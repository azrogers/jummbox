var Z0=Object.defineProperty;var Q0=(r,e,t)=>e in r?Z0(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var a=(r,e,t)=>(Q0(r,typeof e!="symbol"?e+"":e,t),t);import{H as Ke,C as Q,S as me,E as Lt,a as w,b as on,F as Ro,c as Dn,I as je,e as sh,d as Ma,P as Vr,N as fr,m as Nt,f as ms,g as ao,h as us,p as Le,i as J0,j as ef,k as tf,l as Gh,n as tu,o as za,D as Ps,q as nf,r as Zh,s as Qh,t as Jh,u as ec,v as ml,w as tc,x as nc,y as ic,z as sc,A as rc}from"./synth-Q-SpOrBu.js";const nu=document.body.appendChild(Ke.div({style:"width:30px; height:30px; overflow: auto;"},Ke.div({style:"width:100%;height:40px"})));nu.firstChild.clientWidth<30&&document.documentElement.classList.add("obtrusive-scrollbars");document.body.removeChild(nu);document.head.appendChild(Ke.style({type:"text/css"},`

/* Note: "#" symbols need to be encoded as "%23" in SVG data urls, otherwise they are interpreted as fragment identifiers! */
:root {
	--button-size: 26px;
	--settings-area-width: 192px;
	--play-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><path d="M -5 -8 L -5 8 L 8 0 z" fill="gray"/></svg>');
	--pause-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><rect x="-5" y="-7" width="4" height="14" fill="gray"/><rect x="3" y="-7" width="4" height="14" fill="gray"/></svg>');
	--record-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><circle cx="0" cy="0" r="6" fill="gray"/></svg>');
	--stop-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><rect x="-6" y="-6" width="12" height="12" fill="gray"/></svg>');
	--prev-bar-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><rect x="-6" y="-6" width="2" height="12" fill="gray"/><path d="M 6 -6 L 6 6 L -3 0 z" fill="gray"/></svg>');
	--next-bar-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><rect x="4" y="-6" width="2" height="12" fill="gray"/><path d="M -6 -6 L -6 6 L 3 0 z" fill="gray"/></svg>');
	--volume-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 26 26"><path d="M 4 16 L 4 10 L 8 10 L 13 5 L 13 21 L 8 16 z M 15 11 L 16 10 A 7.2 7.2 0 0 1 16 16 L 15 15 A 5.8 5.8 0 0 0 15 12 z M 18 8 L 19 7 A 11.5 11.5 0 0 1 19 19 L 18 18 A 10.1 10.1 0 0 0 18 8 z" fill="gray"/></svg>');
	--unmuted-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="3 3 20 20"><path d="M 4 16 L 4 10 L 8 10 L 13 5 L 13 21 L 8 16 z M 15 11 L 16 10 A 7.2 7.2 0 0 1 16 16 L 15 15 A 5.8 5.8 0 0 0 15 12 z M 18 8 L 19 7 A 11.5 11.5 0 0 1 19 19 L 18 18 A 10.1 10.1 0 0 0 18 8 z" fill="gray"/></svg>');
	--muted-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="3 3 20 20"><path d="M 4 16 L 4 10 L 8 10 L 13 5 L 13 21 L 8 16 z" fill="gray"/></svg>');
	--menu-down-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><path d="M -4 -2 L 4 -2 L 0 3 z" fill="gray"/></svg>');
	--select-arrows-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><path d="M -4 -3 L 4 -3 L 0 -8 z M -4 3 L 4 3 L 0 8 z" fill="gray"/></svg>');
	--file-page-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-5 -21 26 26"><path d="M 2 0 L 2 -16 L 10 -16 L 14 -12 L 14 0 z M 3 -1 L 13 -1 L 13 -11 L 9 -11 L 9 -15 L 3 -15 z" fill="gray"/></svg>');
	--edit-pencil-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-5 -21 26 26"><path d="M 0 0 L 1 -4 L 4 -1 z M 2 -5 L 10 -13 L 13 -10 L 5 -2 zM 11 -14 L 13 -16 L 14 -16 L 16 -14 L 16 -13 L 14 -11 z" fill="gray"/></svg>');
	--preferences-gear-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><path d="M 5.78 -1.6 L 7.93 -0.94 L 7.93 0.94 L 5.78 1.6 L 4.85 3.53 L 5.68 5.61 L 4.21 6.78 L 2.36 5.52 L 0.27 5.99 L -0.85 7.94 L -2.68 7.52 L -2.84 5.28 L -4.52 3.95 L -6.73 4.28 L -7.55 2.59 L -5.9 1.07 L -5.9 -1.07 L -7.55 -2.59 L -6.73 -4.28 L -4.52 -3.95 L -2.84 -5.28 L -2.68 -7.52 L -0.85 -7.94 L 0.27 -5.99 L 2.36 -5.52 L 4.21 -6.78 L 5.68 -5.61 L 4.85 -3.53 M 2.92 0.67 L 2.92 -0.67 L 2.35 -1.87 L 1.3 -2.7 L 0 -3 L -1.3 -2.7 L -2.35 -1.87 L -2.92 -0.67 L -2.92 0.67 L -2.35 1.87 L -1.3 2.7 L -0 3 L 1.3 2.7 L 2.35 1.87 z" fill="gray"/></svg>');
	--customize-dial-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"> 			<g transform="translate(0,1)" fill="gray"> 				<circle cx="0" cy="0" r="6.5" stroke="gray" stroke-width="1" fill="none"/> 				<rect x="-1" y="-5" width="2" height="4" transform="rotate(30)"/> 				<circle cx="-7.79" cy="4.5" r="0.75"/> 				<circle cx="-9" cy="0" r="0.75"/> 				<circle cx="-7.79" cy="-4.5" r="0.75"/> 				<circle cx="-4.5" cy="-7.79" r="0.75"/> 				<circle cx="0" cy="-9" r="0.75"/> 				<circle cx="4.5" cy="-7.79" r="0.75"/> 				<circle cx="7.79" cy="-4.5" r="0.75"/> 				<circle cx="9" cy="0" r="0.75"/> 				<circle cx="7.79" cy="4.5" r="0.75"/> 			</g> 		</svg>');
	--instrument-copy-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-5 -21 26 26"><path d="M 0 -15 L 1 -15 L 1 0 L 13 0 L 13 1 L 0 1 L 0 -15 z M 2 -1 L 2 -17 L 10 -17 L 14 -13 L 14 -1 z M 3 -2 L 13 -2 L 13 -12 L 9 -12 L 9 -16 L 3 -16 z" fill="currentColor"></path></svg>');
	--instrument-paste-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 26 26"><path d="M 8 18 L 6 18 L 6 5 L 17 5 L 17 7 M 9 8 L 16 8 L 20 12 L 20 22 L 9 22 z" stroke="currentColor" fill="none"></path><path d="M 9 3 L 14 3 L 14 6 L 9 6 L 9 3 z M 16 8 L 20 12 L 16 12 L 16 8 z" fill="currentColor"></path></svg>');
	--export-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><path fill="gray" d="M -8 3 L -8 8 L 8 8 L 8 3 L 6 3 L 6 6 L -6 6 L -6 3 z M 0 2 L -4 -2 L -1 -2 L -1 -8 L 1 -8 L 1 -2 L 4 -2 z"/></svg>');
	--close-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><path fill="gray" d="M -7.07 -5.66 L -5.66 -7.07 L 0 -1.4 L 5.66 -7.07 L 7.07 -5.66 L 1.4 0 L 7.07 5.66 L 5.66 7.07 L 0 1.4 L -5.66 7.07 L -7.07 5.66 L -1.4 0 z"/></svg>');
	--add-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><path fill="gray" d="M -8 -1 L -1 -1 L -1 -8  L 1 -8 L 1 -1 L 8 -1 L 8 1 L 1 1 L 1 8 L -1 8 L -1 1 L -8 1 z"/></svg>');
	--zoom-in-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="-10 -10 20 20"><circle cx="-1" cy="-1" r="6" stroke-width="2" stroke="gray" fill="none"></circle><path stroke="gray" stroke-width="2" d="M 3 3 L 7 7 M -1 -4 L -1 2 M -4 -1 L 2 -1" fill="none"></path></svg>');
	--zoom-out-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="-10 -10 20 20"><circle cx="-1" cy="-1" r="6" stroke-width="2" stroke="gray" fill="none"></circle><path stroke="gray" stroke-width="2" d="M 3 3 L 7 7 M -4 -1 L 2 -1" fill="none"></path></svg>');
	--checkmark-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="-13 -13 26 26"><path fill="gray" d="M -9 -2 L -8 -3 L -3 2 L 9 -8 L 10 -7 L -3 8 z"/></svg>');
	--drum-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="40" viewBox="0 0 32 40"> 			<defs> 				<linearGradient id="gold1" x1="0%" y1="0%" x2="100%" y2="0%"> 					<stop offset="0%" stop-color="%237e3302"/> 					<stop offset="40%" stop-color="%23ffec6b"/> 					<stop offset="100%" stop-color="%237e3302"/> 				</linearGradient> 				<linearGradient id="gold2" x1="0%" y1="0%" x2="100%" y2="0%"> 					<stop offset="0%" stop-color="%23faaf7d"/> 					<stop offset="15%" stop-color="%23fffba9"/> 					<stop offset="40%" stop-color="%23ffffe3"/> 					<stop offset="65%" stop-color="%23fffba9"/> 					<stop offset="100%" stop-color="%23faaf7d"/> 				</linearGradient> 				<radialGradient id="gold3" cx="0%" cy="0%" r="100%"> 					<stop offset="0%" stop-color="%23ffffe3"/> 					<stop offset="50%" stop-color="%23ffec6b"/> 					<stop offset="100%" stop-color="%237e3302"/> 				</radialGradient> 				<linearGradient id="red" x1="0%" y1="0%" x2="100%" y2="0%"> 					<stop offset="0%" stop-color="%23641919"/> 					<stop offset="40%" stop-color="%23cd2c2c"/> 					<stop offset="100%" stop-color="%23641919"/> 				</linearGradient> 				<radialGradient id="membrane"> 					<stop offset="10%" stop-color="%23cccccc" /> 					<stop offset="90%" stop-color="%23f6f6f7" /> 					<stop offset="100%" stop-color="%23999" /> 				</radialGradient> 			</defs> 			<ellipse cx="16" cy="26" rx="16" ry="14" fill="rgba(0,0,0,0.5)"/> 			<ellipse cx="16" cy="25" rx="16" ry="14" fill="url(%23gold1)"/> 			<rect x="0" y="23" width="32" height="2" fill="url(%23gold1)"/> 			<ellipse cx="16" cy="23" rx="16" ry="14" fill="url(%23gold2)"/> 			<ellipse cx="16" cy="23" rx="15" ry="13" fill="url(%23red)"/> 			<rect x="1" y="17" width="30" height="6" fill="url(%23red)"/> 			<rect x="5" y="27" width="1" height="5" rx="0.5" fill="rgba(0,0,0,0.5)"/> 			<rect x="15" y="31" width="2" height="5" rx="1" fill="rgba(0,0,0,0.5)"/> 			<rect x="26" y="27" width="1" height="5" rx="0.5" fill="rgba(0,0,0,0.5)"/> 			<rect x="5" y="26" width="1" height="5" rx="0.5" fill="url(%23gold3)"/> 			<rect x="15" y="30" width="2" height="5" rx="1" fill="url(%23gold3)"/> 			<rect x="26" y="26" width="1" height="5" rx="0.5" fill="url(%23gold3)"/> 			<ellipse cx="16" cy="18" rx="15" ry="13" fill="rgba(0,0,0,0.5)"/> 			<ellipse cx="16" cy="16" rx="16" ry="14" fill="url(%23gold1)"/> 			<rect x="0" y="14" width="32" height="2" fill="url(%23gold1)"/> 			<ellipse cx="16" cy="14" rx="16" ry="14" fill="url(%23gold2)"/> 			<ellipse cx="16" cy="14" rx="15" ry="13" fill="url(%23membrane)"/> 		</svg>');
	--piano-key-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="15" preserveAspectRatio="none" viewBox="0 -1 32 15"> 			<defs> 				<linearGradient id="shadow" x1="0%" y1="0%" x2="100%" y2="0%"> 					<stop offset="0%" stop-color="rgba(0,0,0,0.5)"/> 					<stop offset="100%" stop-color="transparent"/> 				</linearGradient> 			</defs> 			<rect x="-1" y="1" width="31" height="1" rx="0.6" fill="rgba(255,255,255,0.4)"/> 			<path d="M -1 11 L 30 11 L 30 2 L 33 -1 L 33 14 L -1 14 z" fill="rgba(0,0,0,0.7)"/> 			<rect x="-1" y="-1" width="19" height="15" fill="url(%23shadow)"/> 		</svg>');
  --mod-key-symbol: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="80" preserveAspectRatio="none" viewBox="0 -1 32 80"> 			<defs> 				<linearGradient id="shadow" x1="0%" y1="0%" x2="100%" y2="0%"> 					<stop offset="0%" stop-color="rgba(0,0,0,0.4)"/> 					<stop offset="100%" stop-color="transparent"/> 				</linearGradient> 			</defs> 			<rect x="-1" y="1" width="31" height="1" rx="0.6" fill="rgba(255,255,255,0.2)"/> 			<path d="M -1 76 L 30 76 L 30 1 L 33 -1 L 33 80 L -1 80 z" fill="rgba(0,0,0,0.7)"/> 			<rect x="-1" y="-1" width="19" height="80" fill="url(%23shadow)"/> 		</svg>');
}


.obtrusive-scrollbars, .obtrusive-scrollbars * {
	scrollbar-width: thin;
	scrollbar-color: ${Q.uiWidgetBackground} ${Q.editorBackground};
}
.obtrusive-scrollbars::-webkit-scrollbar, .obtrusive-scrollbars *::-webkit-scrollbar {
	width: 12px;
}
.obtrusive-scrollbars::-webkit-scrollbar-track, .obtrusive-scrollbars *::-webkit-scrollbar-track {
	background: ${Q.editorBackground};
}
.obtrusive-scrollbars::-webkit-scrollbar-thumb, .obtrusive-scrollbars *::-webkit-scrollbar-thumb {
	background-color: ${Q.uiWidgetBackground};
	border: 3px solid ${Q.editorBackground};
}

@-moz-document url-prefix() {
	.muteButtonText {
		transform: translate(3px, 1px) !important;
	}
}

.beepboxEditor {
	display: grid;
    grid-template-columns: minmax(0, 1fr) max-content;
    grid-template-rows: max-content 1fr; /* max-content minmax(0, 1fr); Chrome 80 grid layout regression. https://bugs.chromium.org/p/chromium/issues/detail?id=1050307 */
    grid-template-areas: "pattern-area settings-area" "track-area settings-area";
	grid-column-gap: 6px;
	grid-row-gap: 6px;
	position: relative;
	touch-action: manipulation;
	cursor: default;
	font-size: 13px;
	overflow: hidden;
	color: ${Q.primaryText};
	background: ${Q.editorBackground};
    opacity: 0;
    -webkit-transition: opacity 0.2s ease-in;
    -moz-transition: opacity 0.2s ease-in;
    -o-transition: opacity 0.2s ease-in;
    -ms-transition: opacity 0.2s ease-in;
    transition: opacity 0.2s ease-in;
    transition-delay: 0s;
}

.beepboxEditor .operatorRow {
	margin: 2px 0;
	height: 2em;
	display: flex;
	flex-direction: row;
	align-items: center;
}

.beepboxEditor .operatorRow > * {
	flex-grow: 1;
	flex-shrink: 1;
}

.pattern-area {
     opacity: 0;
    -webkit-transition: opacity 0.5s ease-in;
    -moz-transition: opacity 0.5s ease-in;
    -o-transition: opacity 0.5s ease-in;
    -ms-transition: opacity 0.5s ease-in;
    transition: opacity 0.5s ease-in;
    transition-delay: 0s;
}

.settings-area {
    opacity: 0;
    -webkit-transition: opacity 0.5s ease-in;
    -moz-transition: opacity 0.5s ease-in;
    -o-transition: opacity 0.5s ease-in;
    -ms-transition: opacity 0.5s ease-in;
    transition: opacity 0.5s ease-in;
    transition-delay: 0.15s;
}

.editor-song-settings {
    opacity: 0;
    -webkit-transition: opacity 0.5s ease-in;
    -moz-transition: opacity 0.5s ease-in;
    -o-transition: opacity 0.5s ease-in;
    -ms-transition: opacity 0.5s ease-in;
    transition: opacity 0.5s ease-in;
    transition-delay: 0.35s;
}

.instrument-settings-area {
    opacity: 0;
    -webkit-transition: opacity 0.5s ease-in;
    -moz-transition: opacity 0.5s ease-in;
    -o-transition: opacity 0.5s ease-in;
    -ms-transition: opacity 0.5s ease-in;
    transition: opacity 0.5s ease-in;
    transition-delay: 0.45s;
}

.trackAndMuteContainer {
    opacity: 0;
    -webkit-transition: opacity 0.5s ease-in;
    -moz-transition: opacity 0.5s ease-in;
    -o-transition: opacity 0.5s ease-in;
    -ms-transition: opacity 0.5s ease-in;
    transition: opacity 0.5s ease-in;
    transition-delay: 0.4s;
}

.barScrollBar {
    opacity: 0;
    -webkit-transition: opacity 0.5s ease-in;
    -moz-transition: opacity 0.5s ease-in;
    -o-transition: opacity 0.5s ease-in;
    -ms-transition: opacity 0.5s ease-in;
    transition: opacity 0.5s ease-in;
    transition-delay: 0.5s;
}



.load {
    opacity: 1;
}

.beepboxEditor .noSelection {
	-webkit-touch-callout: none;
	-webkit-user-select: none;
	-moz-user-select: none;
	-ms-user-select: none;
	user-select: none;
}

.beepboxEditor div {
	margin: 0;
	padding: 0;
}

.beepboxEditor .pattern-area {
	grid-area: pattern-area;
	height: 481px;
	display: flex;
	flex-direction: row;
	position: relative;
}

.beepboxEditor .track-area {
	grid-area: track-area;
}

.beepboxEditor .loopEditor {
	height: 20px;
	position: sticky;
	bottom: 0;
	padding: 5px 0;
	background-color: ${Q.editorBackground};
}

.beepboxEditor .settings-area {
	grid-area: settings-area;
	display: grid;
    grid-template-columns: auto;
    grid-template-rows: min-content min-content min-content min-content min-content;
    grid-template-areas: "version-area" "play-pause-area" "menu-area" "song-settings-area" "instrument-settings-area";
	grid-column-gap: 6px;
}

.beepboxEditor .version-area{ grid-area: version-area; }
.beepboxEditor .play-pause-area{ grid-area: play-pause-area; }
.beepboxEditor .menu-area{ grid-area: menu-area; }
.beepboxEditor .song-settings-area{ grid-area: song-settings-area; }
.beepboxEditor .instrument-settings-area{ grid-area: instrument-settings-area; }

.beepboxEditor .tip {
	cursor: help;
	color: ${Q.secondaryText};
	text-decoration: none;
}

.beepboxEditor .tip:hover {
	color: ${Q.linkAccent};
	text-decoration: underline;
}
.beepboxEditor .tip:active {
	color: ${Q.primaryText};
}

.beepboxEditor .volume-speaker {
	flex-shrink: 0;
	width: var(--button-size);
	height: var(--button-size);
	background: ${Q.secondaryText};
	-webkit-mask-image: var(--volume-symbol);
	-webkit-mask-repeat: no-repeat;
	-webkit-mask-position: center;
	mask-image: var(--volume-symbol);
	mask-repeat: no-repeat;
	mask-position: center;
}

.beepboxEditor .drum-button {
	flex: 1;
	background-color: transparent;
	background-image: var(--drum-symbol);
	background-repeat: no-repeat;
	background-position: center;
}

.beepboxEditor .modulator-button {
	flex: 1;
	position: relative;
	display: flex;
	align-items: center;
}
.beepboxEditor .modulator-button::before {
	content: "";
	position: absolute;
	left: 0;
	top: 0;
	width: 100%;
	height: 100%;
	pointer-events: none;
	background-image: var(--mod-key-symbol);
	background-repeat: no-repeat;
	background-position: center;
	background-size: 100% 102%;
}

.beepboxEditor .piano-button {
	flex: 1;
	position: relative;
	display: flex;
	align-items: center;
}
.beepboxEditor .piano-button::before {
	content: "";
	position: absolute;
	left: 0;
	top: 0;
	width: 100%;
	height: 100%;
	pointer-events: none;
	background-image: var(--piano-key-symbol);
	background-repeat: no-repeat;
	background-position: center;
	background-size: 100% 115.38%;
}
.beepboxEditor .piano-button.disabled::after {
	content: "";
	position: absolute;
	right: 0;
	top: 0;
	width: 70%;
	height: 100%;
	pointer-events: none;
	background: ${Q.editorBackground};
	-webkit-mask-image: linear-gradient(90deg, transparent 0%, gray 70%, gray 100%);
	-webkit-mask-repeat: no-repeat;
	-webkit-mask-position: center;
	mask-image: linear-gradient(90deg, transparent 0%, gray 70%, gray 100%);
	mask-repeat: no-repeat;
	mask-position: center;
}

.beepboxEditor .piano-button.pressed, .beepboxEditor .drum-button.pressed {
	filter: brightness(0.5);
}

.beepboxEditor .customize-instrument {
	margin: 2px 0;
}
.beepboxEditor .customize-instrument::before {
	content: "";
	flex-shrink: 0;
	position: absolute;
	left: 0;
	top: 50%;
	transform: translateY(-50%);
	pointer-events: none;
	width: var(--button-size);
	height: var(--button-size);
	background: currentColor;
	-webkit-mask-image: var(--customize-dial-symbol);
	-webkit-mask-repeat: no-repeat;
	-webkit-mask-position: center;
	mask-image: var(--customize-dial-symbol);
	mask-repeat: no-repeat;
	mask-position: center;
}

.beepboxEditor .instrumentCopyPasteRow {
	gap: 2px;
}

.beepboxEditor .copy-instrument {
	margin: 2px 0;
	flex-grow: 1;
}
.beepboxEditor .copy-instrument::before {
	content: "";
	flex-shrink: 0;
	position: absolute;
	left: 0;
	top: 50%;
	transform: translateY(-50%);
	pointer-events: none;
	width: var(--button-size);
	height: var(--button-size);
	background: currentColor;
	-webkit-mask-image: var(--instrument-copy-symbol);
	-webkit-mask-repeat: no-repeat;
	-webkit-mask-position: center;
	mask-image: var(--instrument-copy-symbol);
	mask-repeat: no-repeat;
	mask-position: center;
}

.beepboxEditor .paste-instrument {
	margin: 2px 0;
	flex-grow: 1;
}
.beepboxEditor .paste-instrument::before {
	content: "";
	flex-shrink: 0;
	position: absolute;
	left: 0;
	top: 50%;
	transform: translateY(-50%);
	pointer-events: none;
	width: var(--button-size);
	height: var(--button-size);
	background: currentColor;
	-webkit-mask-image: var(--instrument-paste-symbol);
	-webkit-mask-repeat: no-repeat;
	-webkit-mask-position: center;
	mask-image: var(--instrument-paste-symbol);
	mask-repeat: no-repeat;
	mask-position: center;
}

.beepboxEditor .envelopeEditor {
	display: flex;
	flex-direction: column;
}

.beepboxEditor .envelope-row {
	display: flex;
	margin: 2px 0;
	gap: 2px;
}

.beepboxEditor .add-envelope {
	width: var(--button-size);
}
.beepboxEditor .add-envelope::before {
	content: "";
	position: absolute;
	width: var(--button-size);
	height: var(--button-size);
	left: 0;
	top: 0;
	pointer-events: none;
	background: currentColor;
	mask-image: var(--add-symbol);
	mask-repeat: no-repeat;
	mask-position: center;
	-webkit-mask-image: var(--add-symbol);
	-webkit-mask-repeat: no-repeat;
	-webkit-mask-position: center;
}
.beepboxEditor .add-envelope:disabled {
	visibility: hidden;
}

.beepboxEditor .effects-menu {
	width: var(--button-size);
	position: relative;
}
.beepboxEditor .effects-menu::before {
	content: "";
	position: absolute;
	width: var(--button-size);
	height: var(--button-size);
	left: 0;
	top: 0;
	pointer-events: none;
	background: currentColor;
	mask-image: var(--menu-down-symbol);
	mask-repeat: no-repeat;
	mask-position: center;
	-webkit-mask-image: var(--menu-down-symbol);
	-webkit-mask-repeat: no-repeat;
	-webkit-mask-position: center;
}

.beepboxEditor .zoomInButton, .beepboxEditor .zoomOutButton {
	width: var(--button-size);
	position: absolute;
	right: 10px;
}
.beepboxEditor .zoomInButton {
	top: 10px;
}
.beepboxEditor .zoomOutButton {
	top: 50px;
}
.beepboxEditor .zoomInButton::before {
	content: "";
	position: absolute;
	width: var(--button-size);
	height: var(--button-size);
	left: 0;
	top: 0;
	pointer-events: none;
	background: currentColor;
	mask-image: var(--zoom-in-symbol);
	mask-repeat: no-repeat;
	mask-position: center;
	-webkit-mask-image: var(--zoom-in-symbol);
	-webkit-mask-repeat: no-repeat;
	-webkit-mask-position: center;
}
.beepboxEditor .zoomOutButton::before {
	content: "";
	position: absolute;
	width: var(--button-size);
	height: var(--button-size);
	left: 0;
	top: 0;
	pointer-events: none;
	background: currentColor;
	mask-image: var(--zoom-out-symbol);
	mask-repeat: no-repeat;
	mask-position: center;
	-webkit-mask-image: var(--zoom-out-symbol);
	-webkit-mask-repeat: no-repeat;
	-webkit-mask-position: center;
}

.beepboxEditor .delete-envelope {
	width: var(--button-size);
	flex-shrink: 0;
	flex-grow: 0;
}
.beepboxEditor .delete-envelope::before {
	content: "";
	position: absolute;
	width: var(--button-size);
	height: var(--button-size);
	left: 0;
	top: 0;
	pointer-events: none;
	background: currentColor;
	mask-image: var(--close-symbol);
	mask-repeat: no-repeat;
	mask-position: center;
	-webkit-mask-image: var(--close-symbol);
	-webkit-mask-repeat: no-repeat;
	-webkit-mask-position: center;
}
.beepboxEditor .delete-envelope:disabled {
	visibility: hidden;
}

.beepboxEditor .menu.file::before {
	content: "";
	flex-shrink: 0;
	position: absolute;
	left: 0;
	top: 50%;
	transform: translateY(-50%);
	pointer-events: none;
	width: var(--button-size);
	height: var(--button-size);
	background: currentColor;
	-webkit-mask-image: var(--file-page-symbol);
	-webkit-mask-repeat: no-repeat;
	-webkit-mask-position: center;
	mask-image: var(--file-page-symbol);
	mask-repeat: no-repeat;
	mask-position: center;
}

.beepboxEditor .menu.edit::before {
	content: "";
	flex-shrink: 0;
	position: absolute;
	left: 0;
	top: 50%;
	transform: translateY(-50%);
	pointer-events: none;
	width: var(--button-size);
	height: var(--button-size);
	background: currentColor;
	-webkit-mask-image: var(--edit-pencil-symbol);
	-webkit-mask-repeat: no-repeat;
	-webkit-mask-position: center;
	mask-image: var(--edit-pencil-symbol);
	mask-repeat: no-repeat;
	mask-position: center;
}

.beepboxEditor .menu.preferences::before {
	content: "";
	flex-shrink: 0;
	position: absolute;
	left: 0;
	top: 50%;
	transform: translateY(-50%);
	pointer-events: none;
	width: var(--button-size);
	height: var(--button-size);
	background: currentColor;
	-webkit-mask-image: var(--preferences-gear-symbol);
	-webkit-mask-repeat: no-repeat;
	-webkit-mask-position: center;
	mask-image: var(--preferences-gear-symbol);
	mask-repeat: no-repeat;
	mask-position: center;
}

.beepboxEditor .mute-button {
	background: transparent;
	border: none;
  padding-right: 0px;
  padding-left: 0px;
  box-shadow: none;
}

.beepboxEditor .mute-button:focus {
  background: transparent;
	border: none;
}

.beepboxEditor .mute-button::before {
	content: "";
	pointer-events: none;
	width: 100%;
	height: 100%;
	display: inline-block;
  background: var(--mute-button-normal);
	-webkit-mask-image: var(--unmuted-symbol);
	-webkit-mask-repeat: no-repeat;
	-webkit-mask-position: center;
	-webkit-mask-size: cover;
  mask-repeat: no-repeat;
	mask-position: center;
	mask-size: cover;
  mask-image: var(--unmuted-symbol);
}

.beepboxEditor .mute-button.muted::before {
  background: var(--ui-widget-background);
	-webkit-mask-image: var(--muted-symbol);
  mask-image: var(--muted-symbol);
}

.beepboxEditor .mute-button.modMute.muted::before {
  background: var(--ui-widget-background);
	-webkit-mask-image: var(--muted-symbol);
  mask-image: var(--muted-symbol);
}

.beepboxEditor .mute-button.modMute::before {
  background: var(--mute-button-mod);
}


.beepboxEditor .promptContainer {
	position: absolute;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
	display: flex;
	justify-content: center;
	align-items: center;
	z-index: 100;
}

.beepboxEditor .promptContainer::before {
	content: "";
	position: absolute;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
	background: ${Q.editorBackground};
	opacity: 0.5;
	display: flex;
}

.beepboxEditor .prompt {
	margin: auto;
	text-align: center;
	background: ${Q.editorBackground};
	border-radius: 15px;
	border: 4px solid ${Q.uiWidgetBackground};
	color: ${Q.primaryText};
	padding: 20px;
	display: flex;
	flex-direction: column;
	position: relative;
	box-shadow: 5px 5px 20px 10px rgba(0,0,0,0.5);
}

.beepboxEditor .prompt > *:not(:first-child):not(.cancelButton) {
	margin-top: 1.5em;
}

.beepboxEditor .prompt h2 {
	font-size: 2em;
	margin: 0 16px;
	font-weight: normal;
}

.beepboxEditor .prompt p {
	text-align: left;
	margin: 1em 0;
}

.beepboxEditor .prompt label {
	cursor: pointer;
}

.beepboxEditor .prompt.recordingSetupPrompt p {
	margin-top: 0.75em;
	margin-bottom: 0;
}

.beepboxEditor .prompt.recordingSetupPrompt > label:not(:first-child):not(.cancelButton) {
	margin: 2px 0;
}

.beepboxEditor .layout-option {
	display: flex;
	flex-direction: column;
	flex: 1;
	cursor: pointer;
	color: ${Q.secondaryText};
}

.beepboxEditor .layout-option input {
	display: none;
}

.beepboxEditor .layout-option input:checked ~ * {
	color: ${Q.primaryText};
}
.beepboxEditor select.invalidSetting {
	border: solid 1px red;
}
.beepboxEditor .selectContainer {
	position: relative;
}
.beepboxEditor .selectContainer:not(.menu)::after {
	content: "";
	flex-shrink: 0;
	position: absolute;
	right: 0;
	top: 50%;
	transform: translateY(-50%);
	pointer-events: none;
	width: 14px;
	height: var(--button-size);
	background: currentColor;
	-webkit-mask-image: var(--select-arrows-symbol);
	-webkit-mask-repeat: no-repeat;
	-webkit-mask-position: center;
	mask-image: var(--select-arrows-symbol);
	mask-repeat: no-repeat;
	mask-position: center;
}
.beepboxEditor .selectContainer.menu::after {
	content: "";
	flex-shrink: 0;
	position: absolute;
	right: 0;
	top: 50%;
	transform: translateY(-50%);
	pointer-events: none;
	width: var(--button-size);
	height: var(--button-size);
	background: currentColor;
	-webkit-mask-image: var(--menu-down-symbol);
	-webkit-mask-repeat: no-repeat;
	-webkit-mask-position: center;
	mask-image: var(--menu-down-symbol);
	mask-repeat: no-repeat;
	mask-position: center;
}
.beepboxEditor select {
	margin: 0;
	padding: 0 4px;
	display: block;
	height: var(--button-size);
	border: none;
	border-radius: 5px;
	background: ${Q.uiWidgetBackground};
	color: inherit;
	font-size: inherit;
	cursor: pointer;
	font-family: inherit;
	font-weight: inherit;

	-webkit-appearance:none;
	-moz-appearance: none;
	appearance: none;
}
.beepboxEditor select option:disabled {
	color: ${Q.linkAccent};
	font-weight: bold;
}

.select2-container .select2-selection--single {
  height: auto;
}

.select2-container {
  width: -moz-available !important;
  width: -webkit-fill-available !important;
}

.select2-container--default .select2-selection--single{
  border-radius: 0px;
  border: 0px;
  background-color: transparent;
  outline: none;
}

.select2-selection__rendered:not(.menu)::before {
	content: "";
	position: absolute;
	right: 0.3em;
	top: 0.4em;
	border-bottom: 0.4em solid currentColor;
	border-left: 0.3em solid transparent;
	border-right: 0.3em solid transparent;
	pointer-events: none;
}
.select2-selection__rendered:not(.menu)::after {
	content: "";
	position: absolute;
	right: 0.3em;
	bottom: 0.4em;
	border-top: 0.4em solid currentColor;
	border-left: 0.3em solid transparent;
	border-right: 0.3em solid transparent;
	pointer-events: none;
}
.select2-selection__rendered {
	margin: 0;
	padding: 0 0.3em;
	display: block;
	height: 2em;
	border: none;
	border-radius: 0.4em;
	background: ${Q.uiWidgetBackground};
	color: inherit !important;
	font-size: inherit;
	cursor: pointer;
	font-family: inherit;
	-webkit-appearance:none;
	-moz-appearance: none;
	appearance: none;
}
.select2-selection__arrow b{
    display:none !important;
}

.select2-selection__rendered--focus {
	background: ${Q.uiWidgetFocus};
	outline: none;
}
.select2-search__field {
    background: ${Q.uiWidgetBackground};
    color: inherit !important;
    font-size: small;
    font-family: inherit;
    border: 0px !important;
    padding: 1px !important;
}
.select2-dropdown {
    box-sizing: border-box;
    display: inline-block;
    margin: 0;
    font-size: small;
    position: relative;
    vertical-align: middle;
    background-color: ${Q.uiWidgetFocus};
}

.select2-container--default .select2-results>.select2-results__options {
    max-height: 430px;
    overflow-x: hidden;
}
.select2-container--default .select2-results__group {
    cursor: default;
    display: block;
    padding: 1px;
    background: ${Q.select2OptGroup};
}
.select2-results__option {
    padding: 2px;
    user-select: none;
    -webkit-user-select: none;
}
.select2-container--default .select2-results__option .select2-results__option {
    padding-left: 0.1em;
}
.select2-container--default .select2-results__option[aria-selected=true] {
  background-color: transparent !important;
}

.select2-results__option--highlighted[aria-selected] {
	color: white !important;
}

.beepboxEditor .menu select {
	padding: 0 var(--button-size);
}
.beepboxEditor select:focus {
	background: ${Q.uiWidgetFocus};
	outline: none;
}
.beepboxEditor .menu select {
	text-align: center;
	text-align-last: center;
}
.beepboxEditor .settings-area select {
       width: 100%;
}

/* This makes it look better in firefox on my computer... What about others?
@-moz-document url-prefix() {
	.beepboxEditor select { padding: 0 2px; }
}
*/
.beepboxEditor button {
	margin: 0;
	position: relative;
	height: var(--button-size);
	border: none;
	border-radius: 5px;
	background: ${Q.uiWidgetBackground};
	color: inherit;
	font-size: inherit;
	font-family: inherit;
	font-weight: inherit;
	cursor: pointer;
}
.beepboxEditor button:focus {
	background: ${Q.uiWidgetFocus};
	outline: none;
}

.beepboxEditor button.cancelButton {
	float: right;
	width: var(--button-size);
	position: absolute;
	top: 8px;
	right: 8px;
}

.beepboxEditor .playback-bar-controls {
	display: grid;
	grid-template-columns: minmax(0, 1fr) minmax(0, 1fr) minmax(0, 1fr) minmax(0, 1fr);
	grid-template-rows: min-content;
	grid-column-gap: 4px;
}

.beepboxEditor button.playButton::before {
	content: "";
	flex-shrink: 0;
	position: absolute;
	left: 0;
	top: 50%;
	transform: translateY(-50%);
	pointer-events: none;
	width: var(--button-size);
	height: var(--button-size);
	background: currentColor;
	-webkit-mask-image: var(--play-symbol);
	-webkit-mask-repeat: no-repeat;
	-webkit-mask-position: center;
	mask-image: var(--play-symbol);
	mask-repeat: no-repeat;
	mask-position: center;
}
.beepboxEditor button.pauseButton::before {
	content: "";
	flex-shrink: 0;
	position: absolute;
	left: 0;
	top: 50%;
	transform: translateY(-50%);
	pointer-events: none;
	width: var(--button-size);
	height: var(--button-size);
	background: currentColor;
	-webkit-mask-image: var(--pause-symbol);
	-webkit-mask-repeat: no-repeat;
	-webkit-mask-position: center;
	mask-image: var(--pause-symbol);
	mask-repeat: no-repeat;
	mask-position: center;
}
.beepboxEditor button.recordButton::before {
	content: "";
	flex-shrink: 0;
	position: absolute;
	left: 0;
	top: 50%;
	transform: translateY(-50%);
	pointer-events: none;
	width: var(--button-size);
	height: var(--button-size);
	background: currentColor;
	-webkit-mask-image: var(--record-symbol);
	-webkit-mask-repeat: no-repeat;
	-webkit-mask-position: center;
	mask-image: var(--record-symbol);
	mask-repeat: no-repeat;
	mask-position: center;
}
.beepboxEditor button.stopButton::before {
	content: "";
	flex-shrink: 0;
	position: absolute;
	left: 0;
	top: 50%;
	transform: translateY(-50%);
	pointer-events: none;
	width: var(--button-size);
	height: var(--button-size);
	background: currentColor;
	-webkit-mask-image: var(--stop-symbol);
	-webkit-mask-repeat: no-repeat;
	-webkit-mask-position: center;
	mask-image: var(--stop-symbol);
	mask-repeat: no-repeat;
	mask-position: center;
}

.beepboxEditor button.prevBarButton::before {
	content: "";
	flex-shrink: 0;
	position: absolute;
	left: 50%;
	top: 50%;
	transform: translate(-50%, -50%);
	pointer-events: none;
	width: var(--button-size);
	height: var(--button-size);
	background: currentColor;
	-webkit-mask-image: var(--prev-bar-symbol);
	-webkit-mask-repeat: no-repeat;
	-webkit-mask-position: center;
	mask-image: var(--prev-bar-symbol);
	mask-repeat: no-repeat;
	mask-position: center;
}

.beepboxEditor button.nextBarButton::before {
	content: "";
	flex-shrink: 0;
	position: absolute;
	left: 50%;
	top: 50%;
	transform: translate(-50%, -50%);
	pointer-events: none;
	width: var(--button-size);
	height: var(--button-size);
	background: currentColor;
	-webkit-mask-image: var(--next-bar-symbol);
	-webkit-mask-repeat: no-repeat;
	-webkit-mask-position: center;
	mask-image: var(--next-bar-symbol);
	mask-repeat: no-repeat;
	mask-position: center;
}

.beepboxEditor button.playButton, .beepboxEditor button.pauseButton, .beepboxEditor button.recordButton, .beepboxEditor button.stopButton, .beepboxEditor button.okayButton, .beepboxEditor button.exportButton {
	padding-left: var(--button-size);
}
.beepboxEditor button.playButton, .beepboxEditor button.pauseButton, .beepboxEditor button.recordButton {
	grid-column-start: 1;
	grid-column-end: 3;
}
.beepboxEditor button.stopButton {
	grid-column-start: 1;
	grid-column-end: 5;
}
.beepboxEditor button.prevBarButton {
	grid-column-start: 3;
	grid-column-end: 4;
}
.beepboxEditor button.nextBarButton {
	grid-column-start: 4;
	grid-column-end: 5;
}

.beepboxEditor button.playButton.shrunk, .beepboxEditor button.recordButton.shrunk {
	padding: 0;
}
.beepboxEditor button.playButton.shrunk::before, .beepboxEditor button.recordButton.shrunk::before {
	left: 50%;
	top: 50%;
	transform: translate(-50%, -50%);
}
.beepboxEditor button.playButton.shrunk span, .beepboxEditor button.recordButton.shrunk span {
	display: none;
}
.beepboxEditor button.playButton.shrunk {
	grid-column-start: 1;
	grid-column-end: 2;
}
.beepboxEditor button.recordButton.shrunk {
	grid-column-start: 2;
	grid-column-end: 3;
}

.beepboxEditor button.cancelButton::before {
	content: "";
	position: absolute;
	width: var(--button-size);
	height: var(--button-size);
	left: 0;
	top: 0;
	pointer-events: none;
	background: currentColor;
	mask-image: var(--close-symbol);
	mask-repeat: no-repeat;
	mask-position: center;
	-webkit-mask-image: var(--close-symbol);
	-webkit-mask-repeat: no-repeat;
	-webkit-mask-position: center;
}

.beepboxEditor button.okayButton::before {
	content: "";
	position: absolute;
	width: var(--button-size);
	height: var(--button-size);
	left: 0;
	top: 0;
	pointer-events: none;
	background: currentColor;
	-webkit-mask-image: var(--checkmark-symbol);
	-webkit-mask-repeat: no-repeat;
	-webkit-mask-position: center;
	mask-image: var(--checkmark-symbol);
	mask-repeat: no-repeat;
	mask-position: center;
}

.beepboxEditor button.exportButton::before {
	content: "";
	position: absolute;
	width: var(--button-size);
	height: var(--button-size);
	left: 0;
	top: 0;
	pointer-events: none;
	background: currentColor;
	mask-image: var(--export-symbol);
	mask-repeat: no-repeat;
	mask-position: center;
	-webkit-mask-image: var(--export-symbol);
	-webkit-mask-repeat: no-repeat;
	-webkit-mask-position: center;
}

.beepboxEditor .instrument-bar {
	display: flex;
	gap: 2px;
}

.beepboxEditor .instrument-bar button {
	flex-grow: 1;
	min-width: 0;
	padding: 0;
	flex-basis: 0;
	display: flex;
	align-items: center;
	justify-content: center;
	color: var(--text-color-lit);
}

.beepboxEditor .instrument-bar .remove-instrument, .beepboxEditor .instrument-bar .add-instrument {
	max-width: var(--button-size);
}

.beepboxEditor .instrument-bar > :not(:first-child) {
	border-top-left-radius: 0;
	border-bottom-left-radius: 0;
}

.beepboxEditor .instrument-bar > :not(.last-button) {
	border-top-right-radius: 0;
	border-bottom-right-radius: 0;
	border-bottom: inset;
	border-color: var(--background-color-dim);
}

.beepboxEditor .instrument-bar .selected-instrument {
	background: var(--background-color-lit);
	color: ${Q.invertedText};
}

.beepboxEditor .instrument-bar .deactivated {
	background: ${Q.editorBackground};
	color: var(--text-color-dim);
	border-bottom: unset;
}

.beepboxEditor .instrument-bar .deactivated.selected-instrument {
	background: var(--background-color-dim);
	color: ${Q.invertedText};
}

.beepboxEditor .instrument-bar .remove-instrument {
	border-bottom: unset;
}

.beepboxEditor .instrument-bar .remove-instrument::before {
	content: "";
	position: absolute;
	width: 100%;
	height: var(--button-size);
	left: 0;
	top: 0;
	pointer-events: none;
	background: currentColor;
	mask-image: var(--close-symbol);
	mask-repeat: no-repeat;
	mask-position: center;
	-webkit-mask-image: var(--close-symbol);
	-webkit-mask-repeat: no-repeat;
	-webkit-mask-position: center;
}

.beepboxEditor .instrument-bar .add-instrument {
	border-bottom: unset;
}

.beepboxEditor .instrument-bar .no-underline {
	border-bottom: unset;
}

.beepboxEditor .instrument-bar .add-instrument::before {
	content: "";
	position: absolute;
	width: 100%;
	height: var(--button-size);
	left: 0;
	top: 0;
	pointer-events: none;
	background: currentColor;
	mask-image: var(--add-symbol);
	mask-repeat: no-repeat;
	mask-position: center;
	-webkit-mask-image: var(--add-symbol);
	-webkit-mask-repeat: no-repeat;
	-webkit-mask-position: center;
}

.beepboxEditor canvas {
	overflow: hidden;
	position: absolute;
	display: block;
  cursor: crosshair;
}

@keyframes dash-animation {
  to {
    stroke-dashoffset: -100;
  }
}

.beepboxEditor .dash-move {
  animation: dash-animation 20s infinite linear;
}

.beepboxEditor .trackContainer {
	flex-grow: 1;
}

.beepboxEditor .trackAndMuteContainer {
	display: flex;
	align-items: flex-start;
	width: 100%;
	min-height: 0;
	flex: 1;
	overflow-x: hidden;
	position: relative;
}

.beepboxEditor .muteEditor {
	width: 32px;
	flex-shrink: 0;
	display: flex;
	flex-direction: column;
	align-items: stretch;
	position: sticky;
	left: 0;
	z-index: 1;
	background: ${Q.editorBackground};
}

.beepboxEditor .selectRow, .beepboxEditor .instrumentCopyPasteRow {
	margin: 2px 0;
	height: var(--button-size);
	display: flex;
	flex-direction: row;
	align-items: center;
	justify-content: space-between;
}

.beepboxEditor .selectRow > :last-child {
	width: 62.5%;
	flex-shrink: 0;
}

.beepboxEditor .menu-area {
	display: flex;
	flex-direction: column;
}
.beepboxEditor .menu-area > * {
	margin: 2px 0;
}
.beepboxEditor .menu-area > button {
	padding: 0 var(--button-size);
	white-space: nowrap;
}

.beepboxEditor .song-settings-area {
	display: flex;
	flex-direction: column;
}

.beepboxEditor .editor-controls {
	flex-shrink: 0;
	display: flex;
	flex-direction: column;
}

.beepboxEditor .instrument-settings-area {
	display: flex;
	flex-direction: column;
}

.beepboxEditor .editor-right-side-top > *, .beepboxEditor .editor-right-side-bottom > * {
	flex-shrink: 0;
}

.beepboxEditor .pitchShiftMarkerContainer {
	box-sizing: border-box;
	display: flex;
	height: 100%;
	left: 3px;
	right: 3px;
	position: absolute;
	align-items: center;
	pointer-events: none;
}

.beepboxEditor .pitchShiftMarker {
	width: 0;
	height: 0;
	position: absolute;
}

.beepboxEditor .pitchShiftMarker::before {
	content: "";
	width: 2px;
	height: 20px;
	transform: translate(-50%, -50%);
	position: absolute;
	background: currentColor;
	border-radius: 3px;
}

.beepboxEditor input[type=text], .beepboxEditor input[type=number] {
	font-size: inherit;
	font-weight: inherit;
	font-family: inherit;
	background: transparent;
	text-align: center;
	border: 1px solid ${Q.inputBoxOutline};
	color: ${Q.primaryText};
}

.beepboxEditor input[type=text]::selection, .beepboxEditor input[type=number]::selection {
	background-color: ${Q.textSelection};
	color: ${Q.primaryText};
}

.beepboxEditor input[type=checkbox] {
  transform: scale(1.5);
}

.beepboxEditor input[type=range] {
	-webkit-appearance: none;
	color: inherit;
	width: 100%;
	height: var(--button-size);
	font-size: inherit;
	margin: 0;
	cursor: pointer;
	background: none;
	touch-action: pan-y;
  position: relative;
}
.beepboxEditor input[type=range]:focus {
	outline: none;
}
.beepboxEditor input[type=range]::-webkit-slider-runnable-track {
	width: 100%;
	height: 6px;
	cursor: pointer;
	background: ${Q.uiWidgetBackground};
}

.modTarget:hover {
	fill: ${Q.hoverPreview} !important;
}

.beepboxEditor span.midTick:after {
    content: "";
    display:inline-block;
    position: absolute;
    background: currentColor;
    width: 2%;
    left: 49%;
    height: 0.5em;
    top: 32%;
    z-index: 1;
		pointer-events: none;
}
.beepboxEditor span.modSlider {
	--mod-position: 20%;
	--mod-color: ${Q.overwritingModSlider};
  --mod-border-radius: 0%;
}
.beepboxEditor span.modSlider:before {
	content: "";
    display:inline-block;
    position: absolute;
    background: var(--mod-color);
    width: 4%;
    left: var(--mod-position);
    height: 0.8em;
    top: 28%;
    z-index: 2;
		transform: translate(-50%, 0%);
		pointer-events: none;
		border: 40%;
		border-radius: var(--mod-border-radius);
}
.beepboxEditor input[type=range]::-webkit-slider-thumb {
	height: var(--button-size);
	width: 6px;
	border-radius: 3px;
	background: currentColor;
	cursor: pointer;
	-webkit-appearance: none;
	margin-top: -10px;
}
.beepboxEditor input[type=range]:focus::-webkit-slider-runnable-track {
	background: ${Q.uiWidgetFocus};
}
.beepboxEditor input[type=range]::-moz-range-track {
	width: 100%;
	height: 6px;
	cursor: pointer;
	background: ${Q.uiWidgetBackground};
}
.beepboxEditor input[type=range]:focus::-moz-range-track {
	background: ${Q.uiWidgetFocus};
}
.beepboxEditor input[type=range]::-moz-range-thumb {
	height: var(--button-size);
	width: 6px;
	border-radius: 3px;
	border: none;
	background: currentColor;
	cursor: pointer;
}
.beepboxEditor input[type=range]::-ms-track {
	width: 100%;
	height: 6px;
	cursor: pointer;
	background: ${Q.uiWidgetBackground};
	border-color: transparent;
}
.beepboxEditor input[type=range]:focus::-ms-track {
	background: ${Q.uiWidgetFocus};
}
.beepboxEditor input[type=range]::-ms-thumb {
	height: var(--button-size);
	width: 6px;
	border-radius: 3px;
	background: currentColor;
	cursor: pointer;
}

li.select2-results__option[role=group] > strong:hover {
  background-color: #516fbb;
}

/* wide screen */
@media (min-width: 711px) {
	#beepboxEditorContainer {
		display: table;
	}
	.beepboxEditor {
		flex-direction: row;
	}
	.beepboxEditor:focus-within {
		outline: 3px solid ${Q.uiWidgetBackground};
	}
	.beepboxEditor .trackAndMuteContainer {
		width: 512px;
	}
	.beepboxEditor .trackSelectBox {
		display: none;
	}
    .beepboxEditor .muteButtonSelectBox {
		display: none;
	}
	.beepboxEditor .play-pause-area {
		display: flex;
		flex-direction: column;
	}
	.beepboxEditor .playback-bar-controls {
		margin: 2px 0;
	}
	.beepboxEditor .playback-volume-controls {
		display: flex;
		flex-direction: row;
		margin: 2px 0;
		align-items: center;
	}
	.beepboxEditor .settings-area {
		width: var(--settings-area-width);
	}
}

/* narrow screen */
@media (max-width: 710px) {
	.beepboxEditor {
		grid-template-columns: minmax(0, 1fr);
		grid-template-rows: min-content 6px min-content min-content;
		grid-template-areas: "pattern-area" "." "track-area" "settings-area";
		grid-row-gap: 0;
	}
	.beepboxEditor .settings-area {
		grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
		grid-template-rows: min-content min-content 1fr min-content;
		grid-template-areas:
			"play-pause-area play-pause-area"
			"menu-area instrument-settings-area"
			"song-settings-area instrument-settings-area"
			"version-area version-area";
		grid-column-gap: 8px;
		margin: 0 4px;
	}
	.beepboxEditor:focus-within {
		outline: none;
	}
	.beepboxEditor .pattern-area {
		max-height: 75vh;
	}
	.beepboxEditor .trackAndMuteContainer {
		overflow-x: auto;
	}
	.beepboxEditor .barScrollBar {
		display: none;
	}
	.beepboxEditor .play-pause-area {
		display: grid;
		grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
		grid-column-gap: 8px;
		margin: 2px 0;
	}
	.beepboxEditor .playback-bar-controls {
		flex-grow: 1;
	}
	.beepboxEditor .playback-volume-controls {
		display: flex;
		flex-direction: row;
		align-items: center;
		flex-grow: 1;
	}
	
	.beepboxEditor .soundIcon {
	  background: ${Q.editorBackground};
	  display: inline-block;
	  height: 10px;
	  margin-left: 0px;
	  margin-top: 8px;
		position: relative;
		width: 10px;
	}
	.beepboxEditor .soundIcon:before {
	  border-bottom: 6px solid transparent;
	  border-top: 6px solid transparent;
	  border-right: 10px solid ${Q.editorBackground};
	  content: "";
	  height: 10px;
	  left: 6px;
	  position: absolute;
	  top: -6px;
	  width: 0;
	}
}

`));class sf{constructor(e,t){a(this,"_editorWidth",512);a(this,"_editorHeight",20);a(this,"_playhead",me.rect("rect",{fill:Q.playhead,x:0,y:0,width:2,height:this._editorHeight}));a(this,"_notches",me.svg({"pointer-events":"none"}));a(this,"_handle",me.rect({fill:Q.uiWidgetBackground,x:0,y:2,width:10,height:this._editorHeight-4}));a(this,"_handleHighlight",me.rect({fill:"none",stroke:Q.hoverPreview,"stroke-width":2,"pointer-events":"none",x:0,y:1,width:10,height:this._editorHeight-2}));a(this,"_leftHighlight",me.path({fill:Q.hoverPreview,"pointer-events":"none"}));a(this,"_rightHighlight",me.path({fill:Q.hoverPreview,"pointer-events":"none"}));a(this,"_renderedPlayhead",-1);a(this,"_svg",me.svg({style:`background-color: ${Q.editorBackground}; touch-action: pan-y; position: absolute;`,width:this._editorWidth,height:this._editorHeight},this._notches,this._handle,this._handleHighlight,this._leftHighlight,this._rightHighlight,this._playhead));a(this,"container",Ke.div({class:"barScrollBar",style:"width: 512px; height: 20px; overflow: hidden; position: relative;"},this._svg));a(this,"_mouseX",0);a(this,"_mouseDown",!1);a(this,"_mouseOver",!1);a(this,"_dragging",!1);a(this,"_dragStart",0);a(this,"_notchSpace",0);a(this,"_renderedNotchCount",-1);a(this,"_renderedScrollBarPos",-1);a(this,"_doc");a(this,"_trackContainer");a(this,"animatePlayhead",()=>{const e=Math.min(512,Math.max(0,this._notchSpace*this._doc.synth.playhead-2));this._renderedPlayhead!=e&&(this._renderedPlayhead=e,this._playhead.setAttribute("x",""+e))});a(this,"_onScroll",e=>{this._doc.barScrollPos=this._trackContainer.scrollLeft/this._doc.getBarWidth()});a(this,"_whenMouseOver",e=>{this._mouseOver||(this._mouseOver=!0,this._updatePreview())});a(this,"_whenMouseOut",e=>{this._mouseOver&&(this._mouseOver=!1,this._updatePreview())});a(this,"_whenMousePressed",e=>{e.preventDefault(),this._mouseDown=!0;const t=this._svg.getBoundingClientRect();this._mouseX=(e.clientX||e.pageX)-t.left,this._updatePreview(),this._mouseX>=this._doc.barScrollPos*this._notchSpace&&this._mouseX<=(this._doc.barScrollPos+this._doc.trackVisibleBars)*this._notchSpace&&(this._dragging=!0,this._dragStart=this._mouseX)});a(this,"_whenTouchPressed",e=>{e.preventDefault(),this._mouseDown=!0;const t=this._svg.getBoundingClientRect();this._mouseX=e.touches[0].clientX-t.left,this._updatePreview(),this._mouseX>=this._doc.barScrollPos*this._notchSpace&&this._mouseX<=(this._doc.barScrollPos+this._doc.trackVisibleBars)*this._notchSpace&&(this._dragging=!0,this._dragStart=this._mouseX)});a(this,"_whenMouseMoved",e=>{const t=this._svg.getBoundingClientRect();this._mouseX=(e.clientX||e.pageX)-t.left,this._whenCursorMoved()});a(this,"_whenTouchMoved",e=>{if(!this._mouseDown)return;e.preventDefault();const t=this._svg.getBoundingClientRect();this._mouseX=e.touches[0].clientX-t.left,this._whenCursorMoved()});a(this,"_whenCursorReleased",e=>{!this._dragging&&this._mouseDown&&(this._mouseX<(this._doc.barScrollPos+8)*this._notchSpace?(this._doc.barScrollPos>0&&this._doc.barScrollPos--,this._doc.notifier.changed()):(this._doc.barScrollPos<this._doc.song.barCount-this._doc.trackVisibleBars&&this._doc.barScrollPos++,this._doc.notifier.changed())),this._mouseDown=!1,this._dragging=!1,this._updatePreview()});this._doc=e,this._trackContainer=t;const n=this._editorHeight*.5,i=20,s=9,h=6;this._leftHighlight.setAttribute("d",`M ${s} ${n} L ${i} ${n+h} L ${i} ${n-h} z`),this._rightHighlight.setAttribute("d",`M ${this._editorWidth-s} ${n} L ${this._editorWidth-i} ${n+h} L ${this._editorWidth-i} ${n-h} z`),this.container.addEventListener("mousedown",this._whenMousePressed),document.addEventListener("mousemove",this._whenMouseMoved),document.addEventListener("mouseup",this._whenCursorReleased),this.container.addEventListener("mouseover",this._whenMouseOver),this.container.addEventListener("mouseout",this._whenMouseOut),this.container.addEventListener("touchstart",this._whenTouchPressed),this.container.addEventListener("touchmove",this._whenTouchMoved),this.container.addEventListener("touchend",this._whenCursorReleased),this.container.addEventListener("touchcancel",this._whenCursorReleased),this._trackContainer.addEventListener("scroll",this._onScroll,{capture:!1,passive:!0})}_whenCursorMoved(){if(this._dragging){for(;this._mouseX-this._dragStart<-this._notchSpace*.5&&this._doc.barScrollPos>0;)this._doc.barScrollPos--,this._dragStart-=this._notchSpace,this._doc.notifier.changed();for(;this._mouseX-this._dragStart>this._notchSpace*.5&&this._doc.barScrollPos<this._doc.song.barCount-this._doc.trackVisibleBars;)this._doc.barScrollPos++,this._dragStart+=this._notchSpace,this._doc.notifier.changed()}this._mouseOver&&this._updatePreview()}changePos(e){for(;Math.abs(e)>=1;)e<0?this._doc.barScrollPos>0&&(this._doc.barScrollPos--,this._dragStart+=this._notchSpace,this._doc.notifier.changed()):this._doc.barScrollPos<this._doc.song.barCount-this._doc.trackVisibleBars&&(this._doc.barScrollPos++,this._dragStart+=this._notchSpace,this._doc.notifier.changed()),e+=e>0?-1:1}_updatePreview(){const e=this._mouseOver&&!this._mouseDown;let t=!1,n=!1,i=!1;e&&(this._mouseX<this._doc.barScrollPos*this._notchSpace?t=!0:this._mouseX>(this._doc.barScrollPos+this._doc.trackVisibleBars)*this._notchSpace?n=!0:i=!0),this._leftHighlight.style.visibility=t?"visible":"hidden",this._rightHighlight.style.visibility=n?"visible":"hidden",this._handleHighlight.style.visibility=i?"visible":"hidden"}render(){this._notchSpace=(this._editorWidth-1)/Math.max(this._doc.trackVisibleBars,this._doc.song.barCount);const e=this._renderedNotchCount!=this._doc.song.barCount;if(e){for(this._renderedNotchCount=this._doc.song.barCount;this._notches.firstChild;)this._notches.removeChild(this._notches.firstChild);for(let t=0;t<=this._doc.song.barCount;t++){const n=t%16==0?0:t%4==0?this._editorHeight/8:this._editorHeight/3;this._notches.appendChild(me.rect({fill:Q.uiWidgetBackground,x:t*this._notchSpace-1,y:n,width:2,height:this._editorHeight-n*2}))}}this._doc.barScrollPos=Math.max(0,Math.min(this._doc.song.barCount-this._doc.trackVisibleBars,this._doc.barScrollPos)),this._doc.channelScrollPos=Math.max(0,Math.min(this._doc.song.getChannelCount()-this._doc.trackVisibleChannels,this._doc.channelScrollPos)),(e||this._renderedScrollBarPos!=this._doc.barScrollPos)&&(this._renderedScrollBarPos=this._doc.barScrollPos,this._handle.setAttribute("x",String(this._notchSpace*this._doc.barScrollPos)),this._handle.setAttribute("width",String(this._notchSpace*this._doc.trackVisibleBars)),this._handleHighlight.setAttribute("x",String(this._notchSpace*this._doc.barScrollPos)),this._handleHighlight.setAttribute("width",String(this._notchSpace*this._doc.trackVisibleBars))),this._updatePreview(),this._trackContainer.scrollLeft=this._doc.barScrollPos*this._doc.getBarWidth(),this._trackContainer.scrollTop=this._doc.channelScrollPos*this._doc.getChannelHeight()}}class it{constructor(){a(this,"_noop",!0)}_didSomething(){this._noop=!1}isNoop(){return this._noop}commit(){}}class rs extends it{constructor(t){super();a(this,"_reversed");a(this,"_doneForwards");this._reversed=t,this._doneForwards=!t}undo(){this._reversed?(this._doForwards(),this._doneForwards=!0):(this._doBackwards(),this._doneForwards=!1)}redo(){this._reversed?(this._doBackwards(),this._doneForwards=!1):(this._doForwards(),this._doneForwards=!0)}_isDoneForwards(){return this._doneForwards}_doForwards(){throw new Error("Change.doForwards(): Override me.")}_doBackwards(){throw new Error("Change.doBackwards(): Override me.")}}class Zt extends it{constructor(){super()}append(e){e.isNoop()||this._didSomething()}}class Zn extends rs{constructor(t){super(!1);a(this,"_changes");t==null?this._changes=[]:this._changes=t.concat()}append(t){t.isNoop()||(this._changes[this._changes.length]=t,this._didSomething())}_doForwards(){for(let t=0;t<this._changes.length;t++)this._changes[t].redo()}_doBackwards(){for(let t=this._changes.length-1;t>=0;t--)this._changes[t].undo()}}function Ta(r,e){const t=r.every(i=>e.indexOf(i)!=-1),n=e.every(i=>r.indexOf(i)!=-1);return t&&n&&e.length==r.length}function Yo(r,e,t){const n=new Set(r);r.length=0,r.push(...n);for(let i=0;i<r.length;i++)r[i]>=e.channels[t].instruments.length&&(r.splice(i,1),i--);r.length>e.getMaxInstrumentsPerPattern(t)&&(r.length=e.getMaxInstrumentsPerPattern(t)),r.length<=0&&(r[0]=0)}function rf(r,e){for(const t of r.notes)for(const n of t.pitches)for(const i of t.pins){const s=(n+i.interval)%12;e[s]||(e[s]=!0)}}function of(r,e){const t=w.scales[e].flags,n=[],i=[];for(let C=0;C<12;C++)r[C]&&n.push(C),t[C]&&i.push(C);const s=n.length>i.length,h=s?i:n,d=s?n:i,c=["root","second","second","third","third","fourth","tritone","fifth","sixth","sixth","seventh","seventh","root"];let _=Number.MAX_SAFE_INTEGER,m=[];const g=[[0]];for(;g.length>0;){const C=g.pop();if(C.length==h.length){let k=0;for(let T=0;T<C.length;T++)k+=Math.abs(h[T]-d[C[T]]),c[h[T]]!=c[d[C[T]]]&&(k+=.75);_>k&&(_=k,m=C)}else{const k=C[C.length-1]+1,T=d.length-h.length+C.length;for(let b=k;b<=T;b++)g.push(C.concat(b))}}const S=[];for(let C=0;C<m.length;C++){const k=h[C],T=d[m[C]];S[C]=s?[T,k]:[k,T]}S.push([12,12]),i.push(12);let E=0;const A=[];for(let C=0;C<12;C++){const k=S[E][0],T=S[E][1],b=S[E+1][0],R=S[E+1][1];C==b-1&&E++;const V=(C-k)*(R-T)/(b-k)+T;let f=0,D=Number.MAX_SAFE_INTEGER;for(const l of i){let W=Math.abs(l-V);c[l]!=c[C]&&(W+=.1),D>W&&(D=W,f=l)}A[C]=f}return A}function xh(r){for(let e=1;e<r.length-1;)r[e-1].interval==r[e].interval&&r[e].interval==r[e+1].interval&&r[e-1].size==r[e].size&&r[e].size==r[e+1].size?r.splice(e,1):e++}function iu(r,e,t,n,i){const s=new fr(-1,t,n,w.noteSizeMax,!1);s.pins.length=0,s.pitches.length=0;const h=n-t;for(const _ of r.pitches)s.pitches.push(_);for(let _=0;_<r.pins.length;_++){const m=r.pins[_],g=m.time+e;if(g<0){if(_+1>=r.pins.length)throw new Error("Error converting pins in note overflow.");const S=r.pins[_+1],E=S.time+e;if(E>0){const A=-g/(E-g);s.pins.push(Nt(Math.round(m.interval+A*(S.interval-m.interval)),0,Math.round(m.size+A*(S.size-m.size))))}}else if(g<=h)s.pins.push(Nt(m.interval,g,m.size));else{if(_<1)throw new Error("Error converting pins in note overflow.");const S=r.pins[_-1],E=S.time+e;if(E<h){const A=(h-E)/(g-E);s.pins.push(Nt(Math.round(S.interval+A*(m.interval-S.interval)),h,Math.round(S.size+A*(m.size-S.size))))}}}const d=s.pins[0].interval;for(let _=0;_<s.pitches.length;_++)s.pitches[_]+=d;for(let _=0;_<s.pins.length;_++)s.pins[_].interval-=d;let c=!1;if(s.start==0)s.continuesLastPattern=e<0||r.continuesLastPattern;else if(s.continuesLastPattern=!1,i.length>0&&r.continuesLastPattern){const _=i[i.length-1];if(_.end==s.start&&ms.adjacentNotesHaveMatchingPitches(_,s)){c=!0;const m=_.pins[_.pins.length-1].interval,g=_.end-_.start;for(let S=1;S<s.pins.length;S++){const E=s.pins[S],A=Nt(E.interval+m,E.time+g,E.size);_.pins.push(A),_.end=_.start+A.time}xh(_.pins)}}c||i.push(s)}class su extends Zt{constructor(e,t,n){super();const i=[],s=[],h=[];for(let d=0;d<e.song.getChannelCount();d++){const c=e.song.channels[d],_=new ao;d<e.song.pitchChannelCount?i.push(_):d<e.song.pitchChannelCount+e.song.noiseChannelCount?s.push(_):h.push(_),_.muted=c.muted,_.octave=c.octave,_.name=c.name;for(const A of c.instruments)_.instruments.push(A);const m=w.partsPerBeat*e.song.beatsPerBar,g=w.partsPerBeat*t;let S=-1,E=null;for(let A=0;A<e.song.barCount;A++){const C=e.song.getPattern(d,A);if(C!=null){const k=A*m;for(const T of C.notes){const b=T.start+k+n,R=T.end+k+n,V=Math.floor(b/g),f=Math.ceil(R/g);for(let D=V;D<f;D++){const l=D*g,W=Math.max(0,b-l),L=Math.min(g,R-l);if(W<L){if(S<D||E==null){for(S++;S<D;)_.bars[S]=0,S++;E=new Vr,_.patterns.push(E),_.bars[S]=_.patterns.length,E.instruments.length=0,E.instruments.push(...C.instruments)}E=_.patterns[_.bars[D]-1],iu(T,b-l-W,W,L,E.notes)}}}}}}lo(i),lo(s),lo(h),this.append(new fu(e,i,s,h))}}class Xa extends rs{constructor(t,n){super(!1);a(this,"_oldStart");a(this,"_newStart");a(this,"_oldEnd");a(this,"_newEnd");a(this,"_oldPins");a(this,"_newPins");a(this,"_oldPitches");a(this,"_newPitches");a(this,"_oldContinuesLastPattern");a(this,"_newContinuesLastPattern");this._doc=t,this._note=n,this._oldStart=this._note.start,this._oldEnd=this._note.end,this._newStart=this._note.start,this._newEnd=this._note.end,this._oldPins=this._note.pins,this._newPins=[],this._oldPitches=this._note.pitches,this._newPitches=[],this._oldContinuesLastPattern=this._note.continuesLastPattern,this._newContinuesLastPattern=this._note.continuesLastPattern}_finishSetup(t){for(let s=0;s<this._newPins.length-1;)this._newPins[s].time>=this._newPins[s+1].time?this._newPins.splice(s,1):s++;xh(this._newPins);const n=this._newPins[0].interval,i=this._newPins[0].time;for(let s=0;s<this._oldPitches.length;s++)this._newPitches[s]=this._oldPitches[s]+n;for(let s=0;s<this._newPins.length;s++)this._newPins[s].interval-=n,this._newPins[s].time-=i;this._newStart=this._oldStart+i,this._newEnd=this._newStart+this._newPins[this._newPins.length-1].time,t!=null&&(this._newContinuesLastPattern=t),this._newStart!=0&&(this._newContinuesLastPattern=!1),this._doForwards(),this._didSomething()}_doForwards(){this._note.pins=this._newPins,this._note.pitches=this._newPitches,this._note.start=this._newStart,this._note.end=this._newEnd,this._note.continuesLastPattern=this._newContinuesLastPattern,this._doc!=null&&this._doc.notifier.changed()}_doBackwards(){this._note.pins=this._oldPins,this._note.pitches=this._oldPitches,this._note.start=this._oldStart,this._note.end=this._oldEnd,this._note.continuesLastPattern=this._oldContinuesLastPattern,this._doc!=null&&this._doc.notifier.changed()}}class pr extends it{constructor(e,t){super();const n=e.song.channels[e.channel].instruments[e.getCurrentInstrument()].customChipWave;var i=!0;for(let s=0;s<n.length;s++)n[s]!=t[s]&&(i=!1,s=n.length);if(i==!1){let s=e.song.channels[e.channel].instruments[e.getCurrentInstrument()];for(let m=0;m<t.length;m++)s.customChipWave[m]=t[m];let h=0;for(let m=0;m<s.customChipWave.length;m++)h+=s.customChipWave[m];const d=h/s.customChipWave.length;let c=0,_=0;for(let m=0;m<s.customChipWave.length;m++)c+=_,_=s.customChipWave[m]-d,s.customChipWaveIntegral[m]=c;s.customChipWaveIntegral[64]=0,s.preset=s.type,e.notifier.changed(),this._didSomething()}}}class oc extends it{constructor(e,t){super();const n=e.song.channels[e.channel].instruments[e.getCurrentInstrument()];if(n.preset!=t){const s=Lt.valueToPreset(t);if(s!=null){if(s.customType!=null)n.type=s.customType,!w.instrumentTypeHasSpecialInterval[n.type]&&w.chords[n.chord].customInterval&&(n.chord=0),n.clearInvalidEnvelopeTargets();else if(s.settings!=null){const h=n.volume,d=n.pan,c=n.panDelay;n.fromJsonObject(s.settings,e.song.getChannelIsNoise(e.channel),e.song.getChannelIsMod(e.channel),e.song.rhythm==0||e.song.rhythm==2,e.song.rhythm>=2),n.volume=h,n.pan=d,n.panDelay=c,n.effects=n.effects|1<<on.panning}}n.preset=t,e.notifier.changed(),this._didSomething()}}}class af extends it{constructor(e){super();function t(m){let g=0;for(const E of m)g+=E.weight;let S=Math.random()*g;for(const E of m)if(S-=E.weight,S<=0)return E.item;return m[Math.random()*m.length|0].item}function n(m,g,S,E){const A=[];for(let C=m;C<=g;C++)A.push({item:C,weight:1/(Math.pow((C-S)/E,2)+1)});return t(A)}class i{constructor(g,S,E,A,C,k){this.chance=g,this.type=S,this.minFreq=E,this.maxFreq=A,this.centerHz=C,this.centerGain=k}}function s(m,g){m.reset();const S=[];for(const E of g){if(Math.random()>E.chance)continue;const A=new Ro;A.type=E.type,A.freq=n(E.minFreq,E.maxFreq,Ro.getRoundedSettingValueFromHz(E.centerHz),1/w.filterFreqStep),A.gain=n(0,w.filterGainRange-1,w.filterGainCenter+E.centerGain,2/w.filterGainStep),!(A.type==Dn.peak&&A.gain==w.filterGainCenter)&&(S.includes(A.freq)||(S.push(A.freq),m.controlPoints[m.controlPointCount]=A,m.controlPointCount++))}}const h=e.song.getChannelIsNoise(e.channel),d=e.song.channels[e.channel].instruments[e.getCurrentInstrument()];d.effects&=1<<on.panning,d.envelopeCount=0;const c=Ro.getRoundedSettingValueFromHz(700),_=w.filterFreqRange-1;if(s(d.eqFilter,[new i(.8,Dn.lowPass,c,_,4e3,-1),new i(.4,Dn.highPass,0,c-1,250,-1),new i(.5,Dn.peak,0,_,2e3,0),new i(.4,Dn.peak,0,_,1400,0),new i(.3,Dn.peak,0,_,1e3,0),new i(.2,Dn.peak,0,_,500,0)]),h){let m=function(S){let E=0;for(const A of S)A>E&&(E=A);for(let A=0;A<S.length;A++)S[A]=w.harmonicsMax*S[A]/E};const g=t([{item:je.noise,weight:1},{item:je.spectrum,weight:3}]);switch(d.preset=d.type=g,d.fadeIn=Math.random()<.8?0:n(0,w.fadeInRange-1,0,2),d.fadeOut=n(0,w.fadeOutTicks.length-1,w.fadeOutNeutral,2),Math.random()<.1&&(d.effects|=1<<on.transition,d.transition=w.transitions.dictionary[t([{item:"normal",weight:30},{item:"interrupt",weight:1},{item:"slide",weight:2}])].index),Math.random()<.2&&(d.effects|=1<<on.chord,d.chord=w.chords.dictionary[t([{item:"strum",weight:2},{item:"arpeggio",weight:1}])].index),Math.random()<.1&&(d.pitchShift=n(0,w.pitchShiftRange-1,w.pitchShiftCenter,2),d.pitchShift!=w.pitchShiftCenter&&(d.effects|=1<<on.pitchShift,d.addEnvelope(w.instrumentAutomationTargets.dictionary.pitchShift.index,0,w.envelopes.dictionary[t([{item:"flare 1",weight:2},{item:"flare 2",weight:1},{item:"flare 3",weight:1},{item:"twang 1",weight:16},{item:"twang 2",weight:8},{item:"twang 3",weight:4},{item:"tremolo1",weight:1},{item:"tremolo2",weight:1},{item:"tremolo3",weight:1},{item:"decay 1",weight:4},{item:"decay 2",weight:2},{item:"decay 3",weight:1}])].index))),Math.random()<.1&&(d.effects|=1<<on.vibrato,d.vibrato=n(0,w.echoSustainRange-1,w.echoSustainRange>>1,2),d.vibrato=w.vibratos.dictionary[t([{item:"light",weight:2},{item:"delayed",weight:2},{item:"heavy",weight:1},{item:"shaky",weight:2}])].index),Math.random()<.8&&(d.effects|=1<<on.noteFilter,s(d.noteFilter,[new i(1,Dn.lowPass,c,_,8e3,-1)]),d.addEnvelope(w.instrumentAutomationTargets.dictionary.noteFilterAllFreqs.index,0,w.envelopes.dictionary[t([{item:"punch",weight:4},{item:"flare 1",weight:2},{item:"flare 2",weight:2},{item:"flare 3",weight:2},{item:"twang 1",weight:8},{item:"twang 2",weight:8},{item:"twang 3",weight:8},{item:"swell 1",weight:2},{item:"swell 2",weight:2},{item:"swell 3",weight:1},{item:"tremolo1",weight:1},{item:"tremolo2",weight:1},{item:"tremolo3",weight:1},{item:"tremolo4",weight:1},{item:"tremolo5",weight:1},{item:"tremolo6",weight:1},{item:"decay 1",weight:4},{item:"decay 2",weight:4},{item:"decay 3",weight:4}])].index)),Math.random()<.1&&(d.effects|=1<<on.distortion,d.distortion=n(1,w.distortionRange-1,w.distortionRange-1,2)),Math.random()<.1&&(d.effects|=1<<on.bitcrusher,d.bitcrusherFreq=n(0,w.bitcrusherFreqRange-1,w.bitcrusherFreqRange>>1,2),d.bitcrusherQuantization=n(0,w.bitcrusherQuantizationRange-1,w.bitcrusherQuantizationRange>>1,2)),Math.random()<.1&&(d.effects|=1<<on.chorus,d.chorus=n(1,w.chorusRange-1,w.chorusRange-1,1)),Math.random()<.1&&(d.echoSustain=n(0,w.echoSustainRange-1,w.echoSustainRange>>1,2),d.echoDelay=n(0,w.echoDelayRange-1,w.echoDelayRange>>1,2),(d.echoSustain!=0||d.echoDelay!=0)&&(d.effects|=1<<on.echo)),Math.random()<.5&&(d.effects|=1<<on.reverb,d.reverb=n(1,w.reverbRange-1,1,1)),g){case je.noise:d.chipNoise=Math.random()*w.chipNoises.length|0;break;case je.spectrum:{const S=[()=>{const C=[];for(let k=0;k<w.spectrumControlPoints;k++)C[k]=Math.random()<.5?Math.random():0;return C},()=>{let C=1;const k=[C];for(let T=1;T<w.spectrumControlPoints;T++)C*=Math.pow(2,Math.random()-.52),k[T]=C;return k},()=>{let C=1;const k=[C];for(let T=1;T<w.spectrumControlPoints;T++)C*=Math.pow(2,Math.random()-.52),k[T]=C*Math.random();return k}],E=S[Math.random()*S.length|0],A=E();m(A);for(let C=0;C<w.spectrumControlPoints;C++)d.spectrumWave.spectrum[C]=Math.round(A[C]);d.spectrumWave.markCustomWaveDirty()}break;default:throw new Error("Unhandled noise instrument type in random generator.")}}else{let m=function(S){let E=0;for(const A of S)A>E&&(E=A);for(let A=0;A<S.length;A++)S[A]=w.harmonicsMax*S[A]/E};const g=t([{item:je.chip,weight:4},{item:je.pwm,weight:4},{item:je.harmonics,weight:5},{item:je.pickedString,weight:5},{item:je.spectrum,weight:1},{item:je.fm,weight:5}]);switch(d.preset=d.type=g,d.fadeIn=Math.random()<.5?0:n(0,w.fadeInRange-1,0,2),d.fadeOut=n(0,w.fadeOutTicks.length-1,w.fadeOutNeutral,2),(g==je.chip||g==je.harmonics||g==je.pickedString)&&(d.unison=w.unisons.dictionary[t([{item:"none",weight:10},{item:"shimmer",weight:5},{item:"hum",weight:4},{item:"honky tonk",weight:3},{item:"dissonant",weight:1},{item:"fifth",weight:1},{item:"octave",weight:2},{item:"bowed",weight:2},{item:"piano",weight:5},{item:"warbled",weight:3}])].index),Math.random()<.1&&(d.effects|=1<<on.transition,d.transition=w.transitions.dictionary[t([{item:"interrupt",weight:1},{item:"slide",weight:2}])].index),Math.random()<.2&&(d.effects|=1<<on.chord,d.chord=w.chords.dictionary[t([{item:"strum",weight:2},{item:"arpeggio",weight:1}])].index),Math.random()<.05&&(d.pitchShift=n(0,w.pitchShiftRange-1,w.pitchShiftCenter,1),d.pitchShift!=w.pitchShiftCenter&&(d.effects|=1<<on.pitchShift,d.addEnvelope(w.instrumentAutomationTargets.dictionary.pitchShift.index,0,w.envelopes.dictionary[t([{item:"flare 1",weight:2},{item:"flare 2",weight:1},{item:"flare 3",weight:1},{item:"twang 1",weight:16},{item:"twang 2",weight:8},{item:"twang 3",weight:4},{item:"decay 1",weight:4},{item:"decay 2",weight:2},{item:"decay 3",weight:1}])].index))),Math.random()<.25&&(d.effects|=1<<on.vibrato,d.vibrato=n(0,w.echoSustainRange-1,w.echoSustainRange>>1,2),d.vibrato=w.vibratos.dictionary[t([{item:"light",weight:2},{item:"delayed",weight:2},{item:"heavy",weight:1},{item:"shaky",weight:2}])].index),Math.random()<.1&&(d.effects|=1<<on.distortion,d.distortion=n(1,w.distortionRange-1,w.distortionRange-1,2)),sh(d.effects)&&Math.random()<.8?(d.effects|=1<<on.noteFilter,s(d.noteFilter,[new i(1,Dn.lowPass,c,_,2e3,-1),new i(.9,Dn.highPass,0,c-1,500,-1),new i(.4,Dn.peak,0,_,1400,0)])):Math.random()<.5&&(d.effects|=1<<on.noteFilter,s(d.noteFilter,[new i(1,Dn.lowPass,c,_,8e3,-1)]),d.addEnvelope(w.instrumentAutomationTargets.dictionary.noteFilterAllFreqs.index,0,w.envelopes.dictionary[t([{item:"punch",weight:6},{item:"flare 1",weight:2},{item:"flare 2",weight:4},{item:"flare 3",weight:2},{item:"twang 1",weight:2},{item:"twang 2",weight:4},{item:"twang 3",weight:4},{item:"swell 1",weight:4},{item:"swell 2",weight:2},{item:"swell 3",weight:1},{item:"tremolo1",weight:1},{item:"tremolo2",weight:1},{item:"tremolo3",weight:1},{item:"tremolo4",weight:1},{item:"tremolo5",weight:1},{item:"tremolo6",weight:1},{item:"decay 1",weight:1},{item:"decay 2",weight:2},{item:"decay 3",weight:2}])].index)),Math.random()<.1&&(d.effects|=1<<on.bitcrusher,d.bitcrusherFreq=n(0,w.bitcrusherFreqRange-1,0,2),d.bitcrusherQuantization=n(0,w.bitcrusherQuantizationRange-1,w.bitcrusherQuantizationRange>>1,2)),Math.random()<.1&&(d.effects|=1<<on.chorus,d.chorus=n(1,w.chorusRange-1,w.chorusRange-1,1)),Math.random()<.1&&(d.echoSustain=n(0,w.echoSustainRange-1,w.echoSustainRange>>1,2),d.echoDelay=n(0,w.echoDelayRange-1,w.echoDelayRange>>1,2),(d.echoSustain!=0||d.echoDelay!=0)&&(d.effects|=1<<on.echo)),Math.random()<.5&&(d.effects|=1<<on.reverb,d.reverb=n(1,w.reverbRange-1,1,1)),g){case je.chip:d.chipWave=Math.random()*w.chipWaves.length|0;break;case je.pwm:d.pulseWidth=n(0,w.pulseWidthRange-1,w.pulseWidthRange-1,2),Math.random()<.6&&d.addEnvelope(w.instrumentAutomationTargets.dictionary.pulseWidth.index,0,w.envelopes.dictionary[t([{item:"punch",weight:6},{item:"flare 1",weight:2},{item:"flare 2",weight:4},{item:"flare 3",weight:2},{item:"twang 1",weight:2},{item:"twang 2",weight:4},{item:"twang 3",weight:4},{item:"swell 1",weight:4},{item:"swell 2",weight:2},{item:"swell 3",weight:1},{item:"tremolo1",weight:1},{item:"tremolo2",weight:1},{item:"tremolo3",weight:1},{item:"tremolo4",weight:1},{item:"tremolo5",weight:1},{item:"tremolo6",weight:1},{item:"decay 1",weight:1},{item:"decay 2",weight:2},{item:"decay 3",weight:2}])].index);break;case je.pickedString:case je.harmonics:{g==je.pickedString&&(d.stringSustain=Math.random()*w.stringSustainRange|0);const S=[()=>{const C=[];for(let k=0;k<w.harmonicsControlPoints;k++)C[k]=Math.random()<.4?Math.random():0;return C[Math.random()*8|0]=Math.pow(Math.random(),.25),C},()=>{let C=1;const k=[C];for(let T=1;T<w.harmonicsControlPoints;T++)C*=Math.pow(2,Math.random()-.55),k[T]=C;return k},()=>{let C=1;const k=[C];for(let T=1;T<w.harmonicsControlPoints;T++)C*=Math.pow(2,Math.random()-.55),k[T]=C*Math.random();return k}],E=S[Math.random()*S.length|0],A=E();m(A);for(let C=0;C<w.harmonicsControlPoints;C++)d.harmonicsWave.harmonics[C]=Math.round(A[C]);d.harmonicsWave.markCustomWaveDirty()}break;case je.spectrum:{const S=[];for(let E=0;E<w.spectrumControlPoints;E++)E==0||E==7||E==11||E==14||E==16||E==18||E==21?S[E]=Math.pow(Math.random(),.25):S[E]=Math.pow(Math.random(),3)*.5;m(S);for(let E=0;E<w.spectrumControlPoints;E++)d.spectrumWave.spectrum[E]=Math.round(S[E]);d.spectrumWave.markCustomWaveDirty()}break;case je.fm:{d.algorithm=Math.random()*w.algorithms.length|0,d.feedbackType=Math.random()*w.feedbacks.length|0;const S=w.algorithms[d.algorithm];for(let E=0;E<S.carrierCount;E++)d.operators[E].frequency=n(0,w.operatorFrequencies.length-1,0,3),d.operators[E].amplitude=n(0,w.operatorAmplitudeMax,w.operatorAmplitudeMax-1,2),d.operators[E].waveform=w.operatorWaves.dictionary[t([{item:"sine",weight:10},{item:"triangle",weight:6},{item:"sawtooth",weight:3},{item:"pulse width",weight:6},{item:"ramp",weight:3},{item:"trapezoid",weight:4}])].index,d.operators[E].waveform==3&&(d.operators[E].pulseWidth=t([{item:0,weight:3},{item:1,weight:5},{item:2,weight:7},{item:3,weight:10},{item:4,weight:15},{item:5,weight:25},{item:6,weight:15},{item:7,weight:10},{item:8,weight:7},{item:9,weight:5},{item:9,weight:3}]));for(let E=S.carrierCount;E<w.operatorCount;E++)d.operators[E].frequency=n(3,w.operatorFrequencies.length-1,0,3),d.operators[E].amplitude=Math.pow(Math.random(),2)*w.operatorAmplitudeMax|0,d.envelopeCount<w.maxEnvelopeCount&&Math.random()<.4&&(d.addEnvelope(w.instrumentAutomationTargets.dictionary.operatorAmplitude.index,E,w.envelopes.dictionary[t([{item:"punch",weight:2},{item:"flare 1",weight:2},{item:"flare 2",weight:2},{item:"flare 3",weight:2},{item:"twang 1",weight:2},{item:"twang 2",weight:2},{item:"twang 3",weight:2},{item:"swell 1",weight:2},{item:"swell 2",weight:2},{item:"swell 3",weight:2},{item:"tremolo1",weight:1},{item:"tremolo2",weight:1},{item:"tremolo3",weight:1},{item:"tremolo4",weight:1},{item:"tremolo5",weight:1},{item:"tremolo6",weight:1},{item:"decay 1",weight:1},{item:"decay 2",weight:1},{item:"decay 3",weight:1}])].index),d.operators[E].waveform=w.operatorWaves.dictionary[t([{item:"sine",weight:10},{item:"triangle",weight:6},{item:"sawtooth",weight:3},{item:"pulse width",weight:6},{item:"ramp",weight:3},{item:"trapezoid",weight:4}])].index,d.operators[E].waveform==3&&(d.operators[E].pulseWidth=t([{item:0,weight:3},{item:1,weight:5},{item:2,weight:7},{item:3,weight:10},{item:4,weight:15},{item:5,weight:25},{item:6,weight:15},{item:7,weight:10},{item:8,weight:7},{item:9,weight:5},{item:9,weight:3}]))),d.envelopeCount<w.maxEnvelopeCount&&Math.random()<.05&&d.addEnvelope(w.instrumentAutomationTargets.dictionary.operatorFrequency.index,E,w.envelopes.dictionary[t([{item:"punch",weight:4},{item:"flare 1",weight:4},{item:"flare 2",weight:2},{item:"flare 3",weight:1},{item:"twang 1",weight:16},{item:"twang 2",weight:2},{item:"twang 3",weight:1},{item:"swell 1",weight:4},{item:"swell 2",weight:2},{item:"swell 3",weight:1},{item:"decay 1",weight:2},{item:"decay 2",weight:1},{item:"decay 3",weight:1}])].index);d.feedbackAmplitude=Math.pow(Math.random(),3)*w.operatorAmplitudeMax|0,d.envelopeCount<w.maxEnvelopeCount&&Math.random()<.4&&d.addEnvelope(w.instrumentAutomationTargets.dictionary.feedbackAmplitude.index,0,w.envelopes.dictionary[t([{item:"punch",weight:2},{item:"flare 1",weight:2},{item:"flare 2",weight:2},{item:"flare 3",weight:2},{item:"twang 1",weight:2},{item:"twang 2",weight:2},{item:"twang 3",weight:2},{item:"swell 1",weight:2},{item:"swell 2",weight:2},{item:"swell 3",weight:2},{item:"tremolo1",weight:1},{item:"tremolo2",weight:1},{item:"tremolo3",weight:1},{item:"tremolo4",weight:1},{item:"tremolo5",weight:1},{item:"tremolo6",weight:1},{item:"decay 1",weight:1},{item:"decay 2",weight:1},{item:"decay 3",weight:1}])].index)}break;default:throw new Error("Unhandled pitched instrument type in random generator.")}}e.notifier.changed(),this._didSomething()}}class lf extends it{constructor(e,t){super();const n=e.song.channels[e.channel].instruments[e.getCurrentInstrument()];n.transition!=t&&(this._didSomething(),n.transition=t,n.preset=n.type,e.notifier.changed())}}class ru extends it{constructor(e,t,n){super();let i=e.song.channels[e.channel].instruments[e.getCurrentInstrument()];n!=null&&(i=n);const s=i.effects,h=(s&1<<t)!=0,d=h?s&~(1<<t):s|1<<t;i.effects=d,t!=on.panning&&(i.preset=i.type),h&&i.clearInvalidEnvelopeTargets(),this._didSomething(),e.notifier.changed()}}class Xi extends it{constructor(e,t,n,i,s,h){if(super(),t>e.song.patternsPerChannel)throw new Error("invalid pattern");for(let d=n;d<n+s;d++)for(let c=i;c<i+h;c++)e.song.channels[c].bars[d]!=t&&(e.song.channels[c].bars[d]=t,this._didSomething());if(i>=e.song.pitchChannelCount+e.song.noiseChannelCount){const d=e.getCurrentPattern();d!=null?e.viewedInstrument[i]=d.instruments[0]:e.viewedInstrument[i]=0}e.notifier.changed()}}class hf extends it{constructor(e,t,n){if(super(),e.song.barCount!=t){for(const i of e.song.channels)if(n){for(;i.bars.length<t;)i.bars.unshift(0);e.song.barCount>t&&i.bars.splice(0,e.song.barCount-t)}else{for(;i.bars.length<t;)i.bars.push(0);i.bars.length=t}if(n){const i=t-e.song.barCount;e.bar=Math.max(0,e.bar+i),(i<0||e.barScrollPos>0)&&(e.barScrollPos=Math.max(0,e.barScrollPos+i)),e.song.loopStart=Math.max(0,e.song.loopStart+i)}e.bar=Math.min(e.bar,t-1),e.song.loopLength=Math.min(t,e.song.loopLength),e.song.loopStart=Math.min(t-e.song.loopLength,e.song.loopStart),e.song.barCount=t,e.notifier.changed(),this._didSomething()}}}class ou extends it{constructor(e,t,n){super();const i=Math.min(w.barCountMax,e.song.barCount+n);if(n=i-e.song.barCount,n!=0){for(const s of e.song.channels)for(;s.bars.length<i;)s.bars.splice(t,0,0);e.song.barCount=i,e.bar+=n,e.barScrollPos+=n,e.song.loopStart>=t?e.song.loopStart+=n:e.song.loopStart+e.song.loopLength>=t&&(e.song.loopLength+=n),e.notifier.changed(),this._didSomething()}}}class au extends it{constructor(e,t,n){super();for(const i of e.song.channels)i.bars.splice(t,n),i.bars.length==0&&i.bars.push(0);e.song.barCount=Math.max(1,e.song.barCount-n),e.bar=Math.max(0,e.bar-n),e.barScrollPos=Math.max(0,e.barScrollPos-n),e.song.loopStart>=t?e.song.loopStart=Math.max(0,e.song.loopStart-n):e.song.loopStart+e.song.loopLength>t&&(e.song.loopLength-=n),e.song.loopLength=Math.max(1,Math.min(e.song.barCount-e.song.loopStart,e.song.loopLength)),e.notifier.changed(),this._didSomething()}}class cf extends it{constructor(e,t,n,i,s,h,d,c){super(),e.song.limitRatio=t,e.song.compressionRatio=n,e.song.limitThreshold=i,e.song.compressionThreshold=s,e.song.limitRise=h,e.song.limitDecay=d,e.song.masterGain=c,e.notifier.changed(),this._didSomething()}}class Ia extends it{constructor(e,t,n,i){super(),e.song.channels.splice(t+i,0,...e.song.channels.splice(t,n-t+1)),n=Math.max(n,t);for(let s=e.song.pitchChannelCount+e.song.noiseChannelCount;s<e.song.getChannelCount();s++)for(let h=0;h<e.song.channels[s].instruments.length;h++){let d=e.song.channels[s].instruments[h];for(let c=0;c<w.modCount;c++)d.modChannels[c]>=t&&d.modChannels[c]<=n?d.modChannels[c]+=i:d.modChannels[c]>=t+i&&d.modChannels[c]<=n+i&&(d.modChannels[c]-=i*(n-t+1))}e.notifier.changed(),this._didSomething()}}class Sh extends it{constructor(e,t,n,i){if(super(),e.song.pitchChannelCount!=t||e.song.noiseChannelCount!=n||e.song.modChannelCount!=i){let s=function(c,_,m,g,S,E,A){for(let C=0;C<c;C++){const k=C+m,T=C+g;if(C<_)h[k]=e.song.channels[T];else{h[k]=new ao,h[k].octave=S;for(let b=0;b<w.instrumentCountMin;b++){const R=new Ma(E,A);if(!A){const V=$a(E),f=Lt.valueToPreset(V);R.fromJsonObject(f.settings,E,A,e.song.rhythm==0||e.song.rhythm==2,e.song.rhythm>=2),R.preset=V}h[k].instruments[b]=R}for(let b=0;b<e.song.patternsPerChannel;b++)h[k].patterns[b]=new Vr;for(let b=0;b<e.song.barCount;b++)h[k].bars[b]=0}}};const h=[];s(t,e.song.pitchChannelCount,0,0,3,!1,!1),s(n,e.song.noiseChannelCount,t,e.song.pitchChannelCount,0,!0,!1),s(i,e.song.modChannelCount,n+t,e.song.pitchChannelCount+e.song.noiseChannelCount,0,!1,!0);let d=e.song.pitchChannelCount;e.song.pitchChannelCount=t,e.song.noiseChannelCount=n,e.song.modChannelCount=i;for(let c=0;c<e.song.getChannelCount();c++)e.song.channels[c]=h[c];e.song.channels.length=e.song.getChannelCount(),e.channel=Math.min(e.channel,t+n+i-1);for(let c=e.song.pitchChannelCount+e.song.noiseChannelCount;c<e.song.getChannelCount();c++)for(let _=0;_<e.song.channels[c].instruments.length;_++)for(let m=0;m<w.modCount;m++){let g=e.song.channels[c].instruments[_],S=g.modChannels[m];(S>=e.song.pitchChannelCount&&S<d||S>=e.song.pitchChannelCount+e.song.noiseChannelCount)&&(g.modulators[m]=w.modulators.dictionary.none.index),S>=d&&d<t&&(g.modChannels[m]+=t-d)}e.notifier.changed(),Q.resetColors(),this._didSomething()}}}class df extends Zt{constructor(e,t,n,i){super();const s=e.song.pitchChannelCount+(n||i?0:1),h=e.song.noiseChannelCount+(!n||i?0:1),d=e.song.modChannelCount+(n||!i?0:1);if(s<=w.pitchChannelCountMax&&h<=w.noiseChannelCountMax&&d<=w.modChannelCountMax){const c=n?e.song.pitchChannelCount+e.song.noiseChannelCount:e.song.pitchChannelCount;this.append(new Sh(e,s,h,d)),c-1>=t&&this.append(new Ia(e,t,c-1,1)),e.synth.computeLatestModValues(),e.recalcChannelNames=!0}}}class lu extends Zt{constructor(e,t,n){super();const i=n;for(let s=e.song.pitchChannelCount+e.song.noiseChannelCount;s<e.song.channels.length;s++)for(let h=0;h<e.song.channels[s].instruments.length;h++){const d=e.song.channels[s].instruments[h];for(let c=0;c<w.modCount;c++)d.modChannels[c]>=t&&d.modChannels[c]<=i?this.append(new rh(e,c,0,d)):d.modChannels[c]>i&&this.append(new rh(e,c,d.modChannels[c]-(i-t+1)+2,d))}for(;n>=t;){const s=e.song.getChannelIsNoise(n),h=e.song.getChannelIsMod(n);e.song.channels.splice(n,1),s?e.song.noiseChannelCount--:h?e.song.modChannelCount--:e.song.pitchChannelCount--,n--}e.song.pitchChannelCount<w.pitchChannelCountMin&&this.append(new Sh(e,w.pitchChannelCountMin,e.song.noiseChannelCount,e.song.modChannelCount)),Q.resetColors(),e.recalcChannelNames=!0,this.append(new _r(e,Math.max(0,t-1),e.bar)),e.synth.computeLatestModValues(),this._didSomething(),e.notifier.changed()}}class _r extends it{constructor(e,t,n,i=!1){super();const s=e.channel,h=e.bar;if(e.channel=t,e.bar=n,i||e.selection.scrollToSelectedPattern(),e.song.getChannelIsMod(e.channel)){const d=e.song.getPattern(e.channel,e.bar);d!=null&&(e.viewedInstrument[e.channel]=d.instruments[0])}e.notifier.changed(),(s!=t||h!=n)&&this._didSomething()}}class uf extends it{constructor(e,t){super();const n=e.song.channels[e.channel].instruments[e.getCurrentInstrument()];n.unison!=t&&(this._didSomething(),n.unison=t,n.preset=n.type,e.notifier.changed())}}class ff extends it{constructor(e,t){super();const n=e.song.channels[e.channel].instruments[e.getCurrentInstrument()];n.chord!=t&&(this._didSomething(),n.chord=t,n.preset=n.type,e.notifier.changed())}}class pf extends it{constructor(e,t){super();const n=e.song.channels[e.channel].instruments[e.getCurrentInstrument()];n.vibrato!=t&&(n.vibrato=t,n.vibratoDepth=w.vibratos[n.vibrato].amplitude,n.vibratoDelay=w.vibratos[n.vibrato].delayTicks/2,n.vibratoSpeed=10,n.vibratoType=w.vibratos[n.vibrato].type,n.preset=n.type,e.notifier.changed(),this._didSomething())}}class _f extends it{constructor(e,t,n){super();const i=e.song.channels[e.channel].instruments[e.getCurrentInstrument()];let s=i.vibrato;e.synth.unsetMod(w.modulators.dictionary["vibrato depth"].index,e.channel,e.getCurrentInstrument()),e.notifier.changed(),(t!=n||s!=w.vibratos.length)&&(i.vibratoDepth=n/25,i.vibrato=w.vibratos.length,e.notifier.changed(),this._didSomething())}}class mf extends it{constructor(e,t,n){super();const i=e.song.channels[e.channel].instruments[e.getCurrentInstrument()];let s=i.vibrato;e.synth.unsetMod(w.modulators.dictionary["vibrato speed"].index,e.channel,e.getCurrentInstrument()),e.notifier.changed(),(t!=n||s!=w.vibratos.length)&&(i.vibratoSpeed=n,i.vibrato=w.vibratos.length,e.notifier.changed(),this._didSomething())}}class gf extends it{constructor(e,t,n){super();const i=e.song.channels[e.channel].instruments[e.getCurrentInstrument()];let s=i.vibrato;e.synth.unsetMod(w.modulators.dictionary["vibrato delay"].index,e.channel,e.getCurrentInstrument()),e.notifier.changed(),(t!=n||s!=w.vibratos.length)&&(i.vibratoDelay=n,i.vibrato=w.vibratos.length,e.notifier.changed(),this._didSomething())}}class vf extends it{constructor(e,t){super();const n=e.song.channels[e.channel].instruments[e.getCurrentInstrument()],i=n.vibratoType;let s=n.vibrato;e.notifier.changed(),(i!=t||s!=w.vibratos.length)&&(n.vibratoType=t,n.vibrato=w.vibratos.length,e.notifier.changed(),this._didSomething())}}class bf extends it{constructor(e,t,n){super();const i=e.song.channels[e.channel].instruments[e.getCurrentInstrument()];i.arpeggioSpeed=n,e.synth.unsetMod(w.modulators.dictionary["arp speed"].index,e.channel,e.getCurrentInstrument()),e.notifier.changed(),t!=n&&this._didSomething()}}class yf extends it{constructor(e,t){super();const n=e.song.channels[e.channel].instruments[e.getCurrentInstrument()],i=n.fastTwoNoteArp;e.notifier.changed(),i!=t&&(n.fastTwoNoteArp=t,this._didSomething())}}class wf extends it{constructor(e,t){super();const n=e.song.channels[e.channel].instruments[e.getCurrentInstrument()],i=n.clicklessTransition;e.notifier.changed(),i!=t&&(n.clicklessTransition=t,this._didSomething())}}class xf extends it{constructor(e,t){super();const n=e.song.channels[e.channel].instruments[e.getCurrentInstrument()],i=n.aliases;e.notifier.changed(),i!=t&&(n.aliases=t,this._didSomething())}}class Sf extends it{constructor(e,t,n){super(),n.markCustomWaveDirty(),t.preset=t.type,e.notifier.changed(),this._didSomething()}}class Cf extends it{constructor(e,t,n){super(),n.markCustomWaveDirty(),t.preset=t.type,e.notifier.changed(),this._didSomething()}}class kf extends it{constructor(e,t,n){super();const i=e.song.channels[e.channel].instruments[e.getCurrentInstrument()];i.drumsetEnvelopes[t]!=n&&(i.drumsetEnvelopes[t]=n,i.preset=i.type,e.notifier.changed(),this._didSomething())}}class Yn extends it{constructor(t){super();a(this,"_instrument");this._doc=t,this._instrument=this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()]}commit(){this.isNoop()||(this._instrument.preset=this._instrument.type,this._doc.notifier.changed())}}class Pf extends Yn{constructor(e,t,n){super(e),this._instrument.pulseWidth=n,e.synth.unsetMod(w.modulators.dictionary["pulse width"].index,e.channel,e.getCurrentInstrument()),e.notifier.changed(),t!=n&&this._didSomething()}}class Ef extends Yn{constructor(e,t,n){super(e),this._instrument.pitchShift=n,e.notifier.changed(),t!=n&&this._didSomething()}}class ac extends Yn{constructor(e,t,n){super(e),this._instrument.detune=n+w.detuneCenter,e.notifier.changed(),e.synth.unsetMod(w.modulators.dictionary.detune.index,e.channel,e.getCurrentInstrument()),t!=n&&this._didSomething()}}class Bf extends Yn{constructor(e,t,n){super(e),this._instrument.distortion=n,e.notifier.changed(),e.synth.unsetMod(w.modulators.dictionary.distortion.index,e.channel,e.getCurrentInstrument()),t!=n&&this._didSomething()}}class Mf extends Yn{constructor(e,t,n){super(e),this._instrument.bitcrusherFreq=n,e.notifier.changed(),t!=n&&this._didSomething()}}class Tf extends Yn{constructor(e,t,n){super(e),this._instrument.bitcrusherQuantization=n,e.notifier.changed(),t!=n&&this._didSomething()}}class If extends Yn{constructor(e,t,n){super(e),this._instrument.stringSustain=n,e.synth.unsetMod(w.modulators.dictionary.sustain.index,e.channel,e.getCurrentInstrument()),e.notifier.changed(),t!=n&&this._didSomething()}}class Af extends it{constructor(e,t,n){super(),t.eqFilterType=n,n==!0?(t.eqFilter.reset(),t.tmpEqFilterStart=t.eqFilter,t.tmpEqFilterEnd=null):(t.eqFilter.convertLegacySettings(t.eqFilterSimpleCut,t.eqFilterSimplePeak,w.envelopes.dictionary.none),t.tmpEqFilterStart=t.eqFilter,t.tmpEqFilterEnd=null),t.clearInvalidEnvelopeTargets(),e.notifier.changed(),this._didSomething()}}class Rf extends it{constructor(e,t,n){super(),t.noteFilterType=n,n==!0?(t.noteFilter.reset(),t.tmpNoteFilterStart=t.noteFilter,t.tmpNoteFilterEnd=null):(t.noteFilter.convertLegacySettings(t.noteFilterSimpleCut,t.noteFilterSimplePeak,w.envelopes.dictionary.none),t.tmpNoteFilterStart=t.noteFilter,t.tmpNoteFilterEnd=null),t.clearInvalidEnvelopeTargets(),e.notifier.changed(),this._didSomething()}}class Lf extends Yn{constructor(e,t,n){super(e),this._instrument.eqFilterSimpleCut=n,e.synth.unsetMod(w.modulators.dictionary["eq filt cut"].index,e.channel,e.getCurrentInstrument()),e.notifier.changed(),t!=n&&this._didSomething()}}class Nf extends Yn{constructor(e,t,n){super(e),this._instrument.eqFilterSimplePeak=n,e.synth.unsetMod(w.modulators.dictionary["eq filt peak"].index,e.channel,e.getCurrentInstrument()),e.notifier.changed(),t!=n&&this._didSomething()}}class Df extends Yn{constructor(e,t,n){super(e),this._instrument.noteFilterSimpleCut=n,e.synth.unsetMod(w.modulators.dictionary["note filt cut"].index,e.channel,e.getCurrentInstrument()),e.notifier.changed(),t!=n&&this._didSomething()}}class Ff extends Yn{constructor(e,t,n){super(e),this._instrument.noteFilterSimplePeak=n,e.synth.unsetMod(w.modulators.dictionary["note filt peak"].index,e.channel,e.getCurrentInstrument()),e.notifier.changed(),t!=n&&this._didSomething()}}class gl extends rs{constructor(t,n,i,s,h,d=!1){super(d);a(this,"_doc");a(this,"_instrument");a(this,"_instrumentPrevPreset");a(this,"_instrumentNextPreset");a(this,"_filterSettings");a(this,"_point");a(this,"_index");a(this,"_envelopeTargetsAdd",[]);a(this,"_envelopeIndicesAdd",[]);a(this,"_envelopeTargetsRemove",[]);a(this,"_envelopeIndicesRemove",[]);this._doc=t,this._instrument=this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()],this._instrumentNextPreset=d?this._instrument.preset:this._instrument.type,this._instrumentPrevPreset=d?this._instrument.type:this._instrument.preset,this._filterSettings=n,this._point=i,this._index=s;for(let c=0;c<this._instrument.envelopeCount;c++){let _=this._instrument.envelopes[c].target,m=this._instrument.envelopes[c].index;if(this._envelopeTargetsAdd.push(_),this._envelopeIndicesAdd.push(m),d){const g=w.instrumentAutomationTargets[_];g.isFilter&&g.effect==on.noteFilter==h&&(g.maxCount==w.filterMaxPoints?m==s?(_=w.instrumentAutomationTargets.dictionary.none.index,m=0):m>s&&m--:n.controlPointCount<=1&&(_=w.instrumentAutomationTargets.dictionary.none.index,m=0))}this._envelopeTargetsRemove.push(_),this._envelopeIndicesRemove.push(m)}this._didSomething(),this.redo()}_doForwards(){this._filterSettings.controlPoints.splice(this._index,0,this._point),this._filterSettings.controlPointCount++,this._filterSettings.controlPoints.length=this._filterSettings.controlPointCount,this._instrument.preset=this._instrumentNextPreset;for(let t=0;t<this._instrument.envelopeCount;t++)this._instrument.envelopes[t].target=this._envelopeTargetsAdd[t],this._instrument.envelopes[t].index=this._envelopeIndicesAdd[t];this._instrument.tmpEqFilterStart=this._instrument.eqFilter,this._instrument.tmpEqFilterEnd=null,this._instrument.tmpNoteFilterStart=this._instrument.noteFilter,this._instrument.tmpNoteFilterEnd=null,this._doc.notifier.changed()}_doBackwards(){this._filterSettings.controlPoints.splice(this._index,1),this._filterSettings.controlPointCount--,this._filterSettings.controlPoints.length=this._filterSettings.controlPointCount,this._instrument.preset=this._instrumentPrevPreset;for(let t=0;t<this._instrument.envelopeCount;t++)this._instrument.envelopes[t].target=this._envelopeTargetsRemove[t],this._instrument.envelopes[t].index=this._envelopeIndicesRemove[t];this._instrument.tmpEqFilterStart=this._instrument.eqFilter,this._instrument.tmpEqFilterEnd=null,this._instrument.tmpNoteFilterStart=this._instrument.noteFilter,this._instrument.tmpNoteFilterEnd=null,this._doc.notifier.changed()}}class Of extends rs{constructor(t,n,i,s,h,d){super(!1);a(this,"_doc");a(this,"_instrument");a(this,"_instrumentPrevPreset");a(this,"_instrumentNextPreset");a(this,"_point");a(this,"_oldFreq");a(this,"_newFreq");a(this,"_oldGain");a(this,"_newGain");this._doc=t,this._instrument=this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()],this._instrumentNextPreset=this._instrument.type,this._instrumentPrevPreset=this._instrument.preset,this._point=n,this._oldFreq=i,this._newFreq=s,this._oldGain=h,this._newGain=d,this._didSomething(),this.redo()}_doForwards(){this._point.freq=this._newFreq,this._point.gain=this._newGain,this._instrument.preset=this._instrumentNextPreset,this._instrument.tmpEqFilterStart=this._instrument.eqFilter,this._instrument.tmpEqFilterEnd=null,this._instrument.tmpNoteFilterStart=this._instrument.noteFilter,this._instrument.tmpNoteFilterEnd=null,this._doc.notifier.changed()}_doBackwards(){this._point.freq=this._oldFreq,this._point.gain=this._oldGain,this._instrument.preset=this._instrumentPrevPreset,this._instrument.tmpEqFilterStart=this._instrument.eqFilter,this._instrument.tmpEqFilterEnd=null,this._instrument.tmpNoteFilterStart=this._instrument.noteFilter,this._instrument.tmpNoteFilterEnd=null,this._doc.notifier.changed()}}class lc extends rs{constructor(t,n,i,s,h=null,d=null){super(!1);a(this,"_doc");a(this,"_instrument");a(this,"_instrumentPrevPreset");a(this,"_instrumentNextPreset");a(this,"_filterSettings");a(this,"_subFilters",[]);a(this,"_oldSubFilters",[]);a(this,"_oldSettings");a(this,"_useNoteFilter");this._doc=t,this._instrument=this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()],this._instrumentNextPreset=this._instrument.type,this._instrumentPrevPreset=this._instrument.preset,this._oldSettings=i,this._useNoteFilter=s,this._filterSettings=n,h!=null&&d!=null&&(this._subFilters=h,this._oldSubFilters=d),this._instrument.clearInvalidEnvelopeTargets(),this._didSomething(),this.redo()}_doForwards(){this._useNoteFilter?(this._instrument.noteFilter=this._filterSettings,this._subFilters!=null&&(this._instrument.noteSubFilters=this._subFilters),this._instrument.tmpNoteFilterStart=this._instrument.noteFilter,this._instrument.tmpNoteFilterEnd=null):(this._instrument.eqFilter=this._filterSettings,this._subFilters!=null&&(this._instrument.eqSubFilters=this._subFilters),this._instrument.tmpEqFilterStart=this._instrument.eqFilter,this._instrument.tmpEqFilterEnd=null),this._instrument.preset=this._instrumentNextPreset,this._instrument.clearInvalidEnvelopeTargets(),this._doc.notifier.changed()}_doBackwards(){this._useNoteFilter?(this._instrument.noteFilter=this._oldSettings,this._oldSubFilters!=null&&(this._instrument.noteSubFilters=this._oldSubFilters),this._instrument.tmpNoteFilterStart=this._instrument.noteFilter,this._instrument.tmpNoteFilterEnd=null):(this._instrument.eqFilter=this._oldSettings,this._oldSubFilters!=null&&(this._instrument.eqSubFilters=this._oldSubFilters),this._instrument.tmpEqFilterStart=this._instrument.eqFilter,this._instrument.tmpEqFilterEnd=null),this._instrument.preset=this._instrumentPrevPreset,this._instrument.clearInvalidEnvelopeTargets(),this._doc.notifier.changed()}}class ea extends rs{constructor(t,n,i){super(!1);a(this,"_doc");a(this,"_instrument");a(this,"_instrumentPrevPreset");a(this,"_instrumentNextPreset");a(this,"_oldFadeIn");a(this,"_oldFadeOut");a(this,"_newFadeIn");a(this,"_newFadeOut");this._doc=t,this._instrument=this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()],this._instrumentNextPreset=this._instrument.type,this._instrumentPrevPreset=this._instrument.preset,this._oldFadeIn=this._instrument.fadeIn,this._oldFadeOut=this._instrument.fadeOut,this._newFadeIn=n,this._newFadeOut=i,this._didSomething(),this.redo()}_doForwards(){this._instrument.fadeIn=this._newFadeIn,this._instrument.fadeOut=this._newFadeOut,this._instrument.preset=this._instrumentNextPreset,this._doc.notifier.changed()}_doBackwards(){this._instrument.fadeIn=this._oldFadeIn,this._instrument.fadeOut=this._oldFadeOut,this._instrument.preset=this._instrumentPrevPreset,this._doc.notifier.changed()}}class Hf extends it{constructor(e,t){super();const n=e.song.channels[e.channel].instruments[e.getCurrentInstrument()];n.algorithm!=t&&(n.algorithm=t,n.preset=n.type,e.notifier.changed(),this._didSomething())}}class Vf extends it{constructor(e,t){super();const n=e.song.channels[e.channel].instruments[e.getCurrentInstrument()];n.feedbackType!=t&&(n.feedbackType=t,n.preset=n.type,e.notifier.changed(),this._didSomething())}}class Wf extends it{constructor(e,t,n){super();const i=e.song.channels[e.channel].instruments[e.getCurrentInstrument()];i.operators[t].waveform!=n&&(i.operators[t].waveform=n,i.preset=i.type,e.notifier.changed(),this._didSomething())}}class qf extends it{constructor(e,t,n,i){super();const s=e.song.channels[e.channel].instruments[e.getCurrentInstrument()];s.operators[t].pulseWidth=i,s.preset=s.type,e.notifier.changed(),n!=i&&this._didSomething()}}class Uf extends it{constructor(e,t,n){super();const i=e.song.channels[e.channel].instruments[e.getCurrentInstrument()];i.operators[t].frequency!=n&&(i.operators[t].frequency=n,i.preset=i.type,e.notifier.changed(),this._didSomething())}}class zf extends Yn{constructor(e,t,n,i){super(e),this._instrument.operators[t].amplitude=i,e.notifier.changed(),n!=i&&this._didSomething()}}class Xf extends Yn{constructor(e,t,n){super(e),this._instrument.feedbackAmplitude=n,e.notifier.changed(),t!=n&&this._didSomething()}}class $f extends it{constructor(e){super();const t=e.song.channels[e.channel],n=e.song.getChannelIsNoise(e.channel),i=e.song.getChannelIsMod(e.channel),s=e.song.getMaxInstrumentsPerChannel();if(t.instruments.length>=s)return;const h=$a(n),d=Lt.valueToPreset(h),c=new Ma(n,i);c.fromJsonObject(d.settings,n,i,!1,!1,1),c.preset=h,c.volume=0,t.instruments.push(c),i||(e.viewedInstrument[e.channel]=t.instruments.length-1);for(let _=e.song.pitchChannelCount+e.song.noiseChannelCount;_<e.song.getChannelCount();_++)for(let m=0;m<e.song.channels[_].instruments.length;m++)for(let g=0;g<w.modCount;g++){let S=e.song.channels[_].instruments[m],E=S.modInstruments[g],A=S.modChannels[g];A==e.channel&&E>=e.song.channels[A].instruments.length-1&&S.modInstruments[g]++}e.synth.computeLatestModValues(),e.notifier.changed(),this._didSomething()}}class Yf extends it{constructor(e){super();const t=e.song.channels[e.channel];if(t.instruments.length<=w.instrumentCountMin)return;const n=e.viewedInstrument[e.channel];if(t.instruments.splice(n,1),e.song.patternInstruments)for(const i of t.patterns){for(let s=0;s<i.instruments.length;s++)i.instruments[s]==n?(i.instruments.splice(s,1),s--):i.instruments[s]>n&&i.instruments[s]--;i.instruments.length<=0&&(i.instruments[0]=0)}for(let i=e.song.pitchChannelCount+e.song.noiseChannelCount;i<e.song.getChannelCount();i++)for(let s=0;s<e.song.channels[i].instruments.length;s++)for(let h=0;h<w.modCount;h++){let d=e.song.channels[i].instruments[s],c=d.modInstruments[h];d.modChannels[h]==e.channel&&(c>n?d.modInstruments[h]--:c==n&&(d.modInstruments[h]=0,d.modulators[h]=0))}e.notifier.changed(),this._didSomething()}}class jf extends it{constructor(e,t){super(),e.viewedInstrument[e.channel]!=t&&(e.viewedInstrument[e.channel]=t,e.notifier.changed(),this._didSomething())}}class Kf extends it{constructor(e,t,n){super();const i=e.song.layeredInstruments,s=e.song.patternInstruments;if(!(i==t&&s==n)){e.song.layeredInstruments=t,e.song.patternInstruments=n;for(let h=0;h<e.song.getChannelCount();h++){const d=e.song.channels[h];d.instruments.length>e.song.getMaxInstrumentsPerChannel()&&(d.instruments.length=e.song.getMaxInstrumentsPerChannel());for(let c=0;c<e.song.patternsPerChannel;c++){const _=d.patterns[c];if(!s&&n){for(let m=0;m<d.instruments.length;m++)_.instruments[m]=m;_.instruments.length=d.instruments.length}Yo(_.instruments,e.song,h)}}e.notifier.changed(),this._didSomething()}}}class Gf extends it{constructor(e,t){super(),e.song.key!=t&&(e.song.key=t,e.notifier.changed(),this._didSomething())}}class vl extends it{constructor(e,t,n,i,s){super(),this._doc=e,this.oldStart=t,this.oldLength=n,this.newStart=i,this.newLength=s,this._doc.song.loopStart=this.newStart,this._doc.song.loopLength=this.newLength,this._doc.notifier.changed(),(this.oldStart!=this.newStart||this.oldLength!=this.newLength)&&this._didSomething()}}class bl extends rs{constructor(t,n,i,s,h=!1){super(h);a(this,"_doc");a(this,"_note");a(this,"_pitch");a(this,"_index");this._doc=t,this._note=n,this._pitch=i,this._index=s,this._didSomething(),this.redo()}_doForwards(){this._note.pitches.splice(this._index,0,this._pitch),this._doc.notifier.changed()}_doBackwards(){this._note.pitches.splice(this._index,1),this._doc.notifier.changed()}}class yl extends it{constructor(e,t,n){super(),this.oldValue=t,e.song.channels[e.channel].octave=n,e.notifier.changed(),t!=n&&this._didSomething()}}class so extends Zt{constructor(e,t){super(),e.song.rhythm!=t&&(e.song.rhythm=t,e.notifier.changed(),this._didSomething())}}class Pa extends Zt{constructor(e,t,n,i,s,h){super(),this.append(new _s(e,t,i,s,null,!0));let d=0;if(e.song.getChannelIsMod(e.channel))d=t.notes.length;else for(let c=0;c<t.notes.length;c++)if(t.notes[c].start<i){if(t.notes[c].end>i)throw new Error;d=c+1}else if(t.notes[c].start<s)throw new Error;for(;i<s;){for(const c of n){const _=c.start+i,m=c.end+i;if(_>=s)break;const g=new fr(c.pitches[0],_,m,c.pins[0].size,!1);g.pitches.length=0;for(const S of c.pitches)g.pitches.push(S);g.pins.length=0;for(const S of c.pins)g.pins.push(Nt(S.interval,S.time,S.size));g.continuesLastPattern=c.continuesLastPattern===!0&&g.start==0,t.notes.splice(d++,0,g),g.end>s&&this.append(new ss(e,g,g.start,s))}i+=h}t!=null&&e.song.getChannelIsMod(e.channel)&&t.notes.sort(function(c,_){return c.start==_.start?c.pitches[0]-_.pitches[0]:c.start-_.start}),e.notifier.changed(),this._didSomething()}}class Zf extends Zt{constructor(e,t,n){super(),t.fromJsonObject(n,n.isDrum,n.isMod,!1,!1),e.notifier.changed(),this._didSomething()}}class vo extends it{constructor(e,t,n,i){super(),Ta(n,i.instruments)||(i.instruments.length=0,i.instruments.push(...n),Yo(i.instruments,e.song,t),this._didSomething(),e.notifier.changed())}}class rh extends it{constructor(e,t,n,i){super();let s=e.song.channels[e.channel].instruments[e.getCurrentInstrument()];i!=null&&(s=i),(n==0||w.modulators[s.modulators[t]].forSong&&n>=2||!w.modulators[s.modulators[t]].forSong&&n<2)&&(s.modulators[t]=w.modulators.dictionary.none.index),s.modChannels[t]=n-2,e.notifier.changed(),this._didSomething()}}class Qf extends it{constructor(e,t,n){super();let i=e.song.channels[e.channel].instruments[e.getCurrentInstrument()];i.modInstruments[t]!=n&&(i.modInstruments[t]=n,e.notifier.changed(),this._didSomething())}}class Jf extends it{constructor(e,t,n){super();let i=e.song.channels[e.channel].instruments[e.getCurrentInstrument()],s=i.modChannels[t],h=[];if(s>=0)if(i.modInstruments[t]==e.song.channels[s].instruments.length)h=h.concat(e.song.channels[s].instruments);else if(i.modInstruments[t]>e.song.channels[s].instruments.length){let c=e.song.getPattern(s,e.bar);if(c!=null)for(let _=0;_<c.instruments.length;_++)h.push(e.song.channels[s].instruments[c.instruments[_]])}else h.push(e.song.channels[s].instruments[i.modInstruments[t]]);if(n.startsWith("+ ")){n=n.substr(2);for(let c=0;c<h.length;c++){const _=h[c];_.effects&1<<w.modulators.dictionary[n].associatedEffect||e.record(new ru(e,w.modulators.dictionary[n].associatedEffect,_))}}let d=w.modulators.dictionary[n].index;if(i.modulators[t]!=d){i.modulators[t]=d;let c=w.modulators[d].maxRawVol;for(let _=0;_<e.song.patternsPerChannel;_++){const m=e.song.channels[e.channel].patterns[_];if(m.instruments[0]==e.getCurrentInstrument())for(let g=0;g<m.notes.length;g++){const S=m.notes[g];if(S.pitches[0]==w.modCount-t-1)for(let E=0;E<S.pins.length;E++){const A=S.pins[E];A.size>c&&(A.size=c)}}}e.notifier.changed(),this._didSomething()}}}class ep extends it{constructor(e,t,n){super();let i=e.song.channels[e.channel].instruments[e.getCurrentInstrument()];if(i.modFilterTypes[t]!=n){i.modFilterTypes[t]=n;let s=e.song.getVolumeCapForSetting(!0,i.modulators[t],i.modFilterTypes[t]);for(let h=0;h<e.song.patternsPerChannel;h++){const d=e.song.channels[e.channel].patterns[h];if(d.instruments[0]==e.getCurrentInstrument())for(let c=0;c<d.notes.length;c++){const _=d.notes[c];if(_.pitches[0]==w.modCount-t-1)for(let m=0;m<_.pins.length;m++){const g=_.pins[m];g.size>s&&(g.size=s)}}}e.notifier.changed(),this._didSomething()}}}class Aa extends it{constructor(e,t){if(super(),e.song.patternsPerChannel!=t){for(let n=0;n<e.song.getChannelCount();n++){const i=e.song.channels[n].bars,s=e.song.channels[n].patterns;for(let h=0;h<i.length;h++)i[h]>t&&(i[h]=0);for(let h=s.length;h<t;h++)s[h]=new Vr;s.length=t}e.song.patternsPerChannel=t,e.notifier.changed(),this._didSomething()}}}class ur extends rs{constructor(t,n,i){super(!1);a(this,"_doc");a(this,"_bar");a(this,"_channelIndex");a(this,"_patternIndex",0);a(this,"_patternOldNotes",null);a(this,"_oldPatternCount");a(this,"_newPatternCount");a(this,"_oldPatternInstruments",null);a(this,"_newPatternInstruments");const s=t.song;if(this._doc=t,this._bar=i,this._channelIndex=n,this._oldPatternCount=s.patternsPerChannel,this._newPatternCount=s.patternsPerChannel,this._newPatternInstruments=t.recentPatternInstruments[n].concat(),s.channels[n].bars[i]!=0)return;let h=null,d=null;for(let c=1;c<=s.patternsPerChannel;c++){let _=!1;for(let g=0;g<s.barCount;g++)if(s.channels[n].bars[g]==c){_=!0;break}if(_)continue;if(d==null&&(d=c),s.channels[n].patterns[c-1].notes.length==0){h=c;break}}if(h!=null)this._patternIndex=h,this._oldPatternInstruments=s.channels[n].patterns[h-1].instruments.concat();else if(s.patternsPerChannel<s.barCount)this._newPatternCount=s.patternsPerChannel+1,this._patternIndex=s.patternsPerChannel+1;else if(d!=null)this._patternIndex=d,this._patternOldNotes=s.channels[n].patterns[d-1].notes,this._oldPatternInstruments=s.channels[n].patterns[d-1].instruments.concat();else throw new Error;this._didSomething(),this._doForwards()}_doForwards(){const t=this._doc.song;for(let i=t.patternsPerChannel;i<this._newPatternCount;i++)for(let s=0;s<t.getChannelCount();s++)t.channels[s].patterns[i]=new Vr;t.patternsPerChannel=this._newPatternCount;const n=t.channels[this._channelIndex].patterns[this._patternIndex-1];n.notes=[],n.instruments.length=0,n.instruments.push(...this._newPatternInstruments),t.channels[this._channelIndex].bars[this._bar]=this._patternIndex,this._doc.notifier.changed()}_doBackwards(){const t=this._doc.song,n=t.channels[this._channelIndex].patterns[this._patternIndex-1];this._patternOldNotes!=null&&(n.notes=this._patternOldNotes),this._oldPatternInstruments!=null&&(n.instruments.length=0,n.instruments.push(...this._oldPatternInstruments)),t.channels[this._channelIndex].bars[this._bar]=0;for(let i=0;i<t.getChannelCount();i++)t.channels[i].patterns.length=this._oldPatternCount;t.patternsPerChannel=this._oldPatternCount,this._doc.notifier.changed()}}class hu extends Xa{constructor(e,t,n,i,s){super(e,t),i-=this._oldStart;const h=this._oldPins[n].time,d=Math.min(h,i),c=Math.max(h,i);let _=!1;for(let m=0;m<this._oldPins.length;m++){const g=t.pins[m],S=g.time;S<d?this._newPins.push(Nt(g.interval,S,g.size)):S>c&&(_||(this._newPins.length>0&&(s=t.continuesLastPattern),this._newPins.push(Nt(this._oldPins[n].interval,i,this._oldPins[n].size)),_=!0),this._newPins.push(Nt(g.interval,S,g.size)))}_||(s=t.continuesLastPattern,this._newPins.push(Nt(this._oldPins[n].interval,i,this._oldPins[n].size))),this._finishSetup(s)}}class hc extends Xa{constructor(e,t,n,i,s,h){super(e,t),n-=this._oldStart,i-=this._oldStart,s-=t.pitches[h];let d=!1,c=!1,_=0,m=w.noteSizeMax,g=!0,S,E,A,C;for(i>n?(S=0,E=1,A=t.pins.length,C=k=>{this._newPins.push(k)}):(S=t.pins.length-1,E=-1,A=-1,C=k=>{this._newPins.unshift(k)});S!=A;S+=E){const k=t.pins[S],T=k.time;for(;;)if(d)if(c){if(T*E==i*E)break;k.interval!=_&&(g=!1),C(Nt(g?s:k.interval,T,k.size));break}else{if(T*E<=i*E&&(_=k.interval,m=k.size),T*E<i*E)break;C(Nt(s,i,m)),c=!0}else if(T*E<=n*E&&(_=k.interval,m=k.size),T*E<n*E){C(Nt(k.interval,T,k.size));break}else C(Nt(_,n,m)),d=!0}c||C(Nt(s,i,m)),this._finishSetup()}}class tp extends Zn{constructor(e,t){super();const n=w.partsPerBeat/w.rhythms[e.song.rhythm].stepsPerBeat,i=function(h){let d=w.rhythms[e.song.rhythm].roundUpThresholds;if(d!=null){const c=Math.floor(h/w.partsPerBeat)*w.partsPerBeat,_=h-c;let m=c;for(const g of d)if(_>=g)m+=n;else break;return m}else return Math.round(h/n)*n};let s=0;for(;s<t.notes.length;){const h=t.notes[s];i(h.start)>=i(h.end)?this.append(new yi(e,t,h,s,!0)):(this.append(new cu(e,h,i)),s++)}}}class cu extends Xa{constructor(e,t,n){super(e,t);for(const i of this._oldPins)this._newPins.push(Nt(i.interval,n(i.time+this._oldStart)-this._oldStart,i.size));this._finishSetup()}}class np extends Zt{constructor(e,t,n){super();let i=Math.round(t%e.song.beatsPerBar*w.partsPerBeat);if(i<0&&(i+=e.song.beatsPerBar*w.partsPerBeat),i!=0){switch(n){case"wrapAround":{const s=w.partsPerBeat*e.song.beatsPerBar;for(const h of e.song.channels)for(const d of h.patterns){const c=[];for(let _=1;_>=0;_--){const m=_*s;for(const g of d.notes){const S=g.start+i,E=g.end+i,A=Math.max(0,S-m),C=Math.min(s,E-m);A<C&&iu(g,S-m-A,A,C,c)}}d.notes=c}}break;case"overflow":{let s=e.song.barCount,h=e.song.loopStart,d=e.song.loopLength;if(this.append(new su(e,e.song.beatsPerBar,i)),t<0){let c=!0;for(const _ of e.song.channels)_.bars[0]!=0&&(c=!1);if(c){for(const _ of e.song.channels)_.bars.shift();e.song.barCount--}else s++,h++,e.bar++}for(;e.song.barCount<s;){for(const c of e.song.channels)c.bars.push(0);e.song.barCount++}e.song.loopStart=h,e.song.loopLength=d}break;default:throw new Error("Unrecognized beats-per-bar conversion strategy.")}e.notifier.changed(),this._didSomething()}}}class ip extends Zt{constructor(e,t,n){if(super(),e.song.beatsPerBar!=t){switch(n){case"splice":if(e.song.beatsPerBar>t){const i=new Zn;for(let s=0;s<e.song.getChannelCount();s++)for(let h=0;h<e.song.channels[s].patterns.length;h++)i.append(new _s(e,e.song.channels[s].patterns[h],t*w.partsPerBeat,e.song.beatsPerBar*w.partsPerBeat,null,!0))}break;case"stretch":{const i=function(s){return Math.round(s*t/e.song.beatsPerBar)};for(let s=0;s<e.song.getChannelCount();s++)for(let h=0;h<e.song.channels[s].patterns.length;h++){const d=e.song.channels[s].patterns[h];let c=0;for(;c<d.notes.length;){const _=d.notes[c];i(_.start)>=i(_.end)?this.append(new yi(e,d,_,c,!0)):(this.append(new cu(e,_,i)),c++)}}this.append(new ah(e,e.song.tempo,e.song.tempo*t/e.song.beatsPerBar))}break;case"overflow":this.append(new su(e,t,0)),e.song.loopStart=0,e.song.loopLength=e.song.barCount;break;default:throw new Error("Unrecognized beats-per-bar conversion strategy.")}e.song.beatsPerBar=t,e.notifier.changed(),this._didSomething()}}}class sp extends Zt{constructor(e,t){super(),e.song.scale!=t&&(e.song.scale=t,e.notifier.changed(),this._didSomething())}}class rp extends Zt{constructor(e){super();const t=e.song,n=w.keys[t.key].basePitch,i=[0,0,0,0,0,0,0,0,0,0,0,0];for(let d=0;d<t.pitchChannelCount;d++)for(let c=0;c<t.barCount;c++){const _=t.getPattern(d,c);if(_!=null)for(const m of _.notes){const g=m.pins[0];for(let S=1;S<m.pins.length;S++){const E=m.pins[S];if(g.interval==E.interval){let A=E.time-g.time;A+=Math.max(0,Math.min(w.partsPerBeat,E.time+m.start)-(g.time+m.start)),A*=E.size+g.size;for(const C of m.pitches){const k=(n+g.interval+C)%12;i[k]+=A}}}}}let s=0,h=0;for(let d=0;d<12;d++){const c=i[d]*(3*i[(d+7)%12]+i[(d+4)%12]+i[(d+3)%12]);h<c&&(h=c,s=d)}if(s!=t.key){const d=t.key-s,c=Math.abs(d);for(let _=0;_<t.pitchChannelCount;_++)for(const m of t.channels[_].patterns)for(let g=0;g<c;g++)this.append(new _u(e,_,m,d>0,!0));t.key=s,e.notifier.changed(),this._didSomething()}}}function $a(r){const e=[];for(let t=0;t<Lt.presetCategories.length;t++){const n=Lt.presetCategories[t];if(n.name!="Novelty Presets")for(let i=0;i<n.presets.length;i++){const s=n.presets[i];s.settings!=null&&s.isNoise==!0==r&&e.push((t<<6)+i)}}return e[Math.random()*e.length|0]}function du(r){for(let e=0;e<r.channels.length;e++)for(const t of r.channels[e].instruments){const n=r.getChannelIsNoise(e),i=r.getChannelIsMod(e),s=e==r.pitchChannelCount?Lt.nameToPresetValue(Math.random()>.5?"chip noise":"standard drumset"):$a(n),h=Lt.valueToPreset(s);t.fromJsonObject(h.settings,n,i,r.rhythm==0||r.rhythm==2,r.rhythm>=2,1),t.preset=s}}class Ra extends Zt{constructor(e,t){super();let n=e.song.pitchChannelCount,i=e.song.noiseChannelCount,s=e.song.modChannelCount;if(e.song.fromBase64String(t),(n!=e.song.pitchChannelCount||i!=e.song.noiseChannelCount||s!=e.song.modChannelCount)&&Q.resetColors(),t==""){this.append(new Fn(e,0,0)),e.selection.resetBoxSelection(),du(e.song),e.song.scale=e.prefs.defaultScale;for(let h=0;h<=e.song.channels.length;h++)e.viewedInstrument[h]=0,e.recentPatternInstruments[h]=[0];e.viewedInstrument.length=e.song.channels.length}else this.append(new uu(e));e.synth.computeLatestModValues(),e.notifier.changed(),this._didSomething()}}class uu extends it{constructor(e){super();const t=Math.min(e.channel,e.song.getChannelCount()-1),n=Math.max(0,Math.min(e.song.barCount-1,e.bar));(e.channel!=t||e.bar!=n)&&(e.bar=n,e.channel=t,this._didSomething()),e.selection.scrollToSelectedPattern(),e.notifier.changed()}}class fu extends Zt{constructor(e,t,n,i){super();const s=e.song;function h(c,_){for(;c.length>_;){let m=c.length-1,g=0;for(let S=0;S<c.length-1;S++){let E=0;for(const A of c[S].bars)A==0&&E++;E>=g&&(m=S,g=E)}c.splice(m,1)}}for(h(t,w.pitchChannelCountMax),h(n,w.noiseChannelCountMax),h(i,w.modChannelCountMax);t.length<w.pitchChannelCountMin;)t.push(new ao);for(;n.length<w.noiseChannelCountMin;)n.push(new ao);for(;i.length<w.modChannelCountMin;)i.push(new ao);s.barCount=1,s.patternsPerChannel=8;const d=t.concat(n.concat(i));for(let c=0;c<d.length;c++){const _=d[c];s.barCount=Math.max(s.barCount,_.bars.length),s.patternsPerChannel=Math.max(s.patternsPerChannel,_.patterns.length),s.channels[c]=_}s.channels.length=d.length,s.pitchChannelCount=t.length,s.noiseChannelCount=n.length,s.modChannelCount=i.length,s.barCount=Math.min(w.barCountMax,s.barCount),s.patternsPerChannel=Math.min(w.barCountMax,s.patternsPerChannel);for(let c=0;c<s.channels.length;c++){const _=s.channels[c];for(let m=0;m<_.bars.length;m++)(_.bars[m]>s.patternsPerChannel||_.bars[m]<0)&&(_.bars[m]=0);for(;_.bars.length<s.barCount;)_.bars.push(0);_.bars.length=s.barCount,_.instruments.length>s.getMaxInstrumentsPerChannel()&&(_.instruments.length=s.getMaxInstrumentsPerChannel());for(const m of _.patterns)Yo(m.instruments,s,c);for(;_.patterns.length<s.patternsPerChannel;)_.patterns.push(new Vr);_.patterns.length=s.patternsPerChannel}s.loopStart=Math.max(0,Math.min(s.barCount-1,s.loopStart)),s.loopLength=Math.min(s.barCount-s.loopStart,s.loopLength),this.append(new uu(e)),e.notifier.changed(),this._didSomething(),Q.resetColors()}}function oh(r,e){if(r.length!=e.length)return!1;for(let t=0;t<r.length;t++){const n=r[t],i=e[t];if(i.start!=n.start||i.end!=n.end||i.pitches.length!=n.pitches.length||i.pins.length!=n.pins.length)return!1;for(let s=0;s<n.pitches.length;s++)if(i.pitches[s]!=n.pitches[s])return!1;for(let s=0;s<n.pins.length;s++)if(i.pins[s].interval!=n.pins[s].interval||i.pins[s].time!=n.pins[s].time||i.pins[s].size!=n.pins[s].size)return!1}return!0}function lo(r){for(const e of r){const t=[];for(let n=0;n<e.bars.length;n++){if(e.bars[n]==0)continue;const i=e.patterns[e.bars[n]-1];let s=!1;for(let h=0;h<t.length;h++){const d=t[h];if(!(!Ta(i.instruments,d.instruments)||d.notes.length!=i.notes.length)&&oh(i.notes,d.notes)){s=!0,e.bars[n]=h+1;break}}s||(t.push(i),e.bars[n]=t.length)}for(let n=0;n<t.length;n++)e.patterns[n]=t[n];e.patterns.length=t.length}}class ah extends it{constructor(e,t,n){super(),e.song.tempo=Math.max(w.tempoMin,Math.min(w.tempoMax,Math.round(n))),e.synth.unsetMod(w.modulators.dictionary.tempo.index),e.notifier.changed(),t!=n&&this._didSomething()}}class op extends Yn{constructor(e,t,n){super(e),this._instrument.echoDelay=n,e.synth.unsetMod(w.modulators.dictionary["echo delay"].index,e.channel,e.getCurrentInstrument()),e.notifier.changed(),t!=n&&this._didSomething()}}class ap extends Yn{constructor(e,t,n){super(e),this._instrument.echoSustain=n,e.synth.unsetMod(w.modulators.dictionary.echo.index,e.channel,e.getCurrentInstrument()),e.notifier.changed(),t!=n&&this._didSomething()}}class lp extends Yn{constructor(e,t,n){super(e),this._instrument.chorus=n,e.notifier.changed(),t!=n&&this._didSomething()}}class hp extends Yn{constructor(e,t,n){super(e),this._instrument.reverb=n,e.synth.unsetMod(w.modulators.dictionary.reverb.index,e.channel,e.getCurrentInstrument()),e.notifier.changed(),t!=n&&this._didSomething()}}class yi extends rs{constructor(t,n,i,s,h=!1){super(h);a(this,"_doc");a(this,"_pattern");a(this,"_note");a(this,"_index");this._doc=t,this._pattern=n,this._note=i,this._index=s,this._didSomething(),this.redo()}_doForwards(){this._pattern.notes.splice(this._index,0,this._note),this._doc.notifier.changed()}_doBackwards(){this._pattern.notes.splice(this._index,1),this._doc.notifier.changed()}}class ss extends Xa{constructor(e,t,n,i){super(e,t);const s=(this._oldStart<0||t.continuesLastPattern)&&n==0;n-=this._oldStart,i-=this._oldStart;let h=!1,d=this._oldPins[0].size,c=this._oldPins[0].interval,_=!0,m;for(m=0;m<this._oldPins.length;m++){const g=this._oldPins[m];if(g.time<n)d=g.size,c=g.interval;else if(g.time>n&&!h&&(this._newPins.push(Nt(c,n,d)),h=!0),g.time<=i){if(this._newPins.push(Nt(g.interval,g.time,g.size)),g.time==i){_=!1;break}}else break}_&&this._newPins.push(Nt(this._oldPins[m].interval,i,this._oldPins[m].size)),this._finishSetup(s)}}class _s extends Zn{constructor(e,t,n,i,s=null,h=!1){super();let d=0;for(;d<t.notes.length;){const c=t.notes[d];if(c==s&&s!=null)d++;else if(c.end<=n)d++;else if(c.start>=i)if(e.song.getChannelIsMod(e.channel))d++;else break;else if(c.start<n&&c.end>i){if(!e.song.getChannelIsMod(e.channel)||h||s!=null&&c.pitches[0]==s.pitches[0]){const _=c.clone();this.append(new ss(e,c,c.start,n)),d++,this.append(new yi(e,t,_,d,!1)),this.append(new ss(e,_,i,_.end))}d++}else c.start<n?((!e.song.getChannelIsMod(e.channel)||h||s!=null&&c.pitches[0]==s.pitches[0])&&this.append(new ss(e,c,c.start,n)),d++):c.end>i?((!e.song.getChannelIsMod(e.channel)||h||s!=null&&c.pitches[0]==s.pitches[0])&&this.append(new ss(e,c,i,c.end)),d++):!e.song.getChannelIsMod(e.channel)||h||s!=null&&c.pitches[0]==s.pitches[0]?this.append(new yi(e,t,c,d,!0)):d++}}}class Ch extends Zn{constructor(e,t){super();let n=0;for(;n<t.notes.length;){const i=t.notes[n];if(i.start<e.selection.patternSelectionStart&&e.selection.patternSelectionStart<i.end){const s=i.clone();this.append(new ss(e,i,i.start,e.selection.patternSelectionStart)),n++,this.append(new yi(e,t,s,n,!1)),this.append(new ss(e,s,e.selection.patternSelectionStart,s.end))}else if(i.start<e.selection.patternSelectionEnd&&e.selection.patternSelectionEnd<i.end){const s=i.clone();this.append(new ss(e,i,i.start,e.selection.patternSelectionEnd)),n++,this.append(new yi(e,t,s,n,!1)),this.append(new ss(e,s,e.selection.patternSelectionEnd,s.end)),n++}else n++}}}class pu extends rs{constructor(t,n,i,s,h=!1,d=!1){super(!1);a(this,"_doc");a(this,"_note");a(this,"_oldStart",0);a(this,"_newStart",0);a(this,"_oldEnd",0);a(this,"_newEnd",0);a(this,"_oldPins");a(this,"_newPins");a(this,"_oldPitches");a(this,"_newPitches");this._doc=t,this._note=i,this._oldPins=i.pins,this._newPins=[],this._oldPitches=i.pitches,this._newPitches=[];const c=t.song.getChannelIsNoise(n);if(c!=t.song.getChannelIsNoise(t.channel)||t.song.getChannelIsMod(t.channel))return;const _=c?w.drumCount-1:w.maxPitch;for(let S=0;S<this._oldPitches.length;S++){let E=this._oldPitches[S];if(d&&!c)s?E=Math.min(_,E+12):E=Math.max(0,E-12);else if(s){for(let C=E+1;C<=_;C++)if(c||h||w.scales[t.song.scale].flags[C%12]){E=C;break}}else for(let C=E-1;C>=0;C--)if(c||h||w.scales[t.song.scale].flags[C%12]){E=C;break}let A=!1;for(let C=0;C<this._newPitches.length;C++)if(this._newPitches[C]==E){A=!0;break}A||this._newPitches.push(E)}let m=0,g=_;for(let S=1;S<this._newPitches.length;S++){const E=this._newPitches[0]-this._newPitches[S];m<E&&(m=E),g>E+_&&(g=E+_)}for(const S of this._oldPins){let E=S.interval+this._oldPitches[0];if(E<m&&(E=m),E>g&&(E=g),d&&!c)s?E=Math.min(g,E+12):E=Math.max(m,E-12);else if(s){for(let A=E+1;A<=g;A++)if(c||h||w.scales[t.song.scale].flags[A%12]){E=A;break}}else for(let A=E-1;A>=m;A--)if(c||h||w.scales[t.song.scale].flags[A%12]){E=A;break}E-=this._newPitches[0],this._newPins.push(Nt(E,S.time,S.size))}if(this._newPins[0].interval!=0)throw new Error("wrong pin start interval");for(let S=1;S<this._newPins.length-1;)this._newPins[S-1].interval==this._newPins[S].interval&&this._newPins[S].interval==this._newPins[S+1].interval&&this._newPins[S-1].size==this._newPins[S].size&&this._newPins[S].size==this._newPins[S+1].size?this._newPins.splice(S,1):S++;this._doForwards(),this._didSomething()}_doForwards(){this._note.pins=this._newPins,this._note.pitches=this._newPitches,this._doc.notifier.changed()}_doBackwards(){this._note.pins=this._oldPins,this._note.pitches=this._oldPitches,this._doc.notifier.changed()}}class _u extends Zn{constructor(e,t,n,i,s=!1,h=!1){super(),e.selection.patternSelectionActive&&this.append(new Ch(e,n));for(const d of n.notes)e.selection.patternSelectionActive&&(d.end<=e.selection.patternSelectionStart||d.start>=e.selection.patternSelectionEnd)||this.append(new pu(e,t,d,i,s,h))}}class cp extends it{constructor(e,t,n,i,s){super(),e.selection.boxSelectionX0=t,e.selection.boxSelectionX1=n,e.selection.boxSelectionY0=i,e.selection.boxSelectionY1=s,e.notifier.changed(),this._didSomething()}}class Fn extends rs{constructor(t,n,i){super(!1);a(this,"_doc");a(this,"_oldStart");a(this,"_oldEnd");a(this,"_oldActive");a(this,"_newStart");a(this,"_newEnd");a(this,"_newActive");this._doc=t,this._oldStart=t.selection.patternSelectionStart,this._oldEnd=t.selection.patternSelectionEnd,this._oldActive=t.selection.patternSelectionActive,this._newStart=n,this._newEnd=i,this._newActive=n<i,this._doForwards(),this._didSomething()}_doForwards(){this._doc.selection.patternSelectionStart=this._newStart,this._doc.selection.patternSelectionEnd=this._newEnd,this._doc.selection.patternSelectionActive=this._newActive,this._doc.notifier.changed()}_doBackwards(){this._doc.selection.patternSelectionStart=this._oldStart,this._doc.selection.patternSelectionEnd=this._oldEnd,this._doc.selection.patternSelectionActive=this._oldActive,this._doc.notifier.changed()}}class dp extends Zn{constructor(e,t,n,i,s){if(super(),i==0&&s==0)return;e.selection.patternSelectionActive&&this.append(new Ch(e,n));const h=e.selection.patternSelectionStart,d=e.selection.patternSelectionEnd,c=Math.max(0,Math.min(e.song.beatsPerBar*w.partsPerBeat,h+i)),_=Math.max(0,Math.min(e.song.beatsPerBar*w.partsPerBeat,d+i));c==_?this.append(new _s(e,n,h,d,null,!0)):i<0?this.append(new _s(e,n,c,Math.min(h,_),null,!0)):this.append(new _s(e,n,Math.max(d,c),_,null,!0)),this.append(new Fn(e,c,_));const m=[];let g=0,S=0;for(;S<n.notes.length;){const E=n.notes[S];E.end<=h||E.start>=d?(S++,E.end<=c&&(g=S)):(m.push(E.clone()),this.append(new yi(e,n,E,S,!0)))}for(const E of m)if(E.start+=i,E.end+=i,!(E.end<=c)&&!(E.start>=_)){this.append(new yi(e,n,E,g++,!1)),this.append(new ss(e,E,Math.max(E.start,c),Math.min(_,E.end)));for(let A=0;A<Math.abs(s);A++)this.append(new pu(e,t,E,s>0,e.prefs.notesOutsideScale))}}}class er extends Zt{constructor(e,t,n,i,s){super();for(let h=i;h<i+s;h++){const d={};for(let c=t;c<t+n;c++){const _=e.song.channels[h].bars[c];if(_!=0){if(d[String(_)]==null){let m=!1;for(let g=0;g<e.song.barCount;g++)if((g<t||g>=t+n)&&e.song.channels[h].bars[g]==_){m=!0;break}if(m){const g=e.song.getPattern(h,c);this.append(new Xi(e,0,c,h,1,1)),this.append(new ur(e,h,c));const S=e.song.getPattern(h,c);if(S==null)throw new Error;this.append(new Pa(e,S,g.notes,0,w.partsPerBeat*e.song.beatsPerBar,w.partsPerBeat*e.song.beatsPerBar)),S.instruments.length=0,S.instruments.push(...g.instruments),d[String(_)]=e.song.channels[h].bars[c]}else d[String(_)]=_}this.append(new Xi(e,d[String(_)],c,h,1,1))}}}}}class up extends it{constructor(e,t,n){super(),e.selection.patternSelectionActive&&new Ch(e,t);const i=w.maxPitch;for(const s of t.notes){if(e.selection.patternSelectionActive&&(s.end<=e.selection.patternSelectionStart||s.start>=e.selection.patternSelectionEnd))continue;const h=[],d=[];for(let m=0;m<s.pitches.length;m++){const g=s.pitches[m],S=n[g%12]+(g-g%12);h.indexOf(S)==-1&&h.push(S)}let c=0,_=i;for(let m=1;m<h.length;m++){const g=h[0]-h[m];c<g&&(c=g),_>g+i&&(_=g+i)}for(const m of s.pins){let g=m.interval+s.pitches[0];g<c&&(g=c),g>_&&(g=_);const S=n[g%12]+(g-g%12);d.push(Nt(S-h[0],m.time,m.size))}if(d[0].interval!=0)throw new Error("wrong pin start interval");for(let m=1;m<d.length-1;)d[m-1].interval==d[m].interval&&d[m].interval==d[m+1].interval&&d[m-1].size==d[m].size&&d[m].size==d[m+1].size?d.splice(m,1):m++;s.pitches=h,s.pins=d}this._didSomething(),e.notifier.changed()}}class wl extends it{constructor(e,t,n){super(),e.song.channels[e.channel].instruments[e.getCurrentInstrument()].volume=n,e.notifier.changed(),t!=n&&this._didSomething()}}class fp extends it{constructor(e,t,n){super(),n.length>30&&(n=n.substring(0,30)),e.song.title=n,document.title=n+" - "+Lt.versionDisplayName,e.notifier.changed(),t!=n&&this._didSomething()}}class pp extends it{constructor(e,t,n){super(),n.length>15&&(n=n.substring(0,15)),e.song.channels[e.muteEditorChannel].name=n,e.recalcChannelNames=!0,e.notifier.changed(),t!=n&&this._didSomething()}}class cc extends it{constructor(e,t,n){super(),e.song.channels[e.channel].instruments[e.getCurrentInstrument()].pan=n,e.synth.unsetMod(w.modulators.dictionary.pan.index,e.channel,e.getCurrentInstrument()),e.notifier.changed(),t!=n&&this._didSomething()}}class _p extends it{constructor(e,t,n){super(),e.song.channels[e.channel].instruments[e.getCurrentInstrument()].panDelay=n,e.notifier.changed(),t!=n&&this._didSomething()}}class xr extends rs{constructor(t,n,i,s,h,d){super(!1);a(this,"_doc");a(this,"_note");a(this,"_oldPins");a(this,"_newPins");this._doc=t,this._note=n,this._oldPins=n.pins,this._newPins=[];let c=!1;for(const _ of n.pins)_.time<i?d?this._newPins.push(Nt(_.interval,_.time,s)):this._newPins.push(_):_.time==i?(this._newPins.push(Nt(h,i,s)),c=!0):(!d&&!c&&(this._newPins.push(Nt(h,i,s)),c=!0),d?this._newPins.push(Nt(_.interval,_.time,s)):this._newPins.push(_));xh(this._newPins),this._doForwards(),this._didSomething()}_doForwards(){this._note.pins=this._newPins,this._doc.notifier.changed()}_doBackwards(){this._note.pins=this._oldPins,this._doc.notifier.changed()}}class mp extends it{constructor(e,t){super();const n=e.song.channels[e.channel].instruments[e.getCurrentInstrument()];n.chipWave!=t&&(n.chipWave=t,n.preset=n.type,e.notifier.changed(),this._didSomething())}}class gp extends it{constructor(e,t){super();const n=e.song.channels[e.channel].instruments[e.getCurrentInstrument()];n.chipNoise!=t&&(n.chipNoise=t,n.preset=n.type,e.notifier.changed(),this._didSomething())}}class vp extends it{constructor(e){super();const t=e.song.channels[e.channel].instruments[e.getCurrentInstrument()];t.addEnvelope(0,0,0),t.preset=t.type,e.notifier.changed(),this._didSomething()}}class bp extends it{constructor(e,t){super();const n=e.song.channels[e.channel].instruments[e.getCurrentInstrument()];n.envelopeCount--;for(let i=t;i<n.envelopeCount;i++)n.envelopes[i].target=n.envelopes[i+1].target,n.envelopes[i].index=n.envelopes[i+1].index,n.envelopes[i].envelope=n.envelopes[i+1].envelope;n.preset=n.type,e.notifier.changed(),this._didSomething()}}class yp extends it{constructor(e,t,n,i){super();const s=e.song.channels[e.channel].instruments[e.getCurrentInstrument()],h=s.envelopes[t].target,d=s.envelopes[t].index;(h!=n||d!=i)&&(s.envelopes[t].target=n,s.envelopes[t].index=i,s.preset=s.type,e.notifier.changed(),this._didSomething())}}class wp extends it{constructor(e,t,n){super();const i=e.song.channels[e.channel].instruments[e.getCurrentInstrument()];i.envelopes[t].envelope!=n&&(i.envelopes[t].envelope=n,i.preset=i.type,e.notifier.changed(),this._didSomething())}}const{button:dc,div:zr,span:xp,h2:Sp,input:Cp,br:kp,select:Pp,option:xl}=Ke;class lr{constructor(e){a(this,"_beatsStepper",Cp({style:"width: 3em; margin-left: 1em;",type:"number",step:"1"}));a(this,"_conversionStrategySelect",Pp({style:"width: 100%;"},xl({value:"splice"},"Splice beats at end of bars."),xl({value:"stretch"},"Stretch notes to fit in bars."),xl({value:"overflow"},"Overflow notes across bars.")));a(this,"_cancelButton",dc({class:"cancelButton"}));a(this,"_okayButton",dc({class:"okayButton",style:"width:45%;"},"Okay"));a(this,"container",zr({class:"prompt noSelection",style:"width: 250px;"},Sp("Beats Per Bar"),zr({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},zr({style:"text-align: right;"},"Beats per bar:",kp(),xp({style:"font-size: smaller; color: ${ColorConfig.secondaryText};"},"(Multiples of 3 or 4 are recommended)")),this._beatsStepper),zr({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},zr({class:"selectContainer",style:"width: 100%;"},this._conversionStrategySelect)),zr({style:"display: flex; flex-direction: row-reverse; justify-content: space-between;"},this._okayButton),this._cancelButton));a(this,"_close",()=>{this._doc.undo()});a(this,"cleanUp",()=>{this._okayButton.removeEventListener("click",this._saveChanges),this._cancelButton.removeEventListener("click",this._close),this._beatsStepper.removeEventListener("keypress",lr._validateKey),this._beatsStepper.removeEventListener("blur",lr._validateNumber),this.container.removeEventListener("keydown",this._whenKeyPressed)});a(this,"_whenKeyPressed",e=>{e.target.tagName!="BUTTON"&&e.keyCode==13&&this._saveChanges()});a(this,"_saveChanges",()=>{window.localStorage.setItem("beatCountStrategy",this._conversionStrategySelect.value),this._doc.prompt=null,this._doc.record(new ip(this._doc,lr._validate(this._beatsStepper),this._conversionStrategySelect.value),!0)});this._doc=e,this._beatsStepper.value=this._doc.song.beatsPerBar+"",this._beatsStepper.min=w.beatsPerBarMin+"",this._beatsStepper.max=w.beatsPerBarMax+"";const t=window.localStorage.getItem("beatCountStrategy");t!=null&&(this._conversionStrategySelect.value=t),this._beatsStepper.select(),setTimeout(()=>this._beatsStepper.focus()),this._okayButton.addEventListener("click",this._saveChanges),this._cancelButton.addEventListener("click",this._close),this._beatsStepper.addEventListener("keypress",lr._validateKey),this._beatsStepper.addEventListener("blur",lr._validateNumber),this.container.addEventListener("keydown",this._whenKeyPressed)}static _validateKey(e){const t=e.which?e.which:e.keyCode;return t!=46&&t>31&&(t<48||t>57)?(e.preventDefault(),!0):!1}static _validateNumber(e){const t=e.target;t.value=String(lr._validate(t))}static _validate(e){return Math.floor(Math.max(Number(e.min),Math.min(Number(e.max),Number(e.value))))}}const{button:uc,div:fc,label:Xr,br:pc,h2:Ep,input:$r}=Ke;class ii{constructor(e){a(this,"_patternsStepper",$r({style:"width: 3em; margin-left: 1em;",type:"number",step:"1"}));a(this,"_pitchChannelStepper",$r({style:"width: 3em; margin-left: 1em;",type:"number",step:"1"}));a(this,"_drumChannelStepper",$r({style:"width: 3em; margin-left: 1em;",type:"number",step:"1"}));a(this,"_modChannelStepper",$r({style:"width: 3em; margin-left: 1em;",type:"number",step:"1"}));a(this,"_layeredInstrumentsBox",$r({style:"width: 3em; margin-left: 1em;",type:"checkbox"}));a(this,"_patternInstrumentsBox",$r({style:"width: 3em; margin-left: 1em;",type:"checkbox"}));a(this,"_cancelButton",uc({class:"cancelButton"}));a(this,"_okayButton",uc({class:"okayButton",style:"width:45%;"},"Okay"));a(this,"container",fc({class:"prompt noSelection",style:"width: 250px; text-align: right;"},Ep("Channel Settings"),Xr({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},"Pitch channels:",this._pitchChannelStepper),Xr({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},"Drum channels:",this._drumChannelStepper),fc({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},"Mod channels:",this._modChannelStepper),Xr({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},"Available patterns per channel:",this._patternsStepper),Xr({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},"Simultaneous instruments",pc(),"per channel:",this._layeredInstrumentsBox),Xr({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},"Different instruments",pc(),"per pattern:",this._patternInstrumentsBox),Xr({style:"display: flex; flex-direction: row-reverse; justify-content: space-between;"},this._okayButton),this._cancelButton));a(this,"_close",()=>{this._doc.undo()});a(this,"cleanUp",()=>{this._okayButton.removeEventListener("click",this._saveChanges),this._cancelButton.removeEventListener("click",this._close),this._patternsStepper.removeEventListener("keypress",ii._validateKey),this._pitchChannelStepper.removeEventListener("keypress",ii._validateKey),this._drumChannelStepper.removeEventListener("keypress",ii._validateKey),this._modChannelStepper.removeEventListener("keypress",ii._validateKey),this._patternsStepper.removeEventListener("blur",this._validateNumber),this._pitchChannelStepper.removeEventListener("blur",this._validateNumber),this._drumChannelStepper.removeEventListener("blur",this._validateNumber),this._modChannelStepper.removeEventListener("blur",this._validateNumber),this.container.removeEventListener("keydown",this._whenKeyPressed)});a(this,"_whenKeyPressed",e=>{e.target.tagName!="BUTTON"&&e.keyCode==13&&this._saveChanges()});a(this,"_validateNumber",e=>{const t=e.target;t.value=String(ii._validate(t))});a(this,"_saveChanges",()=>{const e=new Zt;e.append(new Kf(this._doc,this._layeredInstrumentsBox.checked,this._patternInstrumentsBox.checked)),e.append(new Aa(this._doc,ii._validate(this._patternsStepper))),e.append(new Sh(this._doc,ii._validate(this._pitchChannelStepper),ii._validate(this._drumChannelStepper),ii._validate(this._modChannelStepper))),this._doc.prompt=null,this._doc.record(e,!0)});this._doc=e,this._patternsStepper.value=this._doc.song.patternsPerChannel+"",this._patternsStepper.min="1",this._patternsStepper.max=w.barCountMax+"",this._pitchChannelStepper.value=this._doc.song.pitchChannelCount+"",this._pitchChannelStepper.min=w.pitchChannelCountMin+"",this._pitchChannelStepper.max=w.pitchChannelCountMax+"",this._drumChannelStepper.value=this._doc.song.noiseChannelCount+"",this._drumChannelStepper.min=w.noiseChannelCountMin+"",this._drumChannelStepper.max=w.noiseChannelCountMax+"",this._modChannelStepper.value=this._doc.song.modChannelCount+"",this._modChannelStepper.min=w.modChannelCountMin+"",this._modChannelStepper.max=w.modChannelCountMax+"",this._layeredInstrumentsBox.checked=this._doc.song.layeredInstruments,this._patternInstrumentsBox.checked=this._doc.song.patternInstruments,this._pitchChannelStepper.select(),setTimeout(()=>this._pitchChannelStepper.focus()),this._okayButton.addEventListener("click",this._saveChanges),this._cancelButton.addEventListener("click",this._close),this._patternsStepper.addEventListener("keypress",ii._validateKey),this._pitchChannelStepper.addEventListener("keypress",ii._validateKey),this._drumChannelStepper.addEventListener("keypress",ii._validateKey),this._modChannelStepper.addEventListener("keypress",ii._validateKey),this._patternsStepper.addEventListener("blur",this._validateNumber),this._pitchChannelStepper.addEventListener("blur",this._validateNumber),this._drumChannelStepper.addEventListener("blur",this._validateNumber),this._modChannelStepper.addEventListener("blur",this._validateNumber),this.container.addEventListener("keydown",this._whenKeyPressed)}static _validateKey(e){const t=e.which?e.which:e.keyCode;return t!=46&&t>31&&(t<48||t>57)?(e.preventDefault(),!0):!1}static _validate(e){return Math.floor(Math.max(Number(e.min),Math.min(Number(e.max),Number(e.value))))}}const{button:Sl,div:ta,h2:Bp}=Ke;class Mp{constructor(e){a(this,"_doc");a(this,"_mouseX",0);a(this,"_mouseY",0);a(this,"_lastIndex",0);a(this,"_lastAmp",0);a(this,"_mouseDown",!1);a(this,"chipData",new Float32Array(64));a(this,"startingChipData",new Float32Array(64));a(this,"_undoHistoryState",0);a(this,"_changeQueue",[]);a(this,"_editorWidth",768);a(this,"_editorHeight",294);a(this,"_fill",me.path({fill:Q.uiWidgetBackground,"pointer-events":"none"}));a(this,"_ticks",me.svg({"pointer-events":"none"}));a(this,"_subticks",me.svg({"pointer-events":"none"}));a(this,"_blocks",me.svg({"pointer-events":"none"}));a(this,"_svg",me.svg({style:`background-color: ${Q.editorBackground}; touch-action: none; overflow: visible;`,width:"100%",height:"100%",viewBox:"0 0 "+this._editorWidth+" "+this._editorHeight,preserveAspectRatio:"none"},this._fill,this._ticks,this._subticks,this._blocks));a(this,"container",Ke.div({class:"",style:"height: 294px; width: 768px; padding-bottom: 1.5em;"},this._svg));a(this,"_storeChange",()=>{var e=!0;if(this._changeQueue.length>0)for(var t=0;t<64;t++)this._changeQueue[this._undoHistoryState][t]!=this.chipData[t]&&(e=!1,t=64);(e==!1||this._changeQueue.length==0)&&(this._changeQueue.splice(0,this._undoHistoryState),this._undoHistoryState=0,this._changeQueue.unshift(this.chipData.slice()),this._changeQueue.length>32&&this._changeQueue.pop())});a(this,"undo",()=>{this._undoHistoryState<this._changeQueue.length-1&&(this._undoHistoryState++,this.chipData=this._changeQueue[this._undoHistoryState].slice(),new pr(this._doc,this.chipData),this.render())});a(this,"redo",()=>{this._undoHistoryState>0&&(this._undoHistoryState--,this.chipData=this._changeQueue[this._undoHistoryState].slice(),new pr(this._doc,this.chipData),this.render())});a(this,"_whenKeyPressed",e=>{e.keyCode==90?(this.undo(),e.stopPropagation()):e.keyCode==89&&(this.redo(),e.stopPropagation())});a(this,"_whenMousePressed",e=>{e.preventDefault(),this._mouseDown=!0;const t=this._svg.getBoundingClientRect();this._mouseX=((e.clientX||e.pageX)-t.left)*this._editorWidth/(t.right-t.left),this._mouseY=((e.clientY||e.pageY)-t.top)*this._editorHeight/(t.bottom-t.top),isNaN(this._mouseX)&&(this._mouseX=0),isNaN(this._mouseY)&&(this._mouseY=0),this._lastIndex=-1,this._whenCursorMoved()});a(this,"_whenTouchPressed",e=>{e.preventDefault(),this._mouseDown=!0;const t=this._svg.getBoundingClientRect();this._mouseX=(e.touches[0].clientX-t.left)*this._editorWidth/(t.right-t.left),this._mouseY=(e.touches[0].clientY-t.top)*this._editorHeight/(t.bottom-t.top),isNaN(this._mouseX)&&(this._mouseX=0),isNaN(this._mouseY)&&(this._mouseY=0),this._lastIndex=-1,this._whenCursorMoved()});a(this,"_whenMouseMoved",e=>{if(this.container.offsetParent==null)return;const t=this._svg.getBoundingClientRect();this._mouseX=((e.clientX||e.pageX)-t.left)*this._editorWidth/(t.right-t.left),this._mouseY=((e.clientY||e.pageY)-t.top)*this._editorHeight/(t.bottom-t.top),isNaN(this._mouseX)&&(this._mouseX=0),isNaN(this._mouseY)&&(this._mouseY=0),this._whenCursorMoved()});a(this,"_whenTouchMoved",e=>{if(this.container.offsetParent==null||!this._mouseDown)return;e.preventDefault();const t=this._svg.getBoundingClientRect();this._mouseX=(e.touches[0].clientX-t.left)*this._editorWidth/(t.right-t.left),this._mouseY=(e.touches[0].clientY-t.top)*this._editorHeight/(t.bottom-t.top),isNaN(this._mouseX)&&(this._mouseX=0),isNaN(this._mouseY)&&(this._mouseY=0),this._whenCursorMoved()});a(this,"_whenCursorReleased",e=>{this._storeChange(),this._mouseDown=!1});this._doc=e;for(let n=0;n<=4;n+=2)this._ticks.appendChild(me.rect({fill:Q.tonic,x:n*this._editorWidth/4-1,y:0,width:2,height:this._editorHeight}));for(let n=1;n<=8;n++)this._subticks.appendChild(me.rect({fill:Q.fifthNote,x:n*this._editorWidth/8-1,y:0,width:1,height:this._editorHeight}));this._ticks.appendChild(me.rect({fill:Q.tonic,x:0,y:this._editorHeight/2-1,width:this._editorWidth,height:2}));for(let n=0;n<3;n++)this._subticks.appendChild(me.rect({fill:Q.fifthNote,x:0,y:n*8*(this._editorHeight/49),width:this._editorWidth,height:1})),this._subticks.appendChild(me.rect({fill:Q.fifthNote,x:0,y:this._editorHeight-1-n*8*(this._editorHeight/49),width:this._editorWidth,height:1}));let t=Q.getChannelColor(this._doc.song,this._doc.channel).primaryNote;for(let n=0;n<=64;n++){let i=this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()].customChipWave[n];this.chipData[n]=i,this.startingChipData[n]=i,this._blocks.appendChild(me.rect({fill:t,x:n*this._editorWidth/64,y:(i+24)*(this._editorHeight/49),width:this._editorWidth/64,height:this._editorHeight/49}))}this._storeChange(),this.container.addEventListener("mousedown",this._whenMousePressed),document.addEventListener("mousemove",this._whenMouseMoved),document.addEventListener("mouseup",this._whenCursorReleased),this.container.addEventListener("touchstart",this._whenTouchPressed),this.container.addEventListener("touchmove",this._whenTouchMoved),this.container.addEventListener("touchend",this._whenCursorReleased),this.container.addEventListener("touchcancel",this._whenCursorReleased),this._svg.addEventListener("keydown",this._whenKeyPressed),this.container.addEventListener("keydown",this._whenKeyPressed)}_whenCursorMoved(){if(this._mouseDown){const h=Math.min(63,Math.max(0,Math.floor(this._mouseX*64/this._editorWidth))),d=Math.min(48,Math.max(0,Math.floor(this._mouseY*49/this._editorHeight)));if(this._lastIndex!=-1&&this._lastIndex!=h){var e=h,t=this._lastIndex,n=d,i=this._lastAmp;this._lastIndex<h&&(e=this._lastIndex,t=h,n=this._lastAmp,i=d);for(var s=e;s<=t;s++){const c=Math.round(n+(i-n)*((s-e)/(t-e)));this.chipData[s]=c-24,this._blocks.children[s].setAttribute("y",""+c*(this._editorHeight/49))}}else this.chipData[h]=d-24,this._blocks.children[h].setAttribute("y",""+d*(this._editorHeight/49));new pr(this._doc,this.chipData),this._lastIndex=h,this._lastAmp=d}}render(){for(var e=0;e<64;e++)this._blocks.children[e].setAttribute("y",""+(this.chipData[e]+24)*(this._editorHeight/49))}}class bo{constructor(e,t){a(this,"customChipCanvas",new Mp(this._doc));a(this,"_playButton",Sl({style:"width: 55%;",type:"button"}));a(this,"_cancelButton",Sl({class:"cancelButton"}));a(this,"_okayButton",Sl({class:"okayButton",style:"width:45%;"},"Okay"));a(this,"container",ta({class:"prompt noSelection",style:"width: 600px;"},Bp("Edit Custom Chip Instrument"),ta({style:"display: flex; width: 55%; align-self: center; flex-direction: row; align-items: center; justify-content: center;"},this._playButton),ta({style:"display: flex; flex-direction: row; align-items: center; justify-content: center;"},this.customChipCanvas.container),ta({style:"display: flex; flex-direction: row-reverse; justify-content: space-between;"},this._okayButton),this._cancelButton));a(this,"_togglePlay",()=>{this._songEditor.togglePlay(),this.updatePlayButton()});a(this,"_close",()=>{this._doc.prompt=null,this._doc.undo()});a(this,"cleanUp",()=>{this._okayButton.removeEventListener("click",this._saveChanges),this._cancelButton.removeEventListener("click",this._close),this.container.removeEventListener("keydown",this.whenKeyPressed),this._playButton.removeEventListener("click",this._togglePlay)});a(this,"whenKeyPressed",e=>{e.target.tagName!="BUTTON"&&e.keyCode==13?this._saveChanges():e.keyCode==32?(this._togglePlay(),e.preventDefault()):e.keyCode==90?(this.customChipCanvas.undo(),e.stopPropagation()):e.keyCode==89?(this.customChipCanvas.redo(),e.stopPropagation()):e.keyCode==219?this._doc.synth.goToPrevBar():e.keyCode==221&&this._doc.synth.goToNextBar()});a(this,"_saveChanges",()=>{this._doc.prompt=null,new pr(this._doc,this.customChipCanvas.startingChipData),this._doc.record(new pr(this._doc,this.customChipCanvas.chipData),!0)});this._doc=e,this._songEditor=t,this._okayButton.addEventListener("click",this._saveChanges),this._cancelButton.addEventListener("click",this._close),this.container.addEventListener("keydown",this.whenKeyPressed),this._playButton.addEventListener("click",this._togglePlay),this.updatePlayButton(),setTimeout(()=>this._playButton.focus()),this.customChipCanvas.render()}updatePlayButton(){this._doc.synth.playing?(this._playButton.classList.remove("playButton"),this._playButton.classList.add("pauseButton"),this._playButton.title="Pause (Space)",this._playButton.innerText="Pause"):(this._playButton.classList.remove("pauseButton"),this._playButton.classList.add("playButton"),this._playButton.title="Play (Space)",this._playButton.innerText="Play")}}class Fo{constructor(e,t=!1,n=!1){a(this,"_editorWidth",120);a(this,"_editorHeight",26);a(this,"_responsePath",me.path({fill:Q.uiWidgetBackground,"pointer-events":"none"}));a(this,"_indicators",[]);a(this,"_subFilters",[]);a(this,"_controlPointPath",me.path({fill:"currentColor","pointer-events":"none"}));a(this,"_dottedLinePath",me.path({fill:"none",stroke:"currentColor","stroke-width":1,"stroke-dasharray":"3, 2","pointer-events":"none"}));a(this,"_highlight",me.circle({fill:"white",stroke:"none","pointer-events":"none",r:4}));a(this,"_svg",me.svg({style:`background-color: ${Q.editorBackground}; touch-action: none;`,width:"100%",height:"100%",viewBox:"0 0 "+this._editorWidth+" "+this._editorHeight,preserveAspectRatio:"none"},this._responsePath,this._dottedLinePath,this._highlight,this._controlPointPath));a(this,"selfUndoSettings",[]);a(this,"selfUndoHistoryPos",0);a(this,"_label",Ke.div({style:"position: absolute; bottom: 0; left: 2px; font-size: 8px; line-height: 1; pointer-events: none;"}));a(this,"coordText",null);a(this,"container",Ke.div({class:"filterEditor",style:"height: 100%; position: relative;"},this._svg,this._label));a(this,"_pointRadius",2);a(this,"_useNoteFilter",!1);a(this,"_larger",!1);a(this,"_touchMode",!1);a(this,"_mouseX",0);a(this,"_mouseY",0);a(this,"_mouseOver",!1);a(this,"_mouseDown",!1);a(this,"_mouseDragging",!1);a(this,"_addingPoint",!1);a(this,"_deletingPoint",!1);a(this,"_addedType",Dn.peak);a(this,"_selectedIndex",0);a(this,"_freqStart",0);a(this,"_gainStart",0);a(this,"_dragChange",null);a(this,"_subfilterIndex",0);a(this,"_filterSettings",new us);a(this,"_renderedSelectedIndex",-1);a(this,"_renderedPointCount",-1);a(this,"_renderedPointTypes",-1);a(this,"_renderedPointFreqs",-1);a(this,"_renderedPointGains",-1);a(this,"_whenKeyPressed",e=>{e.keyCode==90&&(this.undo(),e.stopPropagation()),e.keyCode==89&&(this.redo(),e.stopPropagation())});a(this,"_whenMouseOver",e=>{this._mouseOver=!0,this._larger||this._controlPointPath.style.setProperty("fill","currentColor")});a(this,"_whenMouseOut",e=>{this._mouseOver=!1,this._updatePath(),this.coordText!=null&&(this.coordText.innerText="")});a(this,"_whenMousePressed",e=>{e.preventDefault(),this._touchMode=!1;const t=this._svg.getBoundingClientRect();this._mouseX=((e.clientX||e.pageX)-t.left)*this._editorWidth/(t.right-t.left),this._mouseY=((e.clientY||e.pageY)-t.top)*this._editorHeight/(t.bottom-t.top),isNaN(this._mouseX)&&(this._mouseX=0),isNaN(this._mouseY)&&(this._mouseY=0),this._whenCursorPressed()});a(this,"_whenTouchPressed",e=>{e.preventDefault(),this._touchMode=!0;const t=this._svg.getBoundingClientRect();this._mouseX=(e.touches[0].clientX-t.left)*this._editorWidth/(t.right-t.left),this._mouseY=(e.touches[0].clientY-t.top)*this._editorHeight/(t.bottom-t.top),isNaN(this._mouseX)&&(this._mouseX=0),isNaN(this._mouseY)&&(this._mouseY=0),this._whenCursorPressed()});a(this,"_whenMouseMoved",e=>{if(this.container.offsetParent==null)return;const t=this._svg.getBoundingClientRect();this._mouseX=((e.clientX||e.pageX)-t.left)*this._editorWidth/(t.right-t.left),this._mouseY=((e.clientY||e.pageY)-t.top)*this._editorHeight/(t.bottom-t.top),isNaN(this._mouseX)&&(this._mouseX=0),isNaN(this._mouseY)&&(this._mouseY=0),this._mouseDown||this._updateCursor(),this._whenCursorMoved()});a(this,"_whenTouchMoved",e=>{if(this.container.offsetParent==null)return;this._mouseDown&&e.preventDefault();const t=this._svg.getBoundingClientRect();this._mouseX=(e.touches[0].clientX-t.left)*this._editorWidth/(t.right-t.left),this._mouseY=(e.touches[0].clientY-t.top)*this._editorHeight/(t.bottom-t.top),isNaN(this._mouseX)&&(this._mouseX=0),isNaN(this._mouseY)&&(this._mouseY=0),this._mouseDown||this._updateCursor(),this._whenCursorMoved()});a(this,"_whenCursorReleased",e=>{if(this.container.offsetParent!=null){if(this._mouseDown&&this._doc.lastChangeWas(this._dragChange)&&this._dragChange!=null){if(!this._addingPoint&&!this._mouseDragging&&!this._touchMode){if(this._selectedIndex<this._filterSettings.controlPointCount&&this._selectedIndex!=-1){const t=this._filterSettings.controlPoints[this._selectedIndex];let n=new gl(this._doc,this._filterSettings,t,this._selectedIndex,this._useNoteFilter,!0);this._larger||this._doc.record(n)}}else this._larger||this._doc.record(this._dragChange);this._updatePath(),this._larger&&(this.selfUndoSettings.length=this.selfUndoHistoryPos+1,this.selfUndoSettings.push(JSON.stringify(this._filterSettings.toJsonObject())),this.selfUndoHistoryPos++)}this._dragChange=null,this._mouseDragging=!1,this._deletingPoint=!1,this._mouseDown=!1,this._updateCursor()}});if(this._doc=e,this._useNoteFilter=t,this._larger=n,this._larger){this.container.addEventListener("keydown",this._whenKeyPressed),this._editorWidth=1200,this._editorHeight=260,this._pointRadius=14,this._svg.setAttribute("viewBox","0 -20 "+this._editorWidth+" "+(this._editorHeight+30)),this._label.style.setProperty("font-size","16px"),this._label.style.setProperty("position",""),this._label.style.setProperty("bottom","-16px"),this._label.style.setProperty("min-height","1em"),this._dottedLinePath.style.setProperty("stroke-width","3"),this._dottedLinePath.style.setProperty("stroke-dasharray","6, 4"),this._dottedLinePath.setAttribute("color",Q.getChannelColor(this._doc.song,this._doc.channel).primaryNote),this.container.style.setProperty("width","85%"),this._highlight.setAttribute("r","20"),this._controlPointPath.setAttribute("fill",Q.getChannelColor(this._doc.song,this._doc.channel).primaryNote);for(let h=0;h<w.filterMaxPoints;h++)this._indicators[h]=me.text(),this._indicators[h].setAttribute("fill",Q.invertedText),this._indicators[h].setAttribute("text-anchor","start"),this._indicators[h].setAttribute("dominant-baseline","central"),this._indicators[h].setAttribute("pointer-events","none"),this._indicators[h].setAttribute("font-weight","bolder"),this._indicators[h].textContent=""+(h+1),this._indicators[h].style.setProperty("display","none"),this._indicators[h].style.setProperty("font-size","24px"),this._svg.appendChild(this._indicators[h]);const i=this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()],s=this._useNoteFilter?i.noteFilter:i.eqFilter;this.selfUndoSettings.push(JSON.stringify(s.toJsonObject())),this._subFilters[0]=s;for(let h=1;h<w.filterMorphCount;h++){const d=this._useNoteFilter?i.noteSubFilters[h]:i.eqSubFilters[h];if(d!=null){let c=new us;c.fromJsonObject(d.toJsonObject()),this._subFilters[h]=c}}}this.container.addEventListener("mousedown",this._whenMousePressed),this.container.addEventListener("mouseover",this._whenMouseOver),this.container.addEventListener("mouseout",this._whenMouseOut),document.addEventListener("mousemove",this._whenMouseMoved),document.addEventListener("mouseup",this._whenCursorReleased),this.container.addEventListener("touchstart",this._whenTouchPressed),this.container.addEventListener("touchmove",this._whenTouchMoved),this.container.addEventListener("touchend",this._whenCursorReleased),this.container.addEventListener("touchcancel",this._whenCursorReleased)}_xToFreq(e){return w.filterFreqRange*e/this._editorWidth-.5}_freqToX(e){return this._editorWidth*(e+.5)/w.filterFreqRange}_yToGain(e){return(w.filterGainRange-1)*(1-(e-.5)/(this._editorHeight-1))}_gainToY(e){return(this._editorHeight-1)*(1-e/(w.filterGainRange-1))+.5}_whenCursorPressed(){this._mouseDown=!0;const e=new Zn;this._dragChange=e,this._doc.setProspectiveChange(this._dragChange),this._updateCursor(),this._whenCursorMoved()}_updateCursor(){this._freqStart=this._xToFreq(this._mouseX),this._gainStart=this._yToGain(this._mouseY),this._addingPoint=!0,this._selectedIndex=-1;let e=Number.POSITIVE_INFINITY;for(let t=0;t<this._filterSettings.controlPointCount;t++){const n=this._filterSettings.controlPoints[t],i=Math.sqrt(Math.pow(this._freqToX(n.freq)-this._mouseX,2)+Math.pow(this._gainToY(n.gain)-this._mouseY,2));(i<=13*(1+ +this._larger)||this._filterSettings.controlPointCount>=w.filterMaxPoints)&&i<e&&(e=i,this._selectedIndex=t,this._addingPoint=!1)}if(this._addingPoint){const t=this._mouseX/this._editorWidth;t<.2?this._addedType=Dn.highPass:t<.8?this._addedType=Dn.peak:this._addedType=Dn.lowPass}}_whenCursorMoved(){if(this._dragChange!=null&&this._doc.lastChangeWas(this._dragChange)?this._dragChange.undo():this._mouseDown=!1,this._dragChange=null,this._deletingPoint=!1,this.coordText!=null&&!this._mouseDown){let e=Math.round(this._yToGain(this._mouseY)),t=Math.round(this._xToFreq(this._mouseX));t>=0&&t<w.filterFreqRange&&e>=0&&e<w.filterGainRange?this.coordText.innerText="("+t+", "+e+")":this.coordText.innerText=""}if(this._mouseDown){const e=new Zn;if(this._dragChange=e,this._doc.setProspectiveChange(this._dragChange),this._addingPoint){const t=Math.max(0,Math.min(w.filterGainRange-1,Math.round(this._yToGain(this._mouseY)))),n=this._findNearestFreqSlot(this._filterSettings,this._xToFreq(this._mouseX),-1);if(n>=0&&n<w.filterFreqRange){const i=new Ro;i.type=this._addedType,i.freq=n,i.gain=t,e.append(new gl(this._doc,this._filterSettings,i,this._filterSettings.controlPointCount,this._useNoteFilter)),this.coordText!=null&&(this.coordText.innerText="("+n+", "+t+")")}else this._deletingPoint=!0}else if(this._selectedIndex>=this._filterSettings.controlPointCount||this._selectedIndex==-1)this._dragChange=null,this._mouseDown=!1;else{const t=this._xToFreq(this._mouseX)-this._freqStart,n=this._yToGain(this._mouseY)-this._gainStart,i=this._filterSettings.controlPoints[this._selectedIndex],s=Math.max(0,Math.min(w.filterGainRange-1,Math.round(i.gain+n))),h=this._findNearestFreqSlot(this._filterSettings,i.freq+t,this._selectedIndex);(Math.round(t)!=0||Math.round(n)!=0||h!=i.freq||s!=i.gain)&&(this._mouseDragging=!0),h>=0&&h<w.filterFreqRange?(e.append(new Of(this._doc,i,i.freq,h,i.gain,s)),this.coordText!=null&&(this.coordText.innerText="("+h+", "+s+")")):(e.append(new gl(this._doc,this._filterSettings,i,this._selectedIndex,this._useNoteFilter,!0)),this._deletingPoint=!0)}}(this._mouseDown||this._mouseOver)&&this._updatePath()}_findNearestFreqSlot(e,t,n){const i=Math.round(t);let s=i,h=i,d=i<=t;for(;;){let c=!1;const _=d?s:h;for(let m=0;m<e.controlPointCount;m++)if(m!=n&&e.controlPoints[m].freq==_){c=!0;break}if(!c)return _;d=!d,d&&s--,d||h++}}static _circlePath(e,t,n,i=!1){return`M ${e-n} ${t} a ${n} ${n} 0 1 ${i?1:0} ${n*2} 0 a ${n} ${n} 0 1 ${i?1:0} ${-n*2} 0 `}_updatePath(){this._highlight.style.display="none",this._label.textContent="";let e="",t="";for(let d=0;d<this._filterSettings.controlPointCount;d++){const c=this._filterSettings.controlPoints[d],_=this._freqToX(c.freq),m=this._gainToY(c.gain);e+=Fo._circlePath(_,m,this._pointRadius),c.type==Dn.highPass?t+="M 0 "+m+" L "+_+" "+m+" ":c.type==Dn.lowPass&&(t+="M "+this._editorWidth+" "+m+" L "+_+" "+m+" "),this._selectedIndex==d&&this._mouseOver&&!this._mouseDown&&(this._highlight.setAttribute("cx",String(_)),this._highlight.setAttribute("cy",String(m)),this._highlight.style.display="",this.coordText!=null&&(this.coordText.innerText="("+c.freq+", "+c.gain+")")),(this._selectedIndex==d||this._addingPoint&&this._mouseDown&&d==this._filterSettings.controlPointCount-1)&&(this._mouseOver||this._mouseDown)&&!this._deletingPoint&&(this._label.textContent=d+1+": "+w.filterTypeNames[c.type]+(this._larger?" @"+Le(c.getHz())+"Hz":"")),this._larger&&(this._indicators[d].style.setProperty("display",""),this._indicators[d].setAttribute("x",""+(_-7)),this._indicators[d].setAttribute("y",""+(m+2)))}if(this._controlPointPath.setAttribute("d",e),this._dottedLinePath.setAttribute("d",t),this._addingPoint&&!this._mouseDown&&this._mouseOver&&(this._label.textContent="+ "+w.filterTypeNames[this._addedType]),this._larger)for(let d=this._filterSettings.controlPointCount;d<w.filterMaxPoints;d++)this._indicators[d].style.setProperty("display","none");const n=44800,i=[];for(let d=0;d<this._filterSettings.controlPointCount;d++){const c=this._filterSettings.controlPoints[d],_=new J0;c.toCoefficients(_,n),i.push(_)}const s=new ef;let h="M 0 "+this._editorHeight+" ";for(let d=-1;d<=w.filterFreqRange;d++){const c=Ro.getHzFromSettingValue(d),_=2*Math.PI*c/n,m=Math.cos(_),g=Math.sin(_);let S=1;for(const k of i)s.analyzeComplex(k,m,g),S*=s.magnitude();const E=Math.log2(S)/w.filterGainStep+w.filterGainCenter,A=this._gainToY(E),C=this._freqToX(d);h+="L "+Le(C)+" "+Le(A)+" "}h+="L "+this._editorWidth+" "+this._editorHeight+" L 0 "+this._editorHeight+" z ",this._responsePath.setAttribute("d",h)}swapToSettings(e,t=!1){const n=this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];new lc(this._doc,e,this._filterSettings,this._useNoteFilter,this._subFilters,this._useNoteFilter?n.noteSubFilters:n.eqSubFilters),this._filterSettings=e,this._subFilters[this._subfilterIndex]=e,t&&this._larger&&(this.selfUndoSettings.length=this.selfUndoHistoryPos+1,this.selfUndoSettings.push(JSON.stringify(this._filterSettings.toJsonObject())),this.selfUndoHistoryPos++),this._updatePath()}saveSettings(){let e=new us;const t=this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];e.fromJsonObject(JSON.parse(String(this.selfUndoSettings[0]))),this._doc.record(new lc(this._doc,this._subFilters[0],e,this._useNoteFilter,this._subFilters,this._useNoteFilter?t.noteSubFilters:t.eqSubFilters),!0)}undo(){if(this.selfUndoHistoryPos>0)if(this.selfUndoHistoryPos--,this.selfUndoSettings[this.selfUndoHistoryPos+1]!=null&&this.selfUndoSettings[this.selfUndoHistoryPos+1].startsWith("jmp")){let e=this.selfUndoSettings[this.selfUndoHistoryPos+1],t=+e.substring(3,e.indexOf("|"));return this.swapToSubfilter(this._subfilterIndex,t),t}else if(this.selfUndoSettings[this.selfUndoHistoryPos].startsWith("jmp")){let e=new us,t=this.selfUndoSettings[this.selfUndoHistoryPos];e.fromJsonObject(JSON.parse(t.substring(t.indexOf(":")+1))),this.swapToSettings(e,!1)}else{let e=new us;e.fromJsonObject(JSON.parse(String(this.selfUndoSettings[this.selfUndoHistoryPos]))),this.swapToSettings(e,!1)}return-1}redo(){if(this.selfUndoHistoryPos<this.selfUndoSettings.length-1)if(this.selfUndoHistoryPos++,this.selfUndoSettings[this.selfUndoHistoryPos].startsWith("jmp")){let e=this.selfUndoSettings[this.selfUndoHistoryPos],t=+e.substring(e.indexOf("|")+1,e.indexOf(":"));return this.swapToSubfilter(this._subfilterIndex,t,!1),t}else{let e=new us;e.fromJsonObject(JSON.parse(String(this.selfUndoSettings[this.selfUndoHistoryPos]))),this.swapToSettings(e,!1)}return-1}resetToInitial(){this.selfUndoHistoryPos=1,this.undo()}swapSubfilterIndices(e){if(this._selectedIndex==-1||e>=this._filterSettings.controlPointCount)return;let t=this._filterSettings.controlPoints[this._selectedIndex];this._filterSettings.controlPoints[this._selectedIndex]=this._filterSettings.controlPoints[e],this._filterSettings.controlPoints[e]=t,this.render()}swapToSubfilter(e,t,n=!1){if(e!=t){let i=new us;if(i.fromJsonObject(this._filterSettings.toJsonObject()),this._subFilters[e]=i,this._subFilters[t]==null){let s=new us;s.fromJsonObject(this._subFilters[0].toJsonObject()),this._subFilters[t]=s}n&&(this.selfUndoSettings.length=this.selfUndoHistoryPos+1,this.selfUndoSettings.push("jmp"+e+"|"+t+":"+JSON.stringify(this._subFilters[t].toJsonObject())),this.selfUndoHistoryPos++),this._subfilterIndex=t,this.swapToSettings(this._subFilters[t],!1)}}render(e=!1){const t=this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()],n=this._useNoteFilter?t.noteFilter:t.eqFilter;let i=e&&!this._larger&&!this._mouseOver&&!this._mouseDragging&&!this._mouseDown&&this._doc.synth.playing;i?this._controlPointPath.style.setProperty("fill",`${Q.overwritingModSlider}`):this._larger||this._controlPointPath.style.setProperty("fill","currentColor"),this._filterSettings!=n&&(this._dragChange=null,this._mouseDown=!1),this._filterSettings=n;let s=n;this._mouseDown||this._updateCursor(),i&&(s=this._useNoteFilter?t.tmpNoteFilterStart:t.tmpEqFilterStart,s==null&&(s=this._useNoteFilter?t.noteFilter:t.eqFilter),this._filterSettings=s);let h=0,d=0,c=0;for(let _=0;_<s.controlPointCount;_++){const m=s.controlPoints[_];h=h*Dn.length+m.type,d=d*w.filterFreqRange+m.freq,c=c*w.filterGainRange+m.gain}(this._renderedSelectedIndex!=this._selectedIndex||this._renderedPointCount!=s.controlPointCount||this._renderedPointTypes!=h||this._renderedPointFreqs!=d||this._renderedPointGains!=c)&&(this._renderedSelectedIndex=this._selectedIndex,this._renderedPointCount=s.controlPointCount,this._renderedPointTypes=h,this._renderedPointFreqs=d,this._renderedPointGains=c,this._updatePath()),i&&(this._filterSettings=n)}}const{button:Sr,div:tr,h2:Tp,p:Ip}=Ke;class yo{constructor(e,t,n){a(this,"filterEditor");a(this,"filterData",new us);a(this,"startingFilterData",new us);a(this,"_subfilterIndex",0);a(this,"_playButton",Sr({style:"width: 55%;",type:"button"}));a(this,"_filterButtons",[]);a(this,"_filterButtonContainer",tr({class:"instrument-bar",style:"justify-content: center;"}));a(this,"_cancelButton",Sr({class:"cancelButton"}));a(this,"_okayButton",Sr({class:"okayButton",style:"width:45%;"},"Okay"));a(this,"_filterContainer",tr({style:"width: 100%; display: flex; flex-direction: row; align-items: center; justify-content: center;"}));a(this,"_editorTitle",tr({},Tp("Edit Filter")));a(this,"_filterCopyButton",Sr({style:"width:86px; margin-right: 5px;",class:"copyButton"},["Copy",me.svg({style:"flex-shrink: 0; position: absolute; left: 0; top: 50%; margin-top: -1em; pointer-events: none;",width:"2em",height:"2em",viewBox:"-5 -21 26 26"},[me.path({d:"M 0 -15 L 1 -15 L 1 0 L 13 0 L 13 1 L 0 1 L 0 -15 z M 2 -1 L 2 -17 L 10 -17 L 14 -13 L 14 -1 z M 3 -2 L 13 -2 L 13 -12 L 9 -12 L 9 -16 L 3 -16 z",fill:"currentColor"})])]));a(this,"_filterPasteButton",Sr({style:"width:86px;",class:"pasteButton"},["Paste",me.svg({style:"flex-shrink: 0; position: absolute; left: 0; top: 50%; margin-top: -1em; pointer-events: none;",width:"2em",height:"2em",viewBox:"0 0 26 26"},[me.path({d:"M 8 18 L 6 18 L 6 5 L 17 5 L 17 7 M 9 8 L 16 8 L 20 12 L 20 22 L 9 22 z",stroke:"currentColor",fill:"none"}),me.path({d:"M 9 3 L 14 3 L 14 6 L 9 6 L 9 3 z M 16 8 L 20 12 L 16 12 L 16 8 z",fill:"currentColor"})])]));a(this,"_filterCopyPasteContainer",tr({style:"width: 185px;"},this._filterCopyButton,this._filterPasteButton));a(this,"_filterCoordinateText",tr({style:"text-align: left; margin-bottom: 0px; font-size: x-small; height: 1.3em; color: "+Q.secondaryText+";"},Ip("")));a(this,"container",tr({class:"prompt noSelection",style:"width: 600px;"},this._editorTitle,tr({style:"display: flex; width: 55%; align-self: center; flex-direction: row; align-items: center; justify-content: center;"},this._playButton),this._filterButtonContainer,this._filterContainer,tr({style:"display: flex; flex-direction: row-reverse; justify-content: space-between;"},this._okayButton,this._filterCopyPasteContainer),this._cancelButton));a(this,"_setSubfilter",(e,t=!0,n=!0)=>{this._filterButtons[this._subfilterIndex].classList.remove("selected-instrument"),n&&this.filterEditor.swapToSubfilter(this._subfilterIndex,e,t),this._subfilterIndex=e,this._filterButtons[e].classList.add("selected-instrument")});a(this,"_copyFilterSettings",()=>{const e=this._useNoteFilter?this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()].noteFilter.toJsonObject():this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()].eqFilter.toJsonObject();window.localStorage.setItem("filterCopy",JSON.stringify(e))});a(this,"_pasteFilterSettings",()=>{let e=new us;e.fromJsonObject(JSON.parse(String(window.localStorage.getItem("filterCopy")))),e!=null&&this.filterEditor.swapToSettings(e,!0)});a(this,"_whenKeyPressed",e=>{if(e.keyCode==90){let t=this.filterEditor.undo();t>=0&&this._setSubfilter(t,!1,!1),e.stopPropagation()}if(e.keyCode==89){let t=this.filterEditor.redo();t>=0&&this._setSubfilter(t,!1,!1),e.stopPropagation()}e.keyCode>=49&&e.keyCode<=57&&(e.shiftKey||(this.filterEditor.swapSubfilterIndices(e.keyCode-49),e.stopPropagation()))});a(this,"_togglePlay",()=>{this._songEditor.togglePlay(),this.updatePlayButton()});a(this,"_close",()=>{this._doc.prompt=null,this.filterEditor.resetToInitial(),this._doc.undo()});a(this,"cleanUp",()=>{this._okayButton.removeEventListener("click",this._saveChanges),this._cancelButton.removeEventListener("click",this._close),this.container.removeEventListener("keydown",this.whenKeyPressed),this._playButton.removeEventListener("click",this._togglePlay)});a(this,"whenKeyPressed",e=>{e.target.tagName!="BUTTON"&&e.keyCode==13?this._saveChanges():e.keyCode==32?(this._togglePlay(),e.preventDefault()):e.keyCode==90?(this.filterEditor.undo(),e.stopPropagation()):e.keyCode==89?(this.filterEditor.redo(),e.stopPropagation()):e.keyCode==219?this._doc.synth.goToPrevBar():e.keyCode==221?this._doc.synth.goToNextBar():e.keyCode>=48&&e.keyCode<=57&&e.shiftKey&&this._setSubfilter(e.keyCode-48)});a(this,"_saveChanges",()=>{this._doc.prompt=null,this.filterEditor.saveSettings()});this._doc=e,this._songEditor=t,this._useNoteFilter=n,this._okayButton.addEventListener("click",this._saveChanges),this._cancelButton.addEventListener("click",this._close),this._playButton.addEventListener("click",this._togglePlay),this._filterCopyButton.addEventListener("click",this._copyFilterSettings),this._filterPasteButton.addEventListener("click",this._pasteFilterSettings),this.updatePlayButton();let i=Q.getChannelColor(this._doc.song,this._doc.channel);this.filterEditor=new Fo(e,n,!0),this._filterContainer.appendChild(this.filterEditor.container),this.filterEditor.container.insertBefore(this._filterCoordinateText,this.filterEditor.container.firstChild),this.filterEditor.coordText=this._filterCoordinateText,this._editorTitle.children[0].innerHTML=n?"Edit Note Filter":"Edit EQ Filter";let s=Sr({class:"no-underline",style:"max-width: 5em;"},"Main");this._filterButtonContainer.appendChild(s),this._filterButtons.push(s),s.addEventListener("click",()=>{this._setSubfilter(0)});for(let h=1;h<w.filterMorphCount;h++){let d=Sr({class:"no-underline",style:"max-width: 2em;"},""+h);this._filterButtons.push(d),this._filterButtonContainer.appendChild(d),d.addEventListener("click",()=>{this._setSubfilter(h)})}this._filterButtons[w.filterMorphCount-1].classList.add("last-button"),this._filterButtons[0].classList.add("selected-instrument"),this._filterButtonContainer.style.setProperty("--text-color-lit",i.primaryNote),this._filterButtonContainer.style.setProperty("--text-color-dim",i.secondaryNote),this._filterButtonContainer.style.setProperty("--background-color-lit",i.primaryChannel),this._filterButtonContainer.style.setProperty("--background-color-dim",i.secondaryChannel),this._filterContainer.addEventListener("keydown",this._whenKeyPressed),this.filterEditor.container.addEventListener("keydown",this._whenKeyPressed),this.container.addEventListener("keydown",this._whenKeyPressed),setTimeout(()=>this._playButton.focus()),this.filterEditor.render()}updatePlayButton(){this._doc.synth.playing?(this._playButton.classList.remove("playButton"),this._playButton.classList.add("pauseButton"),this._playButton.title="Pause (Space)",this._playButton.innerText="Pause"):(this._playButton.classList.remove("pauseButton"),this._playButton.classList.add("playButton"),this._playButton.title="Play (Space)",this._playButton.innerText="Play")}}function _c(r,e){const t=new ArrayBuffer(e);let n=0,i=Math.min(r.byteLength,t.byteLength);const s=[8,4,2,1];for(const d of s)if(i>=d){const c=h(d,r,t,n,i);n=c.nextOffset,i=c.leftBytes}return t;function h(d,c,_,m,g){let S=Uint8Array;switch(d){case 8:S=Float64Array;break;case 4:S=Float32Array;break;case 2:S=Uint16Array;break;case 1:S=Uint8Array;break;default:S=Uint8Array;break}const E=new S(c,m,g/d|0),A=new S(_,m,g/d|0);for(let C=0;C<A.length;C++)A[C]=E[C];return{nextOffset:E.byteOffset+E.byteLength,leftBytes:g-A.length*d}}}class Ap{constructor(e){a(this,"_writeIndex",0);a(this,"_fileSize",0);a(this,"_arrayBuffer");a(this,"_data");this._arrayBuffer=new ArrayBuffer(e),this._data=new DataView(this._arrayBuffer)}_addBytes(e){this._fileSize+=e,this._fileSize>this._arrayBuffer.byteLength&&(this._arrayBuffer=_c(this._arrayBuffer,Math.max(this._arrayBuffer.byteLength*2,this._fileSize)),this._data=new DataView(this._arrayBuffer))}getWriteIndex(){return this._writeIndex}rewriteUint32(e,t){this._data.setUint32(e,t>>>0,!1)}writeUint32(e){e=e>>>0,this._addBytes(4),this._data.setUint32(this._writeIndex,e,!1),this._writeIndex=this._fileSize}writeUint24(e){e=e>>>0,this._addBytes(3),this._data.setUint8(this._writeIndex,e>>16&255),this._data.setUint8(this._writeIndex+1,e>>8&255),this._data.setUint8(this._writeIndex+2,e&255),this._writeIndex=this._fileSize}writeUint16(e){e=e>>>0,this._addBytes(2),this._data.setUint16(this._writeIndex,e,!1),this._writeIndex=this._fileSize}writeUint8(e){e=e>>>0,this._addBytes(1),this._data.setUint8(this._writeIndex,e),this._writeIndex=this._fileSize}writeInt8(e){e=e|0,this._addBytes(1),this._data.setInt8(this._writeIndex,e),this._writeIndex=this._fileSize}writeMidi7Bits(e){if(e=e>>>0,e>=128)throw new Error("7 bit value contained 8th bit!");this._addBytes(1),this._data.setUint8(this._writeIndex,e),this._writeIndex=this._fileSize}writeMidiVariableLength(e){if(e=e>>>0,e>268435455)throw new Error("writeVariableLength value too big.");let t=!1;for(let n=0;n<4;n++){const i=21-n*7,s=e>>>i&127;(s!=0||n==3)&&(t=!0),t&&this.writeUint8((n==3?0:128)|s)}}writeMidiAscii(e){this.writeMidiVariableLength(e.length);for(let t=0;t<e.length;t++){const n=e.charCodeAt(t);if(n>127)throw new Error("Trying to write unicode character as ascii.");this.writeUint8(n)}}toCompactArrayBuffer(){return _c(this._arrayBuffer,this._fileSize)}}const Cl=127,kl=8192;var Oo=(r=>(r[r.header=1297377380]="header",r[r.track=1297379947]="track",r))(Oo||{}),kh=(r=>(r[r.singleTrack=0]="singleTrack",r[r.simultaneousTracks=1]="simultaneousTracks",r[r.independentTracks=2]="independentTracks",r))(kh||{}),jt=(r=>(r[r.noteOff=128]="noteOff",r[r.noteOn=144]="noteOn",r[r.keyPressure=160]="keyPressure",r[r.controlChange=176]="controlChange",r[r.programChange=192]="programChange",r[r.channelPressure=208]="channelPressure",r[r.pitchBend=224]="pitchBend",r[r.metaAndSysex=240]="metaAndSysex",r[r.meta=255]="meta",r))(jt||{}),Wn=(r=>(r[r.setParameterMSB=6]="setParameterMSB",r[r.volumeMSB=7]="volumeMSB",r[r.panMSB=10]="panMSB",r[r.expressionMSB=11]="expressionMSB",r[r.setParameterLSB=38]="setParameterLSB",r[r.registeredParameterNumberLSB=100]="registeredParameterNumberLSB",r[r.registeredParameterNumberMSB=101]="registeredParameterNumberMSB",r))(Wn||{}),Ho=(r=>(r[r.pitchBendRange=0]="pitchBendRange",r[r.fineTuning=0]="fineTuning",r[r.coarseTuning=0]="coarseTuning",r[r.tuningProgramSelect=0]="tuningProgramSelect",r[r.tuningBankSelect=0]="tuningBankSelect",r[r.reset=127]="reset",r))(Ho||{}),Vo=(r=>(r[r.pitchBendRange=0]="pitchBendRange",r[r.fineTuning=1]="fineTuning",r[r.coarseTuning=2]="coarseTuning",r[r.tuningProgramSelect=3]="tuningProgramSelect",r[r.tuningBankSelect=4]="tuningBankSelect",r[r.reset=127]="reset",r))(Vo||{}),_i=(r=>(r[r.sequenceNumber=0]="sequenceNumber",r[r.text=1]="text",r[r.copyrightNotice=2]="copyrightNotice",r[r.trackName=3]="trackName",r[r.instrumentName=4]="instrumentName",r[r.lyricText=5]="lyricText",r[r.marker=6]="marker",r[r.cuePoint=7]="cuePoint",r[r.channelPrefix=32]="channelPrefix",r[r.endOfTrack=47]="endOfTrack",r[r.tempo=81]="tempo",r[r.smpteOffset=84]="smpteOffset",r[r.timeSignature=88]="timeSignature",r[r.keySignature=89]="keySignature",r[r.sequencerSpecificEvent=127]="sequencerSpecificEvent",r))(_i||{});const lh={35:{frequency:0,duration:2,volume:3},36:{frequency:0,duration:2,volume:3},37:{frequency:5,duration:1,volume:3},38:{frequency:4,duration:2,volume:3},39:{frequency:5,duration:2,volume:3},40:{frequency:4,duration:2,volume:3},41:{frequency:1,duration:2,volume:3},42:{frequency:8,duration:1,volume:3},43:{frequency:1,duration:2,volume:3},44:{frequency:8,duration:1,volume:2},45:{frequency:2,duration:2,volume:3},46:{frequency:8,duration:4,volume:3},47:{frequency:2,duration:2,volume:3},48:{frequency:3,duration:2,volume:3},49:{frequency:7,duration:4,volume:3},50:{frequency:3,duration:2,volume:3},51:{frequency:6,duration:4,volume:2},52:{frequency:7,duration:4,volume:3},53:{frequency:6,duration:2,volume:3},54:{frequency:11,duration:2,volume:3},55:{frequency:9,duration:4,volume:3},56:{frequency:7,duration:1,volume:2},57:{frequency:7,duration:4,volume:3},58:{frequency:10,duration:2,volume:2},59:{frequency:6,duration:4,volume:3},69:{frequency:10,duration:2,volume:3},70:{frequency:10,duration:2,volume:3},73:{frequency:10,duration:1,volume:2},74:{frequency:10,duration:2,volume:2}};function Rp(r){return Math.pow(r/127,4)/.3844015376046128}function Lp(r){return Math.pow(r*.3844015376046128,.25)*127}function Np(r){return Math.pow(r/127,4)}function Dp(r){return Math.pow(r,.25)*127}const{button:mc,div:Ln,h2:Fp,input:na,select:Op,option:wo}=Ke;function gc(r,e,t){return r+t*(e-r)}function xo(r,e){if(navigator.msSaveOrOpenBlob){navigator.msSaveOrOpenBlob(r,e);return}const t=document.createElement("a");if(t.download!=null){const n=URL.createObjectURL(r);setTimeout(function(){URL.revokeObjectURL(n)},6e4),t.href=n,t.download=e,setTimeout(function(){t.dispatchEvent(new MouseEvent("click"))},0)}else{const n=URL.createObjectURL(r);setTimeout(function(){URL.revokeObjectURL(n)},6e4),window.open(n,"_blank")||(window.location.href=n)}}const Is=class Is{constructor(e){a(this,"synth",null);a(this,"thenExportTo","");a(this,"recordedSamplesL",new Float32Array);a(this,"recordedSamplesR",new Float32Array);a(this,"sampleFrames",0);a(this,"totalChunks",0);a(this,"currentChunk",0);a(this,"outputStarted",!1);a(this,"_fileName",na({type:"text",style:"width: 10em;",value:"BeepBox-Song",maxlength:250,autofocus:"autofocus"}));a(this,"_computedSamplesLabel",Ln({style:"width: 10em;"},new Text("0:00")));a(this,"_enableIntro",na({type:"checkbox"}));a(this,"_loopDropDown",na({style:"width: 2em;",type:"number",min:"1",max:"4",step:"1"}));a(this,"_enableOutro",na({type:"checkbox"}));a(this,"_formatSelect",Op({style:"width: 100%;"},wo({value:"wav"},"Export to .wav file."),wo({value:"mp3"},"Export to .mp3 file."),wo({value:"midi"},"Export to .mid file."),wo({value:"json"},"Export to .json file."),wo({value:"html"},"Export to .html file.")));a(this,"_cancelButton",mc({class:"cancelButton"}));a(this,"_exportButton",mc({class:"exportButton",style:"width:45%;"},"Export"));a(this,"_outputProgressBar",Ln({style:`width: 0%; background: ${Q.loopAccent}; height: 100%; position: absolute; z-index: 2;`}));a(this,"_outputProgressLabel",Ln({style:"position: relative; top: -1px; z-index: 3;"},"0%"));a(this,"_outputProgressContainer",Ln({style:`height: 12px; background: ${Q.uiWidgetBackground}; display: block; position: relative; z-index: 1;`},this._outputProgressBar,this._outputProgressLabel));a(this,"container",Ln({class:"prompt noSelection",style:"width: 200px;"},Fp("Export Options"),Ln({style:"display: flex; flex-direction: row; align-items: center; justify-content: space-between;"},"File name:",this._fileName),Ln({style:"display: flex; flex-direction: row; align-items: center; justify-content: space-between;"},"Length:",this._computedSamplesLabel),Ln({style:"display: table; width: 100%;"},Ln({style:"display: table-row;"},Ln({style:"display: table-cell;"},"Intro:"),Ln({style:"display: table-cell;"},"Loop Count:"),Ln({style:"display: table-cell;"},"Outro:")),Ln({style:"display: table-row;"},Ln({style:"display: table-cell; vertical-align: middle;"},this._enableIntro),Ln({style:"display: table-cell; vertical-align: middle;"},this._loopDropDown),Ln({style:"display: table-cell; vertical-align: middle;"},this._enableOutro))),Ln({class:"selectContainer",style:"width: 100%;"},this._formatSelect),Ln({style:"text-align: left;"},"Exporting can be slow. Reloading the page or clicking the X will cancel it. Please be patient."),this._outputProgressContainer,Ln({style:"display: flex; flex-direction: row-reverse; justify-content: space-between;"},this._exportButton),this._cancelButton));a(this,"_close",()=>{this.synth!=null&&(this.synth.renderingSong=!1),this.outputStarted=!1,this._doc.undo()});a(this,"cleanUp",()=>{this._fileName.removeEventListener("input",Is._validateFileName),this._loopDropDown.removeEventListener("blur",Is._validateNumber),this._exportButton.removeEventListener("click",this._export),this._cancelButton.removeEventListener("click",this._close),this.container.removeEventListener("keydown",this._whenKeyPressed)});a(this,"_whenKeyPressed",e=>{e.target.tagName!="BUTTON"&&e.keyCode==13&&this._export()});a(this,"_export",()=>{if(this.outputStarted!=!0)switch(window.localStorage.setItem("exportFormat",this._formatSelect.value),this._formatSelect.value){case"wav":this.outputStarted=!0,this._exportTo("wav");break;case"mp3":this.outputStarted=!0,this._exportTo("mp3");break;case"midi":this.outputStarted=!0,this._exportToMidi();break;case"json":this.outputStarted=!0,this._exportToJson();break;case"html":this._exportToHtml();break;default:throw new Error("Unhandled file export type.")}});this._doc=e,this._loopDropDown.value="1",this._doc.song.loopStart==0?(this._enableIntro.checked=!1,this._enableIntro.disabled=!0):(this._enableIntro.checked=!0,this._enableIntro.disabled=!1),this._doc.song.loopStart+this._doc.song.loopLength==this._doc.song.barCount?(this._enableOutro.checked=!1,this._enableOutro.disabled=!0):(this._enableOutro.checked=!0,this._enableOutro.disabled=!1);const t=window.localStorage.getItem("exportFormat");t!=null&&(this._formatSelect.value=t),this._fileName.select(),setTimeout(()=>this._fileName.focus()),this._fileName.addEventListener("input",Is._validateFileName),this._loopDropDown.addEventListener("blur",Is._validateNumber),this._exportButton.addEventListener("click",this._export),this._cancelButton.addEventListener("click",this._close),this._enableOutro.addEventListener("click",()=>{this._computedSamplesLabel.firstChild.textContent=this.samplesToTime(this._doc.synth.getTotalSamples(this._enableIntro.checked,this._enableOutro.checked,+this._loopDropDown.value-1))}),this._enableIntro.addEventListener("click",()=>{this._computedSamplesLabel.firstChild.textContent=this.samplesToTime(this._doc.synth.getTotalSamples(this._enableIntro.checked,this._enableOutro.checked,+this._loopDropDown.value-1))}),this._loopDropDown.addEventListener("change",()=>{this._computedSamplesLabel.firstChild.textContent=this.samplesToTime(this._doc.synth.getTotalSamples(this._enableIntro.checked,this._enableOutro.checked,+this._loopDropDown.value-1))}),this.container.addEventListener("keydown",this._whenKeyPressed),this._fileName.value=e.song.title,Is._validateFileName(null,this._fileName),this._computedSamplesLabel.firstChild.textContent=this.samplesToTime(this._doc.synth.getTotalSamples(this._enableIntro.checked,this._enableOutro.checked,+this._loopDropDown.value-1))}samplesToTime(e){const t=Math.round(e/this._doc.synth.samplesPerSecond),n=t%60;return Math.floor(t/60)+":"+(n<10?"0":"")+n}changeFileName(e){this._fileName.value=e}static _validateFileName(e,t){let n;if(e!=null)n=e.target;else if(t!=null)n=t;else return;const i=/[\+\*\$\?\|\{\}\\\/<>#%!`&'"=:@]/gi;if(i.test(n.value)){let s=n.selectionStart;n.value=n.value.replace(i,""),s--,n.setSelectionRange(s,s)}}static _validateNumber(e){const t=e.target;t.value=Math.floor(Math.max(Number(t.min),Math.min(Number(t.max),Number(t.value))))+""}_synthesize(){if(this.outputStarted==!1||this.synth==null)return;const e=this.synth.samplesPerSecond*5,t=this.currentChunk*e,n=Math.min(e,this.sampleFrames-t),i=new Float32Array(n),s=new Float32Array(n);if(this.synth.renderingSong=!0,this.synth.synthesize(i,s,n),this.recordedSamplesL.set(i,t),this.recordedSamplesR.set(s,t),this._outputProgressBar.style.setProperty("width",Math.round((this.currentChunk+1)/this.totalChunks*100)+"%"),this._outputProgressLabel.innerText=Math.round((this.currentChunk+1)/this.totalChunks*100)+"%",this.currentChunk++,this.currentChunk>=this.totalChunks)if(this.synth.renderingSong=!1,this._outputProgressLabel.innerText="Encoding...",this.thenExportTo=="wav")this._exportToWavFinish();else if(this.thenExportTo=="mp3")this._exportToMp3Finish();else throw new Error("Unrecognized file export type chosen!");else setTimeout(()=>{this._synthesize()})}_exportTo(e){if(this.thenExportTo=e,this.currentChunk=0,this.synth=new ms(this._doc.song),e=="wav")this.synth.samplesPerSecond=48e3;else if(e=="mp3")this.synth.samplesPerSecond=44100;else throw new Error("Unrecognized file export type chosen!");if(this._outputProgressBar.style.setProperty("width","0%"),this._outputProgressLabel.innerText="0%",this.synth.loopRepeatCount=Number(this._loopDropDown.value)-1,!this._enableIntro.checked)for(let t=0;t<this._doc.song.loopStart;t++)this.synth.goToNextBar();this.synth.computeLatestModValues(),this.synth.warmUpSynthesizer(this._doc.song),this.sampleFrames=this.synth.getTotalSamples(this._enableIntro.checked,this._enableOutro.checked,this.synth.loopRepeatCount),this.totalChunks=Math.ceil(this.sampleFrames/(this.synth.samplesPerSecond*5)),this.recordedSamplesL=new Float32Array(this.sampleFrames),this.recordedSamplesR=new Float32Array(this.sampleFrames),setTimeout(()=>{this._synthesize()})}_exportToWavFinish(){var S;const e=this.recordedSamplesL.length,t=((S=this.synth)==null?void 0:S.samplesPerSecond)??0,n=2,i=2,s=8*i,h=n*e,d=44+h*i;let c=0;const _=new ArrayBuffer(d),m=new DataView(_);m.setUint32(c,1380533830,!1),c+=4,m.setUint32(c,36+h*i,!0),c+=4,m.setUint32(c,1463899717,!1),c+=4,m.setUint32(c,1718449184,!1),c+=4,m.setUint32(c,16,!0),c+=4,m.setUint16(c,1,!0),c+=2,m.setUint16(c,n,!0),c+=2,m.setUint32(c,t,!0),c+=4,m.setUint32(c,t*i*n,!0),c+=4,m.setUint16(c,i*n,!0),c+=2,m.setUint16(c,s,!0),c+=2,m.setUint32(c,1684108385,!1),c+=4,m.setUint32(c,h*i,!0),c+=4;{const E=(1<<s-1)-1;for(let A=0;A<e;A++){let C=Math.floor(Math.max(-1,Math.min(1,this.recordedSamplesL[A]))*E),k=Math.floor(Math.max(-1,Math.min(1,this.recordedSamplesR[A]))*E);m.setInt16(c,C,!0),c+=2,m.setInt16(c,k,!0),c+=2}}const g=new Blob([_],{type:"audio/wav"});xo(g,this._fileName.value.trim()+".wav"),this._close()}_exportToMp3Finish(){const e=()=>{var A;const n=window.lamejs,i=2,s=192,h=1152,d=new n.Mp3Encoder(i,((A=this.synth)==null?void 0:A.samplesPerSecond)??0,s),c=[],_=new Int16Array(this.recordedSamplesL.length),m=new Int16Array(this.recordedSamplesR.length),g=32767;for(let C=0;C<this.recordedSamplesL.length;C++)_[C]=Math.floor(Math.max(-1,Math.min(1,this.recordedSamplesL[C]))*g),m[C]=Math.floor(Math.max(-1,Math.min(1,this.recordedSamplesR[C]))*g);for(let C=0;C<_.length;C+=h){const k=_.subarray(C,C+h),T=m.subarray(C,C+h),b=d.encodeBuffer(k,T);b.length>0&&c.push(b)}const S=d.flush();S.length>0&&c.push(S);const E=new Blob(c,{type:"audio/mp3"});xo(E,this._fileName.value.trim()+".mp3"),this._close()};if("lamejs"in window)e();else{var t=document.createElement("script");t.src="https://cdn.jsdelivr.net/npm/lamejs@1.2.0/lame.min.js",t.onload=e,document.head.appendChild(t)}}_exportToMidi(){const e=this._doc.song,t=2,n=t*w.ticksPerPart*w.partsPerBeat,i=t*w.ticksPerPart,h=60*1e6,d=e.getBeatsPerMinute(),c=Math.round(h/d),_=n*e.beatsPerBar,m=24,g=90,S=[];if(this._enableIntro.checked)for(let b=0;b<e.loopStart;b++)S.push(b);for(let b=0;b<Number(this._loopDropDown.value);b++)for(let R=e.loopStart;R<e.loopStart+e.loopLength;R++)S.push(R);if(this._enableOutro.checked)for(let b=e.loopStart+e.loopLength;b<e.barCount;b++)S.push(b);const E=[{isMeta:!0,channel:-1,midiChannel:-1,isNoise:!1,isDrumset:!1}];let A=0,C=!1;for(let b=0;b<this._doc.song.pitchChannelCount+this._doc.song.noiseChannelCount;b++)if(!C&&this._doc.song.channels[b].instruments[0].type==je.drumset)E.push({isMeta:!1,channel:b,midiChannel:9,isNoise:!0,isDrumset:!0}),C=!0;else{if(A>=16)continue;E.push({isMeta:!1,channel:b,midiChannel:A++,isNoise:this._doc.song.getChannelIsNoise(b),isDrumset:!1}),A==9&&A++}const k=new Ap(1024);k.writeUint32(Oo.header),k.writeUint32(6),k.writeUint16(kh.simultaneousTracks),k.writeUint16(E.length),k.writeUint16(n);for(const b of E){k.writeUint32(Oo.track);const{isMeta:R,channel:V,midiChannel:f,isNoise:D,isDrumset:l}=b,W=k.getWriteIndex();k.writeUint32(0);let L=0,P=0;const y=function(B){if(B<L)throw new Error("Midi event time cannot go backwards.");k.writeMidiVariableLength(B-L),L=B},O=function(B,v){if(!(v>=0&&v<=127))throw new Error("Midi control event value out of range: "+v);k.writeUint8(jt.controlChange|f),k.writeMidi7Bits(B),k.writeMidi7Bits(v|0)};if(R){y(0),k.writeUint8(jt.meta),k.writeMidi7Bits(_i.text),k.writeMidiAscii("Composed with jummbus.bitbucket.io"),y(0),k.writeUint8(jt.meta),k.writeMidi7Bits(_i.tempo),k.writeMidiVariableLength(3),k.writeUint24(c),y(0),k.writeUint8(jt.meta),k.writeMidi7Bits(_i.timeSignature),k.writeMidiVariableLength(4),k.writeUint8(e.beatsPerBar),k.writeUint8(2),k.writeUint8(24),k.writeUint8(8);const B=w.scales[e.scale].flags[3]&&!w.scales[e.scale].flags[4],v=e.key;let H=v;for((v&1)==1&&(H+=6),B&&(H+=9);H>6;)H-=12;y(0),k.writeUint8(jt.meta),k.writeMidi7Bits(_i.keySignature),k.writeMidiVariableLength(2),k.writeInt8(H),k.writeUint8(B?1:0),this._enableIntro.checked&&(P+=_*e.loopStart),y(P),k.writeUint8(jt.meta),k.writeMidi7Bits(_i.marker),k.writeMidiAscii("Loop Start");for(let N=0;N<parseInt(this._loopDropDown.value);N++)P+=_*e.loopLength,y(P),k.writeUint8(jt.meta),k.writeMidi7Bits(_i.marker),k.writeMidiAscii(N<Number(this._loopDropDown.value)-1?"Loop Repeat":"Loop End");if(this._enableOutro.checked&&(P+=_*(e.barCount-e.loopStart-e.loopLength)),P!=_*S.length)throw new Error("Miscalculated number of bars.")}else{let B=function(F){const Z=e.channels[V].instruments[F],ee=Lt.valueToPreset(Z.preset);if(H!=F){if(H=F,y(P),k.writeUint8(jt.meta),k.writeMidi7Bits(_i.instrumentName),k.writeMidiAscii("Instrument "+(F+1)),!l){let _e=81;if(ee!=null&&ee.midiProgram!=null)_e=ee.midiProgram;else if(Z.type==je.drumset)_e=116;else if(Z.type==je.noise||Z.type==je.spectrum)D?_e=116:_e=75;else if(Z.type==je.chip)Is.midiChipInstruments.length>Z.chipWave&&(_e=Is.midiChipInstruments[Z.chipWave]);else if(Z.type==je.pwm||Z.type==je.fm||Z.type==je.harmonics)_e=81;else if(Z.type==je.pickedString)_e=25;else if(Z.type==je.customChipWave)_e=81;else throw new Error("Unrecognized instrument type.");y(P),k.writeUint8(jt.programChange|f),k.writeMidi7Bits(_e)}y(P);let ue=Lp(ms.instrumentVolumeToVolumeMult(Z.volume));O(Wn.volumeMSB,Math.min(127,Math.round(ue))),y(P);let Pe=(Z.pan/w.panCenter-1)*63+64;O(Wn.panMSB,Math.min(127,Math.round(Pe)))}},v=D?"noise channel "+V:"pitch channel "+V;y(0),k.writeUint8(jt.meta),k.writeMidi7Bits(_i.trackName),k.writeMidiAscii(v),y(0),O(Wn.registeredParameterNumberMSB,Ho.pitchBendRange),y(0),O(Wn.registeredParameterNumberLSB,Vo.pitchBendRange),y(0),O(Wn.setParameterMSB,m),y(0),O(Wn.setParameterLSB,0),y(0),O(Wn.registeredParameterNumberMSB,Ho.reset),y(0),O(Wn.registeredParameterNumberLSB,Vo.reset);let H=-1;e.getPattern(V,0)==null&&B(0);let N=kl,te=Cl,G=!1;const se=D?w.spectrumBasePitch:w.keys[e.key].basePitch,M=D?w.noiseInterval:1;for(const F of S){const Z=e.getPattern(V,F);if(Z!=null){const ee=Z.instruments[0],ue=e.channels[V].instruments[ee],Pe=Lt.valueToPreset(ue.preset);B(ee);let _e=ue.getChord().arpeggiates,ke=_e?1:w.maxChordSize;ue.getChord().customInterval&&(ue.type==je.chip||ue.type==je.harmonics?(ke=2,_e=!0):ue.type==je.fm?ke=w.operatorCount:console.error("Unrecognized instrument type for harmonizing arpeggio: "+ue.type));for(let Ne=0;Ne<Z.notes.length;Ne++){const Be=Z.notes[Ne],pe=P+Be.start*i;let Oe=pe,nt=Be.pins[0].size,Ve=Be.pins[0].interval;const ot=[-1,-1,-1,-1],Ge=[-1,-1,-1,-1],lt=Math.min(ke,Be.pitches.length),dt=l?Math.max(1,Math.round(g*Be.pins[0].size/w.noteSizeMax)):g;let St=Be.pickMainInterval(),Mt=St*M;if(!l){let Ct=m,kt=-m;for(let bt=1;bt<Be.pins.length;bt++){const Pt=Be.pins[bt].interval*M;Ct=Math.min(Ct,Pt+m),kt=Math.max(kt,Pt-m)}Mt=Math.min(Ct,Math.max(kt,Mt))}for(let Ct=1;Ct<Be.pins.length;Ct++){const kt=pe+Be.pins[Ct].time*i,bt=Be.pins[Ct].size,Pt=Be.pins[Ct].interval,Xe=kt-Oe;for(let vt=0;vt<Xe;vt++){const Et=Oe+vt,Sn=gc(nt,bt,vt/Xe),On=gc(Ve,Pt,vt/Xe)*M-Mt,Ht=Math.max(0,Math.min(16383,Math.round(8192*(1+On/m)))),j=Math.min(127,Math.round(Dp(ms.noteSizeToVolumeMult(Sn))));Ht!=N&&(y(Et),k.writeUint8(jt.pitchBend|f),k.writeMidi7Bits(Ht&127),k.writeMidi7Bits(Ht>>7&127),N=Ht),j!=te&&!l&&(y(Et),O(Wn.expressionMSB,j),te=j);const K=Et==pe;for(let z=0;z<lt;z++){let Y=Be.pitches[z];if(l){Y+=St;const J=[36,41,45,48,40,39,59,49,46,55,69,54];if(Y<0||Y>=J.length)throw new Error("Could not find corresponding drumset pitch. "+Y);Y=J[Y]}else{if(_e&&Be.pitches.length>z+1&&z==lt-1){const J=(Et-P)%n,X=w.ticksPerArpeggio*i/w.ticksPerPart,ie=Math.floor(J/X);Y=Be.pitches[z+tf(Be.pitches.length-z,ue.fastTwoNoteArp,ie)]}Y=se+Y*M+Mt,Pe!=null&&Pe.midiSubharmonicOctaves!=null?Y+=12*Pe.midiSubharmonicOctaves:D&&(Y+=12*+Lt.presetCategories.dictionary["Drum Presets"].presets.dictionary["taiko drum"].midiSubharmonicOctaves),D&&(Y*=2)}Y=Math.max(0,Math.min(127,Y)),Ge[z]=Y,!K&&ot[z]!=Ge[z]&&(y(Et),k.writeUint8(jt.noteOff|f),k.writeMidi7Bits(ot[z]),k.writeMidi7Bits(dt))}for(let z=0;z<lt;z++)(K||ot[z]!=Ge[z])&&(y(Et),k.writeUint8(jt.noteOn|f),k.writeMidi7Bits(Ge[z]),k.writeMidi7Bits(dt),ot[z]=Ge[z])}Oe=kt,nt=bt,Ve=Pt}const Tt=P+Be.end*i;for(let Ct=0;Ct<lt;Ct++)y(Tt),k.writeUint8(jt.noteOff|f),k.writeMidi7Bits(ot[Ct]),k.writeMidi7Bits(dt);G=!0}}else G&&(G=!1,te!=Cl&&(te=Cl,y(P),O(Wn.expressionMSB,te)),N!=kl&&(N=kl,y(P),k.writeUint8(jt.pitchBend|f),k.writeMidi7Bits(N&127),k.writeMidi7Bits(N>>7&127)));P+=_}}y(P),k.writeUint8(jt.meta),k.writeMidi7Bits(_i.endOfTrack),k.writeMidiVariableLength(0),k.rewriteUint32(W,k.getWriteIndex()-W-4)}const T=new Blob([k.toCompactArrayBuffer()],{type:"audio/midi"});xo(T,this._fileName.value.trim()+".mid"),this._close()}_exportToJson(){const e=this._doc.song.toJsonObject(this._enableIntro.checked,Number(this._loopDropDown.value),this._enableOutro.checked),t=JSON.stringify(e,null,"	"),n=new Blob([t],{type:"application/json"});xo(n,this._fileName.value.trim()+".json"),this._close()}_exportToHtml(){const e=`<!DOCTYPE html><meta charset="utf-8">

You should be redirected to the song at:<br /><br />

<a id="destination" href="${new URL("#"+this._doc.song.toBase64String(),location.href).href}"></a>

<style>
	:root {
		color: white;
		background: black;
		font-family:
		sans-serif;
	}
	a {
		color: #98f;
	}
	a[href]::before {
		content: attr(href);
	}
</style>

<script>
	location.assign(document.querySelector("a#destination").href);
<\/script>
`,t=new Blob([e],{type:"text/html"});xo(t,this._fileName.value.trim()+".html"),this._close()}};a(Is,"midiChipInstruments",[74,71,80,70,68,81,81,81,81]);let hh=Is;class La{static setLayout(e){this._styleElement.textContent=this._layoutMap[e]}}a(La,"_layoutMap",{small:"",long:`
			/* long layout */
			@media (min-width: 711px) {
				#beepboxEditorContainer {
					max-width: initial;
					height: 100vh;
				}
				.beepboxEditor {
					width: 100%;
					height: 100vh;
					grid-template-columns: minmax(0, 1fr) 390px; /* minmax(0, 1fr) min-content; Chrome 80 grid layout regression. https://bugs.chromium.org/p/chromium/issues/detail?id=1050307 */
					grid-template-rows: minmax(481px, 1fr) minmax(0, min-content);
					grid-template-areas: "pattern-area settings-area" "track-area track-area";
				}
				.beepboxEditor .pattern-area {
					width: 100%;
					height: 100%;
				}
				.beepboxEditor .track-area {
					width: 100%;
					display: flex;
					flex-direction: column;
				}
				.beepboxEditor .trackAndMuteContainer {
					width: 100%;
					min-height: 0;
					flex: 1;
					overflow: auto;
					max-height: 97.5vh;
				}
				.beepboxEditor .instrument-settings-area {
					overflow-y: auto;
					position: relative;
				}
				.beepboxEditor .instrument-settings-area > .editor-controls {
					position: absolute;
					width: 100%;
				}
				.beepboxEditor .song-settings-area {
					overflow-y: auto;
				}
				
				.beepboxEditor .settings-area {
					width: 390px;
					grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
					grid-template-rows: auto auto auto minmax(0, 1fr);
					grid-template-areas:
						"instrument-settings-area version-area"
						"instrument-settings-area play-pause-area"
						"instrument-settings-area menu-area"
						"instrument-settings-area song-settings-area";
				}
				
				.beepboxEditor .barScrollBar {
					display: none;
				}
				.beepboxEditor.selectRow {
					height: 2em;
				}
				.beepboxEditor .operatorRow {
					heiht: 2em;
				}
				.beepboxEditor .trackAndMuteContainer {
					max-height: 446px;
				}

				.beepboxEditor .trackContainer {
					overflow: visible;
				}
				.beepboxEditor .trackAndMuteContainer {
					scrollbar-width: auto;
					scrollbar-color: ${Q.uiWidgetBackground} ${Q.editorBackground};
				}
				.beepboxEditor .trackAndMuteContainer::-webkit-scrollbar {
					width: 20px;
					height: 20px;
				}
				.beepboxEditor .trackAndMuteContainer::-webkit-scrollbar-track {
					background: ${Q.editorBackground};
				}
				.beepboxEditor .trackAndMuteContainer::-webkit-scrollbar-thumb {
					background-color: ${Q.uiWidgetBackground};
					border: 3px solid ${Q.editorBackground};
				}
				.beepboxEditor .trackAndMuteContainer::-webkit-scrollbar-corner {
					background-color: ${Q.editorBackground};
				}
			}
		`,tall:`			/* tall layout */
			@media (min-width: 711px) {
				#beepboxEditorContainer {
					max-width: initial;
					height: 100vh;
				}
				.beepboxEditor {
					width: 100%;
					height: 100vh;
					grid-template-columns: minmax(0, 1fr) minmax(0, 1fr) 192px;
					grid-template-rows: 1fr;
					grid-template-areas: "track-area pattern-area settings-area";
				}
				.beepboxEditor .pattern-area {
					width: 100%;
					height: 100%;
				}
				.beepboxEditor .track-area {
					width: 100%;
					height: 100%;
					display: flex;
					flex-direction: column;
					justify-content: center;
				}
				.beepboxEditor .trackAndMuteContainer {
					width: 100%;
					min-height: 0;
					flex: 0;
					overflow: auto;
					flex-basis: initial;
					flex-grow: 0;
					max-height: 97.5vh;
				}
				.beepboxEditor .instrument-settings-area > .editor-controls {
					position: absolute;
					width: 100%;
				}
				
				.beepboxEditor .settings-area {
					width: 192px;
					position: relative;
					overflow-y: auto;
					grid-template-columns: minmax(0, 1fr);
					grid-template-rows: auto auto auto auto minmax(0, 1fr);
					grid-template-areas:
						"version-area"
						"play-pause-area"
						"menu-area"
						"song-settings-area"
						"instrument-settings-area";
				}
				.beepboxEditor .version-area {
					position: sticky;
					top: 0;
					z-index: 1;
					background: ${Q.editorBackground};
				}
				.beepboxEditor .play-pause-area {
					position: sticky;
					top: 22px;
					z-index: 1;
					background: ${Q.editorBackground};
				}
				.beepboxEditor .menu-area {
					position: sticky;
					top: 82px;
					z-index: 1;
					background: ${Q.editorBackground};
				}
				
				.beepboxEditor .barScrollBar {
					display: none;
				}
				.beepboxEditor .trackContainer {
					overflow: visible;
				}
				.beepboxEditor .trackAndMuteContainer {
					scrollbar-width: auto;
					scrollbar-color: ${Q.uiWidgetBackground} ${Q.editorBackground};
				}
				.beepboxEditor .trackAndMuteContainer::-webkit-scrollbar {
					width: 20px;
					height: 20px;
				}
				.beepboxEditor .trackAndMuteContainer::-webkit-scrollbar-track {
					background: ${Q.editorBackground};
				}
				.beepboxEditor .trackAndMuteContainer::-webkit-scrollbar-thumb {
					background-color: ${Q.uiWidgetBackground};
					border: 3px solid ${Q.editorBackground};
				}
				.beepboxEditor .trackAndMuteContainer::-webkit-scrollbar-corner {
					background-color: ${Q.editorBackground};
				}
			}
		`,wide:`			/* wide (JB) layout */
			@media (min-width: 1001px) {
				#beepboxEditorContainer {
					max-width: initial;
					height: 100vh;
				}
				.beepboxEditor {
					width: 100%;
					height: 100vh;
					grid-template-columns: 512px minmax(0, 1fr) 30em;
					grid-template-rows: minmax(481px, 1fr) min-content;
					grid-template-areas: "track-area pattern-area settings-area";
				}
				.beepboxEditor .pattern-area {
					width: 100%;
					height: 100%;
				}
				.beepboxEditor .track-area {
					width: 100%;
					height: 100%;
					max-height: 100%
				}
				.beepboxEditor .editor-widget-column {
					flex: 0;
				}
				.beepboxEditor .trackAndMuteContainer {
					width: 100%;
					flex: 0;
					flex-basis: initial;
					flex-grow: 0;
					overflow-y: auto;
					max-height: 97.5vh;
				}
				.beepboxEditor .instrument-settings-area {
					overflow-y: auto;
					position: relative;
				}
				.beepboxEditor .instrument-settings-area > .editor-controls {
					position: absolute;
					width: 100%;
				}
				
				.beepboxEditor .song-settings-area {
					overflow-y: auto;
				}
				
				.beepboxEditor .settings-area {
					width: 30em;
					grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
					grid-template-rows: auto auto auto minmax(0, 1fr);
					grid-template-areas:
						"instrument-settings-area version-area"
						"instrument-settings-area play-pause-area"
						"instrument-settings-area menu-area"
						"instrument-settings-area song-settings-area";
				}
				.beepboxEditor .version-area {
					position: sticky;
					top: 0;
					z-index: 1;
					background: ${Q.editorBackground};
				}
				.beepboxEditor .play-pause-area {
					position: sticky;
					top: 22px;
					z-index: 1;
					background: ${Q.editorBackground};
				}
				.beepboxEditor .menu-area {
					position: sticky;
					top: 82px;
					z-index: 1;
					background: ${Q.editorBackground};
				}
				
				.beepboxEditor .trackContainer {
					overflow: visible;
				}
			}
		`}),a(La,"_styleElement",document.head.appendChild(Ke.style({type:"text/css"})));class Hp{constructor(e){a(this,"_editorWidth",120);a(this,"_editorHeight",26);a(this,"_octaves",me.svg({"pointer-events":"none"}));a(this,"_fifths",me.svg({"pointer-events":"none"}));a(this,"_curve",me.path({fill:"none",stroke:"currentColor","stroke-width":2,"pointer-events":"none"}));a(this,"_lastControlPoints",[]);a(this,"_lastControlPointContainer",me.svg({"pointer-events":"none"}));a(this,"_svg",me.svg({style:"background-color: ${ColorConfig.editorBackground}; touch-action: none; cursor: crosshair;",width:"100%",height:"100%",viewBox:"0 0 "+this._editorWidth+" "+this._editorHeight,preserveAspectRatio:"none"},this._octaves,this._fifths,this._curve,this._lastControlPointContainer));a(this,"container",Ke.div({class:"harmonics",style:"height: 100%;"},this._svg));a(this,"_mouseX",0);a(this,"_mouseY",0);a(this,"_freqPrev",0);a(this,"_ampPrev",0);a(this,"_mouseDown",!1);a(this,"_change",null);a(this,"_renderedPath","");a(this,"_renderedFifths",!0);a(this,"_whenMousePressed",e=>{e.preventDefault(),this._mouseDown=!0;const t=this._svg.getBoundingClientRect();this._mouseX=((e.clientX||e.pageX)-t.left)*this._editorWidth/(t.right-t.left),this._mouseY=((e.clientY||e.pageY)-t.top)*this._editorHeight/(t.bottom-t.top),isNaN(this._mouseX)&&(this._mouseX=0),isNaN(this._mouseY)&&(this._mouseY=0),this._freqPrev=this._xToFreq(this._mouseX),this._ampPrev=this._yToAmp(this._mouseY),this._whenCursorMoved()});a(this,"_whenTouchPressed",e=>{e.preventDefault(),this._mouseDown=!0;const t=this._svg.getBoundingClientRect();this._mouseX=(e.touches[0].clientX-t.left)*this._editorWidth/(t.right-t.left),this._mouseY=(e.touches[0].clientY-t.top)*this._editorHeight/(t.bottom-t.top),isNaN(this._mouseX)&&(this._mouseX=0),isNaN(this._mouseY)&&(this._mouseY=0),this._freqPrev=this._xToFreq(this._mouseX),this._ampPrev=this._yToAmp(this._mouseY),this._whenCursorMoved()});a(this,"_whenMouseMoved",e=>{if(this.container.offsetParent==null)return;const t=this._svg.getBoundingClientRect();this._mouseX=((e.clientX||e.pageX)-t.left)*this._editorWidth/(t.right-t.left),this._mouseY=((e.clientY||e.pageY)-t.top)*this._editorHeight/(t.bottom-t.top),isNaN(this._mouseX)&&(this._mouseX=0),isNaN(this._mouseY)&&(this._mouseY=0),this._whenCursorMoved()});a(this,"_whenTouchMoved",e=>{if(this.container.offsetParent==null||!this._mouseDown)return;e.preventDefault();const t=this._svg.getBoundingClientRect();this._mouseX=(e.touches[0].clientX-t.left)*this._editorWidth/(t.right-t.left),this._mouseY=(e.touches[0].clientY-t.top)*this._editorHeight/(t.bottom-t.top),isNaN(this._mouseX)&&(this._mouseX=0),isNaN(this._mouseY)&&(this._mouseY=0),this._whenCursorMoved()});a(this,"_whenCursorReleased",e=>{this._mouseDown&&(this._doc.record(this._change),this._change=null),this._mouseDown=!1});this._doc=e;for(let t=1;t<=w.harmonicsControlPoints;t=t*2)this._octaves.appendChild(me.rect({fill:Q.tonic,x:(t-.5)*(this._editorWidth-8)/(w.harmonicsControlPoints-1)-1,y:0,width:2,height:this._editorHeight}));for(let t=3;t<=w.harmonicsControlPoints;t=t*2)this._fifths.appendChild(me.rect({fill:Q.fifthNote,x:(t-.5)*(this._editorWidth-8)/(w.harmonicsControlPoints-1)-1,y:0,width:2,height:this._editorHeight}));for(let t=0;t<4;t++){const n=me.rect({fill:"currentColor",x:this._editorWidth-t*2-1,y:0,width:1,height:this._editorHeight});this._lastControlPoints.push(n),this._lastControlPointContainer.appendChild(n)}this.container.addEventListener("mousedown",this._whenMousePressed),document.addEventListener("mousemove",this._whenMouseMoved),document.addEventListener("mouseup",this._whenCursorReleased),this.container.addEventListener("touchstart",this._whenTouchPressed),this.container.addEventListener("touchmove",this._whenTouchMoved),this.container.addEventListener("touchend",this._whenCursorReleased),this.container.addEventListener("touchcancel",this._whenCursorReleased)}_xToFreq(e){return(w.harmonicsControlPoints-1)*e/(this._editorWidth-8)-.5}_yToAmp(e){return w.harmonicsMax*(1-e/this._editorHeight)}_whenCursorMoved(){if(this._mouseDown){const e=this._xToFreq(this._mouseX),t=this._yToAmp(this._mouseY),n=this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()],i=n.harmonicsWave;if(e!=this._freqPrev){const s=(t-this._ampPrev)/(e-this._freqPrev),h=this._ampPrev-this._freqPrev*s,d=Math.ceil(Math.min(this._freqPrev,e)),c=Math.floor(Math.max(this._freqPrev,e));for(let _=d;_<=c;_++)_<0||_>=w.harmonicsControlPoints||(i.harmonics[_]=Math.max(0,Math.min(w.harmonicsMax,Math.round(_*s+h))))}i.harmonics[Math.max(0,Math.min(w.harmonicsControlPoints-1,Math.round(e)))]=Math.max(0,Math.min(w.harmonicsMax,Math.round(t))),this._freqPrev=e,this._ampPrev=t,this._change=new Cf(this._doc,n,i),this._doc.setProspectiveChange(this._change)}}render(){const t=this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()].harmonicsWave,n=d=>(1-d/w.harmonicsMax)*this._editorHeight;let i=Le(this._editorHeight),s="";for(let d=0;d<w.harmonicsControlPoints-1;d++){if(t.harmonics[d]==0)continue;let c=Le((d+.5)*(this._editorWidth-8)/(w.harmonicsControlPoints-1));s+="M "+c+" "+i+" ",s+="L "+c+" "+Le(n(t.harmonics[d]))+" "}const h=n(t.harmonics[w.harmonicsControlPoints-1]);for(let d=0;d<4;d++){const c=this._lastControlPoints[d];c.setAttribute("y",Le(h)),c.setAttribute("height",Le(this._editorHeight-h))}this._renderedPath!=s&&(this._renderedPath=s,this._curve.setAttribute("d",s)),this._renderedFifths!=this._doc.prefs.showFifth&&(this._renderedFifths=this._doc.prefs.showFifth,this._fifths.style.display=this._doc.prefs.showFifth?"":"none")}}const{span:vc}=Ke;class mu{constructor(e,t,n){a(this,"_change",null);a(this,"_value","");a(this,"_oldValue","");a(this,"_whenInput",()=>{this._doc.lastChangeWas(this._change)||(this._oldValue=this._value),this._change=this._getChange(this._oldValue,this.input.value),this._doc.setProspectiveChange(this._change)});a(this,"_whenChange",()=>{this._doc.record(this._change),this._change=null});this.input=e,this._doc=t,this._getChange=n,e.addEventListener("input",this._whenInput),e.addEventListener("change",this._whenChange)}updateValue(e){this._value=e,this.input.value=String(e)}}class tn{constructor(e,t,n,i){a(this,"_change",null);a(this,"_value",0);a(this,"_oldValue",0);a(this,"container");a(this,"_whenInput",()=>{this._doc.lastChangeWas(this._change)||(this._oldValue=this._value),this._getChange!=null&&(this._change=this._getChange(this._oldValue,parseInt(this.input.value)),this._doc.setProspectiveChange(this._change))});a(this,"_whenChange",()=>{this._getChange!=null&&(this._doc.record(this._change),this._change=null)});this.input=e,this._doc=t,this._getChange=n,this.container=vc(i?{class:"midTick",style:"position: sticky; width: 61.5%;"}:{style:"position: sticky;"},e),e.addEventListener("input",this._whenInput),e.addEventListener("change",this._whenChange)}updateValue(e){this._value=e,this.input.value=String(e)}}class Ph{constructor(e){a(this,"_readIndex",0);a(this,"_data");this._data=e}getReadIndex(){return this._readIndex}readUint32(){if(this._readIndex+4>this._data.byteLength)throw new Error("Reading past the end of the buffer.");const e=this._data.getUint32(this._readIndex,!1);return this._readIndex+=4,e}readUint24(){return this.readUint8()<<16|this.readUint8()<<8|this.readUint8()}readUint16(){if(this._readIndex+2>this._data.byteLength)throw new Error("Reading past the end of the buffer.");const e=this._data.getUint16(this._readIndex,!1);return this._readIndex+=2,e}readUint8(){if(this._readIndex+1>this._data.byteLength)throw new Error("Reading past the end of the buffer.");const e=this._data.getUint8(this._readIndex);return this._readIndex++,e}readInt8(){if(this._readIndex+1>this._data.byteLength)throw new Error("Reading past the end of the buffer.");const e=this._data.getInt8(this._readIndex);return this._readIndex++,e}peakUint8(){if(this._readIndex+1>this._data.byteLength)throw new Error("Reading past the end of the buffer.");return this._data.getUint8(this._readIndex)}readMidi7Bits(){const e=this.readUint8();return e>=128&&console.log("7 bit value contained 8th bit! value "+e+", index "+this._readIndex),e&127}readMidiVariableLength(){let e=0;for(let t=0;t<4;t++){const n=this.readUint8();if(e+=n&127,n&128)e=e<<7;else break}return e}skipBytes(e){this._readIndex+=e}hasMore(){return this._data.byteLength>this._readIndex}getReaderForNextBytes(e){if(this._readIndex+e>this._data.byteLength)throw new Error("Reading past the end of the buffer.");const t=new Ph(new DataView(this._data.buffer,this._data.byteOffset+this._readIndex,e));return this.skipBytes(e),t}}const{button:Vp,p:bc,div:Wp,h2:qp,input:Up}=Ke;class zp{constructor(e){a(this,"_fileInput",Up({type:"file",accept:".json,application/json,.mid,.midi,audio/midi,audio/x-midi"}));a(this,"_cancelButton",Vp({class:"cancelButton"}));a(this,"container",Wp({class:"prompt noSelection",style:"width: 300px;"},qp("Import"),bc({style:"text-align: left; margin: 0.5em 0;"},"BeepBox songs can be exported and re-imported as .json files. You could also use other means to make .json files for BeepBox as long as they follow the same structure."),bc({style:"text-align: left; margin: 0.5em 0;"},"BeepBox can also (crudely) import .mid files. There are many tools available for creating .mid files. Shorter and simpler songs are more likely to work well."),this._fileInput,this._cancelButton));a(this,"_close",()=>{this._doc.undo()});a(this,"cleanUp",()=>{this._fileInput.removeEventListener("change",this._whenFileSelected),this._cancelButton.removeEventListener("click",this._close)});a(this,"_whenFileSelected",()=>{const e=this._fileInput.files[0];if(!e)return;const t=e.name.slice((e.name.lastIndexOf(".")-1>>>0)+2);if(t=="json"){const n=new FileReader;n.addEventListener("load",i=>{this._doc.prompt=null,this._doc.goBackToStart(),this._doc.record(new Ra(this._doc,n.result),!0,!0)}),n.readAsText(e)}else if(t=="midi"||t=="mid"){const n=new FileReader;n.addEventListener("load",i=>{this._doc.prompt=null,this._doc.goBackToStart(),this._parseMidiFile(n.result)}),n.readAsArrayBuffer(e)}else console.error("Unrecognized file extension."),this._close()});this._doc=e,this._fileInput.select(),setTimeout(()=>this._fileInput.focus()),this._fileInput.addEventListener("change",this._whenFileSelected),this._cancelButton.addEventListener("click",this._close)}_parseMidiFile(e){const t=new Ph(new DataView(e));let n=null;const i=[];for(;t.hasMore();){const F=t.readUint32(),Z=t.readUint32();if(F==Oo.header)n==null?n=t.getReaderForNextBytes(Z):console.error("This MIDI file has more than one header chunk.");else if(F==Oo.track){const ee=t.getReaderForNextBytes(Z);ee.hasMore()&&i.push({reader:ee,nextEventMidiTick:ee.readMidiVariableLength(),ended:!1,runningStatus:-1})}else t.skipBytes(Z)}if(n==null){console.error("No header chunk found in this MIDI file."),this._close();return}const s=n.readUint16();n.readUint16();const h=n.readUint16();let d=0;const c=[],_=s==kh.independentTracks;if(_)c.push(d);else for(let F=0;F<i.length;F++)c.push(F);const m=[255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255],g=[255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255],S=[2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2],E=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],A=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],C=[100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100],k=[64,64,64,64,64,64,64,64,64,64,64,64,64,64,64,64],T=[[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]],b=[[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]],R=[[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]];let V=5e5,f=8,D=0,l=!1,W=0;for(;;){let F=Number.MAX_VALUE,Z=!1;for(const ee of c){const ue=i[ee];for(;!ue.ended&&ue.nextEventMidiTick==W;){const _e=ue.reader.peakUint8()&128?ue.reader.readUint8():ue.runningStatus,ke=_e&240,Ne=_e&15;ke!=jt.metaAndSysex&&(ue.runningStatus=_e);let Be=!1;switch(ke){case jt.noteOff:{const pe=ue.reader.readMidi7Bits();ue.reader.readMidi7Bits(),T[Ne].push({midiTick:W,pitch:pe,velocity:0,program:-1,instrumentVolume:-1,instrumentPan:-1,on:!1})}break;case jt.noteOn:{const pe=ue.reader.readMidi7Bits(),Oe=ue.reader.readMidi7Bits();if(Oe==0)T[Ne].push({midiTick:W,pitch:pe,velocity:0,program:-1,instrumentVolume:-1,instrumentPan:-1,on:!1});else{const nt=Math.max(0,Math.min(w.volumeRange-1,Math.round(ms.volumeMultToInstrumentVolume(Rp(C[Ne]))))),Ve=Math.max(0,Math.min(w.panMax,Math.round(((k[Ne]-64)/63+1)*w.panCenter)));T[Ne].push({midiTick:W,pitch:pe,velocity:Math.max(0,Math.min(1,(Oe+14)/90)),program:A[Ne],instrumentVolume:nt,instrumentPan:Ve,on:!0})}}break;case jt.keyPressure:ue.reader.readMidi7Bits(),ue.reader.readMidi7Bits();break;case jt.controlChange:{const pe=ue.reader.readMidi7Bits(),Oe=ue.reader.readMidi7Bits();switch(pe){case Wn.setParameterMSB:m[Ne]==Ho.pitchBendRange&&g[Ne]==Vo.pitchBendRange&&(S[Ne]=Oe);break;case Wn.volumeMSB:C[Ne]=Oe;break;case Wn.panMSB:k[Ne]=Oe;break;case Wn.expressionMSB:R[Ne].push({midiTick:W,size:ms.volumeMultToNoteSize(Np(Oe))});break;case Wn.setParameterLSB:m[Ne]==Ho.pitchBendRange&&g[Ne]==Vo.pitchBendRange&&(E[Ne]=Oe);break;case Wn.registeredParameterNumberLSB:g[Ne]=Oe;break;case Wn.registeredParameterNumberMSB:m[Ne]=Oe;break}}break;case jt.programChange:{const pe=ue.reader.readMidi7Bits();A[Ne]=pe}break;case jt.channelPressure:ue.reader.readMidi7Bits();break;case jt.pitchBend:{const pe=ue.reader.readMidi7Bits(),nt=(ue.reader.readMidi7Bits()<<7|pe)/8192-1,Ve=S[Ne]+E[Ne]*.01,ot=nt*Ve;b[Ne].push({midiTick:W,interval:ot})}break;case jt.metaAndSysex:if(_e==jt.meta){const pe=ue.reader.readMidi7Bits(),Oe=ue.reader.readMidiVariableLength();if(pe==_i.endOfTrack)Be=!0,ue.reader.skipBytes(Oe);else if(pe==_i.tempo)V=ue.reader.readUint24(),ue.reader.skipBytes(Oe-3);else if(pe==_i.timeSignature){const nt=ue.reader.readUint8();let Ve=ue.reader.readUint8();for(ue.reader.readUint8(),ue.reader.readUint8(),ue.reader.skipBytes(Oe-4),f=nt*4;!(f&1)&&(Ve>0||f>w.beatsPerBarMax)&&f>=w.beatsPerBarMin*2;)f=f>>1,Ve=Ve-1;f=Math.max(w.beatsPerBarMin,Math.min(w.beatsPerBarMax,f))}else pe==_i.keySignature?(D=ue.reader.readInt8(),l=ue.reader.readUint8()==1,ue.reader.skipBytes(Oe-2)):ue.reader.skipBytes(Oe)}else if(_e==240||_e==247){const pe=ue.reader.readMidiVariableLength();ue.reader.skipBytes(pe)}else{console.error("Unrecognized event status: "+_e),this._close();return}break;default:{console.error("Unrecognized event type: "+ke),this._close();return}}!Be&&ue.reader.hasMore()?ue.nextEventMidiTick=W+ue.reader.readMidiVariableLength():(ue.ended=!0,_&&(d++,d<i.length&&(c[0]=d,i[d].nextEventMidiTick+=W,F=Math.min(F,i[d].nextEventMidiTick),Z=!0)))}ue.ended||(Z=!0,F=Math.min(F,ue.nextEventMidiTick))}if(Z)W=F;else break}const L=60*1e3*1e3,P=Math.max(w.tempoMin,Math.min(w.tempoMax,Math.round(L/V))),y=h/w.partsPerBeat,O=w.partsPerBeat*f,B=Math.ceil(W/y/O);function v(F){return Math.round(F/y)}let H=D;for(l&&(H+=3),(H&1)==1&&(H+=6);H<0;)H+=12;H=H%12;const N=[],te=[],G=[];for(let F=0;F<16;F++){if(T[F].length==0)continue;const Z=new ao,ee=Lt.midiProgramToPresetValue(T[F][0].program),ue=ee==null?null:Lt.valueToPreset(ee),Pe=F==9,_e=Pe||ue!=null&&ue.isNoise==!0,ke=ue!=null&&ue.isMod==!0,Ne=_e?w.spectrumBasePitch:w.keys[H].basePitch,Be=_e?w.noiseInterval:1,pe=_e?.5:1,Oe=_e?w.drumCount-1:w.maxPitch;_e?Pe?te.unshift(Z):te.push(Z):ke?G.push(Z):N.push(Z);let nt=1,Ve=0,ot=0,Ge=w.panCenter;if(Pe){const lt=[];let dt=-1,St=null,Mt=0,Tt=!1;const Ct=Lt.nameToPresetValue("standard drumset"),kt=Lt.valueToPreset(Ct),bt=new Ma(!1,!1);bt.fromJsonObject(kt.settings,!1,!1,!1,!1,1),bt.preset=Ct,Z.instruments.push(bt);for(let Pt=0;Pt<=T[F].length;Pt++){const vt=Pt==T[F].length?null:T[F][Pt],Et=vt==null?Number.MAX_SAFE_INTEGER:v(vt.midiTick);if(lt.length>0&&Et>Mt&&(vt==null||vt.on)){const Sn=Math.floor(Mt/O),Hi=Sn*O;if(dt!=Sn||St==null){for(dt++;dt<Sn;)Z.bars[dt]=0,dt++;St=new Vr,Z.patterns.push(St),Z.bars[dt]=Z.patterns.length,St.instruments[0]=0,St.instruments.length=1}(!Tt||bt.volume>ot)&&(bt.volume=ot,bt.pan=Ge,bt.panDelay=0,Tt=!0);const On=[];let Ht=Oe,j=0,K=1;for(const ie of lt){const oe=lh[ie];On.indexOf(oe.frequency)==-1&&On.push(oe.frequency),K=Math.max(K,Math.round(oe.volume*nt)),Ht=Math.min(Ht,oe.duration),j=Math.max(j,oe.duration)}const z=Math.min(j,Math.max(Ht,2)),Y=Mt-Hi,J=Math.min(O,Math.min(Et-Hi,Y+z*6)),X=new fr(-1,Y,J,K,!0);X.pitches.length=0;for(let ie=0;ie<Math.min(w.maxChordSize,On.length);ie++){const oe=On[ie+Math.max(0,On.length-w.maxChordSize)];X.pitches.indexOf(oe)==-1&&X.pitches.push(oe)}St.notes.push(X),lt.length=0}vt!=null&&vt.on&&lh[vt.pitch]!=null&&(lt.push(vt.pitch),Mt=Et,nt=vt.velocity,ot=vt.instrumentVolume,Ge=vt.instrumentPan)}}else{let lt=function(Ht){for(;Tt<b[F].length&&b[F][Tt].midiTick<=Ht;)St=b[F][Tt].interval,Tt++},dt=function(Ht){for(;Ct<R[F].length&&R[F][Ct].midiTick<=Ht;)Mt=R[F][Ct].size,Ct++},St=0,Mt=w.noteSizeMax,Tt=0,Ct=0;const kt=[],bt=[];let Pt=-1,Xe=null,vt=0,Et=0,Sn=0,Hi=0;for(let Ht of T[F]){const j=Ht.midiTick,K=v(j);if(bt.length>0&&K>Et){const z=Math.floor(Et/O),Y=Math.ceil(K/O);let J=!1;for(let X=z;X<Y;X++){const ie=X*O,oe=X*f*h,ae=(X+1)*f*h,fe=Math.max(0,Et-ie),ce=Math.min(O,K-ie),we=Math.max(oe,vt),He=Math.min(ae,j);if(fe<ce){const $e=Lt.midiProgramToPresetValue(Ve),Ee=$e==null?null:Lt.valueToPreset($e);if(Pt!=X||Xe==null){for(Pt++;Pt<X;)Z.bars[Pt]=0,Pt++;if(Xe=new Vr,Z.patterns.push(Xe),Z.bars[Pt]=Z.patterns.length,kt[Ve]==null){const mt=new Ma(_e,ke);kt[Ve]=mt,$e!=null&&Ee!=null&&Ee.isNoise==!0==_e?(mt.fromJsonObject(Ee.settings,_e,ke,!1,!1,1),mt.preset=$e):(mt.setTypeAndReset(ke?je.mod:_e?je.noise:je.chip,_e,ke),mt.chord=0),mt.volume=ot,mt.pan=Ge,mt.panDelay=0,Z.instruments.push(mt)}Xe.instruments[0]=Z.instruments.indexOf(kt[Ve]),Xe.instruments.length=1}kt[Ve]!=null&&(kt[Ve].volume=Math.min(kt[Ve].volume,ot),kt[Ve].pan=Math.min(kt[Ve].pan,Ge));const Ye=new fr(-1,fe,ce,w.noteSizeMax,!1);Ye.pins.length=0,Ye.continuesLastPattern=J&&fe==0,J=!0,lt(we),dt(we);const ve=bt[0]*pe-Ne,ze=Math.round((ve+St)/Be),pt=Math.round(St-Ne);let Ae=Nt(0,0,Math.round(nt*Mt));Ye.pins.push(Ae);const qe=[{part:0,pitch:ze,size:Ae.size,keyPitch:!1,keySize:!1}];let Re=0,tt=(ve+St)/Be,Vt=nt*Mt;for(let mt=fe+1;mt<=ce;mt++){const Cn=Math.max(we,Math.min(He-1,Math.round(y*(mt+ie)))),Kt=mt-fe,Wt=mt==ce;lt(Cn),dt(Cn);const en=(St+ve)/Be,gn=nt*Mt,En=Math.round(en),qn=Math.abs(en-En)<.01,Hn=Math.abs(tt-Math.round(tt))<.01?Math.abs(en-tt)>=1:Math.floor(en)!=Math.floor(tt),vn=qn||Hn,ei=Math.round(gn),ai=Math.abs(gn-ei)<.01,Ys=Math.abs(Vt-Math.round(Vt))?Math.abs(gn-Vt)>=1:Math.floor(gn)!=Math.floor(Vt),js=ai||Ys;if(tt=en,Vt=gn,vn||js||Wt){const Vi={part:Kt,pitch:En,size:ei,keyPitch:vn||Wt,keySize:js||Wt},li=qe[Re];let Gt=!1,Wi=Number.MAX_VALUE;if(Vi.keyPitch){const hi=(Vi.pitch-li.pitch)/(Vi.part-li.part);let os=Math.abs(hi),ji=!1,as=Number.MAX_VALUE;for(let An=Re+1;An<qe.length;An++){const Ki=qe[An];if(Ki.keyPitch){const It=li.pitch+hi*(Ki.part-li.part),jn=Math.abs(It-Ki.pitch);os<jn&&(os=jn,ji=!0,as=An)}}ji&&(Gt=!0,Wi=Math.min(Wi,as))}if(Vi.keySize){const hi=(Vi.size-li.size)/(Vi.part-li.part);let os=Math.abs(hi),ji=!1,as=Number.MAX_VALUE;for(let An=Re+1;An<qe.length;An++){const Ki=qe[An];if(Ki.keySize){const It=li.size+hi*(Ki.part-li.part),jn=Math.abs(It-Ki.size);os<jn&&(os=jn,ji=!0,as=An)}}ji&&(Gt=!0,Wi=Math.min(Wi,as))}if(Gt){const hi=qe[Wi];Ye.pins.push(Nt(hi.pitch-ze,hi.part,hi.size)),Re=Wi}qe.push(Vi)}}const We=qe[qe.length-1];Ye.pins.push(Nt(We.pitch-ze,We.part,We.size));let ct=Oe,_t=0;for(const mt of Ye.pins)ct=Math.min(ct,Oe-mt.interval),_t=Math.min(_t,-mt.interval);Ye.pitches.length=0;for(let mt=0;mt<Math.min(w.maxChordSize,bt.length);mt++){let Cn=bt[mt+Math.max(0,bt.length-w.maxChordSize)]*pe;Ee!=null&&Ee.midiSubharmonicOctaves!=null&&(Cn-=12*Ee.midiSubharmonicOctaves);const Kt=Math.max(_t,Math.min(ct,Math.round((Cn+pt)/Be)));if(Ye.pitches.indexOf(Kt)==-1){Ye.pitches.push(Kt);const Wt=Ye.end-Ye.start;Sn+=Kt*Wt,Hi+=Wt}}Xe.notes.push(Ye)}}}bt.indexOf(Ht.pitch)!=-1&&bt.splice(bt.indexOf(Ht.pitch),1),Ht.on&&(bt.push(Ht.pitch),nt=Ht.velocity,Ve=Ht.program,ot=Ht.instrumentVolume,Ge=Ht.instrumentPan),vt=j,Et=K}const On=Sn/Hi;Z.octave=_e||ke?0:Math.max(0,Math.min(w.pitchOctaves-1,Math.floor(On/12)))}for(;Z.bars.length<B;)Z.bars.push(0)}function se(F,Z){for(;F.length>Z;){let ee=F.length-2,ue=F.length-1,Pe=Number.MAX_VALUE,_e=Number.MAX_VALUE;for(let Oe=0;Oe<F.length-1;Oe++)for(let nt=Oe+1;nt<F.length;nt++){const Ve=F[Oe],ot=F[nt];let Ge=0,lt=0;for(let dt=0;dt<Ve.bars.length&&dt<ot.bars.length;dt++)Ve.bars[dt]!=0&&ot.bars[dt]!=0&&Ge++,Ve.bars[dt]==0&&ot.bars[dt]==0&&lt++;Ge<=Pe&&(Ge<Pe||lt<_e)&&(ee=Oe,ue=nt,Pe=Ge,_e=lt)}const ke=F[ee],Ne=F[ue],Be=ke.instruments.length,pe=ke.patterns.length;for(const Oe of Ne.instruments)ke.instruments.push(Oe);for(const Oe of Ne.patterns)Oe.instruments[0]+=Be,ke.patterns.push(Oe);for(let Oe=0;Oe<ke.bars.length&&Oe<Ne.bars.length;Oe++)ke.bars[Oe]==0&&Ne.bars[Oe]!=0&&(ke.bars[Oe]=Ne.bars[Oe]+pe);F.splice(ue,1)}}se(N,w.pitchChannelCountMax),se(te,w.noiseChannelCountMax),se(G,w.modChannelCountMax);class M extends Zt{constructor(Z){super();const ee=Z.song;ee.tempo=P,ee.beatsPerBar=f,ee.key=H,ee.scale=11,ee.rhythm=1,ee.layeredInstruments=!1,ee.patternInstruments=N.some(ue=>ue.instruments.length>1)||te.some(ue=>ue.instruments.length>1),lo(N),lo(te),lo(G),this.append(new fu(Z,N,te,G)),ee.loopStart=0,ee.loopLength=ee.barCount,this._didSomething(),Z.notifier.changed()}}this._doc.goBackToStart();for(const F of this._doc.song.channels)F.muted=!1;this._doc.prompt=null,this._doc.record(new M(this._doc),!0,!0)}}const{button:yc,label:ia,div:Yr,form:Xp,h2:$p,input:So}=Ke;class Yp{constructor(e){a(this,"_fileInput",So({type:"file",accept:".json,application/json,.mid,.midi,audio/midi,audio/x-midi"}));a(this,"_okayButton",yc({class:"okayButton",style:"width:45%;"},"Okay"));a(this,"_cancelButton",yc({class:"cancelButton"}));a(this,"_form",Xp({style:"display: flex; gap: 10px;"},ia({class:"layout-option"},So({type:"radio",name:"layout",value:"small"}),me(`					<svg viewBox="-4 -1 28 22">
						<rect x="0" y="0" width="20" height="20" fill="none" stroke="currentColor" stroke-width="1"/>
						<rect x="2" y="2" width="11" height="10" fill="currentColor"/>
						<rect x="14" y="2" width="4" height="16" fill="currentColor"/>
						<rect x="2" y="13" width="11" height="5" fill="currentColor"/>
					</svg>
				`),Yr("Small")),ia({class:"layout-option"},So({type:"radio",name:"layout",value:"long"}),me(`					<svg viewBox="-1 -1 28 22">
						<rect x="0" y="0" width="26" height="20" fill="none" stroke="currentColor" stroke-width="1"/>
						<rect x="2" y="2" width="12" height="10" fill="currentColor"/>
						<rect x="15" y="2" width="4" height="10" fill="currentColor"/>
						<rect x="20" y="2" width="4" height="10" fill="currentColor"/>
						<rect x="2" y="13" width="22" height="5" fill="currentColor"/>
					</svg>
				`),Yr("Long")),ia({class:"layout-option"},So({type:"radio",name:"layout",value:"tall"}),me(`					<svg viewBox="-1 -1 28 22">
						<rect x="0" y="0" width="26" height="20" fill="none" stroke="currentColor" stroke-width="1"/>
						<rect x="11" y="2" width="8" height="16" fill="currentColor"/>
						<rect x="20" y="2" width="4" height="16" fill="currentColor"/>
						<rect x="2" y="2" width="8" height="16" fill="currentColor"/>
					</svg>
				`),Yr("Tall")),ia({class:"layout-option"},So({type:"radio",name:"layout",value:"wide"}),me(`					<svg viewBox="-1 -1 28 22">
						<rect x="0" y="0" width="26" height="20" fill="none" stroke="currentColor" stroke-width="1"/>
						<rect x="2" y="2" width="4" height="16" fill="currentColor"/>
						<rect x="18" y="2" width="2.5" height="16" fill="currentColor"/>
						<rect x="21.5" y="2" width="2.5" height="16" fill="currentColor"/>
						<rect x="7" y="2" width="10" height="16" fill="currentColor"/>
					</svg>
				`),Yr("Wide (JB)"))));a(this,"container",Yr({class:"prompt noSelection",style:"width: 300px;"},$p("Layout"),this._form,Yr({style:"display: flex; flex-direction: row-reverse; justify-content: space-between;"},this._okayButton),this._cancelButton));a(this,"_close",()=>{this._doc.undo()});a(this,"cleanUp",()=>{this._okayButton.removeEventListener("click",this._confirm),this._cancelButton.removeEventListener("click",this._close),this.container.removeEventListener("keydown",this._whenKeyPressed)});a(this,"_whenKeyPressed",e=>{e.target.tagName!="BUTTON"&&e.keyCode==13&&this._confirm()});a(this,"_confirm",()=>{this._doc.prefs.layout=this._form.elements.layout.value,this._doc.prefs.save(),La.setLayout(this._doc.prefs.layout),this._close()});this._doc=e,this._fileInput.select(),setTimeout(()=>this._fileInput.focus()),this._okayButton.addEventListener("click",this._confirm),this._cancelButton.addEventListener("click",this._close),this.container.addEventListener("keydown",this._whenKeyPressed),this._form.elements.layout.value=this._doc.prefs.layout}}class jp{constructor(e){a(this,"container",Ke.div({class:"envelopeEditor"}));a(this,"_rows",[]);a(this,"_targetSelects",[]);a(this,"_envelopeSelects",[]);a(this,"_deleteButtons",[]);a(this,"_renderedEnvelopeCount",0);a(this,"_renderedEqFilterCount",-1);a(this,"_renderedNoteFilterCount",-1);a(this,"_renderedInstrumentType",je.chip);a(this,"_renderedEffects",0);a(this,"_onChange",e=>{const t=this._targetSelects.indexOf(e.target),n=this._envelopeSelects.indexOf(e.target);if(t!=-1){const i=parseInt(this._targetSelects[t].value),s=i%w.instrumentAutomationTargets.length,h=i/w.instrumentAutomationTargets.length>>>0;this._doc.record(new yp(this._doc,t,s,h))}else n!=-1&&this._doc.record(new wp(this._doc,n,this._envelopeSelects[n].selectedIndex))});a(this,"_onClick",e=>{const t=this._deleteButtons.indexOf(e.target);t!=-1&&this._doc.record(new bp(this._doc,t))});this._doc=e,this.container.addEventListener("change",this._onChange),this.container.addEventListener("click",this._onClick)}_makeOption(e,t){let n=w.instrumentAutomationTargets[e].displayName;return w.instrumentAutomationTargets[e].maxCount>1&&(n.indexOf("#")!=-1?n=n.replace("#",String(t+1)):n+=" "+(t+1)),Ke.option({value:e+t*w.instrumentAutomationTargets.length},n)}_updateTargetOptionVisibility(e,t){for(let n=0;n<e.childElementCount;n++){const i=e.children[n],s=parseInt(i.value),h=s%w.instrumentAutomationTargets.length,d=s/w.instrumentAutomationTargets.length>>>0;i.hidden=!t.supportsEnvelopeTarget(h,d)}}render(){const e=this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];for(let n=this._rows.length;n<e.envelopeCount;n++){const i=Ke.select();for(let c=0;c<w.instrumentAutomationTargets.length;c++){const _=w.instrumentAutomationTargets[c].interleave;for(let m=0;m<w.instrumentAutomationTargets[c].maxCount;m++)i.appendChild(this._makeOption(c,m)),_&&i.appendChild(this._makeOption(c+1,m));_&&c++}const s=Ke.select();for(let c=0;c<w.envelopes.length;c++)s.appendChild(Ke.option({value:c},w.envelopes[c].name));const h=Ke.button({type:"button",class:"delete-envelope"}),d=Ke.div({class:"envelope-row"},Ke.div({class:"selectContainer",style:"width: 0; flex: 1;"},i),Ke.div({class:"selectContainer",style:"width: 0; flex: 0.7;"},s),h);this.container.appendChild(d),this._rows[n]=d,this._targetSelects[n]=i,this._envelopeSelects[n]=s,this._deleteButtons[n]=h}for(let n=this._renderedEnvelopeCount;n<e.envelopeCount;n++)this._rows[n].style.display="",this._updateTargetOptionVisibility(this._targetSelects[n],e);for(let n=e.envelopeCount;n<this._renderedEnvelopeCount;n++)this._rows[n].style.display="none";let t=e.noteFilter.controlPointCount;if(e.noteFilterType&&(t=1),this._renderedEqFilterCount!=e.eqFilter.controlPointCount||this._renderedNoteFilterCount!=t||this._renderedInstrumentType!=e.type||this._renderedEffects!=e.effects)for(let n=0;n<this._renderedEnvelopeCount;n++)this._updateTargetOptionVisibility(this._targetSelects[n],e);for(let n=0;n<e.envelopeCount;n++)this._targetSelects[n].value=String(e.envelopes[n].target+e.envelopes[n].index*w.instrumentAutomationTargets.length),this._envelopeSelects[n].selectedIndex=e.envelopes[n].envelope;this._renderedEnvelopeCount=e.envelopeCount,this._renderedEqFilterCount=e.eqFilter.controlPointCount,this._renderedNoteFilterCount=t,this._renderedInstrumentType=e.type,this._renderedEffects=e.effects}}class Kp{constructor(e){a(this,"_editorWidth",120);a(this,"_editorHeight",26);a(this,"_fadeCurve",me.path({fill:Q.uiWidgetBackground,"pointer-events":"none"}));a(this,"_dottedLinePath",me.path({fill:"none",stroke:"currentColor","stroke-width":1,"stroke-dasharray":"3, 2","pointer-events":"none"}));a(this,"_controlCurve",me.path({fill:"none",stroke:"currentColor","stroke-width":2,"pointer-events":"none"}));a(this,"_svg",me.svg({style:`background-color: ${Q.editorBackground}; touch-action: none; cursor: crosshair;`,width:"100%",height:"100%",viewBox:"0 0 "+this._editorWidth+" "+this._editorHeight,preserveAspectRatio:"none"},this._fadeCurve,this._dottedLinePath,this._controlCurve));a(this,"container",Ke.div({class:"fadeInOut",style:"height: 100%;"},this._svg));a(this,"_mouseX",0);a(this,"_mouseXStart",0);a(this,"_mouseDown",!1);a(this,"_mouseDragging",!1);a(this,"_draggingFadeIn",!1);a(this,"_dragChange",null);a(this,"_renderedFadeIn",-1);a(this,"_renderedFadeOut",-1);a(this,"_whenMousePressed",e=>{e.preventDefault();const t=this._svg.getBoundingClientRect();this._mouseX=(e.clientX||e.pageX)-t.left,this._whenCursorPressed()});a(this,"_whenTouchPressed",e=>{e.preventDefault();const t=this._svg.getBoundingClientRect();this._mouseX=e.touches[0].clientX-t.left,this._whenCursorPressed()});a(this,"_whenMouseMoved",e=>{if(this.container.offsetParent==null)return;const t=this._svg.getBoundingClientRect();this._mouseX=(e.clientX||e.pageX)-t.left,isNaN(this._mouseX)&&(this._mouseX=0),this._whenCursorMoved()});a(this,"_whenTouchMoved",e=>{if(this.container.offsetParent==null||!this._mouseDown)return;e.preventDefault();const t=this._svg.getBoundingClientRect();this._mouseX=e.touches[0].clientX-t.left,isNaN(this._mouseX)&&(this._mouseX=0),this._whenCursorMoved()});a(this,"_whenCursorReleased",e=>{if(this.container.offsetParent!=null){if(this._mouseDown&&this._doc.lastChangeWas(this._dragChange)&&this._dragChange!=null)if(this._mouseDragging)this._doc.record(this._dragChange);else{const t=this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];this._draggingFadeIn?this._doc.record(new ea(this._doc,this._xToFadeIn(this._mouseX),t.fadeOut)):this._doc.record(new ea(this._doc,t.fadeIn,this._xToFadeOut(this._mouseX)))}this._dragChange=null,this._mouseDragging=!1,this._mouseDown=!1}});this._doc=e;const t=this._fadeOutToX(w.fadeOutNeutral);this._dottedLinePath.setAttribute("d",`M ${t} 0 L ${t} ${this._editorHeight}`),this.container.addEventListener("mousedown",this._whenMousePressed),document.addEventListener("mousemove",this._whenMouseMoved),document.addEventListener("mouseup",this._whenCursorReleased),this.container.addEventListener("touchstart",this._whenTouchPressed),this.container.addEventListener("touchmove",this._whenTouchMoved),this.container.addEventListener("touchend",this._whenCursorReleased),this.container.addEventListener("touchcancel",this._whenCursorReleased)}_fadeInToX(e){return 1+(this._editorWidth-2)*.4*e/(w.fadeInRange-1)}_xToFadeIn(e){return Gh(0,w.fadeInRange,Math.round((e-1)*(w.fadeInRange-1)/(.4*this._editorWidth-2)))}_fadeOutToX(e){return 1+(this._editorWidth-2)*(.5+.5*e/(w.fadeOutTicks.length-1))}_xToFadeOut(e){return Gh(0,w.fadeOutTicks.length,Math.round((w.fadeOutTicks.length-1)*((e-1)/(this._editorWidth-2)-.5)/.5))}_whenCursorPressed(){isNaN(this._mouseX)&&(this._mouseX=0),this._mouseXStart=this._mouseX,this._mouseDown=!0,this._mouseDragging=!1;const e=this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()],t=this._fadeInToX(e.fadeIn),n=this._fadeOutToX(e.fadeOut);this._draggingFadeIn=this._mouseXStart<(t+n)/2,this._dragChange=new Zn,this._doc.setProspectiveChange(this._dragChange)}_whenCursorMoved(){if(this._dragChange!=null&&this._doc.lastChangeWas(this._dragChange)?this._dragChange.undo():this._mouseDown=!1,this._dragChange=null,this._mouseDown){const e=new Zn;if(this._dragChange=e,this._doc.setProspectiveChange(this._dragChange),Math.abs(this._mouseX-this._mouseXStart)>4&&(this._mouseDragging=!0),this._mouseDragging){const t=this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];this._draggingFadeIn?e.append(new ea(this._doc,this._xToFadeIn(this._fadeInToX(t.fadeIn)+this._mouseX-this._mouseXStart),t.fadeOut)):e.append(new ea(this._doc,t.fadeIn,this._xToFadeOut(this._fadeOutToX(t.fadeOut)+this._mouseX-this._mouseXStart)))}}}render(){const e=this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];if(this._renderedFadeIn==e.fadeIn&&this._renderedFadeOut==e.fadeOut)return;const t=this._fadeInToX(e.fadeIn),n=this._fadeOutToX(e.fadeOut);this._controlCurve.setAttribute("d",`M ${t} 0 L ${t} ${this._editorHeight} M ${n} 0 L ${n} ${this._editorHeight}`);const i=this._fadeOutToX(w.fadeOutNeutral);let s="";s+=`M 0 ${this._editorHeight} `,s+=`L ${t} 0 `,ms.fadeOutSettingToTicks(e.fadeOut)>0?(s+=`L ${i} 0 `,s+=`L ${n} ${this._editorHeight} `):(s+=`L ${n} 0 `,s+=`L ${i} ${this._editorHeight} `),s+="z",this._fadeCurve.setAttribute("d",s)}}const{button:sa,div:yn,h2:Gp,input:Cr}=Ke;class Zp{constructor(e){a(this,"_editorWidth",200);a(this,"_editorHeight",52);a(this,"_fill",me.path({fill:Q.uiWidgetBackground,"pointer-events":"none"}));a(this,"_ticks",me.svg({"pointer-events":"none"}));a(this,"_subticks",me.svg({"pointer-events":"none"}));a(this,"_boostCurve",me.path({fill:"none",stroke:Q.textSelection,"stroke-width":2,"pointer-events":"none"}));a(this,"_boostDot",me.circle({fill:Q.textSelection,stroke:"none",r:"3"}));a(this,"_midCurve",me.path({fill:"none",stroke:Q.primaryText,"stroke-width":2,"pointer-events":"none"}));a(this,"_limitCurve",me.path({fill:"none",stroke:Q.linkAccent,"stroke-width":2,"pointer-events":"none"}));a(this,"_limitDot",me.circle({fill:Q.linkAccent,stroke:"none",r:"3"}));a(this,"_label0",me.text({x:"-1.5%",y:"148.5%","pointer-events":"none","font-size":"7pt",fill:"var(--secondary-text)"},"0"));a(this,"_label1",me.text({x:"48.2%",y:"148.5%","pointer-events":"none","font-size":"7pt",fill:"var(--secondary-text)"},"1"));a(this,"_label2",me.text({x:"98.2%",y:"148.5%","pointer-events":"none","font-size":"7pt",fill:"var(--secondary-text)"},"2"));a(this,"_inLabel",me.text({x:"-5%",y:"113.5%","pointer-events":"none","font-size":"6pt",fill:"var(--secondary-text)"},"In"));a(this,"_outLabel",me.text({x:"-9%",y:"131%","pointer-events":"none","font-size":"6pt",fill:"var(--secondary-text)"},"Out"));a(this,"_xAxisLabel",me.text({x:"42%",y:"172%","pointer-events":"none","font-size":"7pt",fill:"var(--primary-text)"},"Volume"));a(this,"_yAxisLabel",me.text({x:"55.2%",y:"160%","pointer-events":"none","font-size":"7pt",transform:"rotate(-90 30,120)",fill:"var(--primary-text)"},"Gain"));a(this,"_inVolumeBg",me.rect({"pointer-events":"none",width:"100%",height:"6px",x:"0%",y:"105%",fill:Q.uiWidgetBackground}));a(this,"_outVolumeBg",me.rect({"pointer-events":"none",width:"100%",height:"6px",x:"0%",y:"120%",fill:Q.uiWidgetBackground}));a(this,"_inVolumeBar",me.rect({"pointer-events":"none",height:"6px",x:"0%",y:"105%",fill:"url('#volumeGrad')"}));a(this,"_inVolumeCap",me.rect({"pointer-events":"none",width:"2px",height:"6px",y:"105%",fill:Q.uiWidgetFocus}));a(this,"_outVolumeBar",me.rect({"pointer-events":"none",height:"6px",x:"0%",y:"120%",fill:"url('#volumeGrad')"}));a(this,"_outVolumeCap",me.rect({"pointer-events":"none",width:"2px",height:"6px",y:"120%",fill:Q.uiWidgetFocus}));a(this,"_stop1",me.stop({"stop-color":"lime",offset:"30%"}));a(this,"_stop2",me.stop({"stop-color":"orange",offset:"45%"}));a(this,"_stop3",me.stop({"stop-color":"red",offset:"50%"}));a(this,"_gradient",me.linearGradient({id:"volumeGrad",gradientUnits:"userSpaceOnUse"},this._stop1,this._stop2,this._stop3));a(this,"_defs",me.defs({},this._gradient));a(this,"_svg",me.svg({style:`background-color: ${Q.editorBackground}; touch-action: none; overflow: visible;`,width:"100%",height:"100%",viewBox:"0 0 "+this._editorWidth+" "+this._editorHeight,preserveAspectRatio:"none"},this._defs,this._fill,this._ticks,this._subticks,this._boostCurve,this._midCurve,this._limitCurve,this._boostDot,this._limitDot,this._label0,this._label1,this._label2,this._inLabel,this._outLabel,this._xAxisLabel,this._yAxisLabel,this._inVolumeBg,this._outVolumeBg,this._inVolumeBar,this._outVolumeBar,this._inVolumeCap,this._outVolumeCap));a(this,"container",Ke.div({class:"",style:"height: 4em; width: 80%; padding-bottom: 1.5em;"},this._svg));a(this,"_limiterPrompt");for(let t=0;t<=2;t++)this._ticks.appendChild(me.rect({fill:Q.tonic,x:t*this._editorWidth/2-1,y:0,width:2,height:this._editorHeight}));for(let t=1;t<=3;t+=2)this._subticks.appendChild(me.rect({fill:Q.fifthNote,x:t*this._editorWidth/4-1,y:0,width:1,height:this._editorHeight}));this._limiterPrompt=e}animateVolume(e,t,n,i){this._inVolumeBar.setAttribute("width",""+Math.min(this._editorWidth,e*(this._editorWidth/2))),this._inVolumeCap.setAttribute("x",""+Math.min(this._editorWidth,t*(this._editorWidth/2))),this._outVolumeBar.setAttribute("width",""+Math.min(this._editorWidth,n*(this._editorWidth/2))),this._outVolumeCap.setAttribute("x",""+Math.min(this._editorWidth,i*(this._editorWidth/2)))}render(){const e=c=>Math.max(0,(1-c/5)*(this._editorHeight-1)+1);let t=0,n=0,i=-1,s="",h=["","",""];for(let c=0;c<64;c++){let _=+this._limiterPrompt.limitRatioSlider.value;_=_<10?_/10:_-9;let m=+this._limiterPrompt.compressionRatioSlider.value;m=m<10?m/10:1+(m-10)/60;let g=+this._limiterPrompt.limitThresholdSlider.value,S=+this._limiterPrompt.compressionThresholdSlider.value,E=c*2/64,A=1/1.05;E>=g?A=1/(1.05*(E+1-g)*_+(1-_)):E<S&&(A=1/(((E+1-S)*.8+.25)*m+1.05*(1-m))),c==0&&(s+="M 0 "+Le(e(A))+" "),n>i&&(i>=0&&(h[i]+="L "+Le(c*this._editorWidth/64)+" "+Le(e(A))+" "),h[n]+="M "+Le(c*this._editorWidth/64)+" "+Le(e(A))+" ",(n==1||i==0&&n==2)&&(this._boostDot.setAttribute("cx",Le(c*this._editorWidth/64)),this._boostDot.setAttribute("cy",Le(e(A)))),n==2&&(this._limitDot.setAttribute("cx",Le(c*this._editorWidth/64)),this._limitDot.setAttribute("cy",Le(e(A)))),i=n),t!=0||A!=0?(s+="L ",h[n]+="L "):(s+="M ",h[n]+="M "),s+=Le(c*this._editorWidth/64)+" "+Le(e(A))+" ",h[n]+=Le(c*this._editorWidth/64)+" "+Le(e(A))+" ",t=A,n==0&&c>=S*32-2&&n++,n==1&&c>=g*32-2&&n++}const d=e(t);t>0&&(s+="L "+(this._editorWidth-1)+" "+Le(d)+" ",h[n]+="L "+(this._editorWidth-1)+" "+Le(d)+" "),this._boostCurve.setAttribute("d",h[0]),this._midCurve.setAttribute("d",h[1]),this._limitCurve.setAttribute("d",h[2]),this._fill.setAttribute("d",s+"L "+this._editorWidth+" "+Le(d)+" L "+this._editorWidth+" "+Le(this._editorHeight)+" L 0 "+Le(this._editorHeight)+" z ")}}class ra{constructor(e,t){a(this,"limiterCanvas",new Zp(this));a(this,"_playButton",sa({style:"width: 55%;",type:"button"}));a(this,"limitDecaySlider",Cr({title:"limit decay",style:"width: 5em; flex-grow: 1; margin: 0;",type:"range",min:"1",max:"30",value:"4",step:"1"}));a(this,"limitRiseSlider",Cr({title:"limit rise",style:"width: 5em; flex-grow: 1; margin: 0;",type:"range",min:"2000",max:"10000",value:"4000",step:"250"}));a(this,"compressionThresholdSlider",Cr({title:"compressor threshold",style:"width: 100%; flex-grow: 1; margin: 0;",type:"range",min:"0",max:"1.1",value:"1",step:"0.05"}));a(this,"limitThresholdSlider",Cr({title:"limiter threshold",style:"width: 100%; flex-grow: 1; margin: 0;",type:"range",min:"0",max:"2",value:"1",step:"0.05"}));a(this,"compressionRatioSlider",Cr({title:"compressor ratio",style:"width: 100%; flex-grow: 1; margin: 0;",type:"range",min:"0",max:"20",value:"10",step:"1"}));a(this,"limitRatioSlider",Cr({title:"limiter ratio",style:"width: 100%; flex-grow: 1; margin: 0;",type:"range",min:"0",max:"20",value:"10",step:"1"}));a(this,"masterGainSlider",Cr({title:"master gain",style:"width: 5em; flex-grow: 1; margin: 0;",type:"range",min:"0",max:"5",value:"1",step:"0.02"}));a(this,"startingLimitDecay");a(this,"startingLimitRise");a(this,"startingCompressionThreshold");a(this,"startingLimitThreshold");a(this,"startingCompressionRatio");a(this,"startingLimitRatio");a(this,"startingMasterGain");a(this,"inVolumeHistoricTimer",0);a(this,"inVolumeHistoricCap",0);a(this,"outVolumeHistoricTimer",0);a(this,"outVolumeHistoricCap",0);a(this,"_cancelButton",sa({class:"cancelButton"}));a(this,"_okayButton",sa({class:"okayButton",style:"width:45%;"},"Okay"));a(this,"_resetButton",sa({style:"width:45%;"},"Reset"));a(this,"container",yn({class:"prompt noSelection",style:"width: 250px;"},Gp("Limiter Options"),yn({style:"display: flex; width: 55%; align-self: center; flex-direction: row; align-items: center; justify-content: center;"},this._playButton),yn({style:"display: flex; flex-direction: row; align-items: center; justify-content: center;"},this.limiterCanvas.container),yn({style:"display: flex; flex-direction: row; align-items: center; height: 2em; margin-top: 1.5em; justify-content: flex-end;"},yn({style:`text-align: right; width: 25%; margin-right: 4.5%; color: ${Q.primaryText};`},""),yn({style:`text-align: center; width: 33%; margin-right: 4.5%; color: ${Q.textSelection};`},"Boost"),yn({style:`text-align: center; width: 33%; margin-right: 0%; color: ${Q.linkAccent};`},"Cutoff")),yn({style:"display: flex; flex-direction: row; align-items: center; height: 2em; margin-top: 0.5em; justify-content: flex-end;"},yn({style:`text-align: right; width: 25%; margin-right: 4.5%; color: ${Q.primaryText};`},"Threshold:"),yn({style:"width: 33%; margin-right: 4.5%;"},this.compressionThresholdSlider),yn({style:"width: 33%; margin-right: 0%;"},this.limitThresholdSlider)),yn({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},yn({style:`text-align: right; width: 25%; margin-right: 4.5%; color: ${Q.primaryText};`},"Ratio:"),yn({style:"width: 33%; margin-right: 4.5%;"},this.compressionRatioSlider),yn({style:"width: 33%; margin-right: 0%;"},this.limitRatioSlider)),yn({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},yn({style:`text-align: right; width: 8.5em; margin-right: 1em; color: ${Q.primaryText};`},"Limit Decay:"),this.limitDecaySlider),yn({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},yn({style:`text-align: right; width: 8.5em; margin-right: 1em; color: ${Q.primaryText};`},"Limit Rise:"),this.limitRiseSlider),yn({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},yn({style:`text-align: right; width: 8.5em; margin-right: 1em; color: ${Q.primaryText};`},"Master Gain:"),this.masterGainSlider),yn({style:"display: flex; flex-direction: row-reverse; justify-content: space-between;"},this._okayButton,this._resetButton),this._cancelButton));a(this,"_volumeUpdate",()=>{this.inVolumeHistoricTimer--,this.inVolumeHistoricTimer<=0&&(this.inVolumeHistoricCap-=.03),this._doc.song.inVolumeCap>this.inVolumeHistoricCap&&(this.inVolumeHistoricCap=this._doc.song.inVolumeCap,this.inVolumeHistoricTimer=50),this.outVolumeHistoricTimer--,this.outVolumeHistoricTimer<=0&&(this.outVolumeHistoricCap-=.03),this._doc.song.outVolumeCap>this.outVolumeHistoricCap&&(this.outVolumeHistoricCap=this._doc.song.outVolumeCap,this.outVolumeHistoricTimer=50),this.limiterCanvas.animateVolume(this._doc.song.inVolumeCap,this.inVolumeHistoricCap,this._doc.song.outVolumeCap,this.outVolumeHistoricCap),window.requestAnimationFrame(this._volumeUpdate)});a(this,"_togglePlay",()=>{this._songEditor.togglePlay(),this.updatePlayButton()});a(this,"_whenInput",()=>{+this.limitThresholdSlider.value<+this.compressionThresholdSlider.value&&(this.limitThresholdSlider.removeEventListener("input",this._whenInputFavorLimitThreshold),this.limitThresholdSlider.value=this.compressionThresholdSlider.value,this.limitThresholdSlider.addEventListener("input",this._whenInputFavorLimitThreshold)),this.limiterCanvas.render(),this._updateLimiter()});a(this,"_whenInputFavorLimitThreshold",()=>{+this.limitThresholdSlider.value<+this.compressionThresholdSlider.value&&(this.compressionThresholdSlider.removeEventListener("input",this._whenInput),this.compressionThresholdSlider.value=this.limitThresholdSlider.value,this.compressionThresholdSlider.addEventListener("input",this._whenInput)),this.limiterCanvas.render(),this._updateLimiter()});a(this,"_close",()=>{this.limitRatioSlider.value=""+this.startingLimitRatio,this.compressionRatioSlider.value=""+this.startingCompressionRatio,this.limitThresholdSlider.value=""+this.startingLimitThreshold,this.compressionThresholdSlider.value=""+this.startingCompressionThreshold,this.limitDecaySlider.value=""+this.startingLimitDecay,this.limitRiseSlider.value=""+this.startingLimitRise,this.masterGainSlider.value=""+this.startingMasterGain,this._updateLimiter(),this._doc.prompt=null});a(this,"cleanUp",()=>{this._okayButton.removeEventListener("click",this._saveChanges),this._resetButton.removeEventListener("click",this._resetDefaults),this._cancelButton.removeEventListener("click",this._close),this.container.removeEventListener("keydown",this.whenKeyPressed),this.limitDecaySlider.removeEventListener("input",this._whenInput),this.limitRiseSlider.removeEventListener("input",this._whenInput),this.limitThresholdSlider.removeEventListener("input",this._whenInputFavorLimitThreshold),this.limitRatioSlider.removeEventListener("input",this._whenInput),this.compressionRatioSlider.removeEventListener("input",this._whenInput),this.compressionThresholdSlider.removeEventListener("input",this._whenInput),this.masterGainSlider.removeEventListener("input",this._whenInput),this._playButton.removeEventListener("click",this._togglePlay)});a(this,"whenKeyPressed",e=>{e.target.tagName!="BUTTON"&&e.keyCode==13&&this._saveChanges(),e.keyCode==32&&(this._togglePlay(),e.preventDefault())});a(this,"_resetDefaults",()=>{(this.limitRatioSlider.value!="10"||this.limitRiseSlider.value!="4000"||this.limitDecaySlider.value!="4"||this.limitThresholdSlider.value!="1"||this.compressionRatioSlider.value!="10"||this.compressionThresholdSlider.value!="1"||this.masterGainSlider.value!="1")&&(this.limitRatioSlider.value="10",this.limitRiseSlider.value="4000",this.limitDecaySlider.value="4",this.limitThresholdSlider.value="1",this.compressionRatioSlider.value="10",this.compressionThresholdSlider.value="1",this.masterGainSlider.value="1",this._whenInput())});a(this,"_updateLimiter",()=>{this._doc.record(new cf(this._doc,+this.limitRatioSlider.value<10?+this.limitRatioSlider.value/10:+this.limitRatioSlider.value-9,+this.compressionRatioSlider.value<10?+this.compressionRatioSlider.value/10:1+(+this.compressionRatioSlider.value-10)/60,+this.limitThresholdSlider.value,+this.compressionThresholdSlider.value,+this.limitRiseSlider.value,+this.limitDecaySlider.value,+this.masterGainSlider.value),!0)});a(this,"_saveChanges",()=>{this._updateLimiter(),this._doc.prompt=null});this._doc=e,this._songEditor=t,this._okayButton.addEventListener("click",this._saveChanges),this._resetButton.addEventListener("click",this._resetDefaults),this._cancelButton.addEventListener("click",this._close),this.container.addEventListener("keydown",this.whenKeyPressed),this.limitRatioSlider.value=""+(this._doc.song.limitRatio<1?this._doc.song.limitRatio*10:9+this._doc.song.limitRatio),this.compressionRatioSlider.value=""+(this._doc.song.compressionRatio<1?this._doc.song.compressionRatio*10:10+(this._doc.song.compressionRatio-1)*60),this.limitThresholdSlider.value=""+this._doc.song.limitThreshold,this.compressionThresholdSlider.value=""+this._doc.song.compressionThreshold,this.limitDecaySlider.value=""+this._doc.song.limitDecay,this.limitRiseSlider.value=""+this._doc.song.limitRise,this.masterGainSlider.value=""+this._doc.song.masterGain,this.startingLimitRatio=+this.limitRatioSlider.value,this.startingCompressionRatio=+this.compressionRatioSlider.value,this.startingLimitThreshold=+this.limitThresholdSlider.value,this.startingCompressionThreshold=+this.compressionThresholdSlider.value,this.startingLimitDecay=+this.limitDecaySlider.value,this.startingLimitRise=+this.limitRiseSlider.value,this.startingMasterGain=+this.masterGainSlider.value,this.limitDecaySlider.addEventListener("input",this._whenInput),this.limitRiseSlider.addEventListener("input",this._whenInput),this.limitRatioSlider.addEventListener("input",this._whenInput),this.limitThresholdSlider.addEventListener("input",this._whenInputFavorLimitThreshold),this.compressionRatioSlider.addEventListener("input",this._whenInput),this.compressionThresholdSlider.addEventListener("input",this._whenInput),this.masterGainSlider.addEventListener("input",this._whenInput),this._playButton.addEventListener("click",this._togglePlay),window.requestAnimationFrame(this._volumeUpdate),this.updatePlayButton(),setTimeout(()=>this._playButton.focus()),this.limiterCanvas.render()}updatePlayButton(){this._doc.synth.playing?(this._playButton.classList.remove("playButton"),this._playButton.classList.add("pauseButton"),this._playButton.title="Pause (Space)",this._playButton.innerText="Pause"):(this._playButton.classList.remove("pauseButton"),this._playButton.classList.add("playButton"),this._playButton.title="Play (Space)",this._playButton.innerText="Play")}}class Qp{constructor(e){a(this,"_editorHeight",20);a(this,"_startMode",0);a(this,"_endMode",1);a(this,"_bothMode",2);a(this,"_loop",me.path({fill:"none",stroke:Q.loopAccent,"stroke-width":4}));a(this,"_highlight",me.path({fill:Q.hoverPreview,"pointer-events":"none"}));a(this,"_svg",me.svg({style:"touch-action: pan-y; position: absolute;",height:this._editorHeight},this._loop,this._highlight));a(this,"container",Ke.div({class:"loopEditor"},this._svg));a(this,"_barWidth",32);a(this,"_change",null);a(this,"_cursor",{startBar:-1,mode:-1});a(this,"_mouseX",0);a(this,"_clientStartX",0);a(this,"_clientStartY",0);a(this,"_startedScrolling",!1);a(this,"_draggingHorizontally",!1);a(this,"_mouseDown",!1);a(this,"_mouseOver",!1);a(this,"_renderedLoopStart",-1);a(this,"_renderedLoopStop",-1);a(this,"_renderedBarCount",0);a(this,"_renderedBarWidth",-1);a(this,"_whenMouseOver",e=>{this._mouseOver||(this._mouseOver=!0,this._updatePreview())});a(this,"_whenMouseOut",e=>{this._mouseOver&&(this._mouseOver=!1,this._updatePreview())});a(this,"_whenMousePressed",e=>{e.preventDefault(),this._mouseDown=!0;const t=this._svg.getBoundingClientRect();this._mouseX=(e.clientX||e.pageX)-t.left,this._updateCursorStatus(),this._updatePreview(),this._whenMouseMoved(e)});a(this,"_whenTouchPressed",e=>{this._mouseDown=!0;const t=this._svg.getBoundingClientRect();this._mouseX=e.touches[0].clientX-t.left,this._updateCursorStatus(),this._updatePreview(),this._clientStartX=e.touches[0].clientX,this._clientStartY=e.touches[0].clientY,this._draggingHorizontally=!1,this._startedScrolling=!1});a(this,"_whenMouseMoved",e=>{const t=this._svg.getBoundingClientRect();this._mouseX=(e.clientX||e.pageX)-t.left,this._whenCursorMoved()});a(this,"_whenTouchMoved",e=>{if(!this._mouseDown)return;const t=this._svg.getBoundingClientRect();this._mouseX=e.touches[0].clientX-t.left,!this._draggingHorizontally&&!this._startedScrolling&&(Math.abs(e.touches[0].clientY-this._clientStartY)>10?this._startedScrolling=!0:Math.abs(e.touches[0].clientX-this._clientStartX)>10&&(this._draggingHorizontally=!0)),this._draggingHorizontally&&(this._whenCursorMoved(),e.preventDefault())});a(this,"_whenTouchReleased",e=>{e.preventDefault(),this._startedScrolling||(this._whenCursorMoved(),this._mouseOver=!1,this._whenCursorReleased(e),this._updatePreview()),this._mouseDown=!1});a(this,"_whenCursorReleased",e=>{this._change!=null&&this._doc.record(this._change),this._change=null,this._mouseDown=!1,this._updateCursorStatus(),this._render()});a(this,"_documentChanged",()=>{this._render()});this._doc=e,this._updateCursorStatus(),this._render(),this._doc.notifier.watch(this._documentChanged),this.container.addEventListener("mousedown",this._whenMousePressed),document.addEventListener("mousemove",this._whenMouseMoved),document.addEventListener("mouseup",this._whenCursorReleased),this.container.addEventListener("mouseover",this._whenMouseOver),this.container.addEventListener("mouseout",this._whenMouseOut),this.container.addEventListener("touchstart",this._whenTouchPressed),this.container.addEventListener("touchmove",this._whenTouchMoved),this.container.addEventListener("touchend",this._whenTouchReleased),this.container.addEventListener("touchcancel",this._whenTouchReleased)}_updateCursorStatus(){const e=this._mouseX/this._barWidth;this._cursor.startBar=e,e>this._doc.song.loopStart-.25&&e<this._doc.song.loopStart+this._doc.song.loopLength+.25?e-this._doc.song.loopStart<this._doc.song.loopLength*.5?this._cursor.mode=this._startMode:this._cursor.mode=this._endMode:this._cursor.mode=this._bothMode}_findEndPoints(e){let t=Math.round(e-this._doc.song.loopLength/2),n=t+this._doc.song.loopLength;return t<0&&(n-=t,t=0),n>this._doc.song.barCount&&(t-=n-this._doc.song.barCount,n=this._doc.song.barCount),{start:t,length:n-t}}_whenCursorMoved(){if(this._mouseDown){let e=this._doc.song.loopStart,t=this._doc.song.loopStart+this._doc.song.loopLength;this._change!=null&&this._doc.lastChangeWas(this._change)&&(e=this._change.oldStart,t=e+this._change.oldLength);const n=this._mouseX/this._barWidth;let i,s,h;if(this._cursor.mode==this._startMode)i=e+Math.round(n-this._cursor.startBar),s=t,i<0&&(i=0),i>=this._doc.song.barCount&&(i=this._doc.song.barCount),i==s?i=s-1:i>s&&(h=i,i=s,s=h),this._change=new vl(this._doc,e,t-e,i,s-i);else if(this._cursor.mode==this._endMode)i=e,s=t+Math.round(n-this._cursor.startBar),s<0&&(s=0),s>=this._doc.song.barCount&&(s=this._doc.song.barCount),s==i?s=i+1:s<i&&(h=i,i=s,s=h),this._change=new vl(this._doc,e,t-e,i,s-i);else if(this._cursor.mode==this._bothMode){const d=this._findEndPoints(n);this._change=new vl(this._doc,e,t-e,d.start,d.length)}this._doc.synth.jumpIntoLoop(),this._doc.prefs.autoFollow&&new _r(this._doc,this._doc.channel,Math.floor(this._doc.synth.playhead),!0),this._doc.setProspectiveChange(this._change)}else this._updateCursorStatus(),this._updatePreview()}_updatePreview(){const e=this._mouseOver&&!this._mouseDown;if(this._highlight.style.visibility=e?"visible":"hidden",e){const t=this._editorHeight/2;let n=this._doc.song.loopStart*this._barWidth,i=(this._doc.song.loopStart+this._doc.song.loopLength)*this._barWidth;if(this._cursor.mode==this._startMode)i=this._doc.song.loopStart*this._barWidth+t*2;else if(this._cursor.mode==this._endMode)n=(this._doc.song.loopStart+this._doc.song.loopLength)*this._barWidth-t*2;else{const s=this._findEndPoints(this._cursor.startBar);n=s.start*this._barWidth,i=(s.start+s.length)*this._barWidth}this._highlight.setAttribute("d",`M ${n+t} 4 L ${i-t} 4 A ${t-4} ${t-4} 0 0 1 ${i-t} ${this._editorHeight-4} L ${n+t} ${this._editorHeight-4} A ${t-4} ${t-4} 0 0 1 ${n+t} 4 z`)}}_render(){this._barWidth=this._doc.getBarWidth();const e=this._editorHeight/2,t=this._doc.song.loopStart*this._barWidth,n=(this._doc.song.loopStart+this._doc.song.loopLength)*this._barWidth;if(this._renderedBarCount!=this._doc.song.barCount||this._renderedBarWidth!=this._barWidth){this._renderedBarCount=this._doc.song.barCount,this._renderedBarWidth=this._barWidth;const i=this._barWidth*this._doc.song.barCount;this.container.style.width=i+"px",this._svg.setAttribute("width",i+"")}(this._renderedLoopStart!=t||this._renderedLoopStop!=n)&&(this._renderedLoopStart=t,this._renderedLoopStop=n,this._loop.setAttribute("d",`M ${t+e} 2 L ${n-e} 2 A ${e-2} ${e-2} 0 0 1 ${n-e} ${this._editorHeight-2} L ${t+e} ${this._editorHeight-2} A ${e-2} ${e-2} 0 0 1 ${t+e} 2 z`)),this._updatePreview()}}const{button:wc,div:jr,span:Jp,h2:e_,input:t_,br:n_,select:i_,option:xc}=Ke;class Na{constructor(e){a(this,"_beatsStepper",t_({style:"width: 3em; margin-left: 1em;",type:"number",step:"0.01",value:"0"}));a(this,"_conversionStrategySelect",i_({style:"width: 100%;"},xc({value:"overflow"},"Overflow notes across bars."),xc({value:"wrapAround"},"Wrap notes around within bars.")));a(this,"_cancelButton",wc({class:"cancelButton"}));a(this,"_okayButton",wc({class:"okayButton",style:"width:45%;"},"Okay"));a(this,"container",jr({class:"prompt noSelection",style:"width: 250px;"},e_("Move Notes Sideways"),jr({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},jr({style:"text-align: right;"},"Beats to move:",n_(),Jp({style:`font-size: smaller; color: ${Q.secondaryText};`},"(Negative is left, positive is right)")),this._beatsStepper),jr({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},jr({class:"selectContainer",style:"width: 100%;"},this._conversionStrategySelect)),jr({style:"display: flex; flex-direction: row-reverse; justify-content: space-between;"},this._okayButton),this._cancelButton));a(this,"_close",()=>{this._doc.undo()});a(this,"cleanUp",()=>{this._okayButton.removeEventListener("click",this._saveChanges),this._cancelButton.removeEventListener("click",this._close),this._beatsStepper.removeEventListener("blur",Na._validateNumber),this.container.removeEventListener("keydown",this._whenKeyPressed)});a(this,"_whenKeyPressed",e=>{e.target.tagName!="BUTTON"&&e.keyCode==13&&this._saveChanges()});a(this,"_saveChanges",()=>{window.localStorage.setItem("moveNotesSidewaysStrategy",this._conversionStrategySelect.value),this._doc.prompt=null,this._doc.record(new np(this._doc,+this._beatsStepper.value,this._conversionStrategySelect.value),!0)});this._doc=e,this._beatsStepper.min=-this._doc.song.beatsPerBar+"",this._beatsStepper.max=this._doc.song.beatsPerBar+"";const t=window.localStorage.getItem("moveNotesSidewaysStrategy");t!=null&&(this._conversionStrategySelect.value=t),this._beatsStepper.select(),setTimeout(()=>this._beatsStepper.focus(),100),this._okayButton.addEventListener("click",this._saveChanges),this._cancelButton.addEventListener("click",this._close),this._beatsStepper.addEventListener("blur",Na._validateNumber),this.container.addEventListener("keydown",this._whenKeyPressed)}static _validateNumber(e){const t=e.target;let n=+t.value;n=Math.round(n*w.partsPerBeat)/w.partsPerBeat,n=Math.round(n*100)/100,t.value=Math.max(+t.min,Math.min(+t.max,n))+""}}class s_{constructor(e,t){a(this,"_cornerFiller",Ke.div({style:`background: ${Q.editorBackground}; position: sticky; bottom: 0; left: 0; width: 32px; height: 30px;`}));a(this,"_buttons",[]);a(this,"_channelCounts",[]);a(this,"_channelNameDisplay",Ke.div({style:`background-color: ${Q.uiWidgetFocus}; white-space:nowrap; display: none; transform:translate(20px); width: auto; pointer-events: none; position: absolute; border-radius: 0.2em; z-index: 2;`,color:Q.primaryText},""));a(this,"_channelNameInput",new mu(Ke.input({style:`color: ${Q.primaryText}; background-color: ${Q.uiWidgetFocus}; margin-top: -2px; display: none; width: 6em; position: absolute; border-radius: 0.2em; z-index: 2;`,color:Q.primaryText},""),this._doc,(e,t)=>new pp(this._doc,e,t)));a(this,"_channelDropDown",Ke.select({style:"width: 0px; left: 19px; height: 19px; position:absolute; opacity:0"},Ke.option({value:"rename"},"Rename..."),Ke.option({value:"chnUp"},"Move Channel Up"),Ke.option({value:"chnDown"},"Move Channel Down"),Ke.option({value:"chnMute"},"Mute Channel"),Ke.option({value:"chnSolo"},"Solo Channel"),Ke.option({value:"chnInsert"},"Insert Channel Below"),Ke.option({value:"chnDelete"},"Delete This Channel")));a(this,"container",Ke.div({class:"muteEditor",style:"position: sticky; padding-top: "+w.barEditorHeight+"px;"},this._channelNameDisplay,this._channelNameInput.input,this._channelDropDown));a(this,"_editorHeight",128);a(this,"_renderedChannelCount",0);a(this,"_renderedPitchChannels",0);a(this,"_renderedNoiseChannels",0);a(this,"_renderedModChannels",0);a(this,"_renderedChannelHeight",-1);a(this,"_channelDropDownChannel",0);a(this,"_channelDropDownOpen",!1);a(this,"_channelDropDownLastState",!1);a(this,"_channelNameInputWhenInput",()=>{let e=this._channelNameInput.input.value;e.length>15&&(this._channelNameInput.input.value=e.substring(0,15))});a(this,"_channelNameInputClicked",e=>{e.stopPropagation()});a(this,"_channelNameInputHide",()=>{this._channelNameInput.input.style.setProperty("display","none"),this._channelNameDisplay.style.setProperty("display","none")});a(this,"_channelDropDownClick",e=>{this._channelDropDownOpen=!this._channelDropDownLastState,this._channelDropDownGetOpenedPosition(e)});a(this,"_channelDropDownBlur",()=>{this._channelDropDownOpen=!1,this._channelNameDisplay.style.setProperty("display","none")});a(this,"_channelDropDownGetOpenedPosition",e=>{this._channelDropDownLastState=this._channelDropDownOpen,this._channelDropDownChannel=Math.floor(Math.min(this._renderedChannelCount,Math.max(0,parseInt(this._channelDropDown.style.getPropertyValue("top"))/this._renderedChannelHeight))),this._doc.muteEditorChannel=this._channelDropDownChannel,this._channelNameDisplay.style.setProperty("display",""),this._channelDropDownChannel<this._doc.song.pitchChannelCount&&this._doc.song.pitchChannelCount==w.pitchChannelCountMax||this._channelDropDownChannel>=this._doc.song.pitchChannelCount&&this._channelDropDownChannel<this._doc.song.pitchChannelCount+this._doc.song.noiseChannelCount&&this._doc.song.noiseChannelCount==w.noiseChannelCountMax||this._channelDropDownChannel>=this._doc.song.pitchChannelCount+this._doc.song.noiseChannelCount&&this._doc.song.modChannelCount==w.modChannelCountMax?this._channelDropDown.options[5].disabled=!0:this._channelDropDown.options[5].disabled=!1,this._channelDropDownChannel==0||this._channelDropDownChannel==this._doc.song.pitchChannelCount||this._channelDropDownChannel==this._doc.song.pitchChannelCount+this._doc.song.noiseChannelCount?this._channelDropDown.options[1].disabled=!0:this._channelDropDown.options[1].disabled=!1,this._channelDropDownChannel==this._doc.song.pitchChannelCount-1||this._channelDropDownChannel==this._doc.song.pitchChannelCount+this._doc.song.noiseChannelCount-1||this._channelDropDownChannel==this._doc.song.getChannelCount()-1?this._channelDropDown.options[2].disabled=!0:this._channelDropDown.options[2].disabled=!1,this._doc.song.pitchChannelCount==1&&this._channelDropDownChannel==0?this._channelDropDown.options[6].disabled=!0:this._channelDropDown.options[6].disabled=!1});a(this,"_channelDropDownHandler",e=>{switch(this._channelNameDisplay.style.setProperty("display","none"),this._channelDropDown.style.setProperty("display","none"),this._channelDropDownOpen=!1,e.stopPropagation(),this._channelDropDown.value){case"rename":this._channelNameInput.input.style.setProperty("display",""),this._channelNameInput.input.style.setProperty("transform",this._channelNameDisplay.style.getPropertyValue("transform")),this._channelNameDisplay.textContent!=null?this._channelNameInput.input.value=this._channelNameDisplay.textContent:this._channelNameInput.input.value="",this._channelNameInput.input.select();break;case"chnUp":this._doc.record(new Ia(this._doc,this._channelDropDownChannel,this._channelDropDownChannel,-1));break;case"chnDown":this._doc.record(new Ia(this._doc,this._channelDropDownChannel,this._channelDropDownChannel,1));break;case"chnMute":this._doc.song.channels[this._channelDropDownChannel].muted=!this._doc.song.channels[this._channelDropDownChannel].muted,this.render();break;case"chnSolo":{let t=!1;for(let n=0;n<this._doc.song.pitchChannelCount+this._doc.song.noiseChannelCount;n++)this._doc.song.channels[n].muted==(n==this._channelDropDownChannel)&&(t=!0,n=this._doc.song.pitchChannelCount+this._doc.song.noiseChannelCount);if(t)for(let n=0;n<this._doc.song.pitchChannelCount+this._doc.song.noiseChannelCount;n++)this._doc.song.channels[n].muted=n!=this._channelDropDownChannel;else for(let n=0;n<this._doc.song.pitchChannelCount+this._doc.song.noiseChannelCount;n++)this._doc.song.channels[n].muted=!1;this.render();break}case"chnInsert":{this._doc.channel=this._channelDropDownChannel,this._doc.selection.resetBoxSelection(),this._doc.selection.insertChannel();break}case"chnDelete":{this._doc.record(new lu(this._doc,this._channelDropDownChannel,this._channelDropDownChannel));break}}this._channelDropDown.value!="rename"&&this._editor.refocusStage(),this._channelDropDown.selectedIndex=-1});a(this,"_onClick",e=>{const t=this._buttons.indexOf(e.target);if(t==-1)return;e.clientX-this._buttons[0].getBoundingClientRect().left<21&&(this._doc.song.channels[t].muted=!this._doc.song.channels[t].muted),this._doc.notifier.changed()});a(this,"_onMouseMove",e=>{const t=this._buttons.indexOf(e.target);if(t==-1){!this._channelDropDownOpen&&e.target!=this._channelNameDisplay&&e.target!=this._channelDropDown&&(this._channelNameDisplay.style.setProperty("display","none"),this._channelDropDown.style.setProperty("display","none"),this._channelDropDown.style.setProperty("width","0px"));return}if(e.clientX-this._buttons[0].getBoundingClientRect().left>=21){if(!this._channelDropDownOpen){this._channelDropDown.style.setProperty("display","");var i=this._doc.getChannelHeight();this._channelNameDisplay.style.setProperty("transform","translate(20px, "+(i/4+i*t)+"px)"),this._doc.song.channels[t].name!=""?(this._channelNameDisplay.textContent=this._doc.song.channels[t].name,this._channelNameDisplay.style.setProperty("display","")):(t<this._doc.song.pitchChannelCount?this._channelNameDisplay.textContent="Pitch "+(t+1):t<this._doc.song.pitchChannelCount+this._doc.song.noiseChannelCount?this._channelNameDisplay.textContent="Noise "+(t-this._doc.song.pitchChannelCount+1):this._channelNameDisplay.textContent="Mod "+(t-this._doc.song.pitchChannelCount-this._doc.song.noiseChannelCount+1),this._channelNameDisplay.style.setProperty("display","none")),this._channelDropDown.style.top=w.barEditorHeight+2+t*this._renderedChannelHeight+"px",this._channelDropDown.style.setProperty("width","15px")}}else this._channelDropDownOpen||(this._channelNameDisplay.style.setProperty("display","none"),this._channelDropDown.style.setProperty("display","none"),this._channelDropDown.style.setProperty("width","0px"))});a(this,"_onMouseLeave",e=>{this._channelDropDownOpen||(this._channelNameDisplay.style.setProperty("display","none"),this._channelDropDown.style.setProperty("width","0px"))});this._doc=e,this._editor=t,this.container.addEventListener("click",this._onClick),this.container.addEventListener("mousemove",this._onMouseMove),this.container.addEventListener("mouseleave",this._onMouseLeave),this._channelDropDown.selectedIndex=-1,this._channelDropDown.addEventListener("change",this._channelDropDownHandler),this._channelDropDown.addEventListener("mousedown",this._channelDropDownGetOpenedPosition),this._channelDropDown.addEventListener("blur",this._channelDropDownBlur),this._channelDropDown.addEventListener("click",this._channelDropDownClick),this._channelNameInput.input.addEventListener("change",this._channelNameInputHide),this._channelNameInput.input.addEventListener("blur",this._channelNameInputHide),this._channelNameInput.input.addEventListener("mousedown",this._channelNameInputClicked),this._channelNameInput.input.addEventListener("input",this._channelNameInputWhenInput)}onKeyUp(e){switch(e.keyCode){case 27:this._channelDropDownOpen=!1,this._channelNameDisplay.style.setProperty("display","none");break;case 13:this._channelDropDownOpen=!1,this._channelNameDisplay.style.setProperty("display","none");break}}render(){if(!this._doc.prefs.enableChannelMuting)return;const e=this._doc.getChannelHeight();if(this._renderedChannelCount!=this._doc.song.getChannelCount()){for(let t=this._renderedChannelCount;t<this._doc.song.getChannelCount();t++){const n=Ke.div({class:"noSelection muteButtonText",style:"display: table-cell; -webkit-text-stroke: 1.5px; vertical-align: middle; text-align: center; -webkit-user-select: none; -webkit-touch-callout: none; -moz-user-select: none; -ms-user-select: none; user-select: none; pointer-events: none; width: 12px; height: 20px; transform: translate(0px, 1px);"}),i=Ke.div({class:"mute-button",title:"Mute (M), Mute All (M), Solo (S), Exclude (S)",style:"display: block; pointer-events: none; width: 16px; height: 20px; transform: translate(2px, 1px);"}),s=Ke.div({style:"align-items: center; height: 20px; margin: 0px; display: table; flex-direction: row; justify-content: space-between;"},[i,n]);this.container.appendChild(s),this._buttons[t]=s,this._channelCounts[t]=n}for(let t=this._doc.song.getChannelCount();t<this._renderedChannelCount;t++)this.container.removeChild(this._buttons[t]);this._buttons.length=this._doc.song.getChannelCount(),this.container.appendChild(this._cornerFiller)}for(let t=0;t<this._doc.song.getChannelCount();t++)this._doc.song.channels[t].muted?(this._buttons[t].children[0].classList.add("muted"),t<this._doc.song.pitchChannelCount?this._channelCounts[t].style.color=Q.trackEditorBgPitchDim:t<this._doc.song.pitchChannelCount+this._doc.song.noiseChannelCount?this._channelCounts[t].style.color=Q.trackEditorBgNoiseDim:this._channelCounts[t].style.color=Q.trackEditorBgModDim):(this._buttons[t].children[0].classList.remove("muted"),t<this._doc.song.pitchChannelCount?this._channelCounts[t].style.color=Q.trackEditorBgPitch:t<this._doc.song.pitchChannelCount+this._doc.song.noiseChannelCount?this._channelCounts[t].style.color=Q.trackEditorBgNoise:this._channelCounts[t].style.color=Q.trackEditorBgMod);if(this._renderedChannelHeight!=e||this._renderedChannelCount!=this._doc.song.getChannelCount())for(let t=0;t<this._doc.song.getChannelCount();t++)this._buttons[t].style.marginTop=(e-20)/2+"px",this._buttons[t].style.marginBottom=(e-20)/2+"px";if(this._renderedModChannels!=this._doc.song.modChannelCount||this._renderedChannelCount!=this._doc.song.getChannelCount())for(let t=0;t<this._doc.song.getChannelCount();t++)t<this._doc.song.pitchChannelCount+this._doc.song.noiseChannelCount?this._buttons[t].children[0].classList.remove("modMute"):this._buttons[t].children[0].classList.add("modMute");if(this._renderedModChannels!=this._doc.song.modChannelCount||this._renderedPitchChannels!=this._doc.song.pitchChannelCount||this._renderedNoiseChannels!=this._doc.song.noiseChannelCount){for(let t=0;t<this._doc.song.getChannelCount();t++)if(t<this._doc.song.pitchChannelCount){let n=t+1;this._channelCounts[t].textContent=n+"",this._channelCounts[t].style.fontSize=n>=10?"xx-small":"inherit"}else if(t<this._doc.song.pitchChannelCount+this._doc.song.noiseChannelCount){let n=t-this._doc.song.pitchChannelCount+1;this._channelCounts[t].textContent=n+"",this._channelCounts[t].style.fontSize=n>=10?"xx-small":"inherit"}else{let n=t-this._doc.song.pitchChannelCount-this._doc.song.noiseChannelCount+1;this._channelCounts[t].textContent=n+"",this._channelCounts[t].style.fontSize=n>=10?"xx-small":"inherit"}this._renderedPitchChannels=this._doc.song.pitchChannelCount,this._renderedNoiseChannels=this._doc.song.noiseChannelCount,this._renderedModChannels=this._doc.song.modChannelCount}(this._renderedChannelHeight!=e||this._renderedChannelCount!=this._doc.song.getChannelCount())&&(this._renderedChannelHeight=e,this._renderedChannelCount=this._doc.song.getChannelCount(),this._editorHeight=w.barEditorHeight+this._doc.song.getChannelCount()*e,this._channelNameDisplay.style.setProperty("display","none"),this.container.style.height=this._editorHeight+16+"px",this._renderedChannelHeight<27?(this._channelNameDisplay.style.setProperty("margin-top","-2px"),this._channelDropDown.style.setProperty("margin-top","-4px"),this._channelNameInput.input.style.setProperty("margin-top","-4px")):this._renderedChannelHeight<30?(this._channelNameDisplay.style.setProperty("margin-top","-1px"),this._channelDropDown.style.setProperty("margin-top","-3px"),this._channelNameInput.input.style.setProperty("margin-top","-3px")):(this._channelNameDisplay.style.setProperty("margin-top","0px"),this._channelDropDown.style.setProperty("margin-top","0px"),this._channelNameInput.input.style.setProperty("margin-top","-2px")))}}class r_{constructor(e,t){a(this,"_editorWidth",20);a(this,"_editorHeight",481);a(this,"_notchHeight",4);a(this,"_octaveCount",w.pitchOctaves);a(this,"_octaveHeight",(this._editorHeight-this._notchHeight)/this._octaveCount);a(this,"_handle",me.rect({fill:Q.uiWidgetBackground,x:2,y:0,width:this._editorWidth-4}));a(this,"_handleHighlight",me.rect({fill:"none",stroke:Q.hoverPreview,"stroke-width":2,"pointer-events":"none",x:1,y:0,width:this._editorWidth-2}));a(this,"_upHighlight",me.path({fill:Q.hoverPreview,"pointer-events":"none"}));a(this,"_downHighlight",me.path({fill:Q.hoverPreview,"pointer-events":"none"}));a(this,"_svg",me.svg({style:"background-color: ${ColorConfig.editorBackground}; touch-action: pan-x; position: absolute;",width:this._editorWidth,height:"100%",viewBox:"0 0 20 "+this._editorHeight,preserveAspectRatio:"none"}));a(this,"container",Ke.div({id:"octaveScrollBarContainer",style:"width: 20px; height: 100%; overflow: hidden; position: relative; flex-shrink: 0;"},this._svg));a(this,"_mouseY",0);a(this,"_mouseDown",!1);a(this,"_mouseOver",!1);a(this,"_dragging",!1);a(this,"_dragStart",0);a(this,"_barBottom",0);a(this,"_barHeight",0);a(this,"_renderedBarBottom",-1);a(this,"_renderedVisibleOctaveCount",-1);a(this,"_change",null);a(this,"_whenMouseOver",e=>{this._mouseOver||(this._mouseOver=!0,this._updatePreview())});a(this,"_whenMouseOut",e=>{this._mouseOver&&(this._mouseOver=!1,this._updatePreview())});a(this,"_whenMousePressed",e=>{e.preventDefault(),this._mouseDown=!0;const t=this._svg.getBoundingClientRect();this._mouseY=((e.clientY||e.pageY)-t.top)*this._editorHeight/(t.bottom-t.top),isNaN(this._mouseY)&&(this._mouseY=0),!(this._doc.song.getChannelIsNoise(this._doc.channel)||this._doc.song.getChannelIsMod(this._doc.channel))&&(this._updatePreview(),this._mouseY>=this._barBottom-this._barHeight&&this._mouseY<=this._barBottom&&(this._dragging=!0,this._change=null,this._dragStart=this._mouseY))});a(this,"_whenTouchPressed",e=>{e.preventDefault(),this._mouseDown=!0;const t=this._svg.getBoundingClientRect();this._mouseY=(e.touches[0].clientY-t.top)*this._editorHeight/(t.bottom-t.top),isNaN(this._mouseY)&&(this._mouseY=0),!(this._doc.song.getChannelIsNoise(this._doc.channel)||this._doc.song.getChannelIsMod(this._doc.channel))&&(this._updatePreview(),this._mouseY>=this._barBottom-this._barHeight&&this._mouseY<=this._barBottom&&(this._dragging=!0,this._change=null,this._dragStart=this._mouseY))});a(this,"_whenMouseMoved",e=>{const t=this._svg.getBoundingClientRect();this._mouseY=((e.clientY||e.pageY)-t.top)*this._editorHeight/(t.bottom-t.top),isNaN(this._mouseY)&&(this._mouseY=0),this._whenCursorMoved()});a(this,"_whenTouchMoved",e=>{if(!this._mouseDown)return;e.preventDefault();const t=this._svg.getBoundingClientRect();this._mouseY=(e.touches[0].clientY-t.top)*this._editorHeight/(t.bottom-t.top),isNaN(this._mouseY)&&(this._mouseY=0),this._whenCursorMoved()});a(this,"_whenCursorReleased",e=>{if(!this._doc.song.getChannelIsNoise(this._doc.channel)&&!this._doc.song.getChannelIsMod(this._doc.channel)&&this._mouseDown)if(this._dragging)this._change!=null&&this._doc.record(this._change);else{const t=this._doc.getVisibleOctaveCount(),n=w.pitchOctaves-t,i=this._doc.lastChangeWas(this._change),s=i?this._change.oldValue:this._doc.song.channels[this._doc.channel].octave,h=this._doc.getBaseVisibleOctave(this._doc.channel);this._mouseY<this._barBottom-this._barHeight*.5?h<n&&(this._change=new yl(this._doc,s,Math.floor(h+1+t*.5)),this._doc.record(this._change,i)):h>0&&(this._change=new yl(this._doc,s,Math.floor(h-1+t*.5)),this._doc.record(this._change,i))}this._mouseDown=!1,this._dragging=!1,this._updatePreview()});a(this,"_documentChanged",()=>{this._barBottom=this._editorHeight-this._octaveHeight*this._doc.getBaseVisibleOctave(this._doc.channel),this._svg.style.visibility=this._doc.song.getChannelIsNoise(this._doc.channel)||this._doc.song.getChannelIsMod(this._doc.channel)?"hidden":"visible";const e=this._doc.getVisibleOctaveCount();(this._renderedBarBottom!=this._barBottom||this._renderedVisibleOctaveCount!=e)&&(this._renderedBarBottom=this._barBottom,this._renderedVisibleOctaveCount=e,this._barHeight=this._octaveHeight*e+this._notchHeight,this._handle.setAttribute("height",String(this._barHeight)),this._handleHighlight.setAttribute("height",String(this._barHeight)),this._handle.setAttribute("y",String(this._barBottom-this._barHeight)),this._handleHighlight.setAttribute("y",String(this._barBottom-this._barHeight)),this._piano.forceRender()),this._updatePreview()});this._doc=e,this._piano=t,this._doc.notifier.watch(this._documentChanged),this._documentChanged(),this._svg.appendChild(this._handle);for(let d=0;d<=this._octaveCount;d++)this._svg.appendChild(me.rect({fill:Q.tonic,x:0,y:d*this._octaveHeight,width:this._editorWidth,height:this._notchHeight}));this._svg.appendChild(this._handleHighlight),this._svg.appendChild(this._upHighlight),this._svg.appendChild(this._downHighlight);const n=this._editorWidth*.5,i=20,s=9,h=6;this._upHighlight.setAttribute("d",`M ${n} ${s} L ${n+h} ${i} L ${n-h} ${i} z`),this._downHighlight.setAttribute("d",`M ${n} ${this._editorHeight-s} L ${n+h} ${this._editorHeight-i} L ${n-h} ${this._editorHeight-i} z`),this.container.addEventListener("mousedown",this._whenMousePressed),document.addEventListener("mousemove",this._whenMouseMoved),document.addEventListener("mouseup",this._whenCursorReleased),this.container.addEventListener("mouseover",this._whenMouseOver),this.container.addEventListener("mouseout",this._whenMouseOut),this.container.addEventListener("touchstart",this._whenTouchPressed),this.container.addEventListener("touchmove",this._whenTouchMoved),this.container.addEventListener("touchend",this._whenCursorReleased),this.container.addEventListener("touchcancel",this._whenCursorReleased)}_whenCursorMoved(){if(!(this._doc.song.getChannelIsNoise(this._doc.channel)||this._doc.song.getChannelIsMod(this._doc.channel))){if(this._dragging){const e=this._doc.getVisibleOctaveCount(),t=w.pitchOctaves-e,i=this._doc.lastChangeWas(this._change)?this._change.oldValue:this._doc.song.channels[this._doc.channel].octave;let h=this._doc.getBaseVisibleOctave(this._doc.channel);for(;this._mouseY-this._dragStart<-this._octaveHeight*.5&&h<t;)h++,this._dragStart-=this._octaveHeight;for(;this._mouseY-this._dragStart>this._octaveHeight*.5&&h>0;)h--,this._dragStart+=this._octaveHeight;this._change=new yl(this._doc,i,Math.floor(h+e*.5)),this._doc.setProspectiveChange(this._change)}this._mouseOver&&this._updatePreview()}}_updatePreview(){const e=this._mouseOver&&!this._mouseDown;let t=!1,n=!1,i=!1;e&&(this._mouseY<this._barBottom-this._barHeight?t=!0:this._mouseY>this._barBottom?n=!0:i=!0),this._upHighlight.style.visibility=t?"inherit":"hidden",this._downHighlight.style.visibility=n?"inherit":"hidden",this._handleHighlight.style.visibility=i?"inherit":"hidden"}}const Sc=(Math.random()*4294967295>>>0).toString(16);class o_{constructor(e){a(this,"_takeMidiHandlerFocus",e=>{localStorage.setItem("midiHandlerId",Sc)});a(this,"_handleStateChange",e=>{if(e.port.type==="input")switch(e.port.state){case"connected":this._registerMidiInput(e.port);break;case"disconnected":this._unregisterMidiInput(e.port);break}});a(this,"_registerMidiInput",e=>{e.addEventListener("midimessage",this._onMidiMessage)});a(this,"_unregisterMidiInput",e=>{e.removeEventListener("midimessage",this._onMidiMessage),this._doc.performance.clearAllPitches()});a(this,"_onMidiMessage",e=>{if(!this._doc.prefs.enableMidi||localStorage.getItem("midiHandlerId")!=Sc)return;const t=this._doc.song.getChannelIsNoise(this._doc.channel);let[n,i,s]=e.data;if(n&=240,t){const h=lh[i];if(h!=null)i=h.frequency;else return}else if(i-=w.keys[this._doc.song.key].basePitch,i<0||i>w.maxPitch)return;switch(n==jt.noteOn&&s==0&&(n=jt.noteOff),n){case jt.noteOn:this._doc.synth.preferLowerLatency=!0,this._doc.performance.addPerformedPitch(i);break;case jt.noteOff:this._doc.performance.removePerformedPitch(i);break}});this._doc=e,this.registerMidiAccessHandler()}async registerMidiAccessHandler(){if(navigator.requestMIDIAccess!=null)try{const e=await navigator.requestMIDIAccess();e.inputs.forEach(this._registerMidiInput),e.addEventListener("statechange",this._handleStateChange),this._takeMidiHandlerFocus(),window.addEventListener("focus",this._takeMidiHandlerFocus)}catch(e){console.error("Failed to get MIDI access",e)}}}const qs=class qs{constructor(e){a(this,"_possiblyPlayingPitchesFromKeyboard",!1);a(this,"_onWindowBlur",e=>{this._possiblyPlayingPitchesFromKeyboard&&(this._doc.performance.clearAllPitches(),this._possiblyPlayingPitchesFromKeyboard=!1)});this._doc=e,window.addEventListener("blur",this._onWindowBlur)}static keyPosToPitch(e,t,n,i){let s=null,h=null;switch(i){case"wickiHayden":s=n*5+t*2-2;break;case"songScale":const g=w.scales[e.song.scale].flags.map((S,E)=>S?E:null).filter(S=>S!=null);s=(n-1+Math.floor(t/g.length))*w.pitchesPerOctave+g[(t+g.length)%g.length];break;case"pianoAtC":s=qs._pianoAtC[n][t],h=w.keys.dictionary.C.basePitch;break;case"pianoAtA":s=qs._pianoAtA[n][t],h=w.keys.dictionary.A.basePitch;break;case"pianoTransposingC":s=qs._pianoAtC[n][t];break;case"pianoTransposingA":s=qs._pianoAtA[n][t];break}if(s==null)return null;const d=Math.max(0,e.song.channels[e.channel].octave-1)*w.pitchesPerOctave;let c=0;if(h!=null){const m=w.keys[e.song.key].basePitch;c=(h-m+144)%12}const _=d+c+s;return _<0||_>w.maxPitch?null:_}handleKeyEvent(e,t){switch(e.code){case"Backquote":this.handleKey(-1,3,t);break;case"Digit1":this.handleKey(0,3,t);break;case"Digit2":this.handleKey(1,3,t);break;case"Digit3":this.handleKey(2,3,t);break;case"Digit4":this.handleKey(3,3,t);break;case"Digit5":this.handleKey(4,3,t);break;case"Digit6":this.handleKey(5,3,t);break;case"Digit7":this.handleKey(6,3,t);break;case"Digit8":this.handleKey(7,3,t);break;case"Digit9":this.handleKey(8,3,t);break;case"Digit0":this.handleKey(9,3,t);break;case"Minus":this.handleKey(10,3,t);break;case"Equal":this.handleKey(11,3,t);break;case"IntlYen":this.handleKey(12,3,t);break;case"KeyQ":this.handleKey(0,2,t);break;case"KeyW":this.handleKey(1,2,t);break;case"KeyE":this.handleKey(2,2,t);break;case"KeyR":this.handleKey(3,2,t);break;case"KeyT":this.handleKey(4,2,t);break;case"KeyY":this.handleKey(5,2,t);break;case"KeyU":this.handleKey(6,2,t);break;case"KeyI":this.handleKey(7,2,t);break;case"KeyO":this.handleKey(8,2,t);break;case"KeyP":this.handleKey(9,2,t);break;case"BracketLeft":this.handleKey(10,2,t);break;case"BracketRight":this.handleKey(11,2,t);break;case"Backslash":e.key=="\\"||e.key=="|"?this.handleKey(12,2,t):this.handleKey(11,1,t);break;case"KeyA":this.handleKey(0,1,t);break;case"KeyS":this.handleKey(1,1,t);break;case"KeyD":this.handleKey(2,1,t);break;case"KeyF":this.handleKey(3,1,t);break;case"KeyG":this.handleKey(4,1,t);break;case"KeyH":this.handleKey(5,1,t);break;case"KeyJ":this.handleKey(6,1,t);break;case"KeyK":this.handleKey(7,1,t);break;case"KeyL":this.handleKey(8,1,t);break;case"Semicolon":this.handleKey(9,1,t);break;case"Quote":this.handleKey(10,1,t);break;case"IntlHash":this.handleKey(11,1,t);break;case"IntlBackslash":this.handleKey(-1,0,t);break;case"KeyZ":this.handleKey(0,0,t);break;case"KeyX":this.handleKey(1,0,t);break;case"KeyC":this.handleKey(2,0,t);break;case"KeyV":this.handleKey(3,0,t);break;case"KeyB":this.handleKey(4,0,t);break;case"KeyN":this.handleKey(5,0,t);break;case"KeyM":this.handleKey(6,0,t);break;case"Comma":this.handleKey(7,0,t);break;case"Period":this.handleKey(8,0,t);break;case"Slash":this.handleKey(9,0,t);break;case"IntlRo":this.handleKey(10,0,t);break;default:return}e.preventDefault()}handleKey(e,t,n){if(this._doc.song.getChannelIsNoise(this._doc.channel)){e>=0&&e<w.drumCount&&(n?(this._doc.synth.preferLowerLatency=!0,this._doc.performance.addPerformedPitch(e),this._possiblyPlayingPitchesFromKeyboard=!0):this._doc.performance.removePerformedPitch(e));return}const s=qs.keyPosToPitch(this._doc,e,t,this._doc.prefs.keyboardLayout);s!=null&&(n?(this._doc.synth.preferLowerLatency=!0,this._doc.performance.addPerformedPitch(s),this._possiblyPlayingPitchesFromKeyboard=!0):this._doc.performance.removePerformedPitch(s))}};a(qs,"_pianoAtC",[[0,2,4,5,7,9,11,12,14,16,17],[null,1,3,null,6,8,10,null,13,15,null,18],[12,14,16,17,19,21,23,24,26,28,29,31,33],[null,13,15,null,18,20,22,null,25,27,null,30,32]]),a(qs,"_pianoAtA",[[0,2,3,5,7,8,10,12,14,15,17],[-1,1,null,4,6,null,9,11,13,null,16,18],[12,14,15,17,19,20,22,24,26,27,29,31,32],[11,13,null,16,18,null,21,23,25,null,28,30,null]]);let Da=qs;const Eh="songVersion: ",Cc=8,a_=3*60*1e3,l_=1*60*1e3;function h_(r){return r.indexOf(Eh)==0}function c_(r){return JSON.parse(r.substring(Eh.length))}function Lo(r){return Eh+JSON.stringify(r)}function Pl(){return(Math.random()*(-1>>>0)>>>0).toString(32)}function d_(r,e){return e.versions[0].time-r.versions[0].time}function u_(r,e){return e.time-r.time}class Ya{constructor(){a(this,"_saveVersionTimeoutHandle",-1);a(this,"_song",new tu)}static getAllRecoveredSongs(){const e=[],t={};for(let n=0;n<localStorage.length;n++){const i=localStorage.key(n);if(h_(i)){const s=c_(i);let h=t[s.uid];h==null&&(h={versions:[]},t[s.uid]=h,e.push(h)),h.versions.push(s)}}for(const n of e)n.versions.sort(u_);return e.sort(d_),e}saveVersion(e,t,n){const i=t,s=Math.round(Date.now());clearTimeout(this._saveVersionTimeoutHandle),this._saveVersionTimeoutHandle=setTimeout(()=>{try{this._song.fromBase64String(n)}catch{window.alert(`Whoops, the song data appears to have been corrupted! Please try to recover the last working version of the song from the "Recover Recent Song..." option in BeepBox's "File" menu.`);return}const h=Ya.getAllRecoveredSongs();let d=null;for(const C of h)C.versions[0].uid==e&&(d=C);d==null&&(d={versions:[]},h.unshift(d));let c=d.versions,_=1e3;if(c.length>0){const C=c[0].time;_=c[0].work+Math.min(a_,s-C)}const m={uid:e,name:i,time:s,work:_},g=Lo(m);c.unshift(m),localStorage.setItem(g,n);let S=l_;const E=Math.pow(2,1/2);for(var A=1;A<c.length;A++){const C=c[A].work,k=A==c.length-1?0:c[A+1].work;if(C-k<S){let T=A;if(A<c.length-1){const b=c[A].time,R=c[A-1].time,V=c[A+1].time;b-V<.5*(R-b)&&(T=A+1)}localStorage.removeItem(Lo(c[T]));break}S*=E}for(;h.length>Cc;){let C=null,k=Number.POSITIVE_INFINITY;for(let T=Math.round(Cc/2);T<h.length;T++){const b=h[T],V=1/((s-b.versions[0].time)/(12*60*60*1e3)+1),D=(b.versions[0].work+5*60*1e3)*V;k>D&&(k=D,C=b)}for(const T of C.versions)localStorage.removeItem(Lo(T));h.splice(h.indexOf(C),1)}},750)}}class f_{constructor(e){a(this,"_channelIsDrum",!1);a(this,"_channelOctave",-1);a(this,"_songKey",-1);a(this,"_pitchesAreTemporary",!1);a(this,"_recentlyAddedPitches",[]);a(this,"_songLengthWhenRecordingStarted",-1);a(this,"_playheadPart",-1);a(this,"_playheadPattern",null);a(this,"_pitchesChanged",!1);a(this,"_lastNote",null);a(this,"_recordingChange",null);a(this,"_onAnimationFrame",()=>{window.requestAnimationFrame(this._onAnimationFrame),this._doc.synth.recording&&this._updateRecordedNotes()&&this._doc.notifier.notifyWatchers()});a(this,"_documentChanged",()=>{const e=this._doc.song.getChannelIsNoise(this._doc.channel),t=this._doc.song.channels[this._doc.channel].octave;(this._doc.synth.liveInputChannel!=this._doc.channel||this._channelIsDrum!=e||this._channelOctave!=t||this._songKey!=this._doc.song.key)&&(this._doc.synth.liveInputChannel=this._doc.channel,this._channelIsDrum=e,this._channelOctave=t,this._songKey=this._doc.song.key,this.clearAllPitches()),this._doc.synth.liveInputInstruments=this._doc.recentPatternInstruments[this._doc.channel]});this._doc=e,this._doc.notifier.watch(this._documentChanged),this._documentChanged(),window.requestAnimationFrame(this._onAnimationFrame)}play(){this._doc.synth.play(),this._doc.synth.enableMetronome=!1,this._doc.synth.countInMetronome=!1,this._doc.synth.maintainLiveInput()}pause(){this.clearAllPitches(),this._recordingChange!=null&&(this._doc.song.barCount>this._songLengthWhenRecordingStarted&&!this._lastBarHasPatterns()&&(new au(this._doc,this._doc.song.barCount-1,1),new _r(this._doc,this._doc.channel,this._doc.song.barCount-1)),this._recordingChange.isNoop()||(this._doc.record(this._recordingChange),this._recordingChange=null),this._lastNote=null),this._doc.synth.pause(),this._doc.synth.resetEffects(),this._doc.synth.enableMetronome=!1,this._doc.synth.countInMetronome=!1,this._doc.prefs.autoFollow&&this._doc.synth.goToBar(this._doc.bar),this._doc.synth.snapToBar()}record(){this._doc.synth.snapToBar();const e=Math.floor(this._doc.synth.playhead);e!=this._doc.bar&&new _r(this._doc,this._doc.channel,e),this._pitchesAreTemporary&&(this.clearAllPitches(),this._pitchesAreTemporary=!1),this._doc.synth.enableMetronome=this._doc.prefs.metronomeWhileRecording,this._doc.synth.countInMetronome=this._doc.prefs.metronomeCountIn,this._doc.synth.startRecording(),this._doc.synth.maintainLiveInput(),this._songLengthWhenRecordingStarted=this._doc.song.barCount,this._playheadPart=this._getCurrentPlayheadPart(),this._playheadPattern=null,this._pitchesChanged=!1,this._lastNote=null,this._recentlyAddedPitches.length=0,this._recordingChange=new Zt,this._doc.setProspectiveChange(this._recordingChange)}abortRecording(){this._recordingChange=null,this.pause()}pitchesAreTemporary(){return this._pitchesAreTemporary}_getMinDivision(){return this._doc.prefs.snapRecordedNotesToRhythm?w.partsPerBeat/w.rhythms[this._doc.song.rhythm].stepsPerBeat:1}_getCurrentPlayheadPart(){const e=this._doc.synth.playhead*this._doc.song.beatsPerBar*w.partsPerBeat;if(this._doc.prefs.snapRecordedNotesToRhythm){const t=this._getMinDivision();return Math.round(e/t)*t}return Math.round(e)}_lastBarHasPatterns(){for(let e=0;e<this._doc.song.getChannelCount();e++)if(this._doc.song.channels[e].bars[this._doc.song.barCount-1]!=0)return!0;return!1}_updateRecordedNotes(){if(this._recordingChange==null)return!1;if(!this._doc.lastChangeWas(this._recordingChange))return this.abortRecording(),!1;if(this._doc.synth.countInMetronome)return this._recentlyAddedPitches.length=0,this._pitchesChanged=!1,!1;const e=this._doc.song.beatsPerBar*w.partsPerBeat,t=this._playheadPart%e,n=Math.floor(this._playheadPart/e),i=this._playheadPart;this._playheadPart=this._getCurrentPlayheadPart();const s=this._playheadPart%e,h=Math.floor(this._playheadPart/e);if(t==s&&n==h)return!1;if(this._playheadPart<i)return this._lastNote=null,this._playheadPattern=null,!1;let d=!1;for(let c=n;c<=h;c++){c!=n&&(this._playheadPattern=null);const _=c==n?t:0,m=c==h?s:e;if(_==m)break;if(this._lastNote!=null&&!this._pitchesChanged&&_>0&&this._doc.synth.liveInputPitches.length>0)this._recordingChange.append(new hu(this._doc,this._lastNote,1,m,this._lastNote.continuesLastPattern)),this._doc.currentPatternIsDirty=!0;else{this._lastNote!=null&&(this._lastNote=null);let g=_,S=m;for(;g<m;){let E=!1;if(this._recentlyAddedPitches.length>0||this._doc.synth.liveInputPitches.length>0){if(this._playheadPattern==null&&(this._doc.selection.erasePatternInBar(this._recordingChange,this._doc.synth.liveInputChannel,c),this._recordingChange.append(new ur(this._doc,this._doc.synth.liveInputChannel,c)),this._playheadPattern=this._doc.song.getPattern(this._doc.synth.liveInputChannel,c)),this._playheadPattern==null)throw new Error;for(this._lastNote=new fr(-1,g,S,w.noteSizeMax,this._doc.song.getChannelIsNoise(this._doc.synth.liveInputChannel)),this._lastNote.continuesLastPattern=g==0&&!this._pitchesChanged,this._lastNote.pitches.length=0;this._recentlyAddedPitches.length>0&&!(this._lastNote.pitches.length>=w.maxChordSize);){const A=this._recentlyAddedPitches.shift();this._doc.synth.liveInputPitches.indexOf(A)==-1&&(this._lastNote.pitches.push(A),E=!0)}for(let A=0;A<this._doc.synth.liveInputPitches.length&&!(this._lastNote.pitches.length>=w.maxChordSize);A++)this._lastNote.pitches.push(this._doc.synth.liveInputPitches[A]);this._recordingChange.append(new yi(this._doc,this._playheadPattern,this._lastNote,this._playheadPattern.notes.length)),E&&(S=g+this._getMinDivision(),new ss(this._doc,this._lastNote,this._lastNote.start,S),this._lastNote=null),d=!0}this._pitchesChanged=E,g=S,S=m}}c==this._doc.song.barCount-1&&this._lastBarHasPatterns()&&(new ou(this._doc,this._doc.song.barCount,1),this._doc.bar--,d=!0)}return d}setTemporaryPitches(e,t){this._updateRecordedNotes();for(let n=0;n<e.length;n++)this._doc.synth.liveInputPitches[n]=e[n];this._doc.synth.liveInputPitches.length=Math.min(e.length,w.maxChordSize),this._doc.synth.liveInputDuration=t,this._doc.synth.liveInputStarted=!0,this._pitchesAreTemporary=!0,this._pitchesChanged=!0}addPerformedPitch(e){if(this._doc.synth.maintainLiveInput(),this._updateRecordedNotes(),this._pitchesAreTemporary&&(this.clearAllPitches(),this._pitchesAreTemporary=!1),!(this._doc.prefs.ignorePerformedNotesNotInScale&&!w.scales[this._doc.song.scale].flags[e%w.pitchesPerOctave])&&this._doc.synth.liveInputPitches.indexOf(e)==-1){for(this._doc.synth.liveInputPitches.push(e),this._pitchesChanged=!0;this._doc.synth.liveInputPitches.length>w.maxChordSize;)this._doc.synth.liveInputPitches.shift();if(this._doc.synth.liveInputDuration=Number.MAX_SAFE_INTEGER,this._recordingChange!=null){const t=this._recentlyAddedPitches.indexOf(e);for(t!=-1&&this._recentlyAddedPitches.splice(t,1),this._recentlyAddedPitches.push(e);this._recentlyAddedPitches.length>w.maxChordSize*4;)this._recentlyAddedPitches.shift()}}}removePerformedPitch(e){this._updateRecordedNotes();for(let t=0;t<this._doc.synth.liveInputPitches.length;t++)this._doc.synth.liveInputPitches[t]==e&&(this._doc.synth.liveInputPitches.splice(t,1),this._pitchesChanged=!0,t--)}clearAllPitches(){this._updateRecordedNotes(),this._doc.synth.liveInputPitches.length=0,this._pitchesChanged=!0}}class p_{constructor(e){a(this,"boxSelectionX0",0);a(this,"boxSelectionY0",0);a(this,"boxSelectionX1",0);a(this,"boxSelectionY1",0);a(this,"digits","");a(this,"instrumentDigits","");a(this,"patternSelectionStart",0);a(this,"patternSelectionEnd",0);a(this,"patternSelectionActive",!1);a(this,"_changeTranspose",null);a(this,"_changeTrack",null);a(this,"_changeInstrument",null);a(this,"_changeReorder",null);this._doc=e}toJSON(){return{x0:this.boxSelectionX0,x1:this.boxSelectionX1,y0:this.boxSelectionY0,y1:this.boxSelectionY1,start:this.patternSelectionStart,end:this.patternSelectionEnd}}fromJSON(e){e!=null&&(this.boxSelectionX0=+e.x0,this.boxSelectionX1=+e.x1,this.boxSelectionY0=+e.y0,this.boxSelectionY1=+e.y1,this.patternSelectionStart=+e.start,this.patternSelectionEnd=+e.end,this.digits="",this.instrumentDigits="",this.patternSelectionActive=this.patternSelectionStart<this.patternSelectionEnd)}selectionUpdated(){this._doc.notifier.changed(),this.digits="",this.instrumentDigits=""}get boxSelectionBar(){return Math.min(this.boxSelectionX0,this.boxSelectionX1)}get boxSelectionChannel(){return Math.min(this.boxSelectionY0,this.boxSelectionY1)}get boxSelectionWidth(){return Math.abs(this.boxSelectionX0-this.boxSelectionX1)+1}get boxSelectionHeight(){return Math.abs(this.boxSelectionY0-this.boxSelectionY1)+1}get boxSelectionActive(){return this.boxSelectionWidth>1||this.boxSelectionHeight>1}scrollToSelectedPattern(){this._doc.barScrollPos=Math.min(this._doc.bar,Math.max(this._doc.bar-(this._doc.trackVisibleBars-1),this._doc.barScrollPos)),this._doc.channelScrollPos=Math.min(this._doc.channel,Math.max(this._doc.channel-(this._doc.trackVisibleChannels-1),this._doc.channelScrollPos))}scrollToEndOfSelection(){this._doc.barScrollPos=Math.min(this.boxSelectionX1,Math.max(this.boxSelectionX1-(this._doc.trackVisibleBars-1),this._doc.barScrollPos)),this._doc.channelScrollPos=Math.min(this.boxSelectionY1,Math.max(this.boxSelectionY1-(this._doc.trackVisibleChannels-1),this._doc.channelScrollPos))}setChannelBar(e,t){if(e==this._doc.channel&&t==this._doc.bar)return;const n=this._doc.lastChangeWas(this._changeTrack);this._changeTrack=new Zt,this._changeTrack.append(new _r(this._doc,e,t));const i=this._doc.getCurrentPattern(0);i!=null&&i.instruments.indexOf(this._doc.viewedInstrument[this._doc.channel])<0&&(this._doc.viewedInstrument[this._doc.channel]=i.instruments[0]),this._doc.hasRedoHistory()||this._doc.record(this._changeTrack,n),this.selectionUpdated()}setPattern(e){this._doc.record(new Xi(this._doc,e,this.boxSelectionBar,this.boxSelectionChannel,this.boxSelectionWidth,this.boxSelectionHeight))}nextDigit(e,t,n){if(n)e=="3"?this._doc.record(new so(this._doc,0)):e=="4"?this._doc.record(new so(this._doc,1)):e=="6"?this._doc.record(new so(this._doc,2)):e=="8"?this._doc.record(new so(this._doc,3)):(e=="0"||e=="1")&&this._doc.record(new so(this._doc,4));else if(t){e=="0"&&(e="10"),this.instrumentDigits+=e;var i=parseInt(this.instrumentDigits);if(i!=0&&i<=this._doc.song.channels[this._doc.channel].instruments.length){this.selectInstrument(i-1);return}if(this.instrumentDigits=e,i=parseInt(this.instrumentDigits),i!=0&&i<=this._doc.song.channels[this._doc.channel].instruments.length){this.selectInstrument(i-1);return}this.instrumentDigits=""}else{this.digits+=e;let s=parseInt(this.digits);if(s<=this._doc.song.patternsPerChannel){this.setPattern(s);return}if(this.digits=e,s=parseInt(this.digits),s<=this._doc.song.patternsPerChannel){this.setPattern(s);return}this.digits=""}}setModChannel(e,t){this._doc.record(new rh(this._doc,e,t))}setModInstrument(e,t){this._doc.record(new Qf(this._doc,e,t))}setModSetting(e,t){this._doc.record(new Jf(this._doc,e,t))}setModFilter(e,t){this._doc.record(new ep(this._doc,e,t))}insertBars(){this._doc.record(new ou(this._doc,this.boxSelectionBar+this.boxSelectionWidth,this.boxSelectionWidth));const e=this.boxSelectionWidth;this.boxSelectionX0+=e,this.boxSelectionX1+=e}insertChannel(){const e=new Zt,t=this.boxSelectionChannel+this.boxSelectionHeight,n=this._doc.song.getChannelIsNoise(t-1),i=this._doc.song.getChannelIsMod(t-1);e.append(new df(this._doc,t,n,i)),e.isNoop()||(this.boxSelectionY0=this.boxSelectionY1=t,e.append(new _r(this._doc,t,this._doc.bar)),this._doc.record(e))}deleteBars(){const e=new Zt;if(this._doc.selection.patternSelectionActive){this.boxSelectionActive&&e.append(new er(this._doc,this.boxSelectionBar,this.boxSelectionWidth,this.boxSelectionChannel,this.boxSelectionHeight));for(const t of this._eachSelectedChannel())for(const n of this._eachSelectedPattern(t))e.append(new _s(this._doc,n,this._doc.selection.patternSelectionStart,this._doc.selection.patternSelectionEnd));e.append(new Fn(this._doc,0,0))}else{e.append(new au(this._doc,this.boxSelectionBar,this.boxSelectionWidth));const t=this.boxSelectionWidth;this.boxSelectionX0=Math.max(0,this.boxSelectionX0-t),this.boxSelectionX1=Math.max(0,this.boxSelectionX1-t)}this._doc.record(e)}deleteChannel(){this._doc.record(new lu(this._doc,this.boxSelectionChannel,this.boxSelectionChannel+this.boxSelectionHeight-1)),this.boxSelectionY0=this.boxSelectionY1=this._doc.channel,Q.resetColors()}*_eachSelectedChannel(){for(let e=this.boxSelectionChannel;e<this.boxSelectionChannel+this.boxSelectionHeight;e++)yield e}*_eachSelectedBar(){for(let e=this.boxSelectionBar;e<this.boxSelectionBar+this.boxSelectionWidth;e++)yield e}*_eachSelectedPattern(e){const t={};for(const n of this._eachSelectedBar()){const i=this._doc.song.channels[e].bars[n];if(i==0||t[String(i)])continue;t[String(i)]=!0;const s=this._doc.song.getPattern(e,n);if(s==null)throw new Error;yield s}}_parseCopiedInstrumentArray(e,t){const n=Array.from(e.instruments).map(i=>i>>>0);return Yo(n,this._doc.song,t),n}_patternIndexIsUnused(e,t){for(let n=0;n<this._doc.song.barCount;n++)if(this._doc.song.channels[e].bars[n]==t)return!1;return!0}copy(){const e=[];for(const n of this._eachSelectedChannel()){const i={},s=[];for(const d of this._eachSelectedBar()){const c=this._doc.song.channels[n].bars[d];if(s.push(c),i[String(c)]==null){const _=this._doc.song.getPattern(n,d);let m=this._doc.recentPatternInstruments[n],g=[];if(_!=null)if(m=_.instruments.concat(),this.patternSelectionActive)for(const S of _.cloneNotes())S.end<=this.patternSelectionStart||S.start>=this.patternSelectionEnd||(S.start-=this.patternSelectionStart,S.end-=this.patternSelectionStart,(S.start<0||S.end>this.patternSelectionEnd-this.patternSelectionStart)&&new ss(null,S,Math.max(S.start,0),Math.min(this.patternSelectionEnd-this.patternSelectionStart,S.end)),g.push(S));else g=_.notes;i[String(c)]={instruments:m,notes:g}}}const h={isNoise:this._doc.song.getChannelIsNoise(n),isMod:this._doc.song.getChannelIsMod(n),patterns:i,bars:s};e.push(h)}const t={partDuration:this.patternSelectionActive?this.patternSelectionEnd-this.patternSelectionStart:this._doc.song.beatsPerBar*w.partsPerBeat,channels:e};window.localStorage.setItem("selectionCopy",JSON.stringify(t)),new Fn(this._doc,0,0)}pasteNotes(){const e=JSON.parse(String(window.localStorage.getItem("selectionCopy")));if(e==null)return;const t=e.channels||[],n=e.partDuration>>>0,i=new Zt,s=this.boxSelectionWidth>1||this.boxSelectionHeight>1,h=s?this.boxSelectionHeight:Math.min(t.length,this._doc.song.getChannelCount()-this.boxSelectionChannel);for(let d=0;d<h;d++){const c=t[d%t.length],_=this.boxSelectionChannel+d,m=!!c.isNoise,g=!!c.isMod,S=c.patterns||{},E=c.bars||[];if(E.length==0||m!=this._doc.song.getChannelIsNoise(_)||g!=this._doc.song.getChannelIsMod(_))continue;const A=s?this.boxSelectionWidth:Math.min(E.length,this._doc.song.barCount-this.boxSelectionBar);if(!s&&E.length==1&&t.length==1){const C=E[0]>>>0,k=this.boxSelectionBar,T=this._doc.song.channels[_].bars[k];if(C==0&&T==0)continue;const b=S[String(C)],R=this._parseCopiedInstrumentArray(b,_);if(T==0){const f=this._doc.song.channels[_].patterns[C-1];f!=null&&!this.patternSelectionActive&&(oh(b.notes,f.notes)&&Ta(R,f.instruments)||this._patternIndexIsUnused(_,C))?i.append(new Xi(this._doc,C,k,_,1,1)):i.append(new ur(this._doc,_,k))}const V=this._doc.song.getPattern(_,k);if(V==null)throw new Error;i.append(new Pa(this._doc,V,b.notes,this.patternSelectionActive?this.patternSelectionStart:0,this.patternSelectionActive?this.patternSelectionEnd:w.partsPerBeat*this._doc.song.beatsPerBar,n)),(T==0||b.notes.length==0||_>=this._doc.song.pitchChannelCount+this._doc.song.noiseChannelCount)&&(this.selectInstrument(R[0]),i.append(new vo(this._doc,_,R,V)))}else if(this.patternSelectionActive){const C={},k={};i.append(new er(this._doc,this.boxSelectionBar,A,this.boxSelectionChannel,h));for(let T=0;T<A;T++){const b=this.boxSelectionBar+T,R=E[T%E.length]>>>0,V=this._doc.song.channels[_].bars[b],f=[R,V].join(",");if(R==0&&V==0)continue;if(C[f]!=null){i.append(new Xi(this._doc,C[f],b,_,1,1));continue}if(V==0){i.append(new ur(this._doc,_,b));const l=S[String(R)],W=this._parseCopiedInstrumentArray(l,_),L=this._doc.song.getPattern(_,b);i.append(new vo(this._doc,_,W,L))}else{const l=this._doc.song.getPattern(_,b);if(l==null)throw new Error;if(!k[String(V)])k[String(V)]=!0;else{i.append(new Xi(this._doc,0,b,_,1,1)),i.append(new ur(this._doc,_,b));const W=this._doc.song.getPattern(_,b);if(W==null)throw new Error;for(const L of l.cloneNotes())i.append(new yi(this._doc,W,L,W.notes.length,!1))}}const D=this._doc.song.getPattern(_,b);if(D==null)throw new Error;if(R==0)i.append(new _s(this._doc,D,this.patternSelectionStart,this.patternSelectionEnd));else{const l=S[String(R)];i.append(new Pa(this._doc,D,l.notes,this.patternSelectionStart,this.patternSelectionEnd,n))}C[f]=this._doc.song.channels[_].bars[b]}}else{for(let k=0;k<A;k++)this.erasePatternInBar(i,_,this.boxSelectionBar+k);const C={};for(let k=0;k<A;k++){const T=this.boxSelectionBar+k,b=E[k%E.length]>>>0,R=String(b);if(b==0)continue;if(C[R]!=null){i.append(new Xi(this._doc,C[R],T,_,1,1));continue}const V=S[String(b)],f=this._parseCopiedInstrumentArray(V,_),D=this._doc.song.channels[_].patterns[b-1];if(D!=null&&n==w.partsPerBeat*this._doc.song.beatsPerBar&&oh(V.notes,D.notes)&&Ta(f,D.instruments))i.append(new Xi(this._doc,b,T,_,1,1));else{D!=null&&this._patternIndexIsUnused(_,b)?i.append(new Xi(this._doc,b,T,_,1,1)):i.append(new ur(this._doc,_,T));const l=this._doc.song.getPattern(_,T);if(l==null)throw new Error;i.append(new Pa(this._doc,l,V.notes,this.patternSelectionActive?this.patternSelectionStart:0,this.patternSelectionActive?this.patternSelectionEnd:w.partsPerBeat*this._doc.song.beatsPerBar,n)),i.append(new vo(this._doc,_,f,l))}C[R]=this._doc.song.channels[_].bars[T]}}}this._doc.record(i)}erasePatternInBar(e,t,n){const i=this._doc.song.channels[t].bars[n];i!=0&&(e.append(new Xi(this._doc,0,n,t,1,1)),this._patternIndexIsUnused(t,i)&&(this._doc.song.channels[t].patterns[i-1].notes.length=0))}pasteNumbers(){const e=JSON.parse(String(window.localStorage.getItem("selectionCopy")));if(e==null)return;const t=e.channels||[],n=new Zt,i=this.boxSelectionActive,s=i?this.boxSelectionHeight:Math.min(t.length,this._doc.song.getChannelCount()-this.boxSelectionChannel);for(let h=0;h<s;h++){const d=t[h%t.length],c=this.boxSelectionChannel+h,_=d.bars||[];if(_.length==0)continue;const m=i?this.boxSelectionWidth:Math.min(_.length,this._doc.song.barCount-this.boxSelectionBar);for(let g=0;g<m;g++){const S=_[g%_.length]>>>0,E=this.boxSelectionBar+g;S>this._doc.song.patternsPerChannel&&n.append(new Aa(this._doc,S)),n.append(new Xi(this._doc,S,E,c,1,1))}}this._doc.record(n)}selectAll(){new Fn(this._doc,0,0),this.boxSelectionBar==0&&this.boxSelectionChannel==0&&this.boxSelectionWidth==this._doc.song.barCount&&this.boxSelectionHeight==this._doc.song.getChannelCount()?this.setTrackSelection(this._doc.bar,this._doc.bar,this._doc.channel,this._doc.channel):this.setTrackSelection(0,this._doc.song.barCount-1,0,this._doc.song.getChannelCount()-1),this.selectionUpdated()}selectChannel(){new Fn(this._doc,0,0),this.boxSelectionBar==0&&this.boxSelectionWidth==this._doc.song.barCount?this.setTrackSelection(this._doc.bar,this._doc.bar,this.boxSelectionY0,this.boxSelectionY1):this.setTrackSelection(0,this._doc.song.barCount-1,this.boxSelectionY0,this.boxSelectionY1),this.selectionUpdated()}duplicatePatterns(){this._doc.record(new er(this._doc,this.boxSelectionBar,this.boxSelectionWidth,this.boxSelectionChannel,this.boxSelectionHeight))}muteChannels(e){if(e){let t=!1;for(let n=0;n<this._doc.song.channels.length;n++)if(this._doc.song.channels[n].muted){t=!0;break}for(let n=0;n<this._doc.song.channels.length;n++)this._doc.song.channels[n].muted=!t}else{let t=!1;for(const n of this._eachSelectedChannel())if(!this._doc.song.channels[n].muted){t=!0;break}for(const n of this._eachSelectedChannel())this._doc.song.channels[n].muted=t}this._doc.notifier.changed()}soloChannels(e){let t=!0;if(this.boxSelectionChannel>=this._doc.song.pitchChannelCount+this._doc.song.noiseChannelCount){const n=this._doc.song.channels[this.boxSelectionChannel],i=n.bars[this._doc.bar]-1,s=i>=0?n.instruments[n.patterns[i].instruments[0]]:n.instruments[this._doc.viewedInstrument[this.boxSelectionChannel]],h=[];let d=!e;for(let c=0;c<this._doc.song.pitchChannelCount+this._doc.song.noiseChannelCount;c++){h[c]=!1;for(let _=0;_<w.modCount;_++)s.modChannels[_]==c&&(h[c]=!0)}for(let c=0;c<this._doc.song.pitchChannelCount+this._doc.song.noiseChannelCount;c++)if(this._doc.song.channels[c].muted==h[c]){d=e;break}for(let c=0;c<this._doc.song.pitchChannelCount+this._doc.song.noiseChannelCount;c++)d?this._doc.song.channels[c].muted=!1:this._doc.song.channels[c].muted=!h[c]}else{for(let n=0;n<this._doc.song.pitchChannelCount+this._doc.song.noiseChannelCount;n++){const i=n<this.boxSelectionChannel||n>=this.boxSelectionChannel+this.boxSelectionHeight?!e:e;if(this._doc.song.channels[n].muted!=i){t=!1;break}}if(t)for(let n=0;n<this._doc.song.channels.length;n++)this._doc.song.channels[n].muted=!1;else for(let n=0;n<this._doc.song.pitchChannelCount+this._doc.song.noiseChannelCount;n++)this._doc.song.channels[n].muted=n<this.boxSelectionChannel||n>=this.boxSelectionChannel+this.boxSelectionHeight?!e:e}this._doc.notifier.changed()}forceRhythm(){const e=new Zt;this.boxSelectionActive&&e.append(new er(this._doc,this.boxSelectionBar,this.boxSelectionWidth,this.boxSelectionChannel,this.boxSelectionHeight));for(const t of this._eachSelectedChannel())for(const n of this._eachSelectedPattern(t))e.append(new tp(this._doc,n));this._doc.record(e)}forceScale(){const e=new Zt;this.boxSelectionActive&&e.append(new er(this._doc,this.boxSelectionBar,this.boxSelectionWidth,this.boxSelectionChannel,this.boxSelectionHeight));const t=[!0,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1];for(const i of this._eachSelectedChannel())if(!(this._doc.song.getChannelIsNoise(i)||this._doc.song.getChannelIsMod(i)))for(const s of this._eachSelectedPattern(i))rf(s,t);const n=of(t,this._doc.song.scale);for(const i of this._eachSelectedChannel())if(!(this._doc.song.getChannelIsNoise(i)||this._doc.song.getChannelIsMod(i)))for(const s of this._eachSelectedPattern(i))e.append(new up(this._doc,s,n));this._doc.record(e)}setTrackSelection(e,t,n,i){this._changeTrack=new Zt,this._changeTrack.append(new cp(this._doc,e,t,n,i)),this._doc.record(this._changeTrack,!0)}transpose(e,t){const n=this._doc.lastChangeWas(this._changeTranspose);this._changeTranspose=new Zt,this.boxSelectionActive&&this._changeTranspose.append(new er(this._doc,this.boxSelectionBar,this.boxSelectionWidth,this.boxSelectionChannel,this.boxSelectionHeight));for(const i of this._eachSelectedChannel())if(!(i>=this._doc.song.pitchChannelCount+this._doc.song.noiseChannelCount))for(const s of this._eachSelectedPattern(i))this._changeTranspose.append(new _u(this._doc,i,s,e,this._doc.prefs.notesOutsideScale,t));this._doc.record(this._changeTranspose,n)}swapChannels(e){const t=[this._doc.song.pitchChannelCount,this._doc.song.pitchChannelCount+this._doc.song.noiseChannelCount,this._doc.song.pitchChannelCount+this._doc.song.noiseChannelCount+this._doc.song.modChannelCount,this._doc.song.getChannelCount()];let n=0,i=0;for(const d of t){if(this.boxSelectionChannel<d&&e<0||this.boxSelectionChannel+this.boxSelectionHeight<=d){i=d-1;break}n=d}const s=Math.max(this.boxSelectionChannel,n),h=Math.min(this.boxSelectionChannel+this.boxSelectionHeight-1,i);if(e=Math.max(e,n-s),e=Math.min(e,i-h),e!=0){const d=this._doc.lastChangeWas(this._changeReorder);this._changeReorder=new Zt,this.boxSelectionY0=s+e,this.boxSelectionY1=h+e,this._changeReorder.append(new Ia(this._doc,s,h,e)),this._changeReorder.append(new _r(this._doc,Math.max(this.boxSelectionY0,Math.min(this.boxSelectionY1,this._doc.channel+e)),this._doc.bar)),this.selectionUpdated(),this._doc.record(this._changeReorder,d)}}selectInstrument(e){if(this._doc.viewedInstrument[this._doc.channel]==e){if(this._doc.song.layeredInstruments&&this._doc.song.patternInstruments&&this._doc.channel<this._doc.song.pitchChannelCount+this._doc.song.noiseChannelCount){const t=this._doc.lastChangeWas(this._changeInstrument);this._changeInstrument=new Zt;const n=this._doc.recentPatternInstruments[this._doc.channel];if(n.indexOf(e)==-1){n.push(e);const i=this._doc.song.getMaxInstrumentsPerPattern(this._doc.channel);n.length>i&&n.splice(0,n.length-i)}else n.splice(n.indexOf(e),1),n.length==0&&(n[0]=0);this.boxSelectionActive&&this._changeInstrument.append(new er(this._doc,this.boxSelectionBar,this.boxSelectionWidth,this.boxSelectionChannel,this.boxSelectionHeight));for(const i of this._eachSelectedChannel())for(const s of this._eachSelectedPattern(i))this._changeInstrument.append(new vo(this._doc,i,n,s));this._changeInstrument.isNoop()||this._doc.record(this._changeInstrument,t)}}else{const t=this._doc.lastChangeWas(this._changeInstrument);if(this._changeInstrument=new Zt,this._changeInstrument.append(new jf(this._doc,e)),!(this._doc.song.layeredInstruments&&this._doc.channel<this._doc.song.pitchChannelCount+this._doc.song.noiseChannelCount)&&this._doc.song.patternInstruments){this.boxSelectionActive&&this._changeInstrument.append(new er(this._doc,this.boxSelectionBar,this.boxSelectionWidth,this.boxSelectionChannel,this.boxSelectionHeight));const n=[e];for(const i of this._eachSelectedChannel())for(const s of this._eachSelectedPattern(i))this._changeInstrument.append(new vo(this._doc,i,n,s));this._doc.record(this._changeInstrument,t)}else this._doc.hasRedoHistory()||this._doc.record(this._changeInstrument,t)}}resetBoxSelection(){this.boxSelectionX0=this.boxSelectionX1=this._doc.bar,this.boxSelectionY0=this.boxSelectionY1=this._doc.channel}}const Do=class Do{constructor(){a(this,"autoPlay",!1);a(this,"autoFollow",!1);a(this,"enableNotePreview",!1);a(this,"showFifth",!1);a(this,"notesOutsideScale",!1);a(this,"defaultScale",1);a(this,"showLetters",!1);a(this,"showChannels",!1);a(this,"showScrollBar",!1);a(this,"alwaysFineNoteVol",!1);a(this,"displayVolumeBar",!1);a(this,"instrumentCopyPaste",!1);a(this,"enableChannelMuting",!1);a(this,"colorTheme","");a(this,"layout","");a(this,"displayBrowserUrl",!1);a(this,"volume",75);a(this,"visibleOctaves",Do.defaultVisibleOctaves);a(this,"pressControlForShortcuts",!1);a(this,"keyboardLayout","");a(this,"enableMidi",!1);a(this,"showRecordButton",!1);a(this,"snapRecordedNotesToRhythm",!1);a(this,"ignorePerformedNotesNotInScale",!1);a(this,"metronomeCountIn",!1);a(this,"metronomeWhileRecording",!1);this.reload()}reload(){this.autoPlay=window.localStorage.getItem("autoPlay")=="true",this.autoFollow=window.localStorage.getItem("autoFollow")!="false",this.enableNotePreview=window.localStorage.getItem("enableNotePreview")!="false",this.showFifth=window.localStorage.getItem("showFifth")=="true",this.notesOutsideScale=window.localStorage.getItem("notesOutsideScale")=="true",this.showLetters=window.localStorage.getItem("showLetters")=="true",this.showChannels=window.localStorage.getItem("showChannels")=="true",this.showScrollBar=window.localStorage.getItem("showScrollBar")=="true",this.alwaysFineNoteVol=window.localStorage.getItem("alwaysFineNoteVol")=="true",this.displayVolumeBar=window.localStorage.getItem("displayVolumeBar")=="true",this.instrumentCopyPaste=window.localStorage.getItem("instrumentCopyPaste")=="true",this.enableChannelMuting=window.localStorage.getItem("enableChannelMuting")=="true",this.displayBrowserUrl=window.localStorage.getItem("displayBrowserUrl")!="false",this.pressControlForShortcuts=window.localStorage.getItem("pressControlForShortcuts")=="true",this.enableMidi=window.localStorage.getItem("enableMidi")!="false",this.showRecordButton=window.localStorage.getItem("showRecordButton")=="true",this.snapRecordedNotesToRhythm=window.localStorage.getItem("snapRecordedNotesToRhythm")=="true",this.ignorePerformedNotesNotInScale=window.localStorage.getItem("ignorePerformedNotesNotInScale")=="true",this.metronomeCountIn=window.localStorage.getItem("metronomeCountIn")!="false",this.metronomeWhileRecording=window.localStorage.getItem("metronomeWhileRecording")!="false",this.keyboardLayout=window.localStorage.getItem("keyboardLayout")||"wickiHayden",this.layout=window.localStorage.getItem("layout")||"small",this.colorTheme=window.localStorage.getItem("colorTheme")||"dark classic",this.visibleOctaves=window.localStorage.getItem("visibleOctaves")>>>0||Do.defaultVisibleOctaves;const e=w.scales.dictionary[window.localStorage.getItem("defaultScale")];this.defaultScale=e!=null?e.index:0,window.localStorage.getItem("volume")!=null&&(this.volume=Math.min(window.localStorage.getItem("volume")>>>0,75)),window.localStorage.getItem("fullScreen")!=null&&(window.localStorage.getItem("fullScreen")=="true"&&(this.layout="long"),window.localStorage.removeItem("fullScreen"))}save(){window.localStorage.setItem("autoPlay",this.autoPlay?"true":"false"),window.localStorage.setItem("autoFollow",this.autoFollow?"true":"false"),window.localStorage.setItem("enableNotePreview",this.enableNotePreview?"true":"false"),window.localStorage.setItem("showFifth",this.showFifth?"true":"false"),window.localStorage.setItem("notesOutsideScale",this.notesOutsideScale?"true":"false"),window.localStorage.setItem("defaultScale",w.scales[this.defaultScale].name),window.localStorage.setItem("showLetters",this.showLetters?"true":"false"),window.localStorage.setItem("showChannels",this.showChannels?"true":"false"),window.localStorage.setItem("showScrollBar",this.showScrollBar?"true":"false"),window.localStorage.setItem("alwaysFineNoteVol",this.alwaysFineNoteVol?"true":"false"),window.localStorage.setItem("displayVolumeBar",this.displayVolumeBar?"true":"false"),window.localStorage.setItem("enableChannelMuting",this.enableChannelMuting?"true":"false"),window.localStorage.setItem("instrumentCopyPaste",this.instrumentCopyPaste?"true":"false"),window.localStorage.setItem("displayBrowserUrl",this.displayBrowserUrl?"true":"false"),window.localStorage.setItem("pressControlForShortcuts",this.pressControlForShortcuts?"true":"false"),window.localStorage.setItem("enableMidi",this.enableMidi?"true":"false"),window.localStorage.setItem("showRecordButton",this.showRecordButton?"true":"false"),window.localStorage.setItem("snapRecordedNotesToRhythm",this.snapRecordedNotesToRhythm?"true":"false"),window.localStorage.setItem("ignorePerformedNotesNotInScale",this.ignorePerformedNotesNotInScale?"true":"false"),window.localStorage.setItem("metronomeCountIn",this.metronomeCountIn?"true":"false"),window.localStorage.setItem("metronomeWhileRecording",this.metronomeWhileRecording?"true":"false"),window.localStorage.setItem("keyboardLayout",this.keyboardLayout),window.localStorage.setItem("layout",this.layout),window.localStorage.setItem("colorTheme",this.colorTheme),window.localStorage.setItem("volume",String(this.volume)),window.localStorage.setItem("visibleOctaves",String(this.visibleOctaves))}};a(Do,"defaultVisibleOctaves",3);let Fa=Do;class __{constructor(){a(this,"_watchers",[]);a(this,"_dirty",!1)}watch(e){this._watchers.indexOf(e)==-1&&this._watchers.push(e)}unwatch(e){const t=this._watchers.indexOf(e);t!=-1&&this._watchers.splice(t,1)}changed(){this._dirty=!0}notifyWatchers(){if(this._dirty){this._dirty=!1;for(const e of this._watchers.concat())e()}}}const dr=class dr{constructor(){a(this,"song");a(this,"synth");a(this,"performance");a(this,"notifier",new __);a(this,"selection",new p_(this));a(this,"prefs",new Fa);a(this,"channel",0);a(this,"muteEditorChannel",0);a(this,"bar",0);a(this,"recalcChannelNames",!1);a(this,"recentPatternInstruments",[]);a(this,"viewedInstrument",[]);a(this,"trackVisibleBars",16);a(this,"trackVisibleChannels",4);a(this,"barScrollPos",0);a(this,"channelScrollPos",0);a(this,"prompt",null);a(this,"addedEffect",!1);a(this,"addedEnvelope",!1);a(this,"currentPatternIsDirty",!1);a(this,"_recovery",new Ya);a(this,"_recoveryUid");a(this,"_recentChange",null);a(this,"_sequenceNumber",0);a(this,"_lastSequenceNumber",0);a(this,"_stateShouldBePushed",!1);a(this,"_recordedNewSong",!1);a(this,"_waitingToUpdateState",!1);a(this,"_whenHistoryStateChanged",()=>{if(this.synth.recording&&this.performance.abortRecording(),window.history.state==null&&window.location.hash!=""){this._sequenceNumber++,this._resetSongRecoveryUid();const t={canUndo:!0,sequenceNumber:this._sequenceNumber,bar:this.bar,channel:this.channel,instrument:this.viewedInstrument[this.channel],recoveryUid:this._recoveryUid,prompt:null,selection:this.selection.toJSON()};new Ra(this,window.location.hash),this.prompt=t.prompt,this.prefs.displayBrowserUrl?this._replaceState(t,this.song.toBase64String()):this._pushState(t,this.song.toBase64String()),this.forgetLastChange(),this.notifier.notifyWatchers(),this.synth.pause(),this.synth.goToBar(0);return}const e=this._getHistoryState();if(e==null)throw new Error("History state is null.");e.sequenceNumber!=this._sequenceNumber&&(this.bar=e.bar,this.channel=e.channel,this.viewedInstrument[this.channel]=e.instrument,this._sequenceNumber=e.sequenceNumber,this.prompt=e.prompt,new Ra(this,this._getHash()),this._recoveryUid=e.recoveryUid,this.selection.fromJSON(e.selection),this.forgetLastChange(),this.notifier.notifyWatchers())});a(this,"_cleanDocument",()=>{this.notifier.notifyWatchers()});a(this,"_validateDocState",()=>{const e=this.song.getChannelCount();for(let n=this.recentPatternInstruments.length;n<e;n++)this.recentPatternInstruments[n]=[0];this.recentPatternInstruments.length=e;for(let n=0;n<e;n++){if(n==this.channel)if(this.song.patternInstruments){const i=this.song.getPattern(this.channel,this.bar);i!=null&&(this.recentPatternInstruments[n]=i.instruments.concat())}else{const i=this.song.channels[this.channel];for(let s=0;s<i.instruments.length;s++)this.recentPatternInstruments[n][s]=s;this.recentPatternInstruments[n].length=i.instruments.length}Yo(this.recentPatternInstruments[n],this.song,n)}for(let n=this.viewedInstrument.length;n<e;n++)this.viewedInstrument[n]=0;this.viewedInstrument.length=e;for(let n=0;n<e;n++){if(this.song.patternInstruments&&!this.song.layeredInstruments&&n==this.channel){const i=this.song.getPattern(this.channel,this.bar);i!=null&&(this.viewedInstrument[n]=i.instruments[0])}this.viewedInstrument[n]=Math.min(this.viewedInstrument[n]|0,this.song.channels[n].instruments.length-1)}const t=this.getCurrentPattern();t!=null&&this.song.patternInstruments&&(this.recentPatternInstruments[this.channel]=t.instruments.concat()),(!this.synth.playing&&(this.bar<this.selection.boxSelectionBar||this.selection.boxSelectionBar+this.selection.boxSelectionWidth<=this.bar)||this.channel<this.selection.boxSelectionChannel||this.selection.boxSelectionChannel+this.selection.boxSelectionHeight<=this.channel||this.song.barCount<this.selection.boxSelectionBar+this.selection.boxSelectionWidth||e<this.selection.boxSelectionChannel+this.selection.boxSelectionHeight||this.selection.boxSelectionWidth==1&&this.selection.boxSelectionHeight==1)&&this.selection.resetBoxSelection()});a(this,"_updateHistoryState",()=>{this._waitingToUpdateState=!1;let e;try{e=this.song.toBase64String()}catch{window.alert(`Whoops, the song data appears to have been corrupted! Please try to recover the last working version of the song from the "Recover Recent Song..." option in BeepBox's "File" menu.`);return}this._stateShouldBePushed&&this._sequenceNumber++,this._recordedNewSong?this._resetSongRecoveryUid():this._recovery.saveVersion(this._recoveryUid,this.song.title,e);let t={canUndo:!0,sequenceNumber:this._sequenceNumber,bar:this.bar,channel:this.channel,instrument:this.viewedInstrument[this.channel],recoveryUid:this._recoveryUid,prompt:this.prompt,selection:this.selection.toJSON()};this._stateShouldBePushed?this._pushState(t,e):this._replaceState(t,e),this._stateShouldBePushed=!1,this._recordedNewSong=!1});this.notifier.watch(this._validateDocState),Q.setTheme(this.prefs.colorTheme),La.setLayout(this.prefs.layout),window.sessionStorage.getItem("currentUndoIndex")==null&&(window.sessionStorage.setItem("currentUndoIndex","0"),window.sessionStorage.setItem("oldestUndoIndex","0"),window.sessionStorage.setItem("newestUndoIndex","0"));let e=window.location.hash;e==""&&(e=this._getHash()),this.song=new tu(e),(e==""||e==null)&&(du(this.song),this.song.scale=this.prefs.defaultScale),e=this.song.toBase64String(),this.synth=new ms(this.song),this.synth.volume=this._calcVolume(),this.synth.anticipatePoorPerformance=za;let t=this._getHistoryState();t==null&&(t={canUndo:!1,sequenceNumber:0,bar:0,channel:0,instrument:0,recoveryUid:Pl(),prompt:null,selection:this.selection.toJSON()}),t.recoveryUid==null&&(t.recoveryUid=Pl()),this._replaceState(t,e),window.addEventListener("hashchange",this._whenHistoryStateChanged),window.addEventListener("popstate",this._whenHistoryStateChanged),this.bar=t.bar|0,this.channel=t.channel|0;for(let n=0;n<=this.channel;n++)this.viewedInstrument[n]=0;this.viewedInstrument[this.channel]=t.instrument|0,this._recoveryUid=t.recoveryUid,this.prompt=t.prompt,this.selection.fromJSON(t.selection);for(const n of["input","change","click","keyup","keydown","mousedown","mousemove","mouseup","touchstart","touchmove","touchend","touchcancel"])window.addEventListener(n,this._cleanDocument);this._validateDocState(),this.performance=new f_(this)}toggleDisplayBrowserUrl(){const e=this._getHistoryState();this.prefs.displayBrowserUrl=!this.prefs.displayBrowserUrl,this._replaceState(e,this.song.toBase64String())}_getHistoryState(){if(this.prefs.displayBrowserUrl)return window.history.state;{const e=JSON.parse(window.sessionStorage.getItem(window.sessionStorage.getItem("currentUndoIndex")));return e==null?null:e.state}}_getHash(){if(this.prefs.displayBrowserUrl)return window.location.hash;{const e=JSON.parse(window.sessionStorage.getItem(window.sessionStorage.getItem("currentUndoIndex")));return e==null?"":e.hash}}_replaceState(e,t){this.prefs.displayBrowserUrl?window.history.replaceState(e,"","#"+t):(window.sessionStorage.setItem(window.sessionStorage.getItem("currentUndoIndex")||"0",JSON.stringify({state:e,hash:t})),window.history.replaceState(null,"",location.pathname))}_pushState(e,t){if(this.prefs.displayBrowserUrl)window.history.pushState(e,"","#"+t);else{let n=Number(window.sessionStorage.getItem("currentUndoIndex")),i=Number(window.sessionStorage.getItem("oldestUndoIndex"));n=(n+1)%dr._maximumUndoHistory,window.sessionStorage.setItem("currentUndoIndex",String(n)),window.sessionStorage.setItem("newestUndoIndex",String(n)),n==i&&(i=(i+1)%dr._maximumUndoHistory,window.sessionStorage.setItem("oldestUndoIndex",String(i))),window.sessionStorage.setItem(String(n),JSON.stringify({state:e,hash:t})),window.history.replaceState(null,"",location.pathname)}this._lastSequenceNumber=e.sequenceNumber}hasRedoHistory(){return this._lastSequenceNumber>this._sequenceNumber}_forward(){if(this.prefs.displayBrowserUrl)window.history.forward();else{let e=Number(window.sessionStorage.getItem("currentUndoIndex")),t=Number(window.sessionStorage.getItem("newestUndoIndex"));e!=t&&(e=(e+1)%dr._maximumUndoHistory,window.sessionStorage.setItem("currentUndoIndex",String(e)),setTimeout(this._whenHistoryStateChanged))}}_back(){if(this.prefs.displayBrowserUrl)window.history.back();else{let e=Number(window.sessionStorage.getItem("currentUndoIndex")),t=Number(window.sessionStorage.getItem("oldestUndoIndex"));e!=t&&(e=(e+dr._maximumUndoHistory-1)%dr._maximumUndoHistory,window.sessionStorage.setItem("currentUndoIndex",String(e)),setTimeout(this._whenHistoryStateChanged))}}record(e,t=!1,n=!1){e.isNoop()?(this._recentChange=null,t&&this._back()):(e.commit(),this._recentChange=e,this._stateShouldBePushed=this._stateShouldBePushed||!t,this._recordedNewSong=this._recordedNewSong||n,this._waitingToUpdateState||(window.requestAnimationFrame(this._updateHistoryState),this._waitingToUpdateState=!0))}_resetSongRecoveryUid(){this._recoveryUid=Pl()}openPrompt(e){this.prompt=e;const t=this.song.toBase64String();this._sequenceNumber++;const n={canUndo:!0,sequenceNumber:this._sequenceNumber,bar:this.bar,channel:this.channel,instrument:this.viewedInstrument[this.channel],recoveryUid:this._recoveryUid,prompt:this.prompt,selection:this.selection.toJSON()};this._pushState(n,t)}undo(){this._getHistoryState().canUndo&&this._back()}redo(){this._forward()}setProspectiveChange(e){this._recentChange=e}forgetLastChange(){this._recentChange=null}lastChangeWas(e){return e!=null&&e==this._recentChange}goBackToStart(){this.bar=0,this.channel=0,this.barScrollPos=0,this.channelScrollPos=0,this.synth.snapToStart(),this.notifier.changed()}setVolume(e){this.prefs.volume=e,this.prefs.save(),this.synth.volume=this._calcVolume()}_calcVolume(){return Math.min(1,Math.pow(this.prefs.volume/50,.5))*Math.pow(2,(this.prefs.volume-75)/25)}getCurrentPattern(e=0){return this.song.getPattern(this.channel,this.bar+e)}getCurrentInstrument(e=0){if(e==0)return this.viewedInstrument[this.channel];{const t=this.getCurrentPattern(e);return t==null?0:t.instruments[0]}}getMobileLayout(){return this.prefs.layout=="wide"?window.innerWidth<=1e3:window.innerWidth<=710}getBarWidth(){return!this.getMobileLayout()&&this.prefs.enableChannelMuting&&(!this.getFullScreen()||this.prefs.layout=="wide")?30:32}getChannelHeight(){const e=this.getMobileLayout()||this.song.getChannelCount()>4||this.song.barCount>this.trackVisibleBars&&this.song.getChannelCount()>3;return!this.getMobileLayout()&&(this.prefs.layout!="wide"&&this.song.getChannelCount()>11||this.song.getChannelCount()>22)?23:e?27:32}getFullScreen(){return!this.getMobileLayout()&&this.prefs.layout!="small"}getVisibleOctaveCount(){return this.getFullScreen()?this.prefs.visibleOctaves:Fa.defaultVisibleOctaves}getVisiblePitchCount(){return this.getVisibleOctaveCount()*w.pitchesPerOctave+1}getBaseVisibleOctave(e){const t=this.getVisibleOctaveCount();return Math.max(0,Math.min(w.pitchOctaves-t,Math.ceil(this.song.channels[e].octave-t*.5)))}};a(dr,"_maximumUndoHistory",300);let ch=dr;const u=new ch;function m_(r){const e=r.cloneNode(!1);return r.parentNode.replaceChild(e,r),e}class kc{constructor(){a(this,"valid",!1);a(this,"prevNote",null);a(this,"curNote",null);a(this,"nextNote",null);a(this,"pitch",0);a(this,"pitchIndex",-1);a(this,"curIndex",0);a(this,"start",0);a(this,"end",0);a(this,"part",0);a(this,"exactPart",0);a(this,"nearPinIndex",0);a(this,"pins",[])}}class El{constructor(e,t){a(this,"controlMode",!1);a(this,"shiftMode",!1);a(this,"_svgNoteBackground");a(this,"_svgDrumBackground");a(this,"_svgModBackground");a(this,"_svgBackground");a(this,"_svgNoteContainer",me.svg());a(this,"_svgPlayhead",me.rect({x:"0",y:"0",width:"4",fill:Q.playhead,"pointer-events":"none"}));a(this,"_selectionRect",me.rect({class:"dashed-line dash-move",fill:Q.boxSelectionFill,stroke:Q.hoverPreview,"stroke-width":2,"stroke-dasharray":"5, 3","fill-opacity":"0.4","pointer-events":"none",visibility:"hidden"}));a(this,"_svgPreview",me.path({fill:"none",stroke:Q.hoverPreview,"stroke-width":"2","pointer-events":"none"}));a(this,"modDragValueLabel",Ke.div({width:"90","text-anchor":"start",contenteditable:"true",style:"display: flex, justify-content: center; align-items:center; position:absolute; pointer-events: none;","dominant-baseline":"central"}));a(this,"_svg");a(this,"container");a(this,"_defaultModBorder",34);a(this,"_backgroundPitchRows",[]);a(this,"_backgroundDrumRow",me.rect());a(this,"_backgroundModRow",me.rect());a(this,"_editorWidth",0);a(this,"_modDragValueLabelLeft",0);a(this,"_modDragValueLabelTop",0);a(this,"_modDragValueLabelWidth",0);a(this,"editingModLabel",!1);a(this,"_modDragStartValue",0);a(this,"_modDragPin",null);a(this,"_modDragNote",null);a(this,"_modDragSetting",0);a(this,"_modDragLowerBound",0);a(this,"_modDragUpperBound",6);a(this,"_editorHeight",0);a(this,"_partWidth",0);a(this,"_pitchHeight",-1);a(this,"_pitchBorder",0);a(this,"_pitchCount",0);a(this,"_mouseX",0);a(this,"_mouseY",0);a(this,"_mouseDown",!1);a(this,"_mouseOver",!1);a(this,"_mouseDragging",!1);a(this,"_mouseHorizontal",!1);a(this,"_usingTouch",!1);a(this,"_copiedPinChannels",[]);a(this,"_copiedPins",[]);a(this,"_mouseXStart",0);a(this,"_mouseYStart",0);a(this,"_touchTime",0);a(this,"_shiftHeld",!1);a(this,"_dragConfirmed",!1);a(this,"_draggingStartOfSelection",!1);a(this,"_draggingEndOfSelection",!1);a(this,"_draggingSelectionContents",!1);a(this,"_dragTime",0);a(this,"_dragPitch",0);a(this,"_dragSize",0);a(this,"_dragVisible",!1);a(this,"_dragChange",null);a(this,"_changePatternSelection",null);a(this,"_lastChangeWasPatternSelection",!1);a(this,"_cursor",new kc);a(this,"_stashCursorPinVols",[]);a(this,"_pattern",null);a(this,"_playheadX",0);a(this,"_octaveOffset",0);a(this,"_renderedWidth",-1);a(this,"_renderedHeight",-1);a(this,"_renderedBeatWidth",-1);a(this,"_renderedPitchHeight",-1);a(this,"_renderedFifths",!1);a(this,"_renderedDrums",!1);a(this,"_renderedMod",!1);a(this,"_renderedRhythm",-1);a(this,"_renderedPitchChannelCount",-1);a(this,"_renderedNoiseChannelCount",-1);a(this,"_renderedModChannelCount",-1);a(this,"_followPlayheadBar",-1);a(this,"_barOffset");a(this,"_validateModDragLabelInput",e=>{const t=e.target;let n=Number(t.innerText);if(!(!isNaN(n)&&n>=0&&n<this._modDragLowerBound)&&!(this._modDragPin==null||this._modDragNote==null)&&t.innerText!=""&&t.innerText!="-"){isNaN(n)&&(n=this._modDragLowerBound,t.innerText=""+this._modDragLowerBound);let i=Math.floor(Math.max(Number(this._modDragLowerBound),Math.min(Number(this._modDragUpperBound),n)));t.innerText!=i+""&&(t.innerText=i+"");let s=+(i>=10)+ +(i>=100)+ +(i<0)+ +(i<=-10);this._modDragValueLabelLeft=+Le(Math.max(Math.min(this._editorWidth-10-s*8,this._partWidth*(this._modDragNote.start+this._modDragPin.time)-4-s*4),2)),this.modDragValueLabel.style.setProperty("left",""+this._modDragValueLabelLeft+"px");const h=new Zn;this._dragChange=h,u.setProspectiveChange(this._dragChange),h.append(new xr(u,this._modDragNote,this._modDragPin.time,i-w.modulators[this._modDragSetting].convertRealFactor,this._modDragPin.interval,this.shiftMode))}});a(this,"resetCopiedPins",()=>{const e=this._getMaxDivision();let t=u.song.getVolumeCap(!1);this._copiedPinChannels.length=u.song.getChannelCount(),this._stashCursorPinVols.length=u.song.getChannelCount();for(let n=0;n<u.song.pitchChannelCount;n++)this._copiedPinChannels[n]=[Nt(0,0,t),Nt(0,e,t)],this._stashCursorPinVols[n]=[t,t];for(let n=u.song.pitchChannelCount;n<u.song.pitchChannelCount+u.song.noiseChannelCount;n++)this._copiedPinChannels[n]=[Nt(0,0,t),Nt(0,e,0)],this._stashCursorPinVols[n]=[t,0];for(let n=u.song.pitchChannelCount+u.song.noiseChannelCount;n<u.song.getChannelCount();n++)this._copiedPinChannels[n]=[Nt(0,0,t),Nt(0,e,0)],this._stashCursorPinVols[n]=[t,0]});a(this,"_animatePlayhead",e=>{this._usingTouch&&!this.shiftMode&&!this._mouseDragging&&this._mouseDown&&performance.now()>this._touchTime+1e3&&this._cursor.valid&&u.lastChangeWas(this._dragChange)&&(this._dragChange.undo(),this._shiftHeld=!0,this._dragConfirmed=!1,this._whenCursorPressed(),u.notifier.notifyWatchers());const t=Math.floor(u.synth.playhead);if(u.synth.playing&&(this._pattern!=null&&u.song.getPattern(u.channel,Math.floor(u.synth.playhead))==this._pattern||Math.floor(u.synth.playhead)==u.bar+this._barOffset)){this._svgPlayhead.setAttribute("visibility","visible");const n=u.synth.playhead-t;Math.abs(n-this._playheadX)>.1?this._playheadX=n:this._playheadX+=(n-this._playheadX)*.2,this._svgPlayhead.setAttribute("x",""+Le(this._playheadX*this._editorWidth-2))}else this._svgPlayhead.setAttribute("visibility","hidden");u.synth.playing&&(u.synth.recording||u.prefs.autoFollow)&&this._followPlayheadBar!=t&&(new _r(u,u.channel,t),u.notifier.notifyWatchers()),this._followPlayheadBar=t,u.currentPatternIsDirty&&this._redrawNotePatterns(),window.requestAnimationFrame(this._animatePlayhead)});a(this,"_whenMouseOver",e=>{this._mouseOver||(this._mouseOver=!0,this._usingTouch=!1)});a(this,"_whenMouseOut",e=>{this._mouseOver&&(this._mouseOver=!1)});a(this,"_whenMousePressed",e=>{e.preventDefault();const t=this._svg.getBoundingClientRect();this._mouseX=((e.clientX||e.pageX)-t.left)*this._editorWidth/(t.right-t.left),this._mouseY=((e.clientY||e.pageY)-t.top)*this._editorHeight/(t.bottom-t.top),isNaN(this._mouseX)&&(this._mouseX=0),isNaN(this._mouseY)&&(this._mouseY=0),this._usingTouch=!1,this._shiftHeld=e.shiftKey,this._dragConfirmed=!1,this._whenCursorPressed()});a(this,"_whenTouchPressed",e=>{e.preventDefault();const t=this._svg.getBoundingClientRect();this._mouseX=(e.touches[0].clientX-t.left)*this._editorWidth/(t.right-t.left),this._mouseY=(e.touches[0].clientY-t.top)*this._editorHeight/(t.bottom-t.top),isNaN(this._mouseX)&&(this._mouseX=0),isNaN(this._mouseY)&&(this._mouseY=0),this._usingTouch=!0,this._shiftHeld=e.shiftKey,this._dragConfirmed=!1,this._touchTime=performance.now(),this._whenCursorPressed()});a(this,"_whenMouseMoved",e=>{this.controlMode=e.ctrlKey,this.shiftMode=e.shiftKey;const t=this._svg.getBoundingClientRect();this._mouseX=((e.clientX||e.pageX)-t.left)*this._editorWidth/(t.right-t.left),this._mouseY=((e.clientY||e.pageY)-t.top)*this._editorHeight/(t.bottom-t.top),isNaN(this._mouseX)&&(this._mouseX=0),isNaN(this._mouseY)&&(this._mouseY=0),this._usingTouch=!1,this._whenCursorMoved()});a(this,"_whenTouchMoved",e=>{if(!this._mouseDown)return;e.preventDefault();const t=this._svg.getBoundingClientRect();this._mouseX=(e.touches[0].clientX-t.left)*this._editorWidth/(t.right-t.left),this._mouseY=(e.touches[0].clientY-t.top)*this._editorHeight/(t.bottom-t.top),isNaN(this._mouseX)&&(this._mouseX=0),isNaN(this._mouseY)&&(this._mouseY=0),this._whenCursorMoved()});a(this,"_whenCursorReleased",e=>{if(!this._cursor.valid)return;const t=u.lastChangeWas(this._dragChange);if(this._mouseDown&&t&&this._dragChange!=null)if(this._draggingSelectionContents)u.record(this._dragChange),this._dragChange=null,this._pattern!=null&&u.song.getChannelIsMod(u.channel)&&this._pattern.notes.sort(function(n,i){return n.start==i.start?n.pitches[0]-i.pitches[0]:n.start-i.start});else if(this._draggingStartOfSelection||this._draggingEndOfSelection||this._shiftHeld)this._setPatternSelection(this._dragChange),this._dragChange=null;else if(this._mouseDragging||this._cursor.curNote==null||!this._dragChange.isNoop()||this._draggingStartOfSelection||this._draggingEndOfSelection||this._draggingSelectionContents||this._shiftHeld)u.record(this._dragChange),this._dragChange=null,this._pattern!=null&&u.song.getChannelIsMod(u.channel)&&this._pattern.notes.sort(function(n,i){return n.start==i.start?n.pitches[0]-i.pitches[0]:n.start-i.start});else{if(this._pattern==null)throw new Error;const n=new Zn;if(n.append(new Fn(u,0,0)),this._cursor.pitchIndex==-1){if(this._cursor.curNote.pitches.length==w.maxChordSize&&n.append(new bl(u,this._cursor.curNote,this._cursor.curNote.pitches[0],0,!0)),n.append(new bl(u,this._cursor.curNote,this._cursor.pitch,this._cursor.curNote.pitches.length)),this._copyPins(this._cursor.curNote),u.prefs.enableNotePreview&&!u.synth.playing){const i=Math.min(w.partsPerBeat,this._cursor.end-this._cursor.start);u.performance.setTemporaryPitches(this._cursor.curNote.pitches,i)}}else this._cursor.curNote.pitches.length==1?n.append(new yi(u,this._pattern,this._cursor.curNote,this._cursor.curIndex,!0)):n.append(new bl(u,this._cursor.curNote,this._cursor.pitch,this._cursor.curNote.pitches.indexOf(this._cursor.pitch),!0));u.record(n)}this._mouseDown=!1,this._mouseDragging=!1,this._draggingStartOfSelection=!1,this._draggingEndOfSelection=!1,this._draggingSelectionContents=!1,this._lastChangeWasPatternSelection=!1,this.modDragValueLabel.setAttribute("fill",Q.secondaryText),this._updateCursorStatus(),this._updatePreview()});this._interactive=e,this._barOffset=t,this._svgNoteBackground=me.pattern({id:"patternEditorNoteBackground"+this._barOffset,x:"0",y:"0",patternUnits:"userSpaceOnUse"}),this._svgDrumBackground=me.pattern({id:"patternEditorDrumBackground"+this._barOffset,x:"0",y:"0",patternUnits:"userSpaceOnUse"}),this._svgModBackground=me.pattern({id:"patternEditorModBackground"+this._barOffset,x:"0",y:"0",patternUnits:"userSpaceOnUse"}),this._svgBackground=me.rect({x:"0",y:"0","pointer-events":"none",fill:"url(#patternEditorNoteBackground"+this._barOffset+")"}),this._svg=me.svg({style:`background-color: ${Q.editorBackground}; touch-action: none; position: absolute;`,width:"100%",height:"100%"},me.defs(this._svgNoteBackground,this._svgDrumBackground,this._svgModBackground),this._svgBackground,this._selectionRect,this._svgNoteContainer,this._svgPreview,this._svgPlayhead),this.container=Ke.div({style:"height: 100%; overflow:hidden; position: relative; flex-grow: 1;"},this._svg,this.modDragValueLabel);for(let n=0;n<w.pitchesPerOctave;n++){const i=me.rect();i.setAttribute("x","1"),i.setAttribute("fill",n==0?Q.tonic:Q.pitchBackground),this._svgNoteBackground.appendChild(i),this._backgroundPitchRows[n]=i}this._backgroundDrumRow.setAttribute("x","1"),this._backgroundDrumRow.setAttribute("y","1"),this._backgroundDrumRow.setAttribute("fill",Q.pitchBackground),this._svgDrumBackground.appendChild(this._backgroundDrumRow),this._backgroundModRow.setAttribute("fill",Q.pitchBackground),this._svgModBackground.appendChild(this._backgroundModRow),this._interactive?(this._updateCursorStatus(),this._updatePreview(),window.requestAnimationFrame(this._animatePlayhead),this._svg.addEventListener("mousedown",this._whenMousePressed),document.addEventListener("mousemove",this._whenMouseMoved),document.addEventListener("mouseup",this._whenCursorReleased),this._svg.addEventListener("mouseover",this._whenMouseOver),this._svg.addEventListener("mouseout",this._whenMouseOut),this._svg.addEventListener("touchstart",this._whenTouchPressed),this._svg.addEventListener("touchmove",this._whenTouchMoved),this._svg.addEventListener("touchend",this._whenCursorReleased),this._svg.addEventListener("touchcancel",this._whenCursorReleased),this.modDragValueLabel.addEventListener("input",this._validateModDragLabelInput)):(this._svgPlayhead.style.display="none",this._svg.appendChild(me.rect({x:0,y:0,width:1e4,height:1e4,fill:Q.editorBackground,style:"opacity: 0.5;"}))),this.resetCopiedPins()}_getMaxDivision(){const e=w.rhythms[u.song.rhythm].stepsPerBeat;return e%4==0?w.partsPerBeat/2:e%3==0?w.partsPerBeat/3:e%2==0?w.partsPerBeat/2:w.partsPerBeat}_getMinDivision(){return w.partsPerBeat/w.rhythms[u.song.rhythm].stepsPerBeat}_snapToMinDivision(e){const t=this._getMinDivision();return Math.floor(e/t)*t}_updateCursorStatus(){if(this._cursor=new kc,this._mouseX<0||this._mouseX>this._editorWidth||this._mouseY<0||this._mouseY>this._editorHeight||this._pitchHeight<=0)return;const e=this._getMinDivision();this._cursor.exactPart=this._mouseX/this._partWidth,this._cursor.part=Math.floor(Math.max(0,Math.min(u.song.beatsPerBar*w.partsPerBeat-e,this._cursor.exactPart))/e)*e;let t=!1;if(this._pattern!=null){for(const i of this._pattern.notes)if(i.end<=this._cursor.exactPart)u.song.getChannelIsMod(u.channel)?(i.pitches[0]==Math.floor(this._findMousePitch(this._mouseY))&&(this._cursor.prevNote=i),t||this._cursor.curIndex++):(this._cursor.prevNote=i,this._cursor.curIndex++);else if(i.start<=this._cursor.exactPart&&i.end>this._cursor.exactPart)u.song.getChannelIsMod(u.channel)?i.pitches[0]==Math.floor(this._findMousePitch(this._mouseY))?(this._cursor.curNote=i,t=!0):(!t||this._cursor.curNote!=null&&i.start<this._cursor.curNote.start)&&this._cursor.curIndex++:this._cursor.curNote=i;else if(i.start>this._cursor.exactPart)if(u.song.getChannelIsMod(u.channel)){if(i.pitches[0]==Math.floor(this._findMousePitch(this._mouseY))){this._cursor.nextNote=i;break}}else{this._cursor.nextNote=i;break}if(u.song.getChannelIsMod(u.channel)&&!this.editingModLabel)if(this._pattern.notes[this._cursor.curIndex]!=null&&this._cursor.curNote!=null){let i=0;for(;this._cursor.curNote.start+this._cursor.curNote.pins[i].time<this._cursor.exactPart&&i<this._cursor.curNote.pins.length;)i++;i>0&&this._cursor.curNote.start+this._cursor.curNote.pins[i].time-this._cursor.exactPart>this._cursor.exactPart-(this._cursor.curNote.start+this._cursor.curNote.pins[i-1].time)&&i--,this.modDragValueLabel.style.setProperty("color","#666688"),this.modDragValueLabel.style.setProperty("display","");const s=Math.max(0,w.modCount-1-this._cursor.curNote.pitches[0]);let h=u.song.channels[u.channel].instruments[u.getCurrentInstrument(this._barOffset)].modulators[s],d=this._cursor.curNote.pins[i].size+w.modulators[h].convertRealFactor,c=+(d>=10)+ +(d>=100)+ +(d<0)+ +(d<=-10);this._modDragValueLabelWidth=8+c*8,this._modDragValueLabelLeft=+Le(Math.max(Math.min(this._editorWidth-10-c*8,this._partWidth*(this._cursor.curNote.start+this._cursor.curNote.pins[i].time)-4-c*4),2)),this._modDragValueLabelTop=+Le(this._pitchToPixelHeight(this._cursor.curNote.pitches[0]-this._octaveOffset)-17-(this._pitchHeight-this._pitchBorder)/2),this._modDragStartValue=this._cursor.curNote.pins[i].size,this._modDragNote=this._cursor.curNote,this._modDragPin=this._cursor.curNote.pins[i],this._modDragLowerBound=w.modulators[h].convertRealFactor,this._modDragUpperBound=w.modulators[h].convertRealFactor+w.modulators[h].maxRawVol,this._modDragSetting=h,this.modDragValueLabel.style.setProperty("left",""+this._modDragValueLabelLeft+"px"),this.modDragValueLabel.style.setProperty("top",""+this._modDragValueLabelTop+"px"),this.modDragValueLabel.textContent=""+d}else this.modDragValueLabel.style.setProperty("display","none"),this.modDragValueLabel.style.setProperty("pointer-events","none"),this.modDragValueLabel.setAttribute("contenteditable","false");else this.editingModLabel||(this.modDragValueLabel.style.setProperty("display","none"),this.modDragValueLabel.style.setProperty("pointer-events","none"),this.modDragValueLabel.setAttribute("contenteditable","false"))}else this.modDragValueLabel.style.setProperty("display","none"),this.modDragValueLabel.style.setProperty("pointer-events","none"),this.modDragValueLabel.setAttribute("contenteditable","false");let n=this._findMousePitch(this._mouseY);if(this._cursor.curNote!=null){this._cursor.start=this._cursor.curNote.start,this._cursor.end=this._cursor.curNote.end,this._cursor.pins=this._cursor.curNote.pins;let i=0,s=0,h,d=this._cursor.curNote.pins[0];for(let S=1;S<this._cursor.curNote.pins.length;S++){h=d,d=this._cursor.curNote.pins[S];const E=this._partWidth*(this._cursor.curNote.start+h.time),A=this._partWidth*(this._cursor.curNote.start+d.time);if(this._mouseX>A)continue;if(this._mouseX<E)throw new Error;const C=(this._mouseX-E)/(A-E),k=Math.sqrt(1/Math.sqrt(4)-Math.pow(C-.5,2))-.5,T=Math.abs(d.interval-h.interval);i=h.interval*(1-C)+d.interval*C,s=k*T+.95;break}let c=Number.MAX_VALUE,_=-Number.MAX_VALUE,m=Number.MAX_VALUE;for(const S of this._cursor.curNote.pins){c>S.interval&&(c=S.interval),_<S.interval&&(_=S.interval);const E=Math.abs(this._cursor.curNote.start+S.time-this._mouseX/this._partWidth);m>E&&(m=E,this._cursor.nearPinIndex=this._cursor.curNote.pins.indexOf(S))}n-=i;const g=u.song.getChannelIsNoise(u.channel)?w.drumCount-1:u.song.getChannelIsMod(u.channel)?w.modCount-1:w.maxPitch;if(this._cursor.pitch=this._snapToPitch(n,-c,g-_),!u.song.getChannelIsNoise(u.channel)&&!u.song.getChannelIsMod(u.channel)){let S=s;for(let E=0;E<this._cursor.curNote.pitches.length;E++){const A=Math.abs(this._cursor.curNote.pitches[E]-n+.5);A>S||(S=A,this._cursor.pitch=this._cursor.curNote.pitches[E])}}for(let S=0;S<this._cursor.curNote.pitches.length;S++)if(this._cursor.curNote.pitches[S]==this._cursor.pitch){this._cursor.pitchIndex=S;break}}else{const i=u.song.getChannelIsNoise(u.channel)?w.drumCount-1:u.song.getChannelIsMod(u.channel)?w.modCount:w.maxPitch;this._cursor.pitch=this._snapToPitch(n,0,i);const s=this._copiedPins[this._copiedPins.length-1].time,h=Math.floor(this._cursor.part/w.partsPerBeat),d=this._getMaxDivision(),c=this._cursor.part%w.partsPerBeat;if(s==1)this._cursor.start=this._cursor.part;else if(s>w.partsPerBeat)this._cursor.start=h*w.partsPerBeat;else if(s==w.partsPerBeat)this._cursor.start=h*w.partsPerBeat,d<w.partsPerBeat&&c>d&&(this._cursor.start+=Math.floor(c/d)*d);else{this._cursor.start=h*w.partsPerBeat;let g=w.partsPerBeat%s==0?s:Math.min(s,d);for(;g<d&&w.partsPerBeat%g!=0;)g++;this._cursor.start+=Math.floor(c/g)*g}this._cursor.end=this._cursor.start+s;let _=0,m=u.song.beatsPerBar*w.partsPerBeat;if(this._cursor.prevNote!=null&&(_=this._cursor.prevNote.end),this._cursor.nextNote!=null&&(m=this._cursor.nextNote.start),this._cursor.start<_?(this._cursor.start=_,this._cursor.end=this._cursor.start+s,this._cursor.end>m&&(this._cursor.end=m)):this._cursor.end>m&&(this._cursor.end=m,this._cursor.start=this._cursor.end-s,this._cursor.start<_&&(this._cursor.start=_)),this._cursor.end-this._cursor.start==s)this._copiedPins=this._copiedPinChannels[u.channel],this._cursor.pins=this._copiedPins;else{this._cursor.pins=[];for(const g of this._copiedPins)if(g.time<=this._cursor.end-this._cursor.start){if(this._cursor.pins.push(Nt(0,g.time,g.size)),g.time==this._cursor.end-this._cursor.start)break}else{this._cursor.pins.push(Nt(0,this._cursor.end-this._cursor.start,g.size));break}}if(u.song.getChannelIsMod(u.channel)){if(this._cursor.pitch=Math.max(0,Math.min(w.modCount-1,this._cursor.pitch)),this._stashCursorPinVols!=null&&this._stashCursorPinVols[u.channel]!=null)for(let E=0;E<this._cursor.pins.length;E++)this._cursor.pins[E].size=this._stashCursorPinVols[u.channel][E];let g=u.song.getVolumeCap(u.song.getChannelIsMod(u.channel),u.channel,u.getCurrentInstrument(this._barOffset),this._cursor.pitch),S=0;for(const E of this._cursor.pins)E.size>S&&(S=E.size);if(S>g)for(const E of this._cursor.pins)E.size=Math.round(E.size*(g/S))}}this._cursor.valid=!0}_cursorIsInSelection(){return this._cursor.valid&&u.selection.patternSelectionActive&&u.selection.patternSelectionStart<=this._cursor.exactPart&&this._cursor.exactPart<=u.selection.patternSelectionEnd}_cursorAtStartOfSelection(){return this._cursor.valid&&u.selection.patternSelectionActive&&this._cursor.pitchIndex==-1&&u.selection.patternSelectionStart-3<=this._cursor.exactPart&&this._cursor.exactPart<=u.selection.patternSelectionStart+1.25}_cursorAtEndOfSelection(){return this._cursor.valid&&u.selection.patternSelectionActive&&this._cursor.pitchIndex==-1&&u.selection.patternSelectionEnd-1.25<=this._cursor.exactPart&&this._cursor.exactPart<=u.selection.patternSelectionEnd+3}_findMousePitch(e){return Math.max(0,Math.min(this._pitchCount-1,this._pitchCount-e/this._pitchHeight))+this._octaveOffset}_snapToPitch(e,t,n){e<t&&(e=t),e>n&&(e=n);const i=u.prefs.notesOutsideScale?w.scales.dictionary.Free.flags:w.scales[u.song.scale].flags;if(i[Math.floor(e)%w.pitchesPerOctave]||u.song.getChannelIsNoise(u.channel)||u.song.getChannelIsMod(u.channel))return Math.floor(e);{let s=Math.floor(e)+1,h=Math.floor(e)-1;for(;!i[s%w.pitchesPerOctave];)s++;for(;!i[h%w.pitchesPerOctave];)h--;if(s>n)return h<t?t:h;if(h<t)return s;let d=s,c=h+1;return(s%w.pitchesPerOctave==0||s%w.pitchesPerOctave==7)&&(d-=.5),(h%w.pitchesPerOctave==0||h%w.pitchesPerOctave==7)&&(c+=.5),e-c>d-e?s:h}}_copyPins(e){this._copiedPins=[];for(const t of e.pins)this._copiedPins.push(Nt(0,t.time,t.size));for(let t=1;t<this._copiedPins.length-1;)this._copiedPins[t-1].size==this._copiedPins[t].size&&this._copiedPins[t].size==this._copiedPins[t+1].size?this._copiedPins.splice(t,1):t++;this._copiedPinChannels[u.channel]=this._copiedPins,this._stashCursorPinVols[u.channel]=[];for(let t=0;t<this._copiedPins.length;t++)this._stashCursorPinVols[u.channel].push(this._copiedPins[t].size)}movePlayheadToMouse(){return this._mouseOver?(u.synth.playhead=u.bar+this._barOffset+this._mouseX/this._editorWidth,!0):!1}stopEditingModLabel(e){if(this.editingModLabel&&this._modDragPin!=null&&this._modDragNote!=null){if(this.editingModLabel=!1,this.modDragValueLabel.style.setProperty("pointer-events","none"),window.getSelection){let n=window.getSelection();n!=null&&n.removeAllRanges()}if(e){this._modDragPin.size=this._modDragStartValue;let n=this._modDragStartValue+w.modulators[this._modDragSetting].convertRealFactor,i=+(n>=10)+ +(n>=100)+ +(n<0)+ +(n<=-10);this._modDragValueLabelLeft=+Le(Math.max(Math.min(this._editorWidth-10-i*8,this._partWidth*(this._modDragNote.start+this._modDragPin.time)-4-i*4),2)),this.modDragValueLabel.style.setProperty("left",""+this._modDragValueLabelLeft+"px");const s=new Zn;this._dragChange=s,u.setProspectiveChange(this._dragChange),s.append(new xr(u,this._modDragNote,this._modDragPin.time,this._modDragStartValue,this._modDragPin.interval,this.shiftMode)),this._dragChange=null}u.lastChangeWas(this._dragChange)&&this._dragChange!=null&&(u.record(this._dragChange),this._dragChange=null)}}_whenCursorPressed(){if(u.song.getChannelIsMod(u.channel)&&this.modDragValueLabel.style.getPropertyValue("display")!="none"&&this._mouseX>+this._modDragValueLabelLeft-6&&this._mouseX<+this._modDragValueLabelLeft+this._modDragValueLabelWidth+6&&this._mouseY>+this._modDragValueLabelTop-8&&this._mouseY<+this._modDragValueLabelTop+11){if(this.modDragValueLabel.style.setProperty("pointer-events","fill"),this.modDragValueLabel.setAttribute("contenteditable","true"),window.getSelection){let e=window.getSelection();e!=null&&e.selectAllChildren(this.modDragValueLabel)}window.setTimeout(()=>{this.modDragValueLabel.focus()}),this.editingModLabel=!0}else{this.stopEditingModLabel(!1),u.prefs.enableNotePreview&&u.synth.maintainLiveInput(),this._mouseDown=!0,this._mouseXStart=this._mouseX,this._mouseYStart=this._mouseY,this._updateCursorStatus(),this._updatePreview();const e=new Zn;if(this._dragChange=e,this._lastChangeWasPatternSelection=u.lastChangeWas(this._changePatternSelection),u.setProspectiveChange(this._dragChange),this._cursorAtStartOfSelection())this._draggingStartOfSelection=!0;else if(this._cursorAtEndOfSelection())this._draggingEndOfSelection=!0;else if(this._shiftHeld)if(u.selection.patternSelectionActive&&this._cursor.pitchIndex==-1||this._cursorIsInSelection())e.append(new Fn(u,0,0));else if(this._cursor.curNote!=null)e.append(new Fn(u,this._cursor.curNote.start,this._cursor.curNote.end));else{const t=Math.max(0,Math.min((u.song.beatsPerBar-1)*w.partsPerBeat,Math.floor(this._cursor.exactPart/w.partsPerBeat)*w.partsPerBeat)),n=t+w.partsPerBeat;e.append(new Fn(u,t,n))}else if(this._cursorIsInSelection())this._draggingSelectionContents=!0;else if(this._cursor.valid&&this._cursor.curNote==null){e.append(new Fn(u,0,0));const t=new fr(this._cursor.pitch,this._cursor.start,this._cursor.end,w.noteSizeMax,u.song.getChannelIsNoise(u.channel));t.pins=[];for(const i of this._cursor.pins)t.pins.push(Nt(0,i.time,i.size));e.append(new ur(u,u.channel,u.bar));const n=u.getCurrentPattern(this._barOffset);if(n==null)throw new Error;if(e.append(new yi(u,n,t,this._cursor.curIndex)),u.prefs.enableNotePreview&&!u.synth.playing){const i=Math.min(w.partsPerBeat,this._cursor.end-this._cursor.start);u.performance.setTemporaryPitches([this._cursor.pitch],i)}}this._updateSelection()}}_whenCursorMoved(){u.prefs.enableNotePreview&&this._mouseOver&&u.synth.maintainLiveInput();const e=u.lastChangeWas(this._dragChange);if(!this._mouseDragging&&this._mouseDown&&this._cursor.valid&&e){const t=this._mouseX-this._mouseXStart,n=this._mouseY-this._mouseYStart;Math.sqrt(t*t+n*n)>5&&(this._mouseDragging=!0,this._mouseHorizontal=Math.abs(t)>=Math.abs(n))}if(this._shiftHeld&&this._mouseHorizontal&&Math.abs(this._mouseXStart-this._mouseX)>5&&(this._dragConfirmed=!0),this._mouseDragging&&this._mouseDown&&this._cursor.valid&&e){this._dragChange.undo();const t=new Zn;this._dragChange=t,u.setProspectiveChange(this._dragChange);const n=this._getMinDivision(),i=this._snapToMinDivision(this._mouseX/this._partWidth);if(this._draggingStartOfSelection)t.append(new Fn(u,Math.max(0,Math.min(u.song.beatsPerBar*w.partsPerBeat,i)),u.selection.patternSelectionEnd)),this._updateSelection();else if(this._draggingEndOfSelection)t.append(new Fn(u,u.selection.patternSelectionStart,Math.max(0,Math.min(u.song.beatsPerBar*w.partsPerBeat,i)))),this._updateSelection();else if(this._draggingSelectionContents){const s=u.getCurrentPattern(this._barOffset);if(this._mouseDragging&&s!=null){this._dragChange.undo();const h=new Zn;this._dragChange=h,u.setProspectiveChange(this._dragChange);const d=w.scales[u.song.scale].flags.filter(g=>g).length,c=u.song.getChannelIsNoise(u.channel)?1:12/d,_=Math.round((this._mouseX-this._mouseXStart)/(this._partWidth*n))*n,m=Math.round((this._mouseYStart-this._mouseY)/(this._pitchHeight*c));h.append(new dp(u,u.channel,s,_,m))}}else if(this._shiftHeld&&this._dragConfirmed){if(this._mouseDragging){let s=Math.max(0,Math.min((u.song.beatsPerBar-1)*w.partsPerBeat,Math.floor(this._cursor.exactPart/w.partsPerBeat)*w.partsPerBeat)),h=s+w.partsPerBeat;if(this._cursor.curNote!=null&&(s=Math.max(s,this._cursor.curNote.start),h=Math.min(h,this._cursor.curNote.end)),i<s){s=0;const d=u.getCurrentPattern(this._barOffset);if(d!=null)for(let c=0;c<d.notes.length;c++)d.notes[c].start<=i&&(s=d.notes[c].start),d.notes[c].end<=i&&(s=d.notes[c].end);for(let c=0;c<=u.song.beatsPerBar;c++){const _=c*w.partsPerBeat;s<=_&&_<=i&&(s=_)}}if(i>h){h=w.partsPerBeat*u.song.beatsPerBar;const d=u.getCurrentPattern(this._barOffset);if(d!=null)for(let c=0;c<d.notes.length;c++){if(d.notes[c].start>=i){h=d.notes[c].start;break}if(d.notes[c].end>=i){h=d.notes[c].end;break}}for(let c=0;c<=u.song.beatsPerBar;c++){const _=c*w.partsPerBeat;i<_&&_<h&&(h=_)}}t.append(new Fn(u,s,h)),this._updateSelection()}}else if(this._cursor.curNote==null){t.append(new Fn(u,0,0));let s,h;i<this._cursor.start?(s=!0,h=this._cursor.start-i):(s=!1,h=i-this._cursor.start+n);let d=n;for(let S=n;S<=u.song.beatsPerBar*w.partsPerBeat;S+=n){if(n==1){if(!(S<5)){if(S<=w.partsPerBeat/2){if(S%3!=0&&S%4!=0)continue}else if(S<=w.partsPerBeat*1.5){if(S%6!=0&&S%8!=0)continue}else if(S%w.partsPerBeat!=0)continue}}else if(S>=5*n&&S%w.partsPerBeat!=0&&S!=w.partsPerBeat*3/4&&S!=w.partsPerBeat*3/2&&S!=w.partsPerBeat*4/3)continue;const E=S;if(E==h){d=E;break}if(E<h&&(d=E),E>h){d<h-n&&(d=E);break}}let c,_;s?(_=this._cursor.start,c=_-d):(c=this._cursor.start,_=c+d);const m=c<0&&u.channel<u.song.pitchChannelCount+u.song.noiseChannelCount;if(c<0&&(c=0),_>u.song.beatsPerBar*w.partsPerBeat&&(_=u.song.beatsPerBar*w.partsPerBeat),c<_){t.append(new ur(u,u.channel,u.bar));const S=u.getCurrentPattern(this._barOffset);if(S==null)throw new Error;t.append(new _s(u,S,c,_,new fr(this._cursor.pitch,0,0,0)));let E;for(E=0;E<S.notes.length&&!(S.notes[E].start>=_);E++);const A=new fr(this._cursor.pitch,c,_,u.song.getNewNoteVolume(u.song.getChannelIsMod(u.channel),u.channel,u.getCurrentInstrument(this._barOffset),this._cursor.pitch),u.song.getChannelIsNoise(u.channel));A.continuesLastPattern=m,t.append(new yi(u,S,A,E)),this._copyPins(A),this._dragTime=s?c:_,this._dragPitch=this._cursor.pitch,this._dragSize=A.pins[s?0:1].size,this._dragVisible=!0}let g=this._pattern;this._pattern=u.getCurrentPattern(this._barOffset),this._pattern!=null&&u.song.getChannelIsMod(u.channel)&&this._interactive&&g!=this._pattern&&this._pattern.notes.sort(function(S,E){return S.start==E.start?S.pitches[0]-E.pitches[0]:S.start-E.start})}else if(this._mouseHorizontal){t.append(new Fn(u,0,0));const s=(this._mouseX-this._mouseXStart)/this._partWidth,h=this._cursor.curNote.pins[this._cursor.nearPinIndex];let d=Math.round((this._cursor.curNote.start+h.time+s)/n)*n;const c=d<0&&u.channel<u.song.pitchChannelCount+u.song.noiseChannelCount;if(d<0&&(d=0),d>u.song.beatsPerBar*w.partsPerBeat&&(d=u.song.beatsPerBar*w.partsPerBeat),this._pattern==null)throw new Error;if(d<=this._cursor.curNote.start&&this._cursor.nearPinIndex==this._cursor.curNote.pins.length-1||d>=this._cursor.curNote.end&&this._cursor.nearPinIndex==0)t.append(new yi(u,this._pattern,this._cursor.curNote,this._cursor.curIndex,!0)),this._dragVisible=!1;else{const _=Math.min(this._cursor.curNote.start,d),m=Math.max(this._cursor.curNote.end,d);this._dragTime=d,this._dragPitch=this._cursor.curNote.pitches[this._cursor.pitchIndex==-1?0:this._cursor.pitchIndex]+this._cursor.curNote.pins[this._cursor.nearPinIndex].interval,this._dragSize=this._cursor.curNote.pins[this._cursor.nearPinIndex].size,this._dragVisible=!0,t.append(new _s(u,this._pattern,_,m,this._cursor.curNote)),t.append(new hu(u,this._cursor.curNote,this._cursor.nearPinIndex,d,c)),this._copyPins(this._cursor.curNote)}}else if(this._cursor.pitchIndex==-1||u.song.getChannelIsMod(u.channel)){this._mouseDragging||t.append(new Fn(u,0,0));const s=Math.max(this._cursor.curNote.start,Math.min(this._cursor.curNote.end,Math.round(this._mouseX/(this._partWidth*n))*n))-this._cursor.curNote.start;let h,d=this._cursor.curNote.pins[0],c=0,_=0,m=u.song.getVolumeCap(u.song.getChannelIsMod(u.channel),u.channel,u.getCurrentInstrument(this._barOffset),this._cursor.pitch),g=25/Math.pow(m,.4),S=22/Math.pow(m,.5),E=this._mouseYStart>this._mouseY?1:-1,A=Math.min(Math.abs(this._mouseYStart-this._mouseY)/g,8)+Math.max(0,Math.abs(this._mouseYStart-this._mouseY)/S-8);A>0&&(this._shiftHeld=!1);for(let C=1;C<this._cursor.curNote.pins.length;C++){if(h=d,d=this._cursor.curNote.pins[C],s>d.time)continue;if(s<h.time)throw new Error;const k=(s-h.time)/(d.time-h.time);c=Math.round(h.size*(1-k)+d.size*k+E*A),!this.controlMode&&!u.prefs.alwaysFineNoteVol&&!u.song.getChannelIsMod(u.channel)&&(c=Math.floor(c/2)*2),c<0&&(c=0),c>m&&(c=m),_=this._snapToPitch(h.interval*(1-k)+d.interval*k+this._cursor.curNote.pitches[0],0,w.maxPitch)-this._cursor.curNote.pitches[0];break}if(u.song.getChannelIsMod(u.channel)&&this.controlMode){if(s>=this._cursor.curNote.pins[this._cursor.curNote.pins.length-1].time)if(this._cursor.curNote.start+this._cursor.curNote.pins[this._cursor.curNote.pins.length-1].time<u.song.beatsPerBar*w.partsPerBeat)for(const C of this._pattern.notes)C.start==this._cursor.curNote.start+this._cursor.curNote.pins[this._cursor.curNote.pins.length-1].time&&C.pitches[0]==this._cursor.curNote.pitches[0]&&t.append(new xr(u,C,C.pins[0].time,c,_,this.shiftMode));else{const C=u.getCurrentPattern(1);if(C!=null&&C.instruments[0]==this._pattern.instruments[0])for(const k of C.notes)k.start==0&&k.pitches[0]==this._cursor.curNote.pitches[0]&&t.append(new xr(u,k,k.pins[0].time,c,_,this.shiftMode))}else if(s<=this._cursor.curNote.pins[0].time)if(this._cursor.curNote.start>0)for(const C of this._pattern.notes)C.end==this._cursor.curNote.start&&C.pitches[0]==this._cursor.curNote.pitches[0]&&t.append(new xr(u,C,C.pins[C.pins.length-1].time,c,_,this.shiftMode));else{const C=u.getCurrentPattern(-1);if(C!=null&&C.instruments[0]==this._pattern.instruments[0])for(const k of C.notes)k.end==u.song.beatsPerBar*w.partsPerBeat&&k.pitches[0]==this._cursor.curNote.pitches[0]&&t.append(new xr(u,k,k.pins[k.pins.length-1].time,c,_,this.shiftMode))}}this._dragTime=this._cursor.curNote.start+s,this._dragPitch=this._cursor.curNote.pitches[this._cursor.pitchIndex==-1?0:this._cursor.pitchIndex]+_,this._dragSize=c,this._dragVisible=!0,t.append(new xr(u,this._cursor.curNote,s,c,_,this.shiftMode)),this._copyPins(this._cursor.curNote)}else{if(t.append(new Fn(u,0,0)),this._dragSize=this._cursor.curNote.pins[this._cursor.nearPinIndex].size,this._pattern==null)throw new Error;let s,h;this._mouseX>=this._mouseXStart?(s=Math.max(this._cursor.curNote.start,this._cursor.part),h=i+n):(s=Math.min(this._cursor.curNote.end,this._cursor.part+n),h=i),h<0&&(h=0),h>u.song.beatsPerBar*w.partsPerBeat&&(h=u.song.beatsPerBar*w.partsPerBeat),h>this._cursor.curNote.end&&t.append(new _s(u,this._pattern,this._cursor.curNote.start,h,this._cursor.curNote)),h<this._cursor.curNote.start&&t.append(new _s(u,this._pattern,h,this._cursor.curNote.end,this._cursor.curNote));let d=Number.MAX_VALUE,c=-Number.MAX_VALUE;for(const _ of this._cursor.curNote.pitches)d>_&&(d=_),c<_&&(c=_);if(d-=this._cursor.curNote.pitches[this._cursor.pitchIndex],c-=this._cursor.curNote.pitches[this._cursor.pitchIndex],u.song.getChannelIsMod(u.channel)){const _=this._snapToPitch(this._dragPitch,-d,w.modCount-1);t.append(new hc(u,this._cursor.curNote,s,h,_,this._cursor.pitchIndex)),this._dragPitch=_}else{const _=this._snapToPitch(this._findMousePitch(this._mouseY),-d,(u.song.getChannelIsNoise(u.channel)?w.drumCount-1:w.maxPitch)-c);t.append(new hc(u,this._cursor.curNote,s,h,_,this._cursor.pitchIndex)),this._dragPitch=_}this._copyPins(this._cursor.curNote),this._dragTime=h,this._dragVisible=!0}}this._mouseDown&&this._cursor.valid&&e||(this._updateCursorStatus(),this._updatePreview())}_setPatternSelection(e){this._changePatternSelection=e,u.record(this._changePatternSelection,this._lastChangeWasPatternSelection)}_updatePreview(){if(this._usingTouch)if(!this._mouseDown||!this._cursor.valid||!this._mouseDragging||!this._dragVisible||this._shiftHeld||this._draggingStartOfSelection||this._draggingEndOfSelection||this._draggingSelectionContents)this._svgPreview.setAttribute("visibility","hidden"),this.editingModLabel||(this.modDragValueLabel.style.setProperty("display","none"),this.modDragValueLabel.style.setProperty("pointer-events","none"),this.modDragValueLabel.setAttribute("contenteditable","false"));else{this._svgPreview.setAttribute("visibility","visible");const e=this._partWidth*this._dragTime,t=this._pitchToPixelHeight(this._dragPitch-this._octaveOffset),n=(this._pitchHeight-this._pitchBorder)/2,i=80,s=60,h=u.song.getVolumeCap(u.song.getChannelIsMod(u.channel),u.channel,u.getCurrentInstrument(this._barOffset),this._cursor.pitch);let d="";d+="M "+Le(e)+" "+Le(t-n*(this._dragSize/h))+" ",d+="L "+Le(e)+" "+Le(t-n*(this._dragSize/h)-s)+" ",d+="M "+Le(e)+" "+Le(t+n*(this._dragSize/h))+" ",d+="L "+Le(e)+" "+Le(t+n*(this._dragSize/h)+s)+" ",d+="M "+Le(e)+" "+Le(t-n*(this._dragSize/h))+" ",d+="L "+Le(e+i)+" "+Le(t-n*(this._dragSize/h))+" ",d+="M "+Le(e)+" "+Le(t+n*(this._dragSize/h))+" ",d+="L "+Le(e+i)+" "+Le(t+n*(this._dragSize/h))+" ",d+="M "+Le(e)+" "+Le(t-n*(this._dragSize/h))+" ",d+="L "+Le(e-i)+" "+Le(t-n*(this._dragSize/h))+" ",d+="M "+Le(e)+" "+Le(t+n*(this._dragSize/h))+" ",d+="L "+Le(e-i)+" "+Le(t+n*(this._dragSize/h))+" ",this._svgPreview.setAttribute("d",d)}else if(!this._mouseOver||this._mouseDown||!this._cursor.valid)this._svgPreview.setAttribute("visibility","hidden"),this.editingModLabel||(this.modDragValueLabel.style.setProperty("display","none"),this.modDragValueLabel.style.setProperty("pointer-events","none"),this.modDragValueLabel.setAttribute("contenteditable","false"));else if(this._svgPreview.setAttribute("visibility","visible"),this._cursorAtStartOfSelection()){const e=this._partWidth*u.selection.patternSelectionStart,t=Le(e-4),n=Le(e+4),i=this._pitchToPixelHeight(-.5);this._svgPreview.setAttribute("d","M "+t+" 0 L "+t+" "+i+" L "+n+" "+i+" L "+n+" 0 z")}else if(this._cursorAtEndOfSelection()){const e=this._partWidth*u.selection.patternSelectionEnd,t=Le(e-4),n=Le(e+4),i=this._pitchToPixelHeight(-.5);this._svgPreview.setAttribute("d","M "+t+" 0 L "+t+" "+i+" L "+n+" "+i+" L "+n+" 0 z")}else if(this._cursorIsInSelection()){const e=Le(this._partWidth*u.selection.patternSelectionStart-2),t=Le(this._partWidth*u.selection.patternSelectionEnd+2),n=this._pitchToPixelHeight(-.5);this._svgPreview.setAttribute("d","M "+e+" 0 L "+e+" "+n+" L "+t+" "+n+" L "+t+" 0 z")}else this._drawNote(this._svgPreview,this._cursor.pitch,this._cursor.start,this._cursor.pins,(this._pitchHeight-this._pitchBorder)/2+1,!0,this._octaveOffset)}_updateSelection(){u.selection.patternSelectionActive?(this._selectionRect.setAttribute("visibility","visible"),this._selectionRect.setAttribute("x",String(this._partWidth*u.selection.patternSelectionStart)),this._selectionRect.setAttribute("width",String(this._partWidth*(u.selection.patternSelectionEnd-u.selection.patternSelectionStart)))):this._selectionRect.setAttribute("visibility","hidden")}render(){const e=u.getCurrentPattern(this._barOffset);if(this._pattern!=e&&this._pattern!=null&&(u.song.getChannelIsMod(u.channel)&&this._interactive&&e!=null&&e.notes.sort(function(n,i){return n.start==i.start?n.pitches[0]-i.pitches[0]:n.start-i.start}),this._dragChange=null,this._whenCursorReleased(null)),this._pattern=e,this._editorWidth=this.container.clientWidth,this._editorHeight=this.container.clientHeight,this._partWidth=this._editorWidth/(u.song.beatsPerBar*w.partsPerBeat),this._octaveOffset=u.channel>=u.song.pitchChannelCount?0:u.song.channels[u.channel].octave*w.pitchesPerOctave,u.song.getChannelIsNoise(u.channel))this._pitchBorder=0,this._pitchCount=w.drumCount;else if(u.song.getChannelIsMod(u.channel)){if(this._pitchBorder=this._defaultModBorder,this._pitchCount=w.modCount,this._pattern!=null)for(const n of this._pattern.notes){let i=n.pitches[0],s=u.song.getVolumeCap(!0,u.channel,u.getCurrentInstrument(this._barOffset),i),h=0;for(const d of n.pins)d.size>h&&(h=d.size);if(h>s)for(const d of n.pins)d.size=Math.round(d.size*(s/h))}}else this._pitchBorder=0,this._pitchCount=u.getVisiblePitchCount();this._pitchHeight=this._editorHeight/this._pitchCount,this._octaveOffset=u.channel>=u.song.pitchChannelCount?0:u.getBaseVisibleOctave(u.channel)*w.pitchesPerOctave,(this._renderedRhythm!=u.song.rhythm||this._renderedPitchChannelCount!=u.song.pitchChannelCount||this._renderedNoiseChannelCount!=u.song.noiseChannelCount||this._renderedModChannelCount!=u.song.modChannelCount)&&(this._renderedRhythm=u.song.rhythm,this._renderedPitchChannelCount=u.song.pitchChannelCount,this._renderedNoiseChannelCount=u.song.noiseChannelCount,this._renderedModChannelCount=u.song.modChannelCount,this.resetCopiedPins()),this._copiedPins=this._copiedPinChannels[u.channel],(this._renderedWidth!=this._editorWidth||this._renderedHeight!=this._editorHeight)&&(this._renderedWidth=this._editorWidth,this._renderedHeight=this._editorHeight,this._svgBackground.setAttribute("width",""+this._editorWidth),this._svgBackground.setAttribute("height",""+this._editorHeight),this._svgPlayhead.setAttribute("height",""+this._editorHeight),this._selectionRect.setAttribute("y","0"),this._selectionRect.setAttribute("height",""+this._editorHeight));const t=this._editorWidth/u.song.beatsPerBar;if(this._renderedBeatWidth!=t||this._renderedPitchHeight!=this._pitchHeight){this._renderedBeatWidth=t,this._renderedPitchHeight=this._pitchHeight,this._svgNoteBackground.setAttribute("width",""+t),this._svgNoteBackground.setAttribute("height",""+this._pitchHeight*w.pitchesPerOctave),this._svgDrumBackground.setAttribute("width",""+t),this._svgDrumBackground.setAttribute("height",""+this._pitchHeight),this._svgModBackground.setAttribute("width",""+t),this._svgModBackground.setAttribute("height",""+this._pitchHeight),this._svgModBackground.setAttribute("y",""+this._pitchBorder/2),this._backgroundDrumRow.setAttribute("width",""+(t-2)),this._backgroundDrumRow.setAttribute("height",""+(this._pitchHeight-2)),this._pitchHeight>this._pitchBorder&&(this._backgroundModRow.setAttribute("width",""+(t-2)),this._backgroundModRow.setAttribute("height",""+(this._pitchHeight-this._pitchBorder)));for(let n=0;n<w.pitchesPerOctave;n++){const i=this._backgroundPitchRows[n],s=(w.pitchesPerOctave-n)%w.pitchesPerOctave;i.setAttribute("width",""+(t-2)),i.setAttribute("y",""+(s*this._pitchHeight+1)),i.setAttribute("height",""+(this._pitchHeight-2))}}this._interactive&&(this._mouseDown||this._updateCursorStatus(),this._updatePreview(),this._updateSelection()),this._renderedFifths!=u.prefs.showFifth&&(this._renderedFifths=u.prefs.showFifth,this._backgroundPitchRows[7].setAttribute("fill",u.prefs.showFifth?Q.fifthNote:Q.pitchBackground));for(let n=0;n<w.pitchesPerOctave;n++)this._backgroundPitchRows[n].style.visibility=w.scales[u.song.scale].flags[n]?"visible":"hidden";u.song.getChannelIsNoise(u.channel)?this._renderedDrums||(this._renderedDrums=!0,this._renderedMod=!1,this._svgBackground.setAttribute("fill","url(#patternEditorDrumBackground"+this._barOffset+")")):u.song.getChannelIsMod(u.channel)?this._renderedMod||(this._renderedDrums=!1,this._renderedMod=!0,this._svgBackground.setAttribute("fill","url(#patternEditorModBackground"+this._barOffset+")")):(this._renderedDrums||this._renderedMod)&&(this._renderedDrums=!1,this._renderedMod=!1,this._svgBackground.setAttribute("fill","url(#patternEditorNoteBackground"+this._barOffset+")")),this._redrawNotePatterns()}_redrawNotePatterns(){if(this._svgNoteContainer=m_(this._svgNoteContainer),u.prefs.showChannels&&!u.song.getChannelIsMod(u.channel))for(let e=u.song.pitchChannelCount+u.song.noiseChannelCount-1;e>=0;e--){if(e==u.channel||u.song.getChannelIsNoise(e)!=u.song.getChannelIsNoise(u.channel))continue;const t=u.song.getPattern(e,u.bar+this._barOffset);if(t==null)continue;const n=u.getBaseVisibleOctave(e)*w.pitchesPerOctave;for(const i of t.notes)for(const s of i.pitches){const h=me.path();h.setAttribute("fill",Q.getChannelColor(u.song,e).secondaryNote),h.setAttribute("pointer-events","none"),this._drawNote(h,s,i.start,i.pins,this._pitchHeight*.19,!1,n),this._svgNoteContainer.appendChild(h)}}if(this._pattern!=null){const e=u.song.channels[u.channel].instruments[u.getCurrentInstrument(this._barOffset)],t=e.getChord(),n=e.getTransition(),i=t.customInterval||t.arpeggiates||t.strumParts>0||n.slides;for(const s of this._pattern.notes){let h=!1;u.song.getChannelIsMod(u.channel)&&(e.modulators[w.modCount-1-s.pitches[0]]==w.modulators.dictionary.none.index||e.invalidModulators[w.modCount-1-s.pitches[0]])&&(h=!0);for(let d=0;d<s.pitches.length;d++){const c=s.pitches[d];let _=me.path(),m=h?Q.disabledNotePrimary:Q.getChannelColor(u.song,u.channel).primaryNote,g=h?Q.disabledNoteSecondary:Q.getChannelColor(u.song,u.channel).secondaryNote;_.setAttribute("fill",g),_.setAttribute("pointer-events","none"),this._drawNote(_,c,s.start,s.pins,(this._pitchHeight-this._pitchBorder)/2+1,!1,this._octaveOffset),this._svgNoteContainer.appendChild(_),_=me.path(),_.setAttribute("fill",m),_.setAttribute("pointer-events","none"),this._drawNote(_,c,s.start,s.pins,(this._pitchHeight-this._pitchBorder)/2+1,!0,this._octaveOffset),this._svgNoteContainer.appendChild(_);let S=2;if(s.continuesLastPattern){const E=Math.min(this._pitchHeight,20);let A;A="M "+Le(this._partWidth*s.start+S)+" "+Le(this._pitchToPixelHeight(c-this._octaveOffset)-.1*E),A+="L "+Le(this._partWidth*s.start+S)+" "+Le(this._pitchToPixelHeight(c-this._octaveOffset)+.1*E),A+="L "+Le(this._partWidth*s.start+S+4)+" "+Le(this._pitchToPixelHeight(c-this._octaveOffset)+.1*E),A+="L "+Le(this._partWidth*s.start+S+4)+" "+Le(this._pitchToPixelHeight(c-this._octaveOffset)+.3*E),A+="L "+Le(this._partWidth*s.start+S+12)+" "+Le(this._pitchToPixelHeight(c-this._octaveOffset)),A+="L "+Le(this._partWidth*s.start+S+4)+" "+Le(this._pitchToPixelHeight(c-this._octaveOffset)-.3*E),A+="L "+Le(this._partWidth*s.start+S+4)+" "+Le(this._pitchToPixelHeight(c-this._octaveOffset)-.1*E);const C=me.path();C.setAttribute("d",A),C.setAttribute("fill",Q.invertedText),this._svgNoteContainer.appendChild(C),S+=12}if(s.pitches.length>1&&i){const E=me.text();E.setAttribute("x",""+Le(this._partWidth*s.start+S)),E.setAttribute("y",""+Le(this._pitchToPixelHeight(c-this._octaveOffset))),E.setAttribute("width","30"),E.setAttribute("fill",Q.invertedText),E.setAttribute("text-anchor","start"),E.setAttribute("dominant-baseline","central"),E.setAttribute("pointer-events","none"),E.textContent=""+(d+1),this._svgNoteContainer.appendChild(E)}}if(u.song.getChannelIsMod(u.channel)&&this._mouseDragging&&!this._mouseHorizontal&&s==this._cursor.curNote){this.modDragValueLabel.style.setProperty("display",""),this.modDragValueLabel.style.setProperty("pointer-events","none"),this.modDragValueLabel.setAttribute("contenteditable","false"),this.modDragValueLabel.style.setProperty("color","#FFFFFF");let d=u.song.channels[u.channel].instruments[u.getCurrentInstrument(this._barOffset)].modulators[w.modCount-1-s.pitches[0]],c=this._dragSize+w.modulators[d].convertRealFactor,_=+(c>=10)+ +(c>=100)+ +(c<0)+ +(c<=-10);this._modDragValueLabelWidth=8+_*8,this._modDragValueLabelLeft=+Le(Math.max(Math.min(this._editorWidth-10-_*8,this._partWidth*this._dragTime-4-_*4),2)),this._modDragValueLabelTop=+Le(this._pitchToPixelHeight(s.pitches[0]-this._octaveOffset)-17-(this._pitchHeight-this._pitchBorder)/2),this.modDragValueLabel.style.setProperty("left",""+this._modDragValueLabelLeft+"px"),this.modDragValueLabel.style.setProperty("top",""+this._modDragValueLabelTop+"px"),this.modDragValueLabel.textContent=""+c}}}u.currentPatternIsDirty=!1}_drawNote(e,t,n,i,s,h,d){const c=this._partWidth*(i[i.length-1].time+i[0].time),_=.5*Math.min(2,c-1);let m=i[0];const g=u.song.getVolumeCap(u.song.getChannelIsMod(u.channel),u.channel,u.getCurrentInstrument(this._barOffset),t);let S="M "+Le(this._partWidth*(n+m.time)+_)+" "+Le(this._pitchToPixelHeight(t-d)+s*(h?m.size/g:1))+" ";for(let E=1;E<i.length;E++){let A=m;m=i[E];let C=this._partWidth*(n+A.time)+(E==1?_:0),k=this._partWidth*(n+m.time)-(E==i.length-1?_:0),T=this._pitchToPixelHeight(t+A.interval-d),b=this._pitchToPixelHeight(t+m.interval-d),R=h?A.size/g:1,V=h?m.size/g:1;S+="L "+Le(C)+" "+Le(T-s*R)+" ",A.interval>m.interval&&(S+="L "+Le(C+1)+" "+Le(T-s*R)+" "),A.interval<m.interval&&(S+="L "+Le(k-1)+" "+Le(b-s*V)+" "),S+="L "+Le(k)+" "+Le(b-s*V)+" "}for(let E=i.length-2;E>=0;E--){let A=m;m=i[E];let C=this._partWidth*(n+A.time)-(E==i.length-2?_:0),k=this._partWidth*(n+m.time)+(E==0?_:0),T=this._pitchToPixelHeight(t+A.interval-d),b=this._pitchToPixelHeight(t+m.interval-d),R=h?A.size/g:1,V=h?m.size/g:1;S+="L "+Le(C)+" "+Le(T+s*R)+" ",A.interval<m.interval&&(S+="L "+Le(C-1)+" "+Le(T+s*R)+" "),A.interval>m.interval&&(S+="L "+Le(k+1)+" "+Le(b+s*V)+" "),S+="L "+Le(k)+" "+Le(b+s*V)+" "}S+="z",e.setAttribute("d",S)}_pitchToPixelHeight(e){return this._pitchHeight*(this._pitchCount-e-.5)}}class ja{constructor(e){a(this,"_pianoContainer",Ke.div({style:"width: 100%; height: 100%; display: flex; flex-direction: column-reverse; align-items: stretch;"}));a(this,"_drumContainer",Ke.div({style:"width: 100%; height: 100%; display: flex; flex-direction: column-reverse; align-items: stretch;"}));a(this,"_modContainer",Ke.div({style:"width: 100%; height: 100%; display: flex; flex-direction: column-reverse; align-items: stretch;"}));a(this,"_preview",Ke.div({style:`width: 100%; height: 40px; border: 2px solid ${Q.primaryText}; position: absolute; box-sizing: border-box; pointer-events: none;`}));a(this,"container",Ke.div({style:"width: 32px; height: 100%; overflow: hidden; position: relative; flex-shrink: 0; touch-action: none;"},this._pianoContainer,this._drumContainer,this._modContainer,this._preview));a(this,"_editorHeight",481);a(this,"_pianoKeys",[]);a(this,"_pianoLabels",[]);a(this,"_modFirstLabels",[]);a(this,"_modSecondLabels",[]);a(this,"_modCountLabels",[]);a(this,"_modCountRects",[]);a(this,"_pitchHeight",0);a(this,"_pitchCount",0);a(this,"_mouseY",0);a(this,"_mouseDown",!1);a(this,"_mouseOver",!1);a(this,"_cursorPitch",0);a(this,"_playedPitch",-1);a(this,"_renderedScale",-1);a(this,"_renderedDrums",!1);a(this,"_renderedMod",!1);a(this,"_renderedKey",-1);a(this,"_renderedPitchCount",-1);a(this,"_renderedLiveInputPitches",[]);a(this,"_whenMouseOver",e=>{this._mouseOver||(this._mouseOver=!0,this._updatePreview())});a(this,"_whenMouseOut",e=>{this._mouseOver&&(this._mouseOver=!1,this._updatePreview())});a(this,"_whenMousePressed",e=>{e.preventDefault(),this._doc.synth.maintainLiveInput(),this._mouseDown=!0;const t=this.container.getBoundingClientRect();this._mouseY=((e.clientY||e.pageY)-t.top)*this._editorHeight/(t.bottom-t.top),isNaN(this._mouseY)&&(this._mouseY=0),this._updateCursorPitch(),this._playLiveInput(),this._updatePreview()});a(this,"_whenMouseMoved",e=>{(this._mouseDown||this._mouseOver)&&this._doc.synth.maintainLiveInput();const t=this.container.getBoundingClientRect();this._mouseY=((e.clientY||e.pageY)-t.top)*this._editorHeight/(t.bottom-t.top),isNaN(this._mouseY)&&(this._mouseY=0),this._updateCursorPitch(),this._mouseDown&&this._playLiveInput(),this._updatePreview()});a(this,"_whenMouseReleased",e=>{this._mouseDown&&this._releaseLiveInput(),this._mouseDown=!1,this._updatePreview()});a(this,"_whenTouchPressed",e=>{e.preventDefault(),this._doc.synth.maintainLiveInput(),this._mouseDown=!0;const t=this.container.getBoundingClientRect();this._mouseY=(e.touches[0].clientY-t.top)*this._editorHeight/(t.bottom-t.top),isNaN(this._mouseY)&&(this._mouseY=0),this._updateCursorPitch(),this._playLiveInput()});a(this,"_whenTouchMoved",e=>{e.preventDefault(),this._doc.synth.maintainLiveInput();const t=this.container.getBoundingClientRect();this._mouseY=(e.touches[0].clientY-t.top)*this._editorHeight/(t.bottom-t.top),isNaN(this._mouseY)&&(this._mouseY=0),this._updateCursorPitch(),this._mouseDown&&this._playLiveInput()});a(this,"_whenTouchReleased",e=>{e.preventDefault(),this._mouseDown=!1,this._releaseLiveInput()});a(this,"_onAnimationFrame",()=>{window.requestAnimationFrame(this._onAnimationFrame);let e=!1;const t=this._doc.performance.pitchesAreTemporary()?0:this._doc.synth.liveInputPitches.length;this._renderedLiveInputPitches.length!=t&&(e=!0);for(let n=0;n<t;n++)this._renderedLiveInputPitches[n]!=this._doc.synth.liveInputPitches[n]&&(this._renderedLiveInputPitches[n]=this._doc.synth.liveInputPitches[n],e=!0);this._renderedLiveInputPitches.length=t,e&&this._updatePreview()});a(this,"_documentChanged",()=>{const e=this._doc.song.getChannelIsNoise(this._doc.channel),t=this._doc.song.getChannelIsMod(this._doc.channel);if(this._pitchCount=t?w.modCount:e?w.drumCount:this._doc.getVisiblePitchCount(),this._pitchHeight=this._editorHeight/this._pitchCount,this._updateCursorPitch(),this._mouseDown&&this._playLiveInput(),!this._doc.prefs.showLetters||this._renderedScale==this._doc.song.scale&&this._renderedKey==this._doc.song.key&&this._renderedDrums==e&&this._renderedMod==t&&this._renderedPitchCount==this._pitchCount)return;this._renderedScale=this._doc.song.scale,this._renderedKey=this._doc.song.key,this._renderedDrums=e,this._renderedMod=t;const n=this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()];if(this._pianoContainer.style.display=e||t?"none":"flex",this._drumContainer.style.display=e?"flex":"none",this._modContainer.style.display=t?"flex":"none",!e&&!t){if(this._renderedPitchCount!=this._pitchCount){this._pianoContainer.innerHTML="";for(let d=0;d<this._pitchCount;d++){const c=Ke.div({class:"piano-label",style:"font-weight: bold; -webkit-text-stroke-width: 0; font-size: 11px; font-family: sans-serif; position: absolute; padding-left: 15px;"}),_=Ke.div({class:"piano-button",style:"background: gray;"},c);this._pianoContainer.appendChild(_),this._pianoLabels[d]=c,this._pianoKeys[d]=_}this._pianoLabels.length=this._pitchCount,this._pianoKeys.length=this._pitchCount,this._renderedPitchCount=this._pitchCount}for(let d=0;d<this._pitchCount;d++){const c=(d+w.keys[this._doc.song.key].basePitch)%w.pitchesPerOctave,_=w.keys[c].isWhiteKey;if(this._pianoKeys[d].style.background=_?Q.whitePianoKey:Q.blackPianoKey,!w.scales[this._doc.song.scale].flags[d%w.pitchesPerOctave])this._pianoKeys[d].classList.add("disabled"),this._pianoLabels[d].style.display="none";else{this._pianoKeys[d].classList.remove("disabled"),this._pianoLabels[d].style.display="";const m=this._pianoLabels[d];d%12==0?m.style.transform="translate(-5px, 0px)":m.style.transform="translate(0px, 0px)",m.style.color=w.keys[c].isWhiteKey?"black":"white",m.textContent=ja.getPitchName(c,d,this._doc.getBaseVisibleOctave(this._doc.channel))}}}else if(t){let d="",c="",_=Q.modLabelPrimaryText,m=Q.modLabelSecondaryText;for(let g=0;g<w.modCount;g++){let S=!0,E=!0,A=n.modInstruments[w.modCount-g-1]+1,C=n.modChannels[w.modCount-g-1]+1,k=n.modulators[w.modCount-g-1],T=1+ +(C-1>=this._doc.song.pitchChannelCount);n.modChannels[w.modCount-g-1]==-2?T=0:n.modChannels[w.modCount-g-1]==-1&&(T=3);let b=this._doc.song.channels[Math.max(0,C-1)].instruments.length;switch(T){case 0:d="Mod",S=!1,m=Q.modLabelSecondaryText,E=!1;break;case 1:if(this._doc.song.channels[C-1].name=="")b>1?C>=10||A>=10?(d="P"+C,A-1==b?d+=" All":A-1>b?d+=" Act":d+=" I"+A):(d="Pitch"+C,A-1==b?d+=" All":A-1>b?d+=" Act":d+=" Ins"+A):d="Pitch "+C;else{let l;A-1==b?l=" All":A-1>b?l=" Act":l=" I"+A,b>1?d="P"+C+" "+this._doc.song.channels[C-1].name+l:d="P"+C+" "+this._doc.song.channels[C-1].name}break;case 2:if(C=n.modChannels[w.modCount-g-1]+1-this._doc.song.pitchChannelCount,b=this._doc.song.channels[C-1].instruments.length,this._doc.song.channels[C-1].name=="")b>1?C>=10||A>=10?(d="N"+C,A-1==b?d+=" All":A-1>b?d+=" Act":d+=" I"+A):(d="Noise"+C,A-1==b?d+=" All":A-1>b?d+=" Act":d+=" Ins"+A):d="Noise "+C;else if(b>1){let l;A-1==b?l=" All":A-1>b?l=" Act":l=" I"+A,d="N"+C+" "+this._doc.song.channels[C-1].name+l}else d="N"+C+" "+this._doc.song.channels[C-1].name;break;case 3:d="Song";break}if(S){if(c=w.modulators[k].pianoName,k==w.modulators.dictionary.none.index)m=Q.modLabelSecondaryText,E=!1;else if(k==w.modulators.dictionary["eq filter"].index||k==w.modulators.dictionary["note filter"].index){var i=" Morph",s=n.modFilterTypes[w.modCount-g-1];s>0&&s%2?i=" Dot"+Math.ceil(s/2)+"X":s>0&&(i=" Dot"+Math.ceil(s/2)+"Y"),c+=i}}const R=this._modFirstLabels[g],V=this._modSecondLabels[g],f=this._modCountLabels[g],D=this._modCountRects[g];if(R.style.fill=_,R.textContent=d,V.style.fill=m,V.textContent=S?c:"Not set",f.textContent=""+(w.modCount-g),D.style.fill=E?Q.indicatorPrimary:Q.modLabelSecondaryText,this._doc.song.channels[Math.max(0,n.modChannels[w.modCount-g-1])].name!=""){let l="1",W=R.parentElement.parentElement.getBoundingClientRect().height,L=R.getComputedTextLength(),P=0;for(L>W-8?(l="0.65",P=2):L>W-24&&(l="0.8",P=1),R.style.transform="rotate(-90deg) translate("+(-20-P-Math.round(Math.max(0,(W-80)/2)))+"px, 39px) scale("+l+", 1)";l=="0.65"&&R.getComputedTextLength()>W+8;){var h=4+(A>=10?1:0);R.textContent=R.textContent.substr(0,R.textContent.length-h)+R.textContent.substr(R.textContent.length-h+1)}}else{let l=R.parentElement.parentElement.getBoundingClientRect().height;R.style.transform="rotate(-90deg) translate("+(-20-Math.round(Math.max(0,(l-80)/2)))+"px, 39px) scale(1, 1)"}}}this._updatePreview()});this._doc=e;for(let t=0;t<w.drumCount;t++){const n=(1-t/w.drumCount*.35)*100;this._drumContainer.appendChild(Ke.div({class:"drum-button",style:`background-size: ${n}% ${n}%;`}))}for(let t=0;t<w.modCount;t++){const n=me.text({class:"modulator-label","text-anchor":"left",fill:Q.modLabelPrimaryText,style:"font-weight: bold; align-self: flex-start; transform-origin: center; transform: rotate(-90deg) translate(-19px, 39px); font-size: 11px; font-family: sans-serif;"}),i=me.text({class:"modulator-label","text-anchor":"left",fill:Q.modLabelPrimaryText,style:"font-weight: bold; align-self: flex-end; transform-origin: center; transform: rotate(-90deg) translate(-26px, 42px); font-size: 11px; font-family: sans-serif;"}),s=me.text({class:"modulator-inverse-label",fill:Q.modLabelPrimary,style:"font-weight: bold; align-self: flex-start; transform-origin: center; transform: rotate(-90deg) translate(4px, 13px); font-size: 11px; font-family: sans-serif;"}),h=me.rect({width:"12px",height:"9px",fill:Q.indicatorPrimary,style:"pointer-events: none; transform: translate(4px, 4px);"}),d=me.svg({viewBox:"0 0 16 66",width:"16px",style:"pointer-events: none; flex-grow: 1;"},[n]),c=me.svg({viewBox:"0 0 16 14",width:"16px",style:"pointer-events: none;"},[h,s]),_=me.svg({viewBox:"0 0 16 80",width:"16px",style:"pointer-events: none;"},[i]),m=Ke.div({style:"display: flex; flex-direction: column; justify-content: space-between; pointer-events: none;"},[c,d]),g=Ke.div({style:"display: flex; flex-direction: column-reverse; justify-content: space-between; pointer-events: none;"},[_]),S=Ke.div({style:"display: flex; flex-direction: row; justify-content: space-between; padding: 0px; width: 32px; height: 100%; overflow: hidden; pointer-events: none;"},[m,g]),E=Ke.div({class:"modulator-button",style:"background: "+Q.modLabelPrimary+";"},S);this._modContainer.appendChild(E),this._modFirstLabels.push(n),this._modSecondLabels.push(i),this._modCountLabels.push(s),this._modCountRects.push(h)}this.container.addEventListener("mousedown",this._whenMousePressed),document.addEventListener("mousemove",this._whenMouseMoved),document.addEventListener("mouseup",this._whenMouseReleased),this.container.addEventListener("mouseover",this._whenMouseOver),this.container.addEventListener("mouseout",this._whenMouseOut),this.container.addEventListener("touchstart",this._whenTouchPressed),this.container.addEventListener("touchmove",this._whenTouchMoved),this.container.addEventListener("touchend",this._whenTouchReleased),this.container.addEventListener("touchcancel",this._whenTouchReleased),this._doc.notifier.watch(this._documentChanged),this._documentChanged(),window.requestAnimationFrame(this._onAnimationFrame)}forceRender(){this._renderedScale=-1,this._documentChanged()}_updateCursorPitch(){const e=w.scales[this._doc.song.scale].flags,t=Math.max(0,Math.min(this._pitchCount-1,this._pitchCount-this._mouseY/this._pitchHeight));if(e[Math.floor(t)%w.pitchesPerOctave]||this._doc.song.getChannelIsNoise(this._doc.channel))this._cursorPitch=Math.floor(t);else{let n=Math.floor(t)+1,i=Math.floor(t)-1;for(;!e[n%w.pitchesPerOctave];)n++;for(;!e[i%w.pitchesPerOctave];)i--;let s=n,h=i+1;(n%w.pitchesPerOctave==0||n%w.pitchesPerOctave==7)&&(s-=.5),(i%w.pitchesPerOctave==0||i%w.pitchesPerOctave==7)&&(h+=.5),this._cursorPitch=t-h>s-t?n:i}}_playLiveInput(){const e=this._doc.getBaseVisibleOctave(this._doc.channel)*w.pitchesPerOctave,t=this._cursorPitch+e;this._playedPitch!=t&&(this._doc.performance.removePerformedPitch(this._playedPitch),this._playedPitch=t,this._doc.performance.addPerformedPitch(t))}_releaseLiveInput(){this._doc.performance.removePerformedPitch(this._playedPitch),this._playedPitch=-1}_updatePreview(){if(this._preview.style.visibility=!this._mouseOver||this._mouseDown?"hidden":"visible",this._mouseOver&&!this._mouseDown){const i=this.container.getBoundingClientRect(),s=this._pitchHeight/(this._editorHeight/(i.bottom-i.top));this._preview.style.left="0px",this._preview.style.top=s*(this._pitchCount-this._cursorPitch-1)+"px",this._preview.style.height=s+"px"}const e=this._doc.getBaseVisibleOctave(this._doc.channel)*w.pitchesPerOctave,n=(this._doc.song.getChannelIsNoise(this._doc.channel)?this._drumContainer:this._pianoContainer).children;for(let i=0;i<n.length;i++){const s=n[i];this._renderedLiveInputPitches.indexOf(i+e)==-1?s.classList.remove("pressed"):s.classList.add("pressed")}}static getPitchName(e,t,n){let i;if(w.keys[e].isWhiteKey)i=w.keys[e].name;else{const s=w.blackKeyNameParents[t%w.pitchesPerOctave];i=w.keys[(e+w.pitchesPerOctave+s)%w.pitchesPerOctave].name,s==1?i+="":s==-1&&(i+="")}return t%12==0&&(i+=Math.floor(t/12)+n),i}}const{button:Pc,div:Kr,span:g_,h2:v_,input:b_,br:y_,select:w_,option:Ec}=Ke;class hr{constructor(e){a(this,"_barsStepper",b_({style:"width: 3em; margin-left: 1em;",type:"number",step:"1"}));a(this,"_positionSelect",w_({style:"width: 100%;"},Ec({value:"end"},"Apply change at end of song."),Ec({value:"beginning"},"Apply change at beginning of song.")));a(this,"_cancelButton",Pc({class:"cancelButton"}));a(this,"_okayButton",Pc({class:"okayButton",style:"width:45%;"},"Okay"));a(this,"container",Kr({class:"prompt noSelection",style:"width: 250px;"},v_("Song Length"),Kr({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},Kr({style:"display: inline-block; text-align: right;"},"Bars per song:",y_(),g_({style:`font-size: smaller; color: ${Q.secondaryText};`},"(Multiples of 4 are recommended)")),this._barsStepper),Kr({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},Kr({class:"selectContainer",style:"width: 100%;"},this._positionSelect)),Kr({style:"display: flex; flex-direction: row-reverse; justify-content: space-between;"},this._okayButton),this._cancelButton));a(this,"_close",()=>{this._doc.undo()});a(this,"cleanUp",()=>{this._okayButton.removeEventListener("click",this._saveChanges),this._cancelButton.removeEventListener("click",this._close),this._barsStepper.removeEventListener("keypress",hr._validateKey),this._barsStepper.removeEventListener("blur",hr._validateNumber),this.container.removeEventListener("keydown",this._whenKeyPressed)});a(this,"_whenKeyPressed",e=>{e.target.tagName!="BUTTON"&&e.keyCode==13&&this._saveChanges()});a(this,"_saveChanges",()=>{window.localStorage.setItem("barCountPosition",this._positionSelect.value);const e=new Zt;e.append(new hf(this._doc,hr._validate(this._barsStepper),this._positionSelect.value=="beginning")),this._doc.prompt=null,this._doc.record(e,!0)});this._doc=e,this._barsStepper.value=this._doc.song.barCount+"",this._barsStepper.min=w.barCountMin+"",this._barsStepper.max=w.barCountMax+"";const t=window.localStorage.getItem("barCountPosition");t!=null&&(this._positionSelect.value=t),this._barsStepper.select(),setTimeout(()=>this._barsStepper.focus()),this._okayButton.addEventListener("click",this._saveChanges),this._cancelButton.addEventListener("click",this._close),this._barsStepper.addEventListener("keypress",hr._validateKey),this._barsStepper.addEventListener("blur",hr._validateNumber),this.container.addEventListener("keydown",this._whenKeyPressed)}static _validateKey(e){const t=e.which?e.which:e.keyCode;return t!=46&&t>31&&(t<48||t>57)?(e.preventDefault(),!0):!1}static _validateNumber(e){const t=e.target;t.value=String(hr._validate(t))}static _validate(e){return Math.floor(Math.max(Number(e.min),Math.min(Number(e.max),Number(e.value))))}}const{button:x_,div:Co,h2:S_,p:Bl,select:C_,option:k_,iframe:P_}=Ke;class E_{constructor(e){a(this,"_songContainer",Co());a(this,"_cancelButton",x_({class:"cancelButton"}));a(this,"container",Co({class:"prompt",style:"width: 300px;"},S_("Song Recovery"),Co({style:"max-height: 385px; overflow-y: auto;"},Bl("This is a TEMPORARY list of songs you have recently modified. Please keep your own backups of songs you care about!"),this._songContainer,Bl(`(If "Display Song Data in URL" is enabled in your preferences, then you may also be able to find song versions in your browser history. However, song recovery won't work if you were browsing in private/incognito mode.)`)),this._cancelButton));a(this,"_close",()=>{this._doc.undo()});a(this,"cleanUp",()=>{this._cancelButton.removeEventListener("click",this._close)});this._doc=e,this._cancelButton.addEventListener("click",this._close);const t=Ya.getAllRecoveredSongs();t.length==0&&this._songContainer.appendChild(Bl("There are no recovered songs available yet. Try making a song!"));for(const n of t){const i=C_({style:"width: 100%;"});for(const d of n.versions)i.appendChild(k_({value:d.time},d.name+": "+new Date(d.time).toLocaleString()));const s=P_({style:"width: 100%; height: 60px; border: none; display: block;"});s.src="player/#song="+window.localStorage.getItem(Lo(n.versions[0]));const h=Co({style:"margin: 4px 0;"},Co({class:"selectContainer",style:"width: 100%; margin: 2px 0;"},i),s);this._songContainer.appendChild(h),i.addEventListener("change",()=>{const d=n.versions[i.selectedIndex];s.contentWindow.location.replace("player/#song="+window.localStorage.getItem(Lo(d))),s.contentWindow.dispatchEvent(new Event("hashchange"))})}}}const{button:Bc,label:Os,div:Hs,p:Gr,a:Ml,h2:B_,input:Zr,select:Mc,option:nr}=Ke;class M_{constructor(e){a(this,"_keyboardMode",Mc({style:"width: 100%;"},nr({value:"useCapsLockForNotes"},"simple shortcuts, use caps lock to play notes"),nr({value:"pressControlForShortcuts"},"simple notes, press "+Lt.ctrlName+" for shortcuts")));a(this,"_keyboardLayout",Mc({style:"width: 100%;"},nr({value:"wickiHayden"},"Wicki-Hayden"),nr({value:"songScale"},"selected song scale"),nr({value:"pianoAtC"},"piano starting at C :)"),nr({value:"pianoAtA"},"piano starting at A :("),nr({value:"pianoTransposingC"},"piano transposing C :) to song key"),nr({value:"pianoTransposingA"},"piano transposing A :( to song key")));a(this,"_keyboardLayoutPreview",Hs({style:"display: grid; row-gap: 4px; margin: 4px auto; font-size: 10px;"}));a(this,"_enableMidi",Zr({style:"width: 2em; margin-left: 1em;",type:"checkbox"}));a(this,"_showRecordButton",Zr({style:"width: 2em; margin-left: 1em;",type:"checkbox"}));a(this,"_snapRecordedNotesToRhythm",Zr({style:"width: 2em; margin-left: 1em;",type:"checkbox"}));a(this,"_ignorePerformedNotesNotInScale",Zr({style:"width: 2em; margin-left: 1em;",type:"checkbox"}));a(this,"_metronomeCountIn",Zr({style:"width: 2em; margin-left: 1em;",type:"checkbox"}));a(this,"_metronomeWhileRecording",Zr({style:"width: 2em; margin-left: 1em;",type:"checkbox"}));a(this,"_okayButton",Bc({class:"okayButton",style:"width:45%;"},"Okay"));a(this,"_cancelButton",Bc({class:"cancelButton"}));a(this,"container",Hs({class:"prompt noSelection recordingSetupPrompt",style:"width: 333px; text-align: right; max-height: 90%;"},B_("Note Recording Setup"),Hs({style:"display: grid; overflow-y: auto; overflow-x: hidden; flex-shrink: 1;"},Gr("BeepBox can record notes as you perform them. You can start recording by pressing Ctrl+Space (or "+Lt.ctrlSymbol+"P)."),Os({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},"Add  record button next to  play button:",this._showRecordButton),Os({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},"Snap recorded notes to the song's rhythm:",this._snapRecordedNotesToRhythm),Os({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},"Ignore notes not in the song's scale:",this._ignorePerformedNotesNotInScale),Gr("While recording, you can perform notes on your keyboard!"),Os({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},"Keyboard layout:",Hs({class:"selectContainer",style:"width: 65%; margin-left: 1em;"},this._keyboardLayout)),this._keyboardLayoutPreview,Gr("When not recording, you can use the computer keyboard either for shortcuts (like C and V for copy and paste) or for performing notes, depending on this mode:"),Os({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},Hs({class:"selectContainer",style:"width: 100%;"},this._keyboardMode)),Gr("Performing music takes practice! Try slowing the tempo and using this metronome to help you keep a rhythm."),Os({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},"Hear metronome while recording:",this._metronomeWhileRecording),Os({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},"Count-in 1 bar of metronome before recording:",this._metronomeCountIn),Gr("If you have a ",Ml({href:"https://caniuse.com/midi",target:"_blank"},"compatible browser")," on a device connected to a MIDI keyboard, you can use it to perform notes in BeepBox! (Or you could buy ",Ml({href:"https://imitone.com/",target:"_blank"},"Imitone")," or ",Ml({href:"https://vochlea.com/",target:"_blank"},"Dubler")," to hum notes into a microphone while wearing headphones!)"),Os({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},"Enable MIDI performance:",this._enableMidi),Gr('Tip: Recorded notes often overlap such that one note ends after the next note already started. In BeepBox, these notes get split into two notes which may sound different when re-played than they did when you were recording. To fix the sound, you can either manually clean up the notes in the pattern editor, or you could try enabling the "transition type" effect on the instrument and setting it to "continue".'),Hs({style:`width: 100%; height: 80px; background: linear-gradient(rgba(0,0,0,0), ${Q.editorBackground}); position: sticky; bottom: 0; pointer-events: none;`})),Os({style:"display: flex; flex-direction: row-reverse; justify-content: space-between;"},this._okayButton),this._cancelButton));a(this,"_close",()=>{this._doc.undo()});a(this,"cleanUp",()=>{this._okayButton.removeEventListener("click",this._confirm),this._cancelButton.removeEventListener("click",this._close),this.container.removeEventListener("keydown",this._whenKeyPressed)});a(this,"_whenKeyPressed",e=>{e.target.tagName!="BUTTON"&&e.keyCode==13&&this._confirm()});a(this,"_confirm",()=>{this._doc.prefs.pressControlForShortcuts=this._keyboardMode.value=="pressControlForShortcuts",this._doc.prefs.keyboardLayout=this._keyboardLayout.value,this._doc.prefs.enableMidi=this._enableMidi.checked,this._doc.prefs.showRecordButton=this._showRecordButton.checked,this._doc.prefs.snapRecordedNotesToRhythm=this._snapRecordedNotesToRhythm.checked,this._doc.prefs.ignorePerformedNotesNotInScale=this._ignorePerformedNotesNotInScale.checked,this._doc.prefs.metronomeCountIn=this._metronomeCountIn.checked,this._doc.prefs.metronomeWhileRecording=this._metronomeWhileRecording.checked,this._doc.prefs.save(),this._close()});a(this,"_renderKeyboardLayoutPreview",()=>{for(;this._keyboardLayoutPreview.firstChild;)this._keyboardLayoutPreview.removeChild(this._keyboardLayoutPreview.firstChild);const e=[12,12,11,10],t=w.scales[this._doc.song.scale].flags;for(let n=0;n<4;n++){const i=Hs({style:"display: flex;"});this._keyboardLayoutPreview.appendChild(i);const s=Hs({style:"width: "+n*12+"px; height: 20px; flex-shrink: 0;"});i.appendChild(s);for(let h=0;h<e[n];h++){const d=Hs({style:"width: 20px; height: 20px; margin: 0 2px; box-sizing: border-box; flex-shrink: 0; display: flex; justify-content: center; align-items: center;"});i.appendChild(d);const c=Da.keyPosToPitch(this._doc,h,3-n,this._keyboardLayout.value);if(c!=null){const _=c%12;t[_]?_==0?d.style.background=Q.tonic:_==7&&this._doc.prefs.showFifth?d.style.background=Q.fifthNote:d.style.background=Q.pitchBackground:d.style.border="2px solid "+Q.pitchBackground;const m=(_+w.keys[this._doc.song.key].basePitch)%w.pitchesPerOctave;d.textContent=ja.getPitchName(m,_,Math.floor(c/12))}}}});this._doc=e,this._keyboardMode.value=this._doc.prefs.pressControlForShortcuts?"pressControlForShortcuts":"useCapsLockForNotes",this._keyboardLayout.value=this._doc.prefs.keyboardLayout,this._enableMidi.checked=this._doc.prefs.enableMidi,this._showRecordButton.checked=this._doc.prefs.showRecordButton,this._snapRecordedNotesToRhythm.checked=this._doc.prefs.snapRecordedNotesToRhythm,this._ignorePerformedNotesNotInScale.checked=this._doc.prefs.ignorePerformedNotesNotInScale,this._metronomeCountIn.checked=this._doc.prefs.metronomeCountIn,this._metronomeWhileRecording.checked=this._doc.prefs.metronomeWhileRecording,setTimeout(()=>this._showRecordButton.focus()),this._okayButton.addEventListener("click",this._confirm),this._cancelButton.addEventListener("click",this._close),this.container.addEventListener("keydown",this._whenKeyPressed),this._renderKeyboardLayoutPreview(),this._keyboardLayout.addEventListener("change",this._renderKeyboardLayoutPreview)}}class Tc{constructor(e,t){a(this,"_editorWidth",120);a(this,"_editorHeight",26);a(this,"_fill",me.path({fill:Q.uiWidgetBackground,"pointer-events":"none"}));a(this,"_octaves",me.svg({"pointer-events":"none"}));a(this,"_fifths",me.svg({"pointer-events":"none"}));a(this,"_curve",me.path({fill:"none",stroke:"currentColor","stroke-width":2,"pointer-events":"none"}));a(this,"_arrow",me.path({fill:"currentColor","pointer-events":"none"}));a(this,"_svg",me.svg({style:`background-color: ${Q.editorBackground}; touch-action: none; cursor: crosshair;`,width:"100%",height:"100%",viewBox:"0 0 "+this._editorWidth+" "+this._editorHeight,preserveAspectRatio:"none"},this._fill,this._octaves,this._fifths,this._curve,this._arrow));a(this,"container",Ke.div({class:"spectrum",style:"height: 100%;"},this._svg));a(this,"_mouseX",0);a(this,"_mouseY",0);a(this,"_freqPrev",0);a(this,"_ampPrev",0);a(this,"_mouseDown",!1);a(this,"_change",null);a(this,"_renderedPath","");a(this,"_renderedFifths",!0);a(this,"_whenMousePressed",e=>{e.preventDefault(),this._mouseDown=!0;const t=this._svg.getBoundingClientRect();this._mouseX=((e.clientX||e.pageX)-t.left)*this._editorWidth/(t.right-t.left),this._mouseY=((e.clientY||e.pageY)-t.top)*this._editorHeight/(t.bottom-t.top),isNaN(this._mouseX)&&(this._mouseX=0),isNaN(this._mouseY)&&(this._mouseY=0),this._freqPrev=this._xToFreq(this._mouseX),this._ampPrev=this._yToAmp(this._mouseY),this._whenCursorMoved()});a(this,"_whenTouchPressed",e=>{e.preventDefault(),this._mouseDown=!0;const t=this._svg.getBoundingClientRect();this._mouseX=(e.touches[0].clientX-t.left)*this._editorWidth/(t.right-t.left),this._mouseY=(e.touches[0].clientY-t.top)*this._editorHeight/(t.bottom-t.top),isNaN(this._mouseX)&&(this._mouseX=0),isNaN(this._mouseY)&&(this._mouseY=0),this._freqPrev=this._xToFreq(this._mouseX),this._ampPrev=this._yToAmp(this._mouseY),this._whenCursorMoved()});a(this,"_whenMouseMoved",e=>{if(this.container.offsetParent==null)return;const t=this._svg.getBoundingClientRect();this._mouseX=((e.clientX||e.pageX)-t.left)*this._editorWidth/(t.right-t.left),this._mouseY=((e.clientY||e.pageY)-t.top)*this._editorHeight/(t.bottom-t.top),isNaN(this._mouseX)&&(this._mouseX=0),isNaN(this._mouseY)&&(this._mouseY=0),this._whenCursorMoved()});a(this,"_whenTouchMoved",e=>{if(this.container.offsetParent==null||!this._mouseDown)return;e.preventDefault();const t=this._svg.getBoundingClientRect();this._mouseX=(e.touches[0].clientX-t.left)*this._editorWidth/(t.right-t.left),this._mouseY=(e.touches[0].clientY-t.top)*this._editorHeight/(t.bottom-t.top),isNaN(this._mouseX)&&(this._mouseX=0),isNaN(this._mouseY)&&(this._mouseY=0),this._whenCursorMoved()});a(this,"_whenCursorReleased",e=>{this._mouseDown&&(this._doc.record(this._change),this._change=null),this._mouseDown=!1});this._doc=e,this._spectrumIndex=t;for(let n=0;n<w.spectrumControlPoints;n+=w.spectrumControlPointsPerOctave)this._octaves.appendChild(me.rect({fill:Q.tonic,x:(n+1)*this._editorWidth/(w.spectrumControlPoints+2)-1,y:0,width:2,height:this._editorHeight}));for(let n=4;n<=w.spectrumControlPoints;n+=w.spectrumControlPointsPerOctave)this._fifths.appendChild(me.rect({fill:Q.fifthNote,x:(n+1)*this._editorWidth/(w.spectrumControlPoints+2)-1,y:0,width:2,height:this._editorHeight}));this.container.addEventListener("mousedown",this._whenMousePressed),document.addEventListener("mousemove",this._whenMouseMoved),document.addEventListener("mouseup",this._whenCursorReleased),this.container.addEventListener("touchstart",this._whenTouchPressed),this.container.addEventListener("touchmove",this._whenTouchMoved),this.container.addEventListener("touchend",this._whenCursorReleased),this.container.addEventListener("touchcancel",this._whenCursorReleased)}_xToFreq(e){return(w.spectrumControlPoints+2)*e/this._editorWidth-1}_yToAmp(e){return w.spectrumMax*(1-(e-1)/(this._editorHeight-2))}_whenCursorMoved(){if(this._mouseDown){const e=this._xToFreq(this._mouseX),t=this._yToAmp(this._mouseY),n=this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()],i=this._spectrumIndex==null?n.spectrumWave:n.drumsetSpectrumWaves[this._spectrumIndex];if(e!=this._freqPrev){const s=(t-this._ampPrev)/(e-this._freqPrev),h=this._ampPrev-this._freqPrev*s,d=Math.ceil(Math.min(this._freqPrev,e)),c=Math.floor(Math.max(this._freqPrev,e));for(let _=d;_<=c;_++)_<0||_>=w.spectrumControlPoints||(i.spectrum[_]=Math.max(0,Math.min(w.spectrumMax,Math.round(_*s+h))))}i.spectrum[Math.max(0,Math.min(w.spectrumControlPoints-1,Math.round(e)))]=Math.max(0,Math.min(w.spectrumMax,Math.round(t))),this._freqPrev=e,this._ampPrev=t,this._change=new Sf(this._doc,n,i),this._doc.setProspectiveChange(this._change)}}render(){const e=this._doc.song.channels[this._doc.channel].instruments[this._doc.getCurrentInstrument()],t=this._spectrumIndex==null?e.spectrumWave:e.drumsetSpectrumWaves[this._spectrumIndex],n=d=>(1-d/w.spectrumMax)*(this._editorHeight-1)+1;let i=0,s="M 0 "+Le(this._editorHeight)+" ";for(let d=0;d<w.spectrumControlPoints;d++){let c=t.spectrum[d];i!=0||c!=0?s+="L ":s+="M ",s+=Le((d+1)*this._editorWidth/(w.spectrumControlPoints+2))+" "+Le(n(c))+" ",i=c}const h=n(i);i>0&&(s+="L "+(this._editorWidth-1)+" "+Le(h)+" "),this._renderedPath!=s&&(this._renderedPath=s,this._curve.setAttribute("d",s),this._fill.setAttribute("d",s+"L "+this._editorWidth+" "+Le(h)+" L "+this._editorWidth+" "+Le(this._editorHeight)+" L 0 "+Le(this._editorHeight)+" z "),this._arrow.setAttribute("d","M "+this._editorWidth+" "+Le(h)+" L "+(this._editorWidth-4)+" "+Le(h-4)+" L "+(this._editorWidth-4)+" "+Le(h+4)+" z"),this._arrow.style.display=i>0?"":"none"),this._renderedFifths!=this._doc.prefs.showFifth&&(this._renderedFifths=this._doc.prefs.showFifth,this._fifths.style.display=this._doc.prefs.showFifth?"":"none")}}const{button:Ic,div:oa,h2:T_,select:I_,option:pn}=Ke;class A_{constructor(e){a(this,"_themeSelect",I_({style:"width: 100%;"},pn({value:"dark classic"},"BeepBox Dark"),pn({value:"light classic"},"BeepBox Light"),pn({value:"dark competition"},"BeepBox Competition Dark"),pn({value:"jummbox classic"},"JummBox Dark"),pn({value:"forest"},"Forest"),pn({value:"canyon"},"Canyon"),pn({value:"midnight"},"Midnight"),pn({value:"beachcombing"},"Beachcombing"),pn({value:"violet verdant"},"Violet Verdant"),pn({value:"sunset"},"Sunset"),pn({value:"autumn"},"Autumn"),pn({value:"fruit"},"Shadowfruit"),pn({value:"toxic"},"Toxic"),pn({value:"roe"},"Roe"),pn({value:"moonlight"},"Moonlight"),pn({value:"portal"},"Portal"),pn({value:"fusion"},"Fusion"),pn({value:"inverse"},"Inverse"),pn({value:"nebula"},"Nebula"),pn({value:"roe light"},"Roe Light"),pn({value:"energized"},"Energized"),pn({value:"neapolitan"},"Neapolitan"),pn({value:"mono"},"Mono")));a(this,"_cancelButton",Ic({class:"cancelButton"}));a(this,"_okayButton",Ic({class:"okayButton",style:"width:45%;"},"Okay"));a(this,"container",oa({class:"prompt noSelection",style:"width: 220px;"},T_("Set Theme"),oa({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},oa({class:"selectContainer",style:"width: 100%;"},this._themeSelect)),oa({style:"display: flex; flex-direction: row-reverse; justify-content: space-between;"},this._okayButton),this._cancelButton));a(this,"lastTheme",window.localStorage.getItem("colorTheme"));a(this,"_close",()=>{this.lastTheme!=null?Q.setTheme(this.lastTheme):Q.setTheme("dark classic"),this._doc.undo()});a(this,"cleanUp",()=>{this._okayButton.removeEventListener("click",this._saveChanges),this._cancelButton.removeEventListener("click",this._close),this.container.removeEventListener("keydown",this._whenKeyPressed)});a(this,"_whenKeyPressed",e=>{e.target.tagName!="BUTTON"&&e.keyCode==13&&this._saveChanges()});a(this,"_saveChanges",()=>{window.localStorage.setItem("colorTheme",this._themeSelect.value),this._doc.prompt=null,this._doc.prefs.colorTheme=this._themeSelect.value,this._doc.undo()});a(this,"_previewTheme",()=>{Q.setTheme(this._themeSelect.value),this._doc.notifier.changed()});this._doc=e,this.lastTheme!=null&&(this._themeSelect.value=this.lastTheme),this._okayButton.addEventListener("click",this._saveChanges),this._cancelButton.addEventListener("click",this._close),this.container.addEventListener("keydown",this._whenKeyPressed),this._themeSelect.addEventListener("change",this._previewTheme)}}const{button:R_,div:rt,p:Ie,h2:ht,h3:Ac}=Ke;class Tl{constructor(e,t){a(this,"_closeButton",R_({class:"cancelButton"}));a(this,"container");a(this,"_close",()=>{this._doc.undo()});a(this,"cleanUp",()=>{this._closeButton.removeEventListener("click",this._close)});this._doc=e;let n;switch(t){case"scale":n=rt(ht("Scale"),Ie("This setting limits the available pitches for adding notes. You may think that there's no point in limiting your choices, but the set of pitches you use has a strong influence on the mood and feel of your song, and these scales serve as guides to help you choose appropriate pitches. Don't worry, you can change the scale at any time, so you're not locked into it. Try making little melodies using all the available pitches of a scale to get a sense for how it sounds."),Ie('The most common scales are major and minor. Assuming your song uses all pitches in the scale and especially "tonic" pitches (the purple rows in the pattern editor) then major scales tend to sound more playful or optimistic, whereas minor scales sound more serious or sad.'));break;case"key":n=rt(ht("Song Key"),Ie('This setting can shift the frequency of every note in your entire song up or down, keeping the "tonic" pitches (the brown rows in the pattern editor) aligned with the selected "key" pitch.'),Ie(`If you've already placed some notes but they don't emphasize "tonic" pitches then the selected key isn't very meaningful. You can select the "Detect Key" option in the key menu to automatically align the most emphasized notes with "tonic" pitches.`));break;case"tempo":n=rt(ht("Song Tempo"),Ie('This setting controls the speed of your song, measured in beats-per-minute. A "beat" is the duration of the little gray rectangles in the pattern editor. (In conventional music notation, a "quarter note" is usually equivalent to "beat".)'));break;case"reverb":n=rt(ht("Reverb"),Ie(`Reverb is like a continuous echo effect. A little bit helps instruments sound more natural. Adding a lot of reverb can add sense of depth or mystery, but too much reverb can kinda "smear" sounds so that it's harder to distinguish notes or instruments, especially for lower "bass" notes.`));break;case"rhythm":n=rt(ht("Rhythm"),Ie("This setting determines how beats are divided. The pattern editor helps you align notes to fractions of a beat based on this setting."),Ie(`If you've already placed some notes but they don't align with the selected rhythm, you can select the "Snap Notes To Rhythm" option in the rhythm menu to force the notes in the currently selected pattern(s) to align with the selected rhythm.`));break;case"instrumentIndex":n=rt(ht("Instrument Number"),Ie(`In the "Channel Settings" option from JummBox's "File" menu, there are a few ways to enable multiple instruments per channel.`),Ie("First, you could enable multiple simultaneous instruments per channel. All of the channel's instruments will play all of the notes in the channel at the same time, and you can click an instrument number to view and edit its settings."),Ie("Second, you could enable different instruments per pattern. Only one of the instruments will play at any given time, but you can click the instrument number to change which instrument is used for the currently selected pattern(s)."),Ie("Finally, you can enable them both, in which case you can click an instrument number once to view it, and again to toggle whether the instrument is used for the currently selected pattern(s)."),Ie("Either way, you can click the + button to add more instruments to a channel, and you can press shift and a number key on your keyboard to select an instrument as if you had clicked the corresponding button here."));break;case"instrumentVolume":n=rt(ht("Instrument Volume"),Ie("This setting controls the volume of the selected instrument without affecting the volume of the other instruments. This allows you to balance the loudness of each instrument relative to each other."),Ie("Please be careful when using volume settings above 0. This indicates amplification and too much of that can trip the audio limiter built into this tool. This can lead to your song sounding muffled if overused. But when used carefully, amplification can be a powerful tool!"));break;case"pan":n=rt(ht("Instrument Panning"),Ie("If you're listening through headphones or some other stereo sound system, this controls the position of the instrument and where the sound is coming from, ranging from left to right."),Ie("As a suggestion, composers often put lead melodies, drums, and basses in the center, and spread other instruments toward either side. If too many instruments seem like they're coming from the same place, it can feel crowded and harder to distinguish individual sounds, especially if they cover a similar pitch range."));break;case"panDelay":n=rt(ht("Stereo Delay"),Ie("When panning, a slight delay is often added between the left and right ear to help make a sound feel more 'directional'. For example, in the real world your left ear will hear a sound coming from the left just slightly before the right ear."),Ie("This setting controls how much delay is added. When this is set to minimum, panning only affects the volume of the left/right ear without changing the delay. This can help to get a more 'uniform' feeling sound, which can be desirable for making 8-bit music."));break;case"arpeggioSpeed":n=rt(ht("Arpeggio Speed"),Ie("This setting affects how fast your chord will 'arpeggiate', or cycle between notes. With a fast arpeggio speed it will sound rapid-fire, with a slow speed you can hear each note one after another."));break;case"twoNoteArpeggio":n=rt(ht("Faster Two-Note Arpeggio"),Ie("This setting makes arpeggios with only two notes in them happen twice as fast. Arpeggios with more notes in them are unaffected."));break;case"detune":n=rt(ht("Detune"),Ie("This setting can be used to finely control the pitch of your instrument. It is in units of 'cents', 100 of which equal a pitch shift of one semitone."),Ie("Careful - you can quickly get very dissonant sounding songs by using this setting."));break;case"instrumentType":n=rt(ht("Instrument Type"),Ie("JummBox comes with many instrument presets, try them out! You can also create your own custom instruments!"),Ie("There are also options for copying and pasting instrument settings and for generating random instruments at the top of the instrument type menu."));break;case"eqFilter":n=rt(ht("EQ Filter"),Ie("Filters are a way of emphasizing or diminishing different parts of a sound. Musical notes have a fundamental (base) frequency, but the sound of a musical note also has parts at higher frequencies and filters can adjust the volume of each of these parts based on their frequency."),Ie("Click in the filter editor to insert, delete, or drag a filter control point. The horizontal position of the point determines which frequencies it affects, and the vertical position determines how the volume is affected at that frequency."),Ie('Insert a new point on the left side of the filter editor to add a "high-pass" filter point, which additionally reduces the volume of lower frequencies, or insert a new point on the right side to add a "low-pass" filter point which reduces the volume of higher frequencies.'),Ie('You can also enable a "Note Filter" as an effect. EQ and note filters are mostly the same, but have different purposes. EQ filters are for overall adjustments, whereas note filters are for dynamic control and can be moved with envelopes. Note filters also change how the distortion effect sounds.'));break;case"noteFilter":n=rt(ht("Note Filter"),Ie("Note filters are mostly the same as EQ filters, but have a different purpose. EQ filters are for overall adjustments, whereas note filters are for dynamic control and can be moved with envelopes. Note filters also change how the distortion effect sounds."),Ie("Filters are a way of emphasizing or diminishing different parts of a sound. Musical notes have a fundamental (base) frequency, but the sound of a musical note also has parts at higher frequencies and filters can adjust the volume of each of these parts based on their frequency."),Ie("Click in the filter editor to insert, delete, or drag a filter control point. The horizontal position of the point determines which frequencies it affects, and the vertical position determines how the volume is affected at that frequency."),Ie('Insert a new point on the left side of the filter editor to add a "high-pass" filter point, which additionally reduces the volume of lower frequencies, or insert a new point on the right side to add a "low-pass" filter point which reduces the volume of higher frequencies.'));break;case"fadeInOut":n=rt(ht("Fade In/Out"),Ie("This setting controls how long it takes for notes to reach full volume at the beginning or decay to silence at the end."),Ie("An instant fade-in sounds like instruments that are played by hitting or plucking, whereas slower fade-ins sound like instruments that are played by blowing air."),Ie("You can also make the fade-out start before the note ends to leave a gap before the next note starts, or after the note ends to allow the sound of the end of the note to overlap with the start of the next note."));break;case"transition":n=rt(ht("Transition"),Ie("Usually, when one note ends at the same time another begins, the old note will fade out and the new note will fade in based on the fade in/out settings, but this setting can override that, connecting the end of one note to the beginning of the next."),Ie(`The "interrupt" transition makes the wave suddenly change from the old note's frequency to the new note's frequency without any fading, but still restarts envelopes at the beginning of the new note. The "continue" transition is similar but it doesn't even restart envelopes, and can be used to make each of the notes in a chord start or stop at different times!`),Ie(`The "slide" transition makes the pitch shift quickly but not instantaneously from the old note's frequency to the new note's frequency, and softly restarts envelopes. The "slide in pattern" transition is the same except it doesn't connect the last note in a pattern to the first note in the next pattern.`));break;case"chipWave":n=rt(ht("Chip Wave"),Ie("JummBox comes with some sound waves based on classic electronic sound chips, as well as several unique waves. This is the basic source of the sound of the instrument, which is modified by the other instrument settings."));break;case"chipNoise":n=rt(ht("Noise"),Ie("JummBox comes with several basic noise sounds. These do not have any distinct musical pitch, and can be used like drums to create beats and emphasize your song's rhythm."));break;case"pulseWidth":n=rt(ht("Pulse Wave Width"),Ie("This setting controls the shape and sound of a pulse wave. At the minimum width, it sounds light and buzzy. At the maximum width, it is shaped like a classic square wave."));break;case"unison":n=rt(ht("Unison"),Ie("This instrument can play two identical waves at different frequencies. When two waves play at slightly different frequencies, they move in and out of phase with each other over time as different parts of the waves line up. This creates a dynamic, shifting sound. Pianos are a common example of this kind of sound, because each piano key strikes multiple strings that are tuned to slightly different frequencies."),Ie('The distance between two frequencies is called an "interval", and this setting controls how large it is. If the interval is too wide, then the waves may sound out-of-tune and "dissonant". However, if the interval is even larger, then the two frequencies can even be distinct pitches.'));break;case"chords":n=rt(ht("Chords"),Ie("When multiple different notes occur at the same time, this is called a chord. Chords can be created in JummBox's pattern editor by adding notes above or below another note."),Ie('This setting determines how chords are played. The standard option is "simultaneous" which starts playing all of the pitches in a chord at the same instant. The "strum" option is similar, but plays the notes starting at slightly different times. The "arpeggio" option is used in "chiptune" style music and plays a single tone that rapidly alternates between all of the pitches in the chord.'),Ie('Some JummBox instruments have an option called "custom interval" which uses the chord notes to control the interval between the waves of a single tone. This can create strange sound effects when combined with FM modulators.'));break;case"vibrato":n=rt(ht("Vibrato"),Ie("This setting causes the frequency of a note to wobble slightly. Singers and violinists often use vibrato."));break;case"vibratoDepth":n=rt(ht("Vibrato Depth"),Ie("This setting affects the depth of your instrument's vibrato, making the wobbling effect sound stronger or weaker."));break;case"vibratoDelay":n=rt(ht("Vibrato Delay"),Ie("This setting changes when vibrato starts to kick in after a note is played. Vibrato is most common for long held notes and less common in short notes, so this can help you achieve that effect."));break;case"vibratoSpeed":n=rt(ht("Vibrato Speed"),Ie("This setting determines how fast the vibrato's up-and-down wobble effect will happen for your instrument."));break;case"vibratoType":n=rt(ht("Vibrato Type"),Ie("This determines the way vibrato causes your instrument's pitch to wobble. The normal type is smooth up and down, the shaky type is chaotic."));break;case"algorithm":n=rt(ht("FM Algorithm"),Ie("FM Synthesis is a mysterious but powerful technique for crafting sounds, popularized by Yamaha keyboards and the Sega Genesis/Mega Drive. It may seem confusing, but try playing around with the options until you get a feel for it, or check out some of the preset examples!"),Ie("This FM synthesizer uses up to four waves, numbered 1, 2, 3, and 4. Each wave may have its own frequency and volume."),Ie('There are two kinds of waves: "carrier" waves play a tone out loud, but "modulator" waves distort other waves instead. Wave 1 is always a carrier and plays a tone, but other waves may distort it. The "Algorithm" setting determines which waves are modulators, and which other waves those modulators distort. For example, "12" means that wave 2 modulates wave 1, and wave 1 plays out loud.'));break;case"feedbackType":n=rt(ht("Feedback Type"),Ie("Modulators distort in one direction (like 12), but you can also use the feedback setting to make any wave distort in the opposite direction (12), or even itself (1)."));break;case"feedbackVolume":n=rt(ht("Feedback Distortion"),Ie("This setting controls the amount of feedback distortion based on the feedback type setting."));break;case"operatorFrequency":n=rt(ht("Operator Frequency"),Ie('This setting controls the frequency of an individual FM wave, relative to the fundamental frequency of the note. The multiplier 1 is the same as the fundamental frequency, whereas 2x would be an octave (12 semitones) above it. The frequencies with a "~" are slightly detuned and shift in and out of phase over time compared to the other frequencies.'),Ie('Try different combinations of a "carrier" wave and a "modulator" wave with different frequencies to get a feel for how they sound together.'));break;case"operatorVolume":n=rt(ht("Operator Volume"),Ie('This setting controls the volume of "carrier" waves, or the amount of distortion that "modulator" waves apply to other waves.'));break;case"spectrum":n=rt(ht("Spectrum"),Ie("This setting allows you to draw your own noise spectrum! This is good for making drum sounds."),Ie("If you only use certain frequencies and a soft fade in/out, it's also possible to make howling wind sounds or even musical wind instruments."),Ie("The left side of the spectrum editor controls the noise energy at lower frequencies, and the right side controls higher frequencies."));break;case"harmonics":n=rt(ht("Harmonics"),Ie("This setting allows you to design your own sound wave! Most musical waves are actually a combination of sine waves at certain frequencies, and this lets you control the volume of each sine wave individually."),Ie("The left side of the harmonics editor controls the sine wave volumes at lower frequencies, and the right side controls higher frequencies."));break;case"effects":n=rt(ht("Effects"),Ie("JummBox has many different kinds of special effects you can add to instruments. You can turn on multiple effects at once, and they can be configured individually. Try them all out!"));break;case"drumsetEnvelope":n=rt(ht("Drumset Envelope"),Ie("This drumset comes with a low-pass filter, and this setting can dynamically change the low-pass filter frequency over time. Each row in the pattern editor can have a different envelope shape."));break;case"drumsetSpectrum":n=rt(ht("Drumset Spectrum"),Ie("This setting allows you to draw your own noise spectrum! This is good for making drumsets. Each row in the pattern editor gets its own spectrum."),Ie("The left side of the spectrum editor controls the noise energy at lower frequencies, and the right side controls higher frequencies."));break;case"chorus":n=rt(ht("Chorus"),Ie("The chorus effect combines multiple copies of the instrument's sound and adds a bit of vibrato to simulate an ensemble of instruments or voices. Drag the slider to control how much chorus is added."));break;case"echoSustain":n=rt(ht("Echo Volume"),Ie("The echo effect repeats the instrument's sound after a delay. Each echo is a little bit quieter than the last, and this setting controls how much quieter."));break;case"echoDelay":n=rt(ht("Echo Delay"),Ie("The echo effect repeats the instrument's sound after a delay, and this setting controls how long the delay is."));break;case"pitchShift":n=rt(ht("Pitch Shift"),Ie("This setting makes instruments play higher or lower pitches than the ones displayed in the pattern editor. Be careful that you don't confuse yourself!"),Ie("You can combine this with envelopes to bend pitch over time, or play multiple simultaneous instruments with different pitch shifts for interesting layered sounds."),Ie('The intervals created by this setting are in "just intonation" which means they stay in phase with the original pitch instead of shifting in and out of phase over time. If you want the shifting, add the detune effect!'));break;case"detune":n=rt(ht("Detune"),Ie('This setting slightly adjusts the frequency of notes played by the instrument. You can use a little bit to add a pleasing shifting sound similar to the "unison" feature when combined with other instruments. If you use too much, then the instrument may sound unpleasantly out-of-tune.'));break;case"distortion":n=rt(ht("Distortion"),Ie("This is the famous electric guitar effect! However, there are some things to be aware of."),Ie(`First, most chords don't sound right when combined with heavy distortion. The only chords commonly used with distorted electric guitars are "power chords" which consist of a root note, a "fifth" note above that, and/or any octaves of those two notes.`),Ie("Second, the distortion sound depends a lot on filtering. In particular, I recommend enabling the note filter effect, and adding both high-pass and low-pass points to the note filter. (Note filters are applied first, then distortion which transforms the sound based on that filtering, then the EQ filter is applied last.)"),Ie("Finally, I recommend adjusting the fade-out setting to allow the end of each note to overlap a little bit with the beginning of the next, but not too much!"));break;case"bitcrusherQuantization":n=rt(ht("Bitcrusher Quantization"),Ie(`This effect makes stuff sounds harsher, artificial, and "low quality", which is great if that's what you're going for!`));break;case"bitcrusherFreq":n=rt(ht("Frequency Quantization"),Ie("The bitcrusher effect comes with an additional frequency quantization effect! This is a fun one to play with, especially when combined with the note filter effect."),Ie("Every other notch on this slider is aligned with the currently selected key of the song, and the in-between notches are aligned with the tritones of the key."));break;case"stringSustain":n=rt(ht("String sustain"),Ie("This setting controls how quickly the picked string vibration decays."),Ie(`Unlike most of BeepBox's instrument synthesizer features, a picked string cannot change frequency suddenly while maintaining its decay. If a tone's pitch changes suddenly (e.g. if the chord type is set to "arpeggio" or the transition type is set to "continues") then the string will be re-picked and start decaying from the beginning again, even if the envelopes don't otherwise restart.`));break;case"envelopes":n=rt(ht("Envelopes"),Ie("Envelopes are a way to dynamically adjust various other settings over time, usually based on how long the note lasts. Press the + button to add an envelope, then use the menus below to select which setting to control and the curve of the envelope. Try different combinations to see how they sound!"),Ie('Most envelope curves restart from the beginning every time a new note plays. The "note size" option is based on the note width as drawn in the pattern editor.'),Ie("Envelope curves move in the range from 0 to 1 (or vice versa), where 0 means as quiet as possible and 1 is the same as the corresponding position selected in the instrument settings above. If multiple envelopes are targetting the same setting, they are multiplied before applying to the setting."));break;case"usedInstrument":n=rt(Ac("'Is this instrument used somewhere else?'"),Ie("This indicator will light up when the instrument you're currently looking at is used in another place in your song (outside the selection)."),Ie("This can be useful when you're not sure if you've used the instrument before and making edits carelessly could change other parts of the song."));break;case"usedPattern":n=rt(Ac("'Is this pattern used somewhere else?'"),Ie("This indicator will light up when the pattern you're currently looking at is used in another place in your song (outside the selection)."),Ie("This can be useful when you're not sure if you've used the pattern before and making edits carelessly could change other parts of the song."));break;case"modChannel":n=rt(ht("Modulator Channel"),Ie("Modulators can be used to change settings in your song automatically over time. This technique is also known as automation."),Ie("This setting controls which channel the modulators will take effect for. If you choose 'Song', you can change song-wide settings too!"));break;case"modInstrument":n=rt(ht("Modulator Instrument"),Ie("Modulators can be used to change settings in your song automatically over time. This technique is also known as automation."),Ie("This setting controls which instrument your modulator will apply to within the given channel you've chosen."),Ie("If you choose 'all', every instrument in the channel will be affected. If you choose 'active', just the current ones used in this pattern will be instead."),Ie("Note that with 'all' or 'active', effects will only be applied to instruments that the effect is applicable on. For example if an instrument does not have panning effects, modulating panning will not affect it."));break;case"modSet":n=rt(ht("Modulator Setting"),Ie("This is the parameter that you want to change with this modulator. For example, if you set this to 'Tempo', you can speed up or slow down your song by laying notes in the pattern editor."),Ie("Note that you'll see different options if your channel is set to 'Song' versus a channel number. With 'Song', you'll see song-wide settings such as tempo. With a channel, you'll see specific instrument settings. Adding more effects to the instrument causes modulators for them to be available, so be sure to experiment!"),Ie("Most modulators behave as you'd expect and work just as if you were moving their associated slider. Click the '?' when you have a setting selected to get more info about it!"));break;case"modFilter":n=rt(ht("Filter Target"),Ie("This setting specifies which parameter of your targeted filter you would like to change."),Ie("With the 'morph' setting, the note value for your modulator represents the number of a subfilter to 'morph' into over time. For example, dragging a note from 0 to 7 will morph from your main filter to the 7th subfilter. To change how your subfilters are set up, click the '+' button on the target filter."),Ie("With a Dot setting, you can fine-tune the exact location of every dot on your filter graph. Note that this is extremely intensive if you want to modulate all dots - a morph is better in that case - but this can come in handy for small adjustments."));break;case"transitionBar":n=rt(ht("Tie Notes Over Bars"),Ie("With this option ticked, notes won't transition across bars if you put notes with the same pitches at the start of the next bar. Instead they will 'tie over' and sound like one long note."));break;case"clicklessTransition":n=rt(ht("Clickless Transition"),Ie("Sometimes, seamless and other transition types can make audible 'clicks' when changing between notes. Ticking this option will cause those clicks to be silenced as much as possible."));break;case"aliases":n=rt(ht("Aliasing"),Ie("JummBox applies a technique called 'anti-aliasing' to instruments normally to help them sound cleaner even at high frequencies and low sample rates."),Ie("When this setting is ticked that technique is disabled, so you may hear strange audio artifacts especially at high pitches and when bending notes. However, this can lend a grungy sound to an instrument that could be desirable."));break;case"operatorWaveform":n=rt(ht("Operator Waveform"),Ie("This setting controls the what kind of sound wave an individual FM wave uses. By defualt the FM synth only uses sinewaves."),Ie("This feature was ported from Aury system`s GoldBox!"));break;case"filterType":n=rt(ht("Filter Type"),Ie("Toggling these buttons lets you choose between a simple filter interface with two sliders, or the more advanced filter graph."),Ie("The two-slider version controls a single low-pass filter and was used in legacy versions. It is not as powerful, but if you feel overwhelmed you can start with this."),Ie("Note that switching from the simple interface to the advanced interface will convert your current settings, so you can also use it as a basis for later tweaking."));break;case"filterCutoff":n=rt(ht("Low-Pass Filter Cutoff Frequency"),Ie('The lowest setting feels "muffled" or "dark", and the highest setting feels "harsh" or "bright".'),Ie("Most sounds include a range of frequencies from low to high. JummBox instruments have a filter that allows the lowest frequencies to pass through at full volume, but can reduce the volume of the higher frequencies that are above a cutoff frequency. This setting controls the cutoff frequency and thus the range of higher frequencies that are reduced."),Ie("This cutoff setting also determines which frequency resonates when the resonance peak setting is used."));break;case"filterResonance":n=rt(ht("Low-Pass Filter Resonance Peak"),Ie("Increasing this setting emphasizes a narrow range of frequencies, based on the position of the filter cutoff setting. This can be used to imitate the resonant bodies of acoustic instruments and other interesting effects."),Ie("The filter preserves the volume of frequencies that are below the cutoff frequency, and reduces the volume of frequencies that are above the cutoff. If this setting is used, the filter also increases the volume of frequencies that are near the cutoff."));break;default:if(t.indexOf("modSetInfo")>=0){let i=+t[t.length-1],s=e.song.channels[e.channel].instruments[e.getCurrentInstrument()].modulators[i],h=[];for(let d=0;d<w.modulators[s].promptDesc.length;d++)h.push(Ie(w.modulators[s].promptDesc[d].replace("$LO",""+w.modulators[s].convertRealFactor).replace("$MID",""+(w.modulators[s].convertRealFactor+w.modulators[s].maxRawVol/2)).replace("$HI",""+(w.modulators[s].convertRealFactor+w.modulators[s].maxRawVol))));h[h.length-1].style.setProperty("color","var(--secondary-text)"),n=rt(ht(w.modulators[s].promptName),h);break}else throw new Error("Unhandled TipPrompt type: "+t)}this.container=rt({class:"prompt",style:"width: 300px;"},n,this._closeButton),setTimeout(()=>this._closeButton.focus()),this._closeButton.addEventListener("click",this._close)}}var L_=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function N_(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var gu={exports:{}};/*!
 * jQuery JavaScript Library v3.7.1
 * https://jquery.com/
 *
 * Copyright OpenJS Foundation and other contributors
 * Released under the MIT license
 * https://jquery.org/license
 *
 * Date: 2023-08-28T13:37Z
 */(function(r){(function(e,t){r.exports=e.document?t(e,!0):function(n){if(!n.document)throw new Error("jQuery requires a window with a document");return t(n)}})(typeof window<"u"?window:L_,function(e,t){var n=[],i=Object.getPrototypeOf,s=n.slice,h=n.flat?function(o){return n.flat.call(o)}:function(o){return n.concat.apply([],o)},d=n.push,c=n.indexOf,_={},m=_.toString,g=_.hasOwnProperty,S=g.toString,E=S.call(Object),A={},C=function(p){return typeof p=="function"&&typeof p.nodeType!="number"&&typeof p.item!="function"},k=function(p){return p!=null&&p===p.window},T=e.document,b={type:!0,src:!0,nonce:!0,noModule:!0};function R(o,p,x){x=x||T;var I,q,U=x.createElement("script");if(U.text=o,p)for(I in b)q=p[I]||p.getAttribute&&p.getAttribute(I),q&&U.setAttribute(I,q);x.head.appendChild(U).parentNode.removeChild(U)}function V(o){return o==null?o+"":typeof o=="object"||typeof o=="function"?_[m.call(o)]||"object":typeof o}var f="3.7.1",D=/HTML$/i,l=function(o,p){return new l.fn.init(o,p)};l.fn=l.prototype={jquery:f,constructor:l,length:0,toArray:function(){return s.call(this)},get:function(o){return o==null?s.call(this):o<0?this[o+this.length]:this[o]},pushStack:function(o){var p=l.merge(this.constructor(),o);return p.prevObject=this,p},each:function(o){return l.each(this,o)},map:function(o){return this.pushStack(l.map(this,function(p,x){return o.call(p,x,p)}))},slice:function(){return this.pushStack(s.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},even:function(){return this.pushStack(l.grep(this,function(o,p){return(p+1)%2}))},odd:function(){return this.pushStack(l.grep(this,function(o,p){return p%2}))},eq:function(o){var p=this.length,x=+o+(o<0?p:0);return this.pushStack(x>=0&&x<p?[this[x]]:[])},end:function(){return this.prevObject||this.constructor()},push:d,sort:n.sort,splice:n.splice},l.extend=l.fn.extend=function(){var o,p,x,I,q,U,$=arguments[0]||{},le=1,re=arguments.length,de=!1;for(typeof $=="boolean"&&(de=$,$=arguments[le]||{},le++),typeof $!="object"&&!C($)&&($={}),le===re&&($=this,le--);le<re;le++)if((o=arguments[le])!=null)for(p in o)I=o[p],!(p==="__proto__"||$===I)&&(de&&I&&(l.isPlainObject(I)||(q=Array.isArray(I)))?(x=$[p],q&&!Array.isArray(x)?U=[]:!q&&!l.isPlainObject(x)?U={}:U=x,q=!1,$[p]=l.extend(de,U,I)):I!==void 0&&($[p]=I));return $},l.extend({expando:"jQuery"+(f+Math.random()).replace(/\D/g,""),isReady:!0,error:function(o){throw new Error(o)},noop:function(){},isPlainObject:function(o){var p,x;return!o||m.call(o)!=="[object Object]"?!1:(p=i(o),p?(x=g.call(p,"constructor")&&p.constructor,typeof x=="function"&&S.call(x)===E):!0)},isEmptyObject:function(o){var p;for(p in o)return!1;return!0},globalEval:function(o,p,x){R(o,{nonce:p&&p.nonce},x)},each:function(o,p){var x,I=0;if(W(o))for(x=o.length;I<x&&p.call(o[I],I,o[I])!==!1;I++);else for(I in o)if(p.call(o[I],I,o[I])===!1)break;return o},text:function(o){var p,x="",I=0,q=o.nodeType;if(!q)for(;p=o[I++];)x+=l.text(p);return q===1||q===11?o.textContent:q===9?o.documentElement.textContent:q===3||q===4?o.nodeValue:x},makeArray:function(o,p){var x=p||[];return o!=null&&(W(Object(o))?l.merge(x,typeof o=="string"?[o]:o):d.call(x,o)),x},inArray:function(o,p,x){return p==null?-1:c.call(p,o,x)},isXMLDoc:function(o){var p=o&&o.namespaceURI,x=o&&(o.ownerDocument||o).documentElement;return!D.test(p||x&&x.nodeName||"HTML")},merge:function(o,p){for(var x=+p.length,I=0,q=o.length;I<x;I++)o[q++]=p[I];return o.length=q,o},grep:function(o,p,x){for(var I,q=[],U=0,$=o.length,le=!x;U<$;U++)I=!p(o[U],U),I!==le&&q.push(o[U]);return q},map:function(o,p,x){var I,q,U=0,$=[];if(W(o))for(I=o.length;U<I;U++)q=p(o[U],U,x),q!=null&&$.push(q);else for(U in o)q=p(o[U],U,x),q!=null&&$.push(q);return h($)},guid:1,support:A}),typeof Symbol=="function"&&(l.fn[Symbol.iterator]=n[Symbol.iterator]),l.each("Boolean Number String Function Array Date RegExp Object Error Symbol".split(" "),function(o,p){_["[object "+p+"]"]=p.toLowerCase()});function W(o){var p=!!o&&"length"in o&&o.length,x=V(o);return C(o)||k(o)?!1:x==="array"||p===0||typeof p=="number"&&p>0&&p-1 in o}function L(o,p){return o.nodeName&&o.nodeName.toLowerCase()===p.toLowerCase()}var P=n.pop,y=n.sort,O=n.splice,B="[\\x20\\t\\r\\n\\f]",v=new RegExp("^"+B+"+|((?:^|[^\\\\])(?:\\\\.)*)"+B+"+$","g");l.contains=function(o,p){var x=p&&p.parentNode;return o===x||!!(x&&x.nodeType===1&&(o.contains?o.contains(x):o.compareDocumentPosition&&o.compareDocumentPosition(x)&16))};var H=/([\0-\x1f\x7f]|^-?\d)|^-$|[^\x80-\uFFFF\w-]/g;function N(o,p){return p?o==="\0"?"":o.slice(0,-1)+"\\"+o.charCodeAt(o.length-1).toString(16)+" ":"\\"+o}l.escapeSelector=function(o){return(o+"").replace(H,N)};var te=T,G=d;(function(){var o,p,x,I,q,U=G,$,le,re,de,Ce,Te=l.expando,be=0,Fe=0,yt=Go(),qt=Go(),Bt=Go(),zn=Go(),Rn=function(ne,he){return ne===he&&(q=!0),0},ws="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",xs="(?:\\\\[\\da-fA-F]{1,6}"+B+"?|\\\\[^\\r\\n\\f]|[\\w-]|[^\0-\\x7f])+",Dt="\\["+B+"*("+xs+")(?:"+B+"*([*^$|!~]?=)"+B+`*(?:'((?:\\\\.|[^\\\\'])*)'|"((?:\\\\.|[^\\\\"])*)"|(`+xs+"))|)"+B+"*\\]",yr=":("+xs+`)(?:\\((('((?:\\\\.|[^\\\\'])*)'|"((?:\\\\.|[^\\\\"])*)")|((?:\\\\.|[^\\\\()[\\]]|`+Dt+")*)|.*)\\)|)",Xt=new RegExp(B+"+","g"),bn=new RegExp("^"+B+"*,"+B+"*"),_o=new RegExp("^"+B+"*([>+~]|"+B+")"+B+"*"),hl=new RegExp(B+"|>"),Ss=new RegExp(yr),mo=new RegExp("^"+xs+"$"),Cs={ID:new RegExp("^#("+xs+")"),CLASS:new RegExp("^\\.("+xs+")"),TAG:new RegExp("^("+xs+"|[*])"),ATTR:new RegExp("^"+Dt),PSEUDO:new RegExp("^"+yr),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+B+"*(even|odd|(([+-]|)(\\d*)n|)"+B+"*(?:([+-]|)"+B+"*(\\d+)|))"+B+"*\\)|)","i"),bool:new RegExp("^(?:"+ws+")$","i"),needsContext:new RegExp("^"+B+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+B+"*((?:-\\d)?\\d*)"+B+"*\\)|)(?=[^-]|$)","i")},Zs=/^(?:input|select|textarea|button)$/i,Qs=/^h\d$/i,Gi=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,cl=/[+~]/,Ds=new RegExp("\\\\[\\da-fA-F]{1,6}"+B+"?|\\\\([^\\r\\n\\f])","g"),Fs=function(ne,he){var ge="0x"+ne.slice(1)-65536;return he||(ge<0?String.fromCharCode(ge+65536):String.fromCharCode(ge>>10|55296,ge&1023|56320))},z0=function(){Js()},X0=Qo(function(ne){return ne.disabled===!0&&L(ne,"fieldset")},{dir:"parentNode",next:"legend"});function $0(){try{return $.activeElement}catch{}}try{U.apply(n=s.call(te.childNodes),te.childNodes),n[te.childNodes.length].nodeType}catch{U={apply:function(he,ge){G.apply(he,s.call(ge))},call:function(he){G.apply(he,s.call(arguments,1))}}}function Qt(ne,he,ge,xe){var Me,Ue,Je,at,et,At,gt,wt=he&&he.ownerDocument,Rt=he?he.nodeType:9;if(ge=ge||[],typeof ne!="string"||!ne||Rt!==1&&Rt!==9&&Rt!==11)return ge;if(!xe&&(Js(he),he=he||$,re)){if(Rt!==11&&(et=Gi.exec(ne)))if(Me=et[1]){if(Rt===9)if(Je=he.getElementById(Me)){if(Je.id===Me)return U.call(ge,Je),ge}else return ge;else if(wt&&(Je=wt.getElementById(Me))&&Qt.contains(he,Je)&&Je.id===Me)return U.call(ge,Je),ge}else{if(et[2])return U.apply(ge,he.getElementsByTagName(ne)),ge;if((Me=et[3])&&he.getElementsByClassName)return U.apply(ge,he.getElementsByClassName(Me)),ge}if(!zn[ne+" "]&&(!de||!de.test(ne))){if(gt=ne,wt=he,Rt===1&&(hl.test(ne)||_o.test(ne))){for(wt=cl.test(ne)&&dl(he.parentNode)||he,(wt!=he||!A.scope)&&((at=he.getAttribute("id"))?at=l.escapeSelector(at):he.setAttribute("id",at=Te)),At=go(ne),Ue=At.length;Ue--;)At[Ue]=(at?"#"+at:":scope")+" "+Zo(At[Ue]);gt=At.join(",")}try{return U.apply(ge,wt.querySelectorAll(gt)),ge}catch{zn(ne,!0)}finally{at===Te&&he.removeAttribute("id")}}}return Kh(ne.replace(v,"$1"),he,ge,xe)}function Go(){var ne=[];function he(ge,xe){return ne.push(ge+" ")>p.cacheLength&&delete he[ne.shift()],he[ge+" "]=xe}return he}function ls(ne){return ne[Te]=!0,ne}function qr(ne){var he=$.createElement("fieldset");try{return!!ne(he)}catch{return!1}finally{he.parentNode&&he.parentNode.removeChild(he),he=null}}function Y0(ne){return function(he){return L(he,"input")&&he.type===ne}}function j0(ne){return function(he){return(L(he,"input")||L(he,"button"))&&he.type===ne}}function Yh(ne){return function(he){return"form"in he?he.parentNode&&he.disabled===!1?"label"in he?"label"in he.parentNode?he.parentNode.disabled===ne:he.disabled===ne:he.isDisabled===ne||he.isDisabled!==!ne&&X0(he)===ne:he.disabled===ne:"label"in he?he.disabled===ne:!1}}function wr(ne){return ls(function(he){return he=+he,ls(function(ge,xe){for(var Me,Ue=ne([],ge.length,he),Je=Ue.length;Je--;)ge[Me=Ue[Je]]&&(ge[Me]=!(xe[Me]=ge[Me]))})})}function dl(ne){return ne&&typeof ne.getElementsByTagName<"u"&&ne}function Js(ne){var he,ge=ne?ne.ownerDocument||ne:te;return ge==$||ge.nodeType!==9||!ge.documentElement||($=ge,le=$.documentElement,re=!l.isXMLDoc($),Ce=le.matches||le.webkitMatchesSelector||le.msMatchesSelector,le.msMatchesSelector&&te!=$&&(he=$.defaultView)&&he.top!==he&&he.addEventListener("unload",z0),A.getById=qr(function(xe){return le.appendChild(xe).id=l.expando,!$.getElementsByName||!$.getElementsByName(l.expando).length}),A.disconnectedMatch=qr(function(xe){return Ce.call(xe,"*")}),A.scope=qr(function(){return $.querySelectorAll(":scope")}),A.cssHas=qr(function(){try{return $.querySelector(":has(*,:jqfake)"),!1}catch{return!0}}),A.getById?(p.filter.ID=function(xe){var Me=xe.replace(Ds,Fs);return function(Ue){return Ue.getAttribute("id")===Me}},p.find.ID=function(xe,Me){if(typeof Me.getElementById<"u"&&re){var Ue=Me.getElementById(xe);return Ue?[Ue]:[]}}):(p.filter.ID=function(xe){var Me=xe.replace(Ds,Fs);return function(Ue){var Je=typeof Ue.getAttributeNode<"u"&&Ue.getAttributeNode("id");return Je&&Je.value===Me}},p.find.ID=function(xe,Me){if(typeof Me.getElementById<"u"&&re){var Ue,Je,at,et=Me.getElementById(xe);if(et){if(Ue=et.getAttributeNode("id"),Ue&&Ue.value===xe)return[et];for(at=Me.getElementsByName(xe),Je=0;et=at[Je++];)if(Ue=et.getAttributeNode("id"),Ue&&Ue.value===xe)return[et]}return[]}}),p.find.TAG=function(xe,Me){return typeof Me.getElementsByTagName<"u"?Me.getElementsByTagName(xe):Me.querySelectorAll(xe)},p.find.CLASS=function(xe,Me){if(typeof Me.getElementsByClassName<"u"&&re)return Me.getElementsByClassName(xe)},de=[],qr(function(xe){var Me;le.appendChild(xe).innerHTML="<a id='"+Te+"' href='' disabled='disabled'></a><select id='"+Te+"-\r\\' disabled='disabled'><option selected=''></option></select>",xe.querySelectorAll("[selected]").length||de.push("\\["+B+"*(?:value|"+ws+")"),xe.querySelectorAll("[id~="+Te+"-]").length||de.push("~="),xe.querySelectorAll("a#"+Te+"+*").length||de.push(".#.+[+~]"),xe.querySelectorAll(":checked").length||de.push(":checked"),Me=$.createElement("input"),Me.setAttribute("type","hidden"),xe.appendChild(Me).setAttribute("name","D"),le.appendChild(xe).disabled=!0,xe.querySelectorAll(":disabled").length!==2&&de.push(":enabled",":disabled"),Me=$.createElement("input"),Me.setAttribute("name",""),xe.appendChild(Me),xe.querySelectorAll("[name='']").length||de.push("\\["+B+"*name"+B+"*="+B+`*(?:''|"")`)}),A.cssHas||de.push(":has"),de=de.length&&new RegExp(de.join("|")),Rn=function(xe,Me){if(xe===Me)return q=!0,0;var Ue=!xe.compareDocumentPosition-!Me.compareDocumentPosition;return Ue||(Ue=(xe.ownerDocument||xe)==(Me.ownerDocument||Me)?xe.compareDocumentPosition(Me):1,Ue&1||!A.sortDetached&&Me.compareDocumentPosition(xe)===Ue?xe===$||xe.ownerDocument==te&&Qt.contains(te,xe)?-1:Me===$||Me.ownerDocument==te&&Qt.contains(te,Me)?1:I?c.call(I,xe)-c.call(I,Me):0:Ue&4?-1:1)}),$}Qt.matches=function(ne,he){return Qt(ne,null,null,he)},Qt.matchesSelector=function(ne,he){if(Js(ne),re&&!zn[he+" "]&&(!de||!de.test(he)))try{var ge=Ce.call(ne,he);if(ge||A.disconnectedMatch||ne.document&&ne.document.nodeType!==11)return ge}catch{zn(he,!0)}return Qt(he,$,null,[ne]).length>0},Qt.contains=function(ne,he){return(ne.ownerDocument||ne)!=$&&Js(ne),l.contains(ne,he)},Qt.attr=function(ne,he){(ne.ownerDocument||ne)!=$&&Js(ne);var ge=p.attrHandle[he.toLowerCase()],xe=ge&&g.call(p.attrHandle,he.toLowerCase())?ge(ne,he,!re):void 0;return xe!==void 0?xe:ne.getAttribute(he)},Qt.error=function(ne){throw new Error("Syntax error, unrecognized expression: "+ne)},l.uniqueSort=function(ne){var he,ge=[],xe=0,Me=0;if(q=!A.sortStable,I=!A.sortStable&&s.call(ne,0),y.call(ne,Rn),q){for(;he=ne[Me++];)he===ne[Me]&&(xe=ge.push(Me));for(;xe--;)O.call(ne,ge[xe],1)}return I=null,ne},l.fn.uniqueSort=function(){return this.pushStack(l.uniqueSort(s.apply(this)))},p=l.expr={cacheLength:50,createPseudo:ls,match:Cs,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(ne){return ne[1]=ne[1].replace(Ds,Fs),ne[3]=(ne[3]||ne[4]||ne[5]||"").replace(Ds,Fs),ne[2]==="~="&&(ne[3]=" "+ne[3]+" "),ne.slice(0,4)},CHILD:function(ne){return ne[1]=ne[1].toLowerCase(),ne[1].slice(0,3)==="nth"?(ne[3]||Qt.error(ne[0]),ne[4]=+(ne[4]?ne[5]+(ne[6]||1):2*(ne[3]==="even"||ne[3]==="odd")),ne[5]=+(ne[7]+ne[8]||ne[3]==="odd")):ne[3]&&Qt.error(ne[0]),ne},PSEUDO:function(ne){var he,ge=!ne[6]&&ne[2];return Cs.CHILD.test(ne[0])?null:(ne[3]?ne[2]=ne[4]||ne[5]||"":ge&&Ss.test(ge)&&(he=go(ge,!0))&&(he=ge.indexOf(")",ge.length-he)-ge.length)&&(ne[0]=ne[0].slice(0,he),ne[2]=ge.slice(0,he)),ne.slice(0,3))}},filter:{TAG:function(ne){var he=ne.replace(Ds,Fs).toLowerCase();return ne==="*"?function(){return!0}:function(ge){return L(ge,he)}},CLASS:function(ne){var he=yt[ne+" "];return he||(he=new RegExp("(^|"+B+")"+ne+"("+B+"|$)"))&&yt(ne,function(ge){return he.test(typeof ge.className=="string"&&ge.className||typeof ge.getAttribute<"u"&&ge.getAttribute("class")||"")})},ATTR:function(ne,he,ge){return function(xe){var Me=Qt.attr(xe,ne);return Me==null?he==="!=":he?(Me+="",he==="="?Me===ge:he==="!="?Me!==ge:he==="^="?ge&&Me.indexOf(ge)===0:he==="*="?ge&&Me.indexOf(ge)>-1:he==="$="?ge&&Me.slice(-ge.length)===ge:he==="~="?(" "+Me.replace(Xt," ")+" ").indexOf(ge)>-1:he==="|="?Me===ge||Me.slice(0,ge.length+1)===ge+"-":!1):!0}},CHILD:function(ne,he,ge,xe,Me){var Ue=ne.slice(0,3)!=="nth",Je=ne.slice(-4)!=="last",at=he==="of-type";return xe===1&&Me===0?function(et){return!!et.parentNode}:function(et,At,gt){var wt,Rt,ft,sn,ci,Gn=Ue!==Je?"nextSibling":"previousSibling",Zi=et.parentNode,ks=at&&et.nodeName.toLowerCase(),Ur=!gt&&!at,ti=!1;if(Zi){if(Ue){for(;Gn;){for(ft=et;ft=ft[Gn];)if(at?L(ft,ks):ft.nodeType===1)return!1;ci=Gn=ne==="only"&&!ci&&"nextSibling"}return!0}if(ci=[Je?Zi.firstChild:Zi.lastChild],Je&&Ur){for(Rt=Zi[Te]||(Zi[Te]={}),wt=Rt[ne]||[],sn=wt[0]===be&&wt[1],ti=sn&&wt[2],ft=sn&&Zi.childNodes[sn];ft=++sn&&ft&&ft[Gn]||(ti=sn=0)||ci.pop();)if(ft.nodeType===1&&++ti&&ft===et){Rt[ne]=[be,sn,ti];break}}else if(Ur&&(Rt=et[Te]||(et[Te]={}),wt=Rt[ne]||[],sn=wt[0]===be&&wt[1],ti=sn),ti===!1)for(;(ft=++sn&&ft&&ft[Gn]||(ti=sn=0)||ci.pop())&&!((at?L(ft,ks):ft.nodeType===1)&&++ti&&(Ur&&(Rt=ft[Te]||(ft[Te]={}),Rt[ne]=[be,ti]),ft===et)););return ti-=Me,ti===xe||ti%xe===0&&ti/xe>=0}}},PSEUDO:function(ne,he){var ge,xe=p.pseudos[ne]||p.setFilters[ne.toLowerCase()]||Qt.error("unsupported pseudo: "+ne);return xe[Te]?xe(he):xe.length>1?(ge=[ne,ne,"",he],p.setFilters.hasOwnProperty(ne.toLowerCase())?ls(function(Me,Ue){for(var Je,at=xe(Me,he),et=at.length;et--;)Je=c.call(Me,at[et]),Me[Je]=!(Ue[Je]=at[et])}):function(Me){return xe(Me,0,ge)}):xe}},pseudos:{not:ls(function(ne){var he=[],ge=[],xe=_l(ne.replace(v,"$1"));return xe[Te]?ls(function(Me,Ue,Je,at){for(var et,At=xe(Me,null,at,[]),gt=Me.length;gt--;)(et=At[gt])&&(Me[gt]=!(Ue[gt]=et))}):function(Me,Ue,Je){return he[0]=Me,xe(he,null,Je,ge),he[0]=null,!ge.pop()}}),has:ls(function(ne){return function(he){return Qt(ne,he).length>0}}),contains:ls(function(ne){return ne=ne.replace(Ds,Fs),function(he){return(he.textContent||l.text(he)).indexOf(ne)>-1}}),lang:ls(function(ne){return mo.test(ne||"")||Qt.error("unsupported lang: "+ne),ne=ne.replace(Ds,Fs).toLowerCase(),function(he){var ge;do if(ge=re?he.lang:he.getAttribute("xml:lang")||he.getAttribute("lang"))return ge=ge.toLowerCase(),ge===ne||ge.indexOf(ne+"-")===0;while((he=he.parentNode)&&he.nodeType===1);return!1}}),target:function(ne){var he=e.location&&e.location.hash;return he&&he.slice(1)===ne.id},root:function(ne){return ne===le},focus:function(ne){return ne===$0()&&$.hasFocus()&&!!(ne.type||ne.href||~ne.tabIndex)},enabled:Yh(!1),disabled:Yh(!0),checked:function(ne){return L(ne,"input")&&!!ne.checked||L(ne,"option")&&!!ne.selected},selected:function(ne){return ne.parentNode&&ne.parentNode.selectedIndex,ne.selected===!0},empty:function(ne){for(ne=ne.firstChild;ne;ne=ne.nextSibling)if(ne.nodeType<6)return!1;return!0},parent:function(ne){return!p.pseudos.empty(ne)},header:function(ne){return Qs.test(ne.nodeName)},input:function(ne){return Zs.test(ne.nodeName)},button:function(ne){return L(ne,"input")&&ne.type==="button"||L(ne,"button")},text:function(ne){var he;return L(ne,"input")&&ne.type==="text"&&((he=ne.getAttribute("type"))==null||he.toLowerCase()==="text")},first:wr(function(){return[0]}),last:wr(function(ne,he){return[he-1]}),eq:wr(function(ne,he,ge){return[ge<0?ge+he:ge]}),even:wr(function(ne,he){for(var ge=0;ge<he;ge+=2)ne.push(ge);return ne}),odd:wr(function(ne,he){for(var ge=1;ge<he;ge+=2)ne.push(ge);return ne}),lt:wr(function(ne,he,ge){var xe;for(ge<0?xe=ge+he:ge>he?xe=he:xe=ge;--xe>=0;)ne.push(xe);return ne}),gt:wr(function(ne,he,ge){for(var xe=ge<0?ge+he:ge;++xe<he;)ne.push(xe);return ne})}},p.pseudos.nth=p.pseudos.eq;for(o in{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})p.pseudos[o]=Y0(o);for(o in{submit:!0,reset:!0})p.pseudos[o]=j0(o);function jh(){}jh.prototype=p.filters=p.pseudos,p.setFilters=new jh;function go(ne,he){var ge,xe,Me,Ue,Je,at,et,At=qt[ne+" "];if(At)return he?0:At.slice(0);for(Je=ne,at=[],et=p.preFilter;Je;){(!ge||(xe=bn.exec(Je)))&&(xe&&(Je=Je.slice(xe[0].length)||Je),at.push(Me=[])),ge=!1,(xe=_o.exec(Je))&&(ge=xe.shift(),Me.push({value:ge,type:xe[0].replace(v," ")}),Je=Je.slice(ge.length));for(Ue in p.filter)(xe=Cs[Ue].exec(Je))&&(!et[Ue]||(xe=et[Ue](xe)))&&(ge=xe.shift(),Me.push({value:ge,type:Ue,matches:xe}),Je=Je.slice(ge.length));if(!ge)break}return he?Je.length:Je?Qt.error(ne):qt(ne,at).slice(0)}function Zo(ne){for(var he=0,ge=ne.length,xe="";he<ge;he++)xe+=ne[he].value;return xe}function Qo(ne,he,ge){var xe=he.dir,Me=he.next,Ue=Me||xe,Je=ge&&Ue==="parentNode",at=Fe++;return he.first?function(et,At,gt){for(;et=et[xe];)if(et.nodeType===1||Je)return ne(et,At,gt);return!1}:function(et,At,gt){var wt,Rt,ft=[be,at];if(gt){for(;et=et[xe];)if((et.nodeType===1||Je)&&ne(et,At,gt))return!0}else for(;et=et[xe];)if(et.nodeType===1||Je)if(Rt=et[Te]||(et[Te]={}),Me&&L(et,Me))et=et[xe]||et;else{if((wt=Rt[Ue])&&wt[0]===be&&wt[1]===at)return ft[2]=wt[2];if(Rt[Ue]=ft,ft[2]=ne(et,At,gt))return!0}return!1}}function ul(ne){return ne.length>1?function(he,ge,xe){for(var Me=ne.length;Me--;)if(!ne[Me](he,ge,xe))return!1;return!0}:ne[0]}function K0(ne,he,ge){for(var xe=0,Me=he.length;xe<Me;xe++)Qt(ne,he[xe],ge);return ge}function Jo(ne,he,ge,xe,Me){for(var Ue,Je=[],at=0,et=ne.length,At=he!=null;at<et;at++)(Ue=ne[at])&&(!ge||ge(Ue,xe,Me))&&(Je.push(Ue),At&&he.push(at));return Je}function fl(ne,he,ge,xe,Me,Ue){return xe&&!xe[Te]&&(xe=fl(xe)),Me&&!Me[Te]&&(Me=fl(Me,Ue)),ls(function(Je,at,et,At){var gt,wt,Rt,ft,sn=[],ci=[],Gn=at.length,Zi=Je||K0(he||"*",et.nodeType?[et]:et,[]),ks=ne&&(Je||!he)?Jo(Zi,sn,ne,et,At):Zi;if(ge?(ft=Me||(Je?ne:Gn||xe)?[]:at,ge(ks,ft,et,At)):ft=ks,xe)for(gt=Jo(ft,ci),xe(gt,[],et,At),wt=gt.length;wt--;)(Rt=gt[wt])&&(ft[ci[wt]]=!(ks[ci[wt]]=Rt));if(Je){if(Me||ne){if(Me){for(gt=[],wt=ft.length;wt--;)(Rt=ft[wt])&&gt.push(ks[wt]=Rt);Me(null,ft=[],gt,At)}for(wt=ft.length;wt--;)(Rt=ft[wt])&&(gt=Me?c.call(Je,Rt):sn[wt])>-1&&(Je[gt]=!(at[gt]=Rt))}}else ft=Jo(ft===at?ft.splice(Gn,ft.length):ft),Me?Me(null,at,ft,At):U.apply(at,ft)})}function pl(ne){for(var he,ge,xe,Me=ne.length,Ue=p.relative[ne[0].type],Je=Ue||p.relative[" "],at=Ue?1:0,et=Qo(function(wt){return wt===he},Je,!0),At=Qo(function(wt){return c.call(he,wt)>-1},Je,!0),gt=[function(wt,Rt,ft){var sn=!Ue&&(ft||Rt!=x)||((he=Rt).nodeType?et(wt,Rt,ft):At(wt,Rt,ft));return he=null,sn}];at<Me;at++)if(ge=p.relative[ne[at].type])gt=[Qo(ul(gt),ge)];else{if(ge=p.filter[ne[at].type].apply(null,ne[at].matches),ge[Te]){for(xe=++at;xe<Me&&!p.relative[ne[xe].type];xe++);return fl(at>1&&ul(gt),at>1&&Zo(ne.slice(0,at-1).concat({value:ne[at-2].type===" "?"*":""})).replace(v,"$1"),ge,at<xe&&pl(ne.slice(at,xe)),xe<Me&&pl(ne=ne.slice(xe)),xe<Me&&Zo(ne))}gt.push(ge)}return ul(gt)}function G0(ne,he){var ge=he.length>0,xe=ne.length>0,Me=function(Ue,Je,at,et,At){var gt,wt,Rt,ft=0,sn="0",ci=Ue&&[],Gn=[],Zi=x,ks=Ue||xe&&p.find.TAG("*",At),Ur=be+=Zi==null?1:Math.random()||.1,ti=ks.length;for(At&&(x=Je==$||Je||At);sn!==ti&&(gt=ks[sn])!=null;sn++){if(xe&&gt){for(wt=0,!Je&&gt.ownerDocument!=$&&(Js(gt),at=!re);Rt=ne[wt++];)if(Rt(gt,Je||$,at)){U.call(et,gt);break}At&&(be=Ur)}ge&&((gt=!Rt&&gt)&&ft--,Ue&&ci.push(gt))}if(ft+=sn,ge&&sn!==ft){for(wt=0;Rt=he[wt++];)Rt(ci,Gn,Je,at);if(Ue){if(ft>0)for(;sn--;)ci[sn]||Gn[sn]||(Gn[sn]=P.call(et));Gn=Jo(Gn)}U.apply(et,Gn),At&&!Ue&&Gn.length>0&&ft+he.length>1&&l.uniqueSort(et)}return At&&(be=Ur,x=Zi),ci};return ge?ls(Me):Me}function _l(ne,he){var ge,xe=[],Me=[],Ue=Bt[ne+" "];if(!Ue){for(he||(he=go(ne)),ge=he.length;ge--;)Ue=pl(he[ge]),Ue[Te]?xe.push(Ue):Me.push(Ue);Ue=Bt(ne,G0(Me,xe)),Ue.selector=ne}return Ue}function Kh(ne,he,ge,xe){var Me,Ue,Je,at,et,At=typeof ne=="function"&&ne,gt=!xe&&go(ne=At.selector||ne);if(ge=ge||[],gt.length===1){if(Ue=gt[0]=gt[0].slice(0),Ue.length>2&&(Je=Ue[0]).type==="ID"&&he.nodeType===9&&re&&p.relative[Ue[1].type]){if(he=(p.find.ID(Je.matches[0].replace(Ds,Fs),he)||[])[0],he)At&&(he=he.parentNode);else return ge;ne=ne.slice(Ue.shift().value.length)}for(Me=Cs.needsContext.test(ne)?0:Ue.length;Me--&&(Je=Ue[Me],!p.relative[at=Je.type]);)if((et=p.find[at])&&(xe=et(Je.matches[0].replace(Ds,Fs),cl.test(Ue[0].type)&&dl(he.parentNode)||he))){if(Ue.splice(Me,1),ne=xe.length&&Zo(Ue),!ne)return U.apply(ge,xe),ge;break}}return(At||_l(ne,gt))(xe,he,!re,ge,!he||cl.test(ne)&&dl(he.parentNode)||he),ge}A.sortStable=Te.split("").sort(Rn).join("")===Te,Js(),A.sortDetached=qr(function(ne){return ne.compareDocumentPosition($.createElement("fieldset"))&1}),l.find=Qt,l.expr[":"]=l.expr.pseudos,l.unique=l.uniqueSort,Qt.compile=_l,Qt.select=Kh,Qt.setDocument=Js,Qt.tokenize=go,Qt.escape=l.escapeSelector,Qt.getText=l.text,Qt.isXML=l.isXMLDoc,Qt.selectors=l.expr,Qt.support=l.support,Qt.uniqueSort=l.uniqueSort})();var se=function(o,p,x){for(var I=[],q=x!==void 0;(o=o[p])&&o.nodeType!==9;)if(o.nodeType===1){if(q&&l(o).is(x))break;I.push(o)}return I},M=function(o,p){for(var x=[];o;o=o.nextSibling)o.nodeType===1&&o!==p&&x.push(o);return x},F=l.expr.match.needsContext,Z=/^<([a-z][^\/\0>:\x20\t\r\n\f]*)[\x20\t\r\n\f]*\/?>(?:<\/\1>|)$/i;function ee(o,p,x){return C(p)?l.grep(o,function(I,q){return!!p.call(I,q,I)!==x}):p.nodeType?l.grep(o,function(I){return I===p!==x}):typeof p!="string"?l.grep(o,function(I){return c.call(p,I)>-1!==x}):l.filter(p,o,x)}l.filter=function(o,p,x){var I=p[0];return x&&(o=":not("+o+")"),p.length===1&&I.nodeType===1?l.find.matchesSelector(I,o)?[I]:[]:l.find.matches(o,l.grep(p,function(q){return q.nodeType===1}))},l.fn.extend({find:function(o){var p,x,I=this.length,q=this;if(typeof o!="string")return this.pushStack(l(o).filter(function(){for(p=0;p<I;p++)if(l.contains(q[p],this))return!0}));for(x=this.pushStack([]),p=0;p<I;p++)l.find(o,q[p],x);return I>1?l.uniqueSort(x):x},filter:function(o){return this.pushStack(ee(this,o||[],!1))},not:function(o){return this.pushStack(ee(this,o||[],!0))},is:function(o){return!!ee(this,typeof o=="string"&&F.test(o)?l(o):o||[],!1).length}});var ue,Pe=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]+))$/,_e=l.fn.init=function(o,p,x){var I,q;if(!o)return this;if(x=x||ue,typeof o=="string")if(o[0]==="<"&&o[o.length-1]===">"&&o.length>=3?I=[null,o,null]:I=Pe.exec(o),I&&(I[1]||!p))if(I[1]){if(p=p instanceof l?p[0]:p,l.merge(this,l.parseHTML(I[1],p&&p.nodeType?p.ownerDocument||p:T,!0)),Z.test(I[1])&&l.isPlainObject(p))for(I in p)C(this[I])?this[I](p[I]):this.attr(I,p[I]);return this}else return q=T.getElementById(I[2]),q&&(this[0]=q,this.length=1),this;else return!p||p.jquery?(p||x).find(o):this.constructor(p).find(o);else{if(o.nodeType)return this[0]=o,this.length=1,this;if(C(o))return x.ready!==void 0?x.ready(o):o(l)}return l.makeArray(o,this)};_e.prototype=l.fn,ue=l(T);var ke=/^(?:parents|prev(?:Until|All))/,Ne={children:!0,contents:!0,next:!0,prev:!0};l.fn.extend({has:function(o){var p=l(o,this),x=p.length;return this.filter(function(){for(var I=0;I<x;I++)if(l.contains(this,p[I]))return!0})},closest:function(o,p){var x,I=0,q=this.length,U=[],$=typeof o!="string"&&l(o);if(!F.test(o)){for(;I<q;I++)for(x=this[I];x&&x!==p;x=x.parentNode)if(x.nodeType<11&&($?$.index(x)>-1:x.nodeType===1&&l.find.matchesSelector(x,o))){U.push(x);break}}return this.pushStack(U.length>1?l.uniqueSort(U):U)},index:function(o){return o?typeof o=="string"?c.call(l(o),this[0]):c.call(this,o.jquery?o[0]:o):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(o,p){return this.pushStack(l.uniqueSort(l.merge(this.get(),l(o,p))))},addBack:function(o){return this.add(o==null?this.prevObject:this.prevObject.filter(o))}});function Be(o,p){for(;(o=o[p])&&o.nodeType!==1;);return o}l.each({parent:function(o){var p=o.parentNode;return p&&p.nodeType!==11?p:null},parents:function(o){return se(o,"parentNode")},parentsUntil:function(o,p,x){return se(o,"parentNode",x)},next:function(o){return Be(o,"nextSibling")},prev:function(o){return Be(o,"previousSibling")},nextAll:function(o){return se(o,"nextSibling")},prevAll:function(o){return se(o,"previousSibling")},nextUntil:function(o,p,x){return se(o,"nextSibling",x)},prevUntil:function(o,p,x){return se(o,"previousSibling",x)},siblings:function(o){return M((o.parentNode||{}).firstChild,o)},children:function(o){return M(o.firstChild)},contents:function(o){return o.contentDocument!=null&&i(o.contentDocument)?o.contentDocument:(L(o,"template")&&(o=o.content||o),l.merge([],o.childNodes))}},function(o,p){l.fn[o]=function(x,I){var q=l.map(this,p,x);return o.slice(-5)!=="Until"&&(I=x),I&&typeof I=="string"&&(q=l.filter(I,q)),this.length>1&&(Ne[o]||l.uniqueSort(q),ke.test(o)&&q.reverse()),this.pushStack(q)}});var pe=/[^\x20\t\r\n\f]+/g;function Oe(o){var p={};return l.each(o.match(pe)||[],function(x,I){p[I]=!0}),p}l.Callbacks=function(o){o=typeof o=="string"?Oe(o):l.extend({},o);var p,x,I,q,U=[],$=[],le=-1,re=function(){for(q=q||o.once,I=p=!0;$.length;le=-1)for(x=$.shift();++le<U.length;)U[le].apply(x[0],x[1])===!1&&o.stopOnFalse&&(le=U.length,x=!1);o.memory||(x=!1),p=!1,q&&(x?U=[]:U="")},de={add:function(){return U&&(x&&!p&&(le=U.length-1,$.push(x)),function Ce(Te){l.each(Te,function(be,Fe){C(Fe)?(!o.unique||!de.has(Fe))&&U.push(Fe):Fe&&Fe.length&&V(Fe)!=="string"&&Ce(Fe)})}(arguments),x&&!p&&re()),this},remove:function(){return l.each(arguments,function(Ce,Te){for(var be;(be=l.inArray(Te,U,be))>-1;)U.splice(be,1),be<=le&&le--}),this},has:function(Ce){return Ce?l.inArray(Ce,U)>-1:U.length>0},empty:function(){return U&&(U=[]),this},disable:function(){return q=$=[],U=x="",this},disabled:function(){return!U},lock:function(){return q=$=[],!x&&!p&&(U=x=""),this},locked:function(){return!!q},fireWith:function(Ce,Te){return q||(Te=Te||[],Te=[Ce,Te.slice?Te.slice():Te],$.push(Te),p||re()),this},fire:function(){return de.fireWith(this,arguments),this},fired:function(){return!!I}};return de};function nt(o){return o}function Ve(o){throw o}function ot(o,p,x,I){var q;try{o&&C(q=o.promise)?q.call(o).done(p).fail(x):o&&C(q=o.then)?q.call(o,p,x):p.apply(void 0,[o].slice(I))}catch(U){x.apply(void 0,[U])}}l.extend({Deferred:function(o){var p=[["notify","progress",l.Callbacks("memory"),l.Callbacks("memory"),2],["resolve","done",l.Callbacks("once memory"),l.Callbacks("once memory"),0,"resolved"],["reject","fail",l.Callbacks("once memory"),l.Callbacks("once memory"),1,"rejected"]],x="pending",I={state:function(){return x},always:function(){return q.done(arguments).fail(arguments),this},catch:function(U){return I.then(null,U)},pipe:function(){var U=arguments;return l.Deferred(function($){l.each(p,function(le,re){var de=C(U[re[4]])&&U[re[4]];q[re[1]](function(){var Ce=de&&de.apply(this,arguments);Ce&&C(Ce.promise)?Ce.promise().progress($.notify).done($.resolve).fail($.reject):$[re[0]+"With"](this,de?[Ce]:arguments)})}),U=null}).promise()},then:function(U,$,le){var re=0;function de(Ce,Te,be,Fe){return function(){var yt=this,qt=arguments,Bt=function(){var Rn,ws;if(!(Ce<re)){if(Rn=be.apply(yt,qt),Rn===Te.promise())throw new TypeError("Thenable self-resolution");ws=Rn&&(typeof Rn=="object"||typeof Rn=="function")&&Rn.then,C(ws)?Fe?ws.call(Rn,de(re,Te,nt,Fe),de(re,Te,Ve,Fe)):(re++,ws.call(Rn,de(re,Te,nt,Fe),de(re,Te,Ve,Fe),de(re,Te,nt,Te.notifyWith))):(be!==nt&&(yt=void 0,qt=[Rn]),(Fe||Te.resolveWith)(yt,qt))}},zn=Fe?Bt:function(){try{Bt()}catch(Rn){l.Deferred.exceptionHook&&l.Deferred.exceptionHook(Rn,zn.error),Ce+1>=re&&(be!==Ve&&(yt=void 0,qt=[Rn]),Te.rejectWith(yt,qt))}};Ce?zn():(l.Deferred.getErrorHook?zn.error=l.Deferred.getErrorHook():l.Deferred.getStackHook&&(zn.error=l.Deferred.getStackHook()),e.setTimeout(zn))}}return l.Deferred(function(Ce){p[0][3].add(de(0,Ce,C(le)?le:nt,Ce.notifyWith)),p[1][3].add(de(0,Ce,C(U)?U:nt)),p[2][3].add(de(0,Ce,C($)?$:Ve))}).promise()},promise:function(U){return U!=null?l.extend(U,I):I}},q={};return l.each(p,function(U,$){var le=$[2],re=$[5];I[$[1]]=le.add,re&&le.add(function(){x=re},p[3-U][2].disable,p[3-U][3].disable,p[0][2].lock,p[0][3].lock),le.add($[3].fire),q[$[0]]=function(){return q[$[0]+"With"](this===q?void 0:this,arguments),this},q[$[0]+"With"]=le.fireWith}),I.promise(q),o&&o.call(q,q),q},when:function(o){var p=arguments.length,x=p,I=Array(x),q=s.call(arguments),U=l.Deferred(),$=function(le){return function(re){I[le]=this,q[le]=arguments.length>1?s.call(arguments):re,--p||U.resolveWith(I,q)}};if(p<=1&&(ot(o,U.done($(x)).resolve,U.reject,!p),U.state()==="pending"||C(q[x]&&q[x].then)))return U.then();for(;x--;)ot(q[x],$(x),U.reject);return U.promise()}});var Ge=/^(Eval|Internal|Range|Reference|Syntax|Type|URI)Error$/;l.Deferred.exceptionHook=function(o,p){e.console&&e.console.warn&&o&&Ge.test(o.name)&&e.console.warn("jQuery.Deferred exception: "+o.message,o.stack,p)},l.readyException=function(o){e.setTimeout(function(){throw o})};var lt=l.Deferred();l.fn.ready=function(o){return lt.then(o).catch(function(p){l.readyException(p)}),this},l.extend({isReady:!1,readyWait:1,ready:function(o){(o===!0?--l.readyWait:l.isReady)||(l.isReady=!0,!(o!==!0&&--l.readyWait>0)&&lt.resolveWith(T,[l]))}}),l.ready.then=lt.then;function dt(){T.removeEventListener("DOMContentLoaded",dt),e.removeEventListener("load",dt),l.ready()}T.readyState==="complete"||T.readyState!=="loading"&&!T.documentElement.doScroll?e.setTimeout(l.ready):(T.addEventListener("DOMContentLoaded",dt),e.addEventListener("load",dt));var St=function(o,p,x,I,q,U,$){var le=0,re=o.length,de=x==null;if(V(x)==="object"){q=!0;for(le in x)St(o,p,le,x[le],!0,U,$)}else if(I!==void 0&&(q=!0,C(I)||($=!0),de&&($?(p.call(o,I),p=null):(de=p,p=function(Ce,Te,be){return de.call(l(Ce),be)})),p))for(;le<re;le++)p(o[le],x,$?I:I.call(o[le],le,p(o[le],x)));return q?o:de?p.call(o):re?p(o[0],x):U},Mt=/^-ms-/,Tt=/-([a-z])/g;function Ct(o,p){return p.toUpperCase()}function kt(o){return o.replace(Mt,"ms-").replace(Tt,Ct)}var bt=function(o){return o.nodeType===1||o.nodeType===9||!+o.nodeType};function Pt(){this.expando=l.expando+Pt.uid++}Pt.uid=1,Pt.prototype={cache:function(o){var p=o[this.expando];return p||(p={},bt(o)&&(o.nodeType?o[this.expando]=p:Object.defineProperty(o,this.expando,{value:p,configurable:!0}))),p},set:function(o,p,x){var I,q=this.cache(o);if(typeof p=="string")q[kt(p)]=x;else for(I in p)q[kt(I)]=p[I];return q},get:function(o,p){return p===void 0?this.cache(o):o[this.expando]&&o[this.expando][kt(p)]},access:function(o,p,x){return p===void 0||p&&typeof p=="string"&&x===void 0?this.get(o,p):(this.set(o,p,x),x!==void 0?x:p)},remove:function(o,p){var x,I=o[this.expando];if(I!==void 0){if(p!==void 0)for(Array.isArray(p)?p=p.map(kt):(p=kt(p),p=p in I?[p]:p.match(pe)||[]),x=p.length;x--;)delete I[p[x]];(p===void 0||l.isEmptyObject(I))&&(o.nodeType?o[this.expando]=void 0:delete o[this.expando])}},hasData:function(o){var p=o[this.expando];return p!==void 0&&!l.isEmptyObject(p)}};var Xe=new Pt,vt=new Pt,Et=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,Sn=/[A-Z]/g;function Hi(o){return o==="true"?!0:o==="false"?!1:o==="null"?null:o===+o+""?+o:Et.test(o)?JSON.parse(o):o}function On(o,p,x){var I;if(x===void 0&&o.nodeType===1)if(I="data-"+p.replace(Sn,"-$&").toLowerCase(),x=o.getAttribute(I),typeof x=="string"){try{x=Hi(x)}catch{}vt.set(o,p,x)}else x=void 0;return x}l.extend({hasData:function(o){return vt.hasData(o)||Xe.hasData(o)},data:function(o,p,x){return vt.access(o,p,x)},removeData:function(o,p){vt.remove(o,p)},_data:function(o,p,x){return Xe.access(o,p,x)},_removeData:function(o,p){Xe.remove(o,p)}}),l.fn.extend({data:function(o,p){var x,I,q,U=this[0],$=U&&U.attributes;if(o===void 0){if(this.length&&(q=vt.get(U),U.nodeType===1&&!Xe.get(U,"hasDataAttrs"))){for(x=$.length;x--;)$[x]&&(I=$[x].name,I.indexOf("data-")===0&&(I=kt(I.slice(5)),On(U,I,q[I])));Xe.set(U,"hasDataAttrs",!0)}return q}return typeof o=="object"?this.each(function(){vt.set(this,o)}):St(this,function(le){var re;if(U&&le===void 0)return re=vt.get(U,o),re!==void 0||(re=On(U,o),re!==void 0)?re:void 0;this.each(function(){vt.set(this,o,le)})},null,p,arguments.length>1,null,!0)},removeData:function(o){return this.each(function(){vt.remove(this,o)})}}),l.extend({queue:function(o,p,x){var I;if(o)return p=(p||"fx")+"queue",I=Xe.get(o,p),x&&(!I||Array.isArray(x)?I=Xe.access(o,p,l.makeArray(x)):I.push(x)),I||[]},dequeue:function(o,p){p=p||"fx";var x=l.queue(o,p),I=x.length,q=x.shift(),U=l._queueHooks(o,p),$=function(){l.dequeue(o,p)};q==="inprogress"&&(q=x.shift(),I--),q&&(p==="fx"&&x.unshift("inprogress"),delete U.stop,q.call(o,$,U)),!I&&U&&U.empty.fire()},_queueHooks:function(o,p){var x=p+"queueHooks";return Xe.get(o,x)||Xe.access(o,x,{empty:l.Callbacks("once memory").add(function(){Xe.remove(o,[p+"queue",x])})})}}),l.fn.extend({queue:function(o,p){var x=2;return typeof o!="string"&&(p=o,o="fx",x--),arguments.length<x?l.queue(this[0],o):p===void 0?this:this.each(function(){var I=l.queue(this,o,p);l._queueHooks(this,o),o==="fx"&&I[0]!=="inprogress"&&l.dequeue(this,o)})},dequeue:function(o){return this.each(function(){l.dequeue(this,o)})},clearQueue:function(o){return this.queue(o||"fx",[])},promise:function(o,p){var x,I=1,q=l.Deferred(),U=this,$=this.length,le=function(){--I||q.resolveWith(U,[U])};for(typeof o!="string"&&(p=o,o=void 0),o=o||"fx";$--;)x=Xe.get(U[$],o+"queueHooks"),x&&x.empty&&(I++,x.empty.add(le));return le(),q.promise(p)}});var Ht=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,j=new RegExp("^(?:([+-])=|)("+Ht+")([a-z%]*)$","i"),K=["Top","Right","Bottom","Left"],z=T.documentElement,Y=function(o){return l.contains(o.ownerDocument,o)},J={composed:!0};z.getRootNode&&(Y=function(o){return l.contains(o.ownerDocument,o)||o.getRootNode(J)===o.ownerDocument});var X=function(o,p){return o=p||o,o.style.display==="none"||o.style.display===""&&Y(o)&&l.css(o,"display")==="none"};function ie(o,p,x,I){var q,U,$=20,le=I?function(){return I.cur()}:function(){return l.css(o,p,"")},re=le(),de=x&&x[3]||(l.cssNumber[p]?"":"px"),Ce=o.nodeType&&(l.cssNumber[p]||de!=="px"&&+re)&&j.exec(l.css(o,p));if(Ce&&Ce[3]!==de){for(re=re/2,de=de||Ce[3],Ce=+re||1;$--;)l.style(o,p,Ce+de),(1-U)*(1-(U=le()/re||.5))<=0&&($=0),Ce=Ce/U;Ce=Ce*2,l.style(o,p,Ce+de),x=x||[]}return x&&(Ce=+Ce||+re||0,q=x[1]?Ce+(x[1]+1)*x[2]:+x[2],I&&(I.unit=de,I.start=Ce,I.end=q)),q}var oe={};function ae(o){var p,x=o.ownerDocument,I=o.nodeName,q=oe[I];return q||(p=x.body.appendChild(x.createElement(I)),q=l.css(p,"display"),p.parentNode.removeChild(p),q==="none"&&(q="block"),oe[I]=q,q)}function fe(o,p){for(var x,I,q=[],U=0,$=o.length;U<$;U++)I=o[U],I.style&&(x=I.style.display,p?(x==="none"&&(q[U]=Xe.get(I,"display")||null,q[U]||(I.style.display="")),I.style.display===""&&X(I)&&(q[U]=ae(I))):x!=="none"&&(q[U]="none",Xe.set(I,"display",x)));for(U=0;U<$;U++)q[U]!=null&&(o[U].style.display=q[U]);return o}l.fn.extend({show:function(){return fe(this,!0)},hide:function(){return fe(this)},toggle:function(o){return typeof o=="boolean"?o?this.show():this.hide():this.each(function(){X(this)?l(this).show():l(this).hide()})}});var ce=/^(?:checkbox|radio)$/i,we=/<([a-z][^\/\0>\x20\t\r\n\f]*)/i,He=/^$|^module$|\/(?:java|ecma)script/i;(function(){var o=T.createDocumentFragment(),p=o.appendChild(T.createElement("div")),x=T.createElement("input");x.setAttribute("type","radio"),x.setAttribute("checked","checked"),x.setAttribute("name","t"),p.appendChild(x),A.checkClone=p.cloneNode(!0).cloneNode(!0).lastChild.checked,p.innerHTML="<textarea>x</textarea>",A.noCloneChecked=!!p.cloneNode(!0).lastChild.defaultValue,p.innerHTML="<option></option>",A.option=!!p.lastChild})();var $e={thead:[1,"<table>","</table>"],col:[2,"<table><colgroup>","</colgroup></table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[0,"",""]};$e.tbody=$e.tfoot=$e.colgroup=$e.caption=$e.thead,$e.th=$e.td,A.option||($e.optgroup=$e.option=[1,"<select multiple='multiple'>","</select>"]);function Ee(o,p){var x;return typeof o.getElementsByTagName<"u"?x=o.getElementsByTagName(p||"*"):typeof o.querySelectorAll<"u"?x=o.querySelectorAll(p||"*"):x=[],p===void 0||p&&L(o,p)?l.merge([o],x):x}function Ye(o,p){for(var x=0,I=o.length;x<I;x++)Xe.set(o[x],"globalEval",!p||Xe.get(p[x],"globalEval"))}var ve=/<|&#?\w+;/;function ze(o,p,x,I,q){for(var U,$,le,re,de,Ce,Te=p.createDocumentFragment(),be=[],Fe=0,yt=o.length;Fe<yt;Fe++)if(U=o[Fe],U||U===0)if(V(U)==="object")l.merge(be,U.nodeType?[U]:U);else if(!ve.test(U))be.push(p.createTextNode(U));else{for($=$||Te.appendChild(p.createElement("div")),le=(we.exec(U)||["",""])[1].toLowerCase(),re=$e[le]||$e._default,$.innerHTML=re[1]+l.htmlPrefilter(U)+re[2],Ce=re[0];Ce--;)$=$.lastChild;l.merge(be,$.childNodes),$=Te.firstChild,$.textContent=""}for(Te.textContent="",Fe=0;U=be[Fe++];){if(I&&l.inArray(U,I)>-1){q&&q.push(U);continue}if(de=Y(U),$=Ee(Te.appendChild(U),"script"),de&&Ye($),x)for(Ce=0;U=$[Ce++];)He.test(U.type||"")&&x.push(U)}return Te}var pt=/^([^.]*)(?:\.(.+)|)/;function Ae(){return!0}function qe(){return!1}function Re(o,p,x,I,q,U){var $,le;if(typeof p=="object"){typeof x!="string"&&(I=I||x,x=void 0);for(le in p)Re(o,le,x,I,p[le],U);return o}if(I==null&&q==null?(q=x,I=x=void 0):q==null&&(typeof x=="string"?(q=I,I=void 0):(q=I,I=x,x=void 0)),q===!1)q=qe;else if(!q)return o;return U===1&&($=q,q=function(re){return l().off(re),$.apply(this,arguments)},q.guid=$.guid||($.guid=l.guid++)),o.each(function(){l.event.add(this,p,q,I,x)})}l.event={global:{},add:function(o,p,x,I,q){var U,$,le,re,de,Ce,Te,be,Fe,yt,qt,Bt=Xe.get(o);if(bt(o))for(x.handler&&(U=x,x=U.handler,q=U.selector),q&&l.find.matchesSelector(z,q),x.guid||(x.guid=l.guid++),(re=Bt.events)||(re=Bt.events=Object.create(null)),($=Bt.handle)||($=Bt.handle=function(zn){return typeof l<"u"&&l.event.triggered!==zn.type?l.event.dispatch.apply(o,arguments):void 0}),p=(p||"").match(pe)||[""],de=p.length;de--;)le=pt.exec(p[de])||[],Fe=qt=le[1],yt=(le[2]||"").split(".").sort(),Fe&&(Te=l.event.special[Fe]||{},Fe=(q?Te.delegateType:Te.bindType)||Fe,Te=l.event.special[Fe]||{},Ce=l.extend({type:Fe,origType:qt,data:I,handler:x,guid:x.guid,selector:q,needsContext:q&&l.expr.match.needsContext.test(q),namespace:yt.join(".")},U),(be=re[Fe])||(be=re[Fe]=[],be.delegateCount=0,(!Te.setup||Te.setup.call(o,I,yt,$)===!1)&&o.addEventListener&&o.addEventListener(Fe,$)),Te.add&&(Te.add.call(o,Ce),Ce.handler.guid||(Ce.handler.guid=x.guid)),q?be.splice(be.delegateCount++,0,Ce):be.push(Ce),l.event.global[Fe]=!0)},remove:function(o,p,x,I,q){var U,$,le,re,de,Ce,Te,be,Fe,yt,qt,Bt=Xe.hasData(o)&&Xe.get(o);if(!(!Bt||!(re=Bt.events))){for(p=(p||"").match(pe)||[""],de=p.length;de--;){if(le=pt.exec(p[de])||[],Fe=qt=le[1],yt=(le[2]||"").split(".").sort(),!Fe){for(Fe in re)l.event.remove(o,Fe+p[de],x,I,!0);continue}for(Te=l.event.special[Fe]||{},Fe=(I?Te.delegateType:Te.bindType)||Fe,be=re[Fe]||[],le=le[2]&&new RegExp("(^|\\.)"+yt.join("\\.(?:.*\\.|)")+"(\\.|$)"),$=U=be.length;U--;)Ce=be[U],(q||qt===Ce.origType)&&(!x||x.guid===Ce.guid)&&(!le||le.test(Ce.namespace))&&(!I||I===Ce.selector||I==="**"&&Ce.selector)&&(be.splice(U,1),Ce.selector&&be.delegateCount--,Te.remove&&Te.remove.call(o,Ce));$&&!be.length&&((!Te.teardown||Te.teardown.call(o,yt,Bt.handle)===!1)&&l.removeEvent(o,Fe,Bt.handle),delete re[Fe])}l.isEmptyObject(re)&&Xe.remove(o,"handle events")}},dispatch:function(o){var p,x,I,q,U,$,le=new Array(arguments.length),re=l.event.fix(o),de=(Xe.get(this,"events")||Object.create(null))[re.type]||[],Ce=l.event.special[re.type]||{};for(le[0]=re,p=1;p<arguments.length;p++)le[p]=arguments[p];if(re.delegateTarget=this,!(Ce.preDispatch&&Ce.preDispatch.call(this,re)===!1)){for($=l.event.handlers.call(this,re,de),p=0;(q=$[p++])&&!re.isPropagationStopped();)for(re.currentTarget=q.elem,x=0;(U=q.handlers[x++])&&!re.isImmediatePropagationStopped();)(!re.rnamespace||U.namespace===!1||re.rnamespace.test(U.namespace))&&(re.handleObj=U,re.data=U.data,I=((l.event.special[U.origType]||{}).handle||U.handler).apply(q.elem,le),I!==void 0&&(re.result=I)===!1&&(re.preventDefault(),re.stopPropagation()));return Ce.postDispatch&&Ce.postDispatch.call(this,re),re.result}},handlers:function(o,p){var x,I,q,U,$,le=[],re=p.delegateCount,de=o.target;if(re&&de.nodeType&&!(o.type==="click"&&o.button>=1)){for(;de!==this;de=de.parentNode||this)if(de.nodeType===1&&!(o.type==="click"&&de.disabled===!0)){for(U=[],$={},x=0;x<re;x++)I=p[x],q=I.selector+" ",$[q]===void 0&&($[q]=I.needsContext?l(q,this).index(de)>-1:l.find(q,this,null,[de]).length),$[q]&&U.push(I);U.length&&le.push({elem:de,handlers:U})}}return de=this,re<p.length&&le.push({elem:de,handlers:p.slice(re)}),le},addProp:function(o,p){Object.defineProperty(l.Event.prototype,o,{enumerable:!0,configurable:!0,get:C(p)?function(){if(this.originalEvent)return p(this.originalEvent)}:function(){if(this.originalEvent)return this.originalEvent[o]},set:function(x){Object.defineProperty(this,o,{enumerable:!0,configurable:!0,writable:!0,value:x})}})},fix:function(o){return o[l.expando]?o:new l.Event(o)},special:{load:{noBubble:!0},click:{setup:function(o){var p=this||o;return ce.test(p.type)&&p.click&&L(p,"input")&&tt(p,"click",!0),!1},trigger:function(o){var p=this||o;return ce.test(p.type)&&p.click&&L(p,"input")&&tt(p,"click"),!0},_default:function(o){var p=o.target;return ce.test(p.type)&&p.click&&L(p,"input")&&Xe.get(p,"click")||L(p,"a")}},beforeunload:{postDispatch:function(o){o.result!==void 0&&o.originalEvent&&(o.originalEvent.returnValue=o.result)}}}};function tt(o,p,x){if(!x){Xe.get(o,p)===void 0&&l.event.add(o,p,Ae);return}Xe.set(o,p,!1),l.event.add(o,p,{namespace:!1,handler:function(I){var q,U=Xe.get(this,p);if(I.isTrigger&1&&this[p]){if(U)(l.event.special[p]||{}).delegateType&&I.stopPropagation();else if(U=s.call(arguments),Xe.set(this,p,U),this[p](),q=Xe.get(this,p),Xe.set(this,p,!1),U!==q)return I.stopImmediatePropagation(),I.preventDefault(),q}else U&&(Xe.set(this,p,l.event.trigger(U[0],U.slice(1),this)),I.stopPropagation(),I.isImmediatePropagationStopped=Ae)}})}l.removeEvent=function(o,p,x){o.removeEventListener&&o.removeEventListener(p,x)},l.Event=function(o,p){if(!(this instanceof l.Event))return new l.Event(o,p);o&&o.type?(this.originalEvent=o,this.type=o.type,this.isDefaultPrevented=o.defaultPrevented||o.defaultPrevented===void 0&&o.returnValue===!1?Ae:qe,this.target=o.target&&o.target.nodeType===3?o.target.parentNode:o.target,this.currentTarget=o.currentTarget,this.relatedTarget=o.relatedTarget):this.type=o,p&&l.extend(this,p),this.timeStamp=o&&o.timeStamp||Date.now(),this[l.expando]=!0},l.Event.prototype={constructor:l.Event,isDefaultPrevented:qe,isPropagationStopped:qe,isImmediatePropagationStopped:qe,isSimulated:!1,preventDefault:function(){var o=this.originalEvent;this.isDefaultPrevented=Ae,o&&!this.isSimulated&&o.preventDefault()},stopPropagation:function(){var o=this.originalEvent;this.isPropagationStopped=Ae,o&&!this.isSimulated&&o.stopPropagation()},stopImmediatePropagation:function(){var o=this.originalEvent;this.isImmediatePropagationStopped=Ae,o&&!this.isSimulated&&o.stopImmediatePropagation(),this.stopPropagation()}},l.each({altKey:!0,bubbles:!0,cancelable:!0,changedTouches:!0,ctrlKey:!0,detail:!0,eventPhase:!0,metaKey:!0,pageX:!0,pageY:!0,shiftKey:!0,view:!0,char:!0,code:!0,charCode:!0,key:!0,keyCode:!0,button:!0,buttons:!0,clientX:!0,clientY:!0,offsetX:!0,offsetY:!0,pointerId:!0,pointerType:!0,screenX:!0,screenY:!0,targetTouches:!0,toElement:!0,touches:!0,which:!0},l.event.addProp),l.each({focus:"focusin",blur:"focusout"},function(o,p){function x(I){if(T.documentMode){var q=Xe.get(this,"handle"),U=l.event.fix(I);U.type=I.type==="focusin"?"focus":"blur",U.isSimulated=!0,q(I),U.target===U.currentTarget&&q(U)}else l.event.simulate(p,I.target,l.event.fix(I))}l.event.special[o]={setup:function(){var I;if(tt(this,o,!0),T.documentMode)I=Xe.get(this,p),I||this.addEventListener(p,x),Xe.set(this,p,(I||0)+1);else return!1},trigger:function(){return tt(this,o),!0},teardown:function(){var I;if(T.documentMode)I=Xe.get(this,p)-1,I?Xe.set(this,p,I):(this.removeEventListener(p,x),Xe.remove(this,p));else return!1},_default:function(I){return Xe.get(I.target,o)},delegateType:p},l.event.special[p]={setup:function(){var I=this.ownerDocument||this.document||this,q=T.documentMode?this:I,U=Xe.get(q,p);U||(T.documentMode?this.addEventListener(p,x):I.addEventListener(o,x,!0)),Xe.set(q,p,(U||0)+1)},teardown:function(){var I=this.ownerDocument||this.document||this,q=T.documentMode?this:I,U=Xe.get(q,p)-1;U?Xe.set(q,p,U):(T.documentMode?this.removeEventListener(p,x):I.removeEventListener(o,x,!0),Xe.remove(q,p))}}}),l.each({mouseenter:"mouseover",mouseleave:"mouseout",pointerenter:"pointerover",pointerleave:"pointerout"},function(o,p){l.event.special[o]={delegateType:p,bindType:p,handle:function(x){var I,q=this,U=x.relatedTarget,$=x.handleObj;return(!U||U!==q&&!l.contains(q,U))&&(x.type=$.origType,I=$.handler.apply(this,arguments),x.type=p),I}}}),l.fn.extend({on:function(o,p,x,I){return Re(this,o,p,x,I)},one:function(o,p,x,I){return Re(this,o,p,x,I,1)},off:function(o,p,x){var I,q;if(o&&o.preventDefault&&o.handleObj)return I=o.handleObj,l(o.delegateTarget).off(I.namespace?I.origType+"."+I.namespace:I.origType,I.selector,I.handler),this;if(typeof o=="object"){for(q in o)this.off(q,p,o[q]);return this}return(p===!1||typeof p=="function")&&(x=p,p=void 0),x===!1&&(x=qe),this.each(function(){l.event.remove(this,o,x,p)})}});var Vt=/<script|<style|<link/i,We=/checked\s*(?:[^=]|=\s*.checked.)/i,ct=/^\s*<!\[CDATA\[|\]\]>\s*$/g;function _t(o,p){return L(o,"table")&&L(p.nodeType!==11?p:p.firstChild,"tr")&&l(o).children("tbody")[0]||o}function mt(o){return o.type=(o.getAttribute("type")!==null)+"/"+o.type,o}function Cn(o){return(o.type||"").slice(0,5)==="true/"?o.type=o.type.slice(5):o.removeAttribute("type"),o}function Kt(o,p){var x,I,q,U,$,le,re;if(p.nodeType===1){if(Xe.hasData(o)&&(U=Xe.get(o),re=U.events,re)){Xe.remove(p,"handle events");for(q in re)for(x=0,I=re[q].length;x<I;x++)l.event.add(p,q,re[q][x])}vt.hasData(o)&&($=vt.access(o),le=l.extend({},$),vt.set(p,le))}}function Wt(o,p){var x=p.nodeName.toLowerCase();x==="input"&&ce.test(o.type)?p.checked=o.checked:(x==="input"||x==="textarea")&&(p.defaultValue=o.defaultValue)}function en(o,p,x,I){p=h(p);var q,U,$,le,re,de,Ce=0,Te=o.length,be=Te-1,Fe=p[0],yt=C(Fe);if(yt||Te>1&&typeof Fe=="string"&&!A.checkClone&&We.test(Fe))return o.each(function(qt){var Bt=o.eq(qt);yt&&(p[0]=Fe.call(this,qt,Bt.html())),en(Bt,p,x,I)});if(Te&&(q=ze(p,o[0].ownerDocument,!1,o,I),U=q.firstChild,q.childNodes.length===1&&(q=U),U||I)){for($=l.map(Ee(q,"script"),mt),le=$.length;Ce<Te;Ce++)re=q,Ce!==be&&(re=l.clone(re,!0,!0),le&&l.merge($,Ee(re,"script"))),x.call(o[Ce],re,Ce);if(le)for(de=$[$.length-1].ownerDocument,l.map($,Cn),Ce=0;Ce<le;Ce++)re=$[Ce],He.test(re.type||"")&&!Xe.access(re,"globalEval")&&l.contains(de,re)&&(re.src&&(re.type||"").toLowerCase()!=="module"?l._evalUrl&&!re.noModule&&l._evalUrl(re.src,{nonce:re.nonce||re.getAttribute("nonce")},de):R(re.textContent.replace(ct,""),re,de))}return o}function gn(o,p,x){for(var I,q=p?l.filter(p,o):o,U=0;(I=q[U])!=null;U++)!x&&I.nodeType===1&&l.cleanData(Ee(I)),I.parentNode&&(x&&Y(I)&&Ye(Ee(I,"script")),I.parentNode.removeChild(I));return o}l.extend({htmlPrefilter:function(o){return o},clone:function(o,p,x){var I,q,U,$,le=o.cloneNode(!0),re=Y(o);if(!A.noCloneChecked&&(o.nodeType===1||o.nodeType===11)&&!l.isXMLDoc(o))for($=Ee(le),U=Ee(o),I=0,q=U.length;I<q;I++)Wt(U[I],$[I]);if(p)if(x)for(U=U||Ee(o),$=$||Ee(le),I=0,q=U.length;I<q;I++)Kt(U[I],$[I]);else Kt(o,le);return $=Ee(le,"script"),$.length>0&&Ye($,!re&&Ee(o,"script")),le},cleanData:function(o){for(var p,x,I,q=l.event.special,U=0;(x=o[U])!==void 0;U++)if(bt(x)){if(p=x[Xe.expando]){if(p.events)for(I in p.events)q[I]?l.event.remove(x,I):l.removeEvent(x,I,p.handle);x[Xe.expando]=void 0}x[vt.expando]&&(x[vt.expando]=void 0)}}}),l.fn.extend({detach:function(o){return gn(this,o,!0)},remove:function(o){return gn(this,o)},text:function(o){return St(this,function(p){return p===void 0?l.text(this):this.empty().each(function(){(this.nodeType===1||this.nodeType===11||this.nodeType===9)&&(this.textContent=p)})},null,o,arguments.length)},append:function(){return en(this,arguments,function(o){if(this.nodeType===1||this.nodeType===11||this.nodeType===9){var p=_t(this,o);p.appendChild(o)}})},prepend:function(){return en(this,arguments,function(o){if(this.nodeType===1||this.nodeType===11||this.nodeType===9){var p=_t(this,o);p.insertBefore(o,p.firstChild)}})},before:function(){return en(this,arguments,function(o){this.parentNode&&this.parentNode.insertBefore(o,this)})},after:function(){return en(this,arguments,function(o){this.parentNode&&this.parentNode.insertBefore(o,this.nextSibling)})},empty:function(){for(var o,p=0;(o=this[p])!=null;p++)o.nodeType===1&&(l.cleanData(Ee(o,!1)),o.textContent="");return this},clone:function(o,p){return o=o??!1,p=p??o,this.map(function(){return l.clone(this,o,p)})},html:function(o){return St(this,function(p){var x=this[0]||{},I=0,q=this.length;if(p===void 0&&x.nodeType===1)return x.innerHTML;if(typeof p=="string"&&!Vt.test(p)&&!$e[(we.exec(p)||["",""])[1].toLowerCase()]){p=l.htmlPrefilter(p);try{for(;I<q;I++)x=this[I]||{},x.nodeType===1&&(l.cleanData(Ee(x,!1)),x.innerHTML=p);x=0}catch{}}x&&this.empty().append(p)},null,o,arguments.length)},replaceWith:function(){var o=[];return en(this,arguments,function(p){var x=this.parentNode;l.inArray(this,o)<0&&(l.cleanData(Ee(this)),x&&x.replaceChild(p,this))},o)}}),l.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(o,p){l.fn[o]=function(x){for(var I,q=[],U=l(x),$=U.length-1,le=0;le<=$;le++)I=le===$?this:this.clone(!0),l(U[le])[p](I),d.apply(q,I.get());return this.pushStack(q)}});var En=new RegExp("^("+Ht+")(?!px)[a-z%]+$","i"),qn=/^--/,Hn=function(o){var p=o.ownerDocument.defaultView;return(!p||!p.opener)&&(p=e),p.getComputedStyle(o)},vn=function(o,p,x){var I,q,U={};for(q in p)U[q]=o.style[q],o.style[q]=p[q];I=x.call(o);for(q in p)o.style[q]=U[q];return I},ei=new RegExp(K.join("|"),"i");(function(){function o(){if(de){re.style.cssText="position:absolute;left:-11111px;width:60px;margin-top:1px;padding:0;border:0",de.style.cssText="position:relative;display:block;box-sizing:border-box;overflow:scroll;margin:auto;border:1px;padding:1px;width:60%;top:1%",z.appendChild(re).appendChild(de);var Ce=e.getComputedStyle(de);x=Ce.top!=="1%",le=p(Ce.marginLeft)===12,de.style.right="60%",U=p(Ce.right)===36,I=p(Ce.width)===36,de.style.position="absolute",q=p(de.offsetWidth/3)===12,z.removeChild(re),de=null}}function p(Ce){return Math.round(parseFloat(Ce))}var x,I,q,U,$,le,re=T.createElement("div"),de=T.createElement("div");de.style&&(de.style.backgroundClip="content-box",de.cloneNode(!0).style.backgroundClip="",A.clearCloneStyle=de.style.backgroundClip==="content-box",l.extend(A,{boxSizingReliable:function(){return o(),I},pixelBoxStyles:function(){return o(),U},pixelPosition:function(){return o(),x},reliableMarginLeft:function(){return o(),le},scrollboxSize:function(){return o(),q},reliableTrDimensions:function(){var Ce,Te,be,Fe;return $==null&&(Ce=T.createElement("table"),Te=T.createElement("tr"),be=T.createElement("div"),Ce.style.cssText="position:absolute;left:-11111px;border-collapse:separate",Te.style.cssText="box-sizing:content-box;border:1px solid",Te.style.height="1px",be.style.height="9px",be.style.display="block",z.appendChild(Ce).appendChild(Te).appendChild(be),Fe=e.getComputedStyle(Te),$=parseInt(Fe.height,10)+parseInt(Fe.borderTopWidth,10)+parseInt(Fe.borderBottomWidth,10)===Te.offsetHeight,z.removeChild(Ce)),$}}))})();function ai(o,p,x){var I,q,U,$,le=qn.test(p),re=o.style;return x=x||Hn(o),x&&($=x.getPropertyValue(p)||x[p],le&&$&&($=$.replace(v,"$1")||void 0),$===""&&!Y(o)&&($=l.style(o,p)),!A.pixelBoxStyles()&&En.test($)&&ei.test(p)&&(I=re.width,q=re.minWidth,U=re.maxWidth,re.minWidth=re.maxWidth=re.width=$,$=x.width,re.width=I,re.minWidth=q,re.maxWidth=U)),$!==void 0?$+"":$}function Ys(o,p){return{get:function(){if(o()){delete this.get;return}return(this.get=p).apply(this,arguments)}}}var js=["Webkit","Moz","ms"],Vi=T.createElement("div").style,li={};function Gt(o){for(var p=o[0].toUpperCase()+o.slice(1),x=js.length;x--;)if(o=js[x]+p,o in Vi)return o}function Wi(o){var p=l.cssProps[o]||li[o];return p||(o in Vi?o:li[o]=Gt(o)||o)}var hi=/^(none|table(?!-c[ea]).+)/,os={position:"absolute",visibility:"hidden",display:"block"},ji={letterSpacing:"0",fontWeight:"400"};function as(o,p,x){var I=j.exec(p);return I?Math.max(0,I[2]-(x||0))+(I[3]||"px"):p}function An(o,p,x,I,q,U){var $=p==="width"?1:0,le=0,re=0,de=0;if(x===(I?"border":"content"))return 0;for(;$<4;$+=2)x==="margin"&&(de+=l.css(o,x+K[$],!0,q)),I?(x==="content"&&(re-=l.css(o,"padding"+K[$],!0,q)),x!=="margin"&&(re-=l.css(o,"border"+K[$]+"Width",!0,q))):(re+=l.css(o,"padding"+K[$],!0,q),x!=="padding"?re+=l.css(o,"border"+K[$]+"Width",!0,q):le+=l.css(o,"border"+K[$]+"Width",!0,q));return!I&&U>=0&&(re+=Math.max(0,Math.ceil(o["offset"+p[0].toUpperCase()+p.slice(1)]-U-re-le-.5))||0),re+de}function Ki(o,p,x){var I=Hn(o),q=!A.boxSizingReliable()||x,U=q&&l.css(o,"boxSizing",!1,I)==="border-box",$=U,le=ai(o,p,I),re="offset"+p[0].toUpperCase()+p.slice(1);if(En.test(le)){if(!x)return le;le="auto"}return(!A.boxSizingReliable()&&U||!A.reliableTrDimensions()&&L(o,"tr")||le==="auto"||!parseFloat(le)&&l.css(o,"display",!1,I)==="inline")&&o.getClientRects().length&&(U=l.css(o,"boxSizing",!1,I)==="border-box",$=re in o,$&&(le=o[re])),le=parseFloat(le)||0,le+An(o,p,x||(U?"border":"content"),$,I,le)+"px"}l.extend({cssHooks:{opacity:{get:function(o,p){if(p){var x=ai(o,"opacity");return x===""?"1":x}}}},cssNumber:{animationIterationCount:!0,aspectRatio:!0,borderImageSlice:!0,columnCount:!0,flexGrow:!0,flexShrink:!0,fontWeight:!0,gridArea:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnStart:!0,gridRow:!0,gridRowEnd:!0,gridRowStart:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,scale:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeMiterlimit:!0,strokeOpacity:!0},cssProps:{},style:function(o,p,x,I){if(!(!o||o.nodeType===3||o.nodeType===8||!o.style)){var q,U,$,le=kt(p),re=qn.test(p),de=o.style;if(re||(p=Wi(le)),$=l.cssHooks[p]||l.cssHooks[le],x!==void 0){if(U=typeof x,U==="string"&&(q=j.exec(x))&&q[1]&&(x=ie(o,p,q),U="number"),x==null||x!==x)return;U==="number"&&!re&&(x+=q&&q[3]||(l.cssNumber[le]?"":"px")),!A.clearCloneStyle&&x===""&&p.indexOf("background")===0&&(de[p]="inherit"),(!$||!("set"in $)||(x=$.set(o,x,I))!==void 0)&&(re?de.setProperty(p,x):de[p]=x)}else return $&&"get"in $&&(q=$.get(o,!1,I))!==void 0?q:de[p]}},css:function(o,p,x,I){var q,U,$,le=kt(p),re=qn.test(p);return re||(p=Wi(le)),$=l.cssHooks[p]||l.cssHooks[le],$&&"get"in $&&(q=$.get(o,!0,x)),q===void 0&&(q=ai(o,p,I)),q==="normal"&&p in ji&&(q=ji[p]),x===""||x?(U=parseFloat(q),x===!0||isFinite(U)?U||0:q):q}}),l.each(["height","width"],function(o,p){l.cssHooks[p]={get:function(x,I,q){if(I)return hi.test(l.css(x,"display"))&&(!x.getClientRects().length||!x.getBoundingClientRect().width)?vn(x,os,function(){return Ki(x,p,q)}):Ki(x,p,q)},set:function(x,I,q){var U,$=Hn(x),le=!A.scrollboxSize()&&$.position==="absolute",re=le||q,de=re&&l.css(x,"boxSizing",!1,$)==="border-box",Ce=q?An(x,p,q,de,$):0;return de&&le&&(Ce-=Math.ceil(x["offset"+p[0].toUpperCase()+p.slice(1)]-parseFloat($[p])-An(x,p,"border",!1,$)-.5)),Ce&&(U=j.exec(I))&&(U[3]||"px")!=="px"&&(x.style[p]=I,I=l.css(x,p)),as(x,I,Ce)}}}),l.cssHooks.marginLeft=Ys(A.reliableMarginLeft,function(o,p){if(p)return(parseFloat(ai(o,"marginLeft"))||o.getBoundingClientRect().left-vn(o,{marginLeft:0},function(){return o.getBoundingClientRect().left}))+"px"}),l.each({margin:"",padding:"",border:"Width"},function(o,p){l.cssHooks[o+p]={expand:function(x){for(var I=0,q={},U=typeof x=="string"?x.split(" "):[x];I<4;I++)q[o+K[I]+p]=U[I]||U[I-2]||U[0];return q}},o!=="margin"&&(l.cssHooks[o+p].set=as)}),l.fn.extend({css:function(o,p){return St(this,function(x,I,q){var U,$,le={},re=0;if(Array.isArray(I)){for(U=Hn(x),$=I.length;re<$;re++)le[I[re]]=l.css(x,I[re],!1,U);return le}return q!==void 0?l.style(x,I,q):l.css(x,I)},o,p,arguments.length>1)}});function It(o,p,x,I,q){return new It.prototype.init(o,p,x,I,q)}l.Tween=It,It.prototype={constructor:It,init:function(o,p,x,I,q,U){this.elem=o,this.prop=x,this.easing=q||l.easing._default,this.options=p,this.start=this.now=this.cur(),this.end=I,this.unit=U||(l.cssNumber[x]?"":"px")},cur:function(){var o=It.propHooks[this.prop];return o&&o.get?o.get(this):It.propHooks._default.get(this)},run:function(o){var p,x=It.propHooks[this.prop];return this.options.duration?this.pos=p=l.easing[this.easing](o,this.options.duration*o,0,1,this.options.duration):this.pos=p=o,this.now=(this.end-this.start)*p+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),x&&x.set?x.set(this):It.propHooks._default.set(this),this}},It.prototype.init.prototype=It.prototype,It.propHooks={_default:{get:function(o){var p;return o.elem.nodeType!==1||o.elem[o.prop]!=null&&o.elem.style[o.prop]==null?o.elem[o.prop]:(p=l.css(o.elem,o.prop,""),!p||p==="auto"?0:p)},set:function(o){l.fx.step[o.prop]?l.fx.step[o.prop](o):o.elem.nodeType===1&&(l.cssHooks[o.prop]||o.elem.style[Wi(o.prop)]!=null)?l.style(o.elem,o.prop,o.now+o.unit):o.elem[o.prop]=o.now}}},It.propHooks.scrollTop=It.propHooks.scrollLeft={set:function(o){o.elem.nodeType&&o.elem.parentNode&&(o.elem[o.prop]=o.now)}},l.easing={linear:function(o){return o},swing:function(o){return .5-Math.cos(o*Math.PI)/2},_default:"swing"},l.fx=It.prototype.init,l.fx.step={};var jn,Ks,co=/^(?:toggle|show|hide)$/,Kn=/queueHooks$/;function Ns(){Ks&&(T.hidden===!1&&e.requestAnimationFrame?e.requestAnimationFrame(Ns):e.setTimeout(Ns,l.fx.interval),l.fx.tick())}function vs(){return e.setTimeout(function(){jn=void 0}),jn=Date.now()}function Gs(o,p){var x,I=0,q={height:o};for(p=p?1:0;I<4;I+=2-p)x=K[I],q["margin"+x]=q["padding"+x]=o;return p&&(q.opacity=q.width=o),q}function bs(o,p,x){for(var I,q=(Un.tweeners[p]||[]).concat(Un.tweeners["*"]),U=0,$=q.length;U<$;U++)if(I=q[U].call(x,p,o))return I}function uo(o,p,x){var I,q,U,$,le,re,de,Ce,Te="width"in p||"height"in p,be=this,Fe={},yt=o.style,qt=o.nodeType&&X(o),Bt=Xe.get(o,"fxshow");x.queue||($=l._queueHooks(o,"fx"),$.unqueued==null&&($.unqueued=0,le=$.empty.fire,$.empty.fire=function(){$.unqueued||le()}),$.unqueued++,be.always(function(){be.always(function(){$.unqueued--,l.queue(o,"fx").length||$.empty.fire()})}));for(I in p)if(q=p[I],co.test(q)){if(delete p[I],U=U||q==="toggle",q===(qt?"hide":"show"))if(q==="show"&&Bt&&Bt[I]!==void 0)qt=!0;else continue;Fe[I]=Bt&&Bt[I]||l.style(o,I)}if(re=!l.isEmptyObject(p),!(!re&&l.isEmptyObject(Fe))){Te&&o.nodeType===1&&(x.overflow=[yt.overflow,yt.overflowX,yt.overflowY],de=Bt&&Bt.display,de==null&&(de=Xe.get(o,"display")),Ce=l.css(o,"display"),Ce==="none"&&(de?Ce=de:(fe([o],!0),de=o.style.display||de,Ce=l.css(o,"display"),fe([o]))),(Ce==="inline"||Ce==="inline-block"&&de!=null)&&l.css(o,"float")==="none"&&(re||(be.done(function(){yt.display=de}),de==null&&(Ce=yt.display,de=Ce==="none"?"":Ce)),yt.display="inline-block")),x.overflow&&(yt.overflow="hidden",be.always(function(){yt.overflow=x.overflow[0],yt.overflowX=x.overflow[1],yt.overflowY=x.overflow[2]})),re=!1;for(I in Fe)re||(Bt?"hidden"in Bt&&(qt=Bt.hidden):Bt=Xe.access(o,"fxshow",{display:de}),U&&(Bt.hidden=!qt),qt&&fe([o],!0),be.done(function(){qt||fe([o]),Xe.remove(o,"fxshow");for(I in Fe)l.style(o,I,Fe[I])})),re=bs(qt?Bt[I]:0,I,be),I in Bt||(Bt[I]=re.start,qt&&(re.end=re.start,re.start=0))}}function mr(o,p){var x,I,q,U,$;for(x in o)if(I=kt(x),q=p[I],U=o[x],Array.isArray(U)&&(q=U[1],U=o[x]=U[0]),x!==I&&(o[I]=U,delete o[x]),$=l.cssHooks[I],$&&"expand"in $){U=$.expand(U),delete o[I];for(x in U)x in o||(o[x]=U[x],p[x]=q)}else p[I]=q}function Un(o,p,x){var I,q,U=0,$=Un.prefilters.length,le=l.Deferred().always(function(){delete re.elem}),re=function(){if(q)return!1;for(var Te=jn||vs(),be=Math.max(0,de.startTime+de.duration-Te),Fe=be/de.duration||0,yt=1-Fe,qt=0,Bt=de.tweens.length;qt<Bt;qt++)de.tweens[qt].run(yt);return le.notifyWith(o,[de,yt,be]),yt<1&&Bt?be:(Bt||le.notifyWith(o,[de,1,0]),le.resolveWith(o,[de]),!1)},de=le.promise({elem:o,props:l.extend({},p),opts:l.extend(!0,{specialEasing:{},easing:l.easing._default},x),originalProperties:p,originalOptions:x,startTime:jn||vs(),duration:x.duration,tweens:[],createTween:function(Te,be){var Fe=l.Tween(o,de.opts,Te,be,de.opts.specialEasing[Te]||de.opts.easing);return de.tweens.push(Fe),Fe},stop:function(Te){var be=0,Fe=Te?de.tweens.length:0;if(q)return this;for(q=!0;be<Fe;be++)de.tweens[be].run(1);return Te?(le.notifyWith(o,[de,1,0]),le.resolveWith(o,[de,Te])):le.rejectWith(o,[de,Te]),this}}),Ce=de.props;for(mr(Ce,de.opts.specialEasing);U<$;U++)if(I=Un.prefilters[U].call(de,o,Ce,de.opts),I)return C(I.stop)&&(l._queueHooks(de.elem,de.opts.queue).stop=I.stop.bind(I)),I;return l.map(Ce,bs,de),C(de.opts.start)&&de.opts.start.call(o,de),de.progress(de.opts.progress).done(de.opts.done,de.opts.complete).fail(de.opts.fail).always(de.opts.always),l.fx.timer(l.extend(re,{elem:o,anim:de,queue:de.opts.queue})),de}l.Animation=l.extend(Un,{tweeners:{"*":[function(o,p){var x=this.createTween(o,p);return ie(x.elem,o,j.exec(p),x),x}]},tweener:function(o,p){C(o)?(p=o,o=["*"]):o=o.match(pe);for(var x,I=0,q=o.length;I<q;I++)x=o[I],Un.tweeners[x]=Un.tweeners[x]||[],Un.tweeners[x].unshift(p)},prefilters:[uo],prefilter:function(o,p){p?Un.prefilters.unshift(o):Un.prefilters.push(o)}}),l.speed=function(o,p,x){var I=o&&typeof o=="object"?l.extend({},o):{complete:x||!x&&p||C(o)&&o,duration:o,easing:x&&p||p&&!C(p)&&p};return l.fx.off?I.duration=0:typeof I.duration!="number"&&(I.duration in l.fx.speeds?I.duration=l.fx.speeds[I.duration]:I.duration=l.fx.speeds._default),(I.queue==null||I.queue===!0)&&(I.queue="fx"),I.old=I.complete,I.complete=function(){C(I.old)&&I.old.call(this),I.queue&&l.dequeue(this,I.queue)},I},l.fn.extend({fadeTo:function(o,p,x,I){return this.filter(X).css("opacity",0).show().end().animate({opacity:p},o,x,I)},animate:function(o,p,x,I){var q=l.isEmptyObject(o),U=l.speed(p,x,I),$=function(){var le=Un(this,l.extend({},o),U);(q||Xe.get(this,"finish"))&&le.stop(!0)};return $.finish=$,q||U.queue===!1?this.each($):this.queue(U.queue,$)},stop:function(o,p,x){var I=function(q){var U=q.stop;delete q.stop,U(x)};return typeof o!="string"&&(x=p,p=o,o=void 0),p&&this.queue(o||"fx",[]),this.each(function(){var q=!0,U=o!=null&&o+"queueHooks",$=l.timers,le=Xe.get(this);if(U)le[U]&&le[U].stop&&I(le[U]);else for(U in le)le[U]&&le[U].stop&&Kn.test(U)&&I(le[U]);for(U=$.length;U--;)$[U].elem===this&&(o==null||$[U].queue===o)&&($[U].anim.stop(x),q=!1,$.splice(U,1));(q||!x)&&l.dequeue(this,o)})},finish:function(o){return o!==!1&&(o=o||"fx"),this.each(function(){var p,x=Xe.get(this),I=x[o+"queue"],q=x[o+"queueHooks"],U=l.timers,$=I?I.length:0;for(x.finish=!0,l.queue(this,o,[]),q&&q.stop&&q.stop.call(this,!0),p=U.length;p--;)U[p].elem===this&&U[p].queue===o&&(U[p].anim.stop(!0),U.splice(p,1));for(p=0;p<$;p++)I[p]&&I[p].finish&&I[p].finish.call(this);delete x.finish})}}),l.each(["toggle","show","hide"],function(o,p){var x=l.fn[p];l.fn[p]=function(I,q,U){return I==null||typeof I=="boolean"?x.apply(this,arguments):this.animate(Gs(p,!0),I,q,U)}}),l.each({slideDown:Gs("show"),slideUp:Gs("hide"),slideToggle:Gs("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(o,p){l.fn[o]=function(x,I,q){return this.animate(p,x,I,q)}}),l.timers=[],l.fx.tick=function(){var o,p=0,x=l.timers;for(jn=Date.now();p<x.length;p++)o=x[p],!o()&&x[p]===o&&x.splice(p--,1);x.length||l.fx.stop(),jn=void 0},l.fx.timer=function(o){l.timers.push(o),l.fx.start()},l.fx.interval=13,l.fx.start=function(){Ks||(Ks=!0,Ns())},l.fx.stop=function(){Ks=null},l.fx.speeds={slow:600,fast:200,_default:400},l.fn.delay=function(o,p){return o=l.fx&&l.fx.speeds[o]||o,p=p||"fx",this.queue(p,function(x,I){var q=e.setTimeout(x,o);I.stop=function(){e.clearTimeout(q)}})},function(){var o=T.createElement("input"),p=T.createElement("select"),x=p.appendChild(T.createElement("option"));o.type="checkbox",A.checkOn=o.value!=="",A.optSelected=x.selected,o=T.createElement("input"),o.value="t",o.type="radio",A.radioValue=o.value==="t"}();var gr,ys=l.expr.attrHandle;l.fn.extend({attr:function(o,p){return St(this,l.attr,o,p,arguments.length>1)},removeAttr:function(o){return this.each(function(){l.removeAttr(this,o)})}}),l.extend({attr:function(o,p,x){var I,q,U=o.nodeType;if(!(U===3||U===8||U===2)){if(typeof o.getAttribute>"u")return l.prop(o,p,x);if((U!==1||!l.isXMLDoc(o))&&(q=l.attrHooks[p.toLowerCase()]||(l.expr.match.bool.test(p)?gr:void 0)),x!==void 0){if(x===null){l.removeAttr(o,p);return}return q&&"set"in q&&(I=q.set(o,x,p))!==void 0?I:(o.setAttribute(p,x+""),x)}return q&&"get"in q&&(I=q.get(o,p))!==null?I:(I=l.find.attr(o,p),I??void 0)}},attrHooks:{type:{set:function(o,p){if(!A.radioValue&&p==="radio"&&L(o,"input")){var x=o.value;return o.setAttribute("type",p),x&&(o.value=x),p}}}},removeAttr:function(o,p){var x,I=0,q=p&&p.match(pe);if(q&&o.nodeType===1)for(;x=q[I++];)o.removeAttribute(x)}}),gr={set:function(o,p,x){return p===!1?l.removeAttr(o,x):o.setAttribute(x,x),x}},l.each(l.expr.match.bool.source.match(/\w+/g),function(o,p){var x=ys[p]||l.find.attr;ys[p]=function(I,q,U){var $,le,re=q.toLowerCase();return U||(le=ys[re],ys[re]=$,$=x(I,q,U)!=null?re:null,ys[re]=le),$}});var k0=/^(?:input|select|textarea|button)$/i,P0=/^(?:a|area)$/i;l.fn.extend({prop:function(o,p){return St(this,l.prop,o,p,arguments.length>1)},removeProp:function(o){return this.each(function(){delete this[l.propFix[o]||o]})}}),l.extend({prop:function(o,p,x){var I,q,U=o.nodeType;if(!(U===3||U===8||U===2))return(U!==1||!l.isXMLDoc(o))&&(p=l.propFix[p]||p,q=l.propHooks[p]),x!==void 0?q&&"set"in q&&(I=q.set(o,x,p))!==void 0?I:o[p]=x:q&&"get"in q&&(I=q.get(o,p))!==null?I:o[p]},propHooks:{tabIndex:{get:function(o){var p=l.find.attr(o,"tabindex");return p?parseInt(p,10):k0.test(o.nodeName)||P0.test(o.nodeName)&&o.href?0:-1}}},propFix:{for:"htmlFor",class:"className"}}),A.optSelected||(l.propHooks.selected={get:function(o){var p=o.parentNode;return p&&p.parentNode&&p.parentNode.selectedIndex,null},set:function(o){var p=o.parentNode;p&&(p.selectedIndex,p.parentNode&&p.parentNode.selectedIndex)}}),l.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){l.propFix[this.toLowerCase()]=this});function vr(o){var p=o.match(pe)||[];return p.join(" ")}function br(o){return o.getAttribute&&o.getAttribute("class")||""}function nl(o){return Array.isArray(o)?o:typeof o=="string"?o.match(pe)||[]:[]}l.fn.extend({addClass:function(o){var p,x,I,q,U,$;return C(o)?this.each(function(le){l(this).addClass(o.call(this,le,br(this)))}):(p=nl(o),p.length?this.each(function(){if(I=br(this),x=this.nodeType===1&&" "+vr(I)+" ",x){for(U=0;U<p.length;U++)q=p[U],x.indexOf(" "+q+" ")<0&&(x+=q+" ");$=vr(x),I!==$&&this.setAttribute("class",$)}}):this)},removeClass:function(o){var p,x,I,q,U,$;return C(o)?this.each(function(le){l(this).removeClass(o.call(this,le,br(this)))}):arguments.length?(p=nl(o),p.length?this.each(function(){if(I=br(this),x=this.nodeType===1&&" "+vr(I)+" ",x){for(U=0;U<p.length;U++)for(q=p[U];x.indexOf(" "+q+" ")>-1;)x=x.replace(" "+q+" "," ");$=vr(x),I!==$&&this.setAttribute("class",$)}}):this):this.attr("class","")},toggleClass:function(o,p){var x,I,q,U,$=typeof o,le=$==="string"||Array.isArray(o);return C(o)?this.each(function(re){l(this).toggleClass(o.call(this,re,br(this),p),p)}):typeof p=="boolean"&&le?p?this.addClass(o):this.removeClass(o):(x=nl(o),this.each(function(){if(le)for(U=l(this),q=0;q<x.length;q++)I=x[q],U.hasClass(I)?U.removeClass(I):U.addClass(I);else(o===void 0||$==="boolean")&&(I=br(this),I&&Xe.set(this,"__className__",I),this.setAttribute&&this.setAttribute("class",I||o===!1?"":Xe.get(this,"__className__")||""))}))},hasClass:function(o){var p,x,I=0;for(p=" "+o+" ";x=this[I++];)if(x.nodeType===1&&(" "+vr(br(x))+" ").indexOf(p)>-1)return!0;return!1}});var E0=/\r/g;l.fn.extend({val:function(o){var p,x,I,q=this[0];return arguments.length?(I=C(o),this.each(function(U){var $;this.nodeType===1&&(I?$=o.call(this,U,l(this).val()):$=o,$==null?$="":typeof $=="number"?$+="":Array.isArray($)&&($=l.map($,function(le){return le==null?"":le+""})),p=l.valHooks[this.type]||l.valHooks[this.nodeName.toLowerCase()],(!p||!("set"in p)||p.set(this,$,"value")===void 0)&&(this.value=$))})):q?(p=l.valHooks[q.type]||l.valHooks[q.nodeName.toLowerCase()],p&&"get"in p&&(x=p.get(q,"value"))!==void 0?x:(x=q.value,typeof x=="string"?x.replace(E0,""):x??"")):void 0}}),l.extend({valHooks:{option:{get:function(o){var p=l.find.attr(o,"value");return p??vr(l.text(o))}},select:{get:function(o){var p,x,I,q=o.options,U=o.selectedIndex,$=o.type==="select-one",le=$?null:[],re=$?U+1:q.length;for(U<0?I=re:I=$?U:0;I<re;I++)if(x=q[I],(x.selected||I===U)&&!x.disabled&&(!x.parentNode.disabled||!L(x.parentNode,"optgroup"))){if(p=l(x).val(),$)return p;le.push(p)}return le},set:function(o,p){for(var x,I,q=o.options,U=l.makeArray(p),$=q.length;$--;)I=q[$],(I.selected=l.inArray(l.valHooks.option.get(I),U)>-1)&&(x=!0);return x||(o.selectedIndex=-1),U}}}}),l.each(["radio","checkbox"],function(){l.valHooks[this]={set:function(o,p){if(Array.isArray(p))return o.checked=l.inArray(l(o).val(),p)>-1}},A.checkOn||(l.valHooks[this].get=function(o){return o.getAttribute("value")===null?"on":o.value})});var fo=e.location,Oh={guid:Date.now()},il=/\?/;l.parseXML=function(o){var p,x;if(!o||typeof o!="string")return null;try{p=new e.DOMParser().parseFromString(o,"text/xml")}catch{}return x=p&&p.getElementsByTagName("parsererror")[0],(!p||x)&&l.error("Invalid XML: "+(x?l.map(x.childNodes,function(I){return I.textContent}).join(`
`):o)),p};var Hh=/^(?:focusinfocus|focusoutblur)$/,Vh=function(o){o.stopPropagation()};l.extend(l.event,{trigger:function(o,p,x,I){var q,U,$,le,re,de,Ce,Te,be=[x||T],Fe=g.call(o,"type")?o.type:o,yt=g.call(o,"namespace")?o.namespace.split("."):[];if(U=Te=$=x=x||T,!(x.nodeType===3||x.nodeType===8)&&!Hh.test(Fe+l.event.triggered)&&(Fe.indexOf(".")>-1&&(yt=Fe.split("."),Fe=yt.shift(),yt.sort()),re=Fe.indexOf(":")<0&&"on"+Fe,o=o[l.expando]?o:new l.Event(Fe,typeof o=="object"&&o),o.isTrigger=I?2:3,o.namespace=yt.join("."),o.rnamespace=o.namespace?new RegExp("(^|\\.)"+yt.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,o.result=void 0,o.target||(o.target=x),p=p==null?[o]:l.makeArray(p,[o]),Ce=l.event.special[Fe]||{},!(!I&&Ce.trigger&&Ce.trigger.apply(x,p)===!1))){if(!I&&!Ce.noBubble&&!k(x)){for(le=Ce.delegateType||Fe,Hh.test(le+Fe)||(U=U.parentNode);U;U=U.parentNode)be.push(U),$=U;$===(x.ownerDocument||T)&&be.push($.defaultView||$.parentWindow||e)}for(q=0;(U=be[q++])&&!o.isPropagationStopped();)Te=U,o.type=q>1?le:Ce.bindType||Fe,de=(Xe.get(U,"events")||Object.create(null))[o.type]&&Xe.get(U,"handle"),de&&de.apply(U,p),de=re&&U[re],de&&de.apply&&bt(U)&&(o.result=de.apply(U,p),o.result===!1&&o.preventDefault());return o.type=Fe,!I&&!o.isDefaultPrevented()&&(!Ce._default||Ce._default.apply(be.pop(),p)===!1)&&bt(x)&&re&&C(x[Fe])&&!k(x)&&($=x[re],$&&(x[re]=null),l.event.triggered=Fe,o.isPropagationStopped()&&Te.addEventListener(Fe,Vh),x[Fe](),o.isPropagationStopped()&&Te.removeEventListener(Fe,Vh),l.event.triggered=void 0,$&&(x[re]=$)),o.result}},simulate:function(o,p,x){var I=l.extend(new l.Event,x,{type:o,isSimulated:!0});l.event.trigger(I,null,p)}}),l.fn.extend({trigger:function(o,p){return this.each(function(){l.event.trigger(o,p,this)})},triggerHandler:function(o,p){var x=this[0];if(x)return l.event.trigger(o,p,x,!0)}});var B0=/\[\]$/,Wh=/\r?\n/g,M0=/^(?:submit|button|image|reset|file)$/i,T0=/^(?:input|select|textarea|keygen)/i;function sl(o,p,x,I){var q;if(Array.isArray(p))l.each(p,function(U,$){x||B0.test(o)?I(o,$):sl(o+"["+(typeof $=="object"&&$!=null?U:"")+"]",$,x,I)});else if(!x&&V(p)==="object")for(q in p)sl(o+"["+q+"]",p[q],x,I);else I(o,p)}l.param=function(o,p){var x,I=[],q=function(U,$){var le=C($)?$():$;I[I.length]=encodeURIComponent(U)+"="+encodeURIComponent(le??"")};if(o==null)return"";if(Array.isArray(o)||o.jquery&&!l.isPlainObject(o))l.each(o,function(){q(this.name,this.value)});else for(x in o)sl(x,o[x],p,q);return I.join("&")},l.fn.extend({serialize:function(){return l.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var o=l.prop(this,"elements");return o?l.makeArray(o):this}).filter(function(){var o=this.type;return this.name&&!l(this).is(":disabled")&&T0.test(this.nodeName)&&!M0.test(o)&&(this.checked||!ce.test(o))}).map(function(o,p){var x=l(this).val();return x==null?null:Array.isArray(x)?l.map(x,function(I){return{name:p.name,value:I.replace(Wh,`\r
`)}}):{name:p.name,value:x.replace(Wh,`\r
`)}}).get()}});var I0=/%20/g,A0=/#.*$/,R0=/([?&])_=[^&]*/,L0=/^(.*?):[ \t]*([^\r\n]*)$/mg,N0=/^(?:about|app|app-storage|.+-extension|file|res|widget):$/,D0=/^(?:GET|HEAD)$/,F0=/^\/\//,qh={},rl={},Uh="*/".concat("*"),ol=T.createElement("a");ol.href=fo.href;function zh(o){return function(p,x){typeof p!="string"&&(x=p,p="*");var I,q=0,U=p.toLowerCase().match(pe)||[];if(C(x))for(;I=U[q++];)I[0]==="+"?(I=I.slice(1)||"*",(o[I]=o[I]||[]).unshift(x)):(o[I]=o[I]||[]).push(x)}}function Xh(o,p,x,I){var q={},U=o===rl;function $(le){var re;return q[le]=!0,l.each(o[le]||[],function(de,Ce){var Te=Ce(p,x,I);if(typeof Te=="string"&&!U&&!q[Te])return p.dataTypes.unshift(Te),$(Te),!1;if(U)return!(re=Te)}),re}return $(p.dataTypes[0])||!q["*"]&&$("*")}function al(o,p){var x,I,q=l.ajaxSettings.flatOptions||{};for(x in p)p[x]!==void 0&&((q[x]?o:I||(I={}))[x]=p[x]);return I&&l.extend(!0,o,I),o}function O0(o,p,x){for(var I,q,U,$,le=o.contents,re=o.dataTypes;re[0]==="*";)re.shift(),I===void 0&&(I=o.mimeType||p.getResponseHeader("Content-Type"));if(I){for(q in le)if(le[q]&&le[q].test(I)){re.unshift(q);break}}if(re[0]in x)U=re[0];else{for(q in x){if(!re[0]||o.converters[q+" "+re[0]]){U=q;break}$||($=q)}U=U||$}if(U)return U!==re[0]&&re.unshift(U),x[U]}function H0(o,p,x,I){var q,U,$,le,re,de={},Ce=o.dataTypes.slice();if(Ce[1])for($ in o.converters)de[$.toLowerCase()]=o.converters[$];for(U=Ce.shift();U;)if(o.responseFields[U]&&(x[o.responseFields[U]]=p),!re&&I&&o.dataFilter&&(p=o.dataFilter(p,o.dataType)),re=U,U=Ce.shift(),U){if(U==="*")U=re;else if(re!=="*"&&re!==U){if($=de[re+" "+U]||de["* "+U],!$){for(q in de)if(le=q.split(" "),le[1]===U&&($=de[re+" "+le[0]]||de["* "+le[0]],$)){$===!0?$=de[q]:de[q]!==!0&&(U=le[0],Ce.unshift(le[1]));break}}if($!==!0)if($&&o.throws)p=$(p);else try{p=$(p)}catch(Te){return{state:"parsererror",error:$?Te:"No conversion from "+re+" to "+U}}}}return{state:"success",data:p}}l.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:fo.href,type:"GET",isLocal:N0.test(fo.protocol),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":Uh,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/\bxml\b/,html:/\bhtml/,json:/\bjson\b/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":JSON.parse,"text xml":l.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(o,p){return p?al(al(o,l.ajaxSettings),p):al(l.ajaxSettings,o)},ajaxPrefilter:zh(qh),ajaxTransport:zh(rl),ajax:function(o,p){typeof o=="object"&&(p=o,o=void 0),p=p||{};var x,I,q,U,$,le,re,de,Ce,Te,be=l.ajaxSetup({},p),Fe=be.context||be,yt=be.context&&(Fe.nodeType||Fe.jquery)?l(Fe):l.event,qt=l.Deferred(),Bt=l.Callbacks("once memory"),zn=be.statusCode||{},Rn={},ws={},xs="canceled",Dt={readyState:0,getResponseHeader:function(Xt){var bn;if(re){if(!U)for(U={};bn=L0.exec(q);)U[bn[1].toLowerCase()+" "]=(U[bn[1].toLowerCase()+" "]||[]).concat(bn[2]);bn=U[Xt.toLowerCase()+" "]}return bn==null?null:bn.join(", ")},getAllResponseHeaders:function(){return re?q:null},setRequestHeader:function(Xt,bn){return re==null&&(Xt=ws[Xt.toLowerCase()]=ws[Xt.toLowerCase()]||Xt,Rn[Xt]=bn),this},overrideMimeType:function(Xt){return re==null&&(be.mimeType=Xt),this},statusCode:function(Xt){var bn;if(Xt)if(re)Dt.always(Xt[Dt.status]);else for(bn in Xt)zn[bn]=[zn[bn],Xt[bn]];return this},abort:function(Xt){var bn=Xt||xs;return x&&x.abort(bn),yr(0,bn),this}};if(qt.promise(Dt),be.url=((o||be.url||fo.href)+"").replace(F0,fo.protocol+"//"),be.type=p.method||p.type||be.method||be.type,be.dataTypes=(be.dataType||"*").toLowerCase().match(pe)||[""],be.crossDomain==null){le=T.createElement("a");try{le.href=be.url,le.href=le.href,be.crossDomain=ol.protocol+"//"+ol.host!=le.protocol+"//"+le.host}catch{be.crossDomain=!0}}if(be.data&&be.processData&&typeof be.data!="string"&&(be.data=l.param(be.data,be.traditional)),Xh(qh,be,p,Dt),re)return Dt;de=l.event&&be.global,de&&l.active++===0&&l.event.trigger("ajaxStart"),be.type=be.type.toUpperCase(),be.hasContent=!D0.test(be.type),I=be.url.replace(A0,""),be.hasContent?be.data&&be.processData&&(be.contentType||"").indexOf("application/x-www-form-urlencoded")===0&&(be.data=be.data.replace(I0,"+")):(Te=be.url.slice(I.length),be.data&&(be.processData||typeof be.data=="string")&&(I+=(il.test(I)?"&":"?")+be.data,delete be.data),be.cache===!1&&(I=I.replace(R0,"$1"),Te=(il.test(I)?"&":"?")+"_="+Oh.guid+++Te),be.url=I+Te),be.ifModified&&(l.lastModified[I]&&Dt.setRequestHeader("If-Modified-Since",l.lastModified[I]),l.etag[I]&&Dt.setRequestHeader("If-None-Match",l.etag[I])),(be.data&&be.hasContent&&be.contentType!==!1||p.contentType)&&Dt.setRequestHeader("Content-Type",be.contentType),Dt.setRequestHeader("Accept",be.dataTypes[0]&&be.accepts[be.dataTypes[0]]?be.accepts[be.dataTypes[0]]+(be.dataTypes[0]!=="*"?", "+Uh+"; q=0.01":""):be.accepts["*"]);for(Ce in be.headers)Dt.setRequestHeader(Ce,be.headers[Ce]);if(be.beforeSend&&(be.beforeSend.call(Fe,Dt,be)===!1||re))return Dt.abort();if(xs="abort",Bt.add(be.complete),Dt.done(be.success),Dt.fail(be.error),x=Xh(rl,be,p,Dt),!x)yr(-1,"No Transport");else{if(Dt.readyState=1,de&&yt.trigger("ajaxSend",[Dt,be]),re)return Dt;be.async&&be.timeout>0&&($=e.setTimeout(function(){Dt.abort("timeout")},be.timeout));try{re=!1,x.send(Rn,yr)}catch(Xt){if(re)throw Xt;yr(-1,Xt)}}function yr(Xt,bn,_o,hl){var Ss,mo,Cs,Zs,Qs,Gi=bn;re||(re=!0,$&&e.clearTimeout($),x=void 0,q=hl||"",Dt.readyState=Xt>0?4:0,Ss=Xt>=200&&Xt<300||Xt===304,_o&&(Zs=O0(be,Dt,_o)),!Ss&&l.inArray("script",be.dataTypes)>-1&&l.inArray("json",be.dataTypes)<0&&(be.converters["text script"]=function(){}),Zs=H0(be,Zs,Dt,Ss),Ss?(be.ifModified&&(Qs=Dt.getResponseHeader("Last-Modified"),Qs&&(l.lastModified[I]=Qs),Qs=Dt.getResponseHeader("etag"),Qs&&(l.etag[I]=Qs)),Xt===204||be.type==="HEAD"?Gi="nocontent":Xt===304?Gi="notmodified":(Gi=Zs.state,mo=Zs.data,Cs=Zs.error,Ss=!Cs)):(Cs=Gi,(Xt||!Gi)&&(Gi="error",Xt<0&&(Xt=0))),Dt.status=Xt,Dt.statusText=(bn||Gi)+"",Ss?qt.resolveWith(Fe,[mo,Gi,Dt]):qt.rejectWith(Fe,[Dt,Gi,Cs]),Dt.statusCode(zn),zn=void 0,de&&yt.trigger(Ss?"ajaxSuccess":"ajaxError",[Dt,be,Ss?mo:Cs]),Bt.fireWith(Fe,[Dt,Gi]),de&&(yt.trigger("ajaxComplete",[Dt,be]),--l.active||l.event.trigger("ajaxStop")))}return Dt},getJSON:function(o,p,x){return l.get(o,p,x,"json")},getScript:function(o,p){return l.get(o,void 0,p,"script")}}),l.each(["get","post"],function(o,p){l[p]=function(x,I,q,U){return C(I)&&(U=U||q,q=I,I=void 0),l.ajax(l.extend({url:x,type:p,dataType:U,data:I,success:q},l.isPlainObject(x)&&x))}}),l.ajaxPrefilter(function(o){var p;for(p in o.headers)p.toLowerCase()==="content-type"&&(o.contentType=o.headers[p]||"")}),l._evalUrl=function(o,p,x){return l.ajax({url:o,type:"GET",dataType:"script",cache:!0,async:!1,global:!1,converters:{"text script":function(){}},dataFilter:function(I){l.globalEval(I,p,x)}})},l.fn.extend({wrapAll:function(o){var p;return this[0]&&(C(o)&&(o=o.call(this[0])),p=l(o,this[0].ownerDocument).eq(0).clone(!0),this[0].parentNode&&p.insertBefore(this[0]),p.map(function(){for(var x=this;x.firstElementChild;)x=x.firstElementChild;return x}).append(this)),this},wrapInner:function(o){return C(o)?this.each(function(p){l(this).wrapInner(o.call(this,p))}):this.each(function(){var p=l(this),x=p.contents();x.length?x.wrapAll(o):p.append(o)})},wrap:function(o){var p=C(o);return this.each(function(x){l(this).wrapAll(p?o.call(this,x):o)})},unwrap:function(o){return this.parent(o).not("body").each(function(){l(this).replaceWith(this.childNodes)}),this}}),l.expr.pseudos.hidden=function(o){return!l.expr.pseudos.visible(o)},l.expr.pseudos.visible=function(o){return!!(o.offsetWidth||o.offsetHeight||o.getClientRects().length)},l.ajaxSettings.xhr=function(){try{return new e.XMLHttpRequest}catch{}};var V0={0:200,1223:204},po=l.ajaxSettings.xhr();A.cors=!!po&&"withCredentials"in po,A.ajax=po=!!po,l.ajaxTransport(function(o){var p,x;if(A.cors||po&&!o.crossDomain)return{send:function(I,q){var U,$=o.xhr();if($.open(o.type,o.url,o.async,o.username,o.password),o.xhrFields)for(U in o.xhrFields)$[U]=o.xhrFields[U];o.mimeType&&$.overrideMimeType&&$.overrideMimeType(o.mimeType),!o.crossDomain&&!I["X-Requested-With"]&&(I["X-Requested-With"]="XMLHttpRequest");for(U in I)$.setRequestHeader(U,I[U]);p=function(le){return function(){p&&(p=x=$.onload=$.onerror=$.onabort=$.ontimeout=$.onreadystatechange=null,le==="abort"?$.abort():le==="error"?typeof $.status!="number"?q(0,"error"):q($.status,$.statusText):q(V0[$.status]||$.status,$.statusText,($.responseType||"text")!=="text"||typeof $.responseText!="string"?{binary:$.response}:{text:$.responseText},$.getAllResponseHeaders()))}},$.onload=p(),x=$.onerror=$.ontimeout=p("error"),$.onabort!==void 0?$.onabort=x:$.onreadystatechange=function(){$.readyState===4&&e.setTimeout(function(){p&&x()})},p=p("abort");try{$.send(o.hasContent&&o.data||null)}catch(le){if(p)throw le}},abort:function(){p&&p()}}}),l.ajaxPrefilter(function(o){o.crossDomain&&(o.contents.script=!1)}),l.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/\b(?:java|ecma)script\b/},converters:{"text script":function(o){return l.globalEval(o),o}}}),l.ajaxPrefilter("script",function(o){o.cache===void 0&&(o.cache=!1),o.crossDomain&&(o.type="GET")}),l.ajaxTransport("script",function(o){if(o.crossDomain||o.scriptAttrs){var p,x;return{send:function(I,q){p=l("<script>").attr(o.scriptAttrs||{}).prop({charset:o.scriptCharset,src:o.url}).on("load error",x=function(U){p.remove(),x=null,U&&q(U.type==="error"?404:200,U.type)}),T.head.appendChild(p[0])},abort:function(){x&&x()}}}});var $h=[],ll=/(=)\?(?=&|$)|\?\?/;l.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var o=$h.pop()||l.expando+"_"+Oh.guid++;return this[o]=!0,o}}),l.ajaxPrefilter("json jsonp",function(o,p,x){var I,q,U,$=o.jsonp!==!1&&(ll.test(o.url)?"url":typeof o.data=="string"&&(o.contentType||"").indexOf("application/x-www-form-urlencoded")===0&&ll.test(o.data)&&"data");if($||o.dataTypes[0]==="jsonp")return I=o.jsonpCallback=C(o.jsonpCallback)?o.jsonpCallback():o.jsonpCallback,$?o[$]=o[$].replace(ll,"$1"+I):o.jsonp!==!1&&(o.url+=(il.test(o.url)?"&":"?")+o.jsonp+"="+I),o.converters["script json"]=function(){return U||l.error(I+" was not called"),U[0]},o.dataTypes[0]="json",q=e[I],e[I]=function(){U=arguments},x.always(function(){q===void 0?l(e).removeProp(I):e[I]=q,o[I]&&(o.jsonpCallback=p.jsonpCallback,$h.push(I)),U&&C(q)&&q(U[0]),U=q=void 0}),"script"}),A.createHTMLDocument=function(){var o=T.implementation.createHTMLDocument("").body;return o.innerHTML="<form></form><form></form>",o.childNodes.length===2}(),l.parseHTML=function(o,p,x){if(typeof o!="string")return[];typeof p=="boolean"&&(x=p,p=!1);var I,q,U;return p||(A.createHTMLDocument?(p=T.implementation.createHTMLDocument(""),I=p.createElement("base"),I.href=T.location.href,p.head.appendChild(I)):p=T),q=Z.exec(o),U=!x&&[],q?[p.createElement(q[1])]:(q=ze([o],p,U),U&&U.length&&l(U).remove(),l.merge([],q.childNodes))},l.fn.load=function(o,p,x){var I,q,U,$=this,le=o.indexOf(" ");return le>-1&&(I=vr(o.slice(le)),o=o.slice(0,le)),C(p)?(x=p,p=void 0):p&&typeof p=="object"&&(q="POST"),$.length>0&&l.ajax({url:o,type:q||"GET",dataType:"html",data:p}).done(function(re){U=arguments,$.html(I?l("<div>").append(l.parseHTML(re)).find(I):re)}).always(x&&function(re,de){$.each(function(){x.apply(this,U||[re.responseText,de,re])})}),this},l.expr.pseudos.animated=function(o){return l.grep(l.timers,function(p){return o===p.elem}).length},l.offset={setOffset:function(o,p,x){var I,q,U,$,le,re,de,Ce=l.css(o,"position"),Te=l(o),be={};Ce==="static"&&(o.style.position="relative"),le=Te.offset(),U=l.css(o,"top"),re=l.css(o,"left"),de=(Ce==="absolute"||Ce==="fixed")&&(U+re).indexOf("auto")>-1,de?(I=Te.position(),$=I.top,q=I.left):($=parseFloat(U)||0,q=parseFloat(re)||0),C(p)&&(p=p.call(o,x,l.extend({},le))),p.top!=null&&(be.top=p.top-le.top+$),p.left!=null&&(be.left=p.left-le.left+q),"using"in p?p.using.call(o,be):Te.css(be)}},l.fn.extend({offset:function(o){if(arguments.length)return o===void 0?this:this.each(function(q){l.offset.setOffset(this,o,q)});var p,x,I=this[0];if(I)return I.getClientRects().length?(p=I.getBoundingClientRect(),x=I.ownerDocument.defaultView,{top:p.top+x.pageYOffset,left:p.left+x.pageXOffset}):{top:0,left:0}},position:function(){if(this[0]){var o,p,x,I=this[0],q={top:0,left:0};if(l.css(I,"position")==="fixed")p=I.getBoundingClientRect();else{for(p=this.offset(),x=I.ownerDocument,o=I.offsetParent||x.documentElement;o&&(o===x.body||o===x.documentElement)&&l.css(o,"position")==="static";)o=o.parentNode;o&&o!==I&&o.nodeType===1&&(q=l(o).offset(),q.top+=l.css(o,"borderTopWidth",!0),q.left+=l.css(o,"borderLeftWidth",!0))}return{top:p.top-q.top-l.css(I,"marginTop",!0),left:p.left-q.left-l.css(I,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){for(var o=this.offsetParent;o&&l.css(o,"position")==="static";)o=o.offsetParent;return o||z})}}),l.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(o,p){var x=p==="pageYOffset";l.fn[o]=function(I){return St(this,function(q,U,$){var le;if(k(q)?le=q:q.nodeType===9&&(le=q.defaultView),$===void 0)return le?le[p]:q[U];le?le.scrollTo(x?le.pageXOffset:$,x?$:le.pageYOffset):q[U]=$},o,I,arguments.length)}}),l.each(["top","left"],function(o,p){l.cssHooks[p]=Ys(A.pixelPosition,function(x,I){if(I)return I=ai(x,p),En.test(I)?l(x).position()[p]+"px":I})}),l.each({Height:"height",Width:"width"},function(o,p){l.each({padding:"inner"+o,content:p,"":"outer"+o},function(x,I){l.fn[I]=function(q,U){var $=arguments.length&&(x||typeof q!="boolean"),le=x||(q===!0||U===!0?"margin":"border");return St(this,function(re,de,Ce){var Te;return k(re)?I.indexOf("outer")===0?re["inner"+o]:re.document.documentElement["client"+o]:re.nodeType===9?(Te=re.documentElement,Math.max(re.body["scroll"+o],Te["scroll"+o],re.body["offset"+o],Te["offset"+o],Te["client"+o])):Ce===void 0?l.css(re,de,le):l.style(re,de,Ce,le)},p,$?q:void 0,$)}})}),l.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(o,p){l.fn[p]=function(x){return this.on(p,x)}}),l.fn.extend({bind:function(o,p,x){return this.on(o,null,p,x)},unbind:function(o,p){return this.off(o,null,p)},delegate:function(o,p,x,I){return this.on(p,o,x,I)},undelegate:function(o,p,x){return arguments.length===1?this.off(o,"**"):this.off(p,o||"**",x)},hover:function(o,p){return this.on("mouseenter",o).on("mouseleave",p||o)}}),l.each("blur focus focusin focusout resize scroll click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup contextmenu".split(" "),function(o,p){l.fn[p]=function(x,I){return arguments.length>0?this.on(p,null,x,I):this.trigger(p)}});var W0=/^[\s\uFEFF\xA0]+|([^\s\uFEFF\xA0])[\s\uFEFF\xA0]+$/g;l.proxy=function(o,p){var x,I,q;if(typeof p=="string"&&(x=o[p],p=o,o=x),!!C(o))return I=s.call(arguments,2),q=function(){return o.apply(p||this,I.concat(s.call(arguments)))},q.guid=o.guid=o.guid||l.guid++,q},l.holdReady=function(o){o?l.readyWait++:l.ready(!0)},l.isArray=Array.isArray,l.parseJSON=JSON.parse,l.nodeName=L,l.isFunction=C,l.isWindow=k,l.camelCase=kt,l.type=V,l.now=Date.now,l.isNumeric=function(o){var p=l.type(o);return(p==="number"||p==="string")&&!isNaN(o-parseFloat(o))},l.trim=function(o){return o==null?"":(o+"").replace(W0,"$1")};var q0=e.jQuery,U0=e.$;return l.noConflict=function(o){return e.$===l&&(e.$=U0),o&&e.jQuery===l&&(e.jQuery=q0),l},typeof t>"u"&&(e.jQuery=e.$=l),l})})(gu);var D_=gu.exports;const ut=N_(D_);class Rc{constructor(e,t,n,i){a(this,"_text",document.createTextNode("1"));a(this,"_label",me.text({"font-family":"sans-serif","font-size":20,"text-anchor":"middle","font-weight":"bold",fill:"red"},this._text));a(this,"_rect",me.rect({x:1,y:1}));a(this,"container",me.svg(this._rect,this._label));a(this,"_renderedIndex",1);a(this,"_renderedDim",!0);a(this,"_renderedSelected",!1);a(this,"_renderedColor","");this._x=t,this._y=n,this._rect.setAttribute("fill",Q.uiWidgetBackground),this._label.setAttribute("fill",i)}setSize(e,t){this.container.setAttribute("x",""+this._x*e),this.container.setAttribute("y",""+(w.barEditorHeight+this._y*t)),this._rect.setAttribute("width",""+(e-2)),this._rect.setAttribute("height",""+(t-2)),this._label.setAttribute("x",""+e/2),this._label.setAttribute("y",""+Math.round(t/2+7))}setIndex(e,t,n,i,s,h){this._renderedIndex!=e&&(!this._renderedSelected&&e==0!=(this._renderedIndex==0)&&(e==0?this._rect.setAttribute("fill","none"):s?this._rect.setAttribute("fill",t?Q.trackEditorBgNoiseDim:Q.trackEditorBgNoise):h?this._rect.setAttribute("fill",t?Q.trackEditorBgModDim:Q.trackEditorBgMod):this._rect.setAttribute("fill",t?Q.trackEditorBgPitchDim:Q.trackEditorBgPitch)),e>=100?(this._label.setAttribute("font-size","16"),this._label.setAttribute("style","transform: translate(0px, -1.5px);")):(this._label.setAttribute("font-size","20"),this._label.setAttribute("style","transform: translate(0px, 0px);")),this._renderedIndex=e,this._text.data=""+e),(this._renderedDim!=t||this._renderedColor!=i)&&(this._renderedDim=t,n?this._label.setAttribute("fill",Q.invertedText):(this._label.setAttribute("fill",i),this._renderedIndex==0?this._rect.setAttribute("fill",Q.editorBackground):s?this._rect.setAttribute("fill",t?Q.trackEditorBgNoiseDim:Q.trackEditorBgNoise):h?this._rect.setAttribute("fill",t?Q.trackEditorBgModDim:Q.trackEditorBgMod):this._rect.setAttribute("fill",t?Q.trackEditorBgPitchDim:Q.trackEditorBgPitch))),(this._renderedSelected!=n||this._renderedColor!=i)&&(this._renderedSelected=n,n?(this._rect.setAttribute("fill",i),this._label.setAttribute("fill",Q.invertedText)):(this._label.setAttribute("fill",i),this._renderedIndex==0?this._rect.setAttribute("fill",Q.editorBackground):s?this._rect.setAttribute("fill",t?Q.trackEditorBgNoiseDim:Q.trackEditorBgNoise):h?this._rect.setAttribute("fill",t?Q.trackEditorBgModDim:Q.trackEditorBgMod):this._rect.setAttribute("fill",t?Q.trackEditorBgPitchDim:Q.trackEditorBgPitch))),this._renderedColor=i}}class F_{constructor(e,t){a(this,"_barDropDown",Ke.select({style:"width: 32px; height: "+w.barEditorHeight+"px; top: 0px; position: absolute; opacity: 0"},Ke.option({value:"barBefore"},"Insert Bar Before"),Ke.option({value:"barAfter"},"Insert Bar After"),Ke.option({value:"deleteBar"},"Delete This Bar")));a(this,"_boxContainer",me.g());a(this,"_barNumberContainer",me.g());a(this,"_playhead",me.rect({fill:Q.playhead,x:0,y:0,width:4,height:128}));a(this,"_boxHighlight",me.rect({fill:"none",stroke:Q.hoverPreview,"stroke-width":2,"pointer-events":"none",x:1,y:1,width:30,height:30}));a(this,"_upHighlight",me.path({fill:Q.invertedText,stroke:Q.invertedText,"stroke-width":1,"pointer-events":"none"}));a(this,"_downHighlight",me.path({fill:Q.invertedText,stroke:Q.invertedText,"stroke-width":1,"pointer-events":"none"}));a(this,"_barEditorPath",me.path({fill:Q.uiWidgetBackground,stroke:Q.uiWidgetBackground,"stroke-width":1,"pointer-events":"none"}));a(this,"_selectionRect",me.rect({class:"dashed-line dash-move",fill:Q.boxSelectionFill,stroke:Q.hoverPreview,"stroke-width":2,"stroke-dasharray":"5, 3","fill-opacity":"0.4","pointer-events":"none",visibility:"hidden",x:1,y:1,width:62,height:62}));a(this,"_svg",me.svg({style:`background-color: ${Q.editorBackground}; position: absolute;`,height:128},this._boxContainer,this._barEditorPath,this._selectionRect,this._barNumberContainer,this._boxHighlight,this._upHighlight,this._downHighlight,this._playhead));a(this,"_select",Ke.select({class:"trackSelectBox",style:"background: none; border: none; appearance: none; border-radius: initial; box-shadow: none; color: transparent; position: absolute; touch-action: none;"}));a(this,"container",Ke.div({class:"noSelection",style:"height: 128px; position: relative; overflow:hidden;"},this._svg,this._select,this._barDropDown));a(this,"_grid",[]);a(this,"_barNumbers",[]);a(this,"_mouseX",0);a(this,"_mouseY",0);a(this,"_mouseStartBar",0);a(this,"_mouseStartChannel",0);a(this,"_mouseBar",0);a(this,"_mouseChannel",0);a(this,"_mouseOver",!1);a(this,"_mousePressed",!1);a(this,"_mouseDragging",!1);a(this,"_barWidth",32);a(this,"_channelHeight",32);a(this,"_renderedChannelCount",0);a(this,"_renderedBarCount",0);a(this,"_renderedPatternCount",0);a(this,"_renderedPlayhead",-1);a(this,"_renderedBarWidth",-1);a(this,"_renderedChannelHeight",-1);a(this,"_touchMode",za);a(this,"_barDropDownBar",0);a(this,"_lastScrollTime",0);a(this,"_barDropDownGetOpenedPosition",e=>{this._barDropDownBar=Math.floor(Math.min(this._doc.song.barCount-1,Math.max(0,this._mouseX/this._barWidth)))});a(this,"_barDropDownHandler",e=>{var t=this._barDropDown.value=="barBefore"?0:1;this._barDropDown.value=="barBefore"||this._barDropDown.value=="barAfter"?(this._doc.bar=this._barDropDownBar-1+t,this._doc.selection.resetBoxSelection(),this._doc.selection.insertBars(),this._doc.synth.playhead>=this._barDropDownBar+t&&(this._doc.synth.playhead++,this._songEditor._barScrollBar.animatePlayhead())):this._barDropDown.value=="deleteBar"&&(this._doc.bar=this._barDropDownBar,this._doc.selection.resetBoxSelection(),this._doc.selection.deleteBars(),this._doc.synth.playhead>this._barDropDownBar&&(this._doc.synth.playhead--,this._songEditor._barScrollBar.animatePlayhead())),this._barDropDown.selectedIndex=-1});a(this,"_whenSelectChanged",()=>{this._doc.selection.setPattern(this._select.selectedIndex)});a(this,"_animatePlayhead",e=>{const t=this._barWidth*this._doc.synth.playhead-2;this._renderedPlayhead!=t&&(this._renderedPlayhead=t,this._playhead.setAttribute("x",""+t)),window.requestAnimationFrame(this._animatePlayhead)});a(this,"_whenSelectPressed",e=>{this._mousePressed=!0,this._mouseDragging=!0,this._updateSelectPos(e),this._mouseStartBar=this._mouseBar,this._mouseStartChannel=this._mouseChannel});a(this,"_whenSelectMoved",e=>{this._updateSelectPos(e),(this._mouseStartBar!=this._mouseBar||this._mouseStartChannel!=this._mouseChannel)&&e.preventDefault(),this._mousePressed&&this._dragBoxSelection(),this._updatePreview()});a(this,"_whenSelectReleased",e=>{this._mousePressed=!1,this._mouseDragging=!1,this._updatePreview()});a(this,"_whenMouseOver",e=>{this._mouseOver||(this._mouseOver=!0)});a(this,"_whenMouseOut",e=>{this._mouseOver&&(this._mouseOver=!1)});a(this,"_whenMousePressed",e=>{e.preventDefault(),this._mousePressed=!0,this._updateMousePos(e),this._mouseStartBar=this._mouseBar,this._mouseStartChannel=this._mouseChannel,this._mouseY>=w.barEditorHeight&&(e.shiftKey?(this._mouseDragging=!0,this._doc.selection.setTrackSelection(this._doc.selection.boxSelectionX0,this._mouseBar,this._doc.selection.boxSelectionY0,this._mouseChannel),this._doc.selection.selectionUpdated()):(this._mouseDragging=!1,(this._doc.channel!=this._mouseChannel||this._doc.bar!=this._mouseBar)&&(this._doc.selection.setChannelBar(this._mouseChannel,this._mouseBar),this._mouseDragging=!0),this._doc.selection.resetBoxSelection()))});a(this,"_whenMouseMoved",e=>{this._updateMousePos(e),this._mousePressed&&((this._mouseStartBar!=this._mouseBar||this._mouseStartChannel!=this._mouseChannel)&&(this._mouseDragging=!0),this._dragBoxSelection()),this._updatePreview()});a(this,"_whenMouseReleased",e=>{if(this._mousePressed&&!this._mouseDragging&&this._doc.channel==this._mouseChannel&&this._doc.bar==this._mouseBar){const t=(this._mouseY-w.barEditorHeight)%this._channelHeight<this._channelHeight/2,n=this._doc.song.patternsPerChannel;this._doc.selection.setPattern((this._doc.song.channels[this._mouseChannel].bars[this._mouseBar]+(t?1:n))%(n+1))}this._mousePressed=!1,this._mouseDragging=!1,this._updatePreview()});this._doc=e,this._songEditor=t,window.requestAnimationFrame(this._animatePlayhead),this._svg.addEventListener("mousedown",this._whenMousePressed),document.addEventListener("mousemove",this._whenMouseMoved),document.addEventListener("mouseup",this._whenMouseReleased),this._svg.addEventListener("mouseover",this._whenMouseOver),this._svg.addEventListener("mouseout",this._whenMouseOut),this._select.addEventListener("change",this._whenSelectChanged),this._select.addEventListener("touchstart",this._whenSelectPressed),this._select.addEventListener("touchmove",this._whenSelectMoved),this._select.addEventListener("touchend",this._whenSelectReleased),this._select.addEventListener("touchcancel",this._whenSelectReleased);let n=!1;document.addEventListener("mousedown",()=>{n||(this._touchMode=!1,this._updatePreview()),n=!0},!0),document.addEventListener("touchstart",()=>{n||(this._touchMode=!0,this._updatePreview()),n=!0},!0),this._barDropDown.selectedIndex=-1,this._barDropDown.addEventListener("change",this._barDropDownHandler),this._barDropDown.addEventListener("mousedown",this._barDropDownGetOpenedPosition)}movePlayheadToMouse(){return this._mouseOver?(this._doc.synth.playhead=this._mouseBar+this._mouseX%this._barWidth/this._barWidth,!0):!1}_dragBoxSelection(){this._doc.selection.setTrackSelection(this._doc.selection.boxSelectionX0,this._mouseBar,this._doc.selection.boxSelectionY0,this._mouseChannel),this._doc.selection.selectionUpdated()}_updateSelectPos(e){const t=this._svg.getBoundingClientRect();this._mouseX=e.touches[0].clientX-t.left,this._mouseY=e.touches[0].clientY-t.top,isNaN(this._mouseX)&&(this._mouseX=0),isNaN(this._mouseY)&&(this._mouseY=0),this._mouseBar=Math.floor(Math.min(this._doc.song.barCount-1,Math.max(0,this._mouseX/this._barWidth))),this._mouseChannel=Math.floor(Math.min(this._doc.song.getChannelCount()-1,Math.max(0,(this._mouseY-w.barEditorHeight)/this._channelHeight)))}_updateMousePos(e){const t=this._svg.getBoundingClientRect();this._mouseX=(e.clientX||e.pageX)-t.left,this._mouseY=(e.clientY||e.pageY)-t.top,this._mouseBar=Math.floor(Math.min(this._doc.song.barCount-1,Math.max(0,this._mouseX/this._barWidth))),this._mouseChannel=Math.floor(Math.min(this._doc.song.getChannelCount()-1,Math.max(0,(this._mouseY-w.barEditorHeight)/this._channelHeight)))}_updatePreview(){let e=this._mouseChannel,t=this._mouseBar;this._touchMode&&(t=this._doc.bar,e=this._doc.channel);const n=t==this._doc.bar&&e==this._doc.channel,i=this._mouseY>=w.barEditorHeight;if(this._mouseDragging&&this._mouseStartBar!=this._mouseBar){var s=Date.now();s-this._lastScrollTime>=50&&(t>this._doc.barScrollPos+this._doc.trackVisibleBars-1&&this._doc.barScrollPos<this._doc.song.barCount-this._doc.trackVisibleBars&&this._songEditor.changeBarScrollPos(1),t<this._doc.barScrollPos&&this._doc.barScrollPos>0&&this._songEditor.changeBarScrollPos(-1),this._lastScrollTime=s)}if(this._mouseOver&&!this._mousePressed&&!n&&i?(this._boxHighlight.setAttribute("x",""+(1+this._barWidth*t)),this._boxHighlight.setAttribute("y",""+(1+w.barEditorHeight+this._channelHeight*e)),this._boxHighlight.setAttribute("height",""+(this._channelHeight-2)),this._boxHighlight.setAttribute("width",""+(this._barWidth-2)),this._boxHighlight.style.visibility="visible"):(this._mouseOver||this._mouseX>=t*this._barWidth&&this._mouseX<t*this._barWidth+this._barWidth&&this._mouseY>0)&&!i?(this._boxHighlight.setAttribute("x",""+(1+this._barWidth*t)),this._boxHighlight.setAttribute("y","1"),this._boxHighlight.setAttribute("height",""+(w.barEditorHeight-3)),this._boxHighlight.style.visibility="visible"):this._boxHighlight.style.visibility="hidden",(this._mouseOver||this._touchMode)&&n&&i){const c=(this._mouseY-w.barEditorHeight)%this._channelHeight<this._channelHeight/2,_=this._barWidth*(t+.8),m=w.barEditorHeight+this._channelHeight*(e+.5),g=this._channelHeight*.1,S=this._channelHeight*.4,E=this._channelHeight*.175;this._upHighlight.setAttribute("fill",c&&!this._touchMode?Q.hoverPreview:Q.invertedText),this._downHighlight.setAttribute("fill",!c&&!this._touchMode?Q.hoverPreview:Q.invertedText),this._upHighlight.setAttribute("d",`M ${_} ${m-S} L ${_+E} ${m-g} L ${_-E} ${m-g} z`),this._downHighlight.setAttribute("d",`M ${_} ${m+S} L ${_+E} ${m+g} L ${_-E} ${m+g} z`),this._upHighlight.style.visibility="visible",this._downHighlight.style.visibility="visible"}else this._upHighlight.style.visibility="hidden",this._downHighlight.style.visibility="hidden";this._selectionRect.style.left=this._barWidth*this._doc.bar+"px",this._selectionRect.style.top=w.barEditorHeight+this._channelHeight*this._doc.channel+"px",this._select.style.left=this._barWidth*this._doc.bar+"px",this._select.style.width=this._barWidth+"px",this._select.style.top=w.barEditorHeight+this._channelHeight*this._doc.channel+"px",this._select.style.height=this._channelHeight+"px",this._barDropDown.style.left=this._barWidth*t+"px";const h=this._doc.song.patternsPerChannel+1;for(let c=this._renderedPatternCount;c<h;c++)this._select.appendChild(Ke.option({value:c},c));for(let c=h;c<this._renderedPatternCount;c++)this._select.removeChild(this._select.lastChild);this._renderedPatternCount=h;const d=this._doc.song.channels[this._doc.channel].bars[this._doc.bar];this._select.selectedIndex!=d&&(this._select.selectedIndex=d)}render(){if(this._barWidth=this._doc.getBarWidth(),this._channelHeight=this._doc.getChannelHeight(),this._renderedChannelCount!=this._doc.song.getChannelCount()){for(let d=this._renderedChannelCount;d<this._doc.song.getChannelCount();d++){this._grid[d]=[];for(let c=0;c<this._renderedBarCount;c++){const _=new Rc(d,c,d,Q.getChannelColor(this._doc.song,d).secondaryChannel);_.setSize(this._barWidth,this._channelHeight),this._boxContainer.appendChild(_.container),this._grid[d][c]=_}}for(let d=this._doc.song.getChannelCount();d<this._renderedChannelCount;d++)for(let c=0;c<this._renderedBarCount;c++)this._boxContainer.removeChild(this._grid[d][c].container);this._grid.length=this._doc.song.getChannelCount(),this._mousePressed=!1}if(this._renderedBarCount!=this._doc.song.barCount||this._renderedBarWidth!=this._barWidth){for(let c=0;c<this._doc.song.getChannelCount();c++){for(let _=this._renderedBarCount;_<this._doc.song.barCount;_++){const m=new Rc(c,_,c,Q.getChannelColor(this._doc.song,c).secondaryChannel);m.setSize(this._barWidth,this._channelHeight),this._boxContainer.appendChild(m.container),this._grid[c][_]=m}for(let _=this._doc.song.barCount;_<this._renderedBarCount;_++)this._boxContainer.removeChild(this._grid[c][_].container);this._grid[c].length=this._doc.song.barCount}var e="";for(let c=0;c<this._doc.song.barCount;c++){var t=c*this._barWidth+2,n=1,i=c*this._barWidth+this._barWidth-2,s=w.barEditorHeight-3;e+=`M ${t} ${n} H ${i} V ${s} H ${t} V ${n} Z `}if(this._barEditorPath.setAttribute("d",e),this._renderedBarCount<this._doc.song.barCount){this._barNumbers.length=this._doc.song.barCount;for(var h=this._renderedBarCount;h<this._barNumbers.length;h++)this._barNumbers[h]=me.text({"font-family":"sans-serif","font-size":"8px","text-anchor":"middle","font-weight":"bold",x:h*this._barWidth+this._barWidth/2+"px",y:"7px",fill:Q.secondaryText},""+(h+1)),h%4==0&&this._barNumbers[h].setAttribute("fill",Q.primaryText),this._barNumberContainer.appendChild(this._barNumbers[h])}else if(this._renderedBarCount>this._doc.song.barCount){for(var h=this._renderedBarCount-1;h>=this._doc.song.barCount;h--)this._barNumberContainer.removeChild(this._barNumbers[h]);this._barNumbers.length=this._doc.song.barCount}if(this._renderedBarWidth!=this._barWidth)for(var h=0;h<this._barNumbers.length;h++)this._barNumbers[h].setAttribute("x",h*this._barWidth+this._barWidth/2+"px");this._renderedBarCount=this._doc.song.barCount;const d=this._barWidth*this._doc.song.barCount;this.container.style.width=d+"px",this._svg.setAttribute("width",d+""),this._mousePressed=!1}if(this._renderedChannelHeight!=this._channelHeight||this._renderedBarWidth!=this._barWidth){this._renderedBarWidth=this._barWidth;for(let d=0;d<this._doc.song.getChannelCount();d++)for(let c=0;c<this._renderedBarCount;c++)this._grid[d][c].setSize(this._barWidth,this._channelHeight);this._mousePressed=!1}if(this._renderedChannelHeight!=this._channelHeight||this._renderedChannelCount!=this._doc.song.getChannelCount()){this._renderedChannelHeight=this._channelHeight,this._renderedChannelCount=this._doc.song.getChannelCount();const d=w.barEditorHeight+this._doc.song.getChannelCount()*this._channelHeight;this._svg.setAttribute("height",""+d),this._playhead.setAttribute("height",""+d),this.container.style.height=d+"px"}for(let d=0;d<this._doc.song.getChannelCount();d++)for(let c=0;c<this._renderedBarCount;c++){const _=this._doc.song.getPattern(d,c),m=c==this._doc.bar&&d==this._doc.channel,g=_==null||_.notes.length==0,S=this._grid[d][c];if(c<this._doc.song.barCount){const E=Q.getChannelColor(this._doc.song,d);S.setIndex(this._doc.song.channels[d].bars[c],g,m,g&&!m?E.secondaryChannel:E.primaryChannel,d>=this._doc.song.pitchChannelCount&&d<this._doc.song.pitchChannelCount+this._doc.song.noiseChannelCount,d>=this._doc.song.pitchChannelCount+this._doc.song.noiseChannelCount),S.container.style.visibility="visible"}else S.container.style.visibility="hidden"}this._select.style.display=this._touchMode?"":"none",this._doc.selection.boxSelectionActive?(this._selectionRect.setAttribute("x",String(this._barWidth*this._doc.selection.boxSelectionBar+1)),this._selectionRect.setAttribute("y",String(w.barEditorHeight+this._channelHeight*this._doc.selection.boxSelectionChannel+1)),this._selectionRect.setAttribute("width",String(this._barWidth*this._doc.selection.boxSelectionWidth-2)),this._selectionRect.setAttribute("height",String(this._channelHeight*this._doc.selection.boxSelectionHeight-2)),this._selectionRect.setAttribute("visibility","visible")):this._selectionRect.setAttribute("visibility","hidden"),this._updatePreview()}}const Wo=15,dh=30,uh=19,O_=29,Oa=256,Bh=Oa+1+O_,Lc=2*Bh+1,ko=256,H_=7,Nc=16,Dc=17,Fc=18,Il=8*2,Ha=-1,V_=1,aa=2,W_=0,ro=0,Oc=1,q_=3,pi=4,ds=0,vu=1,la=2,fs=-2,U_=-3,Qr=-5;function Ka(r){return Ga(r.map(([e,t])=>new Array(e).fill(t,0,e)))}function Ga(r){return r.reduce((e,t)=>e.concat(Array.isArray(t)?Ga(t):t),[])}const Hc=[0,1,2,3].concat(...Ka([[2,4],[2,5],[4,6],[4,7],[8,8],[8,9],[16,10],[16,11],[32,12],[32,13],[64,14],[64,15],[2,0],[1,16],[1,17],[2,18],[2,19],[4,20],[4,21],[8,22],[8,23],[16,24],[16,25],[32,26],[32,27],[64,28],[64,29]]));function hn(){const r=this;function e(i){const s=r.dyn_tree,h=r.stat_desc.static_tree,d=r.stat_desc.extra_bits,c=r.stat_desc.extra_base,_=r.stat_desc.max_length;let m,g,S,E,A,C,k=0;for(E=0;E<=Wo;E++)i.bl_count[E]=0;for(s[i.heap[i.heap_max]*2+1]=0,m=i.heap_max+1;m<Lc;m++)g=i.heap[m],E=s[s[g*2+1]*2+1]+1,E>_&&(E=_,k++),s[g*2+1]=E,!(g>r.max_code)&&(i.bl_count[E]++,A=0,g>=c&&(A=d[g-c]),C=s[g*2],i.opt_len+=C*(E+A),h&&(i.static_len+=C*(h[g*2+1]+A)));if(k!==0){do{for(E=_-1;i.bl_count[E]===0;)E--;i.bl_count[E]--,i.bl_count[E+1]+=2,i.bl_count[_]--,k-=2}while(k>0);for(E=_;E!==0;E--)for(g=i.bl_count[E];g!==0;)S=i.heap[--m],!(S>r.max_code)&&(s[S*2+1]!=E&&(i.opt_len+=(E-s[S*2+1])*s[S*2],s[S*2+1]=E),g--)}}function t(i,s){let h=0;do h|=i&1,i>>>=1,h<<=1;while(--s>0);return h>>>1}function n(i,s,h){const d=[];let c=0,_,m,g;for(_=1;_<=Wo;_++)d[_]=c=c+h[_-1]<<1;for(m=0;m<=s;m++)g=i[m*2+1],g!==0&&(i[m*2]=t(d[g]++,g))}r.build_tree=function(i){const s=r.dyn_tree,h=r.stat_desc.static_tree,d=r.stat_desc.elems;let c,_,m=-1,g;for(i.heap_len=0,i.heap_max=Lc,c=0;c<d;c++)s[c*2]!==0?(i.heap[++i.heap_len]=m=c,i.depth[c]=0):s[c*2+1]=0;for(;i.heap_len<2;)g=i.heap[++i.heap_len]=m<2?++m:0,s[g*2]=1,i.depth[g]=0,i.opt_len--,h&&(i.static_len-=h[g*2+1]);for(r.max_code=m,c=Math.floor(i.heap_len/2);c>=1;c--)i.pqdownheap(s,c);g=d;do c=i.heap[1],i.heap[1]=i.heap[i.heap_len--],i.pqdownheap(s,1),_=i.heap[1],i.heap[--i.heap_max]=c,i.heap[--i.heap_max]=_,s[g*2]=s[c*2]+s[_*2],i.depth[g]=Math.max(i.depth[c],i.depth[_])+1,s[c*2+1]=s[_*2+1]=g,i.heap[1]=g++,i.pqdownheap(s,1);while(i.heap_len>=2);i.heap[--i.heap_max]=i.heap[1],e(i),n(s,r.max_code,i.bl_count)}}hn._length_code=[0,1,2,3,4,5,6,7].concat(...Ka([[2,8],[2,9],[2,10],[2,11],[4,12],[4,13],[4,14],[4,15],[8,16],[8,17],[8,18],[8,19],[16,20],[16,21],[16,22],[16,23],[32,24],[32,25],[32,26],[31,27],[1,28]]));hn.base_length=[0,1,2,3,4,5,6,7,8,10,12,14,16,20,24,28,32,40,48,56,64,80,96,112,128,160,192,224,0];hn.base_dist=[0,1,2,3,4,6,8,12,16,24,32,48,64,96,128,192,256,384,512,768,1024,1536,2048,3072,4096,6144,8192,12288,16384,24576];hn.d_code=function(r){return r<256?Hc[r]:Hc[256+(r>>>7)]};hn.extra_lbits=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0];hn.extra_dbits=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13];hn.extra_blbits=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7];hn.bl_order=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];function Xn(r,e,t,n,i){const s=this;s.static_tree=r,s.extra_bits=e,s.extra_base=t,s.elems=n,s.max_length=i}const z_=[12,140,76,204,44,172,108,236,28,156,92,220,60,188,124,252,2,130,66,194,34,162,98,226,18,146,82,210,50,178,114,242,10,138,74,202,42,170,106,234,26,154,90,218,58,186,122,250,6,134,70,198,38,166,102,230,22,150,86,214,54,182,118,246,14,142,78,206,46,174,110,238,30,158,94,222,62,190,126,254,1,129,65,193,33,161,97,225,17,145,81,209,49,177,113,241,9,137,73,201,41,169,105,233,25,153,89,217,57,185,121,249,5,133,69,197,37,165,101,229,21,149,85,213,53,181,117,245,13,141,77,205,45,173,109,237,29,157,93,221,61,189,125,253,19,275,147,403,83,339,211,467,51,307,179,435,115,371,243,499,11,267,139,395,75,331,203,459,43,299,171,427,107,363,235,491,27,283,155,411,91,347,219,475,59,315,187,443,123,379,251,507,7,263,135,391,71,327,199,455,39,295,167,423,103,359,231,487,23,279,151,407,87,343,215,471,55,311,183,439,119,375,247,503,15,271,143,399,79,335,207,463,47,303,175,431,111,367,239,495,31,287,159,415,95,351,223,479,63,319,191,447,127,383,255,511,0,64,32,96,16,80,48,112,8,72,40,104,24,88,56,120,4,68,36,100,20,84,52,116,3,131,67,195,35,163,99,227],X_=Ka([[144,8],[112,9],[24,7],[8,8]]);Xn.static_ltree=Ga(z_.map((r,e)=>[r,X_[e]]));const $_=[0,16,8,24,4,20,12,28,2,18,10,26,6,22,14,30,1,17,9,25,5,21,13,29,3,19,11,27,7,23],Y_=Ka([[30,5]]);Xn.static_dtree=Ga($_.map((r,e)=>[r,Y_[e]]));Xn.static_l_desc=new Xn(Xn.static_ltree,hn.extra_lbits,Oa+1,Bh,Wo);Xn.static_d_desc=new Xn(Xn.static_dtree,hn.extra_dbits,0,dh,Wo);Xn.static_bl_desc=new Xn(null,hn.extra_blbits,0,uh,H_);const j_=9,K_=8;function Es(r,e,t,n,i){const s=this;s.good_length=r,s.max_lazy=e,s.nice_length=t,s.max_chain=n,s.func=i}const bu=0,Ea=1,Or=2,hs=[new Es(0,0,0,0,bu),new Es(4,4,8,4,Ea),new Es(4,5,16,8,Ea),new Es(4,6,32,32,Ea),new Es(4,4,16,16,Or),new Es(8,16,32,32,Or),new Es(8,16,128,128,Or),new Es(8,32,128,256,Or),new Es(32,128,258,1024,Or),new Es(32,258,258,4096,Or)],ha=["need dictionary","stream end","","","stream error","data error","","buffer error","",""],Qi=0,ca=1,Po=2,da=3,G_=32,Al=42,ua=113,Eo=666,Rl=8,Z_=0,Ll=1,Q_=2,un=3,Ba=258,qi=Ba+un+1;function Vc(r,e,t,n){const i=r[e*2],s=r[t*2];return i<s||i==s&&n[e]<=n[t]}function J_(){const r=this;let e,t,n,i,s,h,d,c,_,m,g,S,E,A,C,k,T,b,R,V,f,D,l,W,L,P,y,O,B,v,H,N,te;const G=new hn,se=new hn,M=new hn;r.depth=[];let F,Z,ee,ue,Pe,_e;r.bl_count=[],r.heap=[],H=[],N=[],te=[];function ke(){_=2*s,g[E-1]=0;for(let z=0;z<E-1;z++)g[z]=0;P=hs[y].max_lazy,B=hs[y].good_length,v=hs[y].nice_length,L=hs[y].max_chain,f=0,T=0,l=0,b=W=un-1,V=0,S=0}function Ne(){let z;for(z=0;z<Bh;z++)H[z*2]=0;for(z=0;z<dh;z++)N[z*2]=0;for(z=0;z<uh;z++)te[z*2]=0;H[ko*2]=1,r.opt_len=r.static_len=0,Z=ee=0}function Be(){G.dyn_tree=H,G.stat_desc=Xn.static_l_desc,se.dyn_tree=N,se.stat_desc=Xn.static_d_desc,M.dyn_tree=te,M.stat_desc=Xn.static_bl_desc,Pe=0,_e=0,ue=8,Ne()}r.pqdownheap=function(z,Y){const J=r.heap,X=J[Y];let ie=Y<<1;for(;ie<=r.heap_len&&(ie<r.heap_len&&Vc(z,J[ie+1],J[ie],r.depth)&&ie++,!Vc(z,X,J[ie],r.depth));)J[Y]=J[ie],Y=ie,ie<<=1;J[Y]=X};function pe(z,Y){let J=-1,X,ie=z[0*2+1],oe=0,ae=7,fe=4;ie===0&&(ae=138,fe=3),z[(Y+1)*2+1]=65535;for(let ce=0;ce<=Y;ce++)X=ie,ie=z[(ce+1)*2+1],!(++oe<ae&&X==ie)&&(oe<fe?te[X*2]+=oe:X!==0?(X!=J&&te[X*2]++,te[Nc*2]++):oe<=10?te[Dc*2]++:te[Fc*2]++,oe=0,J=X,ie===0?(ae=138,fe=3):X==ie?(ae=6,fe=3):(ae=7,fe=4))}function Oe(){let z;for(pe(H,G.max_code),pe(N,se.max_code),M.build_tree(r),z=uh-1;z>=3&&te[hn.bl_order[z]*2+1]===0;z--);return r.opt_len+=3*(z+1)+5+5+4,z}function nt(z){r.pending_buf[r.pending++]=z}function Ve(z){nt(z&255),nt(z>>>8&255)}function ot(z){nt(z>>8&255),nt(z&255&255)}function Ge(z,Y){let J;const X=Y;_e>Il-X?(J=z,Pe|=J<<_e&65535,Ve(Pe),Pe=J>>>Il-_e,_e+=X-Il):(Pe|=z<<_e&65535,_e+=X)}function lt(z,Y){const J=z*2;Ge(Y[J]&65535,Y[J+1]&65535)}function dt(z,Y){let J,X=-1,ie,oe=z[0*2+1],ae=0,fe=7,ce=4;for(oe===0&&(fe=138,ce=3),J=0;J<=Y;J++)if(ie=oe,oe=z[(J+1)*2+1],!(++ae<fe&&ie==oe)){if(ae<ce)do lt(ie,te);while(--ae!==0);else ie!==0?(ie!=X&&(lt(ie,te),ae--),lt(Nc,te),Ge(ae-3,2)):ae<=10?(lt(Dc,te),Ge(ae-3,3)):(lt(Fc,te),Ge(ae-11,7));ae=0,X=ie,oe===0?(fe=138,ce=3):ie==oe?(fe=6,ce=3):(fe=7,ce=4)}}function St(z,Y,J){let X;for(Ge(z-257,5),Ge(Y-1,5),Ge(J-4,4),X=0;X<J;X++)Ge(te[hn.bl_order[X]*2+1],3);dt(H,z-1),dt(N,Y-1)}function Mt(){_e==16?(Ve(Pe),Pe=0,_e=0):_e>=8&&(nt(Pe&255),Pe>>>=8,_e-=8)}function Tt(){Ge(Ll<<1,3),lt(ko,Xn.static_ltree),Mt(),1+ue+10-_e<9&&(Ge(Ll<<1,3),lt(ko,Xn.static_ltree),Mt()),ue=7}function Ct(z,Y){let J,X,ie;if(r.dist_buf[Z]=z,r.lc_buf[Z]=Y&255,Z++,z===0?H[Y*2]++:(ee++,z--,H[(hn._length_code[Y]+Oa+1)*2]++,N[hn.d_code(z)*2]++),!(Z&8191)&&y>2){for(J=Z*8,X=f-T,ie=0;ie<dh;ie++)J+=N[ie*2]*(5+hn.extra_dbits[ie]);if(J>>>=3,ee<Math.floor(Z/2)&&J<Math.floor(X/2))return!0}return Z==F-1}function kt(z,Y){let J,X,ie=0,oe,ae;if(Z!==0)do J=r.dist_buf[ie],X=r.lc_buf[ie],ie++,J===0?lt(X,z):(oe=hn._length_code[X],lt(oe+Oa+1,z),ae=hn.extra_lbits[oe],ae!==0&&(X-=hn.base_length[oe],Ge(X,ae)),J--,oe=hn.d_code(J),lt(oe,Y),ae=hn.extra_dbits[oe],ae!==0&&(J-=hn.base_dist[oe],Ge(J,ae)));while(ie<Z);lt(ko,z),ue=z[ko*2+1]}function bt(){_e>8?Ve(Pe):_e>0&&nt(Pe&255),Pe=0,_e=0}function Pt(z,Y,J){bt(),ue=8,J&&(Ve(Y),Ve(~Y)),r.pending_buf.set(c.subarray(z,z+Y),r.pending),r.pending+=Y}function Xe(z,Y,J){Ge((Z_<<1)+(J?1:0),3),Pt(z,Y,!0)}function vt(z,Y,J){let X,ie,oe=0;y>0?(G.build_tree(r),se.build_tree(r),oe=Oe(),X=r.opt_len+3+7>>>3,ie=r.static_len+3+7>>>3,ie<=X&&(X=ie)):X=ie=Y+5,Y+4<=X&&z!=-1?Xe(z,Y,J):ie==X?(Ge((Ll<<1)+(J?1:0),3),kt(Xn.static_ltree,Xn.static_dtree)):(Ge((Q_<<1)+(J?1:0),3),St(G.max_code+1,se.max_code+1,oe+1),kt(H,N)),Ne(),J&&bt()}function Et(z){vt(T>=0?T:-1,f-T,z),T=f,e.flush_pending()}function Sn(){let z,Y,J,X;do{if(X=_-l-f,X===0&&f===0&&l===0)X=s;else if(X==-1)X--;else if(f>=s+s-qi){c.set(c.subarray(s,s+s),0),D-=s,f-=s,T-=s,z=E,J=z;do Y=g[--J]&65535,g[J]=Y>=s?Y-s:0;while(--z!==0);z=s,J=z;do Y=m[--J]&65535,m[J]=Y>=s?Y-s:0;while(--z!==0);X+=s}if(e.avail_in===0)return;z=e.read_buf(c,f+l,X),l+=z,l>=un&&(S=c[f]&255,S=(S<<k^c[f+1]&255)&C)}while(l<qi&&e.avail_in!==0)}function Hi(z){let Y=65535,J;for(Y>n-5&&(Y=n-5);;){if(l<=1){if(Sn(),l===0&&z==ro)return Qi;if(l===0)break}if(f+=l,l=0,J=T+Y,(f===0||f>=J)&&(l=f-J,f=J,Et(!1),e.avail_out===0)||f-T>=s-qi&&(Et(!1),e.avail_out===0))return Qi}return Et(z==pi),e.avail_out===0?z==pi?Po:Qi:z==pi?da:ca}function On(z){let Y=L,J=f,X,ie,oe=W;const ae=f>s-qi?f-(s-qi):0;let fe=v;const ce=d,we=f+Ba;let He=c[J+oe-1],$e=c[J+oe];W>=B&&(Y>>=2),fe>l&&(fe=l);do if(X=z,!(c[X+oe]!=$e||c[X+oe-1]!=He||c[X]!=c[J]||c[++X]!=c[J+1])){J+=2,X++;do;while(c[++J]==c[++X]&&c[++J]==c[++X]&&c[++J]==c[++X]&&c[++J]==c[++X]&&c[++J]==c[++X]&&c[++J]==c[++X]&&c[++J]==c[++X]&&c[++J]==c[++X]&&J<we);if(ie=Ba-(we-J),J=we-Ba,ie>oe){if(D=z,oe=ie,ie>=fe)break;He=c[J+oe-1],$e=c[J+oe]}}while((z=m[z&ce]&65535)>ae&&--Y!==0);return oe<=l?oe:l}function Ht(z){let Y=0,J;for(;;){if(l<qi){if(Sn(),l<qi&&z==ro)return Qi;if(l===0)break}if(l>=un&&(S=(S<<k^c[f+(un-1)]&255)&C,Y=g[S]&65535,m[f&d]=g[S],g[S]=f),Y!==0&&(f-Y&65535)<=s-qi&&O!=aa&&(b=On(Y)),b>=un)if(J=Ct(f-D,b-un),l-=b,b<=P&&l>=un){b--;do f++,S=(S<<k^c[f+(un-1)]&255)&C,Y=g[S]&65535,m[f&d]=g[S],g[S]=f;while(--b!==0);f++}else f+=b,b=0,S=c[f]&255,S=(S<<k^c[f+1]&255)&C;else J=Ct(0,c[f]&255),l--,f++;if(J&&(Et(!1),e.avail_out===0))return Qi}return Et(z==pi),e.avail_out===0?z==pi?Po:Qi:z==pi?da:ca}function j(z){let Y=0,J,X;for(;;){if(l<qi){if(Sn(),l<qi&&z==ro)return Qi;if(l===0)break}if(l>=un&&(S=(S<<k^c[f+(un-1)]&255)&C,Y=g[S]&65535,m[f&d]=g[S],g[S]=f),W=b,R=D,b=un-1,Y!==0&&W<P&&(f-Y&65535)<=s-qi&&(O!=aa&&(b=On(Y)),b<=5&&(O==V_||b==un&&f-D>4096)&&(b=un-1)),W>=un&&b<=W){X=f+l-un,J=Ct(f-1-R,W-un),l-=W-1,W-=2;do++f<=X&&(S=(S<<k^c[f+(un-1)]&255)&C,Y=g[S]&65535,m[f&d]=g[S],g[S]=f);while(--W!==0);if(V=0,b=un-1,f++,J&&(Et(!1),e.avail_out===0))return Qi}else if(V!==0){if(J=Ct(0,c[f-1]&255),J&&Et(!1),f++,l--,e.avail_out===0)return Qi}else V=1,f++,l--}return V!==0&&(J=Ct(0,c[f-1]&255),V=0),Et(z==pi),e.avail_out===0?z==pi?Po:Qi:z==pi?da:ca}function K(z){return z.total_in=z.total_out=0,z.msg=null,r.pending=0,r.pending_out=0,t=ua,i=ro,Be(),ke(),ds}r.deflateInit=function(z,Y,J,X,ie,oe){return X||(X=Rl),ie||(ie=K_),oe||(oe=W_),z.msg=null,Y==Ha&&(Y=6),ie<1||ie>j_||X!=Rl||J<9||J>15||Y<0||Y>9||oe<0||oe>aa?fs:(z.dstate=r,h=J,s=1<<h,d=s-1,A=ie+7,E=1<<A,C=E-1,k=Math.floor((A+un-1)/un),c=new Uint8Array(s*2),m=[],g=[],F=1<<ie+6,r.pending_buf=new Uint8Array(F*4),n=F*4,r.dist_buf=new Uint16Array(F),r.lc_buf=new Uint8Array(F),y=Y,O=oe,K(z))},r.deflateEnd=function(){return t!=Al&&t!=ua&&t!=Eo?fs:(r.lc_buf=null,r.dist_buf=null,r.pending_buf=null,g=null,m=null,c=null,r.dstate=null,t==ua?U_:ds)},r.deflateParams=function(z,Y,J){let X=ds;return Y==Ha&&(Y=6),Y<0||Y>9||J<0||J>aa?fs:(hs[y].func!=hs[Y].func&&z.total_in!==0&&(X=z.deflate(Oc)),y!=Y&&(y=Y,P=hs[y].max_lazy,B=hs[y].good_length,v=hs[y].nice_length,L=hs[y].max_chain),O=J,X)},r.deflateSetDictionary=function(z,Y,J){let X=J,ie,oe=0;if(!Y||t!=Al)return fs;if(X<un)return ds;for(X>s-qi&&(X=s-qi,oe=J-X),c.set(Y.subarray(oe,oe+X),0),f=X,T=X,S=c[0]&255,S=(S<<k^c[1]&255)&C,ie=0;ie<=X-un;ie++)S=(S<<k^c[ie+(un-1)]&255)&C,m[ie&d]=g[S],g[S]=ie;return ds},r.deflate=function(z,Y){let J,X,ie,oe,ae;if(Y>pi||Y<0)return fs;if(!z.next_out||!z.next_in&&z.avail_in!==0||t==Eo&&Y!=pi)return z.msg=ha[la-fs],fs;if(z.avail_out===0)return z.msg=ha[la-Qr],Qr;if(e=z,oe=i,i=Y,t==Al&&(X=Rl+(h-8<<4)<<8,ie=(y-1&255)>>1,ie>3&&(ie=3),X|=ie<<6,f!==0&&(X|=G_),X+=31-X%31,t=ua,ot(X)),r.pending!==0){if(e.flush_pending(),e.avail_out===0)return i=-1,ds}else if(e.avail_in===0&&Y<=oe&&Y!=pi)return e.msg=ha[la-Qr],Qr;if(t==Eo&&e.avail_in!==0)return z.msg=ha[la-Qr],Qr;if(e.avail_in!==0||l!==0||Y!=ro&&t!=Eo){switch(ae=-1,hs[y].func){case bu:ae=Hi(Y);break;case Ea:ae=Ht(Y);break;case Or:ae=j(Y);break}if((ae==Po||ae==da)&&(t=Eo),ae==Qi||ae==Po)return e.avail_out===0&&(i=-1),ds;if(ae==ca){if(Y==Oc)Tt();else if(Xe(0,0,!1),Y==q_)for(J=0;J<E;J++)g[J]=0;if(e.flush_pending(),e.avail_out===0)return i=-1,ds}}return Y!=pi?ds:vu}}function yu(){const r=this;r.next_in_index=0,r.next_out_index=0,r.avail_in=0,r.total_in=0,r.avail_out=0,r.total_out=0}yu.prototype={deflateInit(r,e){const t=this;return t.dstate=new J_,e||(e=Wo),t.dstate.deflateInit(t,r,e)},deflate(r){const e=this;return e.dstate?e.dstate.deflate(e,r):fs},deflateEnd(){const r=this;if(!r.dstate)return fs;const e=r.dstate.deflateEnd();return r.dstate=null,e},deflateParams(r,e){const t=this;return t.dstate?t.dstate.deflateParams(t,r,e):fs},deflateSetDictionary(r,e){const t=this;return t.dstate?t.dstate.deflateSetDictionary(t,r,e):fs},read_buf(r,e,t){const n=this;let i=n.avail_in;return i>t&&(i=t),i===0?0:(n.avail_in-=i,r.set(n.next_in.subarray(n.next_in_index,n.next_in_index+i),e),n.next_in_index+=i,n.total_in+=i,i)},flush_pending(){const r=this;let e=r.dstate.pending;e>r.avail_out&&(e=r.avail_out),e!==0&&(r.next_out.set(r.dstate.pending_buf.subarray(r.dstate.pending_out,r.dstate.pending_out+e),r.next_out_index),r.next_out_index+=e,r.dstate.pending_out+=e,r.total_out+=e,r.avail_out-=e,r.dstate.pending-=e,r.dstate.pending===0&&(r.dstate.pending_out=0))}};function e1(r){const e=this,t=new yu,n=t1(r&&r.chunkSize?r.chunkSize:64*1024),i=ro,s=new Uint8Array(n);let h=r?r.level:Ha;typeof h>"u"&&(h=Ha),t.deflateInit(h),t.next_out=s,e.append=function(d,c){let _,m,g=0,S=0,E=0;const A=[];if(d.length){t.next_in_index=0,t.next_in=d,t.avail_in=d.length;do{if(t.next_out_index=0,t.avail_out=n,_=t.deflate(i),_!=ds)throw new Error("deflating: "+t.msg);t.next_out_index&&(t.next_out_index==n?A.push(new Uint8Array(s)):A.push(s.subarray(0,t.next_out_index))),E+=t.next_out_index,c&&t.next_in_index>0&&t.next_in_index!=g&&(c(t.next_in_index),g=t.next_in_index)}while(t.avail_in>0||t.avail_out===0);return A.length>1?(m=new Uint8Array(E),A.forEach(function(C){m.set(C,S),S+=C.length})):m=A[0]?new Uint8Array(A[0]):new Uint8Array,m}},e.flush=function(){let d,c,_=0,m=0;const g=[];do{if(t.next_out_index=0,t.avail_out=n,d=t.deflate(pi),d!=vu&&d!=ds)throw new Error("deflating: "+t.msg);n-t.avail_out>0&&g.push(s.slice(0,t.next_out_index)),m+=t.next_out_index}while(t.avail_in>0||t.avail_out===0);return t.deflateEnd(),c=new Uint8Array(m),g.forEach(function(S){c.set(S,_),_+=S.length}),c}}function t1(r){return r+5*(Math.floor(r/16383)+1)}const n1=15,Yt=0,Us=1,i1=2,mi=-2,cn=-3,Wc=-4,zs=-5,zi=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535],wu=1440,s1=0,r1=4,o1=9,a1=5,l1=[96,7,256,0,8,80,0,8,16,84,8,115,82,7,31,0,8,112,0,8,48,0,9,192,80,7,10,0,8,96,0,8,32,0,9,160,0,8,0,0,8,128,0,8,64,0,9,224,80,7,6,0,8,88,0,8,24,0,9,144,83,7,59,0,8,120,0,8,56,0,9,208,81,7,17,0,8,104,0,8,40,0,9,176,0,8,8,0,8,136,0,8,72,0,9,240,80,7,4,0,8,84,0,8,20,85,8,227,83,7,43,0,8,116,0,8,52,0,9,200,81,7,13,0,8,100,0,8,36,0,9,168,0,8,4,0,8,132,0,8,68,0,9,232,80,7,8,0,8,92,0,8,28,0,9,152,84,7,83,0,8,124,0,8,60,0,9,216,82,7,23,0,8,108,0,8,44,0,9,184,0,8,12,0,8,140,0,8,76,0,9,248,80,7,3,0,8,82,0,8,18,85,8,163,83,7,35,0,8,114,0,8,50,0,9,196,81,7,11,0,8,98,0,8,34,0,9,164,0,8,2,0,8,130,0,8,66,0,9,228,80,7,7,0,8,90,0,8,26,0,9,148,84,7,67,0,8,122,0,8,58,0,9,212,82,7,19,0,8,106,0,8,42,0,9,180,0,8,10,0,8,138,0,8,74,0,9,244,80,7,5,0,8,86,0,8,22,192,8,0,83,7,51,0,8,118,0,8,54,0,9,204,81,7,15,0,8,102,0,8,38,0,9,172,0,8,6,0,8,134,0,8,70,0,9,236,80,7,9,0,8,94,0,8,30,0,9,156,84,7,99,0,8,126,0,8,62,0,9,220,82,7,27,0,8,110,0,8,46,0,9,188,0,8,14,0,8,142,0,8,78,0,9,252,96,7,256,0,8,81,0,8,17,85,8,131,82,7,31,0,8,113,0,8,49,0,9,194,80,7,10,0,8,97,0,8,33,0,9,162,0,8,1,0,8,129,0,8,65,0,9,226,80,7,6,0,8,89,0,8,25,0,9,146,83,7,59,0,8,121,0,8,57,0,9,210,81,7,17,0,8,105,0,8,41,0,9,178,0,8,9,0,8,137,0,8,73,0,9,242,80,7,4,0,8,85,0,8,21,80,8,258,83,7,43,0,8,117,0,8,53,0,9,202,81,7,13,0,8,101,0,8,37,0,9,170,0,8,5,0,8,133,0,8,69,0,9,234,80,7,8,0,8,93,0,8,29,0,9,154,84,7,83,0,8,125,0,8,61,0,9,218,82,7,23,0,8,109,0,8,45,0,9,186,0,8,13,0,8,141,0,8,77,0,9,250,80,7,3,0,8,83,0,8,19,85,8,195,83,7,35,0,8,115,0,8,51,0,9,198,81,7,11,0,8,99,0,8,35,0,9,166,0,8,3,0,8,131,0,8,67,0,9,230,80,7,7,0,8,91,0,8,27,0,9,150,84,7,67,0,8,123,0,8,59,0,9,214,82,7,19,0,8,107,0,8,43,0,9,182,0,8,11,0,8,139,0,8,75,0,9,246,80,7,5,0,8,87,0,8,23,192,8,0,83,7,51,0,8,119,0,8,55,0,9,206,81,7,15,0,8,103,0,8,39,0,9,174,0,8,7,0,8,135,0,8,71,0,9,238,80,7,9,0,8,95,0,8,31,0,9,158,84,7,99,0,8,127,0,8,63,0,9,222,82,7,27,0,8,111,0,8,47,0,9,190,0,8,15,0,8,143,0,8,79,0,9,254,96,7,256,0,8,80,0,8,16,84,8,115,82,7,31,0,8,112,0,8,48,0,9,193,80,7,10,0,8,96,0,8,32,0,9,161,0,8,0,0,8,128,0,8,64,0,9,225,80,7,6,0,8,88,0,8,24,0,9,145,83,7,59,0,8,120,0,8,56,0,9,209,81,7,17,0,8,104,0,8,40,0,9,177,0,8,8,0,8,136,0,8,72,0,9,241,80,7,4,0,8,84,0,8,20,85,8,227,83,7,43,0,8,116,0,8,52,0,9,201,81,7,13,0,8,100,0,8,36,0,9,169,0,8,4,0,8,132,0,8,68,0,9,233,80,7,8,0,8,92,0,8,28,0,9,153,84,7,83,0,8,124,0,8,60,0,9,217,82,7,23,0,8,108,0,8,44,0,9,185,0,8,12,0,8,140,0,8,76,0,9,249,80,7,3,0,8,82,0,8,18,85,8,163,83,7,35,0,8,114,0,8,50,0,9,197,81,7,11,0,8,98,0,8,34,0,9,165,0,8,2,0,8,130,0,8,66,0,9,229,80,7,7,0,8,90,0,8,26,0,9,149,84,7,67,0,8,122,0,8,58,0,9,213,82,7,19,0,8,106,0,8,42,0,9,181,0,8,10,0,8,138,0,8,74,0,9,245,80,7,5,0,8,86,0,8,22,192,8,0,83,7,51,0,8,118,0,8,54,0,9,205,81,7,15,0,8,102,0,8,38,0,9,173,0,8,6,0,8,134,0,8,70,0,9,237,80,7,9,0,8,94,0,8,30,0,9,157,84,7,99,0,8,126,0,8,62,0,9,221,82,7,27,0,8,110,0,8,46,0,9,189,0,8,14,0,8,142,0,8,78,0,9,253,96,7,256,0,8,81,0,8,17,85,8,131,82,7,31,0,8,113,0,8,49,0,9,195,80,7,10,0,8,97,0,8,33,0,9,163,0,8,1,0,8,129,0,8,65,0,9,227,80,7,6,0,8,89,0,8,25,0,9,147,83,7,59,0,8,121,0,8,57,0,9,211,81,7,17,0,8,105,0,8,41,0,9,179,0,8,9,0,8,137,0,8,73,0,9,243,80,7,4,0,8,85,0,8,21,80,8,258,83,7,43,0,8,117,0,8,53,0,9,203,81,7,13,0,8,101,0,8,37,0,9,171,0,8,5,0,8,133,0,8,69,0,9,235,80,7,8,0,8,93,0,8,29,0,9,155,84,7,83,0,8,125,0,8,61,0,9,219,82,7,23,0,8,109,0,8,45,0,9,187,0,8,13,0,8,141,0,8,77,0,9,251,80,7,3,0,8,83,0,8,19,85,8,195,83,7,35,0,8,115,0,8,51,0,9,199,81,7,11,0,8,99,0,8,35,0,9,167,0,8,3,0,8,131,0,8,67,0,9,231,80,7,7,0,8,91,0,8,27,0,9,151,84,7,67,0,8,123,0,8,59,0,9,215,82,7,19,0,8,107,0,8,43,0,9,183,0,8,11,0,8,139,0,8,75,0,9,247,80,7,5,0,8,87,0,8,23,192,8,0,83,7,51,0,8,119,0,8,55,0,9,207,81,7,15,0,8,103,0,8,39,0,9,175,0,8,7,0,8,135,0,8,71,0,9,239,80,7,9,0,8,95,0,8,31,0,9,159,84,7,99,0,8,127,0,8,63,0,9,223,82,7,27,0,8,111,0,8,47,0,9,191,0,8,15,0,8,143,0,8,79,0,9,255],h1=[80,5,1,87,5,257,83,5,17,91,5,4097,81,5,5,89,5,1025,85,5,65,93,5,16385,80,5,3,88,5,513,84,5,33,92,5,8193,82,5,9,90,5,2049,86,5,129,192,5,24577,80,5,2,87,5,385,83,5,25,91,5,6145,81,5,7,89,5,1537,85,5,97,93,5,24577,80,5,4,88,5,769,84,5,49,92,5,12289,82,5,13,90,5,3073,86,5,193,192,5,24577],c1=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],d1=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,112,112],u1=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],f1=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],ir=15;function fh(){const r=this;let e,t,n,i,s,h;function d(_,m,g,S,E,A,C,k,T,b,R){let V,f,D,l,W,L,P,y,O,B,v,H,N,te,G;B=0,W=g;do n[_[m+B]]++,B++,W--;while(W!==0);if(n[0]==g)return C[0]=-1,k[0]=0,Yt;for(y=k[0],L=1;L<=ir&&n[L]===0;L++);for(P=L,y<L&&(y=L),W=ir;W!==0&&n[W]===0;W--);for(D=W,y>W&&(y=W),k[0]=y,te=1<<L;L<W;L++,te<<=1)if((te-=n[L])<0)return cn;if((te-=n[W])<0)return cn;for(n[W]+=te,h[1]=L=0,B=1,N=2;--W!==0;)h[N]=L+=n[B],N++,B++;W=0,B=0;do(L=_[m+B])!==0&&(R[h[L]++]=W),B++;while(++W<g);for(g=h[D],h[0]=W=0,B=0,l=-1,H=-y,s[0]=0,v=0,G=0;P<=D;P++)for(V=n[P];V--!==0;){for(;P>H+y;){if(l++,H+=y,G=D-H,G=G>y?y:G,(f=1<<(L=P-H))>V+1&&(f-=V+1,N=P,L<G))for(;++L<G&&!((f<<=1)<=n[++N]);)f-=n[N];if(G=1<<L,b[0]+G>wu)return cn;s[l]=v=b[0],b[0]+=G,l!==0?(h[l]=W,i[0]=L,i[1]=y,L=W>>>H-y,i[2]=v-s[l-1]-L,T.set(i,(s[l-1]+L)*3)):C[0]=v}for(i[1]=P-H,B>=g?i[0]=192:R[B]<S?(i[0]=R[B]<256?0:96,i[2]=R[B++]):(i[0]=A[R[B]-S]+16+64,i[2]=E[R[B++]-S]),f=1<<P-H,L=W>>>H;L<G;L+=f)T.set(i,(v+L)*3);for(L=1<<P-1;W&L;L>>>=1)W^=L;for(W^=L,O=(1<<H)-1;(W&O)!=h[l];)l--,H-=y,O=(1<<H)-1}return te!==0&&D!=1?zs:Yt}function c(_){let m;for(e||(e=[],t=[],n=new Int32Array(ir+1),i=[],s=new Int32Array(ir),h=new Int32Array(ir+1)),t.length<_&&(t=[]),m=0;m<_;m++)t[m]=0;for(m=0;m<ir+1;m++)n[m]=0;for(m=0;m<3;m++)i[m]=0;s.set(n.subarray(0,ir),0),h.set(n.subarray(0,ir+1),0)}r.inflate_trees_bits=function(_,m,g,S,E){let A;return c(19),e[0]=0,A=d(_,0,19,19,null,null,g,m,S,e,t),A==cn?E.msg="oversubscribed dynamic bit lengths tree":(A==zs||m[0]===0)&&(E.msg="incomplete dynamic bit lengths tree",A=cn),A},r.inflate_trees_dynamic=function(_,m,g,S,E,A,C,k,T){let b;return c(288),e[0]=0,b=d(g,0,_,257,c1,d1,A,S,k,e,t),b!=Yt||S[0]===0?(b==cn?T.msg="oversubscribed literal/length tree":b!=Wc&&(T.msg="incomplete literal/length tree",b=cn),b):(c(288),b=d(g,_,m,0,u1,f1,C,E,k,e,t),b!=Yt||E[0]===0&&_>257?(b==cn?T.msg="oversubscribed distance tree":b==zs?(T.msg="incomplete distance tree",b=cn):b!=Wc&&(T.msg="empty distance tree with lengths",b=cn),b):Yt)}}fh.inflate_trees_fixed=function(r,e,t,n){return r[0]=o1,e[0]=a1,t[0]=l1,n[0]=h1,Yt};const fa=0,qc=1,Uc=2,zc=3,Xc=4,$c=5,Yc=6,Nl=7,jc=8,pa=9;function p1(){const r=this;let e,t=0,n,i=0,s=0,h=0,d=0,c=0,_=0,m=0,g,S=0,E,A=0;function C(k,T,b,R,V,f,D,l){let W,L,P,y,O,B,v,H,N,te,G,se,M,F,Z,ee;v=l.next_in_index,H=l.avail_in,O=D.bitb,B=D.bitk,N=D.write,te=N<D.read?D.read-N-1:D.end-N,G=zi[k],se=zi[T];do{for(;B<20;)H--,O|=(l.read_byte(v++)&255)<<B,B+=8;if(W=O&G,L=b,P=R,ee=(P+W)*3,(y=L[ee])===0){O>>=L[ee+1],B-=L[ee+1],D.win[N++]=L[ee+2],te--;continue}do{if(O>>=L[ee+1],B-=L[ee+1],y&16){for(y&=15,M=L[ee+2]+(O&zi[y]),O>>=y,B-=y;B<15;)H--,O|=(l.read_byte(v++)&255)<<B,B+=8;W=O&se,L=V,P=f,ee=(P+W)*3,y=L[ee];do if(O>>=L[ee+1],B-=L[ee+1],y&16){for(y&=15;B<y;)H--,O|=(l.read_byte(v++)&255)<<B,B+=8;if(F=L[ee+2]+(O&zi[y]),O>>=y,B-=y,te-=M,N>=F)Z=N-F,N-Z>0&&2>N-Z?(D.win[N++]=D.win[Z++],D.win[N++]=D.win[Z++],M-=2):(D.win.set(D.win.subarray(Z,Z+2),N),N+=2,Z+=2,M-=2);else{Z=N-F;do Z+=D.end;while(Z<0);if(y=D.end-Z,M>y){if(M-=y,N-Z>0&&y>N-Z)do D.win[N++]=D.win[Z++];while(--y!==0);else D.win.set(D.win.subarray(Z,Z+y),N),N+=y,Z+=y,y=0;Z=0}}if(N-Z>0&&M>N-Z)do D.win[N++]=D.win[Z++];while(--M!==0);else D.win.set(D.win.subarray(Z,Z+M),N),N+=M,Z+=M,M=0;break}else if(!(y&64))W+=L[ee+2],W+=O&zi[y],ee=(P+W)*3,y=L[ee];else return l.msg="invalid distance code",M=l.avail_in-H,M=B>>3<M?B>>3:M,H+=M,v-=M,B-=M<<3,D.bitb=O,D.bitk=B,l.avail_in=H,l.total_in+=v-l.next_in_index,l.next_in_index=v,D.write=N,cn;while(!0);break}if(y&64)return y&32?(M=l.avail_in-H,M=B>>3<M?B>>3:M,H+=M,v-=M,B-=M<<3,D.bitb=O,D.bitk=B,l.avail_in=H,l.total_in+=v-l.next_in_index,l.next_in_index=v,D.write=N,Us):(l.msg="invalid literal/length code",M=l.avail_in-H,M=B>>3<M?B>>3:M,H+=M,v-=M,B-=M<<3,D.bitb=O,D.bitk=B,l.avail_in=H,l.total_in+=v-l.next_in_index,l.next_in_index=v,D.write=N,cn);if(W+=L[ee+2],W+=O&zi[y],ee=(P+W)*3,(y=L[ee])===0){O>>=L[ee+1],B-=L[ee+1],D.win[N++]=L[ee+2],te--;break}}while(!0)}while(te>=258&&H>=10);return M=l.avail_in-H,M=B>>3<M?B>>3:M,H+=M,v-=M,B-=M<<3,D.bitb=O,D.bitk=B,l.avail_in=H,l.total_in+=v-l.next_in_index,l.next_in_index=v,D.write=N,Yt}r.init=function(k,T,b,R,V,f){e=fa,_=k,m=T,g=b,S=R,E=V,A=f,n=null},r.proc=function(k,T,b){let R,V,f,D=0,l=0,W=0,L,P,y,O;for(W=T.next_in_index,L=T.avail_in,D=k.bitb,l=k.bitk,P=k.write,y=P<k.read?k.read-P-1:k.end-P;;)switch(e){case fa:if(y>=258&&L>=10&&(k.bitb=D,k.bitk=l,T.avail_in=L,T.total_in+=W-T.next_in_index,T.next_in_index=W,k.write=P,b=C(_,m,g,S,E,A,k,T),W=T.next_in_index,L=T.avail_in,D=k.bitb,l=k.bitk,P=k.write,y=P<k.read?k.read-P-1:k.end-P,b!=Yt)){e=b==Us?Nl:pa;break}s=_,n=g,i=S,e=qc;case qc:for(R=s;l<R;){if(L!==0)b=Yt;else return k.bitb=D,k.bitk=l,T.avail_in=L,T.total_in+=W-T.next_in_index,T.next_in_index=W,k.write=P,k.inflate_flush(T,b);L--,D|=(T.read_byte(W++)&255)<<l,l+=8}if(V=(i+(D&zi[R]))*3,D>>>=n[V+1],l-=n[V+1],f=n[V],f===0){h=n[V+2],e=Yc;break}if(f&16){d=f&15,t=n[V+2],e=Uc;break}if(!(f&64)){s=f,i=V/3+n[V+2];break}if(f&32){e=Nl;break}return e=pa,T.msg="invalid literal/length code",b=cn,k.bitb=D,k.bitk=l,T.avail_in=L,T.total_in+=W-T.next_in_index,T.next_in_index=W,k.write=P,k.inflate_flush(T,b);case Uc:for(R=d;l<R;){if(L!==0)b=Yt;else return k.bitb=D,k.bitk=l,T.avail_in=L,T.total_in+=W-T.next_in_index,T.next_in_index=W,k.write=P,k.inflate_flush(T,b);L--,D|=(T.read_byte(W++)&255)<<l,l+=8}t+=D&zi[R],D>>=R,l-=R,s=m,n=E,i=A,e=zc;case zc:for(R=s;l<R;){if(L!==0)b=Yt;else return k.bitb=D,k.bitk=l,T.avail_in=L,T.total_in+=W-T.next_in_index,T.next_in_index=W,k.write=P,k.inflate_flush(T,b);L--,D|=(T.read_byte(W++)&255)<<l,l+=8}if(V=(i+(D&zi[R]))*3,D>>=n[V+1],l-=n[V+1],f=n[V],f&16){d=f&15,c=n[V+2],e=Xc;break}if(!(f&64)){s=f,i=V/3+n[V+2];break}return e=pa,T.msg="invalid distance code",b=cn,k.bitb=D,k.bitk=l,T.avail_in=L,T.total_in+=W-T.next_in_index,T.next_in_index=W,k.write=P,k.inflate_flush(T,b);case Xc:for(R=d;l<R;){if(L!==0)b=Yt;else return k.bitb=D,k.bitk=l,T.avail_in=L,T.total_in+=W-T.next_in_index,T.next_in_index=W,k.write=P,k.inflate_flush(T,b);L--,D|=(T.read_byte(W++)&255)<<l,l+=8}c+=D&zi[R],D>>=R,l-=R,e=$c;case $c:for(O=P-c;O<0;)O+=k.end;for(;t!==0;){if(y===0&&(P==k.end&&k.read!==0&&(P=0,y=P<k.read?k.read-P-1:k.end-P),y===0&&(k.write=P,b=k.inflate_flush(T,b),P=k.write,y=P<k.read?k.read-P-1:k.end-P,P==k.end&&k.read!==0&&(P=0,y=P<k.read?k.read-P-1:k.end-P),y===0)))return k.bitb=D,k.bitk=l,T.avail_in=L,T.total_in+=W-T.next_in_index,T.next_in_index=W,k.write=P,k.inflate_flush(T,b);k.win[P++]=k.win[O++],y--,O==k.end&&(O=0),t--}e=fa;break;case Yc:if(y===0&&(P==k.end&&k.read!==0&&(P=0,y=P<k.read?k.read-P-1:k.end-P),y===0&&(k.write=P,b=k.inflate_flush(T,b),P=k.write,y=P<k.read?k.read-P-1:k.end-P,P==k.end&&k.read!==0&&(P=0,y=P<k.read?k.read-P-1:k.end-P),y===0)))return k.bitb=D,k.bitk=l,T.avail_in=L,T.total_in+=W-T.next_in_index,T.next_in_index=W,k.write=P,k.inflate_flush(T,b);b=Yt,k.win[P++]=h,y--,e=fa;break;case Nl:if(l>7&&(l-=8,L++,W--),k.write=P,b=k.inflate_flush(T,b),P=k.write,y=P<k.read?k.read-P-1:k.end-P,k.read!=k.write)return k.bitb=D,k.bitk=l,T.avail_in=L,T.total_in+=W-T.next_in_index,T.next_in_index=W,k.write=P,k.inflate_flush(T,b);e=jc;case jc:return b=Us,k.bitb=D,k.bitk=l,T.avail_in=L,T.total_in+=W-T.next_in_index,T.next_in_index=W,k.write=P,k.inflate_flush(T,b);case pa:return b=cn,k.bitb=D,k.bitk=l,T.avail_in=L,T.total_in+=W-T.next_in_index,T.next_in_index=W,k.write=P,k.inflate_flush(T,b);default:return b=mi,k.bitb=D,k.bitk=l,T.avail_in=L,T.total_in+=W-T.next_in_index,T.next_in_index=W,k.write=P,k.inflate_flush(T,b)}},r.free=function(){}}const Kc=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],Jr=0,Dl=1,Gc=2,Zc=3,Qc=4,Jc=5,_a=6,ma=7,ed=8,kr=9;function _1(r,e){const t=this;let n=Jr,i=0,s=0,h=0,d;const c=[0],_=[0],m=new p1;let g=0,S=new Int32Array(wu*3);const E=0,A=new fh;t.bitk=0,t.bitb=0,t.win=new Uint8Array(e),t.end=e,t.read=0,t.write=0,t.reset=function(C,k){k&&(k[0]=E),n==_a&&m.free(C),n=Jr,t.bitk=0,t.bitb=0,t.read=t.write=0},t.reset(r,null),t.inflate_flush=function(C,k){let T,b,R;return b=C.next_out_index,R=t.read,T=(R<=t.write?t.write:t.end)-R,T>C.avail_out&&(T=C.avail_out),T!==0&&k==zs&&(k=Yt),C.avail_out-=T,C.total_out+=T,C.next_out.set(t.win.subarray(R,R+T),b),b+=T,R+=T,R==t.end&&(R=0,t.write==t.end&&(t.write=0),T=t.write-R,T>C.avail_out&&(T=C.avail_out),T!==0&&k==zs&&(k=Yt),C.avail_out-=T,C.total_out+=T,C.next_out.set(t.win.subarray(R,R+T),b),b+=T,R+=T),C.next_out_index=b,t.read=R,k},t.proc=function(C,k){let T,b,R,V,f,D,l,W;for(V=C.next_in_index,f=C.avail_in,b=t.bitb,R=t.bitk,D=t.write,l=D<t.read?t.read-D-1:t.end-D;;){let L,P,y,O,B,v,H,N;switch(n){case Jr:for(;R<3;){if(f!==0)k=Yt;else return t.bitb=b,t.bitk=R,C.avail_in=f,C.total_in+=V-C.next_in_index,C.next_in_index=V,t.write=D,t.inflate_flush(C,k);f--,b|=(C.read_byte(V++)&255)<<R,R+=8}switch(T=b&7,g=T&1,T>>>1){case 0:b>>>=3,R-=3,T=R&7,b>>>=T,R-=T,n=Dl;break;case 1:L=[],P=[],y=[[]],O=[[]],fh.inflate_trees_fixed(L,P,y,O),m.init(L[0],P[0],y[0],0,O[0],0),b>>>=3,R-=3,n=_a;break;case 2:b>>>=3,R-=3,n=Zc;break;case 3:return b>>>=3,R-=3,n=kr,C.msg="invalid block type",k=cn,t.bitb=b,t.bitk=R,C.avail_in=f,C.total_in+=V-C.next_in_index,C.next_in_index=V,t.write=D,t.inflate_flush(C,k)}break;case Dl:for(;R<32;){if(f!==0)k=Yt;else return t.bitb=b,t.bitk=R,C.avail_in=f,C.total_in+=V-C.next_in_index,C.next_in_index=V,t.write=D,t.inflate_flush(C,k);f--,b|=(C.read_byte(V++)&255)<<R,R+=8}if((~b>>>16&65535)!=(b&65535))return n=kr,C.msg="invalid stored block lengths",k=cn,t.bitb=b,t.bitk=R,C.avail_in=f,C.total_in+=V-C.next_in_index,C.next_in_index=V,t.write=D,t.inflate_flush(C,k);i=b&65535,b=R=0,n=i!==0?Gc:g!==0?ma:Jr;break;case Gc:if(f===0||l===0&&(D==t.end&&t.read!==0&&(D=0,l=D<t.read?t.read-D-1:t.end-D),l===0&&(t.write=D,k=t.inflate_flush(C,k),D=t.write,l=D<t.read?t.read-D-1:t.end-D,D==t.end&&t.read!==0&&(D=0,l=D<t.read?t.read-D-1:t.end-D),l===0)))return t.bitb=b,t.bitk=R,C.avail_in=f,C.total_in+=V-C.next_in_index,C.next_in_index=V,t.write=D,t.inflate_flush(C,k);if(k=Yt,T=i,T>f&&(T=f),T>l&&(T=l),t.win.set(C.read_buf(V,T),D),V+=T,f-=T,D+=T,l-=T,(i-=T)!==0)break;n=g!==0?ma:Jr;break;case Zc:for(;R<14;){if(f!==0)k=Yt;else return t.bitb=b,t.bitk=R,C.avail_in=f,C.total_in+=V-C.next_in_index,C.next_in_index=V,t.write=D,t.inflate_flush(C,k);f--,b|=(C.read_byte(V++)&255)<<R,R+=8}if(s=T=b&16383,(T&31)>29||(T>>5&31)>29)return n=kr,C.msg="too many length or distance symbols",k=cn,t.bitb=b,t.bitk=R,C.avail_in=f,C.total_in+=V-C.next_in_index,C.next_in_index=V,t.write=D,t.inflate_flush(C,k);if(T=258+(T&31)+(T>>5&31),!d||d.length<T)d=[];else for(W=0;W<T;W++)d[W]=0;b>>>=14,R-=14,h=0,n=Qc;case Qc:for(;h<4+(s>>>10);){for(;R<3;){if(f!==0)k=Yt;else return t.bitb=b,t.bitk=R,C.avail_in=f,C.total_in+=V-C.next_in_index,C.next_in_index=V,t.write=D,t.inflate_flush(C,k);f--,b|=(C.read_byte(V++)&255)<<R,R+=8}d[Kc[h++]]=b&7,b>>>=3,R-=3}for(;h<19;)d[Kc[h++]]=0;if(c[0]=7,T=A.inflate_trees_bits(d,c,_,S,C),T!=Yt)return k=T,k==cn&&(d=null,n=kr),t.bitb=b,t.bitk=R,C.avail_in=f,C.total_in+=V-C.next_in_index,C.next_in_index=V,t.write=D,t.inflate_flush(C,k);h=0,n=Jc;case Jc:for(;T=s,!(h>=258+(T&31)+(T>>5&31));){let te,G;for(T=c[0];R<T;){if(f!==0)k=Yt;else return t.bitb=b,t.bitk=R,C.avail_in=f,C.total_in+=V-C.next_in_index,C.next_in_index=V,t.write=D,t.inflate_flush(C,k);f--,b|=(C.read_byte(V++)&255)<<R,R+=8}if(T=S[(_[0]+(b&zi[T]))*3+1],G=S[(_[0]+(b&zi[T]))*3+2],G<16)b>>>=T,R-=T,d[h++]=G;else{for(W=G==18?7:G-14,te=G==18?11:3;R<T+W;){if(f!==0)k=Yt;else return t.bitb=b,t.bitk=R,C.avail_in=f,C.total_in+=V-C.next_in_index,C.next_in_index=V,t.write=D,t.inflate_flush(C,k);f--,b|=(C.read_byte(V++)&255)<<R,R+=8}if(b>>>=T,R-=T,te+=b&zi[W],b>>>=W,R-=W,W=h,T=s,W+te>258+(T&31)+(T>>5&31)||G==16&&W<1)return d=null,n=kr,C.msg="invalid bit length repeat",k=cn,t.bitb=b,t.bitk=R,C.avail_in=f,C.total_in+=V-C.next_in_index,C.next_in_index=V,t.write=D,t.inflate_flush(C,k);G=G==16?d[W-1]:0;do d[W++]=G;while(--te!==0);h=W}}if(_[0]=-1,B=[],v=[],H=[],N=[],B[0]=9,v[0]=6,T=s,T=A.inflate_trees_dynamic(257+(T&31),1+(T>>5&31),d,B,v,H,N,S,C),T!=Yt)return T==cn&&(d=null,n=kr),k=T,t.bitb=b,t.bitk=R,C.avail_in=f,C.total_in+=V-C.next_in_index,C.next_in_index=V,t.write=D,t.inflate_flush(C,k);m.init(B[0],v[0],S,H[0],S,N[0]),n=_a;case _a:if(t.bitb=b,t.bitk=R,C.avail_in=f,C.total_in+=V-C.next_in_index,C.next_in_index=V,t.write=D,(k=m.proc(t,C,k))!=Us)return t.inflate_flush(C,k);if(k=Yt,m.free(C),V=C.next_in_index,f=C.avail_in,b=t.bitb,R=t.bitk,D=t.write,l=D<t.read?t.read-D-1:t.end-D,g===0){n=Jr;break}n=ma;case ma:if(t.write=D,k=t.inflate_flush(C,k),D=t.write,l=D<t.read?t.read-D-1:t.end-D,t.read!=t.write)return t.bitb=b,t.bitk=R,C.avail_in=f,C.total_in+=V-C.next_in_index,C.next_in_index=V,t.write=D,t.inflate_flush(C,k);n=ed;case ed:return k=Us,t.bitb=b,t.bitk=R,C.avail_in=f,C.total_in+=V-C.next_in_index,C.next_in_index=V,t.write=D,t.inflate_flush(C,k);case kr:return k=cn,t.bitb=b,t.bitk=R,C.avail_in=f,C.total_in+=V-C.next_in_index,C.next_in_index=V,t.write=D,t.inflate_flush(C,k);default:return k=mi,t.bitb=b,t.bitk=R,C.avail_in=f,C.total_in+=V-C.next_in_index,C.next_in_index=V,t.write=D,t.inflate_flush(C,k)}}},t.free=function(C){t.reset(C,null),t.win=null,S=null},t.set_dictionary=function(C,k,T){t.win.set(C.subarray(k,k+T),0),t.read=t.write=T},t.sync_point=function(){return n==Dl?1:0}}const m1=32,g1=8,v1=0,td=1,nd=2,id=3,sd=4,rd=5,Fl=6,Bo=7,od=12,sr=13,b1=[0,0,255,255];function y1(){const r=this;r.mode=0,r.method=0,r.was=[0],r.need=0,r.marker=0,r.wbits=0;function e(t){return!t||!t.istate?mi:(t.total_in=t.total_out=0,t.msg=null,t.istate.mode=Bo,t.istate.blocks.reset(t,null),Yt)}r.inflateEnd=function(t){return r.blocks&&r.blocks.free(t),r.blocks=null,Yt},r.inflateInit=function(t,n){return t.msg=null,r.blocks=null,n<8||n>15?(r.inflateEnd(t),mi):(r.wbits=n,t.istate.blocks=new _1(t,1<<n),e(t),Yt)},r.inflate=function(t,n){let i,s;if(!t||!t.istate||!t.next_in)return mi;const h=t.istate;for(n=n==r1?zs:Yt,i=zs;;)switch(h.mode){case v1:if(t.avail_in===0)return i;if(i=n,t.avail_in--,t.total_in++,((h.method=t.read_byte(t.next_in_index++))&15)!=g1){h.mode=sr,t.msg="unknown compression method",h.marker=5;break}if((h.method>>4)+8>h.wbits){h.mode=sr,t.msg="invalid win size",h.marker=5;break}h.mode=td;case td:if(t.avail_in===0)return i;if(i=n,t.avail_in--,t.total_in++,s=t.read_byte(t.next_in_index++)&255,((h.method<<8)+s)%31!==0){h.mode=sr,t.msg="incorrect header check",h.marker=5;break}if(!(s&m1)){h.mode=Bo;break}h.mode=nd;case nd:if(t.avail_in===0)return i;i=n,t.avail_in--,t.total_in++,h.need=(t.read_byte(t.next_in_index++)&255)<<24&4278190080,h.mode=id;case id:if(t.avail_in===0)return i;i=n,t.avail_in--,t.total_in++,h.need+=(t.read_byte(t.next_in_index++)&255)<<16&16711680,h.mode=sd;case sd:if(t.avail_in===0)return i;i=n,t.avail_in--,t.total_in++,h.need+=(t.read_byte(t.next_in_index++)&255)<<8&65280,h.mode=rd;case rd:return t.avail_in===0?i:(i=n,t.avail_in--,t.total_in++,h.need+=t.read_byte(t.next_in_index++)&255,h.mode=Fl,i1);case Fl:return h.mode=sr,t.msg="need dictionary",h.marker=0,mi;case Bo:if(i=h.blocks.proc(t,i),i==cn){h.mode=sr,h.marker=0;break}if(i==Yt&&(i=n),i!=Us)return i;i=n,h.blocks.reset(t,h.was),h.mode=od;case od:return t.avail_in=0,Us;case sr:return cn;default:return mi}},r.inflateSetDictionary=function(t,n,i){let s=0,h=i;if(!t||!t.istate||t.istate.mode!=Fl)return mi;const d=t.istate;return h>=1<<d.wbits&&(h=(1<<d.wbits)-1,s=i-h),d.blocks.set_dictionary(n,s,h),d.mode=Bo,Yt},r.inflateSync=function(t){let n,i,s,h,d;if(!t||!t.istate)return mi;const c=t.istate;if(c.mode!=sr&&(c.mode=sr,c.marker=0),(n=t.avail_in)===0)return zs;for(i=t.next_in_index,s=c.marker;n!==0&&s<4;)t.read_byte(i)==b1[s]?s++:t.read_byte(i)!==0?s=0:s=4-s,i++,n--;return t.total_in+=i-t.next_in_index,t.next_in_index=i,t.avail_in=n,c.marker=s,s!=4?cn:(h=t.total_in,d=t.total_out,e(t),t.total_in=h,t.total_out=d,c.mode=Bo,Yt)},r.inflateSyncPoint=function(t){return!t||!t.istate||!t.istate.blocks?mi:t.istate.blocks.sync_point()}}function xu(){}xu.prototype={inflateInit(r){const e=this;return e.istate=new y1,r||(r=n1),e.istate.inflateInit(e,r)},inflate(r){const e=this;return e.istate?e.istate.inflate(e,r):mi},inflateEnd(){const r=this;if(!r.istate)return mi;const e=r.istate.inflateEnd(r);return r.istate=null,e},inflateSync(){const r=this;return r.istate?r.istate.inflateSync(r):mi},inflateSetDictionary(r,e){const t=this;return t.istate?t.istate.inflateSetDictionary(t,r,e):mi},read_byte(r){return this.next_in[r]},read_buf(r,e){return this.next_in.subarray(r,r+e)}};function w1(r){const e=this,t=new xu,n=r&&r.chunkSize?Math.floor(r.chunkSize*2):128*1024,i=s1,s=new Uint8Array(n);let h=!1;t.inflateInit(),t.next_out=s,e.append=function(d,c){const _=[];let m,g,S=0,E=0,A=0;if(d.length!==0){t.next_in_index=0,t.next_in=d,t.avail_in=d.length;do{if(t.next_out_index=0,t.avail_out=n,t.avail_in===0&&!h&&(t.next_in_index=0,h=!0),m=t.inflate(i),h&&m===zs){if(t.avail_in!==0)throw new Error("inflating: bad input")}else if(m!==Yt&&m!==Us)throw new Error("inflating: "+t.msg);if((h||m===Us)&&t.avail_in===d.length)throw new Error("inflating: bad input");t.next_out_index&&(t.next_out_index===n?_.push(new Uint8Array(s)):_.push(s.subarray(0,t.next_out_index))),A+=t.next_out_index,c&&t.next_in_index>0&&t.next_in_index!=S&&(c(t.next_in_index),S=t.next_in_index)}while(t.avail_in>0||t.avail_out===0);return _.length>1?(g=new Uint8Array(A),_.forEach(function(C){g.set(C,E),E+=C.length})):g=_[0]?new Uint8Array(_[0]):new Uint8Array,g}},e.flush=function(){t.inflateEnd()}}const bi=4294967295,gi=65535,ad=8,x1=0,S1=99,C1=67324752,Su=134695760,k1=Su,P1=33639248,E1=101010256,B1=101075792,M1=117853008,ph=22,Cu=20,ku=56,T1=ph+Cu+ku,I1=1,A1=39169,R1=10,L1=1,Pu=21589,N1=6534,D1=1,F1=8,O1=2048,H1=16,V1=20,ld=45,hd=51,Ol="/",cd=new Date(2107,11,31),dd=new Date(1980,0,1),ri=void 0,Va="undefined",Eu="function";class ud{constructor(e){return class extends TransformStream{constructor(t,n){const i=new e(n);super({transform(s,h){h.enqueue(i.append(s))},flush(s){const h=i.flush();h&&s.enqueue(h)}})}}}}const W1=64;let Bu=2;try{typeof navigator!=Va&&navigator.hardwareConcurrency&&(Bu=navigator.hardwareConcurrency)}catch{}const q1={chunkSize:512*1024,maxWorkers:Bu,terminateWorkerTimeout:5e3,useWebWorkers:!0,useCompressionStream:!0,workerScripts:ri,CompressionStreamNative:typeof CompressionStream!=Va&&CompressionStream,DecompressionStreamNative:typeof DecompressionStream!=Va&&DecompressionStream},cr=Object.assign({},q1);function U1(){return cr}function z1(r){return Math.max(r.chunkSize,W1)}function Mh(r){const{baseURL:e,chunkSize:t,maxWorkers:n,terminateWorkerTimeout:i,useCompressionStream:s,useWebWorkers:h,Deflate:d,Inflate:c,CompressionStream:_,DecompressionStream:m,workerScripts:g}=r;if(rr("baseURL",e),rr("chunkSize",t),rr("maxWorkers",n),rr("terminateWorkerTimeout",i),rr("useCompressionStream",s),rr("useWebWorkers",h),d&&(cr.CompressionStream=new ud(d)),c&&(cr.DecompressionStream=new ud(c)),rr("CompressionStream",_),rr("DecompressionStream",m),g!==ri){const{deflate:S,inflate:E}=g;if((S||E)&&(cr.workerScripts||(cr.workerScripts={})),S){if(!Array.isArray(S))throw new Error("workerScripts.deflate must be an array");cr.workerScripts.deflate=S}if(E){if(!Array.isArray(E))throw new Error("workerScripts.inflate must be an array");cr.workerScripts.inflate=E}}}function rr(r,e){e!==ri&&(cr[r]=e)}const Hl={application:{"andrew-inset":"ez",annodex:"anx","atom+xml":"atom","atomcat+xml":"atomcat","atomserv+xml":"atomsrv",bbolin:"lin","cu-seeme":"cu","davmount+xml":"davmount",dsptype:"tsp",ecmascript:["es","ecma"],futuresplash:"spl",hta:"hta","java-archive":"jar","java-serialized-object":"ser","java-vm":"class",m3g:"m3g","mac-binhex40":"hqx",mathematica:["nb","ma","mb"],msaccess:"mdb",msword:["doc","dot","wiz"],mxf:"mxf",oda:"oda",ogg:"ogx",pdf:"pdf","pgp-keys":"key","pgp-signature":["asc","sig"],"pics-rules":"prf",postscript:["ps","ai","eps","epsi","epsf","eps2","eps3"],rar:"rar","rdf+xml":"rdf","rss+xml":"rss",rtf:"rtf","xhtml+xml":["xhtml","xht"],xml:["xml","xsl","xsd","xpdl"],"xspf+xml":"xspf",zip:"zip","vnd.android.package-archive":"apk","vnd.cinderella":"cdy","vnd.google-earth.kml+xml":"kml","vnd.google-earth.kmz":"kmz","vnd.mozilla.xul+xml":"xul","vnd.ms-excel":["xls","xlb","xlt","xlm","xla","xlc","xlw"],"vnd.ms-pki.seccat":"cat","vnd.ms-pki.stl":"stl","vnd.ms-powerpoint":["ppt","pps","pot","ppa","pwz"],"vnd.oasis.opendocument.chart":"odc","vnd.oasis.opendocument.database":"odb","vnd.oasis.opendocument.formula":"odf","vnd.oasis.opendocument.graphics":"odg","vnd.oasis.opendocument.graphics-template":"otg","vnd.oasis.opendocument.image":"odi","vnd.oasis.opendocument.presentation":"odp","vnd.oasis.opendocument.presentation-template":"otp","vnd.oasis.opendocument.spreadsheet":"ods","vnd.oasis.opendocument.spreadsheet-template":"ots","vnd.oasis.opendocument.text":"odt","vnd.oasis.opendocument.text-master":["odm","otm"],"vnd.oasis.opendocument.text-template":"ott","vnd.oasis.opendocument.text-web":"oth","vnd.openxmlformats-officedocument.spreadsheetml.sheet":"xlsx","vnd.openxmlformats-officedocument.spreadsheetml.template":"xltx","vnd.openxmlformats-officedocument.presentationml.presentation":"pptx","vnd.openxmlformats-officedocument.presentationml.slideshow":"ppsx","vnd.openxmlformats-officedocument.presentationml.template":"potx","vnd.openxmlformats-officedocument.wordprocessingml.document":"docx","vnd.openxmlformats-officedocument.wordprocessingml.template":"dotx","vnd.smaf":"mmf","vnd.stardivision.calc":"sdc","vnd.stardivision.chart":"sds","vnd.stardivision.draw":"sda","vnd.stardivision.impress":"sdd","vnd.stardivision.math":["sdf","smf"],"vnd.stardivision.writer":["sdw","vor"],"vnd.stardivision.writer-global":"sgl","vnd.sun.xml.calc":"sxc","vnd.sun.xml.calc.template":"stc","vnd.sun.xml.draw":"sxd","vnd.sun.xml.draw.template":"std","vnd.sun.xml.impress":"sxi","vnd.sun.xml.impress.template":"sti","vnd.sun.xml.math":"sxm","vnd.sun.xml.writer":"sxw","vnd.sun.xml.writer.global":"sxg","vnd.sun.xml.writer.template":"stw","vnd.symbian.install":["sis","sisx"],"vnd.visio":["vsd","vst","vss","vsw","vsdx","vssx","vstx","vssm","vstm"],"vnd.wap.wbxml":"wbxml","vnd.wap.wmlc":"wmlc","vnd.wap.wmlscriptc":"wmlsc","vnd.wordperfect":"wpd","vnd.wordperfect5.1":"wp5","x-123":"wk","x-7z-compressed":"7z","x-abiword":"abw","x-apple-diskimage":"dmg","x-bcpio":"bcpio","x-bittorrent":"torrent","x-cbr":["cbr","cba","cbt","cb7"],"x-cbz":"cbz","x-cdf":["cdf","cda"],"x-cdlink":"vcd","x-chess-pgn":"pgn","x-cpio":"cpio","x-csh":"csh","x-director":["dir","dxr","cst","cct","cxt","w3d","fgd","swa"],"x-dms":"dms","x-doom":"wad","x-dvi":"dvi","x-httpd-eruby":"rhtml","x-font":"pcf.Z","x-freemind":"mm","x-gnumeric":"gnumeric","x-go-sgf":"sgf","x-graphing-calculator":"gcf","x-gtar":["gtar","taz"],"x-hdf":"hdf","x-httpd-php":["phtml","pht","php"],"x-httpd-php-source":"phps","x-httpd-php3":"php3","x-httpd-php3-preprocessed":"php3p","x-httpd-php4":"php4","x-httpd-php5":"php5","x-ica":"ica","x-info":"info","x-internet-signup":["ins","isp"],"x-iphone":"iii","x-iso9660-image":"iso","x-java-jnlp-file":"jnlp","x-jmol":"jmz","x-killustrator":"kil","x-latex":"latex","x-lyx":"lyx","x-lzx":"lzx","x-maker":["frm","fb","fbdoc"],"x-ms-wmd":"wmd","x-msdos-program":["com","exe","bat","dll"],"x-netcdf":["nc"],"x-ns-proxy-autoconfig":["pac","dat"],"x-nwc":"nwc","x-object":"o","x-oz-application":"oza","x-pkcs7-certreqresp":"p7r","x-python-code":["pyc","pyo"],"x-qgis":["qgs","shp","shx"],"x-quicktimeplayer":"qtl","x-redhat-package-manager":["rpm","rpa"],"x-ruby":"rb","x-sh":"sh","x-shar":"shar","x-shockwave-flash":["swf","swfl"],"x-silverlight":"scr","x-stuffit":"sit","x-sv4cpio":"sv4cpio","x-sv4crc":"sv4crc","x-tar":"tar","x-tex-gf":"gf","x-tex-pk":"pk","x-texinfo":["texinfo","texi"],"x-trash":["~","%","bak","old","sik"],"x-ustar":"ustar","x-wais-source":"src","x-wingz":"wz","x-x509-ca-cert":["crt","der","cer"],"x-xcf":"xcf","x-xfig":"fig","x-xpinstall":"xpi",applixware:"aw","atomsvc+xml":"atomsvc","ccxml+xml":"ccxml","cdmi-capability":"cdmia","cdmi-container":"cdmic","cdmi-domain":"cdmid","cdmi-object":"cdmio","cdmi-queue":"cdmiq","docbook+xml":"dbk","dssc+der":"dssc","dssc+xml":"xdssc","emma+xml":"emma","epub+zip":"epub",exi:"exi","font-tdpfr":"pfr","gml+xml":"gml","gpx+xml":"gpx",gxf:"gxf",hyperstudio:"stk","inkml+xml":["ink","inkml"],ipfix:"ipfix","jsonml+json":"jsonml","lost+xml":"lostxml","mads+xml":"mads",marc:"mrc","marcxml+xml":"mrcx","mathml+xml":["mathml","mml"],mbox:"mbox","mediaservercontrol+xml":"mscml","metalink+xml":"metalink","metalink4+xml":"meta4","mets+xml":"mets","mods+xml":"mods",mp21:["m21","mp21"],mp4:"mp4s","oebps-package+xml":"opf","omdoc+xml":"omdoc",onenote:["onetoc","onetoc2","onetmp","onepkg"],oxps:"oxps","patch-ops-error+xml":"xer","pgp-encrypted":"pgp",pkcs10:"p10","pkcs7-mime":["p7m","p7c"],"pkcs7-signature":"p7s",pkcs8:"p8","pkix-attr-cert":"ac","pkix-crl":"crl","pkix-pkipath":"pkipath",pkixcmp:"pki","pls+xml":"pls","prs.cww":"cww","pskc+xml":"pskcxml","reginfo+xml":"rif","relax-ng-compact-syntax":"rnc","resource-lists+xml":"rl","resource-lists-diff+xml":"rld","rls-services+xml":"rs","rpki-ghostbusters":"gbr","rpki-manifest":"mft","rpki-roa":"roa","rsd+xml":"rsd","sbml+xml":"sbml","scvp-cv-request":"scq","scvp-cv-response":"scs","scvp-vp-request":"spq","scvp-vp-response":"spp",sdp:"sdp","set-payment-initiation":"setpay","set-registration-initiation":"setreg","shf+xml":"shf","sparql-query":"rq","sparql-results+xml":"srx",srgs:"gram","srgs+xml":"grxml","sru+xml":"sru","ssdl+xml":"ssdl","ssml+xml":"ssml","tei+xml":["tei","teicorpus"],"thraud+xml":"tfi","timestamped-data":"tsd","vnd.3gpp.pic-bw-large":"plb","vnd.3gpp.pic-bw-small":"psb","vnd.3gpp.pic-bw-var":"pvb","vnd.3gpp2.tcap":"tcap","vnd.3m.post-it-notes":"pwn","vnd.accpac.simply.aso":"aso","vnd.accpac.simply.imp":"imp","vnd.acucobol":"acu","vnd.acucorp":["atc","acutc"],"vnd.adobe.air-application-installer-package+zip":"air","vnd.adobe.formscentral.fcdt":"fcdt","vnd.adobe.fxp":["fxp","fxpl"],"vnd.adobe.xdp+xml":"xdp","vnd.adobe.xfdf":"xfdf","vnd.ahead.space":"ahead","vnd.airzip.filesecure.azf":"azf","vnd.airzip.filesecure.azs":"azs","vnd.amazon.ebook":"azw","vnd.americandynamics.acc":"acc","vnd.amiga.ami":"ami","vnd.anser-web-certificate-issue-initiation":"cii","vnd.anser-web-funds-transfer-initiation":"fti","vnd.antix.game-component":"atx","vnd.apple.installer+xml":"mpkg","vnd.apple.mpegurl":"m3u8","vnd.aristanetworks.swi":"swi","vnd.astraea-software.iota":"iota","vnd.audiograph":"aep","vnd.blueice.multipass":"mpm","vnd.bmi":"bmi","vnd.businessobjects":"rep","vnd.chemdraw+xml":"cdxml","vnd.chipnuts.karaoke-mmd":"mmd","vnd.claymore":"cla","vnd.cloanto.rp9":"rp9","vnd.clonk.c4group":["c4g","c4d","c4f","c4p","c4u"],"vnd.cluetrust.cartomobile-config":"c11amc","vnd.cluetrust.cartomobile-config-pkg":"c11amz","vnd.commonspace":"csp","vnd.contact.cmsg":"cdbcmsg","vnd.cosmocaller":"cmc","vnd.crick.clicker":"clkx","vnd.crick.clicker.keyboard":"clkk","vnd.crick.clicker.palette":"clkp","vnd.crick.clicker.template":"clkt","vnd.crick.clicker.wordbank":"clkw","vnd.criticaltools.wbs+xml":"wbs","vnd.ctc-posml":"pml","vnd.cups-ppd":"ppd","vnd.curl.car":"car","vnd.curl.pcurl":"pcurl","vnd.dart":"dart","vnd.data-vision.rdz":"rdz","vnd.dece.data":["uvf","uvvf","uvd","uvvd"],"vnd.dece.ttml+xml":["uvt","uvvt"],"vnd.dece.unspecified":["uvx","uvvx"],"vnd.dece.zip":["uvz","uvvz"],"vnd.denovo.fcselayout-link":"fe_launch","vnd.dna":"dna","vnd.dolby.mlp":"mlp","vnd.dpgraph":"dpg","vnd.dreamfactory":"dfac","vnd.ds-keypoint":"kpxx","vnd.dvb.ait":"ait","vnd.dvb.service":"svc","vnd.dynageo":"geo","vnd.ecowin.chart":"mag","vnd.enliven":"nml","vnd.epson.esf":"esf","vnd.epson.msf":"msf","vnd.epson.quickanime":"qam","vnd.epson.salt":"slt","vnd.epson.ssf":"ssf","vnd.eszigno3+xml":["es3","et3"],"vnd.ezpix-album":"ez2","vnd.ezpix-package":"ez3","vnd.fdf":"fdf","vnd.fdsn.mseed":"mseed","vnd.fdsn.seed":["seed","dataless"],"vnd.flographit":"gph","vnd.fluxtime.clip":"ftc","vnd.framemaker":["fm","frame","maker","book"],"vnd.frogans.fnc":"fnc","vnd.frogans.ltf":"ltf","vnd.fsc.weblaunch":"fsc","vnd.fujitsu.oasys":"oas","vnd.fujitsu.oasys2":"oa2","vnd.fujitsu.oasys3":"oa3","vnd.fujitsu.oasysgp":"fg5","vnd.fujitsu.oasysprs":"bh2","vnd.fujixerox.ddd":"ddd","vnd.fujixerox.docuworks":"xdw","vnd.fujixerox.docuworks.binder":"xbd","vnd.fuzzysheet":"fzs","vnd.genomatix.tuxedo":"txd","vnd.geogebra.file":"ggb","vnd.geogebra.tool":"ggt","vnd.geometry-explorer":["gex","gre"],"vnd.geonext":"gxt","vnd.geoplan":"g2w","vnd.geospace":"g3w","vnd.gmx":"gmx","vnd.grafeq":["gqf","gqs"],"vnd.groove-account":"gac","vnd.groove-help":"ghf","vnd.groove-identity-message":"gim","vnd.groove-injector":"grv","vnd.groove-tool-message":"gtm","vnd.groove-tool-template":"tpl","vnd.groove-vcard":"vcg","vnd.hal+xml":"hal","vnd.handheld-entertainment+xml":"zmm","vnd.hbci":"hbci","vnd.hhe.lesson-player":"les","vnd.hp-hpgl":"hpgl","vnd.hp-hpid":"hpid","vnd.hp-hps":"hps","vnd.hp-jlyt":"jlt","vnd.hp-pcl":"pcl","vnd.hp-pclxl":"pclxl","vnd.hydrostatix.sof-data":"sfd-hdstx","vnd.ibm.minipay":"mpy","vnd.ibm.modcap":["afp","listafp","list3820"],"vnd.ibm.rights-management":"irm","vnd.ibm.secure-container":"sc","vnd.iccprofile":["icc","icm"],"vnd.igloader":"igl","vnd.immervision-ivp":"ivp","vnd.immervision-ivu":"ivu","vnd.insors.igm":"igm","vnd.intercon.formnet":["xpw","xpx"],"vnd.intergeo":"i2g","vnd.intu.qbo":"qbo","vnd.intu.qfx":"qfx","vnd.ipunplugged.rcprofile":"rcprofile","vnd.irepository.package+xml":"irp","vnd.is-xpr":"xpr","vnd.isac.fcs":"fcs","vnd.jam":"jam","vnd.jcp.javame.midlet-rms":"rms","vnd.jisp":"jisp","vnd.joost.joda-archive":"joda","vnd.kahootz":["ktz","ktr"],"vnd.kde.karbon":"karbon","vnd.kde.kchart":"chrt","vnd.kde.kformula":"kfo","vnd.kde.kivio":"flw","vnd.kde.kontour":"kon","vnd.kde.kpresenter":["kpr","kpt"],"vnd.kde.kspread":"ksp","vnd.kde.kword":["kwd","kwt"],"vnd.kenameaapp":"htke","vnd.kidspiration":"kia","vnd.kinar":["kne","knp"],"vnd.koan":["skp","skd","skt","skm"],"vnd.kodak-descriptor":"sse","vnd.las.las+xml":"lasxml","vnd.llamagraphics.life-balance.desktop":"lbd","vnd.llamagraphics.life-balance.exchange+xml":"lbe","vnd.lotus-1-2-3":"123","vnd.lotus-approach":"apr","vnd.lotus-freelance":"pre","vnd.lotus-notes":"nsf","vnd.lotus-organizer":"org","vnd.lotus-screencam":"scm","vnd.lotus-wordpro":"lwp","vnd.macports.portpkg":"portpkg","vnd.mcd":"mcd","vnd.medcalcdata":"mc1","vnd.mediastation.cdkey":"cdkey","vnd.mfer":"mwf","vnd.mfmp":"mfm","vnd.micrografx.flo":"flo","vnd.micrografx.igx":"igx","vnd.mif":"mif","vnd.mobius.daf":"daf","vnd.mobius.dis":"dis","vnd.mobius.mbk":"mbk","vnd.mobius.mqy":"mqy","vnd.mobius.msl":"msl","vnd.mobius.plc":"plc","vnd.mobius.txf":"txf","vnd.mophun.application":"mpn","vnd.mophun.certificate":"mpc","vnd.ms-artgalry":"cil","vnd.ms-cab-compressed":"cab","vnd.ms-excel.addin.macroenabled.12":"xlam","vnd.ms-excel.sheet.binary.macroenabled.12":"xlsb","vnd.ms-excel.sheet.macroenabled.12":"xlsm","vnd.ms-excel.template.macroenabled.12":"xltm","vnd.ms-fontobject":"eot","vnd.ms-htmlhelp":"chm","vnd.ms-ims":"ims","vnd.ms-lrm":"lrm","vnd.ms-officetheme":"thmx","vnd.ms-powerpoint.addin.macroenabled.12":"ppam","vnd.ms-powerpoint.presentation.macroenabled.12":"pptm","vnd.ms-powerpoint.slide.macroenabled.12":"sldm","vnd.ms-powerpoint.slideshow.macroenabled.12":"ppsm","vnd.ms-powerpoint.template.macroenabled.12":"potm","vnd.ms-project":["mpp","mpt"],"vnd.ms-word.document.macroenabled.12":"docm","vnd.ms-word.template.macroenabled.12":"dotm","vnd.ms-works":["wps","wks","wcm","wdb"],"vnd.ms-wpl":"wpl","vnd.ms-xpsdocument":"xps","vnd.mseq":"mseq","vnd.musician":"mus","vnd.muvee.style":"msty","vnd.mynfc":"taglet","vnd.neurolanguage.nlu":"nlu","vnd.nitf":["ntf","nitf"],"vnd.noblenet-directory":"nnd","vnd.noblenet-sealer":"nns","vnd.noblenet-web":"nnw","vnd.nokia.n-gage.data":"ngdat","vnd.nokia.n-gage.symbian.install":"n-gage","vnd.nokia.radio-preset":"rpst","vnd.nokia.radio-presets":"rpss","vnd.novadigm.edm":"edm","vnd.novadigm.edx":"edx","vnd.novadigm.ext":"ext","vnd.oasis.opendocument.chart-template":"otc","vnd.oasis.opendocument.formula-template":"odft","vnd.oasis.opendocument.image-template":"oti","vnd.olpc-sugar":"xo","vnd.oma.dd2+xml":"dd2","vnd.openofficeorg.extension":"oxt","vnd.openxmlformats-officedocument.presentationml.slide":"sldx","vnd.osgeo.mapguide.package":"mgp","vnd.osgi.dp":"dp","vnd.osgi.subsystem":"esa","vnd.palm":["pdb","pqa","oprc"],"vnd.pawaafile":"paw","vnd.pg.format":"str","vnd.pg.osasli":"ei6","vnd.picsel":"efif","vnd.pmi.widget":"wg","vnd.pocketlearn":"plf","vnd.powerbuilder6":"pbd","vnd.previewsystems.box":"box","vnd.proteus.magazine":"mgz","vnd.publishare-delta-tree":"qps","vnd.pvi.ptid1":"ptid","vnd.quark.quarkxpress":["qxd","qxt","qwd","qwt","qxl","qxb"],"vnd.realvnc.bed":"bed","vnd.recordare.musicxml":"mxl","vnd.recordare.musicxml+xml":"musicxml","vnd.rig.cryptonote":"cryptonote","vnd.rn-realmedia":"rm","vnd.rn-realmedia-vbr":"rmvb","vnd.route66.link66+xml":"link66","vnd.sailingtracker.track":"st","vnd.seemail":"see","vnd.sema":"sema","vnd.semd":"semd","vnd.semf":"semf","vnd.shana.informed.formdata":"ifm","vnd.shana.informed.formtemplate":"itp","vnd.shana.informed.interchange":"iif","vnd.shana.informed.package":"ipk","vnd.simtech-mindmapper":["twd","twds"],"vnd.smart.teacher":"teacher","vnd.solent.sdkm+xml":["sdkm","sdkd"],"vnd.spotfire.dxp":"dxp","vnd.spotfire.sfs":"sfs","vnd.stepmania.package":"smzip","vnd.stepmania.stepchart":"sm","vnd.sus-calendar":["sus","susp"],"vnd.svd":"svd","vnd.syncml+xml":"xsm","vnd.syncml.dm+wbxml":"bdm","vnd.syncml.dm+xml":"xdm","vnd.tao.intent-module-archive":"tao","vnd.tcpdump.pcap":["pcap","cap","dmp"],"vnd.tmobile-livetv":"tmo","vnd.trid.tpt":"tpt","vnd.triscape.mxs":"mxs","vnd.trueapp":"tra","vnd.ufdl":["ufd","ufdl"],"vnd.uiq.theme":"utz","vnd.umajin":"umj","vnd.unity":"unityweb","vnd.uoml+xml":"uoml","vnd.vcx":"vcx","vnd.visionary":"vis","vnd.vsf":"vsf","vnd.webturbo":"wtb","vnd.wolfram.player":"nbp","vnd.wqd":"wqd","vnd.wt.stf":"stf","vnd.xara":"xar","vnd.xfdl":"xfdl","vnd.yamaha.hv-dic":"hvd","vnd.yamaha.hv-script":"hvs","vnd.yamaha.hv-voice":"hvp","vnd.yamaha.openscoreformat":"osf","vnd.yamaha.openscoreformat.osfpvg+xml":"osfpvg","vnd.yamaha.smaf-audio":"saf","vnd.yamaha.smaf-phrase":"spf","vnd.yellowriver-custom-menu":"cmp","vnd.zul":["zir","zirz"],"vnd.zzazz.deck+xml":"zaz","voicexml+xml":"vxml",widget:"wgt",winhlp:"hlp","wsdl+xml":"wsdl","wspolicy+xml":"wspolicy","x-ace-compressed":"ace","x-authorware-bin":["aab","x32","u32","vox"],"x-authorware-map":"aam","x-authorware-seg":"aas","x-blorb":["blb","blorb"],"x-bzip":"bz","x-bzip2":["bz2","boz"],"x-cfs-compressed":"cfs","x-chat":"chat","x-conference":"nsc","x-dgc-compressed":"dgc","x-dtbncx+xml":"ncx","x-dtbook+xml":"dtb","x-dtbresource+xml":"res","x-eva":"eva","x-font-bdf":"bdf","x-font-ghostscript":"gsf","x-font-linux-psf":"psf","x-font-pcf":"pcf","x-font-snf":"snf","x-font-ttf":["ttf","ttc"],"x-font-type1":["pfa","pfb","pfm","afm"],"x-freearc":"arc","x-gca-compressed":"gca","x-glulx":"ulx","x-gramps-xml":"gramps","x-install-instructions":"install","x-lzh-compressed":["lzh","lha"],"x-mie":"mie","x-mobipocket-ebook":["prc","mobi"],"x-ms-application":"application","x-ms-shortcut":"lnk","x-ms-xbap":"xbap","x-msbinder":"obd","x-mscardfile":"crd","x-msclip":"clp","application/x-ms-installer":"msi","x-msmediaview":["mvb","m13","m14"],"x-msmetafile":["wmf","wmz","emf","emz"],"x-msmoney":"mny","x-mspublisher":"pub","x-msschedule":"scd","x-msterminal":"trm","x-mswrite":"wri","x-nzb":"nzb","x-pkcs12":["p12","pfx"],"x-pkcs7-certificates":["p7b","spc"],"x-research-info-systems":"ris","x-silverlight-app":"xap","x-sql":"sql","x-stuffitx":"sitx","x-subrip":"srt","x-t3vm-image":"t3","x-tex-tfm":"tfm","x-tgif":"obj","x-xliff+xml":"xlf","x-xz":"xz","x-zmachine":["z1","z2","z3","z4","z5","z6","z7","z8"],"xaml+xml":"xaml","xcap-diff+xml":"xdf","xenc+xml":"xenc","xml-dtd":"dtd","xop+xml":"xop","xproc+xml":"xpl","xslt+xml":"xslt","xv+xml":["mxml","xhvml","xvml","xvm"],yang:"yang","yin+xml":"yin",envoy:"evy",fractals:"fif","internet-property-stream":"acx",olescript:"axs","vnd.ms-outlook":"msg","vnd.ms-pkicertstore":"sst","x-compress":"z","x-perfmon":["pma","pmc","pmr","pmw"],"ynd.ms-pkipko":"pko",gzip:["gz","tgz"],"smil+xml":["smi","smil"],"vnd.debian.binary-package":["deb","udeb"],"vnd.hzn-3d-crossword":"x3d","vnd.sqlite3":["db","sqlite","sqlite3","db-wal","sqlite-wal","db-shm","sqlite-shm"],"vnd.wap.sic":"sic","vnd.wap.slc":"slc","x-krita":["kra","krz"],"x-perl":["pm","pl"],yaml:["yaml","yml"]},audio:{amr:"amr","amr-wb":"awb",annodex:"axa",basic:["au","snd"],flac:"flac",midi:["mid","midi","kar","rmi"],mpeg:["mpga","mpega","mp3","m4a","mp2a","m2a","m3a"],mpegurl:"m3u",ogg:["oga","ogg","spx"],"prs.sid":"sid","x-aiff":"aifc","x-gsm":"gsm","x-ms-wma":"wma","x-ms-wax":"wax","x-pn-realaudio":"ram","x-realaudio":"ra","x-sd2":"sd2",adpcm:"adp",mp4:"mp4a",s3m:"s3m",silk:"sil","vnd.dece.audio":["uva","uvva"],"vnd.digital-winds":"eol","vnd.dra":"dra","vnd.dts":"dts","vnd.dts.hd":"dtshd","vnd.lucent.voice":"lvp","vnd.ms-playready.media.pya":"pya","vnd.nuera.ecelp4800":"ecelp4800","vnd.nuera.ecelp7470":"ecelp7470","vnd.nuera.ecelp9600":"ecelp9600","vnd.rip":"rip",webm:"weba","x-caf":"caf","x-matroska":"mka","x-pn-realaudio-plugin":"rmp",xm:"xm",aac:"aac",aiff:["aiff","aif","aff"],opus:"opus",wav:"wav"},chemical:{"x-alchemy":"alc","x-cache":["cac","cache"],"x-cache-csf":"csf","x-cactvs-binary":["cbin","cascii","ctab"],"x-cdx":"cdx","x-chem3d":"c3d","x-cif":"cif","x-cmdf":"cmdf","x-cml":"cml","x-compass":"cpa","x-crossfire":"bsd","x-csml":["csml","csm"],"x-ctx":"ctx","x-cxf":["cxf","cef"],"x-embl-dl-nucleotide":["emb","embl"],"x-gamess-input":["inp","gam","gamin"],"x-gaussian-checkpoint":["fch","fchk"],"x-gaussian-cube":"cub","x-gaussian-input":["gau","gjc","gjf"],"x-gaussian-log":"gal","x-gcg8-sequence":"gcg","x-genbank":"gen","x-hin":"hin","x-isostar":["istr","ist"],"x-jcamp-dx":["jdx","dx"],"x-kinemage":"kin","x-macmolecule":"mcm","x-macromodel-input":"mmod","x-mdl-molfile":"mol","x-mdl-rdfile":"rd","x-mdl-rxnfile":"rxn","x-mdl-sdfile":"sd","x-mdl-tgf":"tgf","x-mmcif":"mcif","x-mol2":"mol2","x-molconn-Z":"b","x-mopac-graph":"gpt","x-mopac-input":["mop","mopcrt","zmt"],"x-mopac-out":"moo","x-ncbi-asn1":"asn","x-ncbi-asn1-ascii":["prt","ent"],"x-ncbi-asn1-binary":"val","x-rosdal":"ros","x-swissprot":"sw","x-vamas-iso14976":"vms","x-vmd":"vmd","x-xtel":"xtel","x-xyz":"xyz"},font:{otf:"otf",woff:"woff",woff2:"woff2"},image:{gif:"gif",ief:"ief",jpeg:["jpeg","jpg","jpe","jfif","jfif-tbnl","jif"],pcx:"pcx",png:"png","svg+xml":["svg","svgz"],tiff:["tiff","tif"],"vnd.djvu":["djvu","djv"],"vnd.wap.wbmp":"wbmp","x-canon-cr2":"cr2","x-canon-crw":"crw","x-cmu-raster":"ras","x-coreldraw":"cdr","x-coreldrawpattern":"pat","x-coreldrawtemplate":"cdt","x-corelphotopaint":"cpt","x-epson-erf":"erf","x-icon":"ico","x-jg":"art","x-jng":"jng","x-nikon-nef":"nef","x-olympus-orf":"orf","x-portable-anymap":"pnm","x-portable-bitmap":"pbm","x-portable-graymap":"pgm","x-portable-pixmap":"ppm","x-rgb":"rgb","x-xbitmap":"xbm","x-xpixmap":"xpm","x-xwindowdump":"xwd",bmp:"bmp",cgm:"cgm",g3fax:"g3",ktx:"ktx","prs.btif":"btif",sgi:"sgi","vnd.dece.graphic":["uvi","uvvi","uvg","uvvg"],"vnd.dwg":"dwg","vnd.dxf":"dxf","vnd.fastbidsheet":"fbs","vnd.fpx":"fpx","vnd.fst":"fst","vnd.fujixerox.edmics-mmr":"mmr","vnd.fujixerox.edmics-rlc":"rlc","vnd.ms-modi":"mdi","vnd.ms-photo":"wdp","vnd.net-fpx":"npx","vnd.xiff":"xif",webp:"webp","x-3ds":"3ds","x-cmx":"cmx","x-freehand":["fh","fhc","fh4","fh5","fh7"],"x-pict":["pic","pct"],"x-tga":"tga","cis-cod":"cod",avif:"avifs",heic:["heif","heic"],pjpeg:["pjpg"],"vnd.adobe.photoshop":"psd","x-adobe-dng":"dng","x-fuji-raf":"raf","x-icns":"icns","x-kodak-dcr":"dcr","x-kodak-k25":"k25","x-kodak-kdc":"kdc","x-minolta-mrw":"mrw","x-panasonic-raw":["raw","rw2","rwl"],"x-pentax-pef":["pef","ptx"],"x-sigma-x3f":"x3f","x-sony-arw":"arw","x-sony-sr2":"sr2","x-sony-srf":"srf"},message:{rfc822:["eml","mime","mht","mhtml","nws"]},model:{iges:["igs","iges"],mesh:["msh","mesh","silo"],vrml:["wrl","vrml"],"x3d+vrml":["x3dv","x3dvz"],"x3d+xml":"x3dz","x3d+binary":["x3db","x3dbz"],"vnd.collada+xml":"dae","vnd.dwf":"dwf","vnd.gdl":"gdl","vnd.gtw":"gtw","vnd.mts":"mts","vnd.usdz+zip":"usdz","vnd.vtu":"vtu"},text:{"cache-manifest":["manifest","appcache"],calendar:["ics","icz","ifb"],css:"css",csv:"csv",h323:"323",html:["html","htm","shtml","stm"],iuls:"uls",plain:["txt","text","brf","conf","def","list","log","in","bas","diff","ksh"],richtext:"rtx",scriptlet:["sct","wsc"],texmacs:"tm","tab-separated-values":"tsv","vnd.sun.j2me.app-descriptor":"jad","vnd.wap.wml":"wml","vnd.wap.wmlscript":"wmls","x-bibtex":"bib","x-boo":"boo","x-c++hdr":["h++","hpp","hxx","hh"],"x-c++src":["c++","cpp","cxx","cc"],"x-component":"htc","x-dsrc":"d","x-diff":"patch","x-haskell":"hs","x-java":"java","x-literate-haskell":"lhs","x-moc":"moc","x-pascal":["p","pas","pp","inc"],"x-pcs-gcd":"gcd","x-python":"py","x-scala":"scala","x-setext":"etx","x-tcl":["tcl","tk"],"x-tex":["tex","ltx","sty","cls"],"x-vcalendar":"vcs","x-vcard":"vcf",n3:"n3","prs.lines.tag":"dsc",sgml:["sgml","sgm"],troff:["t","tr","roff","man","me","ms"],turtle:"ttl","uri-list":["uri","uris","urls"],vcard:"vcard","vnd.curl":"curl","vnd.curl.dcurl":"dcurl","vnd.curl.scurl":"scurl","vnd.curl.mcurl":"mcurl","vnd.dvb.subtitle":"sub","vnd.fly":"fly","vnd.fmi.flexstor":"flx","vnd.graphviz":"gv","vnd.in3d.3dml":"3dml","vnd.in3d.spot":"spot","x-asm":["s","asm"],"x-c":["c","h","dic"],"x-fortran":["f","for","f77","f90"],"x-opml":"opml","x-nfo":"nfo","x-sfv":"sfv","x-uuencode":"uu",webviewhtml:"htt",javascript:"js",json:"json",markdown:["md","markdown","mdown","markdn"],"vnd.wap.si":"si","vnd.wap.sl":"sl"},video:{avif:"avif","3gpp":"3gp",annodex:"axv",dl:"dl",dv:["dif","dv"],fli:"fli",gl:"gl",mpeg:["mpeg","mpg","mpe","m1v","m2v","mp2","mpa","mpv2"],mp4:["mp4","mp4v","mpg4"],quicktime:["qt","mov"],ogg:"ogv","vnd.mpegurl":["mxu","m4u"],"x-flv":"flv","x-la-asf":["lsf","lsx"],"x-mng":"mng","x-ms-asf":["asf","asx","asr"],"x-ms-wm":"wm","x-ms-wmv":"wmv","x-ms-wmx":"wmx","x-ms-wvx":"wvx","x-msvideo":"avi","x-sgi-movie":"movie","x-matroska":["mpv","mkv","mk3d","mks"],"3gpp2":"3g2",h261:"h261",h263:"h263",h264:"h264",jpeg:"jpgv",jpm:["jpm","jpgm"],mj2:["mj2","mjp2"],"vnd.dece.hd":["uvh","uvvh"],"vnd.dece.mobile":["uvm","uvvm"],"vnd.dece.pd":["uvp","uvvp"],"vnd.dece.sd":["uvs","uvvs"],"vnd.dece.video":["uvv","uvvv"],"vnd.dvb.file":"dvb","vnd.fvt":"fvt","vnd.ms-playready.media.pyv":"pyv","vnd.uvvu.mp4":["uvu","uvvu"],"vnd.vivo":"viv",webm:"webm","x-f4v":"f4v","x-m4v":"m4v","x-ms-vob":"vob","x-smv":"smv",mp2t:"ts"},"x-conference":{"x-cooltalk":"ice"},"x-world":{"x-vrml":["vrm","flr","wrz","xaf","xof"]}};(()=>{const r={};for(const e of Object.keys(Hl))for(const t of Object.keys(Hl[e])){const n=Hl[e][t];if(typeof n=="string")r[n]=e+"/"+t;else for(let i=0;i<n.length;i++)r[n[i]]=e+"/"+t}return r})();const Mu=[];for(let r=0;r<256;r++){let e=r;for(let t=0;t<8;t++)e&1?e=e>>>1^3988292384:e=e>>>1;Mu[r]=e}class _h{constructor(e){this.crc=e||-1}append(e){let t=this.crc|0;for(let n=0,i=e.length|0;n<i;n++)t=t>>>8^Mu[(t^e[n])&255];this.crc=t}get(){return~this.crc}}class Tu extends TransformStream{constructor(){let e;const t=new _h;super({transform(n,i){t.append(n),i.enqueue(n)},flush(){const n=new Uint8Array(4);new DataView(n.buffer).setUint32(0,t.get()),e.value=n}}),e=this}}function mh(r){if(typeof TextEncoder>"u"){r=unescape(encodeURIComponent(r));const e=new Uint8Array(r.length);for(let t=0;t<e.length;t++)e[t]=r.charCodeAt(t);return e}else return new TextEncoder().encode(r)}const si={concat(r,e){if(r.length===0||e.length===0)return r.concat(e);const t=r[r.length-1],n=si.getPartial(t);return n===32?r.concat(e):si._shiftRight(e,n,t|0,r.slice(0,r.length-1))},bitLength(r){const e=r.length;if(e===0)return 0;const t=r[e-1];return(e-1)*32+si.getPartial(t)},clamp(r,e){if(r.length*32<e)return r;r=r.slice(0,Math.ceil(e/32));const t=r.length;return e=e&31,t>0&&e&&(r[t-1]=si.partial(e,r[t-1]&2147483648>>e-1,1)),r},partial(r,e,t){return r===32?e:(t?e|0:e<<32-r)+r*1099511627776},getPartial(r){return Math.round(r/1099511627776)||32},_shiftRight(r,e,t,n){for(n===void 0&&(n=[]);e>=32;e-=32)n.push(t),t=0;if(e===0)return n.concat(r);for(let h=0;h<r.length;h++)n.push(t|r[h]>>>e),t=r[h]<<32-e;const i=r.length?r[r.length-1]:0,s=si.getPartial(i);return n.push(si.partial(e+s&31,e+s>32?t:n.pop(),1)),n}},Wa={bytes:{fromBits(r){const t=si.bitLength(r)/8,n=new Uint8Array(t);let i;for(let s=0;s<t;s++)s&3||(i=r[s/4]),n[s]=i>>>24,i<<=8;return n},toBits(r){const e=[];let t,n=0;for(t=0;t<r.length;t++)n=n<<8|r[t],(t&3)===3&&(e.push(n),n=0);return t&3&&e.push(si.partial(8*(t&3),n)),e}}},Iu={};Iu.sha1=class{constructor(r){const e=this;e.blockSize=512,e._init=[1732584193,4023233417,2562383102,271733878,3285377520],e._key=[1518500249,1859775393,2400959708,3395469782],r?(e._h=r._h.slice(0),e._buffer=r._buffer.slice(0),e._length=r._length):e.reset()}reset(){const r=this;return r._h=r._init.slice(0),r._buffer=[],r._length=0,r}update(r){const e=this;typeof r=="string"&&(r=Wa.utf8String.toBits(r));const t=e._buffer=si.concat(e._buffer,r),n=e._length,i=e._length=n+si.bitLength(r);if(i>9007199254740991)throw new Error("Cannot hash more than 2^53 - 1 bits");const s=new Uint32Array(t);let h=0;for(let d=e.blockSize+n-(e.blockSize+n&e.blockSize-1);d<=i;d+=e.blockSize)e._block(s.subarray(16*h,16*(h+1))),h+=1;return t.splice(0,16*h),e}finalize(){const r=this;let e=r._buffer;const t=r._h;e=si.concat(e,[si.partial(1,1)]);for(let n=e.length+2;n&15;n++)e.push(0);for(e.push(Math.floor(r._length/4294967296)),e.push(r._length|0);e.length;)r._block(e.splice(0,16));return r.reset(),t}_f(r,e,t,n){if(r<=19)return e&t|~e&n;if(r<=39)return e^t^n;if(r<=59)return e&t|e&n|t&n;if(r<=79)return e^t^n}_S(r,e){return e<<r|e>>>32-r}_block(r){const e=this,t=e._h,n=Array(80);for(let _=0;_<16;_++)n[_]=r[_];let i=t[0],s=t[1],h=t[2],d=t[3],c=t[4];for(let _=0;_<=79;_++){_>=16&&(n[_]=e._S(1,n[_-3]^n[_-8]^n[_-14]^n[_-16]));const m=e._S(5,i)+e._f(_,s,h,d)+c+n[_]+e._key[Math.floor(_/20)]|0;c=d,d=h,h=e._S(30,s),s=i,i=m}t[0]=t[0]+i|0,t[1]=t[1]+s|0,t[2]=t[2]+h|0,t[3]=t[3]+d|0,t[4]=t[4]+c|0}};const Au={};Au.aes=class{constructor(r){const e=this;e._tables=[[[],[],[],[],[]],[[],[],[],[],[]]],e._tables[0][0][0]||e._precompute();const t=e._tables[0][4],n=e._tables[1],i=r.length;let s,h,d,c=1;if(i!==4&&i!==6&&i!==8)throw new Error("invalid aes key size");for(e._key=[h=r.slice(0),d=[]],s=i;s<4*i+28;s++){let _=h[s-1];(s%i===0||i===8&&s%i===4)&&(_=t[_>>>24]<<24^t[_>>16&255]<<16^t[_>>8&255]<<8^t[_&255],s%i===0&&(_=_<<8^_>>>24^c<<24,c=c<<1^(c>>7)*283)),h[s]=h[s-i]^_}for(let _=0;s;_++,s--){const m=h[_&3?s:s-4];s<=4||_<4?d[_]=m:d[_]=n[0][t[m>>>24]]^n[1][t[m>>16&255]]^n[2][t[m>>8&255]]^n[3][t[m&255]]}}encrypt(r){return this._crypt(r,0)}decrypt(r){return this._crypt(r,1)}_precompute(){const r=this._tables[0],e=this._tables[1],t=r[4],n=e[4],i=[],s=[];let h,d,c,_;for(let m=0;m<256;m++)s[(i[m]=m<<1^(m>>7)*283)^m]=m;for(let m=h=0;!t[m];m^=d||1,h=s[h]||1){let g=h^h<<1^h<<2^h<<3^h<<4;g=g>>8^g&255^99,t[m]=g,n[g]=m,_=i[c=i[d=i[m]]];let S=_*16843009^c*65537^d*257^m*16843008,E=i[g]*257^g*16843008;for(let A=0;A<4;A++)r[A][m]=E=E<<24^E>>>8,e[A][g]=S=S<<24^S>>>8}for(let m=0;m<5;m++)r[m]=r[m].slice(0),e[m]=e[m].slice(0)}_crypt(r,e){if(r.length!==4)throw new Error("invalid aes block size");const t=this._key[e],n=t.length/4-2,i=[0,0,0,0],s=this._tables[e],h=s[0],d=s[1],c=s[2],_=s[3],m=s[4];let g=r[0]^t[0],S=r[e?3:1]^t[1],E=r[2]^t[2],A=r[e?1:3]^t[3],C=4,k,T,b;for(let R=0;R<n;R++)k=h[g>>>24]^d[S>>16&255]^c[E>>8&255]^_[A&255]^t[C],T=h[S>>>24]^d[E>>16&255]^c[A>>8&255]^_[g&255]^t[C+1],b=h[E>>>24]^d[A>>16&255]^c[g>>8&255]^_[S&255]^t[C+2],A=h[A>>>24]^d[g>>16&255]^c[S>>8&255]^_[E&255]^t[C+3],C+=4,g=k,S=T,E=b;for(let R=0;R<4;R++)i[e?3&-R:R]=m[g>>>24]<<24^m[S>>16&255]<<16^m[E>>8&255]<<8^m[A&255]^t[C++],k=g,g=S,S=E,E=A,A=k;return i}};const X1={getRandomValues(r){const e=new Uint32Array(r.buffer),t=n=>{let i=987654321;const s=4294967295;return function(){return i=36969*(i&65535)+(i>>16)&s,n=18e3*(n&65535)+(n>>16)&s,(((i<<16)+n&s)/4294967296+.5)*(Math.random()>.5?1:-1)}};for(let n=0,i;n<r.length;n+=4){const s=t((i||Math.random())*4294967296);i=s()*987654071,e[n/4]=s()*4294967296|0}return r}},Ru={};Ru.ctrGladman=class{constructor(r,e){this._prf=r,this._initIv=e,this._iv=e}reset(){this._iv=this._initIv}update(r){return this.calculate(this._prf,r,this._iv)}incWord(r){if((r>>24&255)===255){let e=r>>16&255,t=r>>8&255,n=r&255;e===255?(e=0,t===255?(t=0,n===255?n=0:++n):++t):++e,r=0,r+=e<<16,r+=t<<8,r+=n}else r+=1<<24;return r}incCounter(r){(r[0]=this.incWord(r[0]))===0&&(r[1]=this.incWord(r[1]))}calculate(r,e,t){let n;if(!(n=e.length))return[];const i=si.bitLength(e);for(let s=0;s<n;s+=4){this.incCounter(t);const h=r.encrypt(t);e[s]^=h[0],e[s+1]^=h[1],e[s+2]^=h[2],e[s+3]^=h[3]}return si.clamp(e,i)}};const Wr={importKey(r){return new Wr.hmacSha1(Wa.bytes.toBits(r))},pbkdf2(r,e,t,n){if(t=t||1e4,n<0||t<0)throw new Error("invalid params to pbkdf2");const i=(n>>5)+1<<2;let s,h,d,c,_;const m=new ArrayBuffer(i),g=new DataView(m);let S=0;const E=si;for(e=Wa.bytes.toBits(e),_=1;S<(i||1);_++){for(s=h=r.encrypt(E.concat(e,[_])),d=1;d<t;d++)for(h=r.encrypt(h),c=0;c<h.length;c++)s[c]^=h[c];for(d=0;S<(i||1)&&d<s.length;d++)g.setInt32(S,s[d]),S+=4}return m.slice(0,n/8)}};Wr.hmacSha1=class{constructor(r){const e=this,t=e._hash=Iu.sha1,n=[[],[]];e._baseHash=[new t,new t];const i=e._baseHash[0].blockSize/32;r.length>i&&(r=new t().update(r).finalize());for(let s=0;s<i;s++)n[0][s]=r[s]^909522486,n[1][s]=r[s]^1549556828;e._baseHash[0].update(n[0]),e._baseHash[1].update(n[1]),e._resultHash=new t(e._baseHash[0])}reset(){const r=this;r._resultHash=new r._hash(r._baseHash[0]),r._updated=!1}update(r){const e=this;e._updated=!0,e._resultHash.update(r)}digest(){const r=this,e=r._resultHash.finalize(),t=new r._hash(r._baseHash[1]).update(e).finalize();return r.reset(),t}encrypt(r){if(this._updated)throw new Error("encrypt on already updated hmac called!");return this.update(r),this.digest(r)}};const $1=typeof crypto<"u"&&typeof crypto.getRandomValues=="function",Lu="Invalid password",Nu="Invalid signature",Du="zipjs-abort-check-password";function Fu(r){return $1?crypto.getRandomValues(r):X1.getRandomValues(r)}const oo=16,Y1="raw",Ou={name:"PBKDF2"},j1={name:"HMAC"},K1="SHA-1",G1=Object.assign({hash:j1},Ou),gh=Object.assign({iterations:1e3,hash:{name:K1}},Ou),Z1=["deriveBits"],qo=[8,12,16],Mo=[16,24,32],ar=10,Q1=[0,0,0,0],Hu="undefined",Vu="function",Za=typeof crypto!=Hu,jo=Za&&crypto.subtle,Wu=Za&&typeof jo!=Hu,Rs=Wa.bytes,J1=Au.aes,em=Ru.ctrGladman,tm=Wr.hmacSha1;let fd=Za&&Wu&&typeof jo.importKey==Vu,pd=Za&&Wu&&typeof jo.deriveBits==Vu;class nm extends TransformStream{constructor({password:e,signed:t,encryptionStrength:n,checkPasswordOnly:i}){super({start(){Object.assign(this,{ready:new Promise(s=>this.resolveReady=s),password:e,signed:t,strength:n-1,pending:new Uint8Array})},async transform(s,h){const d=this,{password:c,strength:_,resolveReady:m,ready:g}=d;c?(await sm(d,_,c,is(s,0,qo[_]+2)),s=is(s,qo[_]+2),i?h.error(new Error(Du)):m()):await g;const S=new Uint8Array(s.length-ar-(s.length-ar)%oo);h.enqueue(qu(d,s,S,0,ar,!0))},async flush(s){const{signed:h,ctr:d,hmac:c,pending:_,ready:m}=this;if(c&&d){await m;const g=is(_,0,_.length-ar),S=is(_,_.length-ar);let E=new Uint8Array;if(g.length){const A=zo(Rs,g);c.update(A);const C=d.update(A);E=Uo(Rs,C)}if(h){const A=is(Uo(Rs,c.digest()),0,ar);for(let C=0;C<ar;C++)if(A[C]!=S[C])throw new Error(Nu)}s.enqueue(E)}}})}}class im extends TransformStream{constructor({password:e,encryptionStrength:t}){let n;super({start(){Object.assign(this,{ready:new Promise(i=>this.resolveReady=i),password:e,strength:t-1,pending:new Uint8Array})},async transform(i,s){const h=this,{password:d,strength:c,resolveReady:_,ready:m}=h;let g=new Uint8Array;d?(g=await rm(h,c,d),_()):await m;const S=new Uint8Array(g.length+i.length-i.length%oo);S.set(g,0),s.enqueue(qu(h,i,S,g.length,0))},async flush(i){const{ctr:s,hmac:h,pending:d,ready:c}=this;if(h&&s){await c;let _=new Uint8Array;if(d.length){const m=s.update(zo(Rs,d));h.update(m),_=Uo(Rs,m)}n.signature=Uo(Rs,h.digest()).slice(0,ar),i.enqueue(Th(_,n.signature))}}}),n=this}}function qu(r,e,t,n,i,s){const{ctr:h,hmac:d,pending:c}=r,_=e.length-i;c.length&&(e=Th(c,e),t=lm(t,_-_%oo));let m;for(m=0;m<=_-oo;m+=oo){const g=zo(Rs,is(e,m,m+oo));s&&d.update(g);const S=h.update(g);s||d.update(S),t.set(Uo(Rs,S),m+n)}return r.pending=is(e,m),t}async function sm(r,e,t,n){const i=await Uu(r,e,t,is(n,0,qo[e])),s=is(n,qo[e]);if(i[0]!=s[0]||i[1]!=s[1])throw new Error(Lu)}async function rm(r,e,t){const n=Fu(new Uint8Array(qo[e])),i=await Uu(r,e,t,n);return Th(n,i)}async function Uu(r,e,t,n){r.password=null;const i=mh(t),s=await om(Y1,i,G1,!1,Z1),h=await am(Object.assign({salt:n},gh),s,8*(Mo[e]*2+2)),d=new Uint8Array(h),c=zo(Rs,is(d,0,Mo[e])),_=zo(Rs,is(d,Mo[e],Mo[e]*2)),m=is(d,Mo[e]*2);return Object.assign(r,{keys:{key:c,authentication:_,passwordVerification:m},ctr:new em(new J1(c),Array.from(Q1)),hmac:new tm(_)}),m}async function om(r,e,t,n,i){if(fd)try{return await jo.importKey(r,e,t,n,i)}catch{return fd=!1,Wr.importKey(e)}else return Wr.importKey(e)}async function am(r,e,t){if(pd)try{return await jo.deriveBits(r,e,t)}catch{return pd=!1,Wr.pbkdf2(e,r.salt,gh.iterations,t)}else return Wr.pbkdf2(e,r.salt,gh.iterations,t)}function Th(r,e){let t=r;return r.length+e.length&&(t=new Uint8Array(r.length+e.length),t.set(r,0),t.set(e,r.length)),t}function lm(r,e){if(e&&e>r.length){const t=r;r=new Uint8Array(e),r.set(t,0)}return r}function is(r,e,t){return r.subarray(e,t)}function Uo(r,e){return r.fromBits(e)}function zo(r,e){return r.toBits(e)}const ho=12;class hm extends TransformStream{constructor({password:e,passwordVerification:t,checkPasswordOnly:n}){super({start(){Object.assign(this,{password:e,passwordVerification:t}),zu(this,e)},transform(i,s){const h=this;if(h.password){const d=_d(h,i.subarray(0,ho));if(h.password=null,d[ho-1]!=h.passwordVerification)throw new Error(Lu);i=i.subarray(ho)}n?s.error(new Error(Du)):s.enqueue(_d(h,i))}})}}class cm extends TransformStream{constructor({password:e,passwordVerification:t}){super({start(){Object.assign(this,{password:e,passwordVerification:t}),zu(this,e)},transform(n,i){const s=this;let h,d;if(s.password){s.password=null;const c=Fu(new Uint8Array(ho));c[ho-1]=s.passwordVerification,h=new Uint8Array(n.length+c.length),h.set(md(s,c),0),d=ho}else h=new Uint8Array(n.length),d=0;h.set(md(s,n),d),i.enqueue(h)}})}}function _d(r,e){const t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=Xu(r)^e[n],Ih(r,t[n]);return t}function md(r,e){const t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=Xu(r)^e[n],Ih(r,e[n]);return t}function zu(r,e){const t=[305419896,591751049,878082192];Object.assign(r,{keys:t,crcKey0:new _h(t[0]),crcKey2:new _h(t[2])});for(let n=0;n<e.length;n++)Ih(r,e.charCodeAt(n))}function Ih(r,e){let[t,n,i]=r.keys;r.crcKey0.append([e]),t=~r.crcKey0.get(),n=gd(Math.imul(gd(n+$u(t)),134775813)+1),r.crcKey2.append([n>>>24]),i=~r.crcKey2.get(),r.keys=[t,n,i]}function Xu(r){const e=r.keys[2]|2;return $u(Math.imul(e,e^1)>>>8)}function $u(r){return r&255}function gd(r){return r&4294967295}const vd="deflate-raw";class dm extends TransformStream{constructor(e,{chunkSize:t,CompressionStream:n,CompressionStreamNative:i}){super({});const{compressed:s,encrypted:h,useCompressionStream:d,zipCrypto:c,signed:_,level:m}=e,g=this;let S,E,A=Yu(super.readable);(!h||c)&&_&&(S=new Tu,A=Ls(A,S)),s&&(A=Ku(A,d,{level:m,chunkSize:t},i,n)),h&&(c?A=Ls(A,new cm(e)):(E=new im(e),A=Ls(A,E))),ju(g,A,()=>{let C;h&&!c&&(C=E.signature),(!h||c)&&_&&(C=new DataView(S.value.buffer).getUint32(0)),g.signature=C})}}class um extends TransformStream{constructor(e,{chunkSize:t,DecompressionStream:n,DecompressionStreamNative:i}){super({});const{zipCrypto:s,encrypted:h,signed:d,signature:c,compressed:_,useCompressionStream:m}=e;let g,S,E=Yu(super.readable);h&&(s?E=Ls(E,new hm(e)):(S=new nm(e),E=Ls(E,S))),_&&(E=Ku(E,m,{chunkSize:t},i,n)),(!h||s)&&d&&(g=new Tu,E=Ls(E,g)),ju(this,E,()=>{if((!h||s)&&d){const A=new DataView(g.value.buffer);if(c!=A.getUint32(0,!1))throw new Error(Nu)}})}}function Yu(r){return Ls(r,new TransformStream({transform(e,t){e&&e.length&&t.enqueue(e)}}))}function ju(r,e,t){e=Ls(e,new TransformStream({flush:t})),Object.defineProperty(r,"readable",{get(){return e}})}function Ku(r,e,t,n,i){try{const s=e&&n?n:i;r=Ls(r,new s(vd,t))}catch(s){if(e)r=Ls(r,new i(vd,t));else throw s}return r}function Ls(r,e){return r.pipeThrough(e)}const fm="message",pm="start",_m="pull",bd="data",mm="ack",gm="close",Gu="deflate",vm="inflate";class bm extends TransformStream{constructor(e,t){super({});const n=this,{codecType:i}=e;let s;i.startsWith(Gu)?s=dm:i.startsWith(vm)&&(s=um);let h=0;const d=new s(e,t),c=super.readable,_=new TransformStream({transform(m,g){m&&m.length&&(h+=m.length,g.enqueue(m))},flush(){const{signature:m}=d;Object.assign(n,{signature:m,size:h})}});Object.defineProperty(n,"readable",{get(){return c.pipeThrough(d).pipeThrough(_)}})}}const ym=typeof Worker!=Va;class Vl{constructor(e,{readable:t,writable:n},{options:i,config:s,streamOptions:h,useWebWorkers:d,transferStreams:c,scripts:_},m){const{signal:g}=h;return Object.assign(e,{busy:!0,readable:t.pipeThrough(new wm(t,h,s),{signal:g}),writable:n,options:Object.assign({},i),scripts:_,transferStreams:c,terminate(){const{worker:S,busy:E}=e;S&&!E&&(S.terminate(),e.interface=null)},onTaskFinished(){e.busy=!1,m(e)}}),(d&&ym?Sm:xm)(e,s)}}class wm extends TransformStream{constructor(e,{onstart:t,onprogress:n,size:i,onend:s},{chunkSize:h}){let d=0;super({start(){t&&Wl(t,i)},async transform(c,_){d+=c.length,n&&await Wl(n,d,i),_.enqueue(c)},flush(){e.size=d,s&&Wl(s,d)}},{highWaterMark:1,size:()=>h})}}async function Wl(r,...e){try{await r(...e)}catch{}}function xm(r,e){return{run:()=>Cm(r,e)}}function Sm(r,{baseURL:e,chunkSize:t}){return r.interface||Object.assign(r,{worker:Em(r.scripts[0],e,r),interface:{run:()=>km(r,{chunkSize:t})}}),r.interface}async function Cm({options:r,readable:e,writable:t,onTaskFinished:n},i){const s=new bm(r,i);try{await e.pipeThrough(s).pipeTo(t,{preventClose:!0,preventAbort:!0});const{signature:h,size:d}=s;return{signature:h,size:d}}finally{n()}}async function km(r,e){let t,n;const i=new Promise((S,E)=>{t=S,n=E});Object.assign(r,{reader:null,writer:null,resolveResult:t,rejectResult:n,result:i});const{readable:s,options:h,scripts:d}=r,{writable:c,closed:_}=Pm(r.writable);vh({type:pm,scripts:d.slice(1),options:h,config:e,readable:s,writable:c},r)||Object.assign(r,{reader:s.getReader(),writer:c.getWriter()});const g=await i;try{await c.getWriter().close()}catch{}return await _,g}function Pm(r){const e=r.getWriter();let t;const n=new Promise(s=>t=s);return{writable:new WritableStream({async write(s){await e.ready,await e.write(s)},close(){e.releaseLock(),t()},abort(s){return e.abort(s)}}),closed:n}}let yd=!0,wd=!0;function Em(r,e,t){const n={type:"module"};let i,s;typeof r==Eu&&(r=r());try{i=new URL(r,e)}catch{i=r}if(yd)try{s=new Worker(i)}catch{yd=!1,s=new Worker(i,n)}else s=new Worker(i,n);return s.addEventListener(fm,h=>Bm(h,t)),s}function vh(r,{worker:e,writer:t,onTaskFinished:n,transferStreams:i}){try{let{value:s,readable:h,writable:d}=r;const c=[];if(s&&(s.byteLength<s.buffer.byteLength?r.value=s.buffer.slice(0,s.byteLength):r.value=s.buffer,c.push(r.value)),i&&wd?(h&&c.push(h),d&&c.push(d)):r.readable=r.writable=null,c.length)try{return e.postMessage(r,c),!0}catch{wd=!1,r.readable=r.writable=null,e.postMessage(r)}else e.postMessage(r)}catch(s){throw t&&t.releaseLock(),n(),s}}async function Bm({data:r},e){const{type:t,value:n,messageId:i,result:s,error:h}=r,{reader:d,writer:c,resolveResult:_,rejectResult:m,onTaskFinished:g}=e;try{if(h){const{message:E,stack:A,code:C,name:k}=h,T=new Error(E);Object.assign(T,{stack:A,code:C,name:k}),S(T)}else{if(t==_m){const{value:E,done:A}=await d.read();vh({type:bd,value:E,done:A,messageId:i},e)}t==bd&&(await c.ready,await c.write(new Uint8Array(n)),vh({type:mm,messageId:i},e)),t==gm&&S(null,s)}}catch(E){S(E)}function S(E,A){E?m(E):_(A),c&&c.releaseLock(),g()}}let Pr=[];const ql=[];let xd=0;async function Mm(r,e){const{options:t,config:n}=e,{transferStreams:i,useWebWorkers:s,useCompressionStream:h,codecType:d,compressed:c,signed:_,encrypted:m}=t,{workerScripts:g,maxWorkers:S,terminateWorkerTimeout:E}=n;e.transferStreams=i||i===ri;const A=!c&&!_&&!m&&!e.transferStreams;e.useWebWorkers=!A&&(s||s===ri&&n.useWebWorkers),e.scripts=e.useWebWorkers&&g?g[d]:[],t.useCompressionStream=h||h===ri&&n.useCompressionStream;let C;const k=Pr.find(b=>!b.busy);if(k)Sd(k),C=new Vl(k,r,e,T);else if(Pr.length<S){const b={indexWorker:xd};xd++,Pr.push(b),C=new Vl(b,r,e,T)}else C=await new Promise(b=>ql.push({resolve:b,stream:r,workerOptions:e}));return C.run();function T(b){if(ql.length){const[{resolve:R,stream:V,workerOptions:f}]=ql.splice(0,1);R(new Vl(b,V,f,T))}else b.worker?(Sd(b),Number.isFinite(E)&&E>=0&&(b.terminateTimeout=setTimeout(()=>{Pr=Pr.filter(R=>R!=b),b.terminate()},E))):Pr=Pr.filter(R=>R!=b)}}function Sd(r){const{terminateTimeout:e}=r;e&&(clearTimeout(e),r.terminateTimeout=null)}function Tm(r){const e=()=>URL.createObjectURL(new Blob([`const{Array:e,Object:t,Number:n,Math:r,Error:s,Uint8Array:i,Uint16Array:o,Uint32Array:c,Int32Array:f,Map:a,DataView:l,Promise:u,TextEncoder:w,crypto:h,postMessage:d,TransformStream:p,ReadableStream:y,WritableStream:m,CompressionStream:b,DecompressionStream:g}=self;class k{constructor(e){return class extends p{constructor(t,n){const r=new e(n);super({transform(e,t){t.enqueue(r.append(e))},flush(e){const t=r.flush();t&&e.enqueue(t)}})}}}}const v=[];for(let e=0;256>e;e++){let t=e;for(let e=0;8>e;e++)1&t?t=t>>>1^3988292384:t>>>=1;v[e]=t}class S{constructor(e){this.t=e||-1}append(e){let t=0|this.t;for(let n=0,r=0|e.length;r>n;n++)t=t>>>8^v[255&(t^e[n])];this.t=t}get(){return~this.t}}class z extends p{constructor(){let e;const t=new S;super({transform(e,n){t.append(e),n.enqueue(e)},flush(){const n=new i(4);new l(n.buffer).setUint32(0,t.get()),e.value=n}}),e=this}}const C={concat(e,t){if(0===e.length||0===t.length)return e.concat(t);const n=e[e.length-1],r=C.i(n);return 32===r?e.concat(t):C.o(t,r,0|n,e.slice(0,e.length-1))},l(e){const t=e.length;if(0===t)return 0;const n=e[t-1];return 32*(t-1)+C.i(n)},u(e,t){if(32*e.length<t)return e;const n=(e=e.slice(0,r.ceil(t/32))).length;return t&=31,n>0&&t&&(e[n-1]=C.h(t,e[n-1]&2147483648>>t-1,1)),e},h:(e,t,n)=>32===e?t:(n?0|t:t<<32-e)+1099511627776*e,i:e=>r.round(e/1099511627776)||32,o(e,t,n,r){for(void 0===r&&(r=[]);t>=32;t-=32)r.push(n),n=0;if(0===t)return r.concat(e);for(let s=0;s<e.length;s++)r.push(n|e[s]>>>t),n=e[s]<<32-t;const s=e.length?e[e.length-1]:0,i=C.i(s);return r.push(C.h(t+i&31,t+i>32?n:r.pop(),1)),r}},x={p:{m(e){const t=C.l(e)/8,n=new i(t);let r;for(let s=0;t>s;s++)0==(3&s)&&(r=e[s/4]),n[s]=r>>>24,r<<=8;return n},g(e){const t=[];let n,r=0;for(n=0;n<e.length;n++)r=r<<8|e[n],3==(3&n)&&(t.push(r),r=0);return 3&n&&t.push(C.h(8*(3&n),r)),t}}},_=class{constructor(e){const t=this;t.blockSize=512,t.k=[1732584193,4023233417,2562383102,271733878,3285377520],t.v=[1518500249,1859775393,2400959708,3395469782],e?(t.S=e.S.slice(0),t.C=e.C.slice(0),t._=e._):t.reset()}reset(){const e=this;return e.S=e.k.slice(0),e.C=[],e._=0,e}update(e){const t=this;"string"==typeof e&&(e=x.A.g(e));const n=t.C=C.concat(t.C,e),r=t._,i=t._=r+C.l(e);if(i>9007199254740991)throw new s("Cannot hash more than 2^53 - 1 bits");const o=new c(n);let f=0;for(let e=t.blockSize+r-(t.blockSize+r&t.blockSize-1);i>=e;e+=t.blockSize)t.I(o.subarray(16*f,16*(f+1))),f+=1;return n.splice(0,16*f),t}D(){const e=this;let t=e.C;const n=e.S;t=C.concat(t,[C.h(1,1)]);for(let e=t.length+2;15&e;e++)t.push(0);for(t.push(r.floor(e._/4294967296)),t.push(0|e._);t.length;)e.I(t.splice(0,16));return e.reset(),n}V(e,t,n,r){return e>19?e>39?e>59?e>79?void 0:t^n^r:t&n|t&r|n&r:t^n^r:t&n|~t&r}P(e,t){return t<<e|t>>>32-e}I(t){const n=this,s=n.S,i=e(80);for(let e=0;16>e;e++)i[e]=t[e];let o=s[0],c=s[1],f=s[2],a=s[3],l=s[4];for(let e=0;79>=e;e++){16>e||(i[e]=n.P(1,i[e-3]^i[e-8]^i[e-14]^i[e-16]));const t=n.P(5,o)+n.V(e,c,f,a)+l+i[e]+n.v[r.floor(e/20)]|0;l=a,a=f,f=n.P(30,c),c=o,o=t}s[0]=s[0]+o|0,s[1]=s[1]+c|0,s[2]=s[2]+f|0,s[3]=s[3]+a|0,s[4]=s[4]+l|0}},A={getRandomValues(e){const t=new c(e.buffer),n=e=>{let t=987654321;const n=4294967295;return()=>(t=36969*(65535&t)+(t>>16)&n,(((t<<16)+(e=18e3*(65535&e)+(e>>16)&n)&n)/4294967296+.5)*(r.random()>.5?1:-1))};for(let s,i=0;i<e.length;i+=4){const e=n(4294967296*(s||r.random()));s=987654071*e(),t[i/4]=4294967296*e()|0}return e}},I={importKey:e=>new I.R(x.p.g(e)),B(e,t,n,r){if(n=n||1e4,0>r||0>n)throw new s("invalid params to pbkdf2");const i=1+(r>>5)<<2;let o,c,f,a,u;const w=new ArrayBuffer(i),h=new l(w);let d=0;const p=C;for(t=x.p.g(t),u=1;(i||1)>d;u++){for(o=c=e.encrypt(p.concat(t,[u])),f=1;n>f;f++)for(c=e.encrypt(c),a=0;a<c.length;a++)o[a]^=c[a];for(f=0;(i||1)>d&&f<o.length;f++)h.setInt32(d,o[f]),d+=4}return w.slice(0,r/8)},R:class{constructor(e){const t=this,n=t.M=_,r=[[],[]];t.U=[new n,new n];const s=t.U[0].blockSize/32;e.length>s&&(e=(new n).update(e).D());for(let t=0;s>t;t++)r[0][t]=909522486^e[t],r[1][t]=1549556828^e[t];t.U[0].update(r[0]),t.U[1].update(r[1]),t.K=new n(t.U[0])}reset(){const e=this;e.K=new e.M(e.U[0]),e.N=!1}update(e){this.N=!0,this.K.update(e)}digest(){const e=this,t=e.K.D(),n=new e.M(e.U[1]).update(t).D();return e.reset(),n}encrypt(e){if(this.N)throw new s("encrypt on already updated hmac called!");return this.update(e),this.digest(e)}}},D=void 0!==h&&"function"==typeof h.getRandomValues,V="Invalid password",P="Invalid signature",R="zipjs-abort-check-password";function B(e){return D?h.getRandomValues(e):A.getRandomValues(e)}const E=16,M={name:"PBKDF2"},U=t.assign({hash:{name:"HMAC"}},M),K=t.assign({iterations:1e3,hash:{name:"SHA-1"}},M),N=["deriveBits"],O=[8,12,16],T=[16,24,32],W=10,j=[0,0,0,0],H="undefined",L="function",F=typeof h!=H,q=F&&h.subtle,G=F&&typeof q!=H,J=x.p,Q=class{constructor(e){const t=this;t.O=[[[],[],[],[],[]],[[],[],[],[],[]]],t.O[0][0][0]||t.T();const n=t.O[0][4],r=t.O[1],i=e.length;let o,c,f,a=1;if(4!==i&&6!==i&&8!==i)throw new s("invalid aes key size");for(t.v=[c=e.slice(0),f=[]],o=i;4*i+28>o;o++){let e=c[o-1];(o%i==0||8===i&&o%i==4)&&(e=n[e>>>24]<<24^n[e>>16&255]<<16^n[e>>8&255]<<8^n[255&e],o%i==0&&(e=e<<8^e>>>24^a<<24,a=a<<1^283*(a>>7))),c[o]=c[o-i]^e}for(let e=0;o;e++,o--){const t=c[3&e?o:o-4];f[e]=4>=o||4>e?t:r[0][n[t>>>24]]^r[1][n[t>>16&255]]^r[2][n[t>>8&255]]^r[3][n[255&t]]}}encrypt(e){return this.W(e,0)}decrypt(e){return this.W(e,1)}T(){const e=this.O[0],t=this.O[1],n=e[4],r=t[4],s=[],i=[];let o,c,f,a;for(let e=0;256>e;e++)i[(s[e]=e<<1^283*(e>>7))^e]=e;for(let l=o=0;!n[l];l^=c||1,o=i[o]||1){let i=o^o<<1^o<<2^o<<3^o<<4;i=i>>8^255&i^99,n[l]=i,r[i]=l,a=s[f=s[c=s[l]]];let u=16843009*a^65537*f^257*c^16843008*l,w=257*s[i]^16843008*i;for(let n=0;4>n;n++)e[n][l]=w=w<<24^w>>>8,t[n][i]=u=u<<24^u>>>8}for(let n=0;5>n;n++)e[n]=e[n].slice(0),t[n]=t[n].slice(0)}W(e,t){if(4!==e.length)throw new s("invalid aes block size");const n=this.v[t],r=n.length/4-2,i=[0,0,0,0],o=this.O[t],c=o[0],f=o[1],a=o[2],l=o[3],u=o[4];let w,h,d,p=e[0]^n[0],y=e[t?3:1]^n[1],m=e[2]^n[2],b=e[t?1:3]^n[3],g=4;for(let e=0;r>e;e++)w=c[p>>>24]^f[y>>16&255]^a[m>>8&255]^l[255&b]^n[g],h=c[y>>>24]^f[m>>16&255]^a[b>>8&255]^l[255&p]^n[g+1],d=c[m>>>24]^f[b>>16&255]^a[p>>8&255]^l[255&y]^n[g+2],b=c[b>>>24]^f[p>>16&255]^a[y>>8&255]^l[255&m]^n[g+3],g+=4,p=w,y=h,m=d;for(let e=0;4>e;e++)i[t?3&-e:e]=u[p>>>24]<<24^u[y>>16&255]<<16^u[m>>8&255]<<8^u[255&b]^n[g++],w=p,p=y,y=m,m=b,b=w;return i}},X=class{constructor(e,t){this.j=e,this.H=t,this.L=t}reset(){this.L=this.H}update(e){return this.F(this.j,e,this.L)}q(e){if(255==(e>>24&255)){let t=e>>16&255,n=e>>8&255,r=255&e;255===t?(t=0,255===n?(n=0,255===r?r=0:++r):++n):++t,e=0,e+=t<<16,e+=n<<8,e+=r}else e+=1<<24;return e}G(e){0===(e[0]=this.q(e[0]))&&(e[1]=this.q(e[1]))}F(e,t,n){let r;if(!(r=t.length))return[];const s=C.l(t);for(let s=0;r>s;s+=4){this.G(n);const r=e.encrypt(n);t[s]^=r[0],t[s+1]^=r[1],t[s+2]^=r[2],t[s+3]^=r[3]}return C.u(t,s)}},Y=I.R;let Z=F&&G&&typeof q.importKey==L,$=F&&G&&typeof q.deriveBits==L;class ee extends p{constructor({password:e,signed:n,encryptionStrength:r,checkPasswordOnly:o}){super({start(){t.assign(this,{ready:new u((e=>this.J=e)),password:e,signed:n,X:r-1,pending:new i})},async transform(e,t){const n=this,{password:r,X:c,J:f,ready:a}=n;r?(await(async(e,t,n,r)=>{const i=await re(e,t,n,ie(r,0,O[t])),o=ie(r,O[t]);if(i[0]!=o[0]||i[1]!=o[1])throw new s(V)})(n,c,r,ie(e,0,O[c]+2)),e=ie(e,O[c]+2),o?t.error(new s(R)):f()):await a;const l=new i(e.length-W-(e.length-W)%E);t.enqueue(ne(n,e,l,0,W,!0))},async flush(e){const{signed:t,Y:n,Z:r,pending:o,ready:c}=this;if(r&&n){await c;const f=ie(o,0,o.length-W),a=ie(o,o.length-W);let l=new i;if(f.length){const e=ce(J,f);r.update(e);const t=n.update(e);l=oe(J,t)}if(t){const e=ie(oe(J,r.digest()),0,W);for(let t=0;W>t;t++)if(e[t]!=a[t])throw new s(P)}e.enqueue(l)}}})}}class te extends p{constructor({password:e,encryptionStrength:n}){let r;super({start(){t.assign(this,{ready:new u((e=>this.J=e)),password:e,X:n-1,pending:new i})},async transform(e,t){const n=this,{password:r,X:s,J:o,ready:c}=n;let f=new i;r?(f=await(async(e,t,n)=>{const r=B(new i(O[t]));return se(r,await re(e,t,n,r))})(n,s,r),o()):await c;const a=new i(f.length+e.length-e.length%E);a.set(f,0),t.enqueue(ne(n,e,a,f.length,0))},async flush(e){const{Y:t,Z:n,pending:s,ready:o}=this;if(n&&t){await o;let c=new i;if(s.length){const e=t.update(ce(J,s));n.update(e),c=oe(J,e)}r.signature=oe(J,n.digest()).slice(0,W),e.enqueue(se(c,r.signature))}}}),r=this}}function ne(e,t,n,r,s,o){const{Y:c,Z:f,pending:a}=e,l=t.length-s;let u;for(a.length&&(t=se(a,t),n=((e,t)=>{if(t&&t>e.length){const n=e;(e=new i(t)).set(n,0)}return e})(n,l-l%E)),u=0;l-E>=u;u+=E){const e=ce(J,ie(t,u,u+E));o&&f.update(e);const s=c.update(e);o||f.update(s),n.set(oe(J,s),u+r)}return e.pending=ie(t,u),n}async function re(n,r,s,o){n.password=null;const c=(e=>{if(void 0===w){const t=new i((e=unescape(encodeURIComponent(e))).length);for(let n=0;n<t.length;n++)t[n]=e.charCodeAt(n);return t}return(new w).encode(e)})(s),f=await(async(e,t,n,r,s)=>{if(!Z)return I.importKey(t);try{return await q.importKey("raw",t,n,!1,s)}catch(e){return Z=!1,I.importKey(t)}})(0,c,U,0,N),a=await(async(e,t,n)=>{if(!$)return I.B(t,e.salt,K.iterations,n);try{return await q.deriveBits(e,t,n)}catch(r){return $=!1,I.B(t,e.salt,K.iterations,n)}})(t.assign({salt:o},K),f,8*(2*T[r]+2)),l=new i(a),u=ce(J,ie(l,0,T[r])),h=ce(J,ie(l,T[r],2*T[r])),d=ie(l,2*T[r]);return t.assign(n,{keys:{key:u,$:h,passwordVerification:d},Y:new X(new Q(u),e.from(j)),Z:new Y(h)}),d}function se(e,t){let n=e;return e.length+t.length&&(n=new i(e.length+t.length),n.set(e,0),n.set(t,e.length)),n}function ie(e,t,n){return e.subarray(t,n)}function oe(e,t){return e.m(t)}function ce(e,t){return e.g(t)}class fe extends p{constructor({password:e,passwordVerification:n,checkPasswordOnly:r}){super({start(){t.assign(this,{password:e,passwordVerification:n}),we(this,e)},transform(e,t){const n=this;if(n.password){const t=le(n,e.subarray(0,12));if(n.password=null,t[11]!=n.passwordVerification)throw new s(V);e=e.subarray(12)}r?t.error(new s(R)):t.enqueue(le(n,e))}})}}class ae extends p{constructor({password:e,passwordVerification:n}){super({start(){t.assign(this,{password:e,passwordVerification:n}),we(this,e)},transform(e,t){const n=this;let r,s;if(n.password){n.password=null;const t=B(new i(12));t[11]=n.passwordVerification,r=new i(e.length+t.length),r.set(ue(n,t),0),s=12}else r=new i(e.length),s=0;r.set(ue(n,e),s),t.enqueue(r)}})}}function le(e,t){const n=new i(t.length);for(let r=0;r<t.length;r++)n[r]=de(e)^t[r],he(e,n[r]);return n}function ue(e,t){const n=new i(t.length);for(let r=0;r<t.length;r++)n[r]=de(e)^t[r],he(e,t[r]);return n}function we(e,n){const r=[305419896,591751049,878082192];t.assign(e,{keys:r,ee:new S(r[0]),te:new S(r[2])});for(let t=0;t<n.length;t++)he(e,n.charCodeAt(t))}function he(e,t){let[n,s,i]=e.keys;e.ee.append([t]),n=~e.ee.get(),s=ye(r.imul(ye(s+pe(n)),134775813)+1),e.te.append([s>>>24]),i=~e.te.get(),e.keys=[n,s,i]}function de(e){const t=2|e.keys[2];return pe(r.imul(t,1^t)>>>8)}function pe(e){return 255&e}function ye(e){return 4294967295&e}const me="deflate-raw";class be extends p{constructor(e,{chunkSize:t,CompressionStream:n,CompressionStreamNative:r}){super({});const{compressed:s,encrypted:i,useCompressionStream:o,zipCrypto:c,signed:f,level:a}=e,u=this;let w,h,d=ke(super.readable);i&&!c||!f||(w=new z,d=ze(d,w)),s&&(d=Se(d,o,{level:a,chunkSize:t},r,n)),i&&(c?d=ze(d,new ae(e)):(h=new te(e),d=ze(d,h))),ve(u,d,(()=>{let e;i&&!c&&(e=h.signature),i&&!c||!f||(e=new l(w.value.buffer).getUint32(0)),u.signature=e}))}}class ge extends p{constructor(e,{chunkSize:t,DecompressionStream:n,DecompressionStreamNative:r}){super({});const{zipCrypto:i,encrypted:o,signed:c,signature:f,compressed:a,useCompressionStream:u}=e;let w,h,d=ke(super.readable);o&&(i?d=ze(d,new fe(e)):(h=new ee(e),d=ze(d,h))),a&&(d=Se(d,u,{chunkSize:t},r,n)),o&&!i||!c||(w=new z,d=ze(d,w)),ve(this,d,(()=>{if((!o||i)&&c){const e=new l(w.value.buffer);if(f!=e.getUint32(0,!1))throw new s(P)}}))}}function ke(e){return ze(e,new p({transform(e,t){e&&e.length&&t.enqueue(e)}}))}function ve(e,n,r){n=ze(n,new p({flush:r})),t.defineProperty(e,"readable",{get:()=>n})}function Se(e,t,n,r,s){try{e=ze(e,new(t&&r?r:s)(me,n))}catch(r){if(!t)throw r;e=ze(e,new s(me,n))}return e}function ze(e,t){return e.pipeThrough(t)}const Ce="data";class xe extends p{constructor(e,n){super({});const r=this,{codecType:s}=e;let i;s.startsWith("deflate")?i=be:s.startsWith("inflate")&&(i=ge);let o=0;const c=new i(e,n),f=super.readable,a=new p({transform(e,t){e&&e.length&&(o+=e.length,t.enqueue(e))},flush(){const{signature:e}=c;t.assign(r,{signature:e,size:o})}});t.defineProperty(r,"readable",{get:()=>f.pipeThrough(c).pipeThrough(a)})}}const _e=new a,Ae=new a;let Ie=0;async function De(e){try{const{options:t,scripts:r,config:s}=e;r&&r.length&&importScripts.apply(void 0,r),self.initCodec&&self.initCodec(),s.CompressionStreamNative=self.CompressionStream,s.DecompressionStreamNative=self.DecompressionStream,self.Deflate&&(s.CompressionStream=new k(self.Deflate)),self.Inflate&&(s.DecompressionStream=new k(self.Inflate));const i={highWaterMark:1,size:()=>s.chunkSize},o=e.readable||new y({async pull(e){const t=new u((e=>_e.set(Ie,e)));Ve({type:"pull",messageId:Ie}),Ie=(Ie+1)%n.MAX_SAFE_INTEGER;const{value:r,done:s}=await t;e.enqueue(r),s&&e.close()}},i),c=e.writable||new m({async write(e){let t;const r=new u((e=>t=e));Ae.set(Ie,t),Ve({type:Ce,value:e,messageId:Ie}),Ie=(Ie+1)%n.MAX_SAFE_INTEGER,await r}},i),f=new xe(t,s);await o.pipeThrough(f).pipeTo(c,{preventClose:!0,preventAbort:!0});try{await c.getWriter().close()}catch(e){}const{signature:a,size:l}=f;Ve({type:"close",result:{signature:a,size:l}})}catch(e){Pe(e)}}function Ve(e){let{value:t}=e;if(t)if(t.length)try{t=new i(t),e.value=t.buffer,d(e,[e.value])}catch(t){d(e)}else d(e);else d(e)}function Pe(e=new s("Unknown error")){const{message:t,stack:n,code:r,name:i}=e;d({error:{message:t,stack:n,code:r,name:i}})}addEventListener("message",(({data:e})=>{const{type:t,messageId:n,value:r,done:s}=e;try{if("start"==t&&De(e),t==Ce){const e=_e.get(n);_e.delete(n),e({value:new i(r),done:s})}if("ack"==t){const e=Ae.get(n);Ae.delete(n),e()}}catch(e){Pe(e)}}));const Re=-2;function Be(t){return Ee(t.map((([t,n])=>new e(t).fill(n,0,t))))}function Ee(t){return t.reduce(((t,n)=>t.concat(e.isArray(n)?Ee(n):n)),[])}const Me=[0,1,2,3].concat(...Be([[2,4],[2,5],[4,6],[4,7],[8,8],[8,9],[16,10],[16,11],[32,12],[32,13],[64,14],[64,15],[2,0],[1,16],[1,17],[2,18],[2,19],[4,20],[4,21],[8,22],[8,23],[16,24],[16,25],[32,26],[32,27],[64,28],[64,29]]));function Ue(){const e=this;function t(e,t){let n=0;do{n|=1&e,e>>>=1,n<<=1}while(--t>0);return n>>>1}e.ne=n=>{const s=e.re,i=e.ie.se,o=e.ie.oe;let c,f,a,l=-1;for(n.ce=0,n.fe=573,c=0;o>c;c++)0!==s[2*c]?(n.ae[++n.ce]=l=c,n.le[c]=0):s[2*c+1]=0;for(;2>n.ce;)a=n.ae[++n.ce]=2>l?++l:0,s[2*a]=1,n.le[a]=0,n.ue--,i&&(n.we-=i[2*a+1]);for(e.he=l,c=r.floor(n.ce/2);c>=1;c--)n.de(s,c);a=o;do{c=n.ae[1],n.ae[1]=n.ae[n.ce--],n.de(s,1),f=n.ae[1],n.ae[--n.fe]=c,n.ae[--n.fe]=f,s[2*a]=s[2*c]+s[2*f],n.le[a]=r.max(n.le[c],n.le[f])+1,s[2*c+1]=s[2*f+1]=a,n.ae[1]=a++,n.de(s,1)}while(n.ce>=2);n.ae[--n.fe]=n.ae[1],(t=>{const n=e.re,r=e.ie.se,s=e.ie.pe,i=e.ie.ye,o=e.ie.me;let c,f,a,l,u,w,h=0;for(l=0;15>=l;l++)t.be[l]=0;for(n[2*t.ae[t.fe]+1]=0,c=t.fe+1;573>c;c++)f=t.ae[c],l=n[2*n[2*f+1]+1]+1,l>o&&(l=o,h++),n[2*f+1]=l,f>e.he||(t.be[l]++,u=0,i>f||(u=s[f-i]),w=n[2*f],t.ue+=w*(l+u),r&&(t.we+=w*(r[2*f+1]+u)));if(0!==h){do{for(l=o-1;0===t.be[l];)l--;t.be[l]--,t.be[l+1]+=2,t.be[o]--,h-=2}while(h>0);for(l=o;0!==l;l--)for(f=t.be[l];0!==f;)a=t.ae[--c],a>e.he||(n[2*a+1]!=l&&(t.ue+=(l-n[2*a+1])*n[2*a],n[2*a+1]=l),f--)}})(n),((e,n,r)=>{const s=[];let i,o,c,f=0;for(i=1;15>=i;i++)s[i]=f=f+r[i-1]<<1;for(o=0;n>=o;o++)c=e[2*o+1],0!==c&&(e[2*o]=t(s[c]++,c))})(s,e.he,n.be)}}function Ke(e,t,n,r,s){const i=this;i.se=e,i.pe=t,i.ye=n,i.oe=r,i.me=s}Ue.ge=[0,1,2,3,4,5,6,7].concat(...Be([[2,8],[2,9],[2,10],[2,11],[4,12],[4,13],[4,14],[4,15],[8,16],[8,17],[8,18],[8,19],[16,20],[16,21],[16,22],[16,23],[32,24],[32,25],[32,26],[31,27],[1,28]])),Ue.ke=[0,1,2,3,4,5,6,7,8,10,12,14,16,20,24,28,32,40,48,56,64,80,96,112,128,160,192,224,0],Ue.ve=[0,1,2,3,4,6,8,12,16,24,32,48,64,96,128,192,256,384,512,768,1024,1536,2048,3072,4096,6144,8192,12288,16384,24576],Ue.Se=e=>256>e?Me[e]:Me[256+(e>>>7)],Ue.ze=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],Ue.Ce=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],Ue.xe=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],Ue._e=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];const Ne=Be([[144,8],[112,9],[24,7],[8,8]]);Ke.Ae=Ee([12,140,76,204,44,172,108,236,28,156,92,220,60,188,124,252,2,130,66,194,34,162,98,226,18,146,82,210,50,178,114,242,10,138,74,202,42,170,106,234,26,154,90,218,58,186,122,250,6,134,70,198,38,166,102,230,22,150,86,214,54,182,118,246,14,142,78,206,46,174,110,238,30,158,94,222,62,190,126,254,1,129,65,193,33,161,97,225,17,145,81,209,49,177,113,241,9,137,73,201,41,169,105,233,25,153,89,217,57,185,121,249,5,133,69,197,37,165,101,229,21,149,85,213,53,181,117,245,13,141,77,205,45,173,109,237,29,157,93,221,61,189,125,253,19,275,147,403,83,339,211,467,51,307,179,435,115,371,243,499,11,267,139,395,75,331,203,459,43,299,171,427,107,363,235,491,27,283,155,411,91,347,219,475,59,315,187,443,123,379,251,507,7,263,135,391,71,327,199,455,39,295,167,423,103,359,231,487,23,279,151,407,87,343,215,471,55,311,183,439,119,375,247,503,15,271,143,399,79,335,207,463,47,303,175,431,111,367,239,495,31,287,159,415,95,351,223,479,63,319,191,447,127,383,255,511,0,64,32,96,16,80,48,112,8,72,40,104,24,88,56,120,4,68,36,100,20,84,52,116,3,131,67,195,35,163,99,227].map(((e,t)=>[e,Ne[t]])));const Oe=Be([[30,5]]);function Te(e,t,n,r,s){const i=this;i.Ie=e,i.De=t,i.Ve=n,i.Pe=r,i.Re=s}Ke.Be=Ee([0,16,8,24,4,20,12,28,2,18,10,26,6,22,14,30,1,17,9,25,5,21,13,29,3,19,11,27,7,23].map(((e,t)=>[e,Oe[t]]))),Ke.Ee=new Ke(Ke.Ae,Ue.ze,257,286,15),Ke.Me=new Ke(Ke.Be,Ue.Ce,0,30,15),Ke.Ue=new Ke(null,Ue.xe,0,19,7);const We=[new Te(0,0,0,0,0),new Te(4,4,8,4,1),new Te(4,5,16,8,1),new Te(4,6,32,32,1),new Te(4,4,16,16,2),new Te(8,16,32,32,2),new Te(8,16,128,128,2),new Te(8,32,128,256,2),new Te(32,128,258,1024,2),new Te(32,258,258,4096,2)],je=["need dictionary","stream end","","","stream error","data error","","buffer error","",""],He=113,Le=666,Fe=262;function qe(e,t,n,r){const s=e[2*t],i=e[2*n];return i>s||s==i&&r[t]<=r[n]}function Ge(){const e=this;let t,n,s,c,f,a,l,u,w,h,d,p,y,m,b,g,k,v,S,z,C,x,_,A,I,D,V,P,R,B,E,M,U;const K=new Ue,N=new Ue,O=new Ue;let T,W,j,H,L,F;function q(){let t;for(t=0;286>t;t++)E[2*t]=0;for(t=0;30>t;t++)M[2*t]=0;for(t=0;19>t;t++)U[2*t]=0;E[512]=1,e.ue=e.we=0,W=j=0}function G(e,t){let n,r=-1,s=e[1],i=0,o=7,c=4;0===s&&(o=138,c=3),e[2*(t+1)+1]=65535;for(let f=0;t>=f;f++)n=s,s=e[2*(f+1)+1],++i<o&&n==s||(c>i?U[2*n]+=i:0!==n?(n!=r&&U[2*n]++,U[32]++):i>10?U[36]++:U[34]++,i=0,r=n,0===s?(o=138,c=3):n==s?(o=6,c=3):(o=7,c=4))}function J(t){e.Ke[e.pending++]=t}function Q(e){J(255&e),J(e>>>8&255)}function X(e,t){let n;const r=t;F>16-r?(n=e,L|=n<<F&65535,Q(L),L=n>>>16-F,F+=r-16):(L|=e<<F&65535,F+=r)}function Y(e,t){const n=2*e;X(65535&t[n],65535&t[n+1])}function Z(e,t){let n,r,s=-1,i=e[1],o=0,c=7,f=4;for(0===i&&(c=138,f=3),n=0;t>=n;n++)if(r=i,i=e[2*(n+1)+1],++o>=c||r!=i){if(f>o)do{Y(r,U)}while(0!=--o);else 0!==r?(r!=s&&(Y(r,U),o--),Y(16,U),X(o-3,2)):o>10?(Y(18,U),X(o-11,7)):(Y(17,U),X(o-3,3));o=0,s=r,0===i?(c=138,f=3):r==i?(c=6,f=3):(c=7,f=4)}}function $(){16==F?(Q(L),L=0,F=0):8>F||(J(255&L),L>>>=8,F-=8)}function ee(t,n){let s,i,o;if(e.Ne[W]=t,e.Oe[W]=255&n,W++,0===t?E[2*n]++:(j++,t--,E[2*(Ue.ge[n]+256+1)]++,M[2*Ue.Se(t)]++),0==(8191&W)&&V>2){for(s=8*W,i=C-k,o=0;30>o;o++)s+=M[2*o]*(5+Ue.Ce[o]);if(s>>>=3,j<r.floor(W/2)&&s<r.floor(i/2))return!0}return W==T-1}function te(t,n){let r,s,i,o,c=0;if(0!==W)do{r=e.Ne[c],s=e.Oe[c],c++,0===r?Y(s,t):(i=Ue.ge[s],Y(i+256+1,t),o=Ue.ze[i],0!==o&&(s-=Ue.ke[i],X(s,o)),r--,i=Ue.Se(r),Y(i,n),o=Ue.Ce[i],0!==o&&(r-=Ue.ve[i],X(r,o)))}while(W>c);Y(256,t),H=t[513]}function ne(){F>8?Q(L):F>0&&J(255&L),L=0,F=0}function re(t,n,r){X(0+(r?1:0),3),((t,n)=>{ne(),H=8,Q(n),Q(~n),e.Ke.set(u.subarray(t,t+n),e.pending),e.pending+=n})(t,n)}function se(n){((t,n,r)=>{let s,i,o=0;V>0?(K.ne(e),N.ne(e),o=(()=>{let t;for(G(E,K.he),G(M,N.he),O.ne(e),t=18;t>=3&&0===U[2*Ue._e[t]+1];t--);return e.ue+=14+3*(t+1),t})(),s=e.ue+3+7>>>3,i=e.we+3+7>>>3,i>s||(s=i)):s=i=n+5,n+4>s||-1==t?i==s?(X(2+(r?1:0),3),te(Ke.Ae,Ke.Be)):(X(4+(r?1:0),3),((e,t,n)=>{let r;for(X(e-257,5),X(t-1,5),X(n-4,4),r=0;n>r;r++)X(U[2*Ue._e[r]+1],3);Z(E,e-1),Z(M,t-1)})(K.he+1,N.he+1,o+1),te(E,M)):re(t,n,r),q(),r&&ne()})(0>k?-1:k,C-k,n),k=C,t.Te()}function ie(){let e,n,r,s;do{if(s=w-_-C,0===s&&0===C&&0===_)s=f;else if(-1==s)s--;else if(C>=f+f-Fe){u.set(u.subarray(f,f+f),0),x-=f,C-=f,k-=f,e=y,r=e;do{n=65535&d[--r],d[r]=f>n?0:n-f}while(0!=--e);e=f,r=e;do{n=65535&h[--r],h[r]=f>n?0:n-f}while(0!=--e);s+=f}if(0===t.We)return;e=t.je(u,C+_,s),_+=e,3>_||(p=255&u[C],p=(p<<g^255&u[C+1])&b)}while(Fe>_&&0!==t.We)}function oe(e){let t,n,r=I,s=C,i=A;const o=C>f-Fe?C-(f-Fe):0;let c=B;const a=l,w=C+258;let d=u[s+i-1],p=u[s+i];R>A||(r>>=2),c>_&&(c=_);do{if(t=e,u[t+i]==p&&u[t+i-1]==d&&u[t]==u[s]&&u[++t]==u[s+1]){s+=2,t++;do{}while(u[++s]==u[++t]&&u[++s]==u[++t]&&u[++s]==u[++t]&&u[++s]==u[++t]&&u[++s]==u[++t]&&u[++s]==u[++t]&&u[++s]==u[++t]&&u[++s]==u[++t]&&w>s);if(n=258-(w-s),s=w-258,n>i){if(x=e,i=n,n>=c)break;d=u[s+i-1],p=u[s+i]}}}while((e=65535&h[e&a])>o&&0!=--r);return i>_?_:i}e.le=[],e.be=[],e.ae=[],E=[],M=[],U=[],e.de=(t,n)=>{const r=e.ae,s=r[n];let i=n<<1;for(;i<=e.ce&&(i<e.ce&&qe(t,r[i+1],r[i],e.le)&&i++,!qe(t,s,r[i],e.le));)r[n]=r[i],n=i,i<<=1;r[n]=s},e.He=(t,S,x,W,j,G)=>(W||(W=8),j||(j=8),G||(G=0),t.Le=null,-1==S&&(S=6),1>j||j>9||8!=W||9>x||x>15||0>S||S>9||0>G||G>2?Re:(t.Fe=e,a=x,f=1<<a,l=f-1,m=j+7,y=1<<m,b=y-1,g=r.floor((m+3-1)/3),u=new i(2*f),h=[],d=[],T=1<<j+6,e.Ke=new i(4*T),s=4*T,e.Ne=new o(T),e.Oe=new i(T),V=S,P=G,(t=>(t.qe=t.Ge=0,t.Le=null,e.pending=0,e.Je=0,n=He,c=0,K.re=E,K.ie=Ke.Ee,N.re=M,N.ie=Ke.Me,O.re=U,O.ie=Ke.Ue,L=0,F=0,H=8,q(),(()=>{w=2*f,d[y-1]=0;for(let e=0;y-1>e;e++)d[e]=0;D=We[V].De,R=We[V].Ie,B=We[V].Ve,I=We[V].Pe,C=0,k=0,_=0,v=A=2,z=0,p=0})(),0))(t))),e.Qe=()=>42!=n&&n!=He&&n!=Le?Re:(e.Oe=null,e.Ne=null,e.Ke=null,d=null,h=null,u=null,e.Fe=null,n==He?-3:0),e.Xe=(e,t,n)=>{let r=0;return-1==t&&(t=6),0>t||t>9||0>n||n>2?Re:(We[V].Re!=We[t].Re&&0!==e.qe&&(r=e.Ye(1)),V!=t&&(V=t,D=We[V].De,R=We[V].Ie,B=We[V].Ve,I=We[V].Pe),P=n,r)},e.Ze=(e,t,r)=>{let s,i=r,o=0;if(!t||42!=n)return Re;if(3>i)return 0;for(i>f-Fe&&(i=f-Fe,o=r-i),u.set(t.subarray(o,o+i),0),C=i,k=i,p=255&u[0],p=(p<<g^255&u[1])&b,s=0;i-3>=s;s++)p=(p<<g^255&u[s+2])&b,h[s&l]=d[p],d[p]=s;return 0},e.Ye=(r,i)=>{let o,w,m,I,R;if(i>4||0>i)return Re;if(!r.$e||!r.et&&0!==r.We||n==Le&&4!=i)return r.Le=je[4],Re;if(0===r.tt)return r.Le=je[7],-5;var B;if(t=r,I=c,c=i,42==n&&(w=8+(a-8<<4)<<8,m=(V-1&255)>>1,m>3&&(m=3),w|=m<<6,0!==C&&(w|=32),w+=31-w%31,n=He,J((B=w)>>8&255),J(255&B)),0!==e.pending){if(t.Te(),0===t.tt)return c=-1,0}else if(0===t.We&&I>=i&&4!=i)return t.Le=je[7],-5;if(n==Le&&0!==t.We)return r.Le=je[7],-5;if(0!==t.We||0!==_||0!=i&&n!=Le){switch(R=-1,We[V].Re){case 0:R=(e=>{let n,r=65535;for(r>s-5&&(r=s-5);;){if(1>=_){if(ie(),0===_&&0==e)return 0;if(0===_)break}if(C+=_,_=0,n=k+r,(0===C||C>=n)&&(_=C-n,C=n,se(!1),0===t.tt))return 0;if(C-k>=f-Fe&&(se(!1),0===t.tt))return 0}return se(4==e),0===t.tt?4==e?2:0:4==e?3:1})(i);break;case 1:R=(e=>{let n,r=0;for(;;){if(Fe>_){if(ie(),Fe>_&&0==e)return 0;if(0===_)break}if(3>_||(p=(p<<g^255&u[C+2])&b,r=65535&d[p],h[C&l]=d[p],d[p]=C),0===r||(C-r&65535)>f-Fe||2!=P&&(v=oe(r)),3>v)n=ee(0,255&u[C]),_--,C++;else if(n=ee(C-x,v-3),_-=v,v>D||3>_)C+=v,v=0,p=255&u[C],p=(p<<g^255&u[C+1])&b;else{v--;do{C++,p=(p<<g^255&u[C+2])&b,r=65535&d[p],h[C&l]=d[p],d[p]=C}while(0!=--v);C++}if(n&&(se(!1),0===t.tt))return 0}return se(4==e),0===t.tt?4==e?2:0:4==e?3:1})(i);break;case 2:R=(e=>{let n,r,s=0;for(;;){if(Fe>_){if(ie(),Fe>_&&0==e)return 0;if(0===_)break}if(3>_||(p=(p<<g^255&u[C+2])&b,s=65535&d[p],h[C&l]=d[p],d[p]=C),A=v,S=x,v=2,0!==s&&D>A&&f-Fe>=(C-s&65535)&&(2!=P&&(v=oe(s)),5>=v&&(1==P||3==v&&C-x>4096)&&(v=2)),3>A||v>A)if(0!==z){if(n=ee(0,255&u[C-1]),n&&se(!1),C++,_--,0===t.tt)return 0}else z=1,C++,_--;else{r=C+_-3,n=ee(C-1-S,A-3),_-=A-1,A-=2;do{++C>r||(p=(p<<g^255&u[C+2])&b,s=65535&d[p],h[C&l]=d[p],d[p]=C)}while(0!=--A);if(z=0,v=2,C++,n&&(se(!1),0===t.tt))return 0}}return 0!==z&&(n=ee(0,255&u[C-1]),z=0),se(4==e),0===t.tt?4==e?2:0:4==e?3:1})(i)}if(2!=R&&3!=R||(n=Le),0==R||2==R)return 0===t.tt&&(c=-1),0;if(1==R){if(1==i)X(2,3),Y(256,Ke.Ae),$(),9>1+H+10-F&&(X(2,3),Y(256,Ke.Ae),$()),H=7;else if(re(0,0,!1),3==i)for(o=0;y>o;o++)d[o]=0;if(t.Te(),0===t.tt)return c=-1,0}}return 4!=i?0:1}}function Je(){const e=this;e.nt=0,e.rt=0,e.We=0,e.qe=0,e.tt=0,e.Ge=0}function Qe(e){const t=new Je,n=(o=e&&e.chunkSize?e.chunkSize:65536)+5*(r.floor(o/16383)+1);var o;const c=new i(n);let f=e?e.level:-1;void 0===f&&(f=-1),t.He(f),t.$e=c,this.append=(e,r)=>{let o,f,a=0,l=0,u=0;const w=[];if(e.length){t.nt=0,t.et=e,t.We=e.length;do{if(t.rt=0,t.tt=n,o=t.Ye(0),0!=o)throw new s("deflating: "+t.Le);t.rt&&(t.rt==n?w.push(new i(c)):w.push(c.subarray(0,t.rt))),u+=t.rt,r&&t.nt>0&&t.nt!=a&&(r(t.nt),a=t.nt)}while(t.We>0||0===t.tt);return w.length>1?(f=new i(u),w.forEach((e=>{f.set(e,l),l+=e.length}))):f=w[0]?new i(w[0]):new i,f}},this.flush=()=>{let e,r,o=0,f=0;const a=[];do{if(t.rt=0,t.tt=n,e=t.Ye(4),1!=e&&0!=e)throw new s("deflating: "+t.Le);n-t.tt>0&&a.push(c.slice(0,t.rt)),f+=t.rt}while(t.We>0||0===t.tt);return t.Qe(),r=new i(f),a.forEach((e=>{r.set(e,o),o+=e.length})),r}}Je.prototype={He(e,t){const n=this;return n.Fe=new Ge,t||(t=15),n.Fe.He(n,e,t)},Ye(e){const t=this;return t.Fe?t.Fe.Ye(t,e):Re},Qe(){const e=this;if(!e.Fe)return Re;const t=e.Fe.Qe();return e.Fe=null,t},Xe(e,t){const n=this;return n.Fe?n.Fe.Xe(n,e,t):Re},Ze(e,t){const n=this;return n.Fe?n.Fe.Ze(n,e,t):Re},je(e,t,n){const r=this;let s=r.We;return s>n&&(s=n),0===s?0:(r.We-=s,e.set(r.et.subarray(r.nt,r.nt+s),t),r.nt+=s,r.qe+=s,s)},Te(){const e=this;let t=e.Fe.pending;t>e.tt&&(t=e.tt),0!==t&&(e.$e.set(e.Fe.Ke.subarray(e.Fe.Je,e.Fe.Je+t),e.rt),e.rt+=t,e.Fe.Je+=t,e.Ge+=t,e.tt-=t,e.Fe.pending-=t,0===e.Fe.pending&&(e.Fe.Je=0))}};const Xe=-2,Ye=-3,Ze=-5,$e=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535],et=[96,7,256,0,8,80,0,8,16,84,8,115,82,7,31,0,8,112,0,8,48,0,9,192,80,7,10,0,8,96,0,8,32,0,9,160,0,8,0,0,8,128,0,8,64,0,9,224,80,7,6,0,8,88,0,8,24,0,9,144,83,7,59,0,8,120,0,8,56,0,9,208,81,7,17,0,8,104,0,8,40,0,9,176,0,8,8,0,8,136,0,8,72,0,9,240,80,7,4,0,8,84,0,8,20,85,8,227,83,7,43,0,8,116,0,8,52,0,9,200,81,7,13,0,8,100,0,8,36,0,9,168,0,8,4,0,8,132,0,8,68,0,9,232,80,7,8,0,8,92,0,8,28,0,9,152,84,7,83,0,8,124,0,8,60,0,9,216,82,7,23,0,8,108,0,8,44,0,9,184,0,8,12,0,8,140,0,8,76,0,9,248,80,7,3,0,8,82,0,8,18,85,8,163,83,7,35,0,8,114,0,8,50,0,9,196,81,7,11,0,8,98,0,8,34,0,9,164,0,8,2,0,8,130,0,8,66,0,9,228,80,7,7,0,8,90,0,8,26,0,9,148,84,7,67,0,8,122,0,8,58,0,9,212,82,7,19,0,8,106,0,8,42,0,9,180,0,8,10,0,8,138,0,8,74,0,9,244,80,7,5,0,8,86,0,8,22,192,8,0,83,7,51,0,8,118,0,8,54,0,9,204,81,7,15,0,8,102,0,8,38,0,9,172,0,8,6,0,8,134,0,8,70,0,9,236,80,7,9,0,8,94,0,8,30,0,9,156,84,7,99,0,8,126,0,8,62,0,9,220,82,7,27,0,8,110,0,8,46,0,9,188,0,8,14,0,8,142,0,8,78,0,9,252,96,7,256,0,8,81,0,8,17,85,8,131,82,7,31,0,8,113,0,8,49,0,9,194,80,7,10,0,8,97,0,8,33,0,9,162,0,8,1,0,8,129,0,8,65,0,9,226,80,7,6,0,8,89,0,8,25,0,9,146,83,7,59,0,8,121,0,8,57,0,9,210,81,7,17,0,8,105,0,8,41,0,9,178,0,8,9,0,8,137,0,8,73,0,9,242,80,7,4,0,8,85,0,8,21,80,8,258,83,7,43,0,8,117,0,8,53,0,9,202,81,7,13,0,8,101,0,8,37,0,9,170,0,8,5,0,8,133,0,8,69,0,9,234,80,7,8,0,8,93,0,8,29,0,9,154,84,7,83,0,8,125,0,8,61,0,9,218,82,7,23,0,8,109,0,8,45,0,9,186,0,8,13,0,8,141,0,8,77,0,9,250,80,7,3,0,8,83,0,8,19,85,8,195,83,7,35,0,8,115,0,8,51,0,9,198,81,7,11,0,8,99,0,8,35,0,9,166,0,8,3,0,8,131,0,8,67,0,9,230,80,7,7,0,8,91,0,8,27,0,9,150,84,7,67,0,8,123,0,8,59,0,9,214,82,7,19,0,8,107,0,8,43,0,9,182,0,8,11,0,8,139,0,8,75,0,9,246,80,7,5,0,8,87,0,8,23,192,8,0,83,7,51,0,8,119,0,8,55,0,9,206,81,7,15,0,8,103,0,8,39,0,9,174,0,8,7,0,8,135,0,8,71,0,9,238,80,7,9,0,8,95,0,8,31,0,9,158,84,7,99,0,8,127,0,8,63,0,9,222,82,7,27,0,8,111,0,8,47,0,9,190,0,8,15,0,8,143,0,8,79,0,9,254,96,7,256,0,8,80,0,8,16,84,8,115,82,7,31,0,8,112,0,8,48,0,9,193,80,7,10,0,8,96,0,8,32,0,9,161,0,8,0,0,8,128,0,8,64,0,9,225,80,7,6,0,8,88,0,8,24,0,9,145,83,7,59,0,8,120,0,8,56,0,9,209,81,7,17,0,8,104,0,8,40,0,9,177,0,8,8,0,8,136,0,8,72,0,9,241,80,7,4,0,8,84,0,8,20,85,8,227,83,7,43,0,8,116,0,8,52,0,9,201,81,7,13,0,8,100,0,8,36,0,9,169,0,8,4,0,8,132,0,8,68,0,9,233,80,7,8,0,8,92,0,8,28,0,9,153,84,7,83,0,8,124,0,8,60,0,9,217,82,7,23,0,8,108,0,8,44,0,9,185,0,8,12,0,8,140,0,8,76,0,9,249,80,7,3,0,8,82,0,8,18,85,8,163,83,7,35,0,8,114,0,8,50,0,9,197,81,7,11,0,8,98,0,8,34,0,9,165,0,8,2,0,8,130,0,8,66,0,9,229,80,7,7,0,8,90,0,8,26,0,9,149,84,7,67,0,8,122,0,8,58,0,9,213,82,7,19,0,8,106,0,8,42,0,9,181,0,8,10,0,8,138,0,8,74,0,9,245,80,7,5,0,8,86,0,8,22,192,8,0,83,7,51,0,8,118,0,8,54,0,9,205,81,7,15,0,8,102,0,8,38,0,9,173,0,8,6,0,8,134,0,8,70,0,9,237,80,7,9,0,8,94,0,8,30,0,9,157,84,7,99,0,8,126,0,8,62,0,9,221,82,7,27,0,8,110,0,8,46,0,9,189,0,8,14,0,8,142,0,8,78,0,9,253,96,7,256,0,8,81,0,8,17,85,8,131,82,7,31,0,8,113,0,8,49,0,9,195,80,7,10,0,8,97,0,8,33,0,9,163,0,8,1,0,8,129,0,8,65,0,9,227,80,7,6,0,8,89,0,8,25,0,9,147,83,7,59,0,8,121,0,8,57,0,9,211,81,7,17,0,8,105,0,8,41,0,9,179,0,8,9,0,8,137,0,8,73,0,9,243,80,7,4,0,8,85,0,8,21,80,8,258,83,7,43,0,8,117,0,8,53,0,9,203,81,7,13,0,8,101,0,8,37,0,9,171,0,8,5,0,8,133,0,8,69,0,9,235,80,7,8,0,8,93,0,8,29,0,9,155,84,7,83,0,8,125,0,8,61,0,9,219,82,7,23,0,8,109,0,8,45,0,9,187,0,8,13,0,8,141,0,8,77,0,9,251,80,7,3,0,8,83,0,8,19,85,8,195,83,7,35,0,8,115,0,8,51,0,9,199,81,7,11,0,8,99,0,8,35,0,9,167,0,8,3,0,8,131,0,8,67,0,9,231,80,7,7,0,8,91,0,8,27,0,9,151,84,7,67,0,8,123,0,8,59,0,9,215,82,7,19,0,8,107,0,8,43,0,9,183,0,8,11,0,8,139,0,8,75,0,9,247,80,7,5,0,8,87,0,8,23,192,8,0,83,7,51,0,8,119,0,8,55,0,9,207,81,7,15,0,8,103,0,8,39,0,9,175,0,8,7,0,8,135,0,8,71,0,9,239,80,7,9,0,8,95,0,8,31,0,9,159,84,7,99,0,8,127,0,8,63,0,9,223,82,7,27,0,8,111,0,8,47,0,9,191,0,8,15,0,8,143,0,8,79,0,9,255],tt=[80,5,1,87,5,257,83,5,17,91,5,4097,81,5,5,89,5,1025,85,5,65,93,5,16385,80,5,3,88,5,513,84,5,33,92,5,8193,82,5,9,90,5,2049,86,5,129,192,5,24577,80,5,2,87,5,385,83,5,25,91,5,6145,81,5,7,89,5,1537,85,5,97,93,5,24577,80,5,4,88,5,769,84,5,49,92,5,12289,82,5,13,90,5,3073,86,5,193,192,5,24577],nt=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],rt=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,112,112],st=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],it=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13];function ot(){let e,t,n,r,s,i;function o(e,t,o,c,f,a,l,u,w,h,d){let p,y,m,b,g,k,v,S,z,C,x,_,A,I,D;C=0,g=o;do{n[e[t+C]]++,C++,g--}while(0!==g);if(n[0]==o)return l[0]=-1,u[0]=0,0;for(S=u[0],k=1;15>=k&&0===n[k];k++);for(v=k,k>S&&(S=k),g=15;0!==g&&0===n[g];g--);for(m=g,S>g&&(S=g),u[0]=S,I=1<<k;g>k;k++,I<<=1)if(0>(I-=n[k]))return Ye;if(0>(I-=n[g]))return Ye;for(n[g]+=I,i[1]=k=0,C=1,A=2;0!=--g;)i[A]=k+=n[C],A++,C++;g=0,C=0;do{0!==(k=e[t+C])&&(d[i[k]++]=g),C++}while(++g<o);for(o=i[m],i[0]=g=0,C=0,b=-1,_=-S,s[0]=0,x=0,D=0;m>=v;v++)for(p=n[v];0!=p--;){for(;v>_+S;){if(b++,_+=S,D=m-_,D=D>S?S:D,(y=1<<(k=v-_))>p+1&&(y-=p+1,A=v,D>k))for(;++k<D&&(y<<=1)>n[++A];)y-=n[A];if(D=1<<k,h[0]+D>1440)return Ye;s[b]=x=h[0],h[0]+=D,0!==b?(i[b]=g,r[0]=k,r[1]=S,k=g>>>_-S,r[2]=x-s[b-1]-k,w.set(r,3*(s[b-1]+k))):l[0]=x}for(r[1]=v-_,o>C?d[C]<c?(r[0]=256>d[C]?0:96,r[2]=d[C++]):(r[0]=a[d[C]-c]+16+64,r[2]=f[d[C++]-c]):r[0]=192,y=1<<v-_,k=g>>>_;D>k;k+=y)w.set(r,3*(x+k));for(k=1<<v-1;0!=(g&k);k>>>=1)g^=k;for(g^=k,z=(1<<_)-1;(g&z)!=i[b];)b--,_-=S,z=(1<<_)-1}return 0!==I&&1!=m?Ze:0}function c(o){let c;for(e||(e=[],t=[],n=new f(16),r=[],s=new f(15),i=new f(16)),t.length<o&&(t=[]),c=0;o>c;c++)t[c]=0;for(c=0;16>c;c++)n[c]=0;for(c=0;3>c;c++)r[c]=0;s.set(n.subarray(0,15),0),i.set(n.subarray(0,16),0)}this.st=(n,r,s,i,f)=>{let a;return c(19),e[0]=0,a=o(n,0,19,19,null,null,s,r,i,e,t),a==Ye?f.Le="oversubscribed dynamic bit lengths tree":a!=Ze&&0!==r[0]||(f.Le="incomplete dynamic bit lengths tree",a=Ye),a},this.it=(n,r,s,i,f,a,l,u,w)=>{let h;return c(288),e[0]=0,h=o(s,0,n,257,nt,rt,a,i,u,e,t),0!=h||0===i[0]?(h==Ye?w.Le="oversubscribed literal/length tree":-4!=h&&(w.Le="incomplete literal/length tree",h=Ye),h):(c(288),h=o(s,n,r,0,st,it,l,f,u,e,t),0!=h||0===f[0]&&n>257?(h==Ye?w.Le="oversubscribed distance tree":h==Ze?(w.Le="incomplete distance tree",h=Ye):-4!=h&&(w.Le="empty distance tree with lengths",h=Ye),h):0)}}function ct(){const e=this;let t,n,r,s,i=0,o=0,c=0,f=0,a=0,l=0,u=0,w=0,h=0,d=0;function p(e,t,n,r,s,i,o,c){let f,a,l,u,w,h,d,p,y,m,b,g,k,v,S,z;d=c.nt,p=c.We,w=o.ot,h=o.ct,y=o.write,m=y<o.read?o.read-y-1:o.end-y,b=$e[e],g=$e[t];do{for(;20>h;)p--,w|=(255&c.ft(d++))<<h,h+=8;if(f=w&b,a=n,l=r,z=3*(l+f),0!==(u=a[z]))for(;;){if(w>>=a[z+1],h-=a[z+1],0!=(16&u)){for(u&=15,k=a[z+2]+(w&$e[u]),w>>=u,h-=u;15>h;)p--,w|=(255&c.ft(d++))<<h,h+=8;for(f=w&g,a=s,l=i,z=3*(l+f),u=a[z];;){if(w>>=a[z+1],h-=a[z+1],0!=(16&u)){for(u&=15;u>h;)p--,w|=(255&c.ft(d++))<<h,h+=8;if(v=a[z+2]+(w&$e[u]),w>>=u,h-=u,m-=k,v>y){S=y-v;do{S+=o.end}while(0>S);if(u=o.end-S,k>u){if(k-=u,y-S>0&&u>y-S)do{o.lt[y++]=o.lt[S++]}while(0!=--u);else o.lt.set(o.lt.subarray(S,S+u),y),y+=u,S+=u,u=0;S=0}}else S=y-v,y-S>0&&2>y-S?(o.lt[y++]=o.lt[S++],o.lt[y++]=o.lt[S++],k-=2):(o.lt.set(o.lt.subarray(S,S+2),y),y+=2,S+=2,k-=2);if(y-S>0&&k>y-S)do{o.lt[y++]=o.lt[S++]}while(0!=--k);else o.lt.set(o.lt.subarray(S,S+k),y),y+=k,S+=k,k=0;break}if(0!=(64&u))return c.Le="invalid distance code",k=c.We-p,k=k>h>>3?h>>3:k,p+=k,d-=k,h-=k<<3,o.ot=w,o.ct=h,c.We=p,c.qe+=d-c.nt,c.nt=d,o.write=y,Ye;f+=a[z+2],f+=w&$e[u],z=3*(l+f),u=a[z]}break}if(0!=(64&u))return 0!=(32&u)?(k=c.We-p,k=k>h>>3?h>>3:k,p+=k,d-=k,h-=k<<3,o.ot=w,o.ct=h,c.We=p,c.qe+=d-c.nt,c.nt=d,o.write=y,1):(c.Le="invalid literal/length code",k=c.We-p,k=k>h>>3?h>>3:k,p+=k,d-=k,h-=k<<3,o.ot=w,o.ct=h,c.We=p,c.qe+=d-c.nt,c.nt=d,o.write=y,Ye);if(f+=a[z+2],f+=w&$e[u],z=3*(l+f),0===(u=a[z])){w>>=a[z+1],h-=a[z+1],o.lt[y++]=a[z+2],m--;break}}else w>>=a[z+1],h-=a[z+1],o.lt[y++]=a[z+2],m--}while(m>=258&&p>=10);return k=c.We-p,k=k>h>>3?h>>3:k,p+=k,d-=k,h-=k<<3,o.ot=w,o.ct=h,c.We=p,c.qe+=d-c.nt,c.nt=d,o.write=y,0}e.init=(e,i,o,c,f,a)=>{t=0,u=e,w=i,r=o,h=c,s=f,d=a,n=null},e.ut=(e,y,m)=>{let b,g,k,v,S,z,C,x=0,_=0,A=0;for(A=y.nt,v=y.We,x=e.ot,_=e.ct,S=e.write,z=S<e.read?e.read-S-1:e.end-S;;)switch(t){case 0:if(z>=258&&v>=10&&(e.ot=x,e.ct=_,y.We=v,y.qe+=A-y.nt,y.nt=A,e.write=S,m=p(u,w,r,h,s,d,e,y),A=y.nt,v=y.We,x=e.ot,_=e.ct,S=e.write,z=S<e.read?e.read-S-1:e.end-S,0!=m)){t=1==m?7:9;break}c=u,n=r,o=h,t=1;case 1:for(b=c;b>_;){if(0===v)return e.ot=x,e.ct=_,y.We=v,y.qe+=A-y.nt,y.nt=A,e.write=S,e.wt(y,m);m=0,v--,x|=(255&y.ft(A++))<<_,_+=8}if(g=3*(o+(x&$e[b])),x>>>=n[g+1],_-=n[g+1],k=n[g],0===k){f=n[g+2],t=6;break}if(0!=(16&k)){a=15&k,i=n[g+2],t=2;break}if(0==(64&k)){c=k,o=g/3+n[g+2];break}if(0!=(32&k)){t=7;break}return t=9,y.Le="invalid literal/length code",m=Ye,e.ot=x,e.ct=_,y.We=v,y.qe+=A-y.nt,y.nt=A,e.write=S,e.wt(y,m);case 2:for(b=a;b>_;){if(0===v)return e.ot=x,e.ct=_,y.We=v,y.qe+=A-y.nt,y.nt=A,e.write=S,e.wt(y,m);m=0,v--,x|=(255&y.ft(A++))<<_,_+=8}i+=x&$e[b],x>>=b,_-=b,c=w,n=s,o=d,t=3;case 3:for(b=c;b>_;){if(0===v)return e.ot=x,e.ct=_,y.We=v,y.qe+=A-y.nt,y.nt=A,e.write=S,e.wt(y,m);m=0,v--,x|=(255&y.ft(A++))<<_,_+=8}if(g=3*(o+(x&$e[b])),x>>=n[g+1],_-=n[g+1],k=n[g],0!=(16&k)){a=15&k,l=n[g+2],t=4;break}if(0==(64&k)){c=k,o=g/3+n[g+2];break}return t=9,y.Le="invalid distance code",m=Ye,e.ot=x,e.ct=_,y.We=v,y.qe+=A-y.nt,y.nt=A,e.write=S,e.wt(y,m);case 4:for(b=a;b>_;){if(0===v)return e.ot=x,e.ct=_,y.We=v,y.qe+=A-y.nt,y.nt=A,e.write=S,e.wt(y,m);m=0,v--,x|=(255&y.ft(A++))<<_,_+=8}l+=x&$e[b],x>>=b,_-=b,t=5;case 5:for(C=S-l;0>C;)C+=e.end;for(;0!==i;){if(0===z&&(S==e.end&&0!==e.read&&(S=0,z=S<e.read?e.read-S-1:e.end-S),0===z&&(e.write=S,m=e.wt(y,m),S=e.write,z=S<e.read?e.read-S-1:e.end-S,S==e.end&&0!==e.read&&(S=0,z=S<e.read?e.read-S-1:e.end-S),0===z)))return e.ot=x,e.ct=_,y.We=v,y.qe+=A-y.nt,y.nt=A,e.write=S,e.wt(y,m);e.lt[S++]=e.lt[C++],z--,C==e.end&&(C=0),i--}t=0;break;case 6:if(0===z&&(S==e.end&&0!==e.read&&(S=0,z=S<e.read?e.read-S-1:e.end-S),0===z&&(e.write=S,m=e.wt(y,m),S=e.write,z=S<e.read?e.read-S-1:e.end-S,S==e.end&&0!==e.read&&(S=0,z=S<e.read?e.read-S-1:e.end-S),0===z)))return e.ot=x,e.ct=_,y.We=v,y.qe+=A-y.nt,y.nt=A,e.write=S,e.wt(y,m);m=0,e.lt[S++]=f,z--,t=0;break;case 7:if(_>7&&(_-=8,v++,A--),e.write=S,m=e.wt(y,m),S=e.write,z=S<e.read?e.read-S-1:e.end-S,e.read!=e.write)return e.ot=x,e.ct=_,y.We=v,y.qe+=A-y.nt,y.nt=A,e.write=S,e.wt(y,m);t=8;case 8:return m=1,e.ot=x,e.ct=_,y.We=v,y.qe+=A-y.nt,y.nt=A,e.write=S,e.wt(y,m);case 9:return m=Ye,e.ot=x,e.ct=_,y.We=v,y.qe+=A-y.nt,y.nt=A,e.write=S,e.wt(y,m);default:return m=Xe,e.ot=x,e.ct=_,y.We=v,y.qe+=A-y.nt,y.nt=A,e.write=S,e.wt(y,m)}},e.ht=()=>{}}ot.dt=(e,t,n,r)=>(e[0]=9,t[0]=5,n[0]=et,r[0]=tt,0);const ft=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];function at(e,t){const n=this;let r,s=0,o=0,c=0,a=0;const l=[0],u=[0],w=new ct;let h=0,d=new f(4320);const p=new ot;n.ct=0,n.ot=0,n.lt=new i(t),n.end=t,n.read=0,n.write=0,n.reset=(e,t)=>{t&&(t[0]=0),6==s&&w.ht(e),s=0,n.ct=0,n.ot=0,n.read=n.write=0},n.reset(e,null),n.wt=(e,t)=>{let r,s,i;return s=e.rt,i=n.read,r=(i>n.write?n.end:n.write)-i,r>e.tt&&(r=e.tt),0!==r&&t==Ze&&(t=0),e.tt-=r,e.Ge+=r,e.$e.set(n.lt.subarray(i,i+r),s),s+=r,i+=r,i==n.end&&(i=0,n.write==n.end&&(n.write=0),r=n.write-i,r>e.tt&&(r=e.tt),0!==r&&t==Ze&&(t=0),e.tt-=r,e.Ge+=r,e.$e.set(n.lt.subarray(i,i+r),s),s+=r,i+=r),e.rt=s,n.read=i,t},n.ut=(e,t)=>{let i,f,y,m,b,g,k,v;for(m=e.nt,b=e.We,f=n.ot,y=n.ct,g=n.write,k=g<n.read?n.read-g-1:n.end-g;;){let S,z,C,x,_,A,I,D;switch(s){case 0:for(;3>y;){if(0===b)return n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);t=0,b--,f|=(255&e.ft(m++))<<y,y+=8}switch(i=7&f,h=1&i,i>>>1){case 0:f>>>=3,y-=3,i=7&y,f>>>=i,y-=i,s=1;break;case 1:S=[],z=[],C=[[]],x=[[]],ot.dt(S,z,C,x),w.init(S[0],z[0],C[0],0,x[0],0),f>>>=3,y-=3,s=6;break;case 2:f>>>=3,y-=3,s=3;break;case 3:return f>>>=3,y-=3,s=9,e.Le="invalid block type",t=Ye,n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t)}break;case 1:for(;32>y;){if(0===b)return n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);t=0,b--,f|=(255&e.ft(m++))<<y,y+=8}if((~f>>>16&65535)!=(65535&f))return s=9,e.Le="invalid stored block lengths",t=Ye,n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);o=65535&f,f=y=0,s=0!==o?2:0!==h?7:0;break;case 2:if(0===b)return n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);if(0===k&&(g==n.end&&0!==n.read&&(g=0,k=g<n.read?n.read-g-1:n.end-g),0===k&&(n.write=g,t=n.wt(e,t),g=n.write,k=g<n.read?n.read-g-1:n.end-g,g==n.end&&0!==n.read&&(g=0,k=g<n.read?n.read-g-1:n.end-g),0===k)))return n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);if(t=0,i=o,i>b&&(i=b),i>k&&(i=k),n.lt.set(e.je(m,i),g),m+=i,b-=i,g+=i,k-=i,0!=(o-=i))break;s=0!==h?7:0;break;case 3:for(;14>y;){if(0===b)return n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);t=0,b--,f|=(255&e.ft(m++))<<y,y+=8}if(c=i=16383&f,(31&i)>29||(i>>5&31)>29)return s=9,e.Le="too many length or distance symbols",t=Ye,n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);if(i=258+(31&i)+(i>>5&31),!r||r.length<i)r=[];else for(v=0;i>v;v++)r[v]=0;f>>>=14,y-=14,a=0,s=4;case 4:for(;4+(c>>>10)>a;){for(;3>y;){if(0===b)return n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);t=0,b--,f|=(255&e.ft(m++))<<y,y+=8}r[ft[a++]]=7&f,f>>>=3,y-=3}for(;19>a;)r[ft[a++]]=0;if(l[0]=7,i=p.st(r,l,u,d,e),0!=i)return(t=i)==Ye&&(r=null,s=9),n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);a=0,s=5;case 5:for(;i=c,258+(31&i)+(i>>5&31)>a;){let o,w;for(i=l[0];i>y;){if(0===b)return n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);t=0,b--,f|=(255&e.ft(m++))<<y,y+=8}if(i=d[3*(u[0]+(f&$e[i]))+1],w=d[3*(u[0]+(f&$e[i]))+2],16>w)f>>>=i,y-=i,r[a++]=w;else{for(v=18==w?7:w-14,o=18==w?11:3;i+v>y;){if(0===b)return n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);t=0,b--,f|=(255&e.ft(m++))<<y,y+=8}if(f>>>=i,y-=i,o+=f&$e[v],f>>>=v,y-=v,v=a,i=c,v+o>258+(31&i)+(i>>5&31)||16==w&&1>v)return r=null,s=9,e.Le="invalid bit length repeat",t=Ye,n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);w=16==w?r[v-1]:0;do{r[v++]=w}while(0!=--o);a=v}}if(u[0]=-1,_=[],A=[],I=[],D=[],_[0]=9,A[0]=6,i=c,i=p.it(257+(31&i),1+(i>>5&31),r,_,A,I,D,d,e),0!=i)return i==Ye&&(r=null,s=9),t=i,n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);w.init(_[0],A[0],d,I[0],d,D[0]),s=6;case 6:if(n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,1!=(t=w.ut(n,e,t)))return n.wt(e,t);if(t=0,w.ht(e),m=e.nt,b=e.We,f=n.ot,y=n.ct,g=n.write,k=g<n.read?n.read-g-1:n.end-g,0===h){s=0;break}s=7;case 7:if(n.write=g,t=n.wt(e,t),g=n.write,k=g<n.read?n.read-g-1:n.end-g,n.read!=n.write)return n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);s=8;case 8:return t=1,n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);case 9:return t=Ye,n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t);default:return t=Xe,n.ot=f,n.ct=y,e.We=b,e.qe+=m-e.nt,e.nt=m,n.write=g,n.wt(e,t)}}},n.ht=e=>{n.reset(e,null),n.lt=null,d=null},n.yt=(e,t,r)=>{n.lt.set(e.subarray(t,t+r),0),n.read=n.write=r},n.bt=()=>1==s?1:0}const lt=13,ut=[0,0,255,255];function wt(){const e=this;function t(e){return e&&e.gt?(e.qe=e.Ge=0,e.Le=null,e.gt.mode=7,e.gt.kt.reset(e,null),0):Xe}e.mode=0,e.method=0,e.vt=[0],e.St=0,e.marker=0,e.zt=0,e.Ct=t=>(e.kt&&e.kt.ht(t),e.kt=null,0),e.xt=(n,r)=>(n.Le=null,e.kt=null,8>r||r>15?(e.Ct(n),Xe):(e.zt=r,n.gt.kt=new at(n,1<<r),t(n),0)),e._t=(e,t)=>{let n,r;if(!e||!e.gt||!e.et)return Xe;const s=e.gt;for(t=4==t?Ze:0,n=Ze;;)switch(s.mode){case 0:if(0===e.We)return n;if(n=t,e.We--,e.qe++,8!=(15&(s.method=e.ft(e.nt++)))){s.mode=lt,e.Le="unknown compression method",s.marker=5;break}if(8+(s.method>>4)>s.zt){s.mode=lt,e.Le="invalid win size",s.marker=5;break}s.mode=1;case 1:if(0===e.We)return n;if(n=t,e.We--,e.qe++,r=255&e.ft(e.nt++),((s.method<<8)+r)%31!=0){s.mode=lt,e.Le="incorrect header check",s.marker=5;break}if(0==(32&r)){s.mode=7;break}s.mode=2;case 2:if(0===e.We)return n;n=t,e.We--,e.qe++,s.St=(255&e.ft(e.nt++))<<24&4278190080,s.mode=3;case 3:if(0===e.We)return n;n=t,e.We--,e.qe++,s.St+=(255&e.ft(e.nt++))<<16&16711680,s.mode=4;case 4:if(0===e.We)return n;n=t,e.We--,e.qe++,s.St+=(255&e.ft(e.nt++))<<8&65280,s.mode=5;case 5:return 0===e.We?n:(n=t,e.We--,e.qe++,s.St+=255&e.ft(e.nt++),s.mode=6,2);case 6:return s.mode=lt,e.Le="need dictionary",s.marker=0,Xe;case 7:if(n=s.kt.ut(e,n),n==Ye){s.mode=lt,s.marker=0;break}if(0==n&&(n=t),1!=n)return n;n=t,s.kt.reset(e,s.vt),s.mode=12;case 12:return e.We=0,1;case lt:return Ye;default:return Xe}},e.At=(e,t,n)=>{let r=0,s=n;if(!e||!e.gt||6!=e.gt.mode)return Xe;const i=e.gt;return s<1<<i.zt||(s=(1<<i.zt)-1,r=n-s),i.kt.yt(t,r,s),i.mode=7,0},e.It=e=>{let n,r,s,i,o;if(!e||!e.gt)return Xe;const c=e.gt;if(c.mode!=lt&&(c.mode=lt,c.marker=0),0===(n=e.We))return Ze;for(r=e.nt,s=c.marker;0!==n&&4>s;)e.ft(r)==ut[s]?s++:s=0!==e.ft(r)?0:4-s,r++,n--;return e.qe+=r-e.nt,e.nt=r,e.We=n,c.marker=s,4!=s?Ye:(i=e.qe,o=e.Ge,t(e),e.qe=i,e.Ge=o,c.mode=7,0)},e.Dt=e=>e&&e.gt&&e.gt.kt?e.gt.kt.bt():Xe}function ht(){}function dt(e){const t=new ht,n=e&&e.chunkSize?r.floor(2*e.chunkSize):131072,o=new i(n);let c=!1;t.xt(),t.$e=o,this.append=(e,r)=>{const f=[];let a,l,u=0,w=0,h=0;if(0!==e.length){t.nt=0,t.et=e,t.We=e.length;do{if(t.rt=0,t.tt=n,0!==t.We||c||(t.nt=0,c=!0),a=t._t(0),c&&a===Ze){if(0!==t.We)throw new s("inflating: bad input")}else if(0!==a&&1!==a)throw new s("inflating: "+t.Le);if((c||1===a)&&t.We===e.length)throw new s("inflating: bad input");t.rt&&(t.rt===n?f.push(new i(o)):f.push(o.subarray(0,t.rt))),h+=t.rt,r&&t.nt>0&&t.nt!=u&&(r(t.nt),u=t.nt)}while(t.We>0||0===t.tt);return f.length>1?(l=new i(h),f.forEach((e=>{l.set(e,w),w+=e.length}))):l=f[0]?new i(f[0]):new i,l}},this.flush=()=>{t.Ct()}}ht.prototype={xt(e){const t=this;return t.gt=new wt,e||(e=15),t.gt.xt(t,e)},_t(e){const t=this;return t.gt?t.gt._t(t,e):Xe},Ct(){const e=this;if(!e.gt)return Xe;const t=e.gt.Ct(e);return e.gt=null,t},It(){const e=this;return e.gt?e.gt.It(e):Xe},At(e,t){const n=this;return n.gt?n.gt.At(n,e,t):Xe},ft(e){return this.et[e]},je(e,t){return this.et.subarray(e,e+t)}},self.initCodec=()=>{self.Deflate=Qe,self.Inflate=dt};
`],{type:"text/javascript"}));r({workerScripts:{inflate:[e],deflate:[e]}})}const Im="Writer iterator completed too soon",Am="Content-Type",Rm=64*1024,Zu="writable";class Ah{constructor(){this.size=0}init(){this.initialized=!0}}class Lm extends Ah{get readable(){const e=this,{chunkSize:t=Rm}=e,n=new ReadableStream({start(){this.chunkOffset=0},async pull(i){const{offset:s=0,size:h,diskNumberStart:d}=n,{chunkOffset:c}=this;i.enqueue(await yh(e,s+c,Math.min(t,h-c),d)),c+t>h?i.close():this.chunkOffset+=t}});return n}}class Nm extends Ah{constructor(e){super();const t=this,n=new TransformStream,i=[];e&&i.push([Am,e]),Object.defineProperty(t,Zu,{get(){return n.writable}}),t.blob=new Response(n.readable,{headers:i}).blob()}getData(){return this.blob}}class Dm extends Lm{constructor(e){super(),this.readers=e}async init(){const e=this,{readers:t}=e;e.lastDiskNumber=0,e.lastDiskOffset=0,await Promise.all(t.map(async(n,i)=>{await n.init(),i!=t.length-1&&(e.lastDiskOffset+=n.size),e.size+=n.size})),super.init()}async readUint8Array(e,t,n=0){const i=this,{readers:s}=this;let h,d=n;d==-1&&(d=s.length-1);let c=e;for(;c>=s[d].size;)c-=s[d].size,d++;const _=s[d],m=_.size;if(c+t<=m)h=await yh(_,c,t);else{const g=m-c;h=new Uint8Array(t),h.set(await yh(_,c,g)),h.set(await i.readUint8Array(e+g,t-g,n),g)}return i.lastDiskNumber=Math.max(d,i.lastDiskNumber),h}}class bh extends Ah{constructor(e,t=4294967295){super();const n=this;Object.assign(n,{diskNumber:0,diskOffset:0,size:0,maxSize:t,availableSize:t});let i,s,h;const d=new WritableStream({async write(m){const{availableSize:g}=n;if(h)m.length>=g?(await c(m.slice(0,g)),await _(),n.diskOffset+=i.size,n.diskNumber++,h=null,await this.write(m.slice(g))):await c(m);else{const{value:S,done:E}=await e.next();if(E&&!S)throw new Error(Im);i=S,i.size=0,i.maxSize&&(n.maxSize=i.maxSize),n.availableSize=n.maxSize,await Xo(i),s=S.writable,h=s.getWriter(),await this.write(m)}},async close(){await h.ready,await _()}});Object.defineProperty(n,Zu,{get(){return d}});async function c(m){const g=m.length;g&&(await h.ready,await h.write(m),i.size+=g,n.size+=g,n.availableSize-=g)}async function _(){s.size=i.size,await h.close()}}}async function Xo(r,e){r.init&&!r.initialized&&await r.init(e)}function Fm(r){return Array.isArray(r)&&(r=new Dm(r)),r instanceof ReadableStream&&(r={readable:r}),r}function Om(r){r.writable===ri&&typeof r.next==Eu&&(r=new bh(r)),r instanceof WritableStream&&(r={writable:r});const{writable:e}=r;return e.size===ri&&(e.size=0),r instanceof bh||Object.assign(r,{diskNumber:0,diskOffset:0,availableSize:1/0,maxSize:1/0}),r}function yh(r,e,t,n){return r.readUint8Array(e,t,n)}const Hm="\0 !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~ ".split("");Hm.length==256;const Vm="filename",Wm="rawFilename",qm="comment",Um="rawComment",zm="uncompressedSize",Xm="compressedSize",$m="offset",Cd="diskNumberStart",Qu="lastModDate",Ym="rawLastModDate",Ju="lastAccessDate",e0="creationDate",t0="internalFileAttribute",n0="externalFileAttribute",i0="msDosCompatible",s0="zip64",jm=[Vm,Wm,Xm,zm,Qu,Ym,qm,Um,Ju,e0,$m,Cd,Cd,t0,n0,i0,s0,"directory","bitFlag","encrypted","signature","filenameUTF8","commentUTF8","compressionMethod","version","versionMadeBy","extraField","rawExtraField","extraFieldZip64","extraFieldUnicodePath","extraFieldUnicodeComment","extraFieldAES","extraFieldNTFS","extraFieldExtendedTimestamp"];class r0{constructor(e){jm.forEach(t=>this[t]=e[t])}}const Km="File already exists",Gm="Zip file comment exceeds 64KB",Zm="File entry comment exceeds 64KB",Qm="File entry name exceeds 64KB",kd="Version exceeds 65535",Jm="The strength must equal 1, 2, or 3",eg="Extra field type exceeds 65535",tg="Extra field data exceeds 64KB",Rh="Zip64 is not supported (make sure 'keepOrder' is set to 'true')",Pd=new Uint8Array([7,0,2,0,65,69,3,0,0]);let Ul=0;const Ed=[];class ng{constructor(e,t={}){e=Om(e),Object.assign(this,{writer:e,addSplitZipSignature:e instanceof bh,options:t,config:U1(),files:new Map,filenames:new Set,offset:e.writable.size,pendingEntriesSize:0,pendingAddFileCalls:new Set,bufferedWrites:0})}async add(e="",t,n={}){const i=this,{pendingAddFileCalls:s,config:h}=i;Ul<h.maxWorkers?Ul++:await new Promise(c=>Ed.push(c));let d;try{if(e=e.trim(),i.filenames.has(e))throw new Error(Km);return i.filenames.add(e),d=ig(i,e,t,n),s.add(d),await d}catch(c){throw i.filenames.delete(e),c}finally{s.delete(d);const c=Ed.shift();c?c():Ul--}}async close(e=new Uint8Array,t={}){const n=this,{pendingAddFileCalls:i,writer:s}=this,{writable:h}=s;for(;i.size;)await Promise.all(Array.from(i));return await ug(this,e,t),ln(n,t,"preventClose")||await h.getWriter().close(),s.getData?s.getData():h}}async function ig(r,e,t,n){e=e.trim(),n.directory&&!e.endsWith(Ol)?e+=Ol:n.directory=e.endsWith(Ol);const i=mh(e);if(Jt(i)>gi)throw new Error(Qm);const s=n.comment||"",h=mh(s);if(Jt(h)>gi)throw new Error(Zm);const d=ln(r,n,"version",V1);if(d>gi)throw new Error(kd);const c=ln(r,n,"versionMadeBy",20);if(c>gi)throw new Error(kd);const _=ln(r,n,Qu,new Date),m=ln(r,n,Ju),g=ln(r,n,e0),S=ln(r,n,i0,!0),E=ln(r,n,t0,0),A=ln(r,n,n0,0),C=ln(r,n,"password"),k=ln(r,n,"encryptionStrength",3),T=ln(r,n,"zipCrypto"),b=ln(r,n,"extendedTimestamp",!0),R=ln(r,n,"keepOrder",!0),V=ln(r,n,"level"),f=ln(r,n,"useWebWorkers"),D=ln(r,n,"bufferedWrite"),l=ln(r,n,"dataDescriptorSignature",!1),W=ln(r,n,"signal"),L=ln(r,n,"useCompressionStream");let P=ln(r,n,"dataDescriptor",!0),y=ln(r,n,s0);if(C!==ri&&k!==ri&&(k<1||k>3))throw new Error(Jm);let O=new Uint8Array;const{extraField:B}=n;if(B){let pe=0,Oe=0;B.forEach(nt=>pe+=4+Jt(nt)),O=new Uint8Array(pe),B.forEach((nt,Ve)=>{if(Ve>gi)throw new Error(eg);if(Jt(nt)>gi)throw new Error(tg);In(O,new Uint16Array([Ve]),Oe),In(O,new Uint16Array([Jt(nt)]),Oe+2),In(O,nt,Oe+4),Oe+=4+Jt(nt)})}let v=0,H=0,N=0;const te=y===!0;t&&(t=Fm(t),await Xo(t),t.size===ri?(P=!0,(y||y===ri)&&(y=!0,N=v=bi)):(N=t.size,v=fg(N)));const{diskOffset:G,diskNumber:se,maxSize:M}=r.writer,F=te||N>=bi,Z=te||v>=bi,ee=te||r.offset+r.pendingEntriesSize-G>=bi,Pe=ln(r,n,"supportZip64SplitFile",!0)&&te||se+Math.ceil(r.pendingEntriesSize/M)>=gi;if(ee||F||Z||Pe){if(y===!1||!R)throw new Error(Rh);y=!0}y=y||!1,n=Object.assign({},n,{rawFilename:i,rawComment:h,version:d,versionMadeBy:c,lastModDate:_,lastAccessDate:m,creationDate:g,rawExtraField:O,zip64:y,zip64UncompressedSize:F,zip64CompressedSize:Z,zip64Offset:ee,zip64DiskNumberStart:Pe,password:C,level:V,useWebWorkers:f,encryptionStrength:k,extendedTimestamp:b,zipCrypto:T,bufferedWrite:D,keepOrder:R,dataDescriptor:P,dataDescriptorSignature:l,signal:W,msDosCompatible:S,internalFileAttribute:E,externalFileAttribute:A,useCompressionStream:L});const _e=og(n),ke=lg(n),Ne=Jt(_e.localHeaderArray,ke.dataDescriptorArray);H=Ne+v,r.options.usdz&&(H+=H+64),r.pendingEntriesSize+=H;let Be;try{Be=await sg(r,e,t,{headerInfo:_e,dataDescriptorInfo:ke,metadataSize:Ne},n)}finally{r.pendingEntriesSize-=H}return Object.assign(Be,{name:e,comment:s,extraField:B}),new r0(Be)}async function sg(r,e,t,n,i){const{files:s,writer:h}=r,{keepOrder:d,dataDescriptor:c,signal:_}=i,{headerInfo:m}=n,{usdz:g}=r.options,S=Array.from(s.values()).pop();let E={},A,C,k,T,b,R;s.set(e,E);try{let l;d&&(l=S&&S.lock,V()),(i.bufferedWrite||r.writerLocked||r.bufferedWrites&&d||!c)&&!g?(R=new Nm,R.writable.size=0,A=!0,r.bufferedWrites++,await Xo(h)):(R=h,await f()),await Xo(R);const{writable:W}=h;let{diskOffset:L}=h;if(r.addSplitZipSignature){delete r.addSplitZipSignature;const y=new Uint8Array(4),O=$n(y);Ot(O,0,Su),await As(W,y),r.offset+=4}g&&ag(n,r.offset-L),A||(await l,await D(W));const{diskNumber:P}=h;if(b=!0,E.diskNumberStart=P,E=await rg(t,R,E,n,r.config,i),b=!1,s.set(e,E),E.filename=e,A){await R.writable.getWriter().close();let y=await R.getData();await l,await f(),T=!0,c||(y=await cg(E,y,W,i)),await D(W),E.diskNumberStart=h.diskNumber,L=h.diskOffset,await y.stream().pipeTo(W,{preventClose:!0,preventAbort:!0,signal:_}),W.size+=y.size,T=!1}if(E.offset=r.offset-L,E.zip64)dg(E,i);else if(E.offset>=bi)throw new Error(Rh);return r.offset+=E.length,E}catch(l){if(A&&T||!A&&b){if(r.hasCorruptedEntries=!0,l)try{l.corruptedEntry=!0}catch{}A?r.offset+=R.writable.size:r.offset=R.writable.size}throw s.delete(e),l}finally{A&&r.bufferedWrites--,k&&k(),C&&C()}function V(){E.lock=new Promise(l=>k=l)}async function f(){r.writerLocked=!0;const{lockWriter:l}=r;r.lockWriter=new Promise(W=>C=()=>{r.writerLocked=!1,W()}),await l}async function D(l){m.localHeaderArray.length>h.availableSize&&(h.availableSize=0,await As(l,new Uint8Array))}}async function rg(r,e,{diskNumberStart:t,lock:n},i,s,h){const{headerInfo:d,dataDescriptorInfo:c,metadataSize:_}=i,{localHeaderArray:m,headerArray:g,lastModDate:S,rawLastModDate:E,encrypted:A,compressed:C,version:k,compressionMethod:T,rawExtraFieldExtendedTimestamp:b,extraFieldExtendedTimestampFlag:R,rawExtraFieldNTFS:V,rawExtraFieldAES:f}=d,{dataDescriptorArray:D}=c,{rawFilename:l,lastAccessDate:W,creationDate:L,password:P,level:y,zip64:O,zip64UncompressedSize:B,zip64CompressedSize:v,zip64Offset:H,zip64DiskNumberStart:N,zipCrypto:te,dataDescriptor:G,directory:se,versionMadeBy:M,rawComment:F,rawExtraField:Z,useWebWorkers:ee,onstart:ue,onprogress:Pe,onend:_e,signal:ke,encryptionStrength:Ne,extendedTimestamp:Be,msDosCompatible:pe,internalFileAttribute:Oe,externalFileAttribute:nt,useCompressionStream:Ve}=h,ot={lock:n,versionMadeBy:M,zip64:O,directory:!!se,filenameUTF8:!0,rawFilename:l,commentUTF8:!0,rawComment:F,rawExtraFieldExtendedTimestamp:b,rawExtraFieldNTFS:V,rawExtraFieldAES:f,rawExtraField:Z,extendedTimestamp:Be,msDosCompatible:pe,internalFileAttribute:Oe,externalFileAttribute:nt,diskNumberStart:t};let Ge=0,lt=0,dt;const{writable:St}=e;if(r){r.chunkSize=z1(s),await As(St,m);const Tt=r.readable,Ct=Tt.size=r.size,kt={options:{codecType:Gu,level:y,password:P,encryptionStrength:Ne,zipCrypto:A&&te,passwordVerification:A&&te&&E>>8&255,signed:!0,compressed:C,encrypted:A,useWebWorkers:ee,useCompressionStream:Ve,transferStreams:!1},config:s,streamOptions:{signal:ke,size:Ct,onstart:ue,onprogress:Pe,onend:_e}},bt=await Mm({readable:Tt,writable:St},kt);St.size+=bt.size,dt=bt.signature,lt=r.size=Tt.size,Ge=bt.size}else await As(St,m);let Mt;if(O){let Tt=4;B&&(Tt+=8),v&&(Tt+=8),H&&(Tt+=8),N&&(Tt+=4),Mt=new Uint8Array(Tt)}else Mt=new Uint8Array;return hg({signature:dt,rawExtraFieldZip64:Mt,compressedSize:Ge,uncompressedSize:lt,headerInfo:d,dataDescriptorInfo:c},h),G&&await As(St,D),Object.assign(ot,{uncompressedSize:lt,compressedSize:Ge,lastModDate:S,rawLastModDate:E,creationDate:L,lastAccessDate:W,encrypted:A,length:_+Ge,compressionMethod:T,version:k,headerArray:g,signature:dt,rawExtraFieldZip64:Mt,extraFieldExtendedTimestampFlag:R,zip64UncompressedSize:B,zip64CompressedSize:v,zip64Offset:H,zip64DiskNumberStart:N}),ot}function og(r){const{rawFilename:e,lastModDate:t,lastAccessDate:n,creationDate:i,password:s,level:h,zip64:d,zipCrypto:c,dataDescriptor:_,directory:m,rawExtraField:g,encryptionStrength:S,extendedTimestamp:E}=r,A=h!==0&&!m,C=!!(s&&Jt(s));let k=r.version,T;if(C&&!c){T=new Uint8Array(Jt(Pd)+2);const N=$n(T);$t(N,0,A1),In(T,Pd,2),qa(N,8,S)}else T=new Uint8Array;let b,R,V;if(E){R=new Uint8Array(9+(n?4:0)+(i?4:0));const N=$n(R);$t(N,0,Pu),$t(N,2,Jt(R)-4),V=1+(n?2:0)+(i?4:0),qa(N,4,V);let te=5;Ot(N,te,Math.floor(t.getTime()/1e3)),te+=4,n&&(Ot(N,te,Math.floor(n.getTime()/1e3)),te+=4),i&&Ot(N,te,Math.floor(i.getTime()/1e3));try{b=new Uint8Array(36);const G=$n(b),se=zl(t);$t(G,0,R1),$t(G,2,32),$t(G,8,L1),$t(G,10,24),vi(G,12,se),vi(G,20,zl(n)||se),vi(G,28,zl(i)||se)}catch{b=new Uint8Array}}else b=R=new Uint8Array;let f=O1;_&&(f=f|F1);let D=x1;A&&(D=ad),d&&(k=k>ld?k:ld),C&&(f=f|D1,c||(k=k>hd?k:hd,D=S1,A&&(T[9]=ad)));const l=new Uint8Array(26),W=$n(l);$t(W,0,k),$t(W,2,f),$t(W,4,D);const L=new Uint32Array(1),P=$n(L);let y;t<dd?y=dd:t>cd?y=cd:y=t,$t(P,0,(y.getHours()<<6|y.getMinutes())<<5|y.getSeconds()/2),$t(P,2,(y.getFullYear()-1980<<4|y.getMonth()+1)<<5|y.getDate());const O=L[0];Ot(W,6,O),$t(W,22,Jt(e));const B=Jt(T,R,b,g);$t(W,24,B);const v=new Uint8Array(30+Jt(e)+B),H=$n(v);return Ot(H,0,C1),In(v,l,4),In(v,e,30),In(v,T,30+Jt(e)),In(v,R,30+Jt(e,T)),In(v,b,30+Jt(e,T,R)),In(v,g,30+Jt(e,T,R,b)),{localHeaderArray:v,headerArray:l,headerView:W,lastModDate:t,rawLastModDate:O,encrypted:C,compressed:A,version:k,compressionMethod:D,extraFieldExtendedTimestampFlag:V,rawExtraFieldExtendedTimestamp:R,rawExtraFieldNTFS:b,rawExtraFieldAES:T,extraFieldLength:B}}function ag(r,e){const{headerInfo:t}=r;let{localHeaderArray:n,extraFieldLength:i}=t,s=$n(n),h=64-(e+n.length)%64;h<4&&(h+=64);const d=new Uint8Array(h),c=$n(d);$t(c,0,N1),$t(c,2,h-2);const _=n;t.localHeaderArray=n=new Uint8Array(_.length+h),In(n,_),In(n,d,_.length),s=$n(n),$t(s,28,i+h),r.metadataSize+=h}function lg(r){const{zip64:e,dataDescriptor:t,dataDescriptorSignature:n}=r;let i=new Uint8Array,s,h=0;return t&&(i=new Uint8Array(e?n?24:20:n?16:12),s=$n(i),n&&(h=4,Ot(s,0,k1))),{dataDescriptorArray:i,dataDescriptorView:s,dataDescriptorOffset:h}}function hg(r,e){const{signature:t,rawExtraFieldZip64:n,compressedSize:i,uncompressedSize:s,headerInfo:h,dataDescriptorInfo:d}=r,{headerView:c,encrypted:_}=h,{dataDescriptorView:m,dataDescriptorOffset:g}=d,{zip64:S,zip64UncompressedSize:E,zip64CompressedSize:A,zipCrypto:C,dataDescriptor:k}=e;if((!_||C)&&t!==ri&&(Ot(c,10,t),k&&Ot(m,g,t)),S){const T=$n(n);$t(T,0,I1),$t(T,2,n.length-4);let b=4;E&&(Ot(c,18,bi),vi(T,b,BigInt(s)),b+=8),A&&(Ot(c,14,bi),vi(T,b,BigInt(i))),k&&(vi(m,g+4,BigInt(i)),vi(m,g+12,BigInt(s)))}else Ot(c,14,i),Ot(c,18,s),k&&(Ot(m,g+4,i),Ot(m,g+8,s))}async function cg(r,e,t,{zipCrypto:n}){let i;i=await e.slice(0,26).arrayBuffer(),i.byteLength!=26&&(i=i.slice(0,26));const s=new DataView(i);return(!r.encrypted||n)&&Ot(s,14,r.signature),r.zip64?(Ot(s,18,bi),Ot(s,22,bi)):(Ot(s,18,r.compressedSize),Ot(s,22,r.uncompressedSize)),await As(t,new Uint8Array(i)),e.slice(i.byteLength)}function dg(r,e){const{rawExtraFieldZip64:t,offset:n,diskNumberStart:i}=r,{zip64UncompressedSize:s,zip64CompressedSize:h,zip64Offset:d,zip64DiskNumberStart:c}=e,_=$n(t);let m=4;s&&(m+=8),h&&(m+=8),d&&(vi(_,m,BigInt(n)),m+=8),c&&Ot(_,m,i)}async function ug(r,e,t){const{files:n,writer:i}=r,{diskOffset:s,writable:h}=i;let{diskNumber:d}=i,c=0,_=0,m=r.offset-s,g=n.size;for(const[,f]of n){const{rawFilename:D,rawExtraFieldZip64:l,rawExtraFieldAES:W,rawComment:L,rawExtraFieldNTFS:P,rawExtraField:y,extendedTimestamp:O,extraFieldExtendedTimestampFlag:B,lastModDate:v}=f;let H;if(O){H=new Uint8Array(9);const N=$n(H);$t(N,0,Pu),$t(N,2,5),qa(N,4,B),Ot(N,5,Math.floor(v.getTime()/1e3))}else H=new Uint8Array;f.rawExtraFieldCDExtendedTimestamp=H,_+=46+Jt(D,L,l,W,P,H,y)}const S=new Uint8Array(_),E=$n(S);await Xo(i);let A=0;for(const[f,D]of Array.from(n.values()).entries()){const{offset:l,rawFilename:W,rawExtraFieldZip64:L,rawExtraFieldAES:P,rawExtraFieldCDExtendedTimestamp:y,rawExtraFieldNTFS:O,rawExtraField:B,rawComment:v,versionMadeBy:H,headerArray:N,directory:te,zip64:G,zip64UncompressedSize:se,zip64CompressedSize:M,zip64DiskNumberStart:F,zip64Offset:Z,msDosCompatible:ee,internalFileAttribute:ue,externalFileAttribute:Pe,diskNumberStart:_e,uncompressedSize:ke,compressedSize:Ne}=D,Be=Jt(L,P,y,O,B);Ot(E,c,P1),$t(E,c+4,H);const pe=$n(N);se||Ot(pe,18,ke),M||Ot(pe,14,Ne),In(S,N,c+6),$t(E,c+30,Be),$t(E,c+32,Jt(v)),$t(E,c+34,G&&F?gi:_e),$t(E,c+36,ue),Pe?Ot(E,c+38,Pe):te&&ee&&qa(E,c+38,H1),Ot(E,c+42,G&&Z?bi:l),In(S,W,c+46),In(S,L,c+46+Jt(W)),In(S,P,c+46+Jt(W,L)),In(S,y,c+46+Jt(W,L,P)),In(S,O,c+46+Jt(W,L,P,y)),In(S,B,c+46+Jt(W,L,P,y,O)),In(S,v,c+46+Jt(W)+Be);const Oe=46+Jt(W,v)+Be;if(c-A>i.availableSize&&(i.availableSize=0,await As(h,S.slice(A,c)),A=c),c+=Oe,t.onprogress)try{await t.onprogress(f+1,n.size,new r0(D))}catch{}}await As(h,A?S.slice(A):S);let C=i.diskNumber;const{availableSize:k}=i;k<ph&&C++;let T=ln(r,t,"zip64");if(m>=bi||_>=bi||g>=gi||C>=gi){if(T===!1)throw new Error(Rh);T=!0}const b=new Uint8Array(T?T1:ph),R=$n(b);c=0,T&&(Ot(R,0,B1),vi(R,4,BigInt(44)),$t(R,12,45),$t(R,14,45),Ot(R,16,C),Ot(R,20,d),vi(R,24,BigInt(g)),vi(R,32,BigInt(g)),vi(R,40,BigInt(_)),vi(R,48,BigInt(m)),Ot(R,56,M1),vi(R,64,BigInt(m)+BigInt(_)),Ot(R,72,C+1),ln(r,t,"supportZip64SplitFile",!0)&&(C=gi,d=gi),g=gi,m=bi,_=bi,c+=ku+Cu),Ot(R,c,E1),$t(R,c+4,C),$t(R,c+6,d),$t(R,c+8,g),$t(R,c+10,g),Ot(R,c+12,_),Ot(R,c+16,m);const V=Jt(e);if(V)if(V<=gi)$t(R,c+20,V);else throw new Error(Gm);await As(h,b),V&&await As(h,e)}async function As(r,e){const t=r.getWriter();await t.ready,r.size+=Jt(e),await t.write(e),t.releaseLock()}function zl(r){if(r)return(BigInt(r.getTime())+BigInt(116444736e5))*BigInt(1e4)}function ln(r,e,t,n){const i=e[t]===ri?r.options[t]:e[t];return i===ri?n:i}function fg(r){return r+5*(Math.floor(r/16383)+1)}function qa(r,e,t){r.setUint8(e,t)}function $t(r,e,t){r.setUint16(e,t,!0)}function Ot(r,e,t){r.setUint32(e,t,!0)}function vi(r,e,t){r.setBigUint64(e,t,!0)}function In(r,e,t){r.set(e,t)}function $n(r){return new DataView(r.buffer)}function Jt(...r){let e=0;return r.forEach(t=>t&&(e+=t.length)),e}let o0;try{o0=import.meta.url}catch{}Mh({baseURL:o0});Tm(Mh);Mh({Deflate:e1,Inflate:w1});var Lh={};function pg(r){return new Int8Array(r)}function a0(r){return new Int16Array(r)}function l0(r){return new Int32Array(r)}function h0(r){return new Float32Array(r)}function _g(r){return new Float64Array(r)}function c0(r){if(r.length==1)return h0(r[0]);var e=r[0];r=r.slice(1);for(var t=[],n=0;n<e;n++)t.push(c0(r));return t}function d0(r){if(r.length==1)return l0(r[0]);var e=r[0];r=r.slice(1);for(var t=[],n=0;n<e;n++)t.push(d0(r));return t}function u0(r){if(r.length==1)return a0(r[0]);var e=r[0];r=r.slice(1);for(var t=[],n=0;n<e;n++)t.push(u0(r));return t}function f0(r){if(r.length==1)return new Array(r[0]);var e=r[0];r=r.slice(1);for(var t=[],n=0;n<e;n++)t.push(f0(r));return t}var p0={};p0.fill=function(r,e,t,n){if(arguments.length==2)for(var i=0;i<r.length;i++)r[i]=arguments[1];else for(var i=e;i<t;i++)r[i]=n};var Ko={};Ko.arraycopy=function(r,e,t,n,i){for(var s=e+i;e<s;)t[n++]=r[e++]};Ko.out={};Ko.out.println=function(r){console.log(r)};Ko.out.printf=function(){console.log.apply(console,arguments)};var Qa={};Qa.SQRT2=1.4142135623730951;Qa.FAST_LOG10=function(r){return Math.log10(r)};Qa.FAST_LOG10_X=function(r,e){return Math.log10(r)*e};function $s(r){this.ordinal=r}$s.short_block_allowed=new $s(0);$s.short_block_coupled=new $s(1);$s.short_block_dispensed=new $s(2);$s.short_block_forced=new $s(3);var _0={};_0.MAX_VALUE=34028235e31;function Yi(r){this.ordinal=r}Yi.vbr_off=new Yi(0);Yi.vbr_mt=new Yi(1);Yi.vbr_rh=new Yi(2);Yi.vbr_abr=new Yi(3);Yi.vbr_mtrh=new Yi(4);Yi.vbr_default=Yi.vbr_mtrh;var mg=function(r){},fn={System:Ko,VbrMode:Yi,Float:_0,ShortBlock:$s,Util:Qa,Arrays:p0,new_array_n:f0,new_byte:pg,new_double:_g,new_float:h0,new_float_n:c0,new_int:l0,new_int_n:d0,new_short:a0,new_short_n:u0,assert:mg},Xl,Bd;function gg(){if(Bd)return Xl;Bd=1;var r=fn,e=r.System;r.VbrMode,r.Float,r.ShortBlock;var t=r.Util,n=r.Arrays;r.new_array_n,r.new_byte,r.new_double;var i=r.new_float;r.new_float_n,r.new_int,r.new_int_n,r.assert;var s=Qn();function h(){var d=[-.1482523854003001,32.308141959636465,296.40344946382766,883.1344870032432,11113.947376231741,1057.2713659324597,305.7402417275812,30.825928907280012,3.8533188138216365,59.42900443849514,709.5899960123345,5281.91112291017,-5829.66483675846,-817.6293103748613,-76.91656988279972,-4.594269939176596,.9063471690191471,.1960342806591213,-.15466694054279598,34.324387823855965,301.8067566458425,817.599602898885,11573.795901679885,1181.2520595540152,321.59731579894424,31.232021761053772,3.7107095756221318,53.650946155329365,684.167428119626,5224.56624370173,-6366.391851890084,-908.9766368219582,-89.83068876699639,-5.411397422890401,.8206787908286602,.3901806440322567,-.16070888947830023,36.147034243915876,304.11815768187864,732.7429163887613,11989.60988270091,1300.012278487897,335.28490093152146,31.48816102859945,3.373875931311736,47.232241542899175,652.7371796173471,5132.414255594984,-6909.087078780055,-1001.9990371107289,-103.62185754286375,-6.104916304710272,.7416505462720353,.5805693545089249,-.16636367662261495,37.751650073343995,303.01103387567713,627.9747488785183,12358.763425278165,1412.2779918482834,346.7496836825721,31.598286663170416,3.1598635433980946,40.57878626349686,616.1671130880391,5007.833007176154,-7454.040671756168,-1095.7960341867115,-118.24411666465777,-6.818469345853504,.6681786379192989,.7653668647301797,-.1716176790982088,39.11551877123304,298.3413246578966,503.5259106886539,12679.589408408976,1516.5821921214542,355.9850766329023,31.395241710249053,2.9164211881972335,33.79716964664243,574.8943997801362,4853.234992253242,-7997.57021486075,-1189.7624067269965,-133.6444792601766,-7.7202770609839915,.5993769336819237,.9427934736519954,-.17645823955292173,40.21879108166477,289.9982036694474,359.3226160751053,12950.259102786438,1612.1013903507662,362.85067106591504,31.045922092242872,2.822222032597987,26.988862316190684,529.8996541764288,4671.371946949588,-8535.899136645805,-1282.5898586244496,-149.58553632943463,-8.643494270763135,.5345111359507916,1.111140466039205,-.36174739330527045,41.04429910497807,277.5463268268618,195.6386023135583,13169.43812144731,1697.6433561479398,367.40983966190305,30.557037410382826,2.531473372857427,20.070154905927314,481.50208566532336,4464.970341588308,-9065.36882077239,-1373.62841526722,-166.1660487028118,-9.58289321133207,.4729647758913199,1.268786568327291,-.36970682634889585,41.393213350082036,261.2935935556502,12.935476055240873,13336.131683328815,1772.508612059496,369.76534388639965,29.751323653701338,2.4023193045459172,13.304795348228817,430.5615775526625,4237.0568611071185,-9581.931701634761,-1461.6913552409758,-183.12733958476446,-10.718010163869403,.41421356237309503,1.414213562373095,-.37677560326535325,41.619486213528496,241.05423794991074,-187.94665032361226,13450.063605744153,1836.153896465782,369.4908799925761,29.001847876923147,2.0714759319987186,6.779591200894186,377.7767837205709,3990.386575512536,-10081.709459700915,-1545.947424837898,-200.3762958015653,-11.864482073055006,.3578057213145241,1.546020906725474,-.3829366947518991,41.1516456456653,216.47684307105183,-406.1569483347166,13511.136535077321,1887.8076599260432,367.3025214564151,28.136213436723654,1.913880671464418,.3829366947518991,323.85365704338597,3728.1472257487526,-10561.233882199509,-1625.2025997821418,-217.62525175416,-13.015432208941645,.3033466836073424,1.66293922460509,-.5822628872992417,40.35639251440489,188.20071124269245,-640.2706748618148,13519.21490106562,1927.6022433578062,362.8197642637487,26.968821921868447,1.7463817695935329,-5.62650678237171,269.3016715297017,3453.386536448852,-11016.145278780888,-1698.6569643425091,-234.7658734267683,-14.16351421663124,.2504869601913055,1.76384252869671,-.5887180101749253,39.23429103868072,155.76096234403798,-889.2492977967378,13475.470561874661,1955.0535223723712,356.4450994756727,25.894952980042156,1.5695032905781554,-11.181939564328772,214.80884394039484,3169.1640829158237,-11443.321309975563,-1765.1588461316153,-251.68908574481912,-15.49755935939164,.198912367379658,1.847759065022573,-.7912582233652842,37.39369355329111,119.699486012458,-1151.0956593239027,13380.446257078214,1970.3952110853447,348.01959814116185,24.731487364283044,1.3850130831637748,-16.421408865300393,161.05030052864092,2878.3322807850063,-11838.991423510031,-1823.985884688674,-268.2854986386903,-16.81724543849939,.1483359875383474,1.913880671464418,-.7960642926861912,35.2322109610459,80.01928065061526,-1424.0212633405113,13235.794061869668,1973.804052543835,337.9908651258184,23.289159354463873,1.3934255946442087,-21.099669467133474,108.48348407242611,2583.700758091299,-12199.726194855148,-1874.2780658979746,-284.2467154529415,-18.11369784385905,.09849140335716425,1.961570560806461,-.998795456205172,32.56307803611191,36.958364584370486,-1706.075448829146,13043.287458812016,1965.3831106103316,326.43182772364605,22.175018750622293,1.198638339011324,-25.371248002043963,57.53505923036915,2288.41886619975,-12522.674544337233,-1914.8400385312243,-299.26241273417224,-19.37805630698734,.04912684976946725,1.990369453344394,.035780907*t.SQRT2*.5/2384e-9,.017876148*t.SQRT2*.5/2384e-9,.003134727*t.SQRT2*.5/2384e-9,.002457142*t.SQRT2*.5/2384e-9,971317e-9*t.SQRT2*.5/2384e-9,218868e-9*t.SQRT2*.5/2384e-9,101566e-9*t.SQRT2*.5/2384e-9,13828e-9*t.SQRT2*.5/2384e-9,12804.797818791945,1945.5515939597317,313.4244966442953,20.801593959731544,1995.1556208053692,9.000838926174497,-29.20218120805369],c=12,_=36,m=[[2382191739347913e-28,6423305872147834e-28,9400849094049688e-28,1122435026096556e-27,1183840321267481e-27,1122435026096556e-27,940084909404969e-27,6423305872147839e-28,2382191739347918e-28,5456116108943412e-27,4878985199565852e-27,4240448995017367e-27,3559909094758252e-27,2858043359288075e-27,2156177623817898e-27,1475637723558783e-27,8371015190102974e-28,2599706096327376e-28,-5456116108943412e-27,-4878985199565852e-27,-4240448995017367e-27,-3559909094758252e-27,-2858043359288076e-27,-2156177623817898e-27,-1475637723558783e-27,-8371015190102975e-28,-2599706096327376e-28,-2382191739347923e-28,-6423305872147843e-28,-9400849094049696e-28,-1122435026096556e-27,-1183840321267481e-27,-1122435026096556e-27,-9400849094049694e-28,-642330587214784e-27,-2382191739347918e-28],[2382191739347913e-28,6423305872147834e-28,9400849094049688e-28,1122435026096556e-27,1183840321267481e-27,1122435026096556e-27,9400849094049688e-28,6423305872147841e-28,2382191739347918e-28,5456116108943413e-27,4878985199565852e-27,4240448995017367e-27,3559909094758253e-27,2858043359288075e-27,2156177623817898e-27,1475637723558782e-27,8371015190102975e-28,2599706096327376e-28,-5461314069809755e-27,-4921085770524055e-27,-4343405037091838e-27,-3732668368707687e-27,-3093523840190885e-27,-2430835727329465e-27,-1734679010007751e-27,-974825365660928e-27,-2797435120168326e-28,0,0,0,0,0,0,-2283748241799531e-28,-4037858874020686e-28,-2146547464825323e-28],[.1316524975873958,.414213562373095,.7673269879789602,1.091308501069271,1.303225372841206,1.56968557711749,1.920982126971166,2.414213562373094,3.171594802363212,4.510708503662055,7.595754112725146,22.90376554843115,.984807753012208,.6427876096865394,.3420201433256688,.9396926207859084,-.1736481776669303,-.7660444431189779,.8660254037844387,.5,-.5144957554275265,-.4717319685649723,-.3133774542039019,-.1819131996109812,-.09457419252642064,-.04096558288530405,-.01419856857247115,-.003699974673760037,.8574929257125442,.8817419973177052,.9496286491027329,.9833145924917901,.9955178160675857,.9991605581781475,.999899195244447,.9999931550702802],[0,0,0,0,0,0,2283748241799531e-28,4037858874020686e-28,2146547464825323e-28,5461314069809755e-27,4921085770524055e-27,4343405037091838e-27,3732668368707687e-27,3093523840190885e-27,2430835727329466e-27,1734679010007751e-27,974825365660928e-27,2797435120168326e-28,-5456116108943413e-27,-4878985199565852e-27,-4240448995017367e-27,-3559909094758253e-27,-2858043359288075e-27,-2156177623817898e-27,-1475637723558782e-27,-8371015190102975e-28,-2599706096327376e-28,-2382191739347913e-28,-6423305872147834e-28,-9400849094049688e-28,-1122435026096556e-27,-1183840321267481e-27,-1122435026096556e-27,-9400849094049688e-28,-6423305872147841e-28,-2382191739347918e-28]],g=m[s.SHORT_TYPE],S=m[s.SHORT_TYPE],E=m[s.SHORT_TYPE],A=m[s.SHORT_TYPE],C=[0,1,16,17,8,9,24,25,4,5,20,21,12,13,28,29,2,3,18,19,10,11,26,27,6,7,22,23,14,15,30,31];function k(R,V,f){for(var D=10,l=V+238-14-286,W=-15;W<0;W++){var L,P,y;L=d[D+-10],P=R[l+-224]*L,y=R[V+224]*L,L=d[D+-9],P+=R[l+-160]*L,y+=R[V+160]*L,L=d[D+-8],P+=R[l+-96]*L,y+=R[V+96]*L,L=d[D+-7],P+=R[l+-32]*L,y+=R[V+32]*L,L=d[D+-6],P+=R[l+32]*L,y+=R[V+-32]*L,L=d[D+-5],P+=R[l+96]*L,y+=R[V+-96]*L,L=d[D+-4],P+=R[l+160]*L,y+=R[V+-160]*L,L=d[D+-3],P+=R[l+224]*L,y+=R[V+-224]*L,L=d[D+-2],P+=R[V+-256]*L,y-=R[l+256]*L,L=d[D+-1],P+=R[V+-192]*L,y-=R[l+192]*L,L=d[D+0],P+=R[V+-128]*L,y-=R[l+128]*L,L=d[D+1],P+=R[V+-64]*L,y-=R[l+64]*L,L=d[D+2],P+=R[V+0]*L,y-=R[l+0]*L,L=d[D+3],P+=R[V+64]*L,y-=R[l+-64]*L,L=d[D+4],P+=R[V+128]*L,y-=R[l+-128]*L,L=d[D+5],P+=R[V+192]*L,y-=R[l+-192]*L,P*=d[D+6],L=y-P,f[30+W*2]=y+P,f[31+W*2]=d[D+7]*L,D+=18,V--,l++}{var P,y,O,B;y=R[V+-16]*d[D+-10],P=R[V+-32]*d[D+-2],y+=(R[V+-48]-R[V+16])*d[D+-9],P+=R[V+-96]*d[D+-1],y+=(R[V+-80]+R[V+48])*d[D+-8],P+=R[V+-160]*d[D+0],y+=(R[V+-112]-R[V+80])*d[D+-7],P+=R[V+-224]*d[D+1],y+=(R[V+-144]+R[V+112])*d[D+-6],P-=R[V+32]*d[D+2],y+=(R[V+-176]-R[V+144])*d[D+-5],P-=R[V+96]*d[D+3],y+=(R[V+-208]+R[V+176])*d[D+-4],P-=R[V+160]*d[D+4],y+=(R[V+-240]-R[V+208])*d[D+-3],P-=R[V+224],O=P-y,B=P+y,y=f[14],P=f[15]-y,f[31]=B+y,f[30]=O+P,f[15]=O-P,f[14]=B-y}{var v;v=f[28]-f[0],f[0]+=f[28],f[28]=v*d[D+-2*18+7],v=f[29]-f[1],f[1]+=f[29],f[29]=v*d[D+-2*18+7],v=f[26]-f[2],f[2]+=f[26],f[26]=v*d[D+-4*18+7],v=f[27]-f[3],f[3]+=f[27],f[27]=v*d[D+-4*18+7],v=f[24]-f[4],f[4]+=f[24],f[24]=v*d[D+-6*18+7],v=f[25]-f[5],f[5]+=f[25],f[25]=v*d[D+-6*18+7],v=f[22]-f[6],f[6]+=f[22],f[22]=v*t.SQRT2,v=f[23]-f[7],f[7]+=f[23],f[23]=v*t.SQRT2-f[7],f[7]-=f[6],f[22]-=f[7],f[23]-=f[22],v=f[6],f[6]=f[31]-v,f[31]=f[31]+v,v=f[7],f[7]=f[30]-v,f[30]=f[30]+v,v=f[22],f[22]=f[15]-v,f[15]=f[15]+v,v=f[23],f[23]=f[14]-v,f[14]=f[14]+v,v=f[20]-f[8],f[8]+=f[20],f[20]=v*d[D+-10*18+7],v=f[21]-f[9],f[9]+=f[21],f[21]=v*d[D+-10*18+7],v=f[18]-f[10],f[10]+=f[18],f[18]=v*d[D+-12*18+7],v=f[19]-f[11],f[11]+=f[19],f[19]=v*d[D+-12*18+7],v=f[16]-f[12],f[12]+=f[16],f[16]=v*d[D+-14*18+7],v=f[17]-f[13],f[13]+=f[17],f[17]=v*d[D+-14*18+7],v=-f[20]+f[24],f[20]+=f[24],f[24]=v*d[D+-12*18+7],v=-f[21]+f[25],f[21]+=f[25],f[25]=v*d[D+-12*18+7],v=f[4]-f[8],f[4]+=f[8],f[8]=v*d[D+-12*18+7],v=f[5]-f[9],f[5]+=f[9],f[9]=v*d[D+-12*18+7],v=f[0]-f[12],f[0]+=f[12],f[12]=v*d[D+-4*18+7],v=f[1]-f[13],f[1]+=f[13],f[13]=v*d[D+-4*18+7],v=f[16]-f[28],f[16]+=f[28],f[28]=v*d[D+-4*18+7],v=-f[17]+f[29],f[17]+=f[29],f[29]=v*d[D+-4*18+7],v=t.SQRT2*(f[2]-f[10]),f[2]+=f[10],f[10]=v,v=t.SQRT2*(f[3]-f[11]),f[3]+=f[11],f[11]=v,v=t.SQRT2*(-f[18]+f[26]),f[18]+=f[26],f[26]=v-f[18],v=t.SQRT2*(-f[19]+f[27]),f[19]+=f[27],f[27]=v-f[19],v=f[2],f[19]-=f[3],f[3]-=v,f[2]=f[31]-v,f[31]+=v,v=f[3],f[11]-=f[19],f[18]-=v,f[3]=f[30]-v,f[30]+=v,v=f[18],f[27]-=f[11],f[19]-=v,f[18]=f[15]-v,f[15]+=v,v=f[19],f[10]-=v,f[19]=f[14]-v,f[14]+=v,v=f[10],f[11]-=v,f[10]=f[23]-v,f[23]+=v,v=f[11],f[26]-=v,f[11]=f[22]-v,f[22]+=v,v=f[26],f[27]-=v,f[26]=f[7]-v,f[7]+=v,v=f[27],f[27]=f[6]-v,f[6]+=v,v=t.SQRT2*(f[0]-f[4]),f[0]+=f[4],f[4]=v,v=t.SQRT2*(f[1]-f[5]),f[1]+=f[5],f[5]=v,v=t.SQRT2*(f[16]-f[20]),f[16]+=f[20],f[20]=v,v=t.SQRT2*(f[17]-f[21]),f[17]+=f[21],f[21]=v,v=-t.SQRT2*(f[8]-f[12]),f[8]+=f[12],f[12]=v-f[8],v=-t.SQRT2*(f[9]-f[13]),f[9]+=f[13],f[13]=v-f[9],v=-t.SQRT2*(f[25]-f[29]),f[25]+=f[29],f[29]=v-f[25],v=-t.SQRT2*(f[24]+f[28]),f[24]-=f[28],f[28]=v-f[24],v=f[24]-f[16],f[24]=v,v=f[20]-v,f[20]=v,v=f[28]-v,f[28]=v,v=f[25]-f[17],f[25]=v,v=f[21]-v,f[21]=v,v=f[29]-v,f[29]=v,v=f[17]-f[1],f[17]=v,v=f[9]-v,f[9]=v,v=f[25]-v,f[25]=v,v=f[5]-v,f[5]=v,v=f[21]-v,f[21]=v,v=f[13]-v,f[13]=v,v=f[29]-v,f[29]=v,v=f[1]-f[0],f[1]=v,v=f[16]-v,f[16]=v,v=f[17]-v,f[17]=v,v=f[8]-v,f[8]=v,v=f[9]-v,f[9]=v,v=f[24]-v,f[24]=v,v=f[25]-v,f[25]=v,v=f[4]-v,f[4]=v,v=f[5]-v,f[5]=v,v=f[20]-v,f[20]=v,v=f[21]-v,f[21]=v,v=f[12]-v,f[12]=v,v=f[13]-v,f[13]=v,v=f[28]-v,f[28]=v,v=f[29]-v,f[29]=v,v=f[0],f[0]+=f[31],f[31]-=v,v=f[1],f[1]+=f[30],f[30]-=v,v=f[16],f[16]+=f[15],f[15]-=v,v=f[17],f[17]+=f[14],f[14]-=v,v=f[8],f[8]+=f[23],f[23]-=v,v=f[9],f[9]+=f[22],f[22]-=v,v=f[24],f[24]+=f[7],f[7]-=v,v=f[25],f[25]+=f[6],f[6]-=v,v=f[4],f[4]+=f[27],f[27]-=v,v=f[5],f[5]+=f[26],f[26]-=v,v=f[20],f[20]+=f[11],f[11]-=v,v=f[21],f[21]+=f[10],f[10]-=v,v=f[12],f[12]+=f[19],f[19]-=v,v=f[13],f[13]+=f[18],f[18]-=v,v=f[28],f[28]+=f[3],f[3]-=v,v=f[29],f[29]+=f[2],f[2]-=v}}function T(R,V){for(var f=0;f<3;f++){var D,l,W,L,P,y;L=R[V+2*3]*m[s.SHORT_TYPE][0]-R[V+5*3],D=R[V+0*3]*m[s.SHORT_TYPE][2]-R[V+3*3],l=L+D,W=L-D,L=R[V+5*3]*m[s.SHORT_TYPE][0]+R[V+2*3],D=R[V+3*3]*m[s.SHORT_TYPE][2]+R[V+0*3],P=L+D,y=-L+D,D=(R[V+1*3]*m[s.SHORT_TYPE][1]-R[V+4*3])*2069978111953089e-26,L=(R[V+4*3]*m[s.SHORT_TYPE][1]+R[V+1*3])*2069978111953089e-26,R[V+3*0]=l*190752519173728e-25+D,R[V+3*5]=-P*190752519173728e-25+L,W=W*.8660254037844387*1907525191737281e-26,P=P*.5*1907525191737281e-26+L,R[V+3*1]=W-P,R[V+3*2]=W+P,l=l*.5*1907525191737281e-26-D,y=y*.8660254037844387*1907525191737281e-26,R[V+3*3]=l+y,R[V+3*4]=l-y,V++}}function b(R,V,f){var D,l;{var W,L,P,y,O,B,v,H;W=f[17]-f[9],P=f[15]-f[11],y=f[14]-f[12],O=f[0]+f[8],B=f[1]+f[7],v=f[2]+f[6],H=f[3]+f[5],R[V+17]=O+v-H-(B-f[4]),l=(O+v-H)*S[19]+(B-f[4]),D=(W-P-y)*S[18],R[V+5]=D+l,R[V+6]=D-l,L=(f[16]-f[10])*S[18],B=B*S[19]+f[4],D=W*S[12]+L+P*S[13]+y*S[14],l=-O*S[16]+B-v*S[17]+H*S[15],R[V+1]=D+l,R[V+2]=D-l,D=W*S[13]-L-P*S[14]+y*S[12],l=-O*S[17]+B-v*S[15]+H*S[16],R[V+9]=D+l,R[V+10]=D-l,D=W*S[14]-L+P*S[12]-y*S[13],l=O*S[15]-B+v*S[16]-H*S[17],R[V+13]=D+l,R[V+14]=D-l}{var N,te,G,se,M,F,Z,ee;N=f[8]-f[0],G=f[6]-f[2],se=f[5]-f[3],M=f[17]+f[9],F=f[16]+f[10],Z=f[15]+f[11],ee=f[14]+f[12],R[V+0]=M+Z+ee+(F+f[13]),D=(M+Z+ee)*S[19]-(F+f[13]),l=(N-G+se)*S[18],R[V+11]=D+l,R[V+12]=D-l,te=(f[7]-f[1])*S[18],F=f[13]-F*S[19],D=M*S[15]-F+Z*S[16]+ee*S[17],l=N*S[14]+te+G*S[12]+se*S[13],R[V+3]=D+l,R[V+4]=D-l,D=-M*S[17]+F-Z*S[15]-ee*S[16],l=N*S[13]+te-G*S[14]-se*S[12],R[V+7]=D+l,R[V+8]=D-l,D=-M*S[16]+F-Z*S[17]-ee*S[15],l=N*S[12]-te+G*S[13]-se*S[14],R[V+15]=D+l,R[V+16]=D-l}}this.mdct_sub48=function(R,V,f){for(var D=V,l=286,W=0;W<R.channels_out;W++){for(var L=0;L<R.mode_gr;L++){for(var P,y=R.l3_side.tt[L][W],O=y.xr,B=0,v=R.sb_sample[W][1-L],H=0,N=0;N<18/2;N++)for(k(D,l,v[H]),k(D,l+32,v[H+1]),H+=2,l+=64,P=1;P<32;P+=2)v[H-1][P]*=-1;for(P=0;P<32;P++,B+=18){var te=y.block_type,G=R.sb_sample[W][L],se=R.sb_sample[W][1-L];if(y.mixed_block_flag!=0&&P<2&&(te=0),R.amp_filter[P]<1e-12)n.fill(O,B+0,B+18,0);else{if(R.amp_filter[P]<1)for(var N=0;N<18;N++)se[N][C[P]]*=R.amp_filter[P];if(te==s.SHORT_TYPE){for(var N=-c/4;N<0;N++){var M=m[s.SHORT_TYPE][N+3];O[B+N*3+9]=G[9+N][C[P]]*M-G[8-N][C[P]],O[B+N*3+18]=G[14-N][C[P]]*M+G[15+N][C[P]],O[B+N*3+10]=G[15+N][C[P]]*M-G[14-N][C[P]],O[B+N*3+19]=se[2-N][C[P]]*M+se[3+N][C[P]],O[B+N*3+11]=se[3+N][C[P]]*M-se[2-N][C[P]],O[B+N*3+20]=se[8-N][C[P]]*M+se[9+N][C[P]]}T(O,B)}else{for(var F=i(18),N=-_/4;N<0;N++){var Z,ee;Z=m[te][N+27]*se[N+9][C[P]]+m[te][N+36]*se[8-N][C[P]],ee=m[te][N+9]*G[N+9][C[P]]-m[te][N+18]*G[8-N][C[P]],F[N+9]=Z-ee*g[3+N+9],F[N+18]=Z*g[3+N+9]+ee}b(O,B,F)}}if(te!=s.SHORT_TYPE&&P!=0)for(var N=7;N>=0;--N){var ue,Pe;ue=O[B+N]*E[20+N]+O[B+-1-N]*A[28+N],Pe=O[B+N]*A[28+N]-O[B+-1-N]*E[20+N],O[B+-1-N]=ue,O[B+N]=Pe}}}if(D=f,l=286,R.mode_gr==1)for(var _e=0;_e<18;_e++)e.arraycopy(R.sb_sample[W][1][_e],0,R.sb_sample[W][0][_e],0,32)}}}return Xl=h,Xl}var $l,Md;function m0(){if(Md)return $l;Md=1;var r=Qn(),e=fn,t=e.System;e.VbrMode,e.Float,e.ShortBlock,e.Util,e.Arrays,e.new_array_n,e.new_byte,e.new_double;var n=e.new_float,i=e.new_float_n;e.new_int,e.new_int_n,e.assert;function s(){this.l=n(r.SBMAX_l),this.s=i([r.SBMAX_s,3]);var h=this;this.assign=function(d){t.arraycopy(d.l,0,h.l,0,r.SBMAX_l);for(var c=0;c<r.SBMAX_s;c++)for(var _=0;_<3;_++)h.s[c][_]=d.s[c][_]}}return $l=s,$l}var Yl,Td;function vg(){if(Td)return Yl;Td=1;var r=m0();function e(){this.thm=new r,this.en=new r}return Yl=e,Yl}var jl,Id;function Qn(){if(Id)return jl;Id=1;var r=fn,e=r.System,t=r.VbrMode;r.Float,r.ShortBlock,r.Util,r.Arrays;var n=r.new_array_n;r.new_byte,r.new_double;var i=r.new_float,s=r.new_float_n,h=r.new_int;r.new_int_n;var d=r.assert;c.ENCDELAY=576,c.POSTDELAY=1152,c.MDCTDELAY=48,c.FFTOFFSET=224+c.MDCTDELAY,c.DECDELAY=528,c.SBLIMIT=32,c.CBANDS=64,c.SBPSY_l=21,c.SBPSY_s=12,c.SBMAX_l=22,c.SBMAX_s=13,c.PSFB21=6,c.PSFB12=6,c.BLKSIZE=1024,c.HBLKSIZE=c.BLKSIZE/2+1,c.BLKSIZE_s=256,c.HBLKSIZE_s=c.BLKSIZE_s/2+1,c.NORM_TYPE=0,c.START_TYPE=1,c.SHORT_TYPE=2,c.STOP_TYPE=3,c.MPG_MD_LR_LR=0,c.MPG_MD_LR_I=1,c.MPG_MD_MS_LR=2,c.MPG_MD_MS_I=3,c.fircoef=[-.0207887*5,-.0378413*5,-.0432472*5,-.031183*5,779609e-23*5,.0467745*5,.10091*5,.151365*5,.187098*5];function c(){var _=gg(),m=vg(),g=c.FFTOFFSET,S=c.MPG_MD_MS_LR,E=null;this.psy=null;var A=null,C=null,k=null;this.setModules=function(f,D,l,W){E=f,this.psy=D,A=D,C=W,k=l};var T=new _;function b(f){var D,l;if(f.ATH.useAdjust==0){f.ATH.adjust=1;return}if(l=f.loudness_sq[0][0],D=f.loudness_sq[1][0],f.channels_out==2?(l+=f.loudness_sq[0][1],D+=f.loudness_sq[1][1]):(l+=l,D+=D),f.mode_gr==2&&(l=Math.max(l,D)),l*=.5,l*=f.ATH.aaSensitivityP,l>.03125)f.ATH.adjust>=1?f.ATH.adjust=1:f.ATH.adjust<f.ATH.adjustLimit&&(f.ATH.adjust=f.ATH.adjustLimit),f.ATH.adjustLimit=1;else{var W=31.98*l+625e-6;f.ATH.adjust>=W?(f.ATH.adjust*=W*.075+.925,f.ATH.adjust<W&&(f.ATH.adjust=W)):f.ATH.adjustLimit>=W?f.ATH.adjust=W:f.ATH.adjust<f.ATH.adjustLimit&&(f.ATH.adjust=f.ATH.adjustLimit),f.ATH.adjustLimit=W}}function R(f){var D,l;for(d(0<=f.bitrate_index&&f.bitrate_index<16),d(0<=f.mode_ext&&f.mode_ext<4),f.bitrate_stereoMode_Hist[f.bitrate_index][4]++,f.bitrate_stereoMode_Hist[15][4]++,f.channels_out==2&&(f.bitrate_stereoMode_Hist[f.bitrate_index][f.mode_ext]++,f.bitrate_stereoMode_Hist[15][f.mode_ext]++),D=0;D<f.mode_gr;++D)for(l=0;l<f.channels_out;++l){var W=f.l3_side.tt[D][l].block_type|0;f.l3_side.tt[D][l].mixed_block_flag!=0&&(W=4),f.bitrate_blockType_Hist[f.bitrate_index][W]++,f.bitrate_blockType_Hist[f.bitrate_index][5]++,f.bitrate_blockType_Hist[15][W]++,f.bitrate_blockType_Hist[15][5]++}}function V(f,D){var l=f.internal_flags,W,L;if(l.lame_encode_frame_init==0){var P,y,O=i(2014),B=i(2014);for(l.lame_encode_frame_init=1,P=0,y=0;P<286+576*(1+l.mode_gr);++P)P<576*l.mode_gr?(O[P]=0,l.channels_out==2&&(B[P]=0)):(O[P]=D[0][y],l.channels_out==2&&(B[P]=D[1][y]),++y);for(L=0;L<l.mode_gr;L++)for(W=0;W<l.channels_out;W++)l.l3_side.tt[L][W].block_type=c.SHORT_TYPE;T.mdct_sub48(l,O,B),d(576>=c.FFTOFFSET),d(l.mf_size>=c.BLKSIZE+f.framesize-c.FFTOFFSET),d(l.mf_size>=512+f.framesize-32)}}this.lame_encode_mp3_frame=function(f,D,l,W,L,P){var y,O=n([2,2]);O[0][0]=new m,O[0][1]=new m,O[1][0]=new m,O[1][1]=new m;var B=n([2,2]);B[0][0]=new m,B[0][1]=new m,B[1][0]=new m,B[1][1]=new m;var v,H=[null,null],N=f.internal_flags,te=s([2,4]),G=[.5,.5],se=[[0,0],[0,0]],M=[[0,0],[0,0]],F,Z,ee;if(H[0]=D,H[1]=l,N.lame_encode_frame_init==0&&V(f,H),N.padding=0,(N.slot_lag-=N.frac_SpF)<0&&(N.slot_lag+=f.out_samplerate,N.padding=1),N.psymodel!=0){var ue,Pe=[null,null],_e=0,ke=h(2);for(ee=0;ee<N.mode_gr;ee++){for(Z=0;Z<N.channels_out;Z++)Pe[Z]=H[Z],_e=576+ee*576-c.FFTOFFSET;if(f.VBR==t.vbr_mtrh||f.VBR==t.vbr_mt?ue=A.L3psycho_anal_vbr(f,Pe,_e,ee,O,B,se[ee],M[ee],te[ee],ke):ue=A.L3psycho_anal_ns(f,Pe,_e,ee,O,B,se[ee],M[ee],te[ee],ke),ue!=0)return-4;for(f.mode==MPEGMode.JOINT_STEREO&&(G[ee]=te[ee][2]+te[ee][3],G[ee]>0&&(G[ee]=te[ee][3]/G[ee])),Z=0;Z<N.channels_out;Z++){var Ne=N.l3_side.tt[ee][Z];Ne.block_type=ke[Z],Ne.mixed_block_flag=0}}}else for(ee=0;ee<N.mode_gr;ee++)for(Z=0;Z<N.channels_out;Z++)N.l3_side.tt[ee][Z].block_type=c.NORM_TYPE,N.l3_side.tt[ee][Z].mixed_block_flag=0,M[ee][Z]=se[ee][Z]=700;if(b(N),T.mdct_sub48(N,H[0],H[1]),N.mode_ext=c.MPG_MD_LR_LR,f.force_ms)N.mode_ext=c.MPG_MD_MS_LR;else if(f.mode==MPEGMode.JOINT_STEREO){var Be=0,pe=0;for(ee=0;ee<N.mode_gr;ee++)for(Z=0;Z<N.channels_out;Z++)Be+=M[ee][Z],pe+=se[ee][Z];if(Be<=1*pe){var Oe=N.l3_side.tt[0],nt=N.l3_side.tt[N.mode_gr-1];Oe[0].block_type==Oe[1].block_type&&nt[0].block_type==nt[1].block_type&&(N.mode_ext=c.MPG_MD_MS_LR)}}if(N.mode_ext==S?(v=B,F=M):(v=O,F=se),f.analysis&&N.pinfo!=null)for(ee=0;ee<N.mode_gr;ee++)for(Z=0;Z<N.channels_out;Z++)N.pinfo.ms_ratio[ee]=N.ms_ratio[ee],N.pinfo.ms_ener_ratio[ee]=G[ee],N.pinfo.blocktype[ee][Z]=N.l3_side.tt[ee][Z].block_type,N.pinfo.pe[ee][Z]=F[ee][Z],e.arraycopy(N.l3_side.tt[ee][Z].xr,0,N.pinfo.xr[ee][Z],0,576),N.mode_ext==S&&(N.pinfo.ers[ee][Z]=N.pinfo.ers[ee][Z+2],e.arraycopy(N.pinfo.energy[ee][Z+2],0,N.pinfo.energy[ee][Z],0,N.pinfo.energy[ee][Z].length));if(f.VBR==t.vbr_off||f.VBR==t.vbr_abr){var Ve,ot;for(Ve=0;Ve<18;Ve++)N.nsPsy.pefirbuf[Ve]=N.nsPsy.pefirbuf[Ve+1];for(ot=0,ee=0;ee<N.mode_gr;ee++)for(Z=0;Z<N.channels_out;Z++)ot+=F[ee][Z];for(N.nsPsy.pefirbuf[18]=ot,ot=N.nsPsy.pefirbuf[9],Ve=0;Ve<9;Ve++)ot+=(N.nsPsy.pefirbuf[Ve]+N.nsPsy.pefirbuf[18-Ve])*c.fircoef[Ve];for(ot=670*5*N.mode_gr*N.channels_out/ot,ee=0;ee<N.mode_gr;ee++)for(Z=0;Z<N.channels_out;Z++)F[ee][Z]*=ot}if(N.iteration_loop.iteration_loop(f,F,G,v),E.format_bitstream(f),y=E.copy_buffer(N,W,L,P,1),f.bWriteVbrTag&&C.addVbrFrame(f),f.analysis&&N.pinfo!=null){for(Z=0;Z<N.channels_out;Z++){var Ge;for(Ge=0;Ge<g;Ge++)N.pinfo.pcmdata[Z][Ge]=N.pinfo.pcmdata[Z][Ge+f.framesize];for(Ge=g;Ge<1600;Ge++)N.pinfo.pcmdata[Z][Ge]=H[Z][Ge-g]}k.set_frame_pinfo(f,v)}return R(N),y}}return jl=c,jl}var wi=fn;wi.System;wi.VbrMode;wi.Float;wi.ShortBlock;var Ad=wi.Util;wi.Arrays;wi.new_array_n;wi.new_byte;wi.new_double;var Rd=wi.new_float;wi.new_float_n;wi.new_int;wi.new_int_n;wi.assert;var kn=Qn();function bg(){var r=Rd(kn.BLKSIZE),e=Rd(kn.BLKSIZE_s/2),t=[.9238795325112867,.3826834323650898,.9951847266721969,.0980171403295606,.9996988186962042,.02454122852291229,.9999811752826011,.006135884649154475];function n(s,h,d){var c=0,_,m,g;d<<=1;var S=h+d;_=4;do{var E,A,C,k,T,b,R;R=_>>1,k=_,T=_<<1,b=T+k,_=T<<1,m=h,g=m+R;do{var V,f,D,l;f=s[m+0]-s[m+k],V=s[m+0]+s[m+k],l=s[m+T]-s[m+b],D=s[m+T]+s[m+b],s[m+T]=V-D,s[m+0]=V+D,s[m+b]=f-l,s[m+k]=f+l,f=s[g+0]-s[g+k],V=s[g+0]+s[g+k],l=Ad.SQRT2*s[g+b],D=Ad.SQRT2*s[g+T],s[g+T]=V-D,s[g+0]=V+D,s[g+b]=f-l,s[g+k]=f+l,g+=_,m+=_}while(m<S);for(A=t[c+0],E=t[c+1],C=1;C<R;C++){var W,L;W=1-2*E*E,L=2*E*A,m=h+C,g=h+k-C;do{var P,y,O,V,f,B,D,v,l,H;y=L*s[m+k]-W*s[g+k],P=W*s[m+k]+L*s[g+k],f=s[m+0]-P,V=s[m+0]+P,B=s[g+0]-y,O=s[g+0]+y,y=L*s[m+b]-W*s[g+b],P=W*s[m+b]+L*s[g+b],l=s[m+T]-P,D=s[m+T]+P,H=s[g+T]-y,v=s[g+T]+y,y=E*D-A*H,P=A*D+E*H,s[m+T]=V-P,s[m+0]=V+P,s[g+b]=B-y,s[g+k]=B+y,y=A*v-E*l,P=E*v+A*l,s[g+T]=O-P,s[g+0]=O+P,s[m+b]=f-y,s[m+k]=f+y,g+=_,m+=_}while(m<S);W=A,A=W*t[c+0]-E*t[c+1],E=W*t[c+1]+E*t[c+0]}c+=2}while(_<d)}var i=[0,128,64,192,32,160,96,224,16,144,80,208,48,176,112,240,8,136,72,200,40,168,104,232,24,152,88,216,56,184,120,248,4,132,68,196,36,164,100,228,20,148,84,212,52,180,116,244,12,140,76,204,44,172,108,236,28,156,92,220,60,188,124,252,2,130,66,194,34,162,98,226,18,146,82,210,50,178,114,242,10,138,74,202,42,170,106,234,26,154,90,218,58,186,122,250,6,134,70,198,38,166,102,230,22,150,86,214,54,182,118,246,14,142,78,206,46,174,110,238,30,158,94,222,62,190,126,254];this.fft_short=function(s,h,d,c,_){for(var m=0;m<3;m++){var g=kn.BLKSIZE_s/2,S=65535&576/3*(m+1),E=kn.BLKSIZE_s/8-1;do{var A,C,k,T,b,R=i[E<<2]&255;A=e[R]*c[d][_+R+S],b=e[127-R]*c[d][_+R+S+128],C=A-b,A=A+b,k=e[R+64]*c[d][_+R+S+64],b=e[63-R]*c[d][_+R+S+192],T=k-b,k=k+b,g-=4,h[m][g+0]=A+k,h[m][g+2]=A-k,h[m][g+1]=C+T,h[m][g+3]=C-T,A=e[R+1]*c[d][_+R+S+1],b=e[126-R]*c[d][_+R+S+129],C=A-b,A=A+b,k=e[R+65]*c[d][_+R+S+65],b=e[62-R]*c[d][_+R+S+193],T=k-b,k=k+b,h[m][g+kn.BLKSIZE_s/2+0]=A+k,h[m][g+kn.BLKSIZE_s/2+2]=A-k,h[m][g+kn.BLKSIZE_s/2+1]=C+T,h[m][g+kn.BLKSIZE_s/2+3]=C-T}while(--E>=0);n(h[m],g,kn.BLKSIZE_s/2)}},this.fft_long=function(s,h,d,c,_){var m=kn.BLKSIZE/8-1,g=kn.BLKSIZE/2;do{var S,E,A,C,k,T=i[m]&255;S=r[T]*c[d][_+T],k=r[T+512]*c[d][_+T+512],E=S-k,S=S+k,A=r[T+256]*c[d][_+T+256],k=r[T+768]*c[d][_+T+768],C=A-k,A=A+k,g-=4,h[g+0]=S+A,h[g+2]=S-A,h[g+1]=E+C,h[g+3]=E-C,S=r[T+1]*c[d][_+T+1],k=r[T+513]*c[d][_+T+513],E=S-k,S=S+k,A=r[T+257]*c[d][_+T+257],k=r[T+769]*c[d][_+T+769],C=A-k,A=A+k,h[g+kn.BLKSIZE/2+0]=S+A,h[g+kn.BLKSIZE/2+2]=S-A,h[g+kn.BLKSIZE/2+1]=E+C,h[g+kn.BLKSIZE/2+3]=E-C}while(--m>=0);n(h,g,kn.BLKSIZE/2)},this.init_fft=function(s){for(var h=0;h<kn.BLKSIZE;h++)r[h]=.42-.5*Math.cos(2*Math.PI*(h+.5)/kn.BLKSIZE)+.08*Math.cos(4*Math.PI*(h+.5)/kn.BLKSIZE);for(var h=0;h<kn.BLKSIZE_s/2;h++)e[h]=.5*(1-Math.cos(2*Math.PI*(h+.5)/kn.BLKSIZE_s))}}var yg=bg,xi=fn;xi.System;var eo=xi.VbrMode,Ld=xi.Float,to=xi.ShortBlock,di=xi.Util,wg=xi.Arrays;xi.new_array_n;xi.new_byte;xi.new_double;var Bn=xi.new_float,Ji=xi.new_float_n,Er=xi.new_int;xi.new_int_n;var Ze=xi.assert,xg=yg,Se=Qn();function Sg(){var r=new xg,e=2.302585092994046,t=2,n=16,i=2,s=16,h=.34,d=1/(14752*14752)/(Se.BLKSIZE/2),c=.01,_=.8,m=.6,g=.3,S=3.5,E=21,A=.2302585093;function C(j){return j}function k(j,K){for(var z=0,Y=0;Y<Se.BLKSIZE/2;++Y)z+=j[Y]*K.ATH.eql_w[Y];return z*=d,z}function T(j,K,z,Y,J,X,ie,oe,ae,fe,ce){var we=j.internal_flags;if(ae<2)r.fft_long(we,Y[J],ae,fe,ce),r.fft_short(we,X[ie],ae,fe,ce);else if(ae==2){for(var He=Se.BLKSIZE-1;He>=0;--He){var $e=Y[J+0][He],Ee=Y[J+1][He];Y[J+0][He]=($e+Ee)*di.SQRT2*.5,Y[J+1][He]=($e-Ee)*di.SQRT2*.5}for(var Ye=2;Ye>=0;--Ye)for(var He=Se.BLKSIZE_s-1;He>=0;--He){var $e=X[ie+0][Ye][He],Ee=X[ie+1][Ye][He];X[ie+0][Ye][He]=($e+Ee)*di.SQRT2*.5,X[ie+1][Ye][He]=($e-Ee)*di.SQRT2*.5}}K[0]=Y[J+0][0],K[0]*=K[0];for(var He=Se.BLKSIZE/2-1;He>=0;--He){var ve=Y[J+0][Se.BLKSIZE/2-He],ze=Y[J+0][Se.BLKSIZE/2+He];K[Se.BLKSIZE/2-He]=(ve*ve+ze*ze)*.5}for(var Ye=2;Ye>=0;--Ye){z[Ye][0]=X[ie+0][Ye][0],z[Ye][0]*=z[Ye][0];for(var He=Se.BLKSIZE_s/2-1;He>=0;--He){var ve=X[ie+0][Ye][Se.BLKSIZE_s/2-He],ze=X[ie+0][Ye][Se.BLKSIZE_s/2+He];z[Ye][Se.BLKSIZE_s/2-He]=(ve*ve+ze*ze)*.5}}{for(var pt=0,He=11;He<Se.HBLKSIZE;He++)pt+=K[He];we.tot_ener[ae]=pt}if(j.analysis){for(var He=0;He<Se.HBLKSIZE;He++)we.pinfo.energy[oe][ae][He]=we.pinfo.energy_save[ae][He],we.pinfo.energy_save[ae][He]=K[He];we.pinfo.pe[oe][ae]=we.pe[ae]}j.athaa_loudapprox==2&&ae<2&&(we.loudness_sq[oe][ae]=we.loudness_sq_save[ae],we.loudness_sq_save[ae]=k(K,we))}var b=8,R=23,V=15,f,D,l,W=[1,.79433,.63096,.63096,.63096,.63096,.63096,.25119,.11749];function L(){f=Math.pow(10,(b+1)/16),D=Math.pow(10,(R+1)/16),l=Math.pow(10,V/10)}var P=[3.3246*3.3246,3.23837*3.23837,3.15437*3.15437,3.00412*3.00412,2.86103*2.86103,2.65407*2.65407,2.46209*2.46209,2.284*2.284,2.11879*2.11879,1.96552*1.96552,1.82335*1.82335,1.69146*1.69146,1.56911*1.56911,1.46658*1.46658,1.37074*1.37074,1.31036*1.31036,1.25264*1.25264,1.20648*1.20648,1.16203*1.16203,1.12765*1.12765,1.09428*1.09428,1.0659*1.0659,1.03826*1.03826,1.01895*1.01895,1],y=[1.33352*1.33352,1.35879*1.35879,1.38454*1.38454,1.39497*1.39497,1.40548*1.40548,1.3537*1.3537,1.30382*1.30382,1.22321*1.22321,1.14758*1.14758,1],O=[2.35364*2.35364,2.29259*2.29259,2.23313*2.23313,2.12675*2.12675,2.02545*2.02545,1.87894*1.87894,1.74303*1.74303,1.61695*1.61695,1.49999*1.49999,1.39148*1.39148,1.29083*1.29083,1.19746*1.19746,1.11084*1.11084,1.03826*1.03826];function B(j,K,z,Y,J,X){var ie;if(K>j)if(K<j*D)ie=K/j;else return j+K;else{if(j>=K*D)return j+K;ie=j/K}if(Ze(j>=0),Ze(K>=0),j+=K,Y+3<=6){if(ie>=f)return j;var oe=0|di.FAST_LOG10_X(ie,16);return j*y[oe]}var oe=0|di.FAST_LOG10_X(ie,16);if(X!=0?K=J.ATH.cb_s[z]*J.ATH.adjust:K=J.ATH.cb_l[z]*J.ATH.adjust,Ze(K>=0),j<l*K){if(j>K){var ae,fe;return ae=1,oe<=13&&(ae=O[oe]),fe=di.FAST_LOG10_X(j/K,10/15),j*((P[oe]-ae)*fe+ae)}return oe>13?j:j*O[oe]}return j*P[oe]}var v=[1.33352*1.33352,1.35879*1.35879,1.38454*1.38454,1.39497*1.39497,1.40548*1.40548,1.3537*1.3537,1.30382*1.30382,1.22321*1.22321,1.14758*1.14758,1];function H(j,K,z){var Y;if(j<0&&(j=0),K<0&&(K=0),j<=0)return K;if(K<=0)return j;if(K>j?Y=K/j:Y=j/K,-2<=z&&z<=2){if(Y>=f)return j+K;var J=0|di.FAST_LOG10_X(Y,16);return(j+K)*v[J]}return Y<D?j+K:(j<K&&(j=K),j)}function N(j,K){var z=j.internal_flags;if(z.channels_out>1){for(var Y=0;Y<Se.SBMAX_l;Y++){var J=z.thm[0].l[Y],X=z.thm[1].l[Y];z.thm[0].l[Y]+=X*K,z.thm[1].l[Y]+=J*K}for(var Y=0;Y<Se.SBMAX_s;Y++)for(var ie=0;ie<3;ie++){var J=z.thm[0].s[Y][ie],X=z.thm[1].s[Y][ie];z.thm[0].s[Y][ie]+=X*K,z.thm[1].s[Y][ie]+=J*K}}}function te(j){for(var K=0;K<Se.SBMAX_l;K++)if(!(j.thm[0].l[K]>1.58*j.thm[1].l[K]||j.thm[1].l[K]>1.58*j.thm[0].l[K])){var z=j.mld_l[K]*j.en[3].l[K],Y=Math.max(j.thm[2].l[K],Math.min(j.thm[3].l[K],z));z=j.mld_l[K]*j.en[2].l[K];var J=Math.max(j.thm[3].l[K],Math.min(j.thm[2].l[K],z));j.thm[2].l[K]=Y,j.thm[3].l[K]=J}for(var K=0;K<Se.SBMAX_s;K++)for(var X=0;X<3;X++)if(!(j.thm[0].s[K][X]>1.58*j.thm[1].s[K][X]||j.thm[1].s[K][X]>1.58*j.thm[0].s[K][X])){var z=j.mld_s[K]*j.en[3].s[K][X],Y=Math.max(j.thm[2].s[K][X],Math.min(j.thm[3].s[K][X],z));z=j.mld_s[K]*j.en[2].s[K][X];var J=Math.max(j.thm[3].s[K][X],Math.min(j.thm[2].s[K][X],z));j.thm[2].s[K][X]=Y,j.thm[3].s[K][X]=J}}function G(j,K,z){var Y=K,J=Math.pow(10,z);K*=2,Y*=2;for(var X=0;X<Se.SBMAX_l;X++){var ie,oe,ae,fe;if(fe=j.ATH.cb_l[j.bm_l[X]]*J,ie=Math.min(Math.max(j.thm[0].l[X],fe),Math.max(j.thm[1].l[X],fe)),oe=Math.max(j.thm[2].l[X],fe),ae=Math.max(j.thm[3].l[X],fe),ie*K<oe+ae){var ce=ie*Y/(oe+ae);oe*=ce,ae*=ce,Ze(oe+ae>0)}j.thm[2].l[X]=Math.min(oe,j.thm[2].l[X]),j.thm[3].l[X]=Math.min(ae,j.thm[3].l[X])}J*=Se.BLKSIZE_s/Se.BLKSIZE;for(var X=0;X<Se.SBMAX_s;X++)for(var we=0;we<3;we++){var ie,oe,ae,fe;if(fe=j.ATH.cb_s[j.bm_s[X]]*J,ie=Math.min(Math.max(j.thm[0].s[X][we],fe),Math.max(j.thm[1].s[X][we],fe)),oe=Math.max(j.thm[2].s[X][we],fe),ae=Math.max(j.thm[3].s[X][we],fe),ie*K<oe+ae){var ce=ie*K/(oe+ae);oe*=ce,ae*=ce,Ze(oe+ae>0)}j.thm[2].s[X][we]=Math.min(j.thm[2].s[X][we],oe),j.thm[3].s[X][we]=Math.min(j.thm[3].s[X][we],ae)}}function se(j,K,z,Y,J){var X,ie,oe=0,ae=0;for(X=ie=0;X<Se.SBMAX_s;++ie,++X){for(var fe=j.bo_s[X],ce=j.npart_s,we=fe<ce?fe:ce;ie<we;)Ze(K[ie]>=0),Ze(z[ie]>=0),oe+=K[ie],ae+=z[ie],ie++;if(j.en[Y].s[X][J]=oe,j.thm[Y].s[X][J]=ae,ie>=ce){++X;break}Ze(K[ie]>=0),Ze(z[ie]>=0);{var He=j.PSY.bo_s_weight[X],$e=1-He;oe=He*K[ie],ae=He*z[ie],j.en[Y].s[X][J]+=oe,j.thm[Y].s[X][J]+=ae,oe=$e*K[ie],ae=$e*z[ie]}}for(;X<Se.SBMAX_s;++X)j.en[Y].s[X][J]=0,j.thm[Y].s[X][J]=0}function M(j,K,z,Y){var J,X,ie=0,oe=0;for(J=X=0;J<Se.SBMAX_l;++X,++J){for(var ae=j.bo_l[J],fe=j.npart_l,ce=ae<fe?ae:fe;X<ce;)Ze(K[X]>=0),Ze(z[X]>=0),ie+=K[X],oe+=z[X],X++;if(j.en[Y].l[J]=ie,j.thm[Y].l[J]=oe,X>=fe){++J;break}Ze(K[X]>=0),Ze(z[X]>=0);{var we=j.PSY.bo_l_weight[J],He=1-we;ie=we*K[X],oe=we*z[X],j.en[Y].l[J]+=ie,j.thm[Y].l[J]+=oe,ie=He*K[X],oe=He*z[X]}}for(;J<Se.SBMAX_l;++J)j.en[Y].l[J]=0,j.thm[Y].l[J]=0}function F(j,K,z,Y,J,X){var ie=j.internal_flags,oe,ae;for(ae=oe=0;ae<ie.npart_s;++ae){for(var fe=0,ce=ie.numlines_s[ae],we=0;we<ce;++we,++oe){var He=K[X][oe];fe+=He}z[ae]=fe}for(Ze(ae==ie.npart_s),Ze(oe==129),oe=ae=0;ae<ie.npart_s;ae++){var $e=ie.s3ind_s[ae][0],Ee=ie.s3_ss[oe++]*z[$e];for(++$e;$e<=ie.s3ind_s[ae][1];)Ee+=ie.s3_ss[oe]*z[$e],++oe,++$e;{var Ye=i*ie.nb_s1[J][ae];Y[ae]=Math.min(Ee,Ye)}if(ie.blocktype_old[J&1]==Se.SHORT_TYPE){var Ye=s*ie.nb_s2[J][ae],ve=Y[ae];Y[ae]=Math.min(Ye,ve)}ie.nb_s2[J][ae]=ie.nb_s1[J][ae],ie.nb_s1[J][ae]=Ee,Ze(Y[ae]>=0)}for(;ae<=Se.CBANDS;++ae)z[ae]=0,Y[ae]=0}function Z(j,K,z,Y){var J=j.internal_flags;j.short_blocks==to.short_block_coupled&&!(K[0]!=0&&K[1]!=0)&&(K[0]=K[1]=0);for(var X=0;X<J.channels_out;X++)Y[X]=Se.NORM_TYPE,j.short_blocks==to.short_block_dispensed&&(K[X]=1),j.short_blocks==to.short_block_forced&&(K[X]=0),K[X]!=0?(Ze(J.blocktype_old[X]!=Se.START_TYPE),J.blocktype_old[X]==Se.SHORT_TYPE&&(Y[X]=Se.STOP_TYPE)):(Y[X]=Se.SHORT_TYPE,J.blocktype_old[X]==Se.NORM_TYPE&&(J.blocktype_old[X]=Se.START_TYPE),J.blocktype_old[X]==Se.STOP_TYPE&&(J.blocktype_old[X]=Se.SHORT_TYPE)),z[X]=J.blocktype_old[X],J.blocktype_old[X]=Y[X]}function ee(j,K,z){return z>=1?j:z<=0?K:K>0?Math.pow(j/K,z)*K:0}var ue=[11.8,13.6,17.2,32,46.5,51.3,57.5,67.1,71.5,84.6,97.6,130];function Pe(j,K){for(var z=309.07,Y=0;Y<Se.SBMAX_s-1;Y++)for(var J=0;J<3;J++){var X=j.thm.s[Y][J];if(Ze(Y<ue.length),X>0){var ie=X*K,oe=j.en.s[Y][J];oe>ie&&(oe>ie*1e10?z+=ue[Y]*(10*e):(Ze(ie>0),z+=ue[Y]*di.FAST_LOG10(oe/ie)))}}return z}var _e=[6.8,5.8,5.8,6.4,6.5,9.9,12.1,14.4,15,18.9,21.6,26.9,34.2,40.2,46.8,56.5,60.7,73.9,85.7,93.4,126.1];function ke(j,K){for(var z=281.0575,Y=0;Y<Se.SBMAX_l-1;Y++){var J=j.thm.l[Y];if(Ze(Y<_e.length),J>0){var X=J*K,ie=j.en.l[Y];ie>X&&(ie>X*1e10?z+=_e[Y]*(10*e):(Ze(X>0),z+=_e[Y]*di.FAST_LOG10(ie/X)))}}return z}function Ne(j,K,z,Y,J){var X,ie;for(X=ie=0;X<j.npart_l;++X){var oe=0,ae=0,fe;for(fe=0;fe<j.numlines_l[X];++fe,++ie){var ce=K[ie];Ze(ce>=0),oe+=ce,ae<ce&&(ae=ce)}z[X]=oe,Y[X]=ae,J[X]=oe*j.rnumlines_l[X],Ze(j.rnumlines_l[X]>=0),Ze(oe>=0),Ze(z[X]>=0),Ze(Y[X]>=0),Ze(J[X]>=0)}}function Be(j,K,z,Y){var J=W.length-1,X=0,ie=z[X]+z[X+1];if(Ze(ie>=0),ie>0){var oe=K[X];oe<K[X+1]&&(oe=K[X+1]),Ze(j.numlines_l[X]+j.numlines_l[X+1]-1>0),ie=20*(oe*2-ie)/(ie*(j.numlines_l[X]+j.numlines_l[X+1]-1));var ae=0|ie;ae>J&&(ae=J),Y[X]=ae}else Y[X]=0;for(X=1;X<j.npart_l-1;X++)if(ie=z[X-1]+z[X]+z[X+1],Ze(ie>=0),ie>0){var oe=K[X-1];oe<K[X]&&(oe=K[X]),oe<K[X+1]&&(oe=K[X+1]),Ze(j.numlines_l[X-1]+j.numlines_l[X]+j.numlines_l[X+1]-1>0),ie=20*(oe*3-ie)/(ie*(j.numlines_l[X-1]+j.numlines_l[X]+j.numlines_l[X+1]-1));var ae=0|ie;ae>J&&(ae=J),Y[X]=ae}else Y[X]=0;if(Ze(X>0),Ze(X==j.npart_l-1),ie=z[X-1]+z[X],Ze(ie>=0),ie>0){var oe=K[X-1];oe<K[X]&&(oe=K[X]),Ze(j.numlines_l[X-1]+j.numlines_l[X]-1>0),ie=20*(oe*2-ie)/(ie*(j.numlines_l[X-1]+j.numlines_l[X]-1));var ae=0|ie;ae>J&&(ae=J),Y[X]=ae}else Y[X]=0;Ze(X==j.npart_l-1)}var pe=[-865163e-23*2,-.00851586*2,-674764e-23*2,.0209036*2,-336639e-22*2,-.0438162*2,-154175e-22*2,.0931738*2,-552212e-22*2,-.313819*2];this.L3psycho_anal_ns=function(j,K,z,Y,J,X,ie,oe,ae,fe){var ce=j.internal_flags,we=Ji([2,Se.BLKSIZE]),He=Ji([2,3,Se.BLKSIZE_s]),$e=Bn(Se.CBANDS+1),Ee=Bn(Se.CBANDS+1),Ye=Bn(Se.CBANDS+2),ve=Er(2),ze=Er(2),pt,Ae,qe,Re,tt,Vt,We,ct,_t=Ji([2,576]),mt,Cn=Er(Se.CBANDS+2),Kt=Er(Se.CBANDS+2);for(wg.fill(Kt,0),pt=ce.channels_out,j.mode==MPEGMode.JOINT_STEREO&&(pt=4),j.VBR==eo.vbr_off?mt=ce.ResvMax==0?0:ce.ResvSize/ce.ResvMax*.5:j.VBR==eo.vbr_rh||j.VBR==eo.vbr_mtrh||j.VBR==eo.vbr_mt?mt=.6:mt=1,Ae=0;Ae<ce.channels_out;Ae++){var Wt=K[Ae],en=z+576-350-E+192;for(Ze(pe.length==(E-1)/2),Re=0;Re<576;Re++){var gn,En;for(gn=Wt[en+Re+10],En=0,tt=0;tt<(E-1)/2-1;tt+=2)gn+=pe[tt]*(Wt[en+Re+tt]+Wt[en+Re+E-tt]),En+=pe[tt+1]*(Wt[en+Re+tt+1]+Wt[en+Re+E-tt-1]);_t[Ae][Re]=gn+En}J[Y][Ae].en.assign(ce.en[Ae]),J[Y][Ae].thm.assign(ce.thm[Ae]),pt>2&&(X[Y][Ae].en.assign(ce.en[Ae+2]),X[Y][Ae].thm.assign(ce.thm[Ae+2]))}for(Ae=0;Ae<pt;Ae++){var qn,Hn,vn=Bn(12),ei=[0,0,0,0],ai=Bn(12),Ys=1,js,Vi=Bn(Se.CBANDS),li=Bn(Se.CBANDS),Gt=[0,0,0,0],Wi=Bn(Se.HBLKSIZE),hi=Ji([3,Se.HBLKSIZE_s]);for(Ze(ce.npart_s<=Se.CBANDS),Ze(ce.npart_l<=Se.CBANDS),Re=0;Re<3;Re++)vn[Re]=ce.nsPsy.last_en_subshort[Ae][Re+6],Ze(ce.nsPsy.last_en_subshort[Ae][Re+4]>0),ai[Re]=vn[Re]/ce.nsPsy.last_en_subshort[Ae][Re+4],ei[0]+=vn[Re];if(Ae==2)for(Re=0;Re<576;Re++){var os,ji;os=_t[0][Re],ji=_t[1][Re],_t[0][Re]=os+ji,_t[1][Re]=os-ji}{var as=_t[Ae&1],An=0;for(Re=0;Re<9;Re++){for(var Ki=An+64,It=1;An<Ki;An++)It<Math.abs(as[An])&&(It=Math.abs(as[An]));ce.nsPsy.last_en_subshort[Ae][Re]=vn[Re+3]=It,ei[1+Re/3]+=It,It>vn[Re+3-2]?(Ze(vn[Re+3-2]>0),It=It/vn[Re+3-2]):vn[Re+3-2]>It*10?(Ze(It>0),It=vn[Re+3-2]/(It*10)):It=0,ai[Re+3]=It}}if(j.analysis){var jn=ai[0];for(Re=1;Re<12;Re++)jn<ai[Re]&&(jn=ai[Re]);ce.pinfo.ers[Y][Ae]=ce.pinfo.ers_save[Ae],ce.pinfo.ers_save[Ae]=jn}for(js=Ae==3?ce.nsPsy.attackthre_s:ce.nsPsy.attackthre,Re=0;Re<12;Re++)Gt[Re/3]==0&&ai[Re]>js&&(Gt[Re/3]=Re%3+1);for(Re=1;Re<4;Re++){var Ks;ei[Re-1]>ei[Re]?(Ze(ei[Re]>0),Ks=ei[Re-1]/ei[Re]):(Ze(ei[Re-1]>0),Ks=ei[Re]/ei[Re-1]),Ks<1.7&&(Gt[Re]=0,Re==1&&(Gt[0]=0))}for(Gt[0]!=0&&ce.nsPsy.lastAttacks[Ae]!=0&&(Gt[0]=0),(ce.nsPsy.lastAttacks[Ae]==3||Gt[0]+Gt[1]+Gt[2]+Gt[3]!=0)&&(Ys=0,Gt[1]!=0&&Gt[0]!=0&&(Gt[1]=0),Gt[2]!=0&&Gt[1]!=0&&(Gt[2]=0),Gt[3]!=0&&Gt[2]!=0&&(Gt[3]=0)),Ae<2?ze[Ae]=Ys:Ys==0&&(ze[0]=ze[1]=0),ae[Ae]=ce.tot_ener[Ae],Hn=He,qn=we,T(j,Wi,hi,qn,Ae&1,Hn,Ae&1,Y,Ae,K,z),Ne(ce,Wi,$e,Vi,li),Be(ce,Vi,li,Cn),ct=0;ct<3;ct++){var co,Kn;for(F(j,hi,Ee,Ye,Ae,ct),se(ce,Ee,Ye,Ae,ct),We=0;We<Se.SBMAX_s;We++){if(Kn=ce.thm[Ae].s[We][ct],Kn*=_,Gt[ct]>=2||Gt[ct+1]==1){var Ns=ct!=0?ct-1:2,It=ee(ce.thm[Ae].s[We][Ns],Kn,m*mt);Kn=Math.min(Kn,It)}if(Gt[ct]==1){var Ns=ct!=0?ct-1:2,It=ee(ce.thm[Ae].s[We][Ns],Kn,g*mt);Kn=Math.min(Kn,It)}else if(ct!=0&&Gt[ct-1]==3||ct==0&&ce.nsPsy.lastAttacks[Ae]==3){var Ns=ct!=2?ct+1:0,It=ee(ce.thm[Ae].s[We][Ns],Kn,g*mt);Kn=Math.min(Kn,It)}co=vn[ct*3+3]+vn[ct*3+4]+vn[ct*3+5],vn[ct*3+5]*6<co&&(Kn*=.5,vn[ct*3+4]*6<co&&(Kn*=.5)),ce.thm[Ae].s[We][ct]=Kn}}for(ce.nsPsy.lastAttacks[Ae]=Gt[2],Vt=0,qe=0;qe<ce.npart_l;qe++){for(var vs=ce.s3ind[qe][0],Gs=$e[vs]*W[Cn[vs]],bs=ce.s3_ll[Vt++]*Gs;++vs<=ce.s3ind[qe][1];)Gs=$e[vs]*W[Cn[vs]],bs=B(bs,ce.s3_ll[Vt++]*Gs,vs,vs-qe,ce,0);bs*=.158489319246111,ce.blocktype_old[Ae&1]==Se.SHORT_TYPE?Ye[qe]=bs:Ye[qe]=ee(Math.min(bs,Math.min(t*ce.nb_1[Ae][qe],n*ce.nb_2[Ae][qe])),bs,mt),ce.nb_2[Ae][qe]=ce.nb_1[Ae][qe],ce.nb_1[Ae][qe]=bs}for(;qe<=Se.CBANDS;++qe)$e[qe]=0,Ye[qe]=0;M(ce,$e,Ye,Ae)}if((j.mode==MPEGMode.STEREO||j.mode==MPEGMode.JOINT_STEREO)&&j.interChRatio>0&&N(j,j.interChRatio),j.mode==MPEGMode.JOINT_STEREO){var uo;te(ce),uo=j.msfix,Math.abs(uo)>0&&G(ce,uo,j.ATHlower*ce.ATH.adjust)}for(Z(j,ze,fe,ve),Ae=0;Ae<pt;Ae++){var mr,Un=0,gr,ys;Ae>1?(mr=oe,Un=-2,gr=Se.NORM_TYPE,(fe[0]==Se.SHORT_TYPE||fe[1]==Se.SHORT_TYPE)&&(gr=Se.SHORT_TYPE),ys=X[Y][Ae-2]):(mr=ie,Un=0,gr=fe[Ae],ys=J[Y][Ae]),gr==Se.SHORT_TYPE?mr[Un+Ae]=Pe(ys,ce.masking_lower):mr[Un+Ae]=ke(ys,ce.masking_lower),j.analysis&&(ce.pinfo.pe[Y][Ae]=mr[Un+Ae])}return 0};function Oe(j,K,z,Y,J,X,ie,oe){var ae=j.internal_flags;if(Y<2)r.fft_long(ae,ie[oe],Y,K,z);else if(Y==2)for(var fe=Se.BLKSIZE-1;fe>=0;--fe){var ce=ie[oe+0][fe],we=ie[oe+1][fe];ie[oe+0][fe]=(ce+we)*di.SQRT2*.5,ie[oe+1][fe]=(ce-we)*di.SQRT2*.5}X[0]=ie[oe+0][0],X[0]*=X[0];for(var fe=Se.BLKSIZE/2-1;fe>=0;--fe){var He=ie[oe+0][Se.BLKSIZE/2-fe],$e=ie[oe+0][Se.BLKSIZE/2+fe];X[Se.BLKSIZE/2-fe]=(He*He+$e*$e)*.5}{for(var Ee=0,fe=11;fe<Se.HBLKSIZE;fe++)Ee+=X[fe];ae.tot_ener[Y]=Ee}if(j.analysis){for(var fe=0;fe<Se.HBLKSIZE;fe++)ae.pinfo.energy[J][Y][fe]=ae.pinfo.energy_save[Y][fe],ae.pinfo.energy_save[Y][fe]=X[fe];ae.pinfo.pe[J][Y]=ae.pe[Y]}}function nt(j,K,z,Y,J,X,ie,oe){var ae=j.internal_flags;if(J==0&&Y<2&&r.fft_short(ae,ie[oe],Y,K,z),Y==2)for(var fe=Se.BLKSIZE_s-1;fe>=0;--fe){var ce=ie[oe+0][J][fe],we=ie[oe+1][J][fe];ie[oe+0][J][fe]=(ce+we)*di.SQRT2*.5,ie[oe+1][J][fe]=(ce-we)*di.SQRT2*.5}X[J][0]=ie[oe+0][J][0],X[J][0]*=X[J][0];for(var fe=Se.BLKSIZE_s/2-1;fe>=0;--fe){var He=ie[oe+0][J][Se.BLKSIZE_s/2-fe],$e=ie[oe+0][J][Se.BLKSIZE_s/2+fe];X[J][Se.BLKSIZE_s/2-fe]=(He*He+$e*$e)*.5}}function Ve(j,K,z,Y){var J=j.internal_flags;j.athaa_loudapprox==2&&z<2&&(J.loudness_sq[K][z]=J.loudness_sq_save[z],J.loudness_sq_save[z]=k(Y,J))}var ot=[-865163e-23*2,-.00851586*2,-674764e-23*2,.0209036*2,-336639e-22*2,-.0438162*2,-154175e-22*2,.0931738*2,-552212e-22*2,-.313819*2];function Ge(j,K,z,Y,J,X,ie,oe,ae,fe){for(var ce=Ji([2,576]),we=j.internal_flags,He=we.channels_out,$e=j.mode==MPEGMode.JOINT_STEREO?4:He,Ee=0;Ee<He;Ee++){firbuf=K[Ee];var Ye=z+576-350-E+192;Ze(ot.length==(E-1)/2);for(var ve=0;ve<576;ve++){var ze,pt;ze=firbuf[Ye+ve+10],pt=0;for(var Ae=0;Ae<(E-1)/2-1;Ae+=2)ze+=ot[Ae]*(firbuf[Ye+ve+Ae]+firbuf[Ye+ve+E-Ae]),pt+=ot[Ae+1]*(firbuf[Ye+ve+Ae+1]+firbuf[Ye+ve+E-Ae-1]);ce[Ee][ve]=ze+pt}J[Y][Ee].en.assign(we.en[Ee]),J[Y][Ee].thm.assign(we.thm[Ee]),$e>2&&(X[Y][Ee].en.assign(we.en[Ee+2]),X[Y][Ee].thm.assign(we.thm[Ee+2]))}for(var Ee=0;Ee<$e;Ee++){var qe=Bn(12),Re=Bn(12),tt=[0,0,0,0],Vt=ce[Ee&1],We=0,ct=Ee==3?we.nsPsy.attackthre_s:we.nsPsy.attackthre,_t=1;if(Ee==2)for(var ve=0,Ae=576;Ae>0;++ve,--Ae){var mt=ce[0][ve],Cn=ce[1][ve];ce[0][ve]=mt+Cn,ce[1][ve]=mt-Cn}for(var ve=0;ve<3;ve++)Re[ve]=we.nsPsy.last_en_subshort[Ee][ve+6],Ze(we.nsPsy.last_en_subshort[Ee][ve+4]>0),qe[ve]=Re[ve]/we.nsPsy.last_en_subshort[Ee][ve+4],tt[0]+=Re[ve];for(var ve=0;ve<9;ve++){for(var Kt=We+64,Wt=1;We<Kt;We++)Wt<Math.abs(Vt[We])&&(Wt=Math.abs(Vt[We]));we.nsPsy.last_en_subshort[Ee][ve]=Re[ve+3]=Wt,tt[1+ve/3]+=Wt,Wt>Re[ve+3-2]?(Ze(Re[ve+3-2]>0),Wt=Wt/Re[ve+3-2]):Re[ve+3-2]>Wt*10?(Ze(Wt>0),Wt=Re[ve+3-2]/(Wt*10)):Wt=0,qe[ve+3]=Wt}for(var ve=0;ve<3;++ve){var en=Re[ve*3+3]+Re[ve*3+4]+Re[ve*3+5],gn=1;Re[ve*3+5]*6<en&&(gn*=.5,Re[ve*3+4]*6<en&&(gn*=.5)),oe[Ee][ve]=gn}if(j.analysis){for(var En=qe[0],ve=1;ve<12;ve++)En<qe[ve]&&(En=qe[ve]);we.pinfo.ers[Y][Ee]=we.pinfo.ers_save[Ee],we.pinfo.ers_save[Ee]=En}for(var ve=0;ve<12;ve++)ae[Ee][ve/3]==0&&qe[ve]>ct&&(ae[Ee][ve/3]=ve%3+1);for(var ve=1;ve<4;ve++){var qn=tt[ve-1],Hn=tt[ve],vn=Math.max(qn,Hn);vn<4e4&&qn<1.7*Hn&&Hn<1.7*qn&&(ve==1&&ae[Ee][0]<=ae[Ee][ve]&&(ae[Ee][0]=0),ae[Ee][ve]=0)}ae[Ee][0]<=we.nsPsy.lastAttacks[Ee]&&(ae[Ee][0]=0),(we.nsPsy.lastAttacks[Ee]==3||ae[Ee][0]+ae[Ee][1]+ae[Ee][2]+ae[Ee][3]!=0)&&(_t=0,ae[Ee][1]!=0&&ae[Ee][0]!=0&&(ae[Ee][1]=0),ae[Ee][2]!=0&&ae[Ee][1]!=0&&(ae[Ee][2]=0),ae[Ee][3]!=0&&ae[Ee][2]!=0&&(ae[Ee][3]=0)),Ee<2?fe[Ee]=_t:_t==0&&(fe[0]=fe[1]=0),ie[Ee]=we.tot_ener[Ee]}}function lt(j,K,z){if(z==0)for(var Y=0;Y<j.npart_s;Y++)j.nb_s2[K][Y]=j.nb_s1[K][Y],j.nb_s1[K][Y]=0}function dt(j,K){for(var z=0;z<j.npart_l;z++)j.nb_2[K][z]=j.nb_1[K][z],j.nb_1[K][z]=0}function St(j,K,z,Y){var J=W.length-1,X=0,ie=z[X]+z[X+1];if(Ze(ie>=0),ie>0){var oe=K[X];oe<K[X+1]&&(oe=K[X+1]),Ze(j.numlines_s[X]+j.numlines_s[X+1]-1>0),ie=20*(oe*2-ie)/(ie*(j.numlines_s[X]+j.numlines_s[X+1]-1));var ae=0|ie;ae>J&&(ae=J),Y[X]=ae}else Y[X]=0;for(X=1;X<j.npart_s-1;X++)if(ie=z[X-1]+z[X]+z[X+1],Ze(X+1<j.npart_s),Ze(ie>=0),ie>0){var oe=K[X-1];oe<K[X]&&(oe=K[X]),oe<K[X+1]&&(oe=K[X+1]),Ze(j.numlines_s[X-1]+j.numlines_s[X]+j.numlines_s[X+1]-1>0),ie=20*(oe*3-ie)/(ie*(j.numlines_s[X-1]+j.numlines_s[X]+j.numlines_s[X+1]-1));var ae=0|ie;ae>J&&(ae=J),Y[X]=ae}else Y[X]=0;if(Ze(X>0),Ze(X==j.npart_s-1),ie=z[X-1]+z[X],Ze(ie>=0),ie>0){var oe=K[X-1];oe<K[X]&&(oe=K[X]),Ze(j.numlines_s[X-1]+j.numlines_s[X]-1>0),ie=20*(oe*2-ie)/(ie*(j.numlines_s[X-1]+j.numlines_s[X]-1));var ae=0|ie;ae>J&&(ae=J),Y[X]=ae}else Y[X]=0;Ze(X==j.npart_s-1)}function Mt(j,K,z,Y,J,X){var ie=j.internal_flags,oe=new float[Se.CBANDS],ae=Bn(Se.CBANDS),fe,ce,we,He=new int[Se.CBANDS];for(we=ce=0;we<ie.npart_s;++we){var $e=0,Ee=0,Ye=ie.numlines_s[we];for(fe=0;fe<Ye;++fe,++ce){var ve=K[X][ce];$e+=ve,Ee<ve&&(Ee=ve)}z[we]=$e,Ze($e>=0),oe[we]=Ee,Ze(Ye>0),ae[we]=$e/Ye,Ze(ae[we]>=0)}for(Ze(we==ie.npart_s),Ze(ce==129);we<Se.CBANDS;++we)oe[we]=0,ae[we]=0;for(St(ie,oe,ae,He),ce=we=0;we<ie.npart_s;we++){var ze=ie.s3ind_s[we][0],pt=ie.s3ind_s[we][1],Ae,qe,Re,tt,Vt;for(Ae=He[ze],qe=1,tt=ie.s3_ss[ce]*z[ze]*W[He[ze]],++ce,++ze;ze<=pt;)Ae+=He[ze],qe+=1,Re=ie.s3_ss[ce]*z[ze]*W[He[ze]],tt=H(tt,Re,ze-we),++ce,++ze;Ae=(1+2*Ae)/(2*qe),Vt=W[Ae]*.5,tt*=Vt,Y[we]=tt,ie.nb_s2[J][we]=ie.nb_s1[J][we],ie.nb_s1[J][we]=tt,Re=oe[we],Re*=ie.minval_s[we],Re*=Vt,Y[we]>Re&&(Y[we]=Re),ie.masking_lower>1&&(Y[we]*=ie.masking_lower),Y[we]>z[we]&&(Y[we]=z[we]),ie.masking_lower<1&&(Y[we]*=ie.masking_lower),Ze(Y[we]>=0)}for(;we<Se.CBANDS;++we)z[we]=0,Y[we]=0}function Tt(j,K,z,Y,J){var X=Bn(Se.CBANDS),ie=Bn(Se.CBANDS),oe=Er(Se.CBANDS+2),ae;Ne(j,K,z,X,ie),Be(j,X,ie,oe);var fe=0;for(ae=0;ae<j.npart_l;ae++){var ce,we,He,$e,Ee=j.s3ind[ae][0],Ye=j.s3ind[ae][1],ve=0,ze=0;for(ve=oe[Ee],ze+=1,we=j.s3_ll[fe]*z[Ee]*W[oe[Ee]],++fe,++Ee;Ee<=Ye;)ve+=oe[Ee],ze+=1,ce=j.s3_ll[fe]*z[Ee]*W[oe[Ee]],$e=H(we,ce,Ee-ae),we=$e,++fe,++Ee;if(ve=(1+2*ve)/(2*ze),He=W[ve]*.5,we*=He,j.blocktype_old[J&1]==Se.SHORT_TYPE){var pt=t*j.nb_1[J][ae];pt>0?Y[ae]=Math.min(we,pt):Y[ae]=Math.min(we,z[ae]*g)}else{var Ae=n*j.nb_2[J][ae],qe=t*j.nb_1[J][ae],pt;Ae<=0&&(Ae=we),qe<=0&&(qe=we),j.blocktype_old[J&1]==Se.NORM_TYPE?pt=Math.min(qe,Ae):pt=qe,Y[ae]=Math.min(we,pt)}j.nb_2[J][ae]=j.nb_1[J][ae],j.nb_1[J][ae]=we,ce=X[ae],ce*=j.minval_l[ae],ce*=He,Y[ae]>ce&&(Y[ae]=ce),j.masking_lower>1&&(Y[ae]*=j.masking_lower),Y[ae]>z[ae]&&(Y[ae]=z[ae]),j.masking_lower<1&&(Y[ae]*=j.masking_lower),Ze(Y[ae]>=0)}for(;ae<Se.CBANDS;++ae)z[ae]=0,Y[ae]=0}function Ct(j,K){var z=j.internal_flags;j.short_blocks==to.short_block_coupled&&!(K[0]!=0&&K[1]!=0)&&(K[0]=K[1]=0);for(var Y=0;Y<z.channels_out;Y++)j.short_blocks==to.short_block_dispensed&&(K[Y]=1),j.short_blocks==to.short_block_forced&&(K[Y]=0)}function kt(j,K,z){for(var Y=j.internal_flags,J=0;J<Y.channels_out;J++){var X=Se.NORM_TYPE;K[J]!=0?(Ze(Y.blocktype_old[J]!=Se.START_TYPE),Y.blocktype_old[J]==Se.SHORT_TYPE&&(X=Se.STOP_TYPE)):(X=Se.SHORT_TYPE,Y.blocktype_old[J]==Se.NORM_TYPE&&(Y.blocktype_old[J]=Se.START_TYPE),Y.blocktype_old[J]==Se.STOP_TYPE&&(Y.blocktype_old[J]=Se.SHORT_TYPE)),z[J]=Y.blocktype_old[J],Y.blocktype_old[J]=X}}function bt(j,K,z,Y,J,X,ie){for(var oe=X*2,ae=X>0?Math.pow(10,J):1,fe,ce,we=0;we<ie;++we){var He=j[2][we],$e=j[3][we],Ee=K[0][we],Ye=K[1][we],ve=K[2][we],ze=K[3][we];if(Ee<=1.58*Ye&&Ye<=1.58*Ee){var pt=z[we]*$e,Ae=z[we]*He;ce=Math.max(ve,Math.min(ze,pt)),fe=Math.max(ze,Math.min(ve,Ae))}else ce=ve,fe=ze;if(X>0){var qe,Re,tt=Y[we]*ae;if(qe=Math.min(Math.max(Ee,tt),Math.max(Ye,tt)),ve=Math.max(ce,tt),ze=Math.max(fe,tt),Re=ve+ze,Re>0&&qe*oe<Re){var Vt=qe*oe/Re;ve*=Vt,ze*=Vt,Ze(Re>0)}ce=Math.min(ve,ce),fe=Math.min(ze,fe)}ce>He&&(ce=He),fe>$e&&(fe=$e),K[2][we]=ce,K[3][we]=fe}}this.L3psycho_anal_vbr=function(j,K,z,Y,J,X,ie,oe,ae,fe){var ce=j.internal_flags,we,He,$e=Bn(Se.HBLKSIZE),Ee=Ji([3,Se.HBLKSIZE_s]),Ye=Ji([2,Se.BLKSIZE]),ve=Ji([2,3,Se.BLKSIZE_s]),ze=Ji([4,Se.CBANDS]),pt=Ji([4,Se.CBANDS]),Ae=Ji([4,3]),qe=.6,Re=[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]],tt=Er(2),Vt=j.mode==MPEGMode.JOINT_STEREO?4:ce.channels_out;Ge(j,K,z,Y,J,X,ae,Ae,Re,tt),Ct(j,tt);{for(var We=0;We<Vt;We++){var ct=We&1;we=Ye,Oe(j,K,z,We,Y,$e,we,ct),Ve(j,Y,We,$e),tt[ct]!=0?Tt(ce,$e,ze[We],pt[We],We):dt(ce,We)}tt[0]+tt[1]==2&&j.mode==MPEGMode.JOINT_STEREO&&bt(ze,pt,ce.mld_cb_l,ce.ATH.cb_l,j.ATHlower*ce.ATH.adjust,j.msfix,ce.npart_l);for(var We=0;We<Vt;We++){var ct=We&1;tt[ct]!=0&&M(ce,ze[We],pt[We],We)}}{for(var _t=0;_t<3;_t++){for(var We=0;We<Vt;++We){var ct=We&1;tt[ct]!=0?lt(ce,We,_t):(He=ve,nt(j,K,z,We,_t,Ee,He,ct),Mt(j,Ee,ze[We],pt[We],We,_t))}tt[0]+tt[1]==0&&j.mode==MPEGMode.JOINT_STEREO&&bt(ze,pt,ce.mld_cb_s,ce.ATH.cb_s,j.ATHlower*ce.ATH.adjust,j.msfix,ce.npart_s);for(var We=0;We<Vt;++We){var ct=We&1;tt[ct]==0&&se(ce,ze[We],pt[We],We,_t)}}for(var We=0;We<Vt;We++){var ct=We&1;if(tt[ct]==0)for(var mt=0;mt<Se.SBMAX_s;mt++){for(var Cn=Bn(3),_t=0;_t<3;_t++){var Kt=ce.thm[We].s[mt][_t];if(Kt*=_,Re[We][_t]>=2||Re[We][_t+1]==1){var Wt=_t!=0?_t-1:2,en=ee(ce.thm[We].s[mt][Wt],Kt,m*qe);Kt=Math.min(Kt,en)}else if(Re[We][_t]==1){var Wt=_t!=0?_t-1:2,en=ee(ce.thm[We].s[mt][Wt],Kt,g*qe);Kt=Math.min(Kt,en)}else if(_t!=0&&Re[We][_t-1]==3||_t==0&&ce.nsPsy.lastAttacks[We]==3){var Wt=_t!=2?_t+1:0,en=ee(ce.thm[We].s[mt][Wt],Kt,g*qe);Kt=Math.min(Kt,en)}Kt*=Ae[We][_t],Cn[_t]=Kt}for(var _t=0;_t<3;_t++)ce.thm[We].s[mt][_t]=Cn[_t]}}}for(var We=0;We<Vt;We++)ce.nsPsy.lastAttacks[We]=Re[We][2];kt(j,tt,fe);for(var We=0;We<Vt;We++){var gn,En,qn,Hn;We>1?(gn=oe,En=-2,qn=Se.NORM_TYPE,(fe[0]==Se.SHORT_TYPE||fe[1]==Se.SHORT_TYPE)&&(qn=Se.SHORT_TYPE),Hn=X[Y][We-2]):(gn=ie,En=0,qn=fe[We],Hn=J[Y][We]),qn==Se.SHORT_TYPE?gn[En+We]=Pe(Hn,ce.masking_lower):gn[En+We]=ke(Hn,ce.masking_lower),j.analysis&&(ce.pinfo.pe[Y][We]=gn[En+We])}return 0};function Pt(j,K){var z=j,Y;return z>=0?Y=-z*27:Y=z*K,Y<=-72?0:Math.exp(Y*A)}function Xe(j){var K=0,z=0;{var Y=0,J,X;for(Y=0;Pt(Y,j)>1e-20;Y-=1);for(J=Y,X=0;Math.abs(X-J)>1e-12;)Y=(X+J)/2,Pt(Y,j)>0?X=Y:J=Y;K=J}{var Y=0,J,X;for(Y=0;Pt(Y,j)>1e-20;Y+=1);for(J=0,X=Y;Math.abs(X-J)>1e-12;)Y=(X+J)/2,Pt(Y,j)>0?J=Y:X=Y;z=X}{var ie=0,oe=1e3,ae;for(ae=0;ae<=oe;++ae){var Y=K+ae*(z-K)/oe,fe=Pt(Y,j);ie+=fe}{var ce=(oe+1)/(ie*(z-K));return ce}}}function vt(j){var K,z,Y,J;return K=j,K>=0?K*=3:K*=1.5,K>=.5&&K<=2.5?(J=K-.5,z=8*(J*J-2*J)):z=0,K+=.474,Y=15.811389+7.5*K-17.5*Math.sqrt(1+K*K),Y<=-60?0:(K=Math.exp((z+Y)*A),K/=.6609193,K)}function Et(j){return j<0&&(j=0),j=j*.001,13*Math.atan(.76*j)+3.5*Math.atan(j*j/(7.5*7.5))}function Sn(j,K,z,Y,J,X,ie,oe,ae,fe,ce,we){var He=Bn(Se.CBANDS+1),$e=oe/(we>15?2*576:2*192),Ee=Er(Se.HBLKSIZE),Ye;oe/=ae;var ve=0,ze=0;for(Ye=0;Ye<Se.CBANDS;Ye++){var pt,Ae;for(pt=Et(oe*ve),He[Ye]=oe*ve,Ae=ve;Et(oe*Ae)-pt<h&&Ae<=ae/2;Ae++);for(j[Ye]=Ae-ve,ze=Ye+1;ve<Ae;)Ze(ve<Se.HBLKSIZE),Ee[ve++]=Ye;if(ve>ae/2){ve=ae/2,++Ye;break}}Ze(Ye<Se.CBANDS),He[Ye]=oe*ve;for(var qe=0;qe<we;qe++){var Re,tt,Vt,We,ct;Vt=fe[qe],We=fe[qe+1],Re=0|Math.floor(.5+ce*(Vt-.5)),Re<0&&(Re=0),tt=0|Math.floor(.5+ce*(We-.5)),tt>ae/2&&(tt=ae/2),z[qe]=(Ee[Re]+Ee[tt])/2,K[qe]=Ee[tt];var _t=$e*We;ie[qe]=(_t-He[K[qe]])/(He[K[qe]+1]-He[K[qe]]),ie[qe]<0?ie[qe]=0:ie[qe]>1&&(ie[qe]=1),ct=Et(oe*fe[qe]*ce),ct=Math.min(ct,15.5)/15.5,X[qe]=Math.pow(10,1.25*(1-Math.cos(Math.PI*ct))-2.5)}ve=0;for(var mt=0;mt<ze;mt++){var Cn=j[mt],pt,Kt;pt=Et(oe*ve),Kt=Et(oe*(ve+Cn-1)),Y[mt]=.5*(pt+Kt),pt=Et(oe*(ve-.5)),Kt=Et(oe*(ve+Cn-.5)),J[mt]=Kt-pt,ve+=Cn}return ze}function Hi(j,K,z,Y,J,X){var ie=Ji([Se.CBANDS,Se.CBANDS]),oe,ae=0;if(X)for(var fe=0;fe<K;fe++)for(oe=0;oe<K;oe++){var ce=vt(z[fe]-z[oe])*Y[oe];ie[fe][oe]=ce*J[fe]}else for(oe=0;oe<K;oe++)for(var we=15+Math.min(21/z[oe],12),He=Xe(we),fe=0;fe<K;fe++){var ce=He*Pt(z[fe]-z[oe],we)*Y[oe];ie[fe][oe]=ce*J[fe]}for(var fe=0;fe<K;fe++){for(oe=0;oe<K&&!(ie[fe][oe]>0);oe++);for(j[fe][0]=oe,oe=K-1;oe>0&&!(ie[fe][oe]>0);oe--);j[fe][1]=oe,ae+=j[fe][1]-j[fe][0]+1}for(var $e=Bn(ae),Ee=0,fe=0;fe<K;fe++)for(oe=j[fe][0];oe<=j[fe][1];oe++)$e[Ee++]=ie[fe][oe];return $e}function On(j){var K=Et(j);return K=Math.min(K,15.5)/15.5,Math.pow(10,1.25*(1-Math.cos(Math.PI*K))-2.5)}this.psymodel_init=function(j){var K=j.internal_flags,z,Y=!0,J=13,X=24,ie=0,oe=0,ae=-8.25,fe=-4.5,ce=Bn(Se.CBANDS),we=Bn(Se.CBANDS),He=Bn(Se.CBANDS),$e=j.out_samplerate;switch(j.experimentalZ){default:case 0:Y=!0;break;case 1:Y=!(j.VBR==eo.vbr_mtrh||j.VBR==eo.vbr_mt);break;case 2:Y=!1;break;case 3:J=8,ie=-1.75,oe=-.0125,ae=-8.25,fe=-2.25;break}for(K.ms_ener_ratio_old=.25,K.blocktype_old[0]=K.blocktype_old[1]=Se.NORM_TYPE,z=0;z<4;++z){for(var ve=0;ve<Se.CBANDS;++ve)K.nb_1[z][ve]=1e20,K.nb_2[z][ve]=1e20,K.nb_s1[z][ve]=K.nb_s2[z][ve]=1;for(var Ee=0;Ee<Se.SBMAX_l;Ee++)K.en[z].l[Ee]=1e20,K.thm[z].l[Ee]=1e20;for(var ve=0;ve<3;++ve){for(var Ee=0;Ee<Se.SBMAX_s;Ee++)K.en[z].s[Ee][ve]=1e20,K.thm[z].s[Ee][ve]=1e20;K.nsPsy.lastAttacks[z]=0}for(var ve=0;ve<9;ve++)K.nsPsy.last_en_subshort[z][ve]=10}for(K.loudness_sq_save[0]=K.loudness_sq_save[1]=0,K.npart_l=Sn(K.numlines_l,K.bo_l,K.bm_l,ce,we,K.mld_l,K.PSY.bo_l_weight,$e,Se.BLKSIZE,K.scalefac_band.l,Se.BLKSIZE/(2*576),Se.SBMAX_l),Ze(K.npart_l<Se.CBANDS),z=0;z<K.npart_l;z++){var Ye=ie;ce[z]>=J&&(Ye=oe*(ce[z]-J)/(X-J)+ie*(X-ce[z])/(X-J)),He[z]=Math.pow(10,Ye/10),K.numlines_l[z]>0?K.rnumlines_l[z]=1/K.numlines_l[z]:K.rnumlines_l[z]=0}K.s3_ll=Hi(K.s3ind,K.npart_l,ce,we,He,Y);var ve=0;for(z=0;z<K.npart_l;z++){var ze;ze=Ld.MAX_VALUE;for(var pt=0;pt<K.numlines_l[z];pt++,ve++){var Ae=$e*ve/(1e3*Se.BLKSIZE),qe;qe=this.ATHformula(Ae*1e3,j)-20,qe=Math.pow(10,.1*qe),qe*=K.numlines_l[z],ze>qe&&(ze=qe)}K.ATH.cb_l[z]=ze,ze=-20+ce[z]*20/10,ze>6&&(ze=100),ze<-15&&(ze=-15),ze-=8,K.minval_l[z]=Math.pow(10,ze/10)*K.numlines_l[z]}for(K.npart_s=Sn(K.numlines_s,K.bo_s,K.bm_s,ce,we,K.mld_s,K.PSY.bo_s_weight,$e,Se.BLKSIZE_s,K.scalefac_band.s,Se.BLKSIZE_s/(2*192),Se.SBMAX_s),Ze(K.npart_s<Se.CBANDS),ve=0,z=0;z<K.npart_s;z++){var ze,Ye=ae;ce[z]>=J&&(Ye=fe*(ce[z]-J)/(X-J)+ae*(X-ce[z])/(X-J)),He[z]=Math.pow(10,Ye/10),ze=Ld.MAX_VALUE;for(var pt=0;pt<K.numlines_s[z];pt++,ve++){var Ae=$e*ve/(1e3*Se.BLKSIZE_s),qe;qe=this.ATHformula(Ae*1e3,j)-20,qe=Math.pow(10,.1*qe),qe*=K.numlines_s[z],ze>qe&&(ze=qe)}K.ATH.cb_s[z]=ze,ze=-7+ce[z]*7/12,ce[z]>12&&(ze*=1+Math.log(1+ze)*3.1),ce[z]<12&&(ze*=1+Math.log(1-ze)*2.3),ze<-15&&(ze=-15),ze-=8,K.minval_s[z]=Math.pow(10,ze/10)*K.numlines_s[z]}K.s3_ss=Hi(K.s3ind_s,K.npart_s,ce,we,He,Y),L(),r.init_fft(K),K.decay=Math.exp(-1*e/(c*$e/192));{var Re;Re=S,j.exp_nspsytune&2&&(Re=1),Math.abs(j.msfix)>0&&(Re=j.msfix),j.msfix=Re;for(var tt=0;tt<K.npart_l;tt++)K.s3ind[tt][1]>K.npart_l-1&&(K.s3ind[tt][1]=K.npart_l-1)}var Vt=576*K.mode_gr/$e;if(K.ATH.decay=Math.pow(10,-12/10*Vt),K.ATH.adjust=.01,K.ATH.adjustLimit=1,Ze(K.bo_l[Se.SBMAX_l-1]<=K.npart_l),Ze(K.bo_s[Se.SBMAX_s-1]<=K.npart_s),j.ATHtype!=-1){var Ae,We=j.out_samplerate/Se.BLKSIZE,ct=0;for(Ae=0,z=0;z<Se.BLKSIZE/2;++z)Ae+=We,K.ATH.eql_w[z]=1/Math.pow(10,this.ATHformula(Ae,j)/10),ct+=K.ATH.eql_w[z];for(ct=1/ct,z=Se.BLKSIZE/2;--z>=0;)K.ATH.eql_w[z]*=ct}{for(var tt=ve=0;tt<K.npart_s;++tt)for(z=0;z<K.numlines_s[tt];++z)++ve;Ze(ve==129);for(var tt=ve=0;tt<K.npart_l;++tt)for(z=0;z<K.numlines_l[tt];++z)++ve;Ze(ve==513)}for(ve=0,z=0;z<K.npart_l;z++){var Ae=$e*(ve+K.numlines_l[z]/2)/(1*Se.BLKSIZE);K.mld_cb_l[z]=On(Ae),ve+=K.numlines_l[z]}for(;z<Se.CBANDS;++z)K.mld_cb_l[z]=1;for(ve=0,z=0;z<K.npart_s;z++){var Ae=$e*(ve+K.numlines_s[z]/2)/(1*Se.BLKSIZE_s);K.mld_cb_s[z]=On(Ae),ve+=K.numlines_s[z]}for(;z<Se.CBANDS;++z)K.mld_cb_s[z]=1;return 0};function Ht(j,K){j<-.3&&(j=3410),j/=1e3,j=Math.max(.1,j);var z=3.64*Math.pow(j,-.8)-6.8*Math.exp(-.6*Math.pow(j-3.4,2))+6*Math.exp(-.15*Math.pow(j-8.7,2))+(.6+.04*K)*.001*Math.pow(j,4);return z}this.ATHformula=function(j,K){var z;switch(K.ATHtype){case 0:z=Ht(j,9);break;case 1:z=Ht(j,-1);break;case 2:z=Ht(j,0);break;case 3:z=Ht(j,1)+6;break;case 4:z=Ht(j,K.ATHcurve);break;default:z=Ht(j,0);break}return z}}var Cg=Sg;function gs(r){var e=r;this.ordinal=function(){return e}}gs.STEREO=new gs(0);gs.JOINT_STEREO=new gs(1);gs.DUAL_CHANNEL=new gs(2);gs.MONO=new gs(3);gs.NOT_SET=new gs(4);var g0=gs,kg=g0;function Pg(){this.class_id=0,this.num_samples=0,this.num_channels=0,this.in_samplerate=0,this.out_samplerate=0,this.scale=0,this.scale_left=0,this.scale_right=0,this.analysis=!1,this.bWriteVbrTag=!1,this.decode_only=!1,this.quality=0,this.mode=kg.STEREO,this.force_ms=!1,this.free_format=!1,this.findReplayGain=!1,this.decode_on_the_fly=!1,this.write_id3tag_automatic=!1,this.brate=0,this.compression_ratio=0,this.copyright=0,this.original=0,this.extension=0,this.emphasis=0,this.error_protection=0,this.strict_ISO=!1,this.disable_reservoir=!1,this.quant_comp=0,this.quant_comp_short=0,this.experimentalY=!1,this.experimentalZ=0,this.exp_nspsytune=0,this.preset=0,this.VBR=null,this.VBR_q_frac=0,this.VBR_q=0,this.VBR_mean_bitrate_kbps=0,this.VBR_min_bitrate_kbps=0,this.VBR_max_bitrate_kbps=0,this.VBR_hard_min=0,this.lowpassfreq=0,this.highpassfreq=0,this.lowpasswidth=0,this.highpasswidth=0,this.maskingadjust=0,this.maskingadjust_short=0,this.ATHonly=!1,this.ATHshort=!1,this.noATH=!1,this.ATHtype=0,this.ATHcurve=0,this.ATHlower=0,this.athaa_type=0,this.athaa_loudapprox=0,this.athaa_sensitivity=0,this.short_blocks=null,this.useTemporal=!1,this.interChRatio=0,this.msfix=0,this.tune=!1,this.tune_value_a=0,this.version=0,this.encoder_delay=0,this.encoder_padding=0,this.framesize=0,this.frameNum=0,this.lame_allocated_gfp=0,this.internal_flags=null}var Eg=Pg,Bg=Qn(),v0={};v0.SFBMAX=Bg.SBMAX_s*3;var Ja=v0,Si=fn;Si.System;Si.VbrMode;Si.Float;Si.ShortBlock;Si.Util;Si.Arrays;Si.new_array_n;Si.new_byte;Si.new_double;var Mg=Si.new_float;Si.new_float_n;var Br=Si.new_int;Si.new_int_n;Si.assert;var Kl=Ja;function Tg(){this.xr=Mg(576),this.l3_enc=Br(576),this.scalefac=Br(Kl.SFBMAX),this.xrpow_max=0,this.part2_3_length=0,this.big_values=0,this.count1=0,this.global_gain=0,this.scalefac_compress=0,this.block_type=0,this.mixed_block_flag=0,this.table_select=Br(3),this.subblock_gain=Br(4),this.region0_count=0,this.region1_count=0,this.preflag=0,this.scalefac_scale=0,this.count1table_select=0,this.part2_length=0,this.sfb_lmax=0,this.sfb_smin=0,this.psy_lmax=0,this.sfbmax=0,this.psymax=0,this.sfbdivide=0,this.width=Br(Kl.SFBMAX),this.window=Br(Kl.SFBMAX),this.count1bits=0,this.sfb_partition_table=null,this.slen=Br(4),this.max_nonzero_coeff=0;var r=this;function e(n){return new Int32Array(n)}function t(n){return new Float32Array(n)}this.assign=function(n){r.xr=t(n.xr),r.l3_enc=e(n.l3_enc),r.scalefac=e(n.scalefac),r.xrpow_max=n.xrpow_max,r.part2_3_length=n.part2_3_length,r.big_values=n.big_values,r.count1=n.count1,r.global_gain=n.global_gain,r.scalefac_compress=n.scalefac_compress,r.block_type=n.block_type,r.mixed_block_flag=n.mixed_block_flag,r.table_select=e(n.table_select),r.subblock_gain=e(n.subblock_gain),r.region0_count=n.region0_count,r.region1_count=n.region1_count,r.preflag=n.preflag,r.scalefac_scale=n.scalefac_scale,r.count1table_select=n.count1table_select,r.part2_length=n.part2_length,r.sfb_lmax=n.sfb_lmax,r.sfb_smin=n.sfb_smin,r.psy_lmax=n.psy_lmax,r.sfbmax=n.sfbmax,r.psymax=n.psymax,r.sfbdivide=n.sfbdivide,r.width=e(n.width),r.window=e(n.window),r.count1bits=n.count1bits,r.sfb_partition_table=n.sfb_partition_table.slice(0),r.slen=e(n.slen),r.max_nonzero_coeff=n.max_nonzero_coeff}}var Nh=Tg,Ci=fn;Ci.System;Ci.VbrMode;Ci.Float;Ci.ShortBlock;Ci.Util;Ci.Arrays;Ci.new_array_n;Ci.new_byte;Ci.new_double;Ci.new_float;Ci.new_float_n;var Nd=Ci.new_int;Ci.new_int_n;Ci.assert;var Ig=Nh;function Ag(){this.tt=[[null,null],[null,null]],this.main_data_begin=0,this.private_bits=0,this.resvDrain_pre=0,this.resvDrain_post=0,this.scfsi=[Nd(4),Nd(4)];for(var r=0;r<2;r++)for(var e=0;e<2;e++)this.tt[r][e]=new Ig}var Rg=Ag,ki=fn,ga=ki.System;ki.VbrMode;ki.Float;ki.ShortBlock;ki.Util;ki.Arrays;ki.new_array_n;ki.new_byte;ki.new_double;ki.new_float;ki.new_float_n;var va=ki.new_int;ki.new_int_n;ki.assert;var ba=Qn();function Lg(r,e,t,n){this.l=va(1+ba.SBMAX_l),this.s=va(1+ba.SBMAX_s),this.psfb21=va(1+ba.PSFB21),this.psfb12=va(1+ba.PSFB12);var i=this.l,s=this.s;arguments.length==4&&(this.arrL=arguments[0],this.arrS=arguments[1],this.arr21=arguments[2],this.arr12=arguments[3],ga.arraycopy(this.arrL,0,i,0,Math.min(this.arrL.length,this.l.length)),ga.arraycopy(this.arrS,0,s,0,Math.min(this.arrS.length,this.s.length)),ga.arraycopy(this.arr21,0,this.psfb21,0,Math.min(this.arr21.length,this.psfb21.length)),ga.arraycopy(this.arr12,0,this.psfb12,0,Math.min(this.arr12.length,this.psfb12.length)))}var b0=Lg,Pi=fn;Pi.System;Pi.VbrMode;Pi.Float;Pi.ShortBlock;Pi.Util;Pi.Arrays;Pi.new_array_n;Pi.new_byte;Pi.new_double;var Gl=Pi.new_float,Ng=Pi.new_float_n,Dg=Pi.new_int;Pi.new_int_n;Pi.assert;var Dd=Qn();function Fg(){this.last_en_subshort=Ng([4,9]),this.lastAttacks=Dg(4),this.pefirbuf=Gl(19),this.longfact=Gl(Dd.SBMAX_l),this.shortfact=Gl(Dd.SBMAX_s),this.attackthre=0,this.attackthre_s=0}var Og=Fg;function Hg(){this.sum=0,this.seen=0,this.want=0,this.pos=0,this.size=0,this.bag=null,this.nVbrNumFrames=0,this.nBytesWritten=0,this.TotalFrameSize=0}var Vg=Hg,Ei=fn;Ei.System;Ei.VbrMode;Ei.Float;Ei.ShortBlock;Ei.Util;Ei.Arrays;Ei.new_array_n;var Wg=Ei.new_byte,qg=Ei.new_double,es=Ei.new_float,Mr=Ei.new_float_n,cs=Ei.new_int,ya=Ei.new_int_n;Ei.assert;var Ug=Rg,zg=b0,Xg=Og,$g=Vg,Fd=m0(),xn=Qn(),Yg=Ja;Xs.MFSIZE=3*1152+xn.ENCDELAY-xn.MDCTDELAY;Xs.MAX_HEADER_BUF=256;Xs.MAX_BITS_PER_CHANNEL=4095;Xs.MAX_BITS_PER_GRANULE=7680;Xs.BPC=320;function Xs(){var r=40;this.Class_ID=0,this.lame_encode_frame_init=0,this.iteration_init_init=0,this.fill_buffer_resample_init=0,this.mfbuf=Mr([2,Xs.MFSIZE]),this.mode_gr=0,this.channels_in=0,this.channels_out=0,this.resample_ratio=0,this.mf_samples_to_encode=0,this.mf_size=0,this.VBR_min_bitrate=0,this.VBR_max_bitrate=0,this.bitrate_index=0,this.samplerate_index=0,this.mode_ext=0,this.lowpass1=0,this.lowpass2=0,this.highpass1=0,this.highpass2=0,this.noise_shaping=0,this.noise_shaping_amp=0,this.substep_shaping=0,this.psymodel=0,this.noise_shaping_stop=0,this.subblock_gain=0,this.use_best_huffman=0,this.full_outer_loop=0,this.l3_side=new Ug,this.ms_ratio=es(2),this.padding=0,this.frac_SpF=0,this.slot_lag=0,this.tag_spec=null,this.nMusicCRC=0,this.OldValue=cs(2),this.CurrentStep=cs(2),this.masking_lower=0,this.bv_scf=cs(576),this.pseudohalf=cs(Yg.SFBMAX),this.sfb21_extra=!1,this.inbuf_old=new Array(2),this.blackfilt=new Array(2*Xs.BPC+1),this.itime=qg(2),this.sideinfo_len=0,this.sb_sample=Mr([2,2,18,xn.SBLIMIT]),this.amp_filter=es(32);function e(){this.write_timing=0,this.ptr=0,this.buf=Wg(r)}this.header=new Array(Xs.MAX_HEADER_BUF),this.h_ptr=0,this.w_ptr=0,this.ancillary_flag=0,this.ResvSize=0,this.ResvMax=0,this.scalefac_band=new zg,this.minval_l=es(xn.CBANDS),this.minval_s=es(xn.CBANDS),this.nb_1=Mr([4,xn.CBANDS]),this.nb_2=Mr([4,xn.CBANDS]),this.nb_s1=Mr([4,xn.CBANDS]),this.nb_s2=Mr([4,xn.CBANDS]),this.s3_ss=null,this.s3_ll=null,this.decay=0,this.thm=new Array(4),this.en=new Array(4),this.tot_ener=es(4),this.loudness_sq=Mr([2,2]),this.loudness_sq_save=es(2),this.mld_l=es(xn.SBMAX_l),this.mld_s=es(xn.SBMAX_s),this.bm_l=cs(xn.SBMAX_l),this.bo_l=cs(xn.SBMAX_l),this.bm_s=cs(xn.SBMAX_s),this.bo_s=cs(xn.SBMAX_s),this.npart_l=0,this.npart_s=0,this.s3ind=ya([xn.CBANDS,2]),this.s3ind_s=ya([xn.CBANDS,2]),this.numlines_s=cs(xn.CBANDS),this.numlines_l=cs(xn.CBANDS),this.rnumlines_l=es(xn.CBANDS),this.mld_cb_l=es(xn.CBANDS),this.mld_cb_s=es(xn.CBANDS),this.numlines_s_num1=0,this.numlines_l_num1=0,this.pe=es(4),this.ms_ratio_s_old=0,this.ms_ratio_l_old=0,this.ms_ener_ratio_old=0,this.blocktype_old=cs(2),this.nsPsy=new Xg,this.VBR_seek_table=new $g,this.ATH=null,this.PSY=null,this.nogap_total=0,this.nogap_current=0,this.decode_on_the_fly=!0,this.findReplayGain=!0,this.findPeakSample=!0,this.PeakSample=0,this.RadioGain=0,this.AudiophileGain=0,this.rgdata=null,this.noclipGainChange=0,this.noclipScale=0,this.bitrate_stereoMode_Hist=ya([16,5]),this.bitrate_blockType_Hist=ya([16,6]),this.pinfo=null,this.hip=null,this.in_buffer_nsamples=0,this.in_buffer_0=null,this.in_buffer_1=null,this.iteration_loop=null;for(var t=0;t<this.en.length;t++)this.en[t]=new Fd;for(var t=0;t<this.thm.length;t++)this.thm[t]=new Fd;for(var t=0;t<this.header.length;t++)this.header[t]=new e}var el=Xs,Bi=fn;Bi.System;Bi.VbrMode;Bi.Float;Bi.ShortBlock;Bi.Util;Bi.Arrays;Bi.new_array_n;Bi.new_byte;Bi.new_double;var Tr=Bi.new_float;Bi.new_float_n;Bi.new_int;Bi.new_int_n;Bi.assert;var Ir=Qn();function jg(){this.useAdjust=0,this.aaSensitivityP=0,this.adjust=0,this.adjustLimit=0,this.decay=0,this.floor=0,this.l=Tr(Ir.SBMAX_l),this.s=Tr(Ir.SBMAX_s),this.psfb21=Tr(Ir.PSFB21),this.psfb12=Tr(Ir.PSFB12),this.cb_l=Tr(Ir.CBANDS),this.cb_s=Tr(Ir.CBANDS),this.eql_w=Tr(Ir.BLKSIZE/2)}var Kg=jg,Mi=fn,ui=Mi.System;Mi.VbrMode;Mi.Float;Mi.ShortBlock;Mi.Util;var Od=Mi.Arrays;Mi.new_array_n;Mi.new_byte;Mi.new_double;Mi.new_float;Mi.new_float_n;Mi.new_int;Mi.new_int_n;Mi.assert;dn.STEPS_per_dB=100;dn.MAX_dB=120;dn.GAIN_NOT_ENOUGH_SAMPLES=-24601;dn.GAIN_ANALYSIS_ERROR=0;dn.GAIN_ANALYSIS_OK=1;dn.INIT_GAIN_ANALYSIS_ERROR=0;dn.INIT_GAIN_ANALYSIS_OK=1;dn.YULE_ORDER=10;dn.MAX_ORDER=dn.YULE_ORDER;dn.MAX_SAMP_FREQ=48e3;dn.RMS_WINDOW_TIME_NUMERATOR=1;dn.RMS_WINDOW_TIME_DENOMINATOR=20;dn.MAX_SAMPLES_PER_WINDOW=dn.MAX_SAMP_FREQ*dn.RMS_WINDOW_TIME_NUMERATOR/dn.RMS_WINDOW_TIME_DENOMINATOR+1;function dn(){var r=64.82;dn.YULE_ORDER;var e=.95;dn.MAX_SAMP_FREQ;var t=dn.RMS_WINDOW_TIME_NUMERATOR,n=dn.RMS_WINDOW_TIME_DENOMINATOR;dn.MAX_SAMPLES_PER_WINDOW;var i=[[.038575994352,-3.84664617118067,-.02160367184185,7.81501653005538,-.00123395316851,-11.34170355132042,-9291677959e-14,13.05504219327545,-.01655260341619,-12.28759895145294,.02161526843274,9.4829380631979,-.02074045215285,-5.87257861775999,.00594298065125,2.75465861874613,.00306428023191,-.86984376593551,.00012025322027,.13919314567432,.00288463683916],[.0541865640643,-3.47845948550071,-.02911007808948,6.36317777566148,-.00848709379851,-8.54751527471874,-.00851165645469,9.4769360780128,-.00834990904936,-8.81498681370155,.02245293253339,6.85401540936998,-.02596338512915,-4.39470996079559,.01624864962975,2.19611684890774,-.00240879051584,-.75104302451432,.00674613682247,.13149317958808,-.00187763777362],[.15457299681924,-2.37898834973084,-.09331049056315,2.84868151156327,-.06247880153653,-2.64577170229825,.02163541888798,2.23697657451713,-.05588393329856,-1.67148153367602,.04781476674921,1.00595954808547,.00222312597743,-.45953458054983,.03174092540049,.16378164858596,-.01390589421898,-.05032077717131,.00651420667831,.0234789740702,-.00881362733839],[.30296907319327,-1.61273165137247,-.22613988682123,1.0797749225997,-.08587323730772,-.2565625775407,.03282930172664,-.1627671912044,-.00915702933434,-.22638893773906,-.02364141202522,.39120800788284,-.00584456039913,-.22138138954925,.06276101321749,.04500235387352,-828086748e-14,.02005851806501,.00205861885564,.00302439095741,-.02950134983287],[.33642304856132,-1.49858979367799,-.2557224142557,.87350271418188,-.11828570177555,.12205022308084,.11921148675203,-.80774944671438,-.07834489609479,.47854794562326,-.0046997791438,-.12453458140019,-.0058950022444,-.04067510197014,.05724228140351,.08333755284107,.00832043980773,-.04237348025746,-.0163538138454,.02977207319925,-.0176017656815],[.4491525660845,-.62820619233671,-.14351757464547,.29661783706366,-.22784394429749,-.372563729424,-.01419140100551,.00213767857124,.04078262797139,-.42029820170918,-.12398163381748,.22199650564824,.04097565135648,.00613424350682,.10478503600251,.06747620744683,-.01863887810927,.05784820375801,-.03193428438915,.03222754072173,.00541907748707],[.56619470757641,-1.04800335126349,-.75464456939302,.29156311971249,.1624213774223,-.26806001042947,.16744243493672,.00819999645858,-.18901604199609,.45054734505008,.3093178284183,-.33032403314006,-.27562961986224,.0673936833311,.00647310677246,-.04784254229033,.08647503780351,.01639907836189,-.0378898455484,.01807364323573,-.00588215443421],[.58100494960553,-.51035327095184,-.53174909058578,-.31863563325245,-.14289799034253,-.20256413484477,.17520704835522,.1472815413433,.02377945217615,.38952639978999,.15558449135573,-.23313271880868,-.25344790059353,-.05246019024463,.01628462406333,-.02505961724053,.06920467763959,.02442357316099,-.03721611395801,.01818801111503,-.00749618797172],[.53648789255105,-.2504987195602,-.42163034350696,-.43193942311114,-.00275953611929,-.03424681017675,.04267842219415,-.04678328784242,-.10214864179676,.26408300200955,.14590772289388,.15113130533216,-.02459864859345,-.17556493366449,-.11202315195388,-.18823009262115,-.04060034127,.05477720428674,.0478866554818,.0470440968812,-.02217936801134]],s=[[.98621192462708,-1.97223372919527,-1.97242384925416,.97261396931306,.98621192462708],[.98500175787242,-1.96977855582618,-1.97000351574484,.9702284756635,.98500175787242],[.97938932735214,-1.95835380975398,-1.95877865470428,.95920349965459,.97938932735214],[.97531843204928,-1.95002759149878,-1.95063686409857,.95124613669835,.97531843204928],[.97316523498161,-1.94561023566527,-1.94633046996323,.94705070426118,.97316523498161],[.96454515552826,-1.92783286977036,-1.92909031105652,.93034775234268,.96454515552826],[.96009142950541,-1.91858953033784,-1.92018285901082,.92177618768381,.96009142950541],[.95856916599601,-1.9154210807478,-1.91713833199203,.91885558323625,.95856916599601],[.94597685600279,-1.88903307939452,-1.89195371200558,.89487434461664,.94597685600279]];function h(g,S,E,A,C,k){for(;C--!=0;)E[A]=1e-10+g[S+0]*k[0]-E[A-1]*k[1]+g[S-1]*k[2]-E[A-2]*k[3]+g[S-2]*k[4]-E[A-3]*k[5]+g[S-3]*k[6]-E[A-4]*k[7]+g[S-4]*k[8]-E[A-5]*k[9]+g[S-5]*k[10]-E[A-6]*k[11]+g[S-6]*k[12]-E[A-7]*k[13]+g[S-7]*k[14]-E[A-8]*k[15]+g[S-8]*k[16]-E[A-9]*k[17]+g[S-9]*k[18]-E[A-10]*k[19]+g[S-10]*k[20],++A,++S}function d(g,S,E,A,C,k){for(;C--!=0;)E[A]=g[S+0]*k[0]-E[A-1]*k[1]+g[S-1]*k[2]-E[A-2]*k[3]+g[S-2]*k[4],++A,++S}function c(g,S){for(var E=0;E<MAX_ORDER;E++)g.linprebuf[E]=g.lstepbuf[E]=g.loutbuf[E]=g.rinprebuf[E]=g.rstepbuf[E]=g.routbuf[E]=0;switch(0|S){case 48e3:g.reqindex=0;break;case 44100:g.reqindex=1;break;case 32e3:g.reqindex=2;break;case 24e3:g.reqindex=3;break;case 22050:g.reqindex=4;break;case 16e3:g.reqindex=5;break;case 12e3:g.reqindex=6;break;case 11025:g.reqindex=7;break;case 8e3:g.reqindex=8;break;default:return INIT_GAIN_ANALYSIS_ERROR}return g.sampleWindow=0|(S*t+n-1)/n,g.lsum=0,g.rsum=0,g.totsamp=0,Od.ill(g.A,0),INIT_GAIN_ANALYSIS_OK}this.InitGainAnalysis=function(g,S){return c(g,S)!=INIT_GAIN_ANALYSIS_OK?INIT_GAIN_ANALYSIS_ERROR:(g.linpre=MAX_ORDER,g.rinpre=MAX_ORDER,g.lstep=MAX_ORDER,g.rstep=MAX_ORDER,g.lout=MAX_ORDER,g.rout=MAX_ORDER,Od.fill(g.B,0),INIT_GAIN_ANALYSIS_OK)};function _(g){return g*g}this.AnalyzeSamples=function(g,S,E,A,C,k,T){var b,R,V,f,D,l,W;if(k==0)return GAIN_ANALYSIS_OK;switch(W=0,D=k,T){case 1:A=S,C=E;break;case 2:break;default:return GAIN_ANALYSIS_ERROR}for(k<MAX_ORDER?(ui.arraycopy(S,E,g.linprebuf,MAX_ORDER,k),ui.arraycopy(A,C,g.rinprebuf,MAX_ORDER,k)):(ui.arraycopy(S,E,g.linprebuf,MAX_ORDER,MAX_ORDER),ui.arraycopy(A,C,g.rinprebuf,MAX_ORDER,MAX_ORDER));D>0;){l=D>g.sampleWindow-g.totsamp?g.sampleWindow-g.totsamp:D,W<MAX_ORDER?(b=g.linpre+W,R=g.linprebuf,V=g.rinpre+W,f=g.rinprebuf,l>MAX_ORDER-W&&(l=MAX_ORDER-W)):(b=E+W,R=S,V=C+W,f=A),h(R,b,g.lstepbuf,g.lstep+g.totsamp,l,i[g.reqindex]),h(f,V,g.rstepbuf,g.rstep+g.totsamp,l,i[g.reqindex]),d(g.lstepbuf,g.lstep+g.totsamp,g.loutbuf,g.lout+g.totsamp,l,s[g.reqindex]),d(g.rstepbuf,g.rstep+g.totsamp,g.routbuf,g.rout+g.totsamp,l,s[g.reqindex]),b=g.lout+g.totsamp,R=g.loutbuf,V=g.rout+g.totsamp,f=g.routbuf;for(var L=l%8;L--!=0;)g.lsum+=_(R[b++]),g.rsum+=_(f[V++]);for(L=l/8;L--!=0;)g.lsum+=_(R[b+0])+_(R[b+1])+_(R[b+2])+_(R[b+3])+_(R[b+4])+_(R[b+5])+_(R[b+6])+_(R[b+7]),b+=8,g.rsum+=_(f[V+0])+_(f[V+1])+_(f[V+2])+_(f[V+3])+_(f[V+4])+_(f[V+5])+_(f[V+6])+_(f[V+7]),V+=8;if(D-=l,W+=l,g.totsamp+=l,g.totsamp==g.sampleWindow){var P=dn.STEPS_per_dB*10*Math.log10((g.lsum+g.rsum)/g.totsamp*.5+1e-37),y=P<=0?0:0|P;y>=g.A.length&&(y=g.A.length-1),g.A[y]++,g.lsum=g.rsum=0,ui.arraycopy(g.loutbuf,g.totsamp,g.loutbuf,0,MAX_ORDER),ui.arraycopy(g.routbuf,g.totsamp,g.routbuf,0,MAX_ORDER),ui.arraycopy(g.lstepbuf,g.totsamp,g.lstepbuf,0,MAX_ORDER),ui.arraycopy(g.rstepbuf,g.totsamp,g.rstepbuf,0,MAX_ORDER),g.totsamp=0}if(g.totsamp>g.sampleWindow)return GAIN_ANALYSIS_ERROR}return k<MAX_ORDER?(ui.arraycopy(g.linprebuf,k,g.linprebuf,0,MAX_ORDER-k),ui.arraycopy(g.rinprebuf,k,g.rinprebuf,0,MAX_ORDER-k),ui.arraycopy(S,E,g.linprebuf,MAX_ORDER-k,k),ui.arraycopy(A,C,g.rinprebuf,MAX_ORDER-k,k)):(ui.arraycopy(S,E+k-MAX_ORDER,g.linprebuf,0,MAX_ORDER),ui.arraycopy(A,C+k-MAX_ORDER,g.rinprebuf,0,MAX_ORDER)),GAIN_ANALYSIS_OK};function m(g,S){var E,A=0;for(E=0;E<S;E++)A+=g[E];if(A==0)return GAIN_NOT_ENOUGH_SAMPLES;var C=0|Math.ceil(A*(1-e));for(E=S;E-- >0&&!((C-=g[E])<=0););return r-E/dn.STEPS_per_dB}this.GetTitleGain=function(g){for(var S=m(g.A,g.A.length),E=0;E<g.A.length;E++)g.B[E]+=g.A[E],g.A[E]=0;for(var E=0;E<MAX_ORDER;E++)g.linprebuf[E]=g.lstepbuf[E]=g.loutbuf[E]=g.rinprebuf[E]=g.rstepbuf[E]=g.routbuf[E]=0;return g.totsamp=0,g.lsum=g.rsum=0,S}}var y0=dn,Ti=fn;Ti.System;Ti.VbrMode;Ti.Float;Ti.ShortBlock;Ti.Util;Ti.Arrays;Ti.new_array_n;Ti.new_byte;Ti.new_double;var no=Ti.new_float;Ti.new_float_n;var Hd=Ti.new_int;Ti.new_int_n;Ti.assert;var fi=y0;function Gg(){this.linprebuf=no(fi.MAX_ORDER*2),this.linpre=0,this.lstepbuf=no(fi.MAX_SAMPLES_PER_WINDOW+fi.MAX_ORDER),this.lstep=0,this.loutbuf=no(fi.MAX_SAMPLES_PER_WINDOW+fi.MAX_ORDER),this.lout=0,this.rinprebuf=no(fi.MAX_ORDER*2),this.rinpre=0,this.rstepbuf=no(fi.MAX_SAMPLES_PER_WINDOW+fi.MAX_ORDER),this.rstep=0,this.routbuf=no(fi.MAX_SAMPLES_PER_WINDOW+fi.MAX_ORDER),this.rout=0,this.sampleWindow=0,this.totsamp=0,this.lsum=0,this.rsum=0,this.freqindex=0,this.first=0,this.A=Hd(0|fi.STEPS_per_dB*fi.MAX_dB),this.B=Hd(0|fi.STEPS_per_dB*fi.MAX_dB)}var Zg=Gg;function Qg(r){this.bits=r}var w0=Qg,Ii=fn;Ii.System;Ii.VbrMode;Ii.Float;Ii.ShortBlock;Ii.Util;Ii.Arrays;Ii.new_array_n;Ii.new_byte;Ii.new_double;var Vd=Ii.new_float;Ii.new_float_n;var Jg=Ii.new_int;Ii.new_int_n;var Wd=Ii.assert,e2=w0,qd=Qn(),t2=Ja,n2=el;function i2(r){var e=r;this.quantize=e,this.iteration_loop=function(t,n,i,s){var h=t.internal_flags,d=Vd(t2.SFBMAX),c=Vd(576),_=Jg(2),m=0,g,S=h.l3_side,E=new e2(m);this.quantize.rv.ResvFrameBegin(t,E),m=E.bits;for(var A=0;A<h.mode_gr;A++){g=this.quantize.qupvt.on_pe(t,n,_,m,A,A),h.mode_ext==qd.MPG_MD_MS_LR&&(this.quantize.ms_convert(h.l3_side,A),this.quantize.qupvt.reduce_side(_,i[A],m,g));for(var C=0;C<h.channels_out;C++){var k,T,b=S.tt[A][C];b.block_type!=qd.SHORT_TYPE?(k=0,T=h.PSY.mask_adjust-k):(k=0,T=h.PSY.mask_adjust_short-k),h.masking_lower=Math.pow(10,T*.1),this.quantize.init_outer_loop(h,b),this.quantize.init_xrpow(h,b,c)&&(this.quantize.qupvt.calc_xmin(t,s[A][C],b,d),this.quantize.outer_loop(t,b,d,c,C,_[C])),this.quantize.iteration_finish_one(h,A,C),Wd(b.part2_3_length<=n2.MAX_BITS_PER_CHANNEL),Wd(b.part2_3_length<=_[C])}}this.quantize.rv.ResvFrameEnd(h,m)}}var s2=i2;function Ut(r,e,t,n){this.xlen=r,this.linmax=e,this.table=t,this.hlen=n}var De={};De.t1HB=[1,1,1,0];De.t2HB=[1,2,1,3,1,1,3,2,0];De.t3HB=[3,2,1,1,1,1,3,2,0];De.t5HB=[1,2,6,5,3,1,4,4,7,5,7,1,6,1,1,0];De.t6HB=[7,3,5,1,6,2,3,2,5,4,4,1,3,3,2,0];De.t7HB=[1,2,10,19,16,10,3,3,7,10,5,3,11,4,13,17,8,4,12,11,18,15,11,2,7,6,9,14,3,1,6,4,5,3,2,0];De.t8HB=[3,4,6,18,12,5,5,1,2,16,9,3,7,3,5,14,7,3,19,17,15,13,10,4,13,5,8,11,5,1,12,4,4,1,1,0];De.t9HB=[7,5,9,14,15,7,6,4,5,5,6,7,7,6,8,8,8,5,15,6,9,10,5,1,11,7,9,6,4,1,14,4,6,2,6,0];De.t10HB=[1,2,10,23,35,30,12,17,3,3,8,12,18,21,12,7,11,9,15,21,32,40,19,6,14,13,22,34,46,23,18,7,20,19,33,47,27,22,9,3,31,22,41,26,21,20,5,3,14,13,10,11,16,6,5,1,9,8,7,8,4,4,2,0];De.t11HB=[3,4,10,24,34,33,21,15,5,3,4,10,32,17,11,10,11,7,13,18,30,31,20,5,25,11,19,59,27,18,12,5,35,33,31,58,30,16,7,5,28,26,32,19,17,15,8,14,14,12,9,13,14,9,4,1,11,4,6,6,6,3,2,0];De.t12HB=[9,6,16,33,41,39,38,26,7,5,6,9,23,16,26,11,17,7,11,14,21,30,10,7,17,10,15,12,18,28,14,5,32,13,22,19,18,16,9,5,40,17,31,29,17,13,4,2,27,12,11,15,10,7,4,1,27,12,8,12,6,3,1,0];De.t13HB=[1,5,14,21,34,51,46,71,42,52,68,52,67,44,43,19,3,4,12,19,31,26,44,33,31,24,32,24,31,35,22,14,15,13,23,36,59,49,77,65,29,40,30,40,27,33,42,16,22,20,37,61,56,79,73,64,43,76,56,37,26,31,25,14,35,16,60,57,97,75,114,91,54,73,55,41,48,53,23,24,58,27,50,96,76,70,93,84,77,58,79,29,74,49,41,17,47,45,78,74,115,94,90,79,69,83,71,50,59,38,36,15,72,34,56,95,92,85,91,90,86,73,77,65,51,44,43,42,43,20,30,44,55,78,72,87,78,61,46,54,37,30,20,16,53,25,41,37,44,59,54,81,66,76,57,54,37,18,39,11,35,33,31,57,42,82,72,80,47,58,55,21,22,26,38,22,53,25,23,38,70,60,51,36,55,26,34,23,27,14,9,7,34,32,28,39,49,75,30,52,48,40,52,28,18,17,9,5,45,21,34,64,56,50,49,45,31,19,12,15,10,7,6,3,48,23,20,39,36,35,53,21,16,23,13,10,6,1,4,2,16,15,17,27,25,20,29,11,17,12,16,8,1,1,0,1];De.t15HB=[7,12,18,53,47,76,124,108,89,123,108,119,107,81,122,63,13,5,16,27,46,36,61,51,42,70,52,83,65,41,59,36,19,17,15,24,41,34,59,48,40,64,50,78,62,80,56,33,29,28,25,43,39,63,55,93,76,59,93,72,54,75,50,29,52,22,42,40,67,57,95,79,72,57,89,69,49,66,46,27,77,37,35,66,58,52,91,74,62,48,79,63,90,62,40,38,125,32,60,56,50,92,78,65,55,87,71,51,73,51,70,30,109,53,49,94,88,75,66,122,91,73,56,42,64,44,21,25,90,43,41,77,73,63,56,92,77,66,47,67,48,53,36,20,71,34,67,60,58,49,88,76,67,106,71,54,38,39,23,15,109,53,51,47,90,82,58,57,48,72,57,41,23,27,62,9,86,42,40,37,70,64,52,43,70,55,42,25,29,18,11,11,118,68,30,55,50,46,74,65,49,39,24,16,22,13,14,7,91,44,39,38,34,63,52,45,31,52,28,19,14,8,9,3,123,60,58,53,47,43,32,22,37,24,17,12,15,10,2,1,71,37,34,30,28,20,17,26,21,16,10,6,8,6,2,0];De.t16HB=[1,5,14,44,74,63,110,93,172,149,138,242,225,195,376,17,3,4,12,20,35,62,53,47,83,75,68,119,201,107,207,9,15,13,23,38,67,58,103,90,161,72,127,117,110,209,206,16,45,21,39,69,64,114,99,87,158,140,252,212,199,387,365,26,75,36,68,65,115,101,179,164,155,264,246,226,395,382,362,9,66,30,59,56,102,185,173,265,142,253,232,400,388,378,445,16,111,54,52,100,184,178,160,133,257,244,228,217,385,366,715,10,98,48,91,88,165,157,148,261,248,407,397,372,380,889,884,8,85,84,81,159,156,143,260,249,427,401,392,383,727,713,708,7,154,76,73,141,131,256,245,426,406,394,384,735,359,710,352,11,139,129,67,125,247,233,229,219,393,743,737,720,885,882,439,4,243,120,118,115,227,223,396,746,742,736,721,712,706,223,436,6,202,224,222,218,216,389,386,381,364,888,443,707,440,437,1728,4,747,211,210,208,370,379,734,723,714,1735,883,877,876,3459,865,2,377,369,102,187,726,722,358,711,709,866,1734,871,3458,870,434,0,12,10,7,11,10,17,11,9,13,12,10,7,5,3,1,3];De.t24HB=[15,13,46,80,146,262,248,434,426,669,653,649,621,517,1032,88,14,12,21,38,71,130,122,216,209,198,327,345,319,297,279,42,47,22,41,74,68,128,120,221,207,194,182,340,315,295,541,18,81,39,75,70,134,125,116,220,204,190,178,325,311,293,271,16,147,72,69,135,127,118,112,210,200,188,352,323,306,285,540,14,263,66,129,126,119,114,214,202,192,180,341,317,301,281,262,12,249,123,121,117,113,215,206,195,185,347,330,308,291,272,520,10,435,115,111,109,211,203,196,187,353,332,313,298,283,531,381,17,427,212,208,205,201,193,186,177,169,320,303,286,268,514,377,16,335,199,197,191,189,181,174,333,321,305,289,275,521,379,371,11,668,184,183,179,175,344,331,314,304,290,277,530,383,373,366,10,652,346,171,168,164,318,309,299,287,276,263,513,375,368,362,6,648,322,316,312,307,302,292,284,269,261,512,376,370,364,359,4,620,300,296,294,288,282,273,266,515,380,374,369,365,361,357,2,1033,280,278,274,267,264,259,382,378,372,367,363,360,358,356,0,43,20,19,17,15,13,11,9,7,6,4,7,5,3,1,3];De.t32HB=[1,10,8,20,12,20,16,32,14,12,24,0,28,16,24,16];De.t33HB=[15,28,26,48,22,40,36,64,14,24,20,32,12,16,8,0];De.t1l=[1,4,3,5];De.t2l=[1,4,7,4,5,7,6,7,8];De.t3l=[2,3,7,4,4,7,6,7,8];De.t5l=[1,4,7,8,4,5,8,9,7,8,9,10,8,8,9,10];De.t6l=[3,4,6,8,4,4,6,7,5,6,7,8,7,7,8,9];De.t7l=[1,4,7,9,9,10,4,6,8,9,9,10,7,7,9,10,10,11,8,9,10,11,11,11,8,9,10,11,11,12,9,10,11,12,12,12];De.t8l=[2,4,7,9,9,10,4,4,6,10,10,10,7,6,8,10,10,11,9,10,10,11,11,12,9,9,10,11,12,12,10,10,11,11,13,13];De.t9l=[3,4,6,7,9,10,4,5,6,7,8,10,5,6,7,8,9,10,7,7,8,9,9,10,8,8,9,9,10,11,9,9,10,10,11,11];De.t10l=[1,4,7,9,10,10,10,11,4,6,8,9,10,11,10,10,7,8,9,10,11,12,11,11,8,9,10,11,12,12,11,12,9,10,11,12,12,12,12,12,10,11,12,12,13,13,12,13,9,10,11,12,12,12,13,13,10,10,11,12,12,13,13,13];De.t11l=[2,4,6,8,9,10,9,10,4,5,6,8,10,10,9,10,6,7,8,9,10,11,10,10,8,8,9,11,10,12,10,11,9,10,10,11,11,12,11,12,9,10,11,12,12,13,12,13,9,9,9,10,11,12,12,12,9,9,10,11,12,12,12,12];De.t12l=[4,4,6,8,9,10,10,10,4,5,6,7,9,9,10,10,6,6,7,8,9,10,9,10,7,7,8,8,9,10,10,10,8,8,9,9,10,10,10,11,9,9,10,10,10,11,10,11,9,9,9,10,10,11,11,12,10,10,10,11,11,11,11,12];De.t13l=[1,5,7,8,9,10,10,11,10,11,12,12,13,13,14,14,4,6,8,9,10,10,11,11,11,11,12,12,13,14,14,14,7,8,9,10,11,11,12,12,11,12,12,13,13,14,15,15,8,9,10,11,11,12,12,12,12,13,13,13,13,14,15,15,9,9,11,11,12,12,13,13,12,13,13,14,14,15,15,16,10,10,11,12,12,12,13,13,13,13,14,13,15,15,16,16,10,11,12,12,13,13,13,13,13,14,14,14,15,15,16,16,11,11,12,13,13,13,14,14,14,14,15,15,15,16,18,18,10,10,11,12,12,13,13,14,14,14,14,15,15,16,17,17,11,11,12,12,13,13,13,15,14,15,15,16,16,16,18,17,11,12,12,13,13,14,14,15,14,15,16,15,16,17,18,19,12,12,12,13,14,14,14,14,15,15,15,16,17,17,17,18,12,13,13,14,14,15,14,15,16,16,17,17,17,18,18,18,13,13,14,15,15,15,16,16,16,16,16,17,18,17,18,18,14,14,14,15,15,15,17,16,16,19,17,17,17,19,18,18,13,14,15,16,16,16,17,16,17,17,18,18,21,20,21,18];De.t15l=[3,5,6,8,8,9,10,10,10,11,11,12,12,12,13,14,5,5,7,8,9,9,10,10,10,11,11,12,12,12,13,13,6,7,7,8,9,9,10,10,10,11,11,12,12,13,13,13,7,8,8,9,9,10,10,11,11,11,12,12,12,13,13,13,8,8,9,9,10,10,11,11,11,11,12,12,12,13,13,13,9,9,9,10,10,10,11,11,11,11,12,12,13,13,13,14,10,9,10,10,10,11,11,11,11,12,12,12,13,13,14,14,10,10,10,11,11,11,11,12,12,12,12,12,13,13,13,14,10,10,10,11,11,11,11,12,12,12,12,13,13,14,14,14,10,10,11,11,11,11,12,12,12,13,13,13,13,14,14,14,11,11,11,11,12,12,12,12,12,13,13,13,13,14,15,14,11,11,11,11,12,12,12,12,13,13,13,13,14,14,14,15,12,12,11,12,12,12,13,13,13,13,13,13,14,14,15,15,12,12,12,12,12,13,13,13,13,14,14,14,14,14,15,15,13,13,13,13,13,13,13,13,14,14,14,14,15,15,14,15,13,13,13,13,13,13,13,14,14,14,14,14,15,15,15,15];De.t16_5l=[1,5,7,9,10,10,11,11,12,12,12,13,13,13,14,11,4,6,8,9,10,11,11,11,12,12,12,13,14,13,14,11,7,8,9,10,11,11,12,12,13,12,13,13,13,14,14,12,9,9,10,11,11,12,12,12,13,13,14,14,14,15,15,13,10,10,11,11,12,12,13,13,13,14,14,14,15,15,15,12,10,10,11,11,12,13,13,14,13,14,14,15,15,15,16,13,11,11,11,12,13,13,13,13,14,14,14,14,15,15,16,13,11,11,12,12,13,13,13,14,14,15,15,15,15,17,17,13,11,12,12,13,13,13,14,14,15,15,15,15,16,16,16,13,12,12,12,13,13,14,14,15,15,15,15,16,15,16,15,14,12,13,12,13,14,14,14,14,15,16,16,16,17,17,16,13,13,13,13,13,14,14,15,16,16,16,16,16,16,15,16,14,13,14,14,14,14,15,15,15,15,17,16,16,16,16,18,14,15,14,14,14,15,15,16,16,16,18,17,17,17,19,17,14,14,15,13,14,16,16,15,16,16,17,18,17,19,17,16,14,11,11,11,12,12,13,13,13,14,14,14,14,14,14,14,12];De.t16l=[1,5,7,9,10,10,11,11,12,12,12,13,13,13,14,10,4,6,8,9,10,11,11,11,12,12,12,13,14,13,14,10,7,8,9,10,11,11,12,12,13,12,13,13,13,14,14,11,9,9,10,11,11,12,12,12,13,13,14,14,14,15,15,12,10,10,11,11,12,12,13,13,13,14,14,14,15,15,15,11,10,10,11,11,12,13,13,14,13,14,14,15,15,15,16,12,11,11,11,12,13,13,13,13,14,14,14,14,15,15,16,12,11,11,12,12,13,13,13,14,14,15,15,15,15,17,17,12,11,12,12,13,13,13,14,14,15,15,15,15,16,16,16,12,12,12,12,13,13,14,14,15,15,15,15,16,15,16,15,13,12,13,12,13,14,14,14,14,15,16,16,16,17,17,16,12,13,13,13,13,14,14,15,16,16,16,16,16,16,15,16,13,13,14,14,14,14,15,15,15,15,17,16,16,16,16,18,13,15,14,14,14,15,15,16,16,16,18,17,17,17,19,17,13,14,15,13,14,16,16,15,16,16,17,18,17,19,17,16,13,10,10,10,11,11,12,12,12,13,13,13,13,13,13,13,10];De.t24l=[4,5,7,8,9,10,10,11,11,12,12,12,12,12,13,10,5,6,7,8,9,10,10,11,11,11,12,12,12,12,12,10,7,7,8,9,9,10,10,11,11,11,11,12,12,12,13,9,8,8,9,9,10,10,10,11,11,11,11,12,12,12,12,9,9,9,9,10,10,10,10,11,11,11,12,12,12,12,13,9,10,9,10,10,10,10,11,11,11,11,12,12,12,12,12,9,10,10,10,10,10,11,11,11,11,12,12,12,12,12,13,9,11,10,10,10,11,11,11,11,12,12,12,12,12,13,13,10,11,11,11,11,11,11,11,11,11,12,12,12,12,13,13,10,11,11,11,11,11,11,11,12,12,12,12,12,13,13,13,10,12,11,11,11,11,12,12,12,12,12,12,13,13,13,13,10,12,12,11,11,11,12,12,12,12,12,12,13,13,13,13,10,12,12,12,12,12,12,12,12,12,12,13,13,13,13,13,10,12,12,12,12,12,12,12,12,13,13,13,13,13,13,13,10,13,12,12,12,12,12,12,13,13,13,13,13,13,13,13,10,9,9,9,9,9,9,9,9,9,9,9,10,10,10,10,6];De.t32l=[1,5,5,7,5,8,7,9,5,7,7,9,7,9,9,10];De.t33l=[4,5,5,6,5,6,6,7,5,6,6,7,6,7,7,8];De.ht=[new Ut(0,0,null,null),new Ut(2,0,De.t1HB,De.t1l),new Ut(3,0,De.t2HB,De.t2l),new Ut(3,0,De.t3HB,De.t3l),new Ut(0,0,null,null),new Ut(4,0,De.t5HB,De.t5l),new Ut(4,0,De.t6HB,De.t6l),new Ut(6,0,De.t7HB,De.t7l),new Ut(6,0,De.t8HB,De.t8l),new Ut(6,0,De.t9HB,De.t9l),new Ut(8,0,De.t10HB,De.t10l),new Ut(8,0,De.t11HB,De.t11l),new Ut(8,0,De.t12HB,De.t12l),new Ut(16,0,De.t13HB,De.t13l),new Ut(0,0,null,De.t16_5l),new Ut(16,0,De.t15HB,De.t15l),new Ut(1,1,De.t16HB,De.t16l),new Ut(2,3,De.t16HB,De.t16l),new Ut(3,7,De.t16HB,De.t16l),new Ut(4,15,De.t16HB,De.t16l),new Ut(6,63,De.t16HB,De.t16l),new Ut(8,255,De.t16HB,De.t16l),new Ut(10,1023,De.t16HB,De.t16l),new Ut(13,8191,De.t16HB,De.t16l),new Ut(4,15,De.t24HB,De.t24l),new Ut(5,31,De.t24HB,De.t24l),new Ut(6,63,De.t24HB,De.t24l),new Ut(7,127,De.t24HB,De.t24l),new Ut(8,255,De.t24HB,De.t24l),new Ut(9,511,De.t24HB,De.t24l),new Ut(11,2047,De.t24HB,De.t24l),new Ut(13,8191,De.t24HB,De.t24l),new Ut(0,0,De.t32HB,De.t32l),new Ut(0,0,De.t33HB,De.t33l)];De.largetbl=[65540,327685,458759,589832,655369,655370,720906,720907,786443,786444,786444,851980,851980,851980,917517,655370,262149,393222,524295,589832,655369,720906,720906,720907,786443,786443,786444,851980,917516,851980,917516,655370,458759,524295,589832,655369,720905,720906,786442,786443,851979,786443,851979,851980,851980,917516,917517,720905,589832,589832,655369,720905,720906,786442,786442,786443,851979,851979,917515,917516,917516,983052,983052,786441,655369,655369,720905,720906,786442,786442,851978,851979,851979,917515,917516,917516,983052,983052,983053,720905,655370,655369,720906,720906,786442,851978,851979,917515,851979,917515,917516,983052,983052,983052,1048588,786441,720906,720906,720906,786442,851978,851979,851979,851979,917515,917516,917516,917516,983052,983052,1048589,786441,720907,720906,786442,786442,851979,851979,851979,917515,917516,983052,983052,983052,983052,1114125,1114125,786442,720907,786443,786443,851979,851979,851979,917515,917515,983051,983052,983052,983052,1048588,1048589,1048589,786442,786443,786443,786443,851979,851979,917515,917515,983052,983052,983052,983052,1048588,983053,1048589,983053,851978,786444,851979,786443,851979,917515,917516,917516,917516,983052,1048588,1048588,1048589,1114125,1114125,1048589,786442,851980,851980,851979,851979,917515,917516,983052,1048588,1048588,1048588,1048588,1048589,1048589,983053,1048589,851978,851980,917516,917516,917516,917516,983052,983052,983052,983052,1114124,1048589,1048589,1048589,1048589,1179661,851978,983052,917516,917516,917516,983052,983052,1048588,1048588,1048589,1179661,1114125,1114125,1114125,1245197,1114125,851978,917517,983052,851980,917516,1048588,1048588,983052,1048589,1048589,1114125,1179661,1114125,1245197,1114125,1048589,851978,655369,655369,655369,720905,720905,786441,786441,786441,851977,851977,851977,851978,851978,851978,851978,655366];De.table23=[65538,262147,458759,262148,327684,458759,393222,458759,524296];De.table56=[65539,262148,458758,524296,262148,327684,524294,589831,458757,524294,589831,655368,524295,524295,589832,655369];De.bitrate_table=[[0,8,16,24,32,40,48,56,64,80,96,112,128,144,160,-1],[0,32,40,48,56,64,80,96,112,128,160,192,224,256,320,-1],[0,8,16,24,32,40,48,56,64,-1,-1,-1,-1,-1,-1,-1]];De.samplerate_table=[[22050,24e3,16e3,-1],[44100,48e3,32e3,-1],[11025,12e3,8e3,-1]];De.scfsi_band=[0,6,11,16,21];var Dh=De,Vs=b0,Ai=fn;Ai.System;var Ar=Ai.VbrMode,wa=Ai.Float;Ai.ShortBlock;var Zl=Ai.Util;Ai.Arrays;Ai.new_array_n;Ai.new_byte;Ai.new_double;var Rr=Ai.new_float;Ai.new_float_n;var r2=Ai.new_int;Ai.new_int_n;var Ws=Ai.assert,Vn=Qn(),o2=w0,ni=el;$i.Q_MAX=257;$i.Q_MAX2=116;$i.LARGE_BITS=1e5;$i.IXMAX_VAL=8206;function $i(){var r=null,e=null,t=null;this.setModules=function(b,R,V){r=b,e=R,t=V};function n(b){return Ws(0<=b+$i.Q_MAX2&&b<$i.Q_MAX),g[b+$i.Q_MAX2]}this.IPOW20=function(b){return Ws(0<=b&&b<$i.Q_MAX),S[b]};var i=2220446049250313e-31,s=$i.IXMAX_VAL,h=s+2,d=$i.Q_MAX,c=$i.Q_MAX2;$i.LARGE_BITS;var _=100;this.nr_of_sfb_block=[[[6,5,5,5],[9,9,9,9],[6,9,9,9]],[[6,5,7,3],[9,9,12,6],[6,9,12,6]],[[11,10,0,0],[18,18,0,0],[15,18,0,0]],[[7,7,7,0],[12,12,12,0],[6,15,12,0]],[[6,6,6,3],[12,9,9,6],[6,12,9,6]],[[8,8,5,0],[15,12,9,0],[6,18,9,0]]];var m=[0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,2,2,3,3,3,2,0];this.pretab=m,this.sfBandIndex=[new Vs([0,6,12,18,24,30,36,44,54,66,80,96,116,140,168,200,238,284,336,396,464,522,576],[0,4,8,12,18,24,32,42,56,74,100,132,174,192],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0]),new Vs([0,6,12,18,24,30,36,44,54,66,80,96,114,136,162,194,232,278,332,394,464,540,576],[0,4,8,12,18,26,36,48,62,80,104,136,180,192],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0]),new Vs([0,6,12,18,24,30,36,44,54,66,80,96,116,140,168,200,238,284,336,396,464,522,576],[0,4,8,12,18,26,36,48,62,80,104,134,174,192],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0]),new Vs([0,4,8,12,16,20,24,30,36,44,52,62,74,90,110,134,162,196,238,288,342,418,576],[0,4,8,12,16,22,30,40,52,66,84,106,136,192],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0]),new Vs([0,4,8,12,16,20,24,30,36,42,50,60,72,88,106,128,156,190,230,276,330,384,576],[0,4,8,12,16,22,28,38,50,64,80,100,126,192],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0]),new Vs([0,4,8,12,16,20,24,30,36,44,54,66,82,102,126,156,194,240,296,364,448,550,576],[0,4,8,12,16,22,30,42,58,78,104,138,180,192],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0]),new Vs([0,6,12,18,24,30,36,44,54,66,80,96,116,140,168,200,238,284,336,396,464,522,576],[0/3,12/3,24/3,36/3,54/3,78/3,108/3,144/3,186/3,240/3,312/3,402/3,522/3,576/3],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0]),new Vs([0,6,12,18,24,30,36,44,54,66,80,96,116,140,168,200,238,284,336,396,464,522,576],[0/3,12/3,24/3,36/3,54/3,78/3,108/3,144/3,186/3,240/3,312/3,402/3,522/3,576/3],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0]),new Vs([0,12,24,36,48,60,72,88,108,132,160,192,232,280,336,400,476,566,568,570,572,574,576],[0/3,24/3,48/3,72/3,108/3,156/3,216/3,288/3,372/3,480/3,486/3,492/3,498/3,576/3],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0])];var g=Rr(d+c+1),S=Rr(d),E=Rr(h),A=Rr(h);this.adj43=A;function C(b,R){var V=t.ATHformula(R,b);return V-=_,V=Math.pow(10,V/10+b.ATHlower),V}function k(b){for(var R=b.internal_flags.ATH.l,V=b.internal_flags.ATH.psfb21,f=b.internal_flags.ATH.s,D=b.internal_flags.ATH.psfb12,l=b.internal_flags,W=b.out_samplerate,L=0;L<Vn.SBMAX_l;L++){var P=l.scalefac_band.l[L],y=l.scalefac_band.l[L+1];R[L]=wa.MAX_VALUE;for(var O=P;O<y;O++){var B=O*W/1152,v=C(b,B);R[L]=Math.min(R[L],v)}}for(var L=0;L<Vn.PSFB21;L++){var P=l.scalefac_band.psfb21[L],y=l.scalefac_band.psfb21[L+1];V[L]=wa.MAX_VALUE;for(var O=P;O<y;O++){var B=O*W/1152,v=C(b,B);V[L]=Math.min(V[L],v)}}for(var L=0;L<Vn.SBMAX_s;L++){var P=l.scalefac_band.s[L],y=l.scalefac_band.s[L+1];f[L]=wa.MAX_VALUE;for(var O=P;O<y;O++){var B=O*W/384,v=C(b,B);f[L]=Math.min(f[L],v)}f[L]*=l.scalefac_band.s[L+1]-l.scalefac_band.s[L]}for(var L=0;L<Vn.PSFB12;L++){var P=l.scalefac_band.psfb12[L],y=l.scalefac_band.psfb12[L+1];D[L]=wa.MAX_VALUE;for(var O=P;O<y;O++){var B=O*W/384,v=C(b,B);D[L]=Math.min(D[L],v)}D[L]*=l.scalefac_band.s[13]-l.scalefac_band.s[12]}if(b.noATH){for(var L=0;L<Vn.SBMAX_l;L++)R[L]=1e-20;for(var L=0;L<Vn.PSFB21;L++)V[L]=1e-20;for(var L=0;L<Vn.SBMAX_s;L++)f[L]=1e-20;for(var L=0;L<Vn.PSFB12;L++)D[L]=1e-20}l.ATH.floor=10*Math.log10(C(b,-1))}this.iteration_init=function(b){var R=b.internal_flags,V=R.l3_side,f;if(R.iteration_init_init==0){for(R.iteration_init_init=1,V.main_data_begin=0,k(b),E[0]=0,f=1;f<h;f++)E[f]=Math.pow(f,4/3);for(f=0;f<h-1;f++)A[f]=f+1-Math.pow(.5*(E[f]+E[f+1]),.75);for(A[f]=.5,f=0;f<d;f++)S[f]=Math.pow(2,(f-210)*-.1875);for(f=0;f<=d+c;f++)g[f]=Math.pow(2,(f-210-c)*.25);r.huffman_init(R);{var D,l,W,L;for(f=b.exp_nspsytune>>2&63,f>=32&&(f-=64),D=Math.pow(10,f/4/10),f=b.exp_nspsytune>>8&63,f>=32&&(f-=64),l=Math.pow(10,f/4/10),f=b.exp_nspsytune>>14&63,f>=32&&(f-=64),W=Math.pow(10,f/4/10),f=b.exp_nspsytune>>20&63,f>=32&&(f-=64),L=W*Math.pow(10,f/4/10),f=0;f<Vn.SBMAX_l;f++){var P;f<=6?P=D:f<=13?P=l:f<=20?P=W:P=L,R.nsPsy.longfact[f]=P}for(f=0;f<Vn.SBMAX_s;f++){var P;f<=5?P=D:f<=10?P=l:f<=11?P=W:P=L,R.nsPsy.shortfact[f]=P}}}},this.on_pe=function(b,R,V,f,D,l){var W=b.internal_flags,L=0,P,y=r2(2),O,B=new o2(L),v=e.ResvMaxBits(b,f,B,l);L=B.bits;var H=L+v;for(H>ni.MAX_BITS_PER_GRANULE&&(H=ni.MAX_BITS_PER_GRANULE),P=0,O=0;O<W.channels_out;++O)V[O]=Math.min(ni.MAX_BITS_PER_CHANNEL,L/W.channels_out),y[O]=0|V[O]*R[D][O]/700-V[O],y[O]>f*3/4&&(y[O]=f*3/4),y[O]<0&&(y[O]=0),y[O]+V[O]>ni.MAX_BITS_PER_CHANNEL&&(y[O]=Math.max(0,ni.MAX_BITS_PER_CHANNEL-V[O])),P+=y[O];if(P>v)for(O=0;O<W.channels_out;++O)y[O]=v*y[O]/P;for(O=0;O<W.channels_out;++O)V[O]+=y[O],v-=y[O];for(P=0,O=0;O<W.channels_out;++O)P+=V[O];if(P>ni.MAX_BITS_PER_GRANULE){var N=0;for(O=0;O<W.channels_out;++O)V[O]*=ni.MAX_BITS_PER_GRANULE,V[O]/=P,N+=V[O];Ws(N<=ni.MAX_BITS_PER_GRANULE)}return H},this.reduce_side=function(b,R,V,f){Ws(f<=ni.MAX_BITS_PER_GRANULE),Ws(b[0]+b[1]<=ni.MAX_BITS_PER_GRANULE);var D=.33*(.5-R)/.5;D<0&&(D=0),D>.5&&(D=.5);var l=0|D*.5*(b[0]+b[1]);l>ni.MAX_BITS_PER_CHANNEL-b[0]&&(l=ni.MAX_BITS_PER_CHANNEL-b[0]),l<0&&(l=0),b[1]>=125&&(b[1]-l>125?(b[0]<V&&(b[0]+=l),b[1]-=l):(b[0]+=b[1]-125,b[1]=125)),l=b[0]+b[1],l>f&&(b[0]=f*b[0]/l,b[1]=f*b[1]/l),Ws(b[0]<=ni.MAX_BITS_PER_CHANNEL),Ws(b[1]<=ni.MAX_BITS_PER_CHANNEL),Ws(b[0]+b[1]<=ni.MAX_BITS_PER_GRANULE)},this.athAdjust=function(b,R,V){var f=90.30873362,D=94.82444863,l=Zl.FAST_LOG10_X(R,10),W=b*b,L=0;return l-=V,W>1e-20&&(L=1+Zl.FAST_LOG10_X(W,10/f)),L<0&&(L=0),l*=L,l+=V+f-D,Math.pow(10,.1*l)},this.calc_xmin=function(b,R,V,f){var D=0,l=b.internal_flags,W,L=0,P=0,y=l.ATH,O=V.xr,B=b.VBR==Ar.vbr_mtrh?1:0,v=l.masking_lower;for((b.VBR==Ar.vbr_mtrh||b.VBR==Ar.vbr_mt)&&(v=1),W=0;W<V.psy_lmax;W++){var H,N,te,G,se,M;b.VBR==Ar.vbr_rh||b.VBR==Ar.vbr_mtrh?N=athAdjust(y.adjust,y.l[W],y.floor):N=y.adjust*y.l[W],se=V.width[W],te=N/se,G=i,M=se>>1,H=0;do{var F,Z;F=O[L]*O[L],H+=F,G+=F<te?F:te,L++,Z=O[L]*O[L],H+=Z,G+=Z<te?Z:te,L++}while(--M>0);if(H>N&&P++,W==Vn.SBPSY_l){var ee=N*l.nsPsy.longfact[W];G<ee&&(G=ee)}if(B!=0&&(N=G),!b.ATHonly){var ue=R.en.l[W];if(ue>0){var ee;ee=H*R.thm.l[W]*v/ue,B!=0&&(ee*=l.nsPsy.longfact[W]),N<ee&&(N=ee)}}B!=0?f[D++]=N:f[D++]=N*l.nsPsy.longfact[W]}var Pe=575;if(V.block_type!=Vn.SHORT_TYPE)for(var _e=576;_e--!=0&&BitStream.EQ(O[_e],0);)Pe=_e;V.max_nonzero_coeff=Pe;for(var ke=V.sfb_smin;W<V.psymax;ke++,W+=3){var se,Ne,Be;for(b.VBR==Ar.vbr_rh||b.VBR==Ar.vbr_mtrh?Be=athAdjust(y.adjust,y.s[ke],y.floor):Be=y.adjust*y.s[ke],se=V.width[W],Ne=0;Ne<3;Ne++){var H=0,N,te,G,M=se>>1;te=Be/se,G=i;do{var F,Z;F=O[L]*O[L],H+=F,G+=F<te?F:te,L++,Z=O[L]*O[L],H+=Z,G+=Z<te?Z:te,L++}while(--M>0);if(H>Be&&P++,ke==Vn.SBPSY_s){var ee=Be*l.nsPsy.shortfact[ke];G<ee&&(G=ee)}if(B!=0?N=G:N=Be,!b.ATHonly&&!b.ATHshort){var ue=R.en.s[ke][Ne];if(ue>0){var ee;ee=H*R.thm.s[ke][Ne]*v/ue,B!=0&&(ee*=l.nsPsy.shortfact[ke]),N<ee&&(N=ee)}}B!=0?f[D++]=N:f[D++]=N*l.nsPsy.shortfact[ke]}b.useTemporal&&(f[D-3]>f[D-3+1]&&(f[D-3+1]+=(f[D-3]-f[D-3+1])*l.decay),f[D-3+1]>f[D-3+2]&&(f[D-3+2]+=(f[D-3+1]-f[D-3+2])*l.decay))}return P};function T(b){this.s=b}this.calc_noise_core=function(b,R,V,f){var D=0,l=R.s,W=b.l3_enc;if(l>b.count1)for(;V--!=0;){var L;L=b.xr[l],l++,D+=L*L,L=b.xr[l],l++,D+=L*L}else if(l>b.big_values){var P=Rr(2);for(P[0]=0,P[1]=f;V--!=0;){var L;L=Math.abs(b.xr[l])-P[W[l]],l++,D+=L*L,L=Math.abs(b.xr[l])-P[W[l]],l++,D+=L*L}}else for(;V--!=0;){var L;L=Math.abs(b.xr[l])-E[W[l]]*f,l++,D+=L*L,L=Math.abs(b.xr[l])-E[W[l]]*f,l++,D+=L*L}return R.s=l,D},this.calc_noise=function(b,R,V,f,D){var l=0,W=0,L,P,y=0,O=0,B=0,v=-20,H=0,N=b.scalefac,te=0;for(f.over_SSD=0,L=0;L<b.psymax;L++){var G=b.global_gain-(N[te++]+(b.preflag!=0?m[L]:0)<<b.scalefac_scale+1)-b.subblock_gain[b.window[L]]*8,se=0;if(D!=null&&D.step[L]==G)se=D.noise[L],H+=b.width[L],V[l++]=se/R[W++],se=D.noise_log[L];else{var M=n(G);if(P=b.width[L]>>1,H+b.width[L]>b.max_nonzero_coeff){var F;F=b.max_nonzero_coeff-H+1,F>0?P=F>>1:P=0}var Z=new T(H);se=this.calc_noise_core(b,Z,P,M),H=Z.s,D!=null&&(D.step[L]=G,D.noise[L]=se),se=V[l++]=se/R[W++],se=Zl.FAST_LOG10(Math.max(se,1e-20)),D!=null&&(D.noise_log[L]=se)}if(D!=null&&(D.global_gain=b.global_gain),B+=se,se>0){var ee;ee=Math.max(0|se*10+.5,1),f.over_SSD+=ee*ee,y++,O+=se}v=Math.max(v,se)}return f.over_count=y,f.tot_noise=B,f.over_noise=O,f.max_noise=v,y},this.set_pinfo=function(b,R,V,f,D){var l=b.internal_flags,W,L,P,y,O,B=R.scalefac_scale==0?.5:1,v=R.scalefac,H=Rr(L3Side.SFBMAX),N=Rr(L3Side.SFBMAX),te=new CalcNoiseResult;calc_xmin(b,V,R,H),calc_noise(R,H,N,te,null);var G=0;for(L=R.sfb_lmax,R.block_type!=Vn.SHORT_TYPE&&R.mixed_block_flag==0&&(L=22),W=0;W<L;W++){var se=l.scalefac_band.l[W],M=l.scalefac_band.l[W+1],F=M-se;for(y=0;G<M;G++)y+=R.xr[G]*R.xr[G];y/=F,O=1e15,l.pinfo.en[f][D][W]=O*y,l.pinfo.xfsf[f][D][W]=O*H[W]*N[W]/F,V.en.l[W]>0&&!b.ATHonly?y=y/V.en.l[W]:y=0,l.pinfo.thr[f][D][W]=O*Math.max(y*V.thm.l[W],l.ATH.l[W]),l.pinfo.LAMEsfb[f][D][W]=0,R.preflag!=0&&W>=11&&(l.pinfo.LAMEsfb[f][D][W]=-B*m[W]),W<Vn.SBPSY_l&&(Ws(v[W]>=0),l.pinfo.LAMEsfb[f][D][W]-=B*v[W])}if(R.block_type==Vn.SHORT_TYPE)for(L=W,W=R.sfb_smin;W<Vn.SBMAX_s;W++)for(var se=l.scalefac_band.s[W],M=l.scalefac_band.s[W+1],F=M-se,Z=0;Z<3;Z++){for(y=0,P=se;P<M;P++)y+=R.xr[G]*R.xr[G],G++;y=Math.max(y/F,1e-20),O=1e15,l.pinfo.en_s[f][D][3*W+Z]=O*y,l.pinfo.xfsf_s[f][D][3*W+Z]=O*H[L]*N[L]/F,V.en.s[W][Z]>0?y=y/V.en.s[W][Z]:y=0,(b.ATHonly||b.ATHshort)&&(y=0),l.pinfo.thr_s[f][D][3*W+Z]=O*Math.max(y*V.thm.s[W][Z],l.ATH.s[W]),l.pinfo.LAMEsfb_s[f][D][3*W+Z]=-2*R.subblock_gain[Z],W<Vn.SBPSY_s&&(l.pinfo.LAMEsfb_s[f][D][3*W+Z]-=B*v[L]),L++}l.pinfo.LAMEqss[f][D]=R.global_gain,l.pinfo.LAMEmainbits[f][D]=R.part2_3_length+R.part2_length,l.pinfo.LAMEsfbits[f][D]=R.part2_length,l.pinfo.over[f][D]=te.over_count,l.pinfo.max_noise[f][D]=te.max_noise*10,l.pinfo.over_noise[f][D]=te.over_noise*10,l.pinfo.tot_noise[f][D]=te.tot_noise*10,l.pinfo.over_SSD[f][D]=te.over_SSD}}var x0=$i,Ri=fn,a2=Ri.System;Ri.VbrMode;Ri.Float;Ri.ShortBlock;Ri.Util;var l2=Ri.Arrays;Ri.new_array_n;Ri.new_byte;Ri.new_double;Ri.new_float;Ri.new_float_n;var To=Ri.new_int;Ri.new_int_n;var ts=Ri.assert,_n=Qn(),mn=Dh,h2=Nh,Lr=x0;function wh(){var r=null;this.qupvt=null,this.setModules=function(P){this.qupvt=P,r=P};function e(P){this.bits=0|P}var t=[[0,0],[0,0],[0,0],[0,0],[0,0],[0,1],[1,1],[1,1],[1,2],[2,2],[2,3],[2,3],[3,4],[3,4],[3,4],[4,5],[4,5],[4,6],[5,6],[5,6],[5,7],[6,7],[6,7]];function n(P,y,O,B,v,H){var N=.5946/y;for(ts(P>0),P=P>>1;P--!=0;)v[H++]=N>O[B++]?0:1,v[H++]=N>O[B++]?0:1}function i(P,y,O,B,v,H){ts(P>0),P=P>>1;var N=P%2;for(P=P>>1;P--!=0;){var te,G,se,M,F,Z,ee,ue;te=O[B++]*y,G=O[B++]*y,F=0|te,se=O[B++]*y,Z=0|G,M=O[B++]*y,ee=0|se,te+=r.adj43[F],ue=0|M,G+=r.adj43[Z],v[H++]=0|te,se+=r.adj43[ee],v[H++]=0|G,M+=r.adj43[ue],v[H++]=0|se,v[H++]=0|M}if(N!=0){var te,G,F,Z;te=O[B++]*y,G=O[B++]*y,F=0|te,Z=0|G,te+=r.adj43[F],G+=r.adj43[Z],v[H++]=0|te,v[H++]=0|G}}function s(P,y,O,B,v){var H,N,te=0,G,se=0,M=0,F=0,Z=y,ee=0,ue=Z,Pe=0,_e=P,ke=0;for(G=v!=null&&B.global_gain==v.global_gain,B.block_type==_n.SHORT_TYPE?N=38:N=21,H=0;H<=N;H++){var Ne=-1;if((G||B.block_type==_n.NORM_TYPE)&&(Ne=B.global_gain-(B.scalefac[H]+(B.preflag!=0?r.pretab[H]:0)<<B.scalefac_scale+1)-B.subblock_gain[B.window[H]]*8),ts(B.width[H]>=0),G&&v.step[H]==Ne)se!=0&&(i(se,O,_e,ke,ue,Pe),se=0),M!=0&&(n(M,O,_e,ke,ue,Pe),M=0);else{var Be=B.width[H];if(te+B.width[H]>B.max_nonzero_coeff){var pe;pe=B.max_nonzero_coeff-te+1,l2.fill(y,B.max_nonzero_coeff,576,0),Be=pe,Be<0&&(Be=0),H=N+1}if(se==0&&M==0&&(ue=Z,Pe=ee,_e=P,ke=F),v!=null&&v.sfb_count1>0&&H>=v.sfb_count1&&v.step[H]>0&&Ne>=v.step[H]?(se!=0&&(i(se,O,_e,ke,ue,Pe),se=0,ue=Z,Pe=ee,_e=P,ke=F),M+=Be):(M!=0&&(n(M,O,_e,ke,ue,Pe),M=0,ue=Z,Pe=ee,_e=P,ke=F),se+=Be),Be<=0){M!=0&&(n(M,O,_e,ke,ue,Pe),M=0),se!=0&&(i(se,O,_e,ke,ue,Pe),se=0);break}}H<=N&&(ee+=B.width[H],F+=B.width[H],te+=B.width[H])}se!=0&&(i(se,O,_e,ke,ue,Pe),se=0),M!=0&&(n(M,O,_e,ke,ue,Pe),M=0)}function h(P,y,O){var B=0,v=0;do{var H=P[y++],N=P[y++];B<H&&(B=H),v<N&&(v=N)}while(y<O);return B<v&&(B=v),B}function d(P,y,O,B,v,H){var N=mn.ht[B].xlen*65536+mn.ht[v].xlen,te=0,G;do{var se=P[y++],M=P[y++];se!=0&&(se>14&&(se=15,te+=N),se*=16),M!=0&&(M>14&&(M=15,te+=N),se+=M),te+=mn.largetbl[se]}while(y<O);return G=te&65535,te>>=16,te>G&&(te=G,B=v),H.bits+=te,B}function c(P,y,O,B){var v=0,H=mn.ht[1].hlen;do{var N=P[y+0]*2+P[y+1];y+=2,v+=H[N]}while(y<O);return B.bits+=v,1}function _(P,y,O,B,v){var H=0,N,te=mn.ht[B].xlen,G;B==2?G=mn.table23:G=mn.table56;do{var se=P[y+0]*te+P[y+1];y+=2,H+=G[se]}while(y<O);return N=H&65535,H>>=16,H>N&&(H=N,B++),v.bits+=H,B}function m(P,y,O,B,v){var H=0,N=0,te=0,G=mn.ht[B].xlen,se=mn.ht[B].hlen,M=mn.ht[B+1].hlen,F=mn.ht[B+2].hlen;do{var Z=P[y+0]*G+P[y+1];y+=2,H+=se[Z],N+=M[Z],te+=F[Z]}while(y<O);var ee=B;return H>N&&(H=N,ee++),H>te&&(H=te,ee=B+2),v.bits+=H,ee}var g=[1,2,5,7,7,10,10,13,13,13,13,13,13,13,13];function S(P,y,O,B){var v=h(P,y,O);switch(v){case 0:return v;case 1:return c(P,y,O,B);case 2:case 3:return _(P,y,O,g[v-1],B);case 4:case 5:case 6:case 7:case 8:case 9:case 10:case 11:case 12:case 13:case 14:case 15:return m(P,y,O,g[v-1],B);default:if(v>Lr.IXMAX_VAL)return B.bits=Lr.LARGE_BITS,-1;v-=15;var H;for(H=24;H<32&&!(mn.ht[H].linmax>=v);H++);var N;for(N=H-8;N<24&&!(mn.ht[N].linmax>=v);N++);return d(P,y,O,N,H,B)}}this.noquant_count_bits=function(P,y,O){var B=y.l3_enc,v=Math.min(576,y.max_nonzero_coeff+2>>1<<1);for(O!=null&&(O.sfb_count1=0);v>1&&!(B[v-1]|B[v-2]);v-=2);y.count1=v;for(var H=0,N=0;v>3;v-=4){var te;if(((B[v-1]|B[v-2]|B[v-3]|B[v-4])&2147483647)>1)break;te=((B[v-4]*2+B[v-3])*2+B[v-2])*2+B[v-1],H+=mn.t32l[te],N+=mn.t33l[te]}var G=H;if(y.count1table_select=0,H>N&&(G=N,y.count1table_select=1),y.count1bits=G,y.big_values=v,v==0)return G;if(y.block_type==_n.SHORT_TYPE)H=3*P.scalefac_band.s[3],H>y.big_values&&(H=y.big_values),N=y.big_values;else if(y.block_type==_n.NORM_TYPE){if(ts(v<=576),H=y.region0_count=P.bv_scf[v-2],N=y.region1_count=P.bv_scf[v-1],ts(H+N+2<_n.SBPSY_l),N=P.scalefac_band.l[H+N+2],H=P.scalefac_band.l[H+1],N<v){var se=new e(G);y.table_select[2]=S(B,N,v,se),G=se.bits}}else y.region0_count=7,y.region1_count=_n.SBMAX_l-1-7-1,H=P.scalefac_band.l[8],N=v,H>N&&(H=N);if(H=Math.min(H,v),N=Math.min(N,v),ts(H>=0),ts(N>=0),0<H){var se=new e(G);y.table_select[0]=S(B,0,H,se),G=se.bits}if(H<N){var se=new e(G);y.table_select[1]=S(B,H,N,se),G=se.bits}if(P.use_best_huffman==2&&(y.part2_3_length=G,best_huffman_divide(P,y),G=y.part2_3_length),O!=null&&y.block_type==_n.NORM_TYPE){for(var M=0;P.scalefac_band.l[M]<y.big_values;)M++;O.sfb_count1=M}return G},this.count_bits=function(P,y,O,B){var v=O.l3_enc,H=Lr.IXMAX_VAL/r.IPOW20(O.global_gain);if(O.xrpow_max>H)return Lr.LARGE_BITS;if(s(y,v,r.IPOW20(O.global_gain),O,B),P.substep_shaping&2)for(var N=0,te=O.global_gain+O.scalefac_scale,G=.634521682242439/r.IPOW20(te),se=0;se<O.sfbmax;se++){var M=O.width[se];if(ts(M>=0),P.pseudohalf[se]==0)N+=M;else{var F;for(F=N,N+=M;F<N;++F)v[F]=y[F]>=G?v[F]:0}}return this.noquant_count_bits(P,O,B)};function E(P,y,O,B,v,H,N){for(var te=y.big_values,G=0;G<=22;G++)B[G]=Lr.LARGE_BITS;for(var G=0;G<16;G++){var se=P.scalefac_band.l[G+1];if(se>=te)break;var M=0,F=new e(M),Z=S(O,0,se,F);M=F.bits;for(var ee=0;ee<8;ee++){var ue=P.scalefac_band.l[G+ee+2];if(ue>=te)break;var Pe=M;F=new e(Pe);var _e=S(O,se,ue,F);Pe=F.bits,B[G+ee]>Pe&&(B[G+ee]=Pe,v[G+ee]=G,H[G+ee]=Z,N[G+ee]=_e)}}}function A(P,y,O,B,v,H,N,te){for(var G=y.big_values,se=2;se<_n.SBMAX_l+1;se++){var M=P.scalefac_band.l[se];if(M>=G)break;var F=v[se-2]+y.count1bits;if(O.part2_3_length<=F)break;var Z=new e(F),ee=S(B,M,G,Z);F=Z.bits,!(O.part2_3_length<=F)&&(O.assign(y),O.part2_3_length=F,O.region0_count=H[se-2],O.region1_count=se-2-H[se-2],O.table_select[0]=N[se-2],O.table_select[1]=te[se-2],O.table_select[2]=ee)}}this.best_huffman_divide=function(P,y){var O=new h2,B=y.l3_enc,v=To(23),H=To(23),N=To(23),te=To(23);if(!(y.block_type==_n.SHORT_TYPE&&P.mode_gr==1)){O.assign(y),y.block_type==_n.NORM_TYPE&&(E(P,y,B,v,H,N,te),A(P,O,y,B,v,H,N,te));var G=O.big_values;if(!(G==0||(B[G-2]|B[G-1])>1)&&(G=y.count1+2,!(G>576))){O.assign(y),O.count1=G;var se=0,M=0;for(ts(G<=576);G>O.big_values;G-=4){var F=((B[G-4]*2+B[G-3])*2+B[G-2])*2+B[G-1];se+=mn.t32l[F],M+=mn.t33l[F]}if(O.big_values=G,O.count1table_select=0,se>M&&(se=M,O.count1table_select=1),O.count1bits=se,O.block_type==_n.NORM_TYPE)A(P,O,y,B,v,H,N,te);else{if(O.part2_3_length=se,se=P.scalefac_band.l[8],se>G&&(se=G),se>0){var Z=new e(O.part2_3_length);O.table_select[0]=S(B,0,se,Z),O.part2_3_length=Z.bits}if(G>se){var Z=new e(O.part2_3_length);O.table_select[1]=S(B,se,G,Z),O.part2_3_length=Z.bits}y.part2_3_length>O.part2_3_length&&y.assign(O)}}}};var C=[1,1,1,1,8,2,2,2,4,4,4,8,8,8,16,16],k=[1,2,4,8,1,2,4,8,2,4,8,2,4,8,4,8],T=[0,0,0,0,3,1,1,1,2,2,2,3,3,3,4,4],b=[0,1,2,3,0,1,2,3,1,2,3,1,2,3,2,3];wh.slen1_tab=T,wh.slen2_tab=b;function R(P,y){for(var O,B=y.tt[1][P],v=y.tt[0][P],H=0;H<mn.scfsi_band.length-1;H++){for(O=mn.scfsi_band[H];O<mn.scfsi_band[H+1]&&!(v.scalefac[O]!=B.scalefac[O]&&B.scalefac[O]>=0);O++);if(O==mn.scfsi_band[H+1]){for(O=mn.scfsi_band[H];O<mn.scfsi_band[H+1];O++)B.scalefac[O]=-1;y.scfsi[P][H]=1}}var N=0,te=0;for(O=0;O<11;O++)B.scalefac[O]!=-1&&(te++,N<B.scalefac[O]&&(N=B.scalefac[O]));for(var G=0,se=0;O<_n.SBPSY_l;O++)B.scalefac[O]!=-1&&(se++,G<B.scalefac[O]&&(G=B.scalefac[O]));for(var H=0;H<16;H++)if(N<C[H]&&G<k[H]){var M=T[H]*te+b[H]*se;B.part2_length>M&&(B.part2_length=M,B.scalefac_compress=H)}}this.best_scalefac_store=function(P,y,O,B){var v=B.tt[y][O],H,N,te,G,se=0;for(te=0,H=0;H<v.sfbmax;H++){var M=v.width[H];for(ts(M>=0),te+=M,G=-M;G<0&&v.l3_enc[G+te]==0;G++);G==0&&(v.scalefac[H]=se=-2)}if(v.scalefac_scale==0&&v.preflag==0){var F=0;for(H=0;H<v.sfbmax;H++)v.scalefac[H]>0&&(F|=v.scalefac[H]);if(!(F&1)&&F!=0){for(H=0;H<v.sfbmax;H++)v.scalefac[H]>0&&(v.scalefac[H]>>=1);v.scalefac_scale=se=1}}if(v.preflag==0&&v.block_type!=_n.SHORT_TYPE&&P.mode_gr==2){for(H=11;H<_n.SBPSY_l&&!(v.scalefac[H]<r.pretab[H]&&v.scalefac[H]!=-2);H++);if(H==_n.SBPSY_l){for(H=11;H<_n.SBPSY_l;H++)v.scalefac[H]>0&&(v.scalefac[H]-=r.pretab[H]);v.preflag=se=1}}for(N=0;N<4;N++)B.scfsi[O][N]=0;for(P.mode_gr==2&&y==1&&B.tt[0][O].block_type!=_n.SHORT_TYPE&&B.tt[1][O].block_type!=_n.SHORT_TYPE&&(R(O,B),se=0),H=0;H<v.sfbmax;H++)v.scalefac[H]==-2&&(v.scalefac[H]=0);se!=0&&(P.mode_gr==2?this.scale_bitcount(v):this.scale_bitcount_lsf(P,v))};function V(P,y){for(var O=0;O<y;++O)if(P[O]<0)return!1;return!0}var f=[0,18,36,54,54,36,54,72,54,72,90,72,90,108,108,126],D=[0,18,36,54,51,35,53,71,52,70,88,69,87,105,104,122],l=[0,10,20,30,33,21,31,41,32,42,52,43,53,63,64,74];this.scale_bitcount=function(P){var y,O,B=0,v=0,H,N=P.scalefac;if(ts(V(N,P.sfbmax)),P.block_type==_n.SHORT_TYPE)H=f,P.mixed_block_flag!=0&&(H=D);else if(H=l,P.preflag==0){for(O=11;O<_n.SBPSY_l&&!(N[O]<r.pretab[O]);O++);if(O==_n.SBPSY_l)for(P.preflag=1,O=11;O<_n.SBPSY_l;O++)N[O]-=r.pretab[O]}for(O=0;O<P.sfbdivide;O++)B<N[O]&&(B=N[O]);for(;O<P.sfbmax;O++)v<N[O]&&(v=N[O]);for(P.part2_length=Lr.LARGE_BITS,y=0;y<16;y++)B<C[y]&&v<k[y]&&P.part2_length>H[y]&&(P.part2_length=H[y],P.scalefac_compress=y);return P.part2_length==Lr.LARGE_BITS};var W=[[15,15,7,7],[15,15,7,0],[7,3,0,0],[15,31,31,0],[7,7,7,0],[3,3,0,0]];this.scale_bitcount_lsf=function(P,y){var O,B,v,H,N,te,G,se,M=To(4),F=y.scalefac;for(y.preflag!=0?O=2:O=0,G=0;G<4;G++)M[G]=0;if(y.block_type==_n.SHORT_TYPE){B=1;var Z=r.nr_of_sfb_block[O][B];for(se=0,v=0;v<4;v++)for(H=Z[v]/3,G=0;G<H;G++,se++)for(N=0;N<3;N++)F[se*3+N]>M[v]&&(M[v]=F[se*3+N])}else{B=0;var Z=r.nr_of_sfb_block[O][B];for(se=0,v=0;v<4;v++)for(H=Z[v],G=0;G<H;G++,se++)F[se]>M[v]&&(M[v]=F[se])}for(te=!1,v=0;v<4;v++)M[v]>W[O][v]&&(te=!0);if(!te){var ee,ue,Pe,_e;for(y.sfb_partition_table=r.nr_of_sfb_block[O][B],v=0;v<4;v++)y.slen[v]=L[M[v]];switch(ee=y.slen[0],ue=y.slen[1],Pe=y.slen[2],_e=y.slen[3],O){case 0:y.scalefac_compress=(ee*5+ue<<4)+(Pe<<2)+_e;break;case 1:y.scalefac_compress=400+(ee*5+ue<<2)+Pe;break;case 2:y.scalefac_compress=500+ee*3+ue;break;default:a2.err.printf(`intensity stereo not implemented yet
`);break}}if(!te)for(ts(y.sfb_partition_table!=null),y.part2_length=0,v=0;v<4;v++)y.part2_length+=y.slen[v]*y.sfb_partition_table[v];return te};var L=[0,1,2,2,3,3,3,3,4,4,4,4,4,4,4,4];this.huffman_init=function(P){for(var y=2;y<=576;y+=2){for(var O=0,B;P.scalefac_band.l[++O]<y;);for(B=t[O][0];P.scalefac_band.l[B+1]>y;)B--;for(B<0&&(B=t[O][0]),P.bv_scf[y-2]=B,B=t[O][1];P.scalefac_band.l[B+P.bv_scf[y-2]+2]>y;)B--;B<0&&(B=t[O][1]),P.bv_scf[y-1]=B}}}var S0=wh,Li=fn,Bs=Li.System;Li.VbrMode;Li.Float;Li.ShortBlock;Li.Util;var c2=Li.Arrays;Li.new_array_n;var d2=Li.new_byte;Li.new_double;Li.new_float;var u2=Li.new_float_n,f2=Li.new_int;Li.new_int_n;var xt=Li.assert,Ud=S0,Ql=Dh,xa=Qn(),Nr=el;Ua.EQ=function(r,e){return Math.abs(r)>Math.abs(e)?Math.abs(r-e)<=Math.abs(r)*1e-6:Math.abs(r-e)<=Math.abs(e)*1e-6};Ua.NEQ=function(r,e){return!Ua.EQ(r,e)};function Ua(){var r=this,e=32773,t=32,n=null,i=null,s=null,h=null;this.setModules=function(L,P,y,O){n=L,i=P,s=y,h=O};var d=null,c=0,_=0,m=0;this.getframebits=function(L){var P=L.internal_flags,y;P.bitrate_index!=0?y=Ql.bitrate_table[L.version][P.bitrate_index]:y=L.brate,xt(8<=y&&y<=640);var O=0|(L.version+1)*72e3*y/L.out_samplerate+P.padding;return 8*O};function g(L){Bs.arraycopy(L.header[L.w_ptr].buf,0,d,_,L.sideinfo_len),_+=L.sideinfo_len,c+=L.sideinfo_len*8,L.w_ptr=L.w_ptr+1&Nr.MAX_HEADER_BUF-1}function S(L,P,y){for(xt(y<t-2);y>0;){var O;m==0&&(m=8,_++,xt(_<Lame.LAME_MAXMP3BUFFER),xt(L.header[L.w_ptr].write_timing>=c),L.header[L.w_ptr].write_timing==c&&g(L),d[_]=0),O=Math.min(y,m),y-=O,m-=O,xt(y<t),xt(m<t),d[_]|=P>>y<<m,c+=O}}function E(L,P,y){for(xt(y<t-2);y>0;){var O;m==0&&(m=8,_++,xt(_<Lame.LAME_MAXMP3BUFFER),d[_]=0),O=Math.min(y,m),y-=O,m-=O,xt(y<t),xt(m<t),d[_]|=P>>y<<m,c+=O}}function A(L,P){var y=L.internal_flags,O;if(xt(P>=0),P>=8&&(S(y,76,8),P-=8),P>=8&&(S(y,65,8),P-=8),P>=8&&(S(y,77,8),P-=8),P>=8&&(S(y,69,8),P-=8),P>=32){var B=s.getLameShortVersion();if(P>=32)for(O=0;O<B.length&&P>=8;++O)P-=8,S(y,B.charAt(O),8)}for(;P>=1;P-=1)S(y,y.ancillary_flag,1),y.ancillary_flag^=L.disable_reservoir?0:1;xt(P==0)}function C(L,P,y){for(var O=L.header[L.h_ptr].ptr;y>0;){var B=Math.min(y,8-(O&7));y-=B,xt(y<t),L.header[L.h_ptr].buf[O>>3]|=P>>y<<8-(O&7)-B,O+=B}L.header[L.h_ptr].ptr=O}function k(L,P){L<<=8;for(var y=0;y<8;y++)L<<=1,P<<=1,(P^L)&65536&&(P^=e);return P}this.CRC_writeheader=function(L,P){var y=65535;y=k(P[2]&255,y),y=k(P[3]&255,y);for(var O=6;O<L.sideinfo_len;O++)y=k(P[O]&255,y);P[4]=byte(y>>8),P[5]=byte(y&255)};function T(L,P){var y=L.internal_flags,O,B,v;if(O=y.l3_side,y.header[y.h_ptr].ptr=0,c2.fill(y.header[y.h_ptr].buf,0,y.sideinfo_len,0),L.out_samplerate<16e3?C(y,4094,12):C(y,4095,12),C(y,L.version,1),C(y,1,2),C(y,L.error_protection?0:1,1),C(y,y.bitrate_index,4),C(y,y.samplerate_index,2),C(y,y.padding,1),C(y,L.extension,1),C(y,L.mode.ordinal(),2),C(y,y.mode_ext,2),C(y,L.copyright,1),C(y,L.original,1),C(y,L.emphasis,2),L.error_protection&&C(y,0,16),L.version==1){for(xt(O.main_data_begin>=0),C(y,O.main_data_begin,9),y.channels_out==2?C(y,O.private_bits,3):C(y,O.private_bits,5),v=0;v<y.channels_out;v++){var H;for(H=0;H<4;H++)C(y,O.scfsi[v][H],1)}for(B=0;B<2;B++)for(v=0;v<y.channels_out;v++){var N=O.tt[B][v];C(y,N.part2_3_length+N.part2_length,12),C(y,N.big_values/2,9),C(y,N.global_gain,8),C(y,N.scalefac_compress,4),N.block_type!=xa.NORM_TYPE?(C(y,1,1),C(y,N.block_type,2),C(y,N.mixed_block_flag,1),N.table_select[0]==14&&(N.table_select[0]=16),C(y,N.table_select[0],5),N.table_select[1]==14&&(N.table_select[1]=16),C(y,N.table_select[1],5),C(y,N.subblock_gain[0],3),C(y,N.subblock_gain[1],3),C(y,N.subblock_gain[2],3)):(C(y,0,1),N.table_select[0]==14&&(N.table_select[0]=16),C(y,N.table_select[0],5),N.table_select[1]==14&&(N.table_select[1]=16),C(y,N.table_select[1],5),N.table_select[2]==14&&(N.table_select[2]=16),C(y,N.table_select[2],5),xt(0<=N.region0_count&&N.region0_count<16),xt(0<=N.region1_count&&N.region1_count<8),C(y,N.region0_count,4),C(y,N.region1_count,3)),C(y,N.preflag,1),C(y,N.scalefac_scale,1),C(y,N.count1table_select,1)}}else for(xt(O.main_data_begin>=0),C(y,O.main_data_begin,8),C(y,O.private_bits,y.channels_out),B=0,v=0;v<y.channels_out;v++){var N=O.tt[B][v];C(y,N.part2_3_length+N.part2_length,12),C(y,N.big_values/2,9),C(y,N.global_gain,8),C(y,N.scalefac_compress,9),N.block_type!=xa.NORM_TYPE?(C(y,1,1),C(y,N.block_type,2),C(y,N.mixed_block_flag,1),N.table_select[0]==14&&(N.table_select[0]=16),C(y,N.table_select[0],5),N.table_select[1]==14&&(N.table_select[1]=16),C(y,N.table_select[1],5),C(y,N.subblock_gain[0],3),C(y,N.subblock_gain[1],3),C(y,N.subblock_gain[2],3)):(C(y,0,1),N.table_select[0]==14&&(N.table_select[0]=16),C(y,N.table_select[0],5),N.table_select[1]==14&&(N.table_select[1]=16),C(y,N.table_select[1],5),N.table_select[2]==14&&(N.table_select[2]=16),C(y,N.table_select[2],5),xt(0<=N.region0_count&&N.region0_count<16),xt(0<=N.region1_count&&N.region1_count<8),C(y,N.region0_count,4),C(y,N.region1_count,3)),C(y,N.scalefac_scale,1),C(y,N.count1table_select,1)}L.error_protection&&CRC_writeheader(y,y.header[y.h_ptr].buf);{var te=y.h_ptr;xt(y.header[te].ptr==y.sideinfo_len*8),y.h_ptr=te+1&Nr.MAX_HEADER_BUF-1,y.header[y.h_ptr].write_timing=y.header[te].write_timing+P,y.h_ptr==y.w_ptr&&Bs.err.println(`Error: MAX_HEADER_BUF too small in bitstream.c 
`)}}function b(L,P){var y=Ql.ht[P.count1table_select+32],O,B=0,v=P.big_values,H=P.big_values;for(xt(P.count1table_select<2),O=(P.count1-P.big_values)/4;O>0;--O){var N=0,te=0,G;G=P.l3_enc[v+0],G!=0&&(te+=8,P.xr[H+0]<0&&N++,xt(G<=1)),G=P.l3_enc[v+1],G!=0&&(te+=4,N*=2,P.xr[H+1]<0&&N++,xt(G<=1)),G=P.l3_enc[v+2],G!=0&&(te+=2,N*=2,P.xr[H+2]<0&&N++,xt(G<=1)),G=P.l3_enc[v+3],G!=0&&(te++,N*=2,P.xr[H+3]<0&&N++,xt(G<=1)),v+=4,H+=4,S(L,N+y.table[te],y.hlen[te]),B+=y.hlen[te]}return B}function R(L,P,y,O,B){var v=Ql.ht[P],H=0;if(xt(P<32),P==0)return H;for(var N=y;N<O;N+=2){var te=0,G=0,se=v.xlen,M=v.xlen,F=0,Z=B.l3_enc[N],ee=B.l3_enc[N+1];if(Z!=0&&(B.xr[N]<0&&F++,te--),P>15){if(Z>14){var ue=Z-15;xt(ue<=v.linmax),F|=ue<<1,G=se,Z=15}if(ee>14){var Pe=ee-15;xt(Pe<=v.linmax),F<<=se,F|=Pe,G+=se,ee=15}M=16}ee!=0&&(F<<=1,B.xr[N+1]<0&&F++,te--),xt((Z|ee)<16),Z=Z*M+ee,G-=te,te+=v.hlen[Z],xt(te<=t),xt(G<=t),S(L,v.table[Z],te),S(L,F,G),H+=te+G}return H}function V(L,P){var y=3*L.scalefac_band.s[3];y>P.big_values&&(y=P.big_values);var O=R(L,P.table_select[0],0,y,P);return O+=R(L,P.table_select[1],y,P.big_values,P),O}function f(L,P){var y,O,B,v;y=P.big_values,xt(0<=y&&y<=576);var H=P.region0_count+1;return xt(0<=H),xt(H<L.scalefac_band.l.length),B=L.scalefac_band.l[H],H+=P.region1_count+1,xt(0<=H),xt(H<L.scalefac_band.l.length),v=L.scalefac_band.l[H],B>y&&(B=y),v>y&&(v=y),O=R(L,P.table_select[0],0,B,P),O+=R(L,P.table_select[1],B,v,P),O+=R(L,P.table_select[2],v,y,P),O}function D(L){var P,y,O,B,v=0,H=L.internal_flags,N=H.l3_side;if(L.version==1)for(P=0;P<2;P++)for(y=0;y<H.channels_out;y++){var te=N.tt[P][y],G=Ud.slen1_tab[te.scalefac_compress],se=Ud.slen2_tab[te.scalefac_compress];for(B=0,O=0;O<te.sfbdivide;O++)te.scalefac[O]!=-1&&(S(H,te.scalefac[O],G),B+=G);for(;O<te.sfbmax;O++)te.scalefac[O]!=-1&&(S(H,te.scalefac[O],se),B+=se);xt(B==te.part2_length),te.block_type==xa.SHORT_TYPE?B+=V(H,te):B+=f(H,te),B+=b(H,te),xt(B==te.part2_3_length+te.part2_length),v+=B}else for(P=0,y=0;y<H.channels_out;y++){var te=N.tt[P][y],M,F,Z=0;if(xt(te.sfb_partition_table!=null),B=0,O=0,F=0,te.block_type==xa.SHORT_TYPE){for(;F<4;F++){var ee=te.sfb_partition_table[F]/3,ue=te.slen[F];for(M=0;M<ee;M++,O++)S(H,Math.max(te.scalefac[O*3+0],0),ue),S(H,Math.max(te.scalefac[O*3+1],0),ue),S(H,Math.max(te.scalefac[O*3+2],0),ue),Z+=3*ue}B+=V(H,te)}else{for(;F<4;F++){var ee=te.sfb_partition_table[F],ue=te.slen[F];for(M=0;M<ee;M++,O++)S(H,Math.max(te.scalefac[O],0),ue),Z+=ue}B+=f(H,te)}B+=b(H,te),xt(B==te.part2_3_length),xt(Z==te.part2_length),v+=Z+B}return v}function l(){this.total=0}function W(L,P){var y=L.internal_flags,O,B,v,H,N;return N=y.w_ptr,H=y.h_ptr-1,H==-1&&(H=Nr.MAX_HEADER_BUF-1),O=y.header[H].write_timing-c,P.total=O,O>=0&&(B=1+H-N,H<N&&(B=1+H-N+Nr.MAX_HEADER_BUF),O-=B*8*y.sideinfo_len),v=r.getframebits(L),O+=v,P.total+=v,P.total%8!=0?P.total=1+P.total/8:P.total=P.total/8,P.total+=_+1,O<0&&Bs.err.println(`strange error flushing buffer ... 
`),O}this.flush_bitstream=function(L){var P=L.internal_flags,y,O,B=P.h_ptr-1;if(B==-1&&(B=Nr.MAX_HEADER_BUF-1),y=P.l3_side,!((O=W(L,new l))<0)){if(A(L,O),xt(P.header[B].write_timing+this.getframebits(L)==c),P.ResvSize=0,y.main_data_begin=0,P.findReplayGain){var v=n.GetTitleGain(P.rgdata);xt(NEQ(v,GainAnalysis.GAIN_NOT_ENOUGH_SAMPLES)),P.RadioGain=Math.floor(v*10+.5)|0}P.findPeakSample&&(P.noclipGainChange=Math.ceil(Math.log10(P.PeakSample/32767)*20*10)|0,P.noclipGainChange>0&&(EQ(L.scale,1)||EQ(L.scale,0))?P.noclipScale=Math.floor(32767/P.PeakSample*100)/100:P.noclipScale=-1)}},this.add_dummy_byte=function(L,P,y){for(var O=L.internal_flags,B;y-- >0;)for(E(O,P,8),B=0;B<Nr.MAX_HEADER_BUF;++B)O.header[B].write_timing+=8},this.format_bitstream=function(L){var P=L.internal_flags,y;y=P.l3_side;var O=this.getframebits(L);A(L,y.resvDrain_pre),T(L,O);var B=8*P.sideinfo_len;if(B+=D(L),A(L,y.resvDrain_post),B+=y.resvDrain_post,y.main_data_begin+=(O-B)/8,W(L,new l)!=P.ResvSize&&Bs.err.println("Internal buffer inconsistency. flushbits <> ResvSize"),y.main_data_begin*8!=P.ResvSize&&(Bs.err.printf(`bit reservoir error: 
l3_side.main_data_begin: %d 
Resvoir size:             %d 
resv drain (post)         %d 
resv drain (pre)          %d 
header and sideinfo:      %d 
data bits:                %d 
total bits:               %d (remainder: %d) 
bitsperframe:             %d 
`,8*y.main_data_begin,P.ResvSize,y.resvDrain_post,y.resvDrain_pre,8*P.sideinfo_len,B-y.resvDrain_post-8*P.sideinfo_len,B,B%8,O),Bs.err.println("This is a fatal error.  It has several possible causes:"),Bs.err.println("90%%  LAME compiled with buggy version of gcc using advanced optimizations"),Bs.err.println(" 9%%  Your system is overclocked"),Bs.err.println(" 1%%  bug in LAME encoding library"),P.ResvSize=y.main_data_begin*8),xt(c%8==0),c>1e9){var v;for(v=0;v<Nr.MAX_HEADER_BUF;++v)P.header[v].write_timing-=c;c=0}return 0},this.copy_buffer=function(L,P,y,O,B){var v=_+1;if(v<=0)return 0;if(O!=0&&v>O)return-1;if(Bs.arraycopy(d,0,P,y,v),_=-1,m=0,B!=0){var H=f2(1);if(H[0]=L.nMusicCRC,h.updateMusicCRC(H,P,y,v),L.nMusicCRC=H[0],v>0&&(L.VBR_seek_table.nBytesWritten+=v),L.decode_on_the_fly){for(var N=u2([2,1152]),te=v,G=-1,se;G!=0;)if(G=i.hip_decode1_unclipped(L.hip,P,y,te,N[0],N[1]),te=0,G==-1&&(G=0),G>0){if(xt(G<=1152),L.findPeakSample){for(se=0;se<G;se++)N[0][se]>L.PeakSample?L.PeakSample=N[0][se]:-N[0][se]>L.PeakSample&&(L.PeakSample=-N[0][se]);if(L.channels_out>1)for(se=0;se<G;se++)N[1][se]>L.PeakSample?L.PeakSample=N[1][se]:-N[1][se]>L.PeakSample&&(L.PeakSample=-N[1][se])}if(L.findReplayGain&&n.AnalyzeSamples(L.rgdata,N[0],0,N[1],0,G,L.channels_out)==GainAnalysis.GAIN_ANALYSIS_ERROR)return-6}}}return v},this.init_bit_stream_w=function(L){d=d2(Lame.LAME_MAXMP3BUFFER),L.h_ptr=L.w_ptr=0,L.header[L.h_ptr].write_timing=0,_=-1,m=0,c=0}}var C0=Ua,oi=fn,p2=oi.System,nn=oi.VbrMode;oi.Float;var Jl=oi.ShortBlock;oi.Util;oi.Arrays;oi.new_array_n;oi.new_byte;oi.new_double;var Dr=oi.new_float;oi.new_float_n;oi.new_int;var zd=oi.new_int_n,_2=oi.new_short_n,Ui=oi.assert,eh=Cg,m2=Eg,Io=el,g2=Kg,v2=Zg,b2=s2,Fr=C0,Ms=Dh,wn=Qn();function Tn(){var r=this,e=128*1024;Tn.V9=410,Tn.V8=420,Tn.V7=430,Tn.V6=440,Tn.V5=450,Tn.V4=460,Tn.V3=470,Tn.V2=480,Tn.V1=490,Tn.V0=500,Tn.R3MIX=1e3,Tn.STANDARD=1001,Tn.EXTREME=1002,Tn.INSANE=1003,Tn.STANDARD_FAST=1004,Tn.EXTREME_FAST=1005,Tn.MEDIUM=1006,Tn.MEDIUM_FAST=1007;var t=16384+e;Tn.LAME_MAXMP3BUFFER=t;var n,i,s,h,d,c=new eh,_,m,g;this.enc=new wn,this.setModules=function(M,F,Z,ee,ue,Pe,_e,ke,Ne){n=M,i=F,s=Z,h=ee,d=ue,_=Pe,m=ke,g=Ne,this.enc.setModules(i,c,h,_)};function S(){this.mask_adjust=0,this.mask_adjust_short=0,this.bo_l_weight=Dr(wn.SBMAX_l),this.bo_s_weight=Dr(wn.SBMAX_s)}function E(){this.lowerlimit=0}function A(M,F){this.lowpass=F}var C=4294479419;function k(M){var F;return M.class_id=C,F=M.internal_flags=new Io,M.mode=MPEGMode.NOT_SET,M.original=1,M.in_samplerate=44100,M.num_channels=2,M.num_samples=-1,M.bWriteVbrTag=!0,M.quality=-1,M.short_blocks=null,F.subblock_gain=-1,M.lowpassfreq=0,M.highpassfreq=0,M.lowpasswidth=-1,M.highpasswidth=-1,M.VBR=nn.vbr_off,M.VBR_q=4,M.ATHcurve=-1,M.VBR_mean_bitrate_kbps=128,M.VBR_min_bitrate_kbps=0,M.VBR_max_bitrate_kbps=0,M.VBR_hard_min=0,F.VBR_min_bitrate=1,F.VBR_max_bitrate=13,M.quant_comp=-1,M.quant_comp_short=-1,M.msfix=-1,F.resample_ratio=1,F.OldValue[0]=180,F.OldValue[1]=180,F.CurrentStep[0]=4,F.CurrentStep[1]=4,F.masking_lower=1,F.nsPsy.attackthre=-1,F.nsPsy.attackthre_s=-1,M.scale=-1,M.athaa_type=-1,M.ATHtype=-1,M.athaa_loudapprox=-1,M.athaa_sensitivity=0,M.useTemporal=null,M.interChRatio=-1,F.mf_samples_to_encode=wn.ENCDELAY+wn.POSTDELAY,M.encoder_padding=0,F.mf_size=wn.ENCDELAY-wn.MDCTDELAY,M.findReplayGain=!1,M.decode_on_the_fly=!1,F.decode_on_the_fly=!1,F.findReplayGain=!1,F.findPeakSample=!1,F.RadioGain=0,F.AudiophileGain=0,F.noclipGainChange=0,F.noclipScale=-1,M.preset=0,M.write_id3tag_automatic=!0,0}this.lame_init=function(){var M=new m2;return k(M),M.lame_allocated_gfp=1,M};function T(M){return M>1?0:M<=0?1:Math.cos(Math.PI/2*M)}this.nearestBitrateFullIndex=function(M){var F=[8,16,24,32,40,48,56,64,80,96,112,128,160,192,224,256,320],Z=0,ee=0,ue=0,Pe=0;Pe=F[16],ue=16,ee=F[16],Z=16;for(var _e=0;_e<16;_e++)if(Math.max(M,F[_e+1])!=M){Pe=F[_e+1],ue=_e+1,ee=F[_e],Z=_e;break}return Pe-M>M-ee?Z:ue};function b(M,F){var Z=44100;return F>=48e3?Z=48e3:F>=44100?Z=44100:F>=32e3?Z=32e3:F>=24e3?Z=24e3:F>=22050?Z=22050:F>=16e3?Z=16e3:F>=12e3?Z=12e3:F>=11025?Z=11025:F>=8e3&&(Z=8e3),M==-1?Z:(M<=15960&&(Z=44100),M<=15250&&(Z=32e3),M<=11220&&(Z=24e3),M<=9970&&(Z=22050),M<=7230&&(Z=16e3),M<=5420&&(Z=12e3),M<=4510&&(Z=11025),M<=3970&&(Z=8e3),F<Z?F>44100?48e3:F>32e3?44100:F>24e3?32e3:F>22050?24e3:F>16e3?22050:F>12e3?16e3:F>11025?12e3:F>8e3?11025:8e3:Z)}function R(M,F){switch(M){case 44100:return F.version=1,0;case 48e3:return F.version=1,1;case 32e3:return F.version=1,2;case 22050:return F.version=0,0;case 24e3:return F.version=0,1;case 16e3:return F.version=0,2;case 11025:return F.version=0,0;case 12e3:return F.version=0,1;case 8e3:return F.version=0,2;default:return F.version=0,-1}}function V(M,F,Z){Z<16e3&&(F=2);for(var ee=Ms.bitrate_table[F][1],ue=2;ue<=14;ue++)Ms.bitrate_table[F][ue]>0&&Math.abs(Ms.bitrate_table[F][ue]-M)<Math.abs(ee-M)&&(ee=Ms.bitrate_table[F][ue]);return ee}function f(M,F,Z){Z<16e3&&(F=2);for(var ee=0;ee<=14;ee++)if(Ms.bitrate_table[F][ee]>0&&Ms.bitrate_table[F][ee]==M)return ee;return-1}function D(M,F){var Z=[new A(8,2e3),new A(16,3700),new A(24,3900),new A(32,5500),new A(40,7e3),new A(48,7500),new A(56,1e4),new A(64,11e3),new A(80,13500),new A(96,15100),new A(112,15600),new A(128,17e3),new A(160,17500),new A(192,18600),new A(224,19400),new A(256,19700),new A(320,20500)],ee=r.nearestBitrateFullIndex(F);M.lowerlimit=Z[ee].lowpass}function l(M){var F=M.internal_flags,Z=32,ee=-1;if(F.lowpass1>0){for(var ue=999,Pe=0;Pe<=31;Pe++){var _e=Pe/31;_e>=F.lowpass2&&(Z=Math.min(Z,Pe)),F.lowpass1<_e&&_e<F.lowpass2&&(ue=Math.min(ue,Pe))}ue==999?F.lowpass1=(Z-.75)/31:F.lowpass1=(ue-.75)/31,F.lowpass2=Z/31}if(F.highpass2>0&&F.highpass2<.9*(.75/31)&&(F.highpass1=0,F.highpass2=0,p2.err.println(`Warning: highpass filter disabled.  highpass frequency too small
`)),F.highpass2>0){for(var ke=-1,Pe=0;Pe<=31;Pe++){var _e=Pe/31;_e<=F.highpass1&&(ee=Math.max(ee,Pe)),F.highpass1<_e&&_e<F.highpass2&&(ke=Math.max(ke,Pe))}F.highpass1=ee/31,ke==-1?F.highpass2=(ee+.75)/31:F.highpass2=(ke+.75)/31}for(var Pe=0;Pe<32;Pe++){var Ne,Be,_e=Pe/31;F.highpass2>F.highpass1?Ne=T((F.highpass2-_e)/(F.highpass2-F.highpass1+1e-20)):Ne=1,F.lowpass2>F.lowpass1?Be=T((_e-F.lowpass1)/(F.lowpass2-F.lowpass1+1e-20)):Be=1,F.amp_filter[Pe]=Ne*Be}}function W(M){var F=M.internal_flags;switch(M.quality){default:case 9:F.psymodel=0,F.noise_shaping=0,F.noise_shaping_amp=0,F.noise_shaping_stop=0,F.use_best_huffman=0,F.full_outer_loop=0;break;case 8:M.quality=7;case 7:F.psymodel=1,F.noise_shaping=0,F.noise_shaping_amp=0,F.noise_shaping_stop=0,F.use_best_huffman=0,F.full_outer_loop=0;break;case 6:F.psymodel=1,F.noise_shaping==0&&(F.noise_shaping=1),F.noise_shaping_amp=0,F.noise_shaping_stop=0,F.subblock_gain==-1&&(F.subblock_gain=1),F.use_best_huffman=0,F.full_outer_loop=0;break;case 5:F.psymodel=1,F.noise_shaping==0&&(F.noise_shaping=1),F.noise_shaping_amp=0,F.noise_shaping_stop=0,F.subblock_gain==-1&&(F.subblock_gain=1),F.use_best_huffman=0,F.full_outer_loop=0;break;case 4:F.psymodel=1,F.noise_shaping==0&&(F.noise_shaping=1),F.noise_shaping_amp=0,F.noise_shaping_stop=0,F.subblock_gain==-1&&(F.subblock_gain=1),F.use_best_huffman=1,F.full_outer_loop=0;break;case 3:F.psymodel=1,F.noise_shaping==0&&(F.noise_shaping=1),F.noise_shaping_amp=1,F.noise_shaping_stop=1,F.subblock_gain==-1&&(F.subblock_gain=1),F.use_best_huffman=1,F.full_outer_loop=0;break;case 2:F.psymodel=1,F.noise_shaping==0&&(F.noise_shaping=1),F.substep_shaping==0&&(F.substep_shaping=2),F.noise_shaping_amp=1,F.noise_shaping_stop=1,F.subblock_gain==-1&&(F.subblock_gain=1),F.use_best_huffman=1,F.full_outer_loop=0;break;case 1:F.psymodel=1,F.noise_shaping==0&&(F.noise_shaping=1),F.substep_shaping==0&&(F.substep_shaping=2),F.noise_shaping_amp=2,F.noise_shaping_stop=1,F.subblock_gain==-1&&(F.subblock_gain=1),F.use_best_huffman=1,F.full_outer_loop=0;break;case 0:F.psymodel=1,F.noise_shaping==0&&(F.noise_shaping=1),F.substep_shaping==0&&(F.substep_shaping=2),F.noise_shaping_amp=2,F.noise_shaping_stop=1,F.subblock_gain==-1&&(F.subblock_gain=1),F.use_best_huffman=1,F.full_outer_loop=0;break}}function L(M){var F=M.internal_flags;M.frameNum=0,M.write_id3tag_automatic&&m.id3tag_write_v2(M),F.bitrate_stereoMode_Hist=zd([16,5]),F.bitrate_blockType_Hist=zd([16,6]),F.PeakSample=0,M.bWriteVbrTag&&_.InitVbrTag(M)}this.lame_init_params=function(M){var F=M.internal_flags;if(F.Class_ID=0,F.ATH==null&&(F.ATH=new g2),F.PSY==null&&(F.PSY=new S),F.rgdata==null&&(F.rgdata=new v2),F.channels_in=M.num_channels,F.channels_in==1&&(M.mode=MPEGMode.MONO),F.channels_out=M.mode==MPEGMode.MONO?1:2,F.mode_ext=wn.MPG_MD_MS_LR,M.mode==MPEGMode.MONO&&(M.force_ms=!1),M.VBR==nn.vbr_off&&M.VBR_mean_bitrate_kbps!=128&&M.brate==0&&(M.brate=M.VBR_mean_bitrate_kbps),M.VBR==nn.vbr_off||M.VBR==nn.vbr_mtrh||M.VBR==nn.vbr_mt||(M.free_format=!1),M.VBR==nn.vbr_off&&M.brate==0&&Fr.EQ(M.compression_ratio,0)&&(M.compression_ratio=11.025),M.VBR==nn.vbr_off&&M.compression_ratio>0&&(M.out_samplerate==0&&(M.out_samplerate=map2MP3Frequency(int(.97*M.in_samplerate))),M.brate=0|M.out_samplerate*16*F.channels_out/(1e3*M.compression_ratio),F.samplerate_index=R(M.out_samplerate,M),M.free_format||(M.brate=V(M.brate,M.version,M.out_samplerate))),M.out_samplerate!=0&&(M.out_samplerate<16e3?(M.VBR_mean_bitrate_kbps=Math.max(M.VBR_mean_bitrate_kbps,8),M.VBR_mean_bitrate_kbps=Math.min(M.VBR_mean_bitrate_kbps,64)):M.out_samplerate<32e3?(M.VBR_mean_bitrate_kbps=Math.max(M.VBR_mean_bitrate_kbps,8),M.VBR_mean_bitrate_kbps=Math.min(M.VBR_mean_bitrate_kbps,160)):(M.VBR_mean_bitrate_kbps=Math.max(M.VBR_mean_bitrate_kbps,32),M.VBR_mean_bitrate_kbps=Math.min(M.VBR_mean_bitrate_kbps,320))),M.lowpassfreq==0){var Z=16e3;switch(M.VBR){case nn.vbr_off:{var ee=new E;D(ee,M.brate),Z=ee.lowerlimit;break}case nn.vbr_abr:{var ee=new E;D(ee,M.VBR_mean_bitrate_kbps),Z=ee.lowerlimit;break}case nn.vbr_rh:{var ue=[19500,19e3,18600,18e3,17500,16e3,15600,14900,12500,1e4,3950];if(0<=M.VBR_q&&M.VBR_q<=9){var Pe=ue[M.VBR_q],_e=ue[M.VBR_q+1],ke=M.VBR_q_frac;Z=linear_int(Pe,_e,ke)}else Z=19500;break}default:{var ue=[19500,19e3,18500,18e3,17500,16500,15500,14500,12500,9500,3950];if(0<=M.VBR_q&&M.VBR_q<=9){var Pe=ue[M.VBR_q],_e=ue[M.VBR_q+1],ke=M.VBR_q_frac;Z=linear_int(Pe,_e,ke)}else Z=19500}}M.mode==MPEGMode.MONO&&(M.VBR==nn.vbr_off||M.VBR==nn.vbr_abr)&&(Z*=1.5),M.lowpassfreq=Z|0}if(M.out_samplerate==0&&(2*M.lowpassfreq>M.in_samplerate&&(M.lowpassfreq=M.in_samplerate/2),M.out_samplerate=b(M.lowpassfreq|0,M.in_samplerate)),M.lowpassfreq=Math.min(20500,M.lowpassfreq),M.lowpassfreq=Math.min(M.out_samplerate/2,M.lowpassfreq),M.VBR==nn.vbr_off&&(M.compression_ratio=M.out_samplerate*16*F.channels_out/(1e3*M.brate)),M.VBR==nn.vbr_abr&&(M.compression_ratio=M.out_samplerate*16*F.channels_out/(1e3*M.VBR_mean_bitrate_kbps)),M.bWriteVbrTag||(M.findReplayGain=!1,M.decode_on_the_fly=!1,F.findPeakSample=!1),F.findReplayGain=M.findReplayGain,F.decode_on_the_fly=M.decode_on_the_fly,F.decode_on_the_fly&&(F.findPeakSample=!0),F.findReplayGain&&n.InitGainAnalysis(F.rgdata,M.out_samplerate)==GainAnalysis.INIT_GAIN_ANALYSIS_ERROR)return M.internal_flags=null,-6;switch(F.decode_on_the_fly&&!M.decode_only&&(F.hip!=null&&g.hip_decode_exit(F.hip),F.hip=g.hip_decode_init()),F.mode_gr=M.out_samplerate<=24e3?1:2,M.framesize=576*F.mode_gr,M.encoder_delay=wn.ENCDELAY,F.resample_ratio=M.in_samplerate/M.out_samplerate,M.VBR){case nn.vbr_mt:case nn.vbr_rh:case nn.vbr_mtrh:{var Ne=[5.7,6.5,7.3,8.2,10,11.9,13,14,15,16.5];M.compression_ratio=Ne[M.VBR_q]}break;case nn.vbr_abr:M.compression_ratio=M.out_samplerate*16*F.channels_out/(1e3*M.VBR_mean_bitrate_kbps);break;default:M.compression_ratio=M.out_samplerate*16*F.channels_out/(1e3*M.brate);break}if(M.mode==MPEGMode.NOT_SET&&(M.mode=MPEGMode.JOINT_STEREO),M.highpassfreq>0?(F.highpass1=2*M.highpassfreq,M.highpasswidth>=0?F.highpass2=2*(M.highpassfreq+M.highpasswidth):F.highpass2=1*2*M.highpassfreq,F.highpass1/=M.out_samplerate,F.highpass2/=M.out_samplerate):(F.highpass1=0,F.highpass2=0),M.lowpassfreq>0?(F.lowpass2=2*M.lowpassfreq,M.lowpasswidth>=0?(F.lowpass1=2*(M.lowpassfreq-M.lowpasswidth),F.lowpass1<0&&(F.lowpass1=0)):F.lowpass1=1*2*M.lowpassfreq,F.lowpass1/=M.out_samplerate,F.lowpass2/=M.out_samplerate):(F.lowpass1=0,F.lowpass2=0),l(M),F.samplerate_index=R(M.out_samplerate,M),F.samplerate_index<0)return M.internal_flags=null,-1;if(M.VBR==nn.vbr_off){if(M.free_format)F.bitrate_index=0;else if(M.brate=V(M.brate,M.version,M.out_samplerate),F.bitrate_index=f(M.brate,M.version,M.out_samplerate),F.bitrate_index<=0)return M.internal_flags=null,-1}else F.bitrate_index=1;M.analysis&&(M.bWriteVbrTag=!1),F.pinfo!=null&&(M.bWriteVbrTag=!1),i.init_bit_stream_w(F);for(var Be=F.samplerate_index+3*M.version+6*(M.out_samplerate<16e3?1:0),pe=0;pe<wn.SBMAX_l+1;pe++)F.scalefac_band.l[pe]=h.sfBandIndex[Be].l[pe];for(var pe=0;pe<wn.PSFB21+1;pe++){var Oe=(F.scalefac_band.l[22]-F.scalefac_band.l[21])/wn.PSFB21,nt=F.scalefac_band.l[21]+pe*Oe;F.scalefac_band.psfb21[pe]=nt}F.scalefac_band.psfb21[wn.PSFB21]=576;for(var pe=0;pe<wn.SBMAX_s+1;pe++)F.scalefac_band.s[pe]=h.sfBandIndex[Be].s[pe];for(var pe=0;pe<wn.PSFB12+1;pe++){var Oe=(F.scalefac_band.s[13]-F.scalefac_band.s[12])/wn.PSFB12,nt=F.scalefac_band.s[12]+pe*Oe;F.scalefac_band.psfb12[pe]=nt}F.scalefac_band.psfb12[wn.PSFB12]=192,M.version==1?F.sideinfo_len=F.channels_out==1?21:36:F.sideinfo_len=F.channels_out==1?13:21,M.error_protection&&(F.sideinfo_len+=2),L(M),F.Class_ID=C;{var Ve;for(Ve=0;Ve<19;Ve++)F.nsPsy.pefirbuf[Ve]=700*F.mode_gr*F.channels_out;M.ATHtype==-1&&(M.ATHtype=4)}switch(Ui(M.VBR_q<=9),Ui(M.VBR_q>=0),M.VBR){case nn.vbr_mt:M.VBR=nn.vbr_mtrh;case nn.vbr_mtrh:{M.useTemporal==null&&(M.useTemporal=!1),s.apply_preset(M,500-M.VBR_q*10,0),M.quality<0&&(M.quality=LAME_DEFAULT_QUALITY),M.quality<5&&(M.quality=0),M.quality>5&&(M.quality=5),F.PSY.mask_adjust=M.maskingadjust,F.PSY.mask_adjust_short=M.maskingadjust_short,M.experimentalY?F.sfb21_extra=!1:F.sfb21_extra=M.out_samplerate>44e3,F.iteration_loop=new VBRNewIterationLoop(d);break}case nn.vbr_rh:{s.apply_preset(M,500-M.VBR_q*10,0),F.PSY.mask_adjust=M.maskingadjust,F.PSY.mask_adjust_short=M.maskingadjust_short,M.experimentalY?F.sfb21_extra=!1:F.sfb21_extra=M.out_samplerate>44e3,M.quality>6&&(M.quality=6),M.quality<0&&(M.quality=LAME_DEFAULT_QUALITY),F.iteration_loop=new VBROldIterationLoop(d);break}default:{var ot;F.sfb21_extra=!1,M.quality<0&&(M.quality=LAME_DEFAULT_QUALITY),ot=M.VBR,ot==nn.vbr_off&&(M.VBR_mean_bitrate_kbps=M.brate),s.apply_preset(M,M.VBR_mean_bitrate_kbps,0),M.VBR=ot,F.PSY.mask_adjust=M.maskingadjust,F.PSY.mask_adjust_short=M.maskingadjust_short,ot==nn.vbr_off?F.iteration_loop=new b2(d):F.iteration_loop=new ABRIterationLoop(d);break}}if(Ui(M.scale>=0),M.VBR!=nn.vbr_off){if(F.VBR_min_bitrate=1,F.VBR_max_bitrate=14,M.out_samplerate<16e3&&(F.VBR_max_bitrate=8),M.VBR_min_bitrate_kbps!=0&&(M.VBR_min_bitrate_kbps=V(M.VBR_min_bitrate_kbps,M.version,M.out_samplerate),F.VBR_min_bitrate=f(M.VBR_min_bitrate_kbps,M.version,M.out_samplerate),F.VBR_min_bitrate<0)||M.VBR_max_bitrate_kbps!=0&&(M.VBR_max_bitrate_kbps=V(M.VBR_max_bitrate_kbps,M.version,M.out_samplerate),F.VBR_max_bitrate=f(M.VBR_max_bitrate_kbps,M.version,M.out_samplerate),F.VBR_max_bitrate<0))return-1;M.VBR_min_bitrate_kbps=Ms.bitrate_table[M.version][F.VBR_min_bitrate],M.VBR_max_bitrate_kbps=Ms.bitrate_table[M.version][F.VBR_max_bitrate],M.VBR_mean_bitrate_kbps=Math.min(Ms.bitrate_table[M.version][F.VBR_max_bitrate],M.VBR_mean_bitrate_kbps),M.VBR_mean_bitrate_kbps=Math.max(Ms.bitrate_table[M.version][F.VBR_min_bitrate],M.VBR_mean_bitrate_kbps)}return M.tune&&(F.PSY.mask_adjust+=M.tune_value_a,F.PSY.mask_adjust_short+=M.tune_value_a),W(M),Ui(M.scale>=0),M.athaa_type<0?F.ATH.useAdjust=3:F.ATH.useAdjust=M.athaa_type,F.ATH.aaSensitivityP=Math.pow(10,M.athaa_sensitivity/-10),M.short_blocks==null&&(M.short_blocks=Jl.short_block_allowed),M.short_blocks==Jl.short_block_allowed&&(M.mode==MPEGMode.JOINT_STEREO||M.mode==MPEGMode.STEREO)&&(M.short_blocks=Jl.short_block_coupled),M.quant_comp<0&&(M.quant_comp=1),M.quant_comp_short<0&&(M.quant_comp_short=0),M.msfix<0&&(M.msfix=0),M.exp_nspsytune=M.exp_nspsytune|1,M.internal_flags.nsPsy.attackthre<0&&(M.internal_flags.nsPsy.attackthre=eh.NSATTACKTHRE),M.internal_flags.nsPsy.attackthre_s<0&&(M.internal_flags.nsPsy.attackthre_s=eh.NSATTACKTHRE_S),Ui(M.scale>=0),M.scale<0&&(M.scale=1),M.ATHtype<0&&(M.ATHtype=4),M.ATHcurve<0&&(M.ATHcurve=4),M.athaa_loudapprox<0&&(M.athaa_loudapprox=2),M.interChRatio<0&&(M.interChRatio=0),M.useTemporal==null&&(M.useTemporal=!0),F.slot_lag=F.frac_SpF=0,M.VBR==nn.vbr_off&&(F.slot_lag=F.frac_SpF=(M.version+1)*72e3*M.brate%M.out_samplerate|0),h.iteration_init(M),c.psymodel_init(M),Ui(M.scale>=0),0};function P(M,F){(M.in_buffer_0==null||M.in_buffer_nsamples<F)&&(M.in_buffer_0=Dr(F),M.in_buffer_1=Dr(F),M.in_buffer_nsamples=F)}this.lame_encode_flush=function(M,F,Z,ee){var ue=M.internal_flags,Pe=_2([2,1152]),_e=0,ke,Ne,Be,pe,Oe=ue.mf_samples_to_encode-wn.POSTDELAY,nt=y(M);if(ue.mf_samples_to_encode<1)return 0;for(ke=0,M.in_samplerate!=M.out_samplerate&&(Oe+=16*M.out_samplerate/M.in_samplerate),Be=M.framesize-Oe%M.framesize,Be<576&&(Be+=M.framesize),M.encoder_padding=Be,pe=(Oe+Be)/M.framesize;pe>0&&_e>=0;){var Ve=nt-ue.mf_size,ot=M.frameNum;Ve*=M.in_samplerate,Ve/=M.out_samplerate,Ve>1152&&(Ve=1152),Ve<1&&(Ve=1),Ne=ee-ke,ee==0&&(Ne=0),_e=this.lame_encode_buffer(M,Pe[0],Pe[1],Ve,F,Z,Ne),Z+=_e,ke+=_e,pe-=ot!=M.frameNum?1:0}if(ue.mf_samples_to_encode=0,_e<0||(Ne=ee-ke,ee==0&&(Ne=0),i.flush_bitstream(M),_e=i.copy_buffer(ue,F,Z,Ne,1),_e<0))return _e;if(Z+=_e,ke+=_e,Ne=ee-ke,ee==0&&(Ne=0),M.write_id3tag_automatic){if(m.id3tag_write_v1(M),_e=i.copy_buffer(ue,F,Z,Ne,0),_e<0)return _e;ke+=_e}return ke},this.lame_encode_buffer=function(M,F,Z,ee,ue,Pe,_e){var ke=M.internal_flags,Ne=[null,null];if(ke.Class_ID!=C)return-3;if(ee==0)return 0;P(ke,ee),Ne[0]=ke.in_buffer_0,Ne[1]=ke.in_buffer_1;for(var Be=0;Be<ee;Be++)Ne[0][Be]=F[Be],ke.channels_in>1&&(Ne[1][Be]=Z[Be]);return O(M,Ne[0],Ne[1],ee,ue,Pe,_e)};function y(M){var F=wn.BLKSIZE+M.framesize-wn.FFTOFFSET;return F=Math.max(F,512+M.framesize-32),Ui(Io.MFSIZE>=F),F}function O(M,F,Z,ee,ue,Pe,_e){var ke=M.internal_flags,Ne=0,Be,pe,Oe,nt,Ve,ot=[null,null],Ge=[null,null];if(ke.Class_ID!=C)return-3;if(ee==0)return 0;if(Ve=i.copy_buffer(ke,ue,Pe,_e,0),Ve<0)return Ve;if(Pe+=Ve,Ne+=Ve,Ge[0]=F,Ge[1]=Z,Fr.NEQ(M.scale,0)&&Fr.NEQ(M.scale,1))for(pe=0;pe<ee;++pe)Ge[0][pe]*=M.scale,ke.channels_out==2&&(Ge[1][pe]*=M.scale);if(Fr.NEQ(M.scale_left,0)&&Fr.NEQ(M.scale_left,1))for(pe=0;pe<ee;++pe)Ge[0][pe]*=M.scale_left;if(Fr.NEQ(M.scale_right,0)&&Fr.NEQ(M.scale_right,1))for(pe=0;pe<ee;++pe)Ge[1][pe]*=M.scale_right;if(M.num_channels==2&&ke.channels_out==1)for(pe=0;pe<ee;++pe)Ge[0][pe]=.5*(Ge[0][pe]+Ge[1][pe]),Ge[1][pe]=0;nt=y(M),ot[0]=ke.mfbuf[0],ot[1]=ke.mfbuf[1];for(var lt=0;ee>0;){var dt=[null,null],St=0,Mt=0;dt[0]=Ge[0],dt[1]=Ge[1];var Tt=new v;if(se(M,ot,dt,lt,ee,Tt),St=Tt.n_in,Mt=Tt.n_out,ke.findReplayGain&&!ke.decode_on_the_fly&&n.AnalyzeSamples(ke.rgdata,ot[0],ke.mf_size,ot[1],ke.mf_size,Mt,ke.channels_out)==GainAnalysis.GAIN_ANALYSIS_ERROR)return-6;if(ee-=St,lt+=St,ke.channels_out==2,ke.mf_size+=Mt,Ui(ke.mf_size<=Io.MFSIZE),ke.mf_samples_to_encode<1&&(ke.mf_samples_to_encode=wn.ENCDELAY+wn.POSTDELAY),ke.mf_samples_to_encode+=Mt,ke.mf_size>=nt){var Ct=_e-Ne;if(_e==0&&(Ct=0),Be=B(M,ot[0],ot[1],ue,Pe,Ct),Be<0)return Be;for(Pe+=Be,Ne+=Be,ke.mf_size-=M.framesize,ke.mf_samples_to_encode-=M.framesize,Oe=0;Oe<ke.channels_out;Oe++)for(pe=0;pe<ke.mf_size;pe++)ot[Oe][pe]=ot[Oe][pe+M.framesize]}}return Ui(ee==0),Ne}function B(M,F,Z,ee,ue,Pe){var _e=r.enc.lame_encode_mp3_frame(M,F,Z,ee,ue,Pe);return M.frameNum++,_e}function v(){this.n_in=0,this.n_out=0}function H(){this.num_used=0}function N(M,F){return F!=0?N(F,M%F):M}function te(M,F,Z){var ee=Math.PI*F;M/=Z,M<0&&(M=0),M>1&&(M=1);var ue=M-.5,Pe=.42-.5*Math.cos(2*M*Math.PI)+.08*Math.cos(4*M*Math.PI);return Math.abs(ue)<1e-9?ee/Math.PI:Pe*Math.sin(Z*ee*ue)/(Math.PI*Z*ue)}function G(M,F,Z,ee,ue,Pe,_e,ke,Ne){var Be=M.internal_flags,pe,Oe=0,nt,Ve=M.out_samplerate/N(M.out_samplerate,M.in_samplerate);Ve>Io.BPC&&(Ve=Io.BPC);var ot=Math.abs(Be.resample_ratio-Math.floor(.5+Be.resample_ratio))<1e-4?1:0,Ge=1/Be.resample_ratio;Ge>1&&(Ge=1);var lt=31;lt%2==0&&--lt,lt+=ot;var dt=lt+1;if(Be.fill_buffer_resample_init==0){for(Be.inbuf_old[0]=Dr(dt),Be.inbuf_old[1]=Dr(dt),pe=0;pe<=2*Ve;++pe)Be.blackfilt[pe]=Dr(dt);for(Be.itime[0]=0,Be.itime[1]=0,Oe=0;Oe<=2*Ve;Oe++){var St=0,Mt=(Oe-Ve)/(2*Ve);for(pe=0;pe<=lt;pe++)St+=Be.blackfilt[Oe][pe]=te(pe-Mt,Ge,lt);for(pe=0;pe<=lt;pe++)Be.blackfilt[Oe][pe]/=St}Be.fill_buffer_resample_init=1}var Tt=Be.inbuf_old[Ne];for(nt=0;nt<ee;nt++){var Ct,kt;if(Ct=nt*Be.resample_ratio,Oe=0|Math.floor(Ct-Be.itime[Ne]),lt+Oe-lt/2>=_e)break;var Mt=Ct-Be.itime[Ne]-(Oe+.5*(lt%2));Ui(Math.abs(Mt)<=.501),kt=0|Math.floor(Mt*2*Ve+Ve+.5);var bt=0;for(pe=0;pe<=lt;++pe){var Pt=0|pe+Oe-lt/2,Xe;Ui(Pt<_e),Ui(Pt+dt>=0),Xe=Pt<0?Tt[dt+Pt]:ue[Pe+Pt],bt+=Xe*Be.blackfilt[kt][pe]}F[Z+nt]=bt}if(ke.num_used=Math.min(_e,lt+Oe-lt/2),Be.itime[Ne]+=ke.num_used-nt*Be.resample_ratio,ke.num_used>=dt)for(pe=0;pe<dt;pe++)Tt[pe]=ue[Pe+ke.num_used+pe-dt];else{var vt=dt-ke.num_used;for(pe=0;pe<vt;++pe)Tt[pe]=Tt[pe+ke.num_used];for(Oe=0;pe<dt;++pe,++Oe)Tt[pe]=ue[Pe+Oe];Ui(Oe==ke.num_used)}return nt}function se(M,F,Z,ee,ue,Pe){var _e=M.internal_flags;if(_e.resample_ratio<.9999||_e.resample_ratio>1.0001)for(var ke=0;ke<_e.channels_out;ke++){var Ne=new H;Pe.n_out=G(M,F[ke],_e.mf_size,M.framesize,Z[ke],ee,ue,Ne,ke),Pe.n_in=Ne.num_used}else{Pe.n_out=Math.min(M.framesize,ue),Pe.n_in=Pe.n_out;for(var Be=0;Be<Pe.n_out;++Be)F[0][_e.mf_size+Be]=Z[0][ee+Be],_e.channels_out==2&&(F[1][_e.mf_size+Be]=Z[1][ee+Be])}}}var y2=Tn,Ni=fn;Ni.System;var Ts=Ni.VbrMode;Ni.Float;Ni.ShortBlock;Ni.Util;Ni.Arrays;Ni.new_array_n;Ni.new_byte;Ni.new_double;Ni.new_float;Ni.new_float_n;Ni.new_int;Ni.new_int_n;Ni.assert;function w2(){function r(_,m,g,S,E,A,C,k,T,b,R,V,f,D,l){this.vbr_q=_,this.quant_comp=m,this.quant_comp_s=g,this.expY=S,this.st_lrm=E,this.st_s=A,this.masking_adj=C,this.masking_adj_short=k,this.ath_lower=T,this.ath_curve=b,this.ath_sensitivity=R,this.interch=V,this.safejoint=f,this.sfb21mod=D,this.msfix=l}function e(_,m,g,S,E,A,C,k,T,b,R,V,f,D){this.quant_comp=m,this.quant_comp_s=g,this.safejoint=S,this.nsmsfix=E,this.st_lrm=A,this.st_s=C,this.nsbass=k,this.scale=T,this.masking_adj=b,this.ath_lower=R,this.ath_curve=V,this.interch=f,this.sfscale=D}var t;this.setModules=function(_){t=_};var n=[new r(0,9,9,0,5.2,125,-4.2,-6.3,4.8,1,0,0,2,21,.97),new r(1,9,9,0,5.3,125,-3.6,-5.6,4.5,1.5,0,0,2,21,1.35),new r(2,9,9,0,5.6,125,-2.2,-3.5,2.8,2,0,0,2,21,1.49),new r(3,9,9,1,5.8,130,-1.8,-2.8,2.6,3,-4,0,2,20,1.64),new r(4,9,9,1,6,135,-.7,-1.1,1.1,3.5,-8,0,2,0,1.79),new r(5,9,9,1,6.4,140,.5,.4,-7.5,4,-12,2e-4,0,0,1.95),new r(6,9,9,1,6.6,145,.67,.65,-14.7,6.5,-19,4e-4,0,0,2.3),new r(7,9,9,1,6.6,145,.8,.75,-19.7,8,-22,6e-4,0,0,2.7),new r(8,9,9,1,6.6,145,1.2,1.15,-27.5,10,-23,7e-4,0,0,0),new r(9,9,9,1,6.6,145,1.6,1.6,-36,11,-25,8e-4,0,0,0),new r(10,9,9,1,6.6,145,2,2,-36,12,-25,8e-4,0,0,0)],i=[new r(0,9,9,0,4.2,25,-7,-4,7.5,1,0,0,2,26,.97),new r(1,9,9,0,4.2,25,-5.6,-3.6,4.5,1.5,0,0,2,21,1.35),new r(2,9,9,0,4.2,25,-4.4,-1.8,2,2,0,0,2,18,1.49),new r(3,9,9,1,4.2,25,-3.4,-1.25,1.1,3,-4,0,2,15,1.64),new r(4,9,9,1,4.2,25,-2.2,.1,0,3.5,-8,0,2,0,1.79),new r(5,9,9,1,4.2,25,-1,1.65,-7.7,4,-12,2e-4,0,0,1.95),new r(6,9,9,1,4.2,25,-0,2.47,-7.7,6.5,-19,4e-4,0,0,2),new r(7,9,9,1,4.2,25,.5,2,-14.5,8,-22,6e-4,0,0,2),new r(8,9,9,1,4.2,25,1,2.4,-22,10,-23,7e-4,0,0,2),new r(9,9,9,1,4.2,25,1.5,2.95,-30,11,-25,8e-4,0,0,2),new r(10,9,9,1,4.2,25,2,2.95,-36,12,-30,8e-4,0,0,2)];function s(_,m,g){var S=_.VBR==Ts.vbr_rh?n:i,E=_.VBR_q_frac,A=S[m],C=S[m+1],k=A;A.st_lrm=A.st_lrm+E*(C.st_lrm-A.st_lrm),A.st_s=A.st_s+E*(C.st_s-A.st_s),A.masking_adj=A.masking_adj+E*(C.masking_adj-A.masking_adj),A.masking_adj_short=A.masking_adj_short+E*(C.masking_adj_short-A.masking_adj_short),A.ath_lower=A.ath_lower+E*(C.ath_lower-A.ath_lower),A.ath_curve=A.ath_curve+E*(C.ath_curve-A.ath_curve),A.ath_sensitivity=A.ath_sensitivity+E*(C.ath_sensitivity-A.ath_sensitivity),A.interch=A.interch+E*(C.interch-A.interch),A.msfix=A.msfix+E*(C.msfix-A.msfix),c(_,k.vbr_q),g!=0?_.quant_comp=k.quant_comp:Math.abs(_.quant_comp- -1)>0||(_.quant_comp=k.quant_comp),g!=0?_.quant_comp_short=k.quant_comp_s:Math.abs(_.quant_comp_short- -1)>0||(_.quant_comp_short=k.quant_comp_s),k.expY!=0&&(_.experimentalY=k.expY!=0),g!=0?_.internal_flags.nsPsy.attackthre=k.st_lrm:Math.abs(_.internal_flags.nsPsy.attackthre- -1)>0||(_.internal_flags.nsPsy.attackthre=k.st_lrm),g!=0?_.internal_flags.nsPsy.attackthre_s=k.st_s:Math.abs(_.internal_flags.nsPsy.attackthre_s- -1)>0||(_.internal_flags.nsPsy.attackthre_s=k.st_s),g!=0?_.maskingadjust=k.masking_adj:Math.abs(_.maskingadjust-0)>0||(_.maskingadjust=k.masking_adj),g!=0?_.maskingadjust_short=k.masking_adj_short:Math.abs(_.maskingadjust_short-0)>0||(_.maskingadjust_short=k.masking_adj_short),g!=0?_.ATHlower=-k.ath_lower/10:Math.abs(-_.ATHlower*10-0)>0||(_.ATHlower=-k.ath_lower/10),g!=0?_.ATHcurve=k.ath_curve:Math.abs(_.ATHcurve- -1)>0||(_.ATHcurve=k.ath_curve),g!=0?_.athaa_sensitivity=k.ath_sensitivity:Math.abs(_.athaa_sensitivity- -1)>0||(_.athaa_sensitivity=k.ath_sensitivity),k.interch>0&&(g!=0?_.interChRatio=k.interch:Math.abs(_.interChRatio- -1)>0||(_.interChRatio=k.interch)),k.safejoint>0&&(_.exp_nspsytune=_.exp_nspsytune|k.safejoint),k.sfb21mod>0&&(_.exp_nspsytune=_.exp_nspsytune|k.sfb21mod<<20),g!=0?_.msfix=k.msfix:Math.abs(_.msfix- -1)>0||(_.msfix=k.msfix),g==0&&(_.VBR_q=m,_.VBR_q_frac=E)}var h=[new e(8,9,9,0,0,6.6,145,0,.95,0,-30,11,.0012,1),new e(16,9,9,0,0,6.6,145,0,.95,0,-25,11,.001,1),new e(24,9,9,0,0,6.6,145,0,.95,0,-20,11,.001,1),new e(32,9,9,0,0,6.6,145,0,.95,0,-15,11,.001,1),new e(40,9,9,0,0,6.6,145,0,.95,0,-10,11,9e-4,1),new e(48,9,9,0,0,6.6,145,0,.95,0,-10,11,9e-4,1),new e(56,9,9,0,0,6.6,145,0,.95,0,-6,11,8e-4,1),new e(64,9,9,0,0,6.6,145,0,.95,0,-2,11,8e-4,1),new e(80,9,9,0,0,6.6,145,0,.95,0,0,8,7e-4,1),new e(96,9,9,0,2.5,6.6,145,0,.95,0,1,5.5,6e-4,1),new e(112,9,9,0,2.25,6.6,145,0,.95,0,2,4.5,5e-4,1),new e(128,9,9,0,1.95,6.4,140,0,.95,0,3,4,2e-4,1),new e(160,9,9,1,1.79,6,135,0,.95,-2,5,3.5,0,1),new e(192,9,9,1,1.49,5.6,125,0,.97,-4,7,3,0,0),new e(224,9,9,1,1.25,5.2,125,0,.98,-6,9,2,0,0),new e(256,9,9,1,.97,5.2,125,0,1,-8,10,1,0,0),new e(320,9,9,1,.9,5.2,125,0,1,-10,12,0,0,0)];function d(_,m,g){var S=m,E=t.nearestBitrateFullIndex(m);if(_.VBR=Ts.vbr_abr,_.VBR_mean_bitrate_kbps=S,_.VBR_mean_bitrate_kbps=Math.min(_.VBR_mean_bitrate_kbps,320),_.VBR_mean_bitrate_kbps=Math.max(_.VBR_mean_bitrate_kbps,8),_.brate=_.VBR_mean_bitrate_kbps,_.VBR_mean_bitrate_kbps>320&&(_.disable_reservoir=!0),h[E].safejoint>0&&(_.exp_nspsytune=_.exp_nspsytune|2),h[E].sfscale>0&&(_.internal_flags.noise_shaping=2),Math.abs(h[E].nsbass)>0){var A=int(h[E].nsbass*4);A<0&&(A+=64),_.exp_nspsytune=_.exp_nspsytune|A<<2}return g!=0?_.quant_comp=h[E].quant_comp:Math.abs(_.quant_comp- -1)>0||(_.quant_comp=h[E].quant_comp),g!=0?_.quant_comp_short=h[E].quant_comp_s:Math.abs(_.quant_comp_short- -1)>0||(_.quant_comp_short=h[E].quant_comp_s),g!=0?_.msfix=h[E].nsmsfix:Math.abs(_.msfix- -1)>0||(_.msfix=h[E].nsmsfix),g!=0?_.internal_flags.nsPsy.attackthre=h[E].st_lrm:Math.abs(_.internal_flags.nsPsy.attackthre- -1)>0||(_.internal_flags.nsPsy.attackthre=h[E].st_lrm),g!=0?_.internal_flags.nsPsy.attackthre_s=h[E].st_s:Math.abs(_.internal_flags.nsPsy.attackthre_s- -1)>0||(_.internal_flags.nsPsy.attackthre_s=h[E].st_s),g!=0?_.scale=h[E].scale:Math.abs(_.scale- -1)>0||(_.scale=h[E].scale),g!=0?_.maskingadjust=h[E].masking_adj:Math.abs(_.maskingadjust-0)>0||(_.maskingadjust=h[E].masking_adj),h[E].masking_adj>0?g!=0?_.maskingadjust_short=h[E].masking_adj*.9:Math.abs(_.maskingadjust_short-0)>0||(_.maskingadjust_short=h[E].masking_adj*.9):g!=0?_.maskingadjust_short=h[E].masking_adj*1.1:Math.abs(_.maskingadjust_short-0)>0||(_.maskingadjust_short=h[E].masking_adj*1.1),g!=0?_.ATHlower=-h[E].ath_lower/10:Math.abs(-_.ATHlower*10-0)>0||(_.ATHlower=-h[E].ath_lower/10),g!=0?_.ATHcurve=h[E].ath_curve:Math.abs(_.ATHcurve- -1)>0||(_.ATHcurve=h[E].ath_curve),g!=0?_.interChRatio=h[E].interch:Math.abs(_.interChRatio- -1)>0||(_.interChRatio=h[E].interch),m}this.apply_preset=function(_,m,g){switch(m){case Lame.R3MIX:{m=Lame.V3,_.VBR=Ts.vbr_mtrh;break}case Lame.MEDIUM:{m=Lame.V4,_.VBR=Ts.vbr_rh;break}case Lame.MEDIUM_FAST:{m=Lame.V4,_.VBR=Ts.vbr_mtrh;break}case Lame.STANDARD:{m=Lame.V2,_.VBR=Ts.vbr_rh;break}case Lame.STANDARD_FAST:{m=Lame.V2,_.VBR=Ts.vbr_mtrh;break}case Lame.EXTREME:{m=Lame.V0,_.VBR=Ts.vbr_rh;break}case Lame.EXTREME_FAST:{m=Lame.V0,_.VBR=Ts.vbr_mtrh;break}case Lame.INSANE:return m=320,_.preset=m,d(_,m,g),_.VBR=Ts.vbr_off,m}switch(_.preset=m,m){case Lame.V9:return s(_,9,g),m;case Lame.V8:return s(_,8,g),m;case Lame.V7:return s(_,7,g),m;case Lame.V6:return s(_,6,g),m;case Lame.V5:return s(_,5,g),m;case Lame.V4:return s(_,4,g),m;case Lame.V3:return s(_,3,g),m;case Lame.V2:return s(_,2,g),m;case Lame.V1:return s(_,1,g),m;case Lame.V0:return s(_,0,g),m}return 8<=m&&m<=320?d(_,m,g):(_.preset=0,m)};function c(_,m){var g=0;return 0>m&&(g=-1,m=0),9<m&&(g=-1,m=9),_.VBR_q=m,_.VBR_q_frac=0,g}}var x2=w2;function S2(){this.setModules=function(r,e){}}var C2=S2;function k2(){this.over_noise=0,this.tot_noise=0,this.max_noise=0,this.over_count=0,this.over_SSD=0,this.bits=0}var P2=k2,Fh=fn,Xd=Fh.new_float,E2=Fh.new_int;Fh.assert;function B2(){this.global_gain=0,this.sfb_count1=0,this.step=E2(39),this.noise=Xd(39),this.noise_log=Xd(39)}var M2=B2,Di=fn,or=Di.System,$d=Di.VbrMode;Di.Float;Di.ShortBlock;var th=Di.Util,io=Di.Arrays;Di.new_array_n;Di.new_byte;Di.new_double;var Ao=Di.new_float;Di.new_float_n;Di.new_int;Di.new_int_n;var ns=Di.assert,T2=C2,nh=P2,I2=M2,zt=Qn(),Yd=Nh,jd=Ja;function A2(){var r;this.rv=null;var e;this.qupvt=null;var t,n=new T2,i;this.setModules=function(T,b,R,V){r=T,e=b,this.rv=b,t=R,this.qupvt=R,i=V,n.setModules(t,i)},this.ms_convert=function(T,b){for(var R=0;R<576;++R){var V=T.tt[b][0].xr[R],f=T.tt[b][1].xr[R];T.tt[b][0].xr[R]=(V+f)*(th.SQRT2*.5),T.tt[b][1].xr[R]=(V-f)*(th.SQRT2*.5)}};function s(T,b,R,V){V=0;for(var f=0;f<=R;++f){var D=Math.abs(T.xr[f]);V+=D,b[f]=Math.sqrt(D*Math.sqrt(D)),b[f]>T.xrpow_max&&(T.xrpow_max=b[f])}return V}this.init_xrpow=function(T,b,R){var V=0,f=0|b.max_nonzero_coeff;if(ns(R!=null),b.xrpow_max=0,ns(0<=f&&f<=575),io.fill(R,f,576,0),V=s(b,R,f,V),V>1e-20){var D=0;T.substep_shaping&2&&(D=1);for(var l=0;l<b.psymax;l++)T.pseudohalf[l]=D;return!0}return io.fill(b.l3_enc,0,576,0),!1};function h(T,b){var R=T.ATH,V=b.xr;if(b.block_type!=zt.SHORT_TYPE)for(var f=!1,D=zt.PSFB21-1;D>=0&&!f;D--){var l=T.scalefac_band.psfb21[D],W=T.scalefac_band.psfb21[D+1],L=t.athAdjust(R.adjust,R.psfb21[D],R.floor);T.nsPsy.longfact[21]>1e-12&&(L*=T.nsPsy.longfact[21]);for(var P=W-1;P>=l;P--)if(Math.abs(V[P])<L)V[P]=0;else{f=!0;break}}else for(var y=0;y<3;y++)for(var f=!1,D=zt.PSFB12-1;D>=0&&!f;D--){var l=T.scalefac_band.s[12]*3+(T.scalefac_band.s[13]-T.scalefac_band.s[12])*y+(T.scalefac_band.psfb12[D]-T.scalefac_band.psfb12[0]),W=l+(T.scalefac_band.psfb12[D+1]-T.scalefac_band.psfb12[D]),O=t.athAdjust(R.adjust,R.psfb12[D],R.floor);T.nsPsy.shortfact[12]>1e-12&&(O*=T.nsPsy.shortfact[12]);for(var P=W-1;P>=l;P--)if(Math.abs(V[P])<O)V[P]=0;else{f=!0;break}}}this.init_outer_loop=function(T,b){b.part2_3_length=0,b.big_values=0,b.count1=0,b.global_gain=210,b.scalefac_compress=0,b.table_select[0]=0,b.table_select[1]=0,b.table_select[2]=0,b.subblock_gain[0]=0,b.subblock_gain[1]=0,b.subblock_gain[2]=0,b.subblock_gain[3]=0,b.region0_count=0,b.region1_count=0,b.preflag=0,b.scalefac_scale=0,b.count1table_select=0,b.part2_length=0,b.sfb_lmax=zt.SBPSY_l,b.sfb_smin=zt.SBPSY_s,b.psy_lmax=T.sfb21_extra?zt.SBMAX_l:zt.SBPSY_l,b.psymax=b.psy_lmax,b.sfbmax=b.sfb_lmax,b.sfbdivide=11;for(var R=0;R<zt.SBMAX_l;R++)b.width[R]=T.scalefac_band.l[R+1]-T.scalefac_band.l[R],b.window[R]=3;if(b.block_type==zt.SHORT_TYPE){var V=Ao(576);b.sfb_smin=0,b.sfb_lmax=0,b.mixed_block_flag!=0&&(b.sfb_smin=3,b.sfb_lmax=T.mode_gr*2+4),b.psymax=b.sfb_lmax+3*((T.sfb21_extra?zt.SBMAX_s:zt.SBPSY_s)-b.sfb_smin),b.sfbmax=b.sfb_lmax+3*(zt.SBPSY_s-b.sfb_smin),b.sfbdivide=b.sfbmax-18,b.psy_lmax=b.sfb_lmax;var f=T.scalefac_band.l[b.sfb_lmax];or.arraycopy(b.xr,0,V,0,576);for(var R=b.sfb_smin;R<zt.SBMAX_s;R++)for(var D=T.scalefac_band.s[R],l=T.scalefac_band.s[R+1],W=0;W<3;W++)for(var L=D;L<l;L++)b.xr[f++]=V[3*L+W];for(var P=b.sfb_lmax,R=b.sfb_smin;R<zt.SBMAX_s;R++)b.width[P]=b.width[P+1]=b.width[P+2]=T.scalefac_band.s[R+1]-T.scalefac_band.s[R],b.window[P]=0,b.window[P+1]=1,b.window[P+2]=2,P+=3}b.count1bits=0,b.sfb_partition_table=t.nr_of_sfb_block[0][0],b.slen[0]=0,b.slen[1]=0,b.slen[2]=0,b.slen[3]=0,b.max_nonzero_coeff=575,io.fill(b.scalefac,0),h(T,b)};function d(T){this.ordinal=T}d.BINSEARCH_NONE=new d(0),d.BINSEARCH_UP=new d(1),d.BINSEARCH_DOWN=new d(2);function c(T,b,R,V,f){var D,l=T.CurrentStep[V],W=!1,L=T.OldValue[V],P=d.BINSEARCH_NONE;for(b.global_gain=L,R-=b.part2_length,ns(l!=0);;){var y;if(D=i.count_bits(T,f,b,null),l==1||D==R)break;D>R?(P==d.BINSEARCH_DOWN&&(W=!0),W&&(l/=2),P=d.BINSEARCH_UP,y=l):(P==d.BINSEARCH_UP&&(W=!0),W&&(l/=2),P=d.BINSEARCH_DOWN,y=-l),b.global_gain+=y,b.global_gain<0&&(b.global_gain=0,W=!0),b.global_gain>255&&(b.global_gain=255,W=!0)}for(ns(b.global_gain>=0),ns(b.global_gain<256);D>R&&b.global_gain<255;)b.global_gain++,D=i.count_bits(T,f,b,null);return T.CurrentStep[V]=L-b.global_gain>=4?4:2,T.OldValue[V]=b.global_gain,b.part2_3_length=D,D}this.trancate_smallspectrums=function(T,b,R,V){var f=Ao(jd.SFBMAX);if(!(!(T.substep_shaping&4)&&b.block_type==zt.SHORT_TYPE||T.substep_shaping&128)){t.calc_noise(b,R,f,new nh,null);for(var l=0;l<576;l++){var D=0;b.l3_enc[l]!=0&&(D=Math.abs(b.xr[l])),V[l]=D}var l=0,W=8;b.block_type==zt.SHORT_TYPE&&(W=6);do{var L,P,y,O,B=b.width[W];if(l+=B,!(f[W]>=1)&&(io.sort(V,l-B,B),!BitStream.EQ(V[l-1],0))){L=(1-f[W])*R[W],P=0,O=0;do{var v;for(y=1;O+y<B&&!BitStream.NEQ(V[O+l-B],V[O+l+y-B]);y++);if(v=V[O+l-B]*V[O+l-B]*y,L<v){O!=0&&(P=V[O+l-B-1]);break}L-=v,O+=y}while(O<B);if(!BitStream.EQ(P,0))do Math.abs(b.xr[l-B])<=P&&(b.l3_enc[l-B]=0);while(--B>0)}}while(++W<b.psymax);b.part2_3_length=i.noquant_count_bits(T,b,null)}};function _(T){for(var b=0;b<T.sfbmax;b++)if(T.scalefac[b]+T.subblock_gain[T.window[b]]==0)return!1;return!0}function m(T){return th.FAST_LOG10(.368+.632*T*T*T)}function g(T,b){for(var R=1e-37,V=0;V<b.psymax;V++)R+=m(T[V]);return Math.max(1e-20,R)}function S(T,b,R,V,f){var D;switch(T){default:case 9:{b.over_count>0?(D=R.over_SSD<=b.over_SSD,R.over_SSD==b.over_SSD&&(D=R.bits<b.bits)):D=R.max_noise<0&&R.max_noise*10+R.bits<=b.max_noise*10+b.bits;break}case 0:D=R.over_count<b.over_count||R.over_count==b.over_count&&R.over_noise<b.over_noise||R.over_count==b.over_count&&BitStream.EQ(R.over_noise,b.over_noise)&&R.tot_noise<b.tot_noise;break;case 8:R.max_noise=g(f,V);case 1:D=R.max_noise<b.max_noise;break;case 2:D=R.tot_noise<b.tot_noise;break;case 3:D=R.tot_noise<b.tot_noise&&R.max_noise<b.max_noise;break;case 4:D=R.max_noise<=0&&b.max_noise>.2||R.max_noise<=0&&b.max_noise<0&&b.max_noise>R.max_noise-.2&&R.tot_noise<b.tot_noise||R.max_noise<=0&&b.max_noise>0&&b.max_noise>R.max_noise-.2&&R.tot_noise<b.tot_noise+b.over_noise||R.max_noise>0&&b.max_noise>-.05&&b.max_noise>R.max_noise-.1&&R.tot_noise+R.over_noise<b.tot_noise+b.over_noise||R.max_noise>0&&b.max_noise>-.1&&b.max_noise>R.max_noise-.15&&R.tot_noise+R.over_noise+R.over_noise<b.tot_noise+b.over_noise+b.over_noise;break;case 5:D=R.over_noise<b.over_noise||BitStream.EQ(R.over_noise,b.over_noise)&&R.tot_noise<b.tot_noise;break;case 6:D=R.over_noise<b.over_noise||BitStream.EQ(R.over_noise,b.over_noise)&&(R.max_noise<b.max_noise||BitStream.EQ(R.max_noise,b.max_noise)&&R.tot_noise<=b.tot_noise);break;case 7:D=R.over_count<b.over_count||R.over_noise<b.over_noise;break}return b.over_count==0&&(D=D&&R.bits<b.bits),D}function E(T,b,R,V,f){var D=T.internal_flags,l;b.scalefac_scale==0?l=1.2968395546510096:l=1.6817928305074292;for(var W=0,L=0;L<b.sfbmax;L++)W<R[L]&&(W=R[L]);var P=D.noise_shaping_amp;switch(P==3&&(f?P=2:P=1),P){case 2:break;case 1:W>1?W=Math.pow(W,.5):W*=.95;break;case 0:default:W>1?W=1:W*=.95;break}for(var y=0,L=0;L<b.sfbmax;L++){var O=b.width[L],B;if(y+=O,!(R[L]<W)){if(D.substep_shaping&2&&(D.pseudohalf[L]=D.pseudohalf[L]==0?1:0,D.pseudohalf[L]==0&&D.noise_shaping_amp==2))return;for(b.scalefac[L]++,B=-O;B<0;B++)V[y+B]*=l,V[y+B]>b.xrpow_max&&(b.xrpow_max=V[y+B]);if(D.noise_shaping_amp==2)return}}}function A(T,b){for(var R=1.2968395546510096,V=0,f=0;f<T.sfbmax;f++){var D=T.width[f],l=T.scalefac[f];if(T.preflag!=0&&(l+=t.pretab[f]),V+=D,l&1){l++;for(var W=-D;W<0;W++)b[V+W]*=R,b[V+W]>T.xrpow_max&&(T.xrpow_max=b[V+W])}T.scalefac[f]=l>>1}T.preflag=0,T.scalefac_scale=1}function C(T,b,R){var V,f=b.scalefac;for(V=0;V<b.sfb_lmax;V++)if(f[V]>=16)return!0;for(var D=0;D<3;D++){var l=0,W=0;for(V=b.sfb_lmax+D;V<b.sfbdivide;V+=3)l<f[V]&&(l=f[V]);for(;V<b.sfbmax;V+=3)W<f[V]&&(W=f[V]);if(!(l<16&&W<8)){if(b.subblock_gain[D]>=7)return!0;b.subblock_gain[D]++;var L=T.scalefac_band.l[b.sfb_lmax];for(V=b.sfb_lmax+D;V<b.sfbmax;V+=3){var P,y=b.width[V],O=f[V];if(ns(O>=0),O=O-(4>>b.scalefac_scale),O>=0){f[V]=O,L+=y*3;continue}f[V]=0;{var B=210+(O<<b.scalefac_scale+1);P=t.IPOW20(B)}L+=y*(D+1);for(var v=-y;v<0;v++)R[L+v]*=P,R[L+v]>b.xrpow_max&&(b.xrpow_max=R[L+v]);L+=y*(3-D-1)}{var P=t.IPOW20(202);L+=b.width[V]*(D+1);for(var v=-b.width[V];v<0;v++)R[L+v]*=P,R[L+v]>b.xrpow_max&&(b.xrpow_max=R[L+v])}}}return!1}function k(T,b,R,V,f){var D=T.internal_flags;E(T,b,R,V,f);var l=_(b);return l?!1:(D.mode_gr==2?l=i.scale_bitcount(b):l=i.scale_bitcount_lsf(D,b),l?(D.noise_shaping>1&&(io.fill(D.pseudohalf,0),b.scalefac_scale==0?(A(b,V),l=!1):b.block_type==zt.SHORT_TYPE&&D.subblock_gain>0&&(l=C(D,b,V)||_(b))),l||(D.mode_gr==2?l=i.scale_bitcount(b):l=i.scale_bitcount_lsf(D,b)),!l):!0)}this.outer_loop=function(T,b,R,V,f,D){var l=T.internal_flags,W=new Yd,L=Ao(576),P=Ao(jd.SFBMAX),y=new nh,O,B=new I2,v=9999999,H=!1,N=!1,te=0;if(c(l,b,D,f,V),l.noise_shaping==0)return 100;t.calc_noise(b,R,P,y,B),y.bits=b.part2_3_length,W.assign(b);var G=0;for(or.arraycopy(V,0,L,0,576);!H;){do{var se=new nh,M,F=255;if(l.substep_shaping&2?M=20:M=3,l.sfb21_extra&&(P[W.sfbmax]>1||W.block_type==zt.SHORT_TYPE&&(P[W.sfbmax+1]>1||P[W.sfbmax+2]>1))||!k(T,W,P,V,N))break;W.scalefac_scale!=0&&(F=254);var Z=D-W.part2_length;if(Z<=0)break;for(;(W.part2_3_length=i.count_bits(l,V,W,B))>Z&&W.global_gain<=F;)W.global_gain++;if(W.global_gain>F)break;if(y.over_count==0){for(;(W.part2_3_length=i.count_bits(l,V,W,B))>v&&W.global_gain<=F;)W.global_gain++;if(W.global_gain>F)break}if(t.calc_noise(W,R,P,se,B),se.bits=W.part2_3_length,b.block_type!=zt.SHORT_TYPE?O=T.quant_comp:O=T.quant_comp_short,O=S(O,y,se,W,P)?1:0,O!=0)v=b.part2_3_length,y=se,b.assign(W),G=0,or.arraycopy(V,0,L,0,576);else if(l.full_outer_loop==0&&(++G>M&&y.over_count==0||l.noise_shaping_amp==3&&N&&G>30||l.noise_shaping_amp==3&&N&&W.global_gain-te>15))break}while(W.global_gain+W.scalefac_scale<255);l.noise_shaping_amp==3?N?H=!0:(W.assign(b),or.arraycopy(L,0,V,0,576),G=0,te=W.global_gain,N=!0):H=!0}return ns(b.global_gain+b.scalefac_scale<=255),T.VBR==$d.vbr_rh||T.VBR==$d.vbr_mtrh?or.arraycopy(L,0,V,0,576):l.substep_shaping&1&&trancate_smallspectrums(l,b,R,V),y.over_count},this.iteration_finish_one=function(T,b,R){var V=T.l3_side,f=V.tt[b][R];i.best_scalefac_store(T,b,R,V),T.use_best_huffman==1&&i.best_huffman_divide(T,f),e.ResvAdjust(T,f)},this.VBR_encode_granule=function(T,b,R,V,f,D,l){var W=T.internal_flags,L=new Yd,P=Ao(576),y=l,O=l+1,B=(l+D)/2,v,H,N=0,te=W.sfb21_extra;ns(y<=LameInternalFlags.MAX_BITS_PER_CHANNEL),io.fill(L.l3_enc,0);do ns(B>=D),ns(B<=l),ns(D<=l),B>y-42?W.sfb21_extra=!1:W.sfb21_extra=te,H=outer_loop(T,b,R,V,f,B),H<=0?(N=1,O=b.part2_3_length,L.assign(b),or.arraycopy(V,0,P,0,576),l=O-32,v=l-D,B=(l+D)/2):(D=B+32,v=l-D,B=(l+D)/2,N!=0&&(N=2,b.assign(L),or.arraycopy(P,0,V,0,576)));while(v>12);W.sfb21_extra=te,N==2&&or.arraycopy(L.l3_enc,0,b.l3_enc,0,576),ns(b.part2_3_length<=y)},this.get_framebits=function(T,b){var R=T.internal_flags;R.bitrate_index=R.VBR_min_bitrate;var V=r.getframebits(T);R.bitrate_index=1,V=r.getframebits(T);for(var f=1;f<=R.VBR_max_bitrate;f++){R.bitrate_index=f;var D=new MeanBits(V);b[f]=e.ResvFrameBegin(T,D),V=D.bits}},this.VBR_old_prepare=function(T,b,R,V,f,D,l,W,L){var P=T.internal_flags,y,O=0,B=1,v=0;P.bitrate_index=P.VBR_max_bitrate;var H=e.ResvFrameBegin(T,new MeanBits(0))/P.mode_gr;get_framebits(T,D);for(var N=0;N<P.mode_gr;N++){var te=t.on_pe(T,b,W[N],H,N,0);P.mode_ext==zt.MPG_MD_MS_LR&&(ms_convert(P.l3_side,N),t.reduce_side(W[N],R[N],H,te));for(var G=0;G<P.channels_out;++G){var se=P.l3_side.tt[N][G];se.block_type!=zt.SHORT_TYPE?(O=1.28/(1+Math.exp(3.5-b[N][G]/300))-.05,y=P.PSY.mask_adjust-O):(O=2.56/(1+Math.exp(3.5-b[N][G]/300))-.14,y=P.PSY.mask_adjust_short-O),P.masking_lower=Math.pow(10,y*.1),init_outer_loop(P,se),L[N][G]=t.calc_xmin(T,V[N][G],se,f[N][G]),L[N][G]!=0&&(B=0),l[N][G]=126,v+=W[N][G]}}for(var N=0;N<P.mode_gr;N++)for(var G=0;G<P.channels_out;G++)v>D[P.VBR_max_bitrate]&&(W[N][G]*=D[P.VBR_max_bitrate],W[N][G]/=v),l[N][G]>W[N][G]&&(l[N][G]=W[N][G]);return B},this.bitpressure_strategy=function(T,b,R,V){for(var f=0;f<T.mode_gr;f++)for(var D=0;D<T.channels_out;D++){for(var l=T.l3_side.tt[f][D],W=b[f][D],L=0,P=0;P<l.psy_lmax;P++)W[L++]*=1+.029*P*P/zt.SBMAX_l/zt.SBMAX_l;if(l.block_type==zt.SHORT_TYPE)for(var P=l.sfb_smin;P<zt.SBMAX_s;P++)W[L++]*=1+.029*P*P/zt.SBMAX_s/zt.SBMAX_s,W[L++]*=1+.029*P*P/zt.SBMAX_s/zt.SBMAX_s,W[L++]*=1+.029*P*P/zt.SBMAX_s/zt.SBMAX_s;V[f][D]=0|Math.max(R[f][D],.9*V[f][D])}},this.VBR_new_prepare=function(T,b,R,V,f,D){var l=T.internal_flags,W=1,L=0,P=0,y;if(T.free_format){l.bitrate_index=0;var O=new MeanBits(L);y=e.ResvFrameBegin(T,O),L=O.bits,f[0]=y}else{l.bitrate_index=l.VBR_max_bitrate;var O=new MeanBits(L);e.ResvFrameBegin(T,O),L=O.bits,get_framebits(T,f),y=f[l.VBR_max_bitrate]}for(var B=0;B<l.mode_gr;B++){t.on_pe(T,b,D[B],L,B,0),l.mode_ext==zt.MPG_MD_MS_LR&&ms_convert(l.l3_side,B);for(var v=0;v<l.channels_out;++v){var H=l.l3_side.tt[B][v];l.masking_lower=Math.pow(10,l.PSY.mask_adjust*.1),init_outer_loop(l,H),t.calc_xmin(T,R[B][v],H,V[B][v])!=0&&(W=0),P+=D[B][v]}}for(var B=0;B<l.mode_gr;B++)for(var v=0;v<l.channels_out;v++)P>y&&(D[B][v]*=y,D[B][v]/=P);return W},this.calc_target_bits=function(T,b,R,V,f,D){var l=T.internal_flags,W=l.l3_side,L,P,y,O,B=0;l.bitrate_index=l.VBR_max_bitrate;var v=new MeanBits(B);for(D[0]=e.ResvFrameBegin(T,v),B=v.bits,l.bitrate_index=1,B=r.getframebits(T)-l.sideinfo_len*8,f[0]=B/(l.mode_gr*l.channels_out),B=T.VBR_mean_bitrate_kbps*T.framesize*1e3,l.substep_shaping&1&&(B*=1.09),B/=T.out_samplerate,B-=l.sideinfo_len*8,B/=l.mode_gr*l.channels_out,L=.93+.07*(11-T.compression_ratio)/(11-5.5),L<.9&&(L=.9),L>1&&(L=1),P=0;P<l.mode_gr;P++){var H=0;for(y=0;y<l.channels_out;y++){if(V[P][y]=int(L*B),b[P][y]>700){var N=int((b[P][y]-700)/1.4),te=W.tt[P][y];V[P][y]=int(L*B),te.block_type==zt.SHORT_TYPE&&N<B/2&&(N=B/2),N>B*3/2?N=B*3/2:N<0&&(N=0),V[P][y]+=N}V[P][y]>LameInternalFlags.MAX_BITS_PER_CHANNEL&&(V[P][y]=LameInternalFlags.MAX_BITS_PER_CHANNEL),H+=V[P][y]}if(H>LameInternalFlags.MAX_BITS_PER_GRANULE)for(y=0;y<l.channels_out;++y)V[P][y]*=LameInternalFlags.MAX_BITS_PER_GRANULE,V[P][y]/=H}if(l.mode_ext==zt.MPG_MD_MS_LR)for(P=0;P<l.mode_gr;P++)t.reduce_side(V[P],R[P],B*l.channels_out,LameInternalFlags.MAX_BITS_PER_GRANULE);for(O=0,P=0;P<l.mode_gr;P++)for(y=0;y<l.channels_out;y++)V[P][y]>LameInternalFlags.MAX_BITS_PER_CHANNEL&&(V[P][y]=LameInternalFlags.MAX_BITS_PER_CHANNEL),O+=V[P][y];if(O>D[0])for(P=0;P<l.mode_gr;P++)for(y=0;y<l.channels_out;y++)V[P][y]*=D[0],V[P][y]/=O}}var R2=A2,L2=fn,Sa=L2.assert;function N2(){var r;this.setModules=function(e){r=e},this.ResvFrameBegin=function(e,t){var n=e.internal_flags,i,s=n.l3_side,h=r.getframebits(e);t.bits=(h-n.sideinfo_len*8)/n.mode_gr;var d=8*256*n.mode_gr-8;e.brate>320?i=8*int(e.brate*1e3/(e.out_samplerate/1152)/8+.5):(i=8*1440,e.strict_ISO&&(i=8*int(32e4/(e.out_samplerate/1152)/8+.5))),n.ResvMax=i-h,n.ResvMax>d&&(n.ResvMax=d),(n.ResvMax<0||e.disable_reservoir)&&(n.ResvMax=0);var c=t.bits*n.mode_gr+Math.min(n.ResvSize,n.ResvMax);return c>i&&(c=i),Sa(n.ResvMax%8==0),Sa(n.ResvMax>=0),s.resvDrain_pre=0,n.pinfo!=null&&(n.pinfo.mean_bits=t.bits/2,n.pinfo.resvsize=n.ResvSize),c},this.ResvMaxBits=function(e,t,n,i){var s=e.internal_flags,h,d=s.ResvSize,c=s.ResvMax;i!=0&&(d+=t),s.substep_shaping&1&&(c*=.9),n.bits=t,d*10>c*9?(h=d-c*9/10,n.bits+=h,s.substep_shaping|=128):(h=0,s.substep_shaping&=127,!e.disable_reservoir&&!(s.substep_shaping&1)&&(n.bits-=.1*t));var _=d<s.ResvMax*6/10?d:s.ResvMax*6/10;return _-=h,_<0&&(_=0),_},this.ResvAdjust=function(e,t){e.ResvSize-=t.part2_3_length+t.part2_length},this.ResvFrameEnd=function(e,t){var n,i=e.l3_side;e.ResvSize+=t*e.mode_gr;var s=0;i.resvDrain_post=0,i.resvDrain_pre=0,(n=e.ResvSize%8)!=0&&(s+=n),n=e.ResvSize-s-e.ResvMax,n>0&&(Sa(n%8==0),Sa(n>=0),s+=n);{var h=Math.min(i.main_data_begin*8,s)/8;i.resvDrain_pre+=8*h,s-=8*h,e.ResvSize-=8*h,i.main_data_begin-=h}i.resvDrain_post+=s,e.ResvSize-=s}}var D2=N2;function F2(){var r="http://www.mp3dev.org/",e=3,t=98,n=4,i=0,s=93;this.getLameVersion=function(){return e+"."+t+"."+n},this.getLameShortVersion=function(){return e+"."+t+"."+n},this.getLameVeryShortVersion=function(){return"LAME"+e+"."+t+"r"},this.getPsyVersion=function(){return i+"."+s},this.getLameUrl=function(){return r},this.getLameOsBitness=function(){return"32bits"}}var O2=F2,Fi=fn,H2=Fi.System,ih=Fi.VbrMode;Fi.Float;var Kd=Fi.ShortBlock;Fi.Util;var V2=Fi.Arrays;Fi.new_array_n;var Ca=Fi.new_byte;Fi.new_double;Fi.new_float;Fi.new_float_n;Fi.new_int;Fi.new_int_n;var W2=Fi.assert;$o.NUMTOCENTRIES=100;$o.MAXFRAMESIZE=2880;function $o(){var r,e,t;this.setModules=function(B,v,H){r=B,e=v,t=H};var n=1,i=2,s=4,h=8,d=$o.NUMTOCENTRIES,c=$o.MAXFRAMESIZE,_=d+4+4+4+4+4,m=_+9+1+1+8+1+1+3+1+1+2+4+2+2,g=128,S=64,E=32,A=null,C="Xing",k="Info",T=[0,49345,49537,320,49921,960,640,49729,50689,1728,1920,51009,1280,50625,50305,1088,52225,3264,3456,52545,3840,53185,52865,3648,2560,51905,52097,2880,51457,2496,2176,51265,55297,6336,6528,55617,6912,56257,55937,6720,7680,57025,57217,8e3,56577,7616,7296,56385,5120,54465,54657,5440,55041,6080,5760,54849,53761,4800,4992,54081,4352,53697,53377,4160,61441,12480,12672,61761,13056,62401,62081,12864,13824,63169,63361,14144,62721,13760,13440,62529,15360,64705,64897,15680,65281,16320,16e3,65089,64001,15040,15232,64321,14592,63937,63617,14400,10240,59585,59777,10560,60161,11200,10880,59969,60929,11968,12160,61249,11520,60865,60545,11328,58369,9408,9600,58689,9984,59329,59009,9792,8704,58049,58241,9024,57601,8640,8320,57409,40961,24768,24960,41281,25344,41921,41601,25152,26112,42689,42881,26432,42241,26048,25728,42049,27648,44225,44417,27968,44801,28608,28288,44609,43521,27328,27520,43841,26880,43457,43137,26688,30720,47297,47489,31040,47873,31680,31360,47681,48641,32448,32640,48961,32e3,48577,48257,31808,46081,29888,30080,46401,30464,47041,46721,30272,29184,45761,45953,29504,45313,29120,28800,45121,20480,37057,37249,20800,37633,21440,21120,37441,38401,22208,22400,38721,21760,38337,38017,21568,39937,23744,23936,40257,24320,40897,40577,24128,23040,39617,39809,23360,39169,22976,22656,38977,34817,18624,18816,35137,19200,35777,35457,19008,19968,36545,36737,20288,36097,19904,19584,35905,17408,33985,34177,17728,34561,18368,18048,34369,33281,17088,17280,33601,16640,33217,32897,16448];function b(B,v){if(B.nVbrNumFrames++,B.sum+=v,B.seen++,!(B.seen<B.want)&&(B.pos<B.size&&(B.bag[B.pos]=B.sum,B.pos++,B.seen=0),B.pos==B.size)){for(var H=1;H<B.size;H+=2)B.bag[H/2]=B.bag[H];B.want*=2,B.pos/=2}}function R(B,v){if(!(B.pos<=0))for(var H=1;H<d;++H){var N=H/d,te,G,se=0|Math.floor(N*B.pos);se>B.pos-1&&(se=B.pos-1),te=B.bag[se],G=B.sum;var M=0|256*te/G;M>255&&(M=255),v[H]=255&M}}this.addVbrFrame=function(B){var v=B.internal_flags,H=Tables.bitrate_table[B.version][v.bitrate_index];W2(v.VBR_seek_table.bag!=null),b(v.VBR_seek_table,H)};function V(B,v){var H=B[v+0]&255;return H<<=8,H|=B[v+1]&255,H<<=8,H|=B[v+2]&255,H<<=8,H|=B[v+3]&255,H}function f(B,v,H){B[v+0]=255&(H>>24&255),B[v+1]=255&(H>>16&255),B[v+2]=255&(H>>8&255),B[v+3]=255&(H&255)}function D(B,v,H){B[v+0]=255&(H>>8&255),B[v+1]=255&(H&255)}function l(B,v){return new String(B,v,C.length(),A).equals(C)||new String(B,v,k.length(),A).equals(k)}function W(B,v,H){return 255&(B<<v|H&~(-1<<v))}function L(B,v){var H=B.internal_flags;v[0]=W(v[0],8,255),v[1]=W(v[1],3,7),v[1]=W(v[1],1,B.out_samplerate<16e3?0:1),v[1]=W(v[1],1,B.version),v[1]=W(v[1],2,1),v[1]=W(v[1],1,B.error_protection?0:1),v[2]=W(v[2],4,H.bitrate_index),v[2]=W(v[2],2,H.samplerate_index),v[2]=W(v[2],1,0),v[2]=W(v[2],1,B.extension),v[3]=W(v[3],2,B.mode.ordinal()),v[3]=W(v[3],2,H.mode_ext),v[3]=W(v[3],1,B.copyright),v[3]=W(v[3],1,B.original),v[3]=W(v[3],2,B.emphasis),v[0]=255;var N=255&(v[1]&241),te;B.version==1?te=g:B.out_samplerate<16e3?te=E:te=S,B.VBR==ih.vbr_off&&(te=B.brate);var G;B.free_format?G=0:G=255&16*r.BitrateIndex(te,B.version,B.out_samplerate),B.version==1?(v[1]=255&(N|10),N=255&(v[2]&13),v[2]=255&(G|N)):(v[1]=255&(N|2),N=255&(v[2]&13),v[2]=255&(G|N))}this.getVbrTag=function(B){var v=new VBRTagData,H=0;v.flags=0;var N=B[H+1]>>3&1,te=B[H+2]>>2&3,G=B[H+3]>>6&3,se=B[H+2]>>4&15;if(se=Tables.bitrate_table[N][se],B[H+1]>>4==14?v.samprate=Tables.samplerate_table[2][te]:v.samprate=Tables.samplerate_table[N][te],N!=0?G!=3?H+=36:H+=21:G!=3?H+=21:H+=13,!l(B,H))return null;H+=4,v.hId=N;var M=v.flags=V(B,H);if(H+=4,M&n&&(v.frames=V(B,H),H+=4),M&i&&(v.bytes=V(B,H),H+=4),M&s){if(v.toc!=null)for(var F=0;F<d;F++)v.toc[F]=B[H+F];H+=d}v.vbrScale=-1,M&h&&(v.vbrScale=V(B,H),H+=4),v.headersize=(N+1)*72e3*se/v.samprate,H+=21;var Z=B[H+0]<<4;Z+=B[H+1]>>4;var ee=(B[H+1]&15)<<8;return ee+=B[H+2]&255,(Z<0||Z>3e3)&&(Z=-1),(ee<0||ee>3e3)&&(ee=-1),v.encDelay=Z,v.encPadding=ee,v},this.InitVbrTag=function(B){var v=B.internal_flags,H;B.version==1?H=g:B.out_samplerate<16e3?H=E:H=S,B.VBR==ih.vbr_off&&(H=B.brate);var N=(B.version+1)*72e3*H/B.out_samplerate,te=v.sideinfo_len+m;if(v.VBR_seek_table.TotalFrameSize=N,N<te||N>c){B.bWriteVbrTag=!1;return}v.VBR_seek_table.nVbrNumFrames=0,v.VBR_seek_table.nBytesWritten=0,v.VBR_seek_table.sum=0,v.VBR_seek_table.seen=0,v.VBR_seek_table.want=1,v.VBR_seek_table.pos=0,v.VBR_seek_table.bag==null&&(v.VBR_seek_table.bag=new int[400],v.VBR_seek_table.size=400);var G=Ca(c);L(B,G);for(var se=v.VBR_seek_table.TotalFrameSize,M=0;M<se;++M)e.add_dummy_byte(B,G[M]&255,1)};function P(B,v){var H=v^B;return v=v>>8^T[H&255],v}this.updateMusicCRC=function(B,v,H,N){for(var te=0;te<N;++te)B[0]=P(v[H+te],B[0])};function y(B,v,H,N,te){var G=B.internal_flags,se=0,M=B.encoder_delay,F=B.encoder_padding,Z=100-10*B.VBR_q-B.quality,ee=t.getLameVeryShortVersion(),ue,Pe=0,_e,ke=[1,5,3,2,4,0,3],Ne=0|(B.lowpassfreq/100+.5>255?255:B.lowpassfreq/100+.5),Be=0,pe=0,Oe=0,nt=B.internal_flags.noise_shaping,Ve=0,ot=0,Ge=0,lt=0,dt=0,St=(B.exp_nspsytune&1)!=0,Mt=(B.exp_nspsytune&2)!=0,Tt=!1,Ct=!1,kt=B.internal_flags.nogap_total,bt=B.internal_flags.nogap_current,Pt=B.ATHtype,Xe=0,vt;switch(B.VBR){case vbr_abr:vt=B.VBR_mean_bitrate_kbps;break;case vbr_off:vt=B.brate;break;default:vt=B.VBR_min_bitrate_kbps}switch(B.VBR.ordinal()<ke.length?ue=ke[B.VBR.ordinal()]:ue=0,_e=16*Pe+ue,G.findReplayGain&&(G.RadioGain>510&&(G.RadioGain=510),G.RadioGain<-510&&(G.RadioGain=-510),pe=8192,pe|=3072,G.RadioGain>=0?pe|=G.RadioGain:(pe|=512,pe|=-G.RadioGain)),G.findPeakSample&&(Be=Math.abs(0|G.PeakSample/32767*Math.pow(2,23)+.5)),kt!=-1&&(bt>0&&(Ct=!0),bt<kt-1&&(Tt=!0)),Xe=Pt+((St?1:0)<<4)+((Mt?1:0)<<5)+((Tt?1:0)<<6)+((Ct?1:0)<<7),Z<0&&(Z=0),B.mode){case MONO:Ve=0;break;case STEREO:Ve=1;break;case DUAL_CHANNEL:Ve=2;break;case JOINT_STEREO:B.force_ms?Ve=4:Ve=3;break;case NOT_SET:default:Ve=7;break}B.in_samplerate<=32e3?Ge=0:B.in_samplerate==48e3?Ge=2:B.in_samplerate>48e3?Ge=3:Ge=1,(B.short_blocks==Kd.short_block_forced||B.short_blocks==Kd.short_block_dispensed||B.lowpassfreq==-1&&B.highpassfreq==-1||B.scale_left<B.scale_right||B.scale_left>B.scale_right||B.disable_reservoir&&B.brate<320||B.noATH||B.ATHonly||Pt==0||B.in_samplerate<=32e3)&&(ot=1),lt=nt+(Ve<<2)+(ot<<5)+(Ge<<6),dt=G.nMusicCRC,f(H,N+se,Z),se+=4;for(var Et=0;Et<9;Et++)H[N+se+Et]=255&ee.charAt(Et);se+=9,H[N+se]=255&_e,se++,H[N+se]=255&Ne,se++,f(H,N+se,Be),se+=4,D(H,N+se,pe),se+=2,D(H,N+se,Oe),se+=2,H[N+se]=255&Xe,se++,vt>=255?H[N+se]=255:H[N+se]=255&vt,se++,H[N+se]=255&M>>4,H[N+se+1]=255&(M<<4)+(F>>8),H[N+se+2]=255&F,se+=3,H[N+se]=255&lt,se++,H[N+se++]=0,D(H,N+se,B.preset),se+=2,f(H,N+se,v),se+=4,D(H,N+se,dt),se+=2;for(var Sn=0;Sn<se;Sn++)te=P(H[N+Sn],te);return D(H,N+se,te),se+=2,se}function O(B){B.seek(0);var v=Ca(10);B.readFully(v);var H;return new String(v,"ISO-8859-1").startsWith("ID3")?H=0:H=((v[6]&127)<<21|(v[7]&127)<<14|(v[8]&127)<<7|v[9]&127)+v.length,H}this.getLameTagFrame=function(B,v){var H=B.internal_flags;if(!B.bWriteVbrTag||H.Class_ID!=Lame.LAME_ID||H.VBR_seek_table.pos<=0)return 0;if(v.length<H.VBR_seek_table.TotalFrameSize)return H.VBR_seek_table.TotalFrameSize;V2.fill(v,0,H.VBR_seek_table.TotalFrameSize,0),L(B,v);var N=Ca(d);if(B.free_format)for(var te=1;te<d;++te)N[te]=255&255*te/100;else R(H.VBR_seek_table,N);var G=H.sideinfo_len;B.error_protection&&(G-=2),B.VBR==ih.vbr_off?(v[G++]=255&k.charAt(0),v[G++]=255&k.charAt(1),v[G++]=255&k.charAt(2),v[G++]=255&k.charAt(3)):(v[G++]=255&C.charAt(0),v[G++]=255&C.charAt(1),v[G++]=255&C.charAt(2),v[G++]=255&C.charAt(3)),f(v,G,n+i+s+h),G+=4,f(v,G,H.VBR_seek_table.nVbrNumFrames),G+=4;var se=H.VBR_seek_table.nBytesWritten+H.VBR_seek_table.TotalFrameSize;f(v,G,0|se),G+=4,H2.arraycopy(N,0,v,G,N.length),G+=N.length,B.error_protection&&e.CRC_writeheader(H,v);for(var M=0,te=0;te<G;te++)M=P(v[te],M);return G+=y(B,se,v,G,M),H.VBR_seek_table.TotalFrameSize},this.putVbrTag=function(B,v){var H=B.internal_flags;if(H.VBR_seek_table.pos<=0||(v.seek(v.length()),v.length()==0))return-1;var N=O(v);v.seek(N);var te=Ca(c),G=getLameTagFrame(B,te);return G>te.length?-1:(G<1||v.write(te,0,G),0)}}var q2=$o,Oi=fn;Oi.System;Oi.VbrMode;Oi.Float;Oi.ShortBlock;Oi.Util;Oi.Arrays;Oi.new_array_n;var Gd=Oi.new_byte;Oi.new_double;Oi.new_float;Oi.new_float_n;Oi.new_int;Oi.new_int_n;var Zd=Oi.assert,U2=y2,z2=x2,X2=y0,$2=x0,Y2=R2,j2=S0,K2=D2,G2=g0,Z2=C0;Qn();var Q2=O2,J2=q2;function ev(){this.setModules=function(r,e){}}function tv(){this.setModules=function(r,e,t){}}function nv(){}function iv(){this.setModules=function(r,e){}}function sv(r,e,t){arguments.length!=3&&(console.error("WARN: Mp3Encoder(channels, samplerate, kbps) not specified"),r=1,e=44100,t=128);var n=new U2,i=new ev,s=new X2,h=new Z2,d=new z2,c=new $2,_=new Y2,m=new J2,g=new Q2,S=new iv,E=new K2,A=new j2,C=new tv,k=new nv;n.setModules(s,h,d,c,_,m,g,S,k),h.setModules(s,k,g,m),S.setModules(h,g),d.setModules(n),_.setModules(h,E,c,A),c.setModules(A,E,n.enc.psy),E.setModules(h),A.setModules(c),m.setModules(n,h,g),i.setModules(C,k),C.setModules(g,S,d);var T=n.lame_init();T.num_channels=r,T.in_samplerate=e,T.brate=t,T.mode=G2.STEREO,T.quality=3,T.bWriteVbrTag=!1,T.disable_reservoir=!0,T.write_id3tag_automatic=!1;var b=n.lame_init_params(T);Zd(b==0);var R=1152,V=0|1.25*R+7200,f=Gd(V);this.encodeBuffer=function(D,l){r==1&&(l=D),Zd(D.length==l.length),D.length>R&&(R=D.length,V=0|1.25*R+7200,f=Gd(V));var W=n.lame_encode_buffer(T,D,l,D.length,f,0,V);return new Int8Array(f.subarray(0,W))},this.flush=function(){var D=n.lame_encode_flush(T,f,0,V);return new Int8Array(f.subarray(0,D))}}function ps(){this.dataOffset=0,this.dataLen=0,this.channels=0,this.sampleRate=0}function tl(r){return r.charCodeAt(0)<<24|r.charCodeAt(1)<<16|r.charCodeAt(2)<<8|r.charCodeAt(3)}ps.RIFF=tl("RIFF");ps.WAVE=tl("WAVE");ps.fmt_=tl("fmt ");ps.data=tl("data");ps.readHeader=function(r){var e=new ps,t=r.getUint32(0,!1);if(ps.RIFF==t&&(r.getUint32(4,!0),ps.WAVE==r.getUint32(8,!1)&&ps.fmt_==r.getUint32(12,!1))){var n=r.getUint32(16,!0),i=20;switch(n){case 16:case 18:e.channels=r.getUint16(i+2,!0),e.sampleRate=r.getUint32(i+4,!0);break;default:throw"extended fmt chunk not implemented"}i+=n;for(var s=ps.data,h=0;s!=t&&(t=r.getUint32(i,!1),h=r.getUint32(i+4,!0),s!=t);)i+=h+8;return e.dataLen=h,e.dataOffset=i+8,e}};Lh.Mp3Encoder=sv;Lh.WavHeader=ps;const{button:Qd,div:Nn,h2:rv,input:ka,select:ov,option:Jd}=Ke;function av(r,e){if(navigator.msSaveOrOpenBlob){navigator.msSaveOrOpenBlob(r,e);return}const t=document.createElement("a");if(t.download!=null){const n=URL.createObjectURL(r);setTimeout(function(){URL.revokeObjectURL(n)},6e4),t.href=n,t.download=e,setTimeout(function(){t.dispatchEvent(new MouseEvent("click"))},0)}else{const n=URL.createObjectURL(r);setTimeout(function(){URL.revokeObjectURL(n)},6e4),window.open(n,"_blank")||(window.location.href=n)}}class Hr{constructor(e){a(this,"synth",null);a(this,"thenExportTo","");a(this,"recordedSamplesL",new Float32Array);a(this,"recordedSamplesR",new Float32Array);a(this,"sampleFrames",0);a(this,"totalChunks",0);a(this,"currentChunk",0);a(this,"outputStarted",!1);a(this,"cachedMutes",{});a(this,"_fileName",ka({type:"text",style:"width: 10em;",value:"BeepBox-Song",maxlength:250,autofocus:"autofocus"}));a(this,"_computedSamplesLabel",Nn({style:"width: 10em;"},new Text("0:00")));a(this,"_enableIntro",ka({type:"checkbox"}));a(this,"_loopDropDown",ka({style:"width: 2em;",type:"number",min:"1",max:"4",step:"1"}));a(this,"_enableOutro",ka({type:"checkbox"}));a(this,"_formatSelect",ov({style:"width: 100%;"},Jd({value:"wav"},"Export to .wav file."),Jd({value:"mp3"},"Export to .mp3 file.")));a(this,"_cancelButton",Qd({class:"cancelButton"}));a(this,"_exportButton",Qd({class:"exportButton",style:"width:45%;"},"Export"));a(this,"_outputProgressBar",Nn({style:`width: 0%; background: ${Q.loopAccent}; height: 100%; position: absolute; z-index: 2;`}));a(this,"_outputProgressLabel",Nn({style:"position: relative; top: -1px; z-index: 3;"},"0%"));a(this,"_outputProgressContainer",Nn({style:`height: 12px; background: ${Q.uiWidgetBackground}; display: block; position: relative; z-index: 1;`},this._outputProgressBar,this._outputProgressLabel));a(this,"container",Nn({class:"prompt noSelection",style:"width: 200px;"},rv("Export Stems"),Nn({style:"display: flex; flex-direction: row; align-items: center; justify-content: space-between;"},"File name:",this._fileName),Nn({style:"display: flex; flex-direction: row; align-items: center; justify-content: space-between;"},"Length:",this._computedSamplesLabel),Nn({style:"display: table; width: 100%;"},Nn({style:"display: table-row;"},Nn({style:"display: table-cell;"},"Intro:"),Nn({style:"display: table-cell;"},"Loop Count:"),Nn({style:"display: table-cell;"},"Outro:")),Nn({style:"display: table-row;"},Nn({style:"display: table-cell; vertical-align: middle;"},this._enableIntro),Nn({style:"display: table-cell; vertical-align: middle;"},this._loopDropDown),Nn({style:"display: table-cell; vertical-align: middle;"},this._enableOutro))),Nn({class:"selectContainer",style:"width: 100%;"},this._formatSelect),Nn({style:"text-align: left;"},"Exporting can be slow. Reloading the page or clicking the X will cancel it. Please be patient."),this._outputProgressContainer,Nn({style:"display: flex; flex-direction: row-reverse; justify-content: space-between;"},this._exportButton),this._cancelButton));a(this,"_close",()=>{this.synth!=null&&(this.synth.renderingSong=!1),this.outputStarted=!1,this._doc.undo()});a(this,"cleanUp",()=>{this._fileName.removeEventListener("input",Hr._validateFileName),this._loopDropDown.removeEventListener("blur",Hr._validateNumber),this._exportButton.removeEventListener("click",this._export),this._cancelButton.removeEventListener("click",this._close),this.container.removeEventListener("keydown",this._whenKeyPressed)});a(this,"_whenKeyPressed",e=>{e.target.tagName!="BUTTON"&&e.keyCode==13&&this._export()});a(this,"_export",()=>{if(this.outputStarted!=!0)switch(window.localStorage.setItem("exportFormat",this._formatSelect.value),this._formatSelect.value){case"wav":this.outputStarted=!0,this._exportTo("wav");break;case"mp3":this.outputStarted=!0,this._exportTo("mp3");break;default:throw new Error("Unhandled file export type.")}});this._doc=e,this._loopDropDown.value="1",this._doc.song.loopStart==0?(this._enableIntro.checked=!1,this._enableIntro.disabled=!0):(this._enableIntro.checked=!0,this._enableIntro.disabled=!1),this._doc.song.loopStart+this._doc.song.loopLength==this._doc.song.barCount?(this._enableOutro.checked=!1,this._enableOutro.disabled=!0):(this._enableOutro.checked=!0,this._enableOutro.disabled=!1);const t=window.localStorage.getItem("exportFormat");t!=null&&(this._formatSelect.value=t),this._fileName.select(),setTimeout(()=>this._fileName.focus()),this._fileName.addEventListener("input",Hr._validateFileName),this._loopDropDown.addEventListener("blur",Hr._validateNumber),this._exportButton.addEventListener("click",this._export),this._cancelButton.addEventListener("click",this._close),this._enableOutro.addEventListener("click",()=>{this._computedSamplesLabel.firstChild.textContent=this.samplesToTime(this._doc.synth.getTotalSamples(this._enableIntro.checked,this._enableOutro.checked,+this._loopDropDown.value-1))}),this._enableIntro.addEventListener("click",()=>{this._computedSamplesLabel.firstChild.textContent=this.samplesToTime(this._doc.synth.getTotalSamples(this._enableIntro.checked,this._enableOutro.checked,+this._loopDropDown.value-1))}),this._loopDropDown.addEventListener("change",()=>{this._computedSamplesLabel.firstChild.textContent=this.samplesToTime(this._doc.synth.getTotalSamples(this._enableIntro.checked,this._enableOutro.checked,+this._loopDropDown.value-1))}),this.container.addEventListener("keydown",this._whenKeyPressed),this._fileName.value=e.song.title,Hr._validateFileName(null,this._fileName),this._computedSamplesLabel.firstChild.textContent=this.samplesToTime(this._doc.synth.getTotalSamples(this._enableIntro.checked,this._enableOutro.checked,+this._loopDropDown.value-1))}samplesToTime(e){const t=Math.round(e/this._doc.synth.samplesPerSecond),n=t%60;return Math.floor(t/60)+":"+(n<10?"0":"")+n}changeFileName(e){this._fileName.value=e}static _validateFileName(e,t){let n;if(e!=null)n=e.target;else if(t!=null)n=t;else return;const i=/[\+\*\$\?\|\{\}\\\/<>#%!`&'"=:@]/gi;if(i.test(n.value)){let s=n.selectionStart;n.value=n.value.replace(i,""),s--,n.setSelectionRange(s,s)}}static _validateNumber(e){const t=e.target;t.value=Math.floor(Math.max(Number(t.min),Math.min(Number(t.max),Number(t.value))))+""}async _synthesize(){if(this.outputStarted==!1||this.synth==null)return!0;const e=this.synth.samplesPerSecond*5,t=this.currentChunk*e,n=Math.min(e,this.sampleFrames-t),i=new Float32Array(n),s=new Float32Array(n);return this.synth.renderingSong=!0,this.synth.synthesize(i,s,n),this.recordedSamplesL.set(i,t),this.recordedSamplesR.set(s,t),this._outputProgressBar.style.setProperty("width",Math.round((this.currentChunk+1)/this.totalChunks*100)+"%"),this._outputProgressLabel.innerText=Math.round((this.currentChunk+1)/this.totalChunks*100)+"%",this.currentChunk++,this.currentChunk>=this.totalChunks?(this.synth.renderingSong=!1,!0):!1}async _exportTo(e){this.thenExportTo=e,this.cachedMutes={},this._doc.song.patternInstruments;for(let c=0;c<this._doc.song.channels.length;c++)this.cachedMutes[c]=this._doc.song.channels[c].muted,this._doc.song.channels[c].muted=!0;this._outputProgressBar.style.setProperty("width","0%"),this._outputProgressLabel.innerText="0%";const t=new TransformStream,n=new Response(t.readable).blob(),i=new ng(t.writable);let s={};for(let c=0;c<this._doc.song.channels.length;c++){if(this._doc.song.channels[c].muted=!1,this.currentChunk=0,this.synth=new ms(this._doc.song),e=="wav")this.synth.samplesPerSecond=48e3;else if(e=="mp3")this.synth.samplesPerSecond=44100;else throw new Error("Unrecognized file export type chosen!");if(this.synth.loopRepeatCount=Number(this._loopDropDown.value)-1,!this._enableIntro.checked)for(let m=0;m<this._doc.song.loopStart;m++)this.synth.goToNextBar();for(this.synth.computeLatestModValues(),this.synth.warmUpSynthesizer(this._doc.song),this.sampleFrames=this.synth.getTotalSamples(this._enableIntro.checked,this._enableOutro.checked,this.synth.loopRepeatCount),this.totalChunks=Math.ceil(this.sampleFrames/(this.synth.samplesPerSecond*5)),this.recordedSamplesL=new Float32Array(this.sampleFrames),this.recordedSamplesR=new Float32Array(this.sampleFrames);!await this._synthesize(););this._outputProgressLabel.innerText="Encoding...";let _=null;if(this.thenExportTo=="wav")_=await this._exportToWavFinish();else if(this.thenExportTo=="mp3")_=await this._exportToMp3Finish();else throw new Error("Unrecognized file export type chosen!");if(_!=null){let m=`channel-${c}.${this.thenExportTo}`;s[m]=_}this._doc.song.channels[c].muted=!0}for(let c=0;c<this._doc.song.channels.length;c++)this._doc.song.channels[c].muted=this.cachedMutes[c];let h=Object.keys(s);for(let c=0;c<h.length;c++)await i.add(h[c],s[h[c]].stream());await i.close();let d=await n;av(d,this._fileName.value+".zip"),this._close()}async _exportToWavFinish(){var S;const e=this.recordedSamplesL.length,t=((S=this.synth)==null?void 0:S.samplesPerSecond)??0,n=2,i=2,s=8*i,h=n*e,d=44+h*i;let c=0;const _=new ArrayBuffer(d),m=new DataView(_);m.setUint32(c,1380533830,!1),c+=4,m.setUint32(c,36+h*i,!0),c+=4,m.setUint32(c,1463899717,!1),c+=4,m.setUint32(c,1718449184,!1),c+=4,m.setUint32(c,16,!0),c+=4,m.setUint16(c,1,!0),c+=2,m.setUint16(c,n,!0),c+=2,m.setUint32(c,t,!0),c+=4,m.setUint32(c,t*i*n,!0),c+=4,m.setUint16(c,i*n,!0),c+=2,m.setUint16(c,s,!0),c+=2,m.setUint32(c,1684108385,!1),c+=4,m.setUint32(c,h*i,!0),c+=4;{const E=(1<<s-1)-1;for(let A=0;A<e;A++){let C=Math.floor(Math.max(-1,Math.min(1,this.recordedSamplesL[A]))*E),k=Math.floor(Math.max(-1,Math.min(1,this.recordedSamplesR[A]))*E);m.setInt16(c,C,!0),c+=2,m.setInt16(c,k,!0),c+=2}}return new Blob([_],{type:"audio/wav"})}async _exportToMp3Finish(){var g;const i=new Lh.Mp3Encoder(2,((g=this.synth)==null?void 0:g.samplesPerSecond)??0,192),s=[],h=new Int16Array(this.recordedSamplesL.length),d=new Int16Array(this.recordedSamplesR.length),c=32767;for(let S=0;S<this.recordedSamplesL.length;S++)h[S]=Math.floor(Math.max(-1,Math.min(1,this.recordedSamplesL[S]))*c),d[S]=Math.floor(Math.max(-1,Math.min(1,this.recordedSamplesR[S]))*c);for(let S=0;S<h.length;S+=1152){const E=h.subarray(S,S+1152),A=d.subarray(S,S+1152),C=i.encodeBuffer(E,A);C.length>0&&s.push(C)}const _=i.flush();return _.length>0&&s.push(_),new Blob(s,{type:"audio/mp3"})}}const{button:rn,div:ye,input:Ft,select:an,span:st,optgroup:No,option:Qe,canvas:lv}=Ke;function Mn(r,e){for(let t=0;t<e.length;t++)r.appendChild(Qe({value:t},e[t]));return r}function hv(r,e,t){e.appendChild(Qe({selected:!0,disabled:!0,value:r},r));for(const n of t)e.appendChild(Qe({value:n},n));return e}function eu(r,e){const t=an({id:e});r?(t.appendChild(Qe({value:je.noise},Lt.valueToPreset(je.noise).name)),t.appendChild(Qe({value:je.spectrum},Lt.valueToPreset(je.spectrum).name)),t.appendChild(Qe({value:je.drumset},Lt.valueToPreset(je.drumset).name))):(t.appendChild(Qe({value:je.chip},Lt.valueToPreset(je.chip).name)),t.appendChild(Qe({value:je.pwm},Lt.valueToPreset(je.pwm).name)),t.appendChild(Qe({value:je.harmonics},Lt.valueToPreset(je.harmonics).name)),t.appendChild(Qe({value:je.pickedString},Lt.valueToPreset(je.pickedString).name)),t.appendChild(Qe({value:je.spectrum},Lt.valueToPreset(je.spectrum).name)),t.appendChild(Qe({value:je.fm},Lt.valueToPreset(je.fm).name)),t.appendChild(Qe({value:je.customChipWave},Lt.valueToPreset(je.customChipWave).name)));const n=No({label:"Randomize "});n.appendChild(Qe({value:"randomPreset"},"Random Preset")),n.appendChild(Qe({value:"randomGenerated"},"Random Generated")),t.appendChild(n);for(let i=1;i<Lt.presetCategories.length;i++){const s=Lt.presetCategories[i],h=No({label:s.name+" "});let d=!1;for(let c=0;c<s.presets.length;c++){const _=s.presets[c];_.isNoise==!0==r&&(h.appendChild(Qe({value:(i<<6)+c},_.name)),d=!0)}if(s.name=="String Presets"&&d){let c=h.removeChild(h.children[11]);h.insertBefore(c,h.children[1])}if(s.name=="Flute Presets"&&d){let c=h.removeChild(h.children[11]);h.insertBefore(c,h.children[1])}if(s.name=="Keyboard Presets"&&d){let c=h.removeChild(h.children[9]);h.insertBefore(c,h.children[1])}d&&t.appendChild(h)}return t}function Pn(r,e){const t=e.toString();r.value!=t&&(r.value=t),ut(r).data("select2")&&ut(r).val(e).trigger("change.select2")}class cv{constructor(e,t,n){a(this,"mouseDown");a(this,"continuousEdit");a(this,"lastX");a(this,"lastY");a(this,"newArray");a(this,"_change",null);a(this,"_onMouseMove",e=>{if(this.mouseDown){var t=(e.clientX||e.pageX)-this.canvas.getBoundingClientRect().left,n=Math.floor((e.clientY||e.pageY)-this.canvas.getBoundingClientRect().top);n<2&&(n=2),n>50&&(n=50);var i=this.canvas.getContext("2d");if(this.continuousEdit==!0&&Math.abs(this.lastX-t)<40){var s=t<this.lastX?t:this.lastX,h=t<this.lastX?this.lastX:t;for(let A=s;A<=h;A+=2){var d=Math.abs(t-this.lastX)>2?t>this.lastX?1-(A-s)/(h-s):(A-s)/(h-s):0,c=Math.round(n+(this.lastY-n)*d);i.fillStyle=Q.getComputed("--editor-background"),i.fillRect(Math.floor(A/2)*2,0,2,53),i.fillStyle=Q.getComputed("--ui-widget-background"),i.fillRect(Math.floor(A/2)*2,25,2,2),i.fillStyle=Q.getComputed("--track-editor-bg-pitch-dim"),i.fillRect(Math.floor(A/2)*2,13,2,1),i.fillRect(Math.floor(A/2)*2,39,2,1),i.fillStyle=Q.getComputedChannelColor(u.song,u.channel).primaryNote,i.fillRect(Math.floor(A/2)*2,c-2,2,4),this.newArray[Math.floor(A/2)]=c-26}}else i.fillStyle=Q.getComputed("--editor-background"),i.fillRect(Math.floor(t/2)*2,0,2,52),i.fillStyle=Q.getComputed("--ui-widget-background"),i.fillRect(Math.floor(t/2)*2,25,2,2),i.fillStyle=Q.getComputed("--track-editor-bg-pitch-dim"),i.fillRect(Math.floor(t/2)*2,13,2,1),i.fillRect(Math.floor(t/2)*2,39,2,1),i.fillStyle=Q.getComputedChannelColor(u.song,u.channel).primaryNote,i.fillRect(Math.floor(t/2)*2,n-2,2,4),this.newArray[Math.floor(t/2)]=n-26;this.continuousEdit=!0,this.lastX=t,this.lastY=n;let _=u.song.channels[u.channel].instruments[u.getCurrentInstrument()],m=0;for(let A=0;A<this.newArray.length;A++)m+=this.newArray[A];const g=m/this.newArray.length;let S=0,E=0;for(let A=0;A<this.newArray.length;A++)S+=E,E=this.newArray[A]-g,_.customChipWaveIntegral[A]=S;_.customChipWaveIntegral[64]=0}});a(this,"_onMouseDown",e=>{this.mouseDown=!0,this._onMouseMove(e)});a(this,"_onMouseUp",()=>{this.mouseDown=!1,this.continuousEdit=!1,this._whenChange()});a(this,"_whenChange",()=>{this._change=this._getChange(this.newArray),u.record(this._change),this._change=null});this.canvas=e,this._doc=t,this._getChange=n,e.addEventListener("mousemove",this._onMouseMove),e.addEventListener("mousedown",this._onMouseDown),e.addEventListener("mouseup",this._onMouseUp),e.addEventListener("mouseleave",this._onMouseUp),this.mouseDown=!1,this.continuousEdit=!1,this.lastX=0,this.lastY=0,this.newArray=new Float32Array(64),this.redrawCanvas()}redrawCanvas(){var e=this.canvas.getContext("2d");e.fillStyle=Q.getComputed("--editor-background"),e.fillRect(0,0,128,52),e.fillStyle=Q.getComputed("--ui-widget-background"),e.fillRect(0,25,128,2),e.fillStyle=Q.getComputed("--track-editor-bg-pitch-dim"),e.fillRect(0,13,128,1),e.fillRect(0,39,128,1),e.fillStyle=Q.getComputedChannelColor(u.song,u.channel).primaryNote;for(let n=0;n<64;n++){var t=u.song.channels[u.channel].instruments[u.getCurrentInstrument()].customChipWave[n]+26;e.fillRect(n*2,t-2,2,4),this.newArray[n]=t-26}}}class dv{constructor(){a(this,"prompt",null);a(this,"_keyboardLayout",new Da(u));a(this,"_patternEditorPrev",new El(!1,-1));a(this,"_patternEditor",new El(!0,0));a(this,"_patternEditorNext",new El(!1,1));a(this,"_trackEditor",new F_(u,this));a(this,"_muteEditor",new s_(u,this));a(this,"_loopEditor",new Qp(u));a(this,"_piano",new ja(u));a(this,"_octaveScrollBar",new r_(u,this._piano));a(this,"_playButton",rn({class:"playButton",type:"button",title:"Play (Space)"},st("Play")));a(this,"_pauseButton",rn({class:"pauseButton",style:"display: none;",type:"button",title:"Pause (Space)"},"Pause"));a(this,"_recordButton",rn({class:"recordButton",style:"display: none;",type:"button",title:"Record (Ctrl+Space)"},st("Record")));a(this,"_stopButton",rn({class:"stopButton",style:"display: none;",type:"button",title:"Stop Recording (Space)"},"Stop Recording"));a(this,"_prevBarButton",rn({class:"prevBarButton",type:"button",title:"Previous Bar (left bracket)"}));a(this,"_nextBarButton",rn({class:"nextBarButton",type:"button",title:"Next Bar (right bracket)"}));a(this,"_volumeSlider",new tn(Ft({title:"main volume",style:"width: 5em; flex-grow: 1; margin: 0;",type:"range",min:"0",max:"75",value:"50",step:"1"}),u,null,!1));a(this,"_outVolumeBarBg",me.rect({"pointer-events":"none",width:"90%",height:"50%",x:"5%",y:"25%",fill:Q.uiWidgetBackground}));a(this,"_outVolumeBar",me.rect({"pointer-events":"none",height:"50%",width:"0%",x:"5%",y:"25%",fill:"url('#volumeGrad2')"}));a(this,"_outVolumeCap",me.rect({"pointer-events":"none",width:"2px",height:"50%",x:"5%",y:"25%",fill:Q.uiWidgetFocus}));a(this,"_stop1",me.stop({"stop-color":"lime",offset:"60%"}));a(this,"_stop2",me.stop({"stop-color":"orange",offset:"90%"}));a(this,"_stop3",me.stop({"stop-color":"red",offset:"100%"}));a(this,"_gradient",me.linearGradient({id:"volumeGrad2",gradientUnits:"userSpaceOnUse"},this._stop1,this._stop2,this._stop3));a(this,"_defs",me.defs({},this._gradient));a(this,"_volumeBarContainer",me.svg({style:"touch-action: none; overflow: visible; margin: auto; max-width: 20vw;",width:"160px",height:"100%",preserveAspectRatio:"none",viewBox:"0 0 160 12"},this._defs,this._outVolumeBarBg,this._outVolumeBar,this._outVolumeCap));a(this,"_volumeBarBox",ye({class:"playback-volume-bar",style:"height: 12px; align-self: center;"},this._volumeBarContainer));a(this,"_fileMenu",an({style:"width: 100%;"},Qe({selected:!0,disabled:!0,hidden:!1},"File"),Qe({value:"new"},"+ New Blank Song"),Qe({value:"import"}," Import Song... ("+Lt.ctrlSymbol+"O)"),Qe({value:"export"}," Export Song... ("+Lt.ctrlSymbol+"S)"),Qe({value:"export_stems"}," Export Stems..."),Qe({value:"copyUrl"}," Copy Song URL"),Qe({value:"shareUrl"}," Share Song URL"),Qe({value:"shortenUrl"}," Shorten Song URL"),Qe({value:"viewPlayer"}," View in Song Player"),Qe({value:"copyEmbed"}," Copy HTML Embed Code"),Qe({value:"songRecovery"}," Recover Recent Song...")));a(this,"_editMenu",an({style:"width: 100%;"},Qe({selected:!0,disabled:!0,hidden:!1},"Edit"),Qe({value:"undo"},"Undo (Z)"),Qe({value:"redo"},"Redo (Y)"),Qe({value:"copy"},"Copy Pattern (C)"),Qe({value:"pasteNotes"},"Paste Pattern Notes (V)"),Qe({value:"pasteNumbers"},"Paste Pattern Numbers ("+Lt.ctrlSymbol+"V)"),Qe({value:"insertBars"},"Insert Bar ()"),Qe({value:"deleteBars"},"Delete Selected Bars ()"),Qe({value:"insertChannel"},"Insert Channel ("+Lt.ctrlSymbol+")"),Qe({value:"deleteChannel"},"Delete Selected Channels ("+Lt.ctrlSymbol+")"),Qe({value:"selectChannel"},"Select Channel (A)"),Qe({value:"selectAll"},"Select All (A)"),Qe({value:"duplicatePatterns"},"Duplicate Reused Patterns (D)"),Qe({value:"transposeUp"},"Move Notes Up (+ or +)"),Qe({value:"transposeDown"},"Move Notes Down (- or -)"),Qe({value:"moveNotesSideways"},"Move All Notes Sideways... (W)"),Qe({value:"beatsPerBar"},"Change Beats Per Bar..."),Qe({value:"barCount"},"Change Song Length... (L)"),Qe({value:"channelSettings"},"Channel Settings... (Q)"),Qe({value:"limiterSettings"},"Limiter Settings... (L)")));a(this,"_optionsMenu",an({style:"width: 100%;"},Qe({selected:!0,disabled:!0,hidden:!1},"Preferences"),Qe({value:"autoPlay"},"Auto Play on Load"),Qe({value:"autoFollow"},"Keep Current Pattern Selected"),Qe({value:"enableNotePreview"},"Hear Preview of Added Notes"),Qe({value:"showLetters"},"Show Piano Keys"),Qe({value:"showFifth"},'Highlight "Fifth" of Song Key'),Qe({value:"notesOutsideScale"},"Allow Adding Notes Not in Scale"),Qe({value:"setDefaultScale"},"Use Current Scale as Default"),Qe({value:"showChannels"},"Show Notes From All Channels"),Qe({value:"showScrollBar"},"Show Octave Scroll Bar"),Qe({value:"alwaysFineNoteVol"},"Always Fine Note Volume"),Qe({value:"enableChannelMuting"},"Enable Channel Muting"),Qe({value:"displayBrowserUrl"},"Display Song Data in URL"),Qe({value:"displayVolumeBar"},"Show Playback Volume"),Qe({value:"layout"},"Set Layout..."),Qe({value:"colorTheme"},"Set Theme..."),Qe({value:"recordingSetup"},"Set Up Note Recording...")));a(this,"_scaleSelect",Mn(an(),w.scales.map(e=>e.name)));a(this,"_keySelect",Mn(an(),w.keys.map(e=>e.name).reverse()));a(this,"_tempoSlider",new tn(Ft({style:"margin: 0; vertical-align: middle;",type:"range",min:"30",max:"320",value:"160",step:"1"}),u,(e,t)=>new ah(u,e,t),!1));a(this,"_tempoStepper",Ft({style:"width: 4em; font-size: 80%; margin-left: 0.4em; vertical-align: middle;",type:"number",step:"1"}));a(this,"_chorusSlider",new tn(Ft({style:"margin: 0;",type:"range",min:"0",max:w.chorusRange-1,value:"0",step:"1"}),u,(e,t)=>new lp(u,e,t),!1));a(this,"_chorusRow",ye({class:"selectRow"},st({class:"tip",onclick:()=>this._openPrompt("chorus")},"Chorus:"),this._chorusSlider.container));a(this,"_reverbSlider",new tn(Ft({style:"margin: 0; position: sticky,",type:"range",min:"0",max:w.reverbRange-1,value:"0",step:"1"}),u,(e,t)=>new hp(u,e,t),!1));a(this,"_reverbRow",ye({class:"selectRow"},st({class:"tip",onclick:()=>this._openPrompt("reverb")},"Reverb:"),this._reverbSlider.container));a(this,"_echoSustainSlider",new tn(Ft({style:"margin: 0;",type:"range",min:"0",max:w.echoSustainRange-1,value:"0",step:"1"}),u,(e,t)=>new ap(u,e,t),!1));a(this,"_echoSustainRow",ye({class:"selectRow"},st({class:"tip",onclick:()=>this._openPrompt("echoSustain")},"Echo:"),this._echoSustainSlider.container));a(this,"_echoDelaySlider",new tn(Ft({style:"margin: 0;",type:"range",min:"0",max:w.echoDelayRange-1,value:"0",step:"1"}),u,(e,t)=>new op(u,e,t),!1));a(this,"_echoDelayRow",ye({class:"selectRow"},st({class:"tip",onclick:()=>this._openPrompt("echoDelay")},"Echo Delay:"),this._echoDelaySlider.container));a(this,"_rhythmSelect",Mn(an(),w.rhythms.map(e=>e.name)));a(this,"_pitchedPresetSelect",eu(!1,"pitchPresetSelect"));a(this,"_drumPresetSelect",eu(!0,"drumPresetSelect"));a(this,"_algorithmSelect",Mn(an(),w.algorithms.map(e=>e.name)));a(this,"_algorithmSelectRow",ye({class:"selectRow"},st({class:"tip",onclick:()=>this._openPrompt("algorithm")},"Algorithm: "),ye({class:"selectContainer"},this._algorithmSelect)));a(this,"_instrumentButtons",[]);a(this,"_instrumentAddButton",rn({type:"button",class:"add-instrument last-button"}));a(this,"_instrumentRemoveButton",rn({type:"button",class:"remove-instrument"}));a(this,"_instrumentsButtonBar",ye({class:"instrument-bar"},this._instrumentRemoveButton,this._instrumentAddButton));a(this,"_instrumentsButtonRow",ye({class:"selectRow",style:"display: none;"},st({class:"tip",onclick:()=>this._openPrompt("instrumentIndex")},"Instrument:"),this._instrumentsButtonBar));a(this,"_instrumentVolumeSlider",new tn(Ft({style:"margin: 0; position: sticky;",type:"range",min:Math.floor(-w.volumeRange/2),max:Math.floor(w.volumeRange/2),value:"0",step:"1"}),u,(e,t)=>new wl(u,e,t),!0));a(this,"_instrumentVolumeSliderInputBox",Ft({style:"width: 4em; font-size: 80%",id:"volumeSliderInputBox",type:"number",step:"1",min:Math.floor(-w.volumeRange/2),max:Math.floor(w.volumeRange/2),value:"0"}));a(this,"_instrumentVolumeSliderTip",ye({class:"selectRow",style:"height: 1em"},st({class:"tip",style:"font-size: smaller;",onclick:()=>this._openPrompt("instrumentVolume")},"Volume: ")));a(this,"_instrumentVolumeSliderRow",ye({class:"selectRow"},ye({},ye({style:"color: "+Q.secondaryText+";"},st({class:"tip"},this._instrumentVolumeSliderTip)),ye({style:"color: "+Q.secondaryText+"; margin-top: -3px;"},this._instrumentVolumeSliderInputBox)),this._instrumentVolumeSlider.container));a(this,"_panSlider",new tn(Ft({style:"margin: 0; position: sticky;",type:"range",min:"0",max:w.panMax,value:w.panCenter,step:"1"}),u,(e,t)=>new cc(u,e,t),!0));a(this,"_panDropdown",rn({style:"margin-left:0em; height:1.5em; width: 10px; padding: 0px; font-size: 8px;",onclick:()=>this._toggleDropdownMenu(Ps.Pan)},""));a(this,"_panSliderInputBox",Ft({style:"width: 4em; font-size: 80%; ",id:"panSliderInputBox",type:"number",step:"1",min:"0",max:"100",value:"0"}));a(this,"_panSliderRow",ye({class:"selectRow"},ye({},st({class:"tip",tabindex:"0",style:"height:1em; font-size: smaller;",onclick:()=>this._openPrompt("pan")},"Pan: "),ye({style:"color: "+Q.secondaryText+"; margin-top: -3px;"},this._panSliderInputBox)),this._panDropdown,this._panSlider.container));a(this,"_panDelaySlider",new tn(Ft({style:"margin: 0;",type:"range",min:"0",max:w.modulators.dictionary["pan delay"].maxRawVol,value:"0",step:"1"}),u,(e,t)=>new _p(u,e,t),!1));a(this,"_panDelayRow",ye({class:"selectRow"},st({class:"tip",style:"margin-left:10px;",onclick:()=>this._openPrompt("panDelay")},"Delay:"),this._panDelaySlider.container));a(this,"_panDropdownGroup",ye({class:"editor-controls",style:"display: none;"},this._panDelayRow));a(this,"_chipWaveSelect",Mn(an(),w.chipWaves.map(e=>e.name)));a(this,"_chipNoiseSelect",Mn(an(),w.chipNoises.map(e=>e.name)));a(this,"_chipWaveSelectRow",ye({class:"selectRow"},st({class:"tip",onclick:()=>this._openPrompt("chipWave")},"Wave: "),ye({class:"selectContainer"},this._chipWaveSelect)));a(this,"_chipNoiseSelectRow",ye({class:"selectRow"},st({class:"tip",onclick:()=>this._openPrompt("chipNoise")},"Noise: "),ye({class:"selectContainer"},this._chipNoiseSelect)));a(this,"_fadeInOutEditor",new Kp(u));a(this,"_fadeInOutRow",ye({class:"selectRow"},st({class:"tip",onclick:()=>this._openPrompt("fadeInOut")},"Fade:"),this._fadeInOutEditor.container));a(this,"_transitionSelect",Mn(an(),w.transitions.map(e=>e.name)));a(this,"_transitionDropdown",rn({style:"margin-left:0em; height:1.5em; width: 10px; padding: 0px; font-size: 8px;",onclick:()=>this._toggleDropdownMenu(Ps.Transition)},""));a(this,"_transitionRow",ye({class:"selectRow"},st({class:"tip",onclick:()=>this._openPrompt("transition")},"Transition:"),this._transitionDropdown,ye({class:"selectContainer",style:"width: 52.5%;"},this._transitionSelect)));a(this,"_clicklessTransitionBox",Ft({type:"checkbox",style:"width: 1em; padding: 0; margin-right: 4em;"}));a(this,"_clicklessTransitionRow",ye({class:"selectRow"},st({class:"tip",style:"margin-left:10px;",onclick:()=>this._openPrompt("clicklessTransition")},"Clickless:"),this._clicklessTransitionBox));a(this,"_transitionDropdownGroup",ye({class:"editor-controls",style:"display: none;"},this._clicklessTransitionRow));a(this,"_effectsSelect",an(Qe({selected:!0,disabled:!0,hidden:!1})));a(this,"_eqFilterSimpleButton",rn({style:"font-size: x-small; width: 50%; height: 40%",class:"no-underline",onclick:()=>this._switchEQFilterType(!0)},"simple"));a(this,"_eqFilterAdvancedButton",rn({style:"font-size: x-small; width: 50%; height: 40%",class:"last-button no-underline",onclick:()=>this._switchEQFilterType(!1)},"advanced"));a(this,"_eqFilterTypeRow",ye({class:"selectRow",style:"padding-top: 4px; margin-bottom: 0px;"},st({style:"font-size: x-small;",class:"tip",onclick:()=>this._openPrompt("filterType")},"EQ Filt.Type:"),ye({class:"instrument-bar"},this._eqFilterSimpleButton,this._eqFilterAdvancedButton)));a(this,"_eqFilterEditor",new Fo(u));a(this,"_eqFilterZoom",rn({style:"margin-left:0em; padding-left:0.2em; height:1.5em; max-width: 12px;",onclick:()=>this._openPrompt("customEQFilterSettings")},"+"));a(this,"_eqFilterRow",ye({class:"selectRow"},st({class:"tip",onclick:()=>this._openPrompt("eqFilter")},"EQ Filt:"),this._eqFilterZoom,this._eqFilterEditor.container));a(this,"_eqFilterSimpleCutSlider",new tn(Ft({style:"margin: 0;",type:"range",min:"0",max:w.filterSimpleCutRange-1,value:"6",step:"1"}),u,(e,t)=>new Lf(u,e,t),!1));a(this,"_eqFilterSimpleCutRow",ye({class:"selectRow",title:"Low-pass Filter Cutoff Frequency"},st({class:"tip",onclick:()=>this._openPrompt("filterCutoff")},"Filter Cut:"),this._eqFilterSimpleCutSlider.container));a(this,"_eqFilterSimplePeakSlider",new tn(Ft({style:"margin: 0;",type:"range",min:"0",max:w.filterSimplePeakRange-1,value:"6",step:"1"}),u,(e,t)=>new Nf(u,e,t),!1));a(this,"_eqFilterSimplePeakRow",ye({class:"selectRow",title:"Low-pass Filter Peak Resonance"},st({class:"tip",onclick:()=>this._openPrompt("filterResonance")},"Filter Peak:"),this._eqFilterSimplePeakSlider.container));a(this,"_noteFilterSimpleButton",rn({style:"font-size: x-small; width: 50%; height: 40%",class:"no-underline",onclick:()=>this._switchNoteFilterType(!0)},"simple"));a(this,"_noteFilterAdvancedButton",rn({style:"font-size: x-small; width: 50%; height: 40%",class:"last-button no-underline",onclick:()=>this._switchNoteFilterType(!1)},"advanced"));a(this,"_noteFilterTypeRow",ye({class:"selectRow",style:"padding-top: 4px; margin-bottom: 0px;"},st({style:"font-size: x-small;",class:"tip",onclick:()=>this._openPrompt("filterType")},"Note Filt.Type:"),ye({class:"instrument-bar"},this._noteFilterSimpleButton,this._noteFilterAdvancedButton)));a(this,"_noteFilterEditor",new Fo(u,!0));a(this,"_noteFilterZoom",rn({style:"margin-left:0em; padding-left:0.2em; height:1.5em; max-width: 12px;",onclick:()=>this._openPrompt("customNoteFilterSettings")},"+"));a(this,"_noteFilterRow",ye({class:"selectRow"},st({class:"tip",onclick:()=>this._openPrompt("noteFilter")},"Note Filt:"),this._noteFilterZoom,this._noteFilterEditor.container));a(this,"_noteFilterSimpleCutSlider",new tn(Ft({style:"margin: 0;",type:"range",min:"0",max:w.filterSimpleCutRange-1,value:"6",step:"1"}),u,(e,t)=>new Df(u,e,t),!1));a(this,"_noteFilterSimpleCutRow",ye({class:"selectRow",title:"Low-pass Filter Cutoff Frequency"},st({class:"tip",onclick:()=>this._openPrompt("filterCutoff")},"Filter Cut:"),this._noteFilterSimpleCutSlider.container));a(this,"_noteFilterSimplePeakSlider",new tn(Ft({style:"margin: 0;",type:"range",min:"0",max:w.filterSimplePeakRange-1,value:"6",step:"1"}),u,(e,t)=>new Ff(u,e,t),!1));a(this,"_noteFilterSimplePeakRow",ye({class:"selectRow",title:"Low-pass Filter Peak Resonance"},st({class:"tip",onclick:()=>this._openPrompt("filterResonance")},"Filter Peak:"),this._noteFilterSimplePeakSlider.container));a(this,"_pulseWidthSlider",new tn(Ft({style:"margin: 0;",type:"range",min:"1",max:w.pulseWidthRange,value:"1",step:"1"}),u,(e,t)=>new Pf(u,e,t),!1));a(this,"_pulseWidthRow",ye({class:"selectRow"},st({class:"tip",onclick:()=>this._openPrompt("pulseWidth")},"Pulse Width:"),this._pulseWidthSlider.container));a(this,"_pitchShiftSlider",new tn(Ft({style:"margin: 0;",type:"range",min:"0",max:w.pitchShiftRange-1,value:"0",step:"1"}),u,(e,t)=>new Ef(u,e,t),!0));a(this,"_pitchShiftTonicMarkers",[ye({class:"pitchShiftMarker",style:{color:Q.tonic}}),ye({class:"pitchShiftMarker",style:{color:Q.tonic,left:"50%"}}),ye({class:"pitchShiftMarker",style:{color:Q.tonic,left:"100%"}})]);a(this,"_pitchShiftFifthMarkers",[ye({class:"pitchShiftMarker",style:{color:Q.fifthNote,left:100*7/24+"%"}}),ye({class:"pitchShiftMarker",style:{color:Q.fifthNote,left:100*19/24+"%"}})]);a(this,"_pitchShiftMarkerContainer",ye({style:"display: flex; position: relative;"},this._pitchShiftSlider.container,ye({class:"pitchShiftMarkerContainer"},this._pitchShiftTonicMarkers,this._pitchShiftFifthMarkers)));a(this,"_pitchShiftRow",ye({class:"selectRow"},st({class:"tip",onclick:()=>this._openPrompt("pitchShift")},"Pitch Shift:"),this._pitchShiftMarkerContainer));a(this,"_detuneSlider",new tn(Ft({style:"margin: 0;",type:"range",min:w.detuneMin-w.detuneCenter,max:w.detuneMax-w.detuneCenter,value:0,step:"4"}),u,(e,t)=>new ac(u,e,t),!0));a(this,"_detuneSliderInputBox",Ft({style:"width: 4em; font-size: 80%; ",id:"detuneSliderInputBox",type:"number",step:"1",min:w.detuneMin-w.detuneCenter,max:w.detuneMax-w.detuneCenter,value:0}));a(this,"_detuneSliderRow",ye({class:"selectRow"},ye({},st({class:"tip",style:"height:1em; font-size: smaller;",onclick:()=>this._openPrompt("detune")},"Detune: "),ye({style:"color: "+Q.secondaryText+"; margin-top: -3px;"},this._detuneSliderInputBox)),this._detuneSlider.container));a(this,"_distortionSlider",new tn(Ft({style:"margin: 0; position: sticky;",type:"range",min:"0",max:w.distortionRange-1,value:"0",step:"1"}),u,(e,t)=>new Bf(u,e,t),!1));a(this,"_distortionRow",ye({class:"selectRow"},st({class:"tip",onclick:()=>this._openPrompt("distortion")},"Distortion:"),this._distortionSlider.container));a(this,"_aliasingBox",Ft({type:"checkbox",style:"width: 1em; padding: 0; margin-right: 4em;"}));a(this,"_aliasingRow",ye({class:"selectRow"},st({class:"tip",style:"margin-left:10px;",onclick:()=>this._openPrompt("aliases")},"Aliasing:"),this._aliasingBox));a(this,"_bitcrusherQuantizationSlider",new tn(Ft({style:"margin: 0;",type:"range",min:"0",max:w.bitcrusherQuantizationRange-1,value:"0",step:"1"}),u,(e,t)=>new Tf(u,e,t),!1));a(this,"_bitcrusherQuantizationRow",ye({class:"selectRow"},st({class:"tip",onclick:()=>this._openPrompt("bitcrusherQuantization")},"Bit Crush:"),this._bitcrusherQuantizationSlider.container));a(this,"_bitcrusherFreqSlider",new tn(Ft({style:"margin: 0;",type:"range",min:"0",max:w.bitcrusherFreqRange-1,value:"0",step:"1"}),u,(e,t)=>new Mf(u,e,t),!1));a(this,"_bitcrusherFreqRow",ye({class:"selectRow"},st({class:"tip",onclick:()=>this._openPrompt("bitcrusherFreq")},"Freq Crush:"),this._bitcrusherFreqSlider.container));a(this,"_stringSustainSlider",new tn(Ft({style:"margin: 0;",type:"range",min:"0",max:w.stringSustainRange-1,value:"0",step:"1"}),u,(e,t)=>new If(u,e,t),!1));a(this,"_stringSustainRow",ye({class:"selectRow"},st({class:"tip",onclick:()=>this._openPrompt("stringSustain")},"Sustain:"),this._stringSustainSlider.container));a(this,"_unisonSelect",Mn(an(),w.unisons.map(e=>e.name)));a(this,"_unisonSelectRow",ye({class:"selectRow"},st({class:"tip",onclick:()=>this._openPrompt("unison")},"Unison:"),ye({class:"selectContainer"},this._unisonSelect)));a(this,"_chordSelect",Mn(an(),w.chords.map(e=>e.name)));a(this,"_chordDropdown",rn({style:"margin-left:0em; height:1.5em; width: 10px; padding: 0px; font-size: 8px;",onclick:()=>this._toggleDropdownMenu(Ps.Chord)},""));a(this,"_chordSelectRow",ye({class:"selectRow"},st({class:"tip",onclick:()=>this._openPrompt("chords")},"Chords:"),this._chordDropdown,ye({class:"selectContainer"},this._chordSelect)));a(this,"_arpeggioSpeedSlider",new tn(Ft({style:"margin: 0;",type:"range",min:"0",max:w.modulators.dictionary["arp speed"].maxRawVol,value:"0",step:"1"}),u,(e,t)=>new bf(u,e,t),!1));a(this,"_arpeggioSpeedRow",ye({class:"selectRow"},st({class:"tip",style:"margin-left:10px;",onclick:()=>this._openPrompt("arpeggioSpeed")},"Speed:"),this._arpeggioSpeedSlider.container));a(this,"_twoNoteArpBox",Ft({type:"checkbox",style:"width: 1em; padding: 0; margin-right: 4em;"}));a(this,"_twoNoteArpRow",ye({class:"selectRow"},st({class:"tip",style:"margin-left:10px;",onclick:()=>this._openPrompt("twoNoteArpeggio")},"Fast Two-Note:"),this._twoNoteArpBox));a(this,"_chordDropdownGroup",ye({class:"editor-controls",style:"display: none;"},this._arpeggioSpeedRow,this._twoNoteArpRow));a(this,"_vibratoSelect",Mn(an(),w.vibratos.map(e=>e.name)));a(this,"_vibratoDropdown",rn({style:"margin-left:0em; height:1.5em; width: 10px; padding: 0px; font-size: 8px;",onclick:()=>this._toggleDropdownMenu(Ps.Vibrato)},""));a(this,"_vibratoSelectRow",ye({class:"selectRow"},st({class:"tip",onclick:()=>this._openPrompt("vibrato")},"Vibrato:"),this._vibratoDropdown,ye({class:"selectContainer",style:"width: 61.5%;"},this._vibratoSelect)));a(this,"_vibratoDepthSlider",new tn(Ft({style:"margin: 0;",type:"range",min:"0",max:w.modulators.dictionary["vibrato depth"].maxRawVol,value:"0",step:"1"}),u,(e,t)=>new _f(u,e,t),!1));a(this,"_vibratoDepthRow",ye({class:"selectRow"},st({class:"tip",style:"margin-left:10px;",onclick:()=>this._openPrompt("vibratoDepth")},"Depth:"),this._vibratoDepthSlider.container));a(this,"_vibratoSpeedSlider",new tn(Ft({style:"margin: 0;",type:"range",min:"0",max:w.modulators.dictionary["vibrato speed"].maxRawVol,value:"0",step:"1"}),u,(e,t)=>new mf(u,e,t),!1));a(this,"_vibratoSpeedRow",ye({class:"selectRow"},st({class:"tip",style:"margin-left:10px;",onclick:()=>this._openPrompt("vibratoSpeed")},"Speed:"),this._vibratoSpeedSlider.container));a(this,"_vibratoDelaySlider",new tn(Ft({style:"margin: 0;",type:"range",min:"0",max:w.modulators.dictionary["vibrato delay"].maxRawVol,value:"0",step:"1"}),u,(e,t)=>new gf(u,e,t),!1));a(this,"_vibratoDelayRow",ye({class:"selectRow"},st({class:"tip",style:"margin-left:10px;",onclick:()=>this._openPrompt("vibratoDelay")},"Delay:"),this._vibratoDelaySlider.container));a(this,"_vibratoTypeSelect",Mn(an(),w.vibratoTypes.map(e=>e.name)));a(this,"_vibratoTypeSelectRow",ye({class:"selectRow"},st({class:"tip",style:"margin-left:10px;",onclick:()=>this._openPrompt("vibratoType")},"Type:"),ye({class:"selectContainer",style:"width: 61.5%;"},this._vibratoTypeSelect)));a(this,"_vibratoDropdownGroup",ye({class:"editor-controls",style:"display: none;"},this._vibratoDepthRow,this._vibratoSpeedRow,this._vibratoDelayRow,this._vibratoTypeSelectRow));a(this,"_phaseModGroup",ye({class:"editor-controls"}));a(this,"_feedbackTypeSelect",Mn(an(),w.feedbacks.map(e=>e.name)));a(this,"_feedbackRow1",ye({class:"selectRow"},st({class:"tip",onclick:()=>this._openPrompt("feedbackType")},"Feedback:"),ye({class:"selectContainer"},this._feedbackTypeSelect)));a(this,"_spectrumEditor",new Tc(u,null));a(this,"_spectrumRow",ye({class:"selectRow"},st({class:"tip",onclick:()=>this._openPrompt("spectrum")},"Spectrum:"),this._spectrumEditor.container));a(this,"_harmonicsEditor",new Hp(u));a(this,"_harmonicsRow",ye({class:"selectRow"},st({class:"tip",onclick:()=>this._openPrompt("harmonics")},"Harmonics:"),this._harmonicsEditor.container));a(this,"_envelopeEditor",new jp(u));a(this,"_drumsetGroup",ye({class:"editor-controls"}));a(this,"_modulatorGroup",ye({class:"editor-controls"}));a(this,"_modNameRows");a(this,"_modChannelBoxes");a(this,"_modInstrumentBoxes");a(this,"_modSetRows");a(this,"_modSetBoxes");a(this,"_modFilterRows");a(this,"_modFilterBoxes");a(this,"_modTargetIndicators");a(this,"_instrumentCopyButton",rn({style:"max-width:86px; width: 86px;",class:"copyButton"},["Copy",me.svg({style:"flex-shrink: 0; position: absolute; left: 0; top: 50%; margin-top: -1em; pointer-events: none;",width:"2em",height:"2em",viewBox:"-5 -21 26 26"},[me.path({d:"M 0 -15 L 1 -15 L 1 0 L 13 0 L 13 1 L 0 1 L 0 -15 z M 2 -1 L 2 -17 L 10 -17 L 14 -13 L 14 -1 z M 3 -2 L 13 -2 L 13 -12 L 9 -12 L 9 -16 L 3 -16 z",fill:"currentColor"})])]));a(this,"_instrumentPasteButton",rn({style:"max-width:86px;",class:"pasteButton"},["Paste",me.svg({style:"flex-shrink: 0; position: absolute; left: 0; top: 50%; margin-top: -1em; pointer-events: none;",width:"2em",height:"2em",viewBox:"0 0 26 26"},[me.path({d:"M 8 18 L 6 18 L 6 5 L 17 5 L 17 7 M 9 8 L 16 8 L 20 12 L 20 22 L 9 22 z",stroke:"currentColor",fill:"none"}),me.path({d:"M 9 3 L 14 3 L 14 6 L 9 6 L 9 3 z M 16 8 L 20 12 L 16 12 L 16 8 z",fill:"currentColor"})])]));a(this,"_customWaveDrawCanvas",new cv(lv({width:128,height:52,style:"border:2px solid "+Q.uiWidgetBackground,id:"customWaveDrawCanvas"}),u,e=>new pr(u,e)));a(this,"_customWavePresetDrop",hv("Load Preset",an({style:"width: 50%; height:1.5em; text-align: center; text-align-last: center;"}),w.chipWaves.map(e=>e.name)));a(this,"_customWaveZoom",rn({style:"margin-left:0.5em; height:1.5em; max-width: 20px;",onclick:()=>this._openPrompt("customChipSettings")},"+"));a(this,"_customWaveDraw",ye({style:"height:80px; margin-top:10px; margin-bottom:5px"},[ye({style:"height:54px; display:flex; justify-content:center;"},[this._customWaveDrawCanvas.canvas]),ye({style:"margin-top:5px; display:flex; justify-content:center;"},[this._customWavePresetDrop,this._customWaveZoom])]));a(this,"_songTitleInputBox",new mu(Ft({style:"font-weight:bold; border:none; width: 100%; background-color:${ColorConfig.editorBackground}; color:${ColorConfig.primaryText}; text-align:center",maxlength:"30",type:"text",value:Lt.versionDisplayName}),u,(e,t)=>new fp(u,e,t)));a(this,"_feedbackAmplitudeSlider",new tn(Ft({type:"range",min:"0",max:w.operatorAmplitudeMax,value:"0",step:"1",title:"Feedback Amplitude"}),u,(e,t)=>new Xf(u,e,t),!1));a(this,"_feedbackRow2",ye({class:"selectRow"},st({class:"tip",onclick:()=>this._openPrompt("feedbackVolume")},"Fdback Vol:"),this._feedbackAmplitudeSlider.container));a(this,"_addEnvelopeButton",rn({type:"button",class:"add-envelope"}));a(this,"_customInstrumentSettingsGroup",ye({class:"editor-controls"},this._panSliderRow,this._panDropdownGroup,this._chipWaveSelectRow,this._chipNoiseSelectRow,this._customWaveDraw,this._eqFilterTypeRow,this._eqFilterRow,this._eqFilterSimpleCutRow,this._eqFilterSimplePeakRow,this._fadeInOutRow,this._algorithmSelectRow,this._phaseModGroup,this._feedbackRow1,this._feedbackRow2,this._spectrumRow,this._harmonicsRow,this._drumsetGroup,this._pulseWidthRow,this._stringSustainRow,this._unisonSelectRow,ye({style:"padding: 2px 0; margin-left: 2em; display: flex; align-items: center;"},st({style:"flex-grow: 1; text-align: center;"},st({class:"tip",onclick:()=>this._openPrompt("effects")},"Effects")),ye({class:"effects-menu"},this._effectsSelect)),this._transitionRow,this._transitionDropdownGroup,this._chordSelectRow,this._chordDropdownGroup,this._pitchShiftRow,this._detuneSliderRow,this._vibratoSelectRow,this._vibratoDropdownGroup,this._noteFilterTypeRow,this._noteFilterRow,this._noteFilterSimpleCutRow,this._noteFilterSimplePeakRow,this._distortionRow,this._aliasingRow,this._bitcrusherQuantizationRow,this._bitcrusherFreqRow,this._chorusRow,this._echoSustainRow,this._echoDelayRow,this._reverbRow,ye({style:"padding: 2px 0; margin-left: 2em; display: flex; align-items: center;"},st({style:"flex-grow: 1; text-align: center;"},st({class:"tip",onclick:()=>this._openPrompt("envelopes")},"Envelopes")),this._addEnvelopeButton),this._envelopeEditor.container));a(this,"_instrumentCopyGroup",ye({class:"editor-controls"},ye({class:"selectRow"},this._instrumentCopyButton,this._instrumentPasteButton)));a(this,"_instrumentSettingsTextRow",ye({id:"instrumentSettingsText",style:`padding: 3px 0; max-width: 15em; text-align: center; color: ${Q.secondaryText};`},"Instrument Settings"));a(this,"_instrumentTypeSelectRow",ye({class:"selectRow",id:"typeSelectRow"},st({class:"tip",onclick:()=>this._openPrompt("instrumentType")},"Type:"),ye(ye({class:"pitchSelect"},this._pitchedPresetSelect),ye({class:"drumSelect"},this._drumPresetSelect))));a(this,"_instrumentSettingsGroup",ye({class:"editor-controls"},this._instrumentSettingsTextRow,this._instrumentsButtonRow,this._instrumentTypeSelectRow,this._instrumentVolumeSliderRow,this._customInstrumentSettingsGroup));a(this,"_usedPatternIndicator",me.path({d:"M -6 -6 H 6 V 6 H -6 V -6 M -2 -3 L -2 -3 L -1 -4 H 1 V 4 H -1 V -1.2 L -1.2 -1 H -2 V -3 z",fill:Q.indicatorSecondary,"fill-rule":"evenodd"}));a(this,"_usedInstrumentIndicator",me.path({d:"M -6 -0.8 H -3.8 V -6 H 0.8 V 4.4 H 2.2 V -0.8 H 6 V 0.8 H 3.8 V 6 H -0.8 V -4.4 H -2.2 V 0.8 H -6 z",fill:Q.indicatorSecondary}));a(this,"_jumpToModIndicator",me.svg({style:"width: 92%; height: 1.3em; flex-shrink: 0; position: absolute;",viewBox:"0 0 200 200"},[me.path({d:"M90 155 l0 -45 -45 0 c-25 0 -45 -4 -45 -10 0 -5 20 -10 45 -10 l45 0 0 -45 c0 -25 5 -45 10 -45 6 0 10 20 10 45 l0 45 45 0 c25 0 45 5 45 10 0 6 -20 10 -45 10 l -45 0 0 45 c0 25 -4 45 -10 45 -5 0 -10 -20 -10 -45z"}),me.path({d:"M42 158 c-15 -15 -16 -38 -2 -38 6 0 10 7 10 15 0 8 7 15 15 15 8 0 15 5 15 10 0 14 -23 13 -38 -2z"}),me.path({d:"M120 160 c0 -5 7 -10 15 -10 8 0 15 -7 15 -15 0 -8 5 -15 10 -15 14 0 13 23 -2 38 -15 15 -38 16 -38 2z"}),me.path({d:"M32 58 c3 -23 48 -40 48 -19 0 6 -7 11 -15 11 -8 0 -15 7 -15 15 0 8 -5 15 -11 15 -6 0 -9 -10 -7 -22z"}),me.path({d:"M150 65 c0 -8 -7 -15 -15 -15 -8 0 -15 -4 -15 -10 0 -14 23 -13 38 2 15 15 16 38 2 38 -5 0 -10 -7 -10 -15z"})]));a(this,"_promptContainer",ye({class:"promptContainer",style:"display: none;"}));a(this,"_zoomInButton",rn({class:"zoomInButton",type:"button",title:"Zoom In"}));a(this,"_zoomOutButton",rn({class:"zoomOutButton",type:"button",title:"Zoom Out"}));a(this,"_patternEditorRow",ye({style:"flex: 1; height: 100%; display: flex; overflow: hidden; justify-content: center;"},this._patternEditorPrev.container,this._patternEditor.container,this._patternEditorNext.container));a(this,"_patternArea",ye({class:"pattern-area"},this._piano.container,this._patternEditorRow,this._octaveScrollBar.container,this._zoomInButton,this._zoomOutButton));a(this,"_trackContainer",ye({class:"trackContainer"},this._trackEditor.container,this._loopEditor.container));a(this,"_trackVisibleArea",ye({style:"position: absolute; width: 100%; height: 100%; pointer-events: none;"}));a(this,"_trackAndMuteContainer",ye({class:"trackAndMuteContainer"},this._muteEditor.container,this._trackContainer,this._trackVisibleArea));a(this,"_barScrollBar",new sf(u,this._trackAndMuteContainer));a(this,"_trackArea",ye({class:"track-area"},this._trackAndMuteContainer,this._barScrollBar.container));a(this,"_menuArea",ye({class:"menu-area"},ye({class:"selectContainer menu file"},this._fileMenu),ye({class:"selectContainer menu edit"},this._editMenu),ye({class:"selectContainer menu preferences"},this._optionsMenu)));a(this,"_songSettingsArea",ye({class:"song-settings-area"},ye({class:"editor-controls"},ye({class:"editor-song-settings"},ye({style:"margin: 3px 0; position: relative; text-align: center; color: ${ColorConfig.secondaryText};"},ye({class:"tip",style:"flex-shrink: 0; position:absolute; left: 0; top: 0; width: 12px; height: 12px",onclick:()=>this._openPrompt("usedPattern")},me.svg({style:"flex-shrink: 0; position: absolute; left: 0; top: 0; pointer-events: none;",width:"12px",height:"12px","margin-right":"0.5em",viewBox:"-6 -6 12 12"},this._usedPatternIndicator)),ye({class:"tip",style:"flex-shrink: 0; position: absolute; left: 14px; top: 0; width: 12px; height: 12px",onclick:()=>this._openPrompt("usedInstrument")},me.svg({style:"flex-shrink: 0; position: absolute; left: 0; top: 0; pointer-events: none;",width:"12px",height:"12px","margin-right":"1em",viewBox:"-6 -6 12 12"},this._usedInstrumentIndicator)),"Song Settings",ye({style:"width: 100%; left: 0; top: -1px; position:absolute; overflow-x:clip;"},this._jumpToModIndicator))),ye({class:"selectRow"},st({class:"tip",onclick:()=>this._openPrompt("scale")},"Scale: "),ye({class:"selectContainer"},this._scaleSelect)),ye({class:"selectRow"},st({class:"tip",onclick:()=>this._openPrompt("key")},"Key: "),ye({class:"selectContainer"},this._keySelect)),ye({class:"selectRow"},st({class:"tip",onclick:()=>this._openPrompt("tempo")},"Tempo: "),st({style:"display: flex;"},this._tempoSlider.container,this._tempoStepper)),ye({class:"selectRow"},st({class:"tip",onclick:()=>this._openPrompt("rhythm")},"Rhythm: "),ye({class:"selectContainer"},this._rhythmSelect)))));a(this,"_instrumentSettingsArea",ye({class:"instrument-settings-area"},this._instrumentSettingsGroup,this._modulatorGroup));a(this,"_settingsArea",ye({class:"settings-area noSelection"},ye({class:"version-area"},ye({style:`text-align: center; margin: 3px 0; color: ${Q.secondaryText};`},this._songTitleInputBox.input)),ye({class:"play-pause-area"},this._volumeBarBox,ye({class:"playback-bar-controls"},this._playButton,this._pauseButton,this._recordButton,this._stopButton,this._prevBarButton,this._nextBarButton),ye({class:"playback-volume-controls"},st({class:"volume-speaker"}),this._volumeSlider.container)),this._menuArea,this._songSettingsArea,this._instrumentSettingsArea));a(this,"mainLayer",ye({class:"beepboxEditor",tabIndex:"0"},this._patternArea,this._trackArea,this._settingsArea,this._promptContainer));a(this,"_wasPlaying",!1);a(this,"_currentPromptName",null);a(this,"_highlightedInstrumentIndex",-1);a(this,"_renderedInstrumentCount",0);a(this,"_renderedIsPlaying",!1);a(this,"_renderedIsRecording",!1);a(this,"_renderedShowRecordButton",!1);a(this,"_renderedCtrlHeld",!1);a(this,"_ctrlHeld",!1);a(this,"_deactivatedInstruments",!1);a(this,"_operatorRows",[]);a(this,"_operatorAmplitudeSliders",[]);a(this,"_operatorFrequencySelects",[]);a(this,"_operatorDropdowns",[]);a(this,"_operatorWaveformSelects",[]);a(this,"_operatorWaveformHints",[]);a(this,"_operatorWaveformPulsewidthSliders",[]);a(this,"_operatorDropdownRows",[]);a(this,"_operatorDropdownGroups",[]);a(this,"_drumsetSpectrumEditors",[]);a(this,"_drumsetEnvelopeSelects",[]);a(this,"_showModSliders",[]);a(this,"_newShowModSliders",[]);a(this,"_modSliderValues",[]);a(this,"_hasActiveModSliders",!1);a(this,"_openPanDropdown",!1);a(this,"_openVibratoDropdown",!1);a(this,"_openChordDropdown",!1);a(this,"_openTransitionDropdown",!1);a(this,"_openOperatorDropdowns",[]);a(this,"outVolumeHistoricTimer",0);a(this,"outVolumeHistoricCap",0);a(this,"lastOutVolumeCap",0);a(this,"refocusStage",()=>{this.mainLayer.focus({preventScroll:!0})});a(this,"_onFocusIn",e=>{u.synth.recording&&e.target!=this.mainLayer&&e.target!=this._stopButton&&e.target!=this._volumeSlider.input&&this.refocusStage()});a(this,"_refocusStageNotEditing",()=>{this._patternEditor.editingModLabel||this.mainLayer.focus({preventScroll:!0})});a(this,"whenUpdated",()=>{const e=u.prefs;this._muteEditor.container.style.display=e.enableChannelMuting?"":"none";const t=this._trackVisibleArea.getBoundingClientRect();u.trackVisibleBars=Math.floor((t.right-t.left-(e.enableChannelMuting?32:0))/u.getBarWidth()),u.trackVisibleChannels=Math.floor((t.bottom-t.top-30)/u.getChannelHeight());for(let m=u.song.pitchChannelCount+u.song.noiseChannelCount;m<u.song.channels.length;m++){const g=u.song.channels[m];for(let S=0;S<g.instruments.length;S++)u.synth.determineInvalidModulators(g.instruments[S])}if(this._barScrollBar.render(),this._muteEditor.render(),this._trackEditor.render(),document.activeElement!=this._patternEditor.modDragValueLabel&&this._patternEditor.editingModLabel&&this._patternEditor.stopEditingModLabel(!1),this._piano.container.style.display=e.showLetters?"":"none",this._octaveScrollBar.container.style.display=e.showScrollBar?"":"none",this._barScrollBar.container.style.display=u.song.barCount>u.trackVisibleBars?"":"none",this._volumeBarBox.style.display=u.prefs.displayVolumeBar?"":"none",u.getFullScreen()){const g=this._patternEditorRow.clientHeight/u.getVisiblePitchCount()*5,S=this._patternEditorRow.clientWidth/(u.song.beatsPerBar*3),E=this._patternEditorRow.clientWidth/(u.song.beatsPerBar+2),C=Math.max(S,Math.min(E,g))*u.song.beatsPerBar;this._patternEditorPrev.container.style.width=C+"px",this._patternEditor.container.style.width=C+"px",this._patternEditorNext.container.style.width=C+"px",this._patternEditorPrev.container.style.flexShrink="0",this._patternEditor.container.style.flexShrink="0",this._patternEditorNext.container.style.flexShrink="0",this._patternEditorPrev.container.style.display="",this._patternEditorNext.container.style.display="",this._patternEditorPrev.render(),this._patternEditorNext.render(),this._zoomInButton.style.display=u.channel<u.song.pitchChannelCount?"":"none",this._zoomOutButton.style.display=u.channel<u.song.pitchChannelCount?"":"none",this._zoomInButton.style.right=e.showScrollBar?"24px":"4px",this._zoomOutButton.style.right=e.showScrollBar?"24px":"4px"}else this._patternEditor.container.style.width="",this._patternEditor.container.style.flexShrink="",this._patternEditorPrev.container.style.display="none",this._patternEditorNext.container.style.display="none",this._zoomInButton.style.display="none",this._zoomOutButton.style.display="none";this._patternEditor.render();const n=[(e.autoPlay?" ":"")+"Auto Play on Load",(e.autoFollow?" ":"")+"Keep Current Pattern Selected",(e.enableNotePreview?" ":"")+"Hear Preview of Added Notes",(e.showLetters?" ":"")+"Show Piano Keys",(e.showFifth?" ":"")+'Highlight "Fifth" of Song Key',(e.notesOutsideScale?" ":"")+"Allow Adding Notes Not in Scale",(e.defaultScale==u.song.scale?" ":"")+"Use Current Scale as Default",(e.showChannels?" ":"")+"Show Notes From All Channels",(e.showScrollBar?" ":"")+"Show Octave Scroll Bar",(e.alwaysFineNoteVol?" ":"")+"Always Fine Note Volume",(e.enableChannelMuting?" ":"")+"Enable Channel Muting",(e.displayBrowserUrl?" ":"")+"Display Song Data in URL",(e.displayVolumeBar?" ":"")+"Show Playback Volume","Set Layout...","Set Theme...","Set Up Note Recording..."];for(let m=0;m<n.length;m++){const g=this._optionsMenu.children[m+1];g.textContent!=n[m]&&(g.textContent=n[m])}const i=u.song.channels[u.channel],s=u.getCurrentInstrument(),h=i.instruments[s],d=this.mainLayer.contains(document.activeElement),c=document.activeElement,_=Q.getChannelColor(u.song,u.channel);for(let m=this._effectsSelect.childElementCount-1;m<w.effectOrder.length;m++)this._effectsSelect.appendChild(Qe({value:m}));this._effectsSelect.selectedIndex=-1;for(let m=0;m<w.effectOrder.length;m++){let g=w.effectOrder[m];const E=((h.effects&1<<g)!=0?" ":"")+w.effectNames[g],A=this._effectsSelect.children[m+1];A.textContent!=E&&(A.textContent=E)}if(Pn(this._scaleSelect,u.song.scale),this._scaleSelect.title=w.scales[u.song.scale].realName,Pn(this._keySelect,w.keys.length-1-u.song.key),this._tempoSlider.updateValue(Math.max(0,Math.round(u.song.tempo))),this._tempoStepper.value=Math.round(u.song.tempo).toString(),this._songTitleInputBox.updateValue(u.song.title),this._eqFilterTypeRow.style.setProperty("--text-color-lit",_.primaryNote),this._eqFilterTypeRow.style.setProperty("--text-color-dim",_.secondaryNote),this._eqFilterTypeRow.style.setProperty("--background-color-lit",_.primaryChannel),this._eqFilterTypeRow.style.setProperty("--background-color-dim",_.secondaryChannel),h.eqFilterType?(this._eqFilterSimpleButton.classList.remove("deactivated"),this._eqFilterAdvancedButton.classList.add("deactivated"),this._eqFilterRow.style.display="none",this._eqFilterSimpleCutRow.style.display="",this._eqFilterSimplePeakRow.style.display=""):(this._eqFilterSimpleButton.classList.add("deactivated"),this._eqFilterAdvancedButton.classList.remove("deactivated"),this._eqFilterRow.style.display="",this._eqFilterSimpleCutRow.style.display="none",this._eqFilterSimplePeakRow.style.display="none"),Pn(this._rhythmSelect,u.song.rhythm),u.song.getChannelIsMod(u.channel)){this._usageCheck(u.channel,s),this._pitchedPresetSelect.style.display="none",this._drumPresetSelect.style.display="none",ut("#pitchPresetSelect").parent().hide(),ut("#drumPresetSelect").parent().hide(),this._modulatorGroup.appendChild(this._instrumentCopyGroup),this._modulatorGroup.insertBefore(this._instrumentsButtonRow,this._modulatorGroup.firstChild),this._modulatorGroup.insertBefore(this._instrumentSettingsTextRow,this._modulatorGroup.firstChild),u.song.channels[u.channel].name==""?this._instrumentSettingsTextRow.textContent="Modulator Settings":this._instrumentSettingsTextRow.textContent=u.song.channels[u.channel].name,this._chipNoiseSelectRow.style.display="none",this._chipWaveSelectRow.style.display="none",this._spectrumRow.style.display="none",this._harmonicsRow.style.display="none",this._transitionRow.style.display="none",this._chordSelectRow.style.display="none",this._chordDropdownGroup.style.display="none",this._drumsetGroup.style.display="none",this._customWaveDraw.style.display="none",this._algorithmSelectRow.style.display="none",this._phaseModGroup.style.display="none",this._feedbackRow1.style.display="none",this._feedbackRow2.style.display="none",this._pulseWidthRow.style.display="none",this._vibratoSelectRow.style.display="none",this._vibratoDropdownGroup.style.display="none",this._detuneSliderRow.style.display="none",this._panSliderRow.style.display="none",this._panDropdownGroup.style.display="none",this._modulatorGroup.style.display="",this._modulatorGroup.style.color=Q.getChannelColor(u.song,u.channel).primaryNote;for(let m=0;m<w.modCount;m++){let g=u.song.channels[u.channel].instruments[u.getCurrentInstrument()],S=Math.max(0,g.modChannels[m]),E=g.modInstruments[m];if((E>=u.song.channels[S].instruments.length+2||E>0&&u.song.channels[S].instruments.length<=1)&&(E=0,g.modInstruments[m]=0,g.modulators[m]=0),S>=u.song.pitchChannelCount+u.song.noiseChannelCount&&(g.modInstruments[m]=0,g.modulators[m]=0),u.recalcChannelNames||this._modChannelBoxes[m].children.length!=2+u.song.pitchChannelCount+u.song.noiseChannelCount){for(;this._modChannelBoxes[m].firstChild;)this._modChannelBoxes[m].remove(0);const k=[];k.push("none"),k.push("song");for(let T=0;T<u.song.pitchChannelCount;T++)u.song.channels[T].name==""?k.push("pitch "+(T+1)):k.push(u.song.channels[T].name);for(let T=0;T<u.song.noiseChannelCount;T++)u.song.channels[T+u.song.pitchChannelCount].name==""?k.push("noise "+(T+1)):k.push(u.song.channels[T+u.song.pitchChannelCount].name);Mn(this._modChannelBoxes[m],k)}this._modChannelBoxes[m].selectedIndex=g.modChannels[m]+2;let A=u.song.channels[S];if(this._modInstrumentBoxes[m].children.length!=A.instruments.length+2){for(;this._modInstrumentBoxes[m].firstChild;)this._modInstrumentBoxes[m].remove(0);const k=[];for(let T=0;T<A.instruments.length;T++)k.push(""+T+1);k.push("all"),k.push("active"),Mn(this._modInstrumentBoxes[m],k)}if(A.bars[u.bar]>0){let k=A.patterns[A.bars[u.bar]-1].instruments;for(let T=0;T<A.instruments.length;T++)k.includes(T)?this._modInstrumentBoxes[m].options[T].label=""+(T+1):this._modInstrumentBoxes[m].options[T].label=""+(T+1)}else for(let k=0;k<A.instruments.length;k++)this._modInstrumentBoxes[m].options[k].label=""+(k+1);if(this._modInstrumentBoxes[m].selectedIndex=g.modInstruments[m],g.modChannels[m]!=-2){for(;this._modSetBoxes[m].firstChild;)this._modSetBoxes[m].remove(0);const k=[],T=[];if(k.push("none"),g.modChannels[m]==-1)k.push("song volume"),k.push("tempo"),k.push("song reverb"),k.push("next bar"),k.push("song detune");else{k.push("note volume"),k.push("mix volume");let R=[],V=!1,f=!1,D=!1,l=!1,W=!1,L=!1,P=!1,y=!1,O=!1,B=!1,v=!1,H=!1,N=!1,te=!1,G=!1,se=!0,M=!0,F=!0,Z=!0,ee=!0,ue=!0,Pe=!0,_e=!0,ke=!0,Ne=[];if(E>=A.instruments.length)for(let Be=0;Be<A.instruments.length;Be++)Ne.push(Be);else Ne.push(E);for(let Be=0;Be<Ne.length;Be++){let pe=Ne[Be];R.includes(A.instruments[pe].type)||R.push(A.instruments[pe].type),A.instruments[pe].eqFilterType?f=!0:V=!0,Zh(A.instruments[pe].effects)&&A.instruments[pe].getChord().arpeggiates&&(W=!0),Qh(A.instruments[pe].effects)&&(L=!0),Jh(A.instruments[pe].effects)?P=!0:M=!1,ec(A.instruments[pe].effects)?y=!0:F=!1,ml(A.instruments[pe].effects)?(O=!0,A.instruments[pe].noteFilterType?l=!0:D=!0):se=!1,sh(A.instruments[pe].effects)?B=!0:Z=!1,tc(A.instruments[pe].effects)?v=!0:ee=!1,nc(A.instruments[pe].effects)?H=!0:ue=!1,ic(A.instruments[pe].effects)?N=!0:Pe=!1,sc(A.instruments[pe].effects)?te=!0:_e=!1,rc(A.instruments[pe].effects)?G=!0:ke=!1}V&&k.push("eq filter"),f&&(k.push("eq filt cut"),k.push("eq filt peak")),R.includes(je.fm)&&(k.push("fm slider 1"),k.push("fm slider 2"),k.push("fm slider 3"),k.push("fm slider 4"),k.push("fm feedback")),R.includes(je.pwm)&&k.push("pulse width"),R.includes(je.pickedString)&&k.push("sustain"),W&&(k.push("arp speed"),k.push("reset arp")),L&&k.push("pitch shift"),P&&k.push("detune"),M||T.push("+ detune"),y&&(k.push("vibrato depth"),k.push("vibrato speed"),k.push("vibrato delay")),F||(T.push("+ vibrato depth"),T.push("+ vibrato speed"),T.push("+ vibrato delay")),O&&(D&&k.push("note filter"),l&&(k.push("note filt cut"),k.push("note filt peak"))),se||T.push("+ note filter"),B&&k.push("distortion"),Z||T.push("+ distortion"),v&&(k.push("bit crush"),k.push("freq crush")),ee||(T.push("+ bit crush"),T.push("+ freq crush")),H&&(k.push("pan"),k.push("pan delay")),ue||(T.push("+ pan"),T.push("+ pan delay")),N&&k.push("chorus"),Pe||T.push("+ chorus"),te&&k.push("echo"),_e||T.push("+ echo"),G&&k.push("reverb"),ke||T.push("+ reverb")}Mn(this._modSetBoxes[m],k),T.length>0&&(this._modSetBoxes[m].appendChild(Qe({selected:!1,disabled:!0,value:"Add Effect"},"Add Effect")),Mn(this._modSetBoxes[m],T));let b=k.indexOf(w.modulators[g.modulators[m]].name);b==-1?(this._modSetBoxes[m].insertBefore(Qe({value:w.modulators[g.modulators[m]].name,style:"color: red;"},w.modulators[g.modulators[m]].name),this._modSetBoxes[m].children[0]),this._modSetBoxes[m].selectedIndex=0,this._whenSetModSetting(m,!0)):(this._modSetBoxes[m].selectedIndex=b,this._modSetBoxes[m].classList.remove("invalidSetting"),g.invalidModulators[m]=!1)}else this._modSetBoxes[m].selectedIndex>0&&(this._modSetBoxes[m].selectedIndex=0,this._whenSetModSetting(m));g.modChannels[m]<0?(this._modInstrumentBoxes[m].parentElement.style.display="none",ut("#modInstrumentText"+m).css("display","none"),ut("#modChannelText"+m).text("Channel:"),g.modChannels[m]==-2?(ut("#modSettingText"+m).css("display","none"),this._modSetBoxes[m].parentElement.style.display="none"):(ut("#modSettingText"+m).css("display",""),this._modSetBoxes[m].parentElement.style.display=""),this._modTargetIndicators[m].style.setProperty("fill",Q.uiWidgetFocus),this._modTargetIndicators[m].classList.remove("modTarget")):(this._modInstrumentBoxes[m].parentElement.style.display=A.instruments.length>1?"":"none",ut("#modInstrumentText"+m).css("display",A.instruments.length>1?"":"none"),ut("#modChannelText"+m).text(A.instruments.length>1?"Ch:":"Channel:"),ut("#modSettingText"+m).css("display",""),this._modSetBoxes[m].parentElement.style.display="",this._modTargetIndicators[m].style.setProperty("fill",Q.indicatorPrimary),this._modTargetIndicators[m].classList.add("modTarget"));let C=w.modulators[g.modulators[m]].name;if(C=="eq filter"||C=="note filter"){ut("#modFilterText"+m).css("display",""),ut("#modSettingText"+m).css("margin-bottom","2px");let k=g.modInstruments[m],T=u.song.channels[Math.max(0,g.modChannels[m])],b=-1;if(k>=T.instruments.length)for(let f=0;f<T.instruments.length;f++)C=="eq filter"?T.instruments[f].eqFilter.controlPointCount>b&&(b=T.instruments[f].eqFilter.controlPointCount,k=f):T.instruments[f].noteFilter.controlPointCount>b&&(b=T.instruments[f].noteFilter.controlPointCount,k=f);let R=C=="eq filter"?A.instruments[k].eqFilter.controlPointCount:A.instruments[k].noteFilter.controlPointCount;const V=C=="eq filter"?A.instruments[k].eqFilterType:A.instruments[k].noteFilterType;if(V&&(R=0),V||this._modFilterBoxes[m].children.length!=1+R*2){for(;this._modFilterBoxes[m].firstChild;)this._modFilterBoxes[m].remove(0);const f=[];V||f.push("morph");for(let D=0;D<R;D++)f.push("dot "+(D+1)+" x"),f.push("dot "+(D+1)+" y");Mn(this._modFilterBoxes[m],f)}if(V||g.modFilterTypes[m]>=this._modFilterBoxes[m].length){this._modFilterBoxes[m].classList.add("invalidSetting"),g.invalidModulators[m]=!0;let f=(g.modFilterTypes[m]-1)%2==1?"dot "+(Math.floor((g.modFilterTypes[m]-1)/2)+1)+" y":"dot "+(Math.floor((g.modFilterTypes[m]-1)/2)+1)+" x";g.modFilterTypes[m]==0&&(f="morph"),this._modFilterBoxes[m].insertBefore(Qe({value:f,style:"color: red;"},f),this._modFilterBoxes[m].children[0]),this._modFilterBoxes[m].selectedIndex=0}else this._modFilterBoxes[m].classList.remove("invalidSetting"),g.invalidModulators[m]=!1,this._modFilterBoxes[m].selectedIndex=g.modFilterTypes[m]}else{let k=ut("#modFilterText"+m).get(0);k&&(k.style.display="none");let T=ut("#modSettingText"+m).get(0);T&&T.style.setProperty("margin-bottom","0.9em")}}u.recalcChannelNames=!1;for(let m=0;m<w.chords.length;m++){const g=this._chordSelect.children[m];g.hasAttribute("hidden")||g.setAttribute("hidden","")}this._customInstrumentSettingsGroup.style.display="none",this._panSliderRow.style.display="none",this._panDropdownGroup.style.display="none",this._instrumentVolumeSliderRow.style.display="none",this._instrumentTypeSelectRow.style.setProperty("display","none"),this._instrumentSettingsGroup.style.color=Q.getChannelColor(u.song,u.channel).primaryNote,u.channel>=u.song.pitchChannelCount+u.song.noiseChannelCount&&this._piano.forceRender(),this._renderInstrumentBar(i,s,_)}else{if(this._customInstrumentSettingsGroup.style.display="",this._panSliderRow.style.display="",this._panDropdownGroup.style.display=this._openPanDropdown?"":"none",this._detuneSliderRow.style.display="",this._instrumentVolumeSliderRow.style.display="",this._instrumentTypeSelectRow.style.setProperty("display",""),this._instrumentSettingsGroup.appendChild(this._instrumentCopyGroup),this._instrumentSettingsGroup.insertBefore(this._instrumentsButtonRow,this._instrumentSettingsGroup.firstChild),this._instrumentSettingsGroup.insertBefore(this._instrumentSettingsTextRow,this._instrumentSettingsGroup.firstChild),u.song.channels[u.channel].name==""?this._instrumentSettingsTextRow.textContent="Instrument Settings":this._instrumentSettingsTextRow.textContent=u.song.channels[u.channel].name,this._modulatorGroup.style.display="none",this._usageCheck(u.channel,s),u.song.getChannelIsNoise(u.channel)?(this._pitchedPresetSelect.style.display="none",this._drumPresetSelect.style.display="",ut("#pitchPresetSelect").parent().hide(),ut("#drumPresetSelect").parent().show(),Pn(this._drumPresetSelect,h.preset)):(this._pitchedPresetSelect.style.display="",this._drumPresetSelect.style.display="none",ut("#pitchPresetSelect").parent().show(),ut("#drumPresetSelect").parent().hide(),Pn(this._pitchedPresetSelect,h.preset)),h.type==je.noise?(this._chipWaveSelectRow.style.display="none",this._chipNoiseSelectRow.style.display="",Pn(this._chipNoiseSelect,h.chipNoise)):this._chipNoiseSelectRow.style.display="none",h.type==je.spectrum?(this._chipWaveSelectRow.style.display="none",this._spectrumRow.style.display="",this._spectrumEditor.render()):this._spectrumRow.style.display="none",h.type==je.harmonics||h.type==je.pickedString?(this._chipWaveSelectRow.style.display="none",this._harmonicsRow.style.display="",this._harmonicsEditor.render()):this._harmonicsRow.style.display="none",h.type==je.pickedString?(this._chipWaveSelectRow.style.display="none",this._stringSustainRow.style.display="",this._stringSustainSlider.updateValue(h.stringSustain)):this._stringSustainRow.style.display="none",h.type==je.drumset){this._drumsetGroup.style.display="",this._chipWaveSelectRow.style.display="none",this._fadeInOutRow.style.display="none";for(let m=0;m<w.drumCount;m++)Pn(this._drumsetEnvelopeSelects[m],h.drumsetEnvelopes[m]),this._drumsetSpectrumEditors[m].render()}else this._drumsetGroup.style.display="none",this._fadeInOutRow.style.display="",this._fadeInOutEditor.render();if(h.type==je.chip&&(this._chipWaveSelectRow.style.display="",Pn(this._chipWaveSelect,h.chipWave)),h.type==je.customChipWave?(this._customWaveDraw.style.display="",this._chipWaveSelectRow.style.display="none"):this._customWaveDraw.style.display="none",h.type==je.pwm?(this._chipWaveSelectRow.style.display="none",this._pulseWidthRow.style.display="",this._pulseWidthSlider.input.title=Le(h.pulseWidth)+"%",this._pulseWidthSlider.updateValue(h.pulseWidth)):this._pulseWidthRow.style.display="none",h.type==je.fm){this._algorithmSelectRow.style.display="",this._phaseModGroup.style.display="",this._feedbackRow1.style.display="",this._feedbackRow2.style.display="",this._chipWaveSelectRow.style.display="none",Pn(this._algorithmSelect,h.algorithm),Pn(this._feedbackTypeSelect,h.feedbackType),this._feedbackAmplitudeSlider.updateValue(h.feedbackAmplitude);for(let m=0;m<w.operatorCount;m++){const g=m<w.algorithms[h.algorithm].carrierCount;this._operatorRows[m].style.color=g?Q.primaryText:"",Pn(this._operatorFrequencySelects[m],h.operators[m].frequency),this._operatorAmplitudeSliders[m].updateValue(h.operators[m].amplitude),Pn(this._operatorWaveformSelects[m],h.operators[m].waveform),this._operatorWaveformPulsewidthSliders[m].updateValue(h.operators[m].pulseWidth),this._operatorWaveformPulsewidthSliders[m].input.title=""+w.pwmOperatorWaves[h.operators[m].pulseWidth].name,this._operatorDropdownGroups[m].style.color=g?Q.primaryText:"";const S=(g?"Voice ":"Modulator ")+(m+1);this._operatorFrequencySelects[m].title=S+" Frequency",this._operatorAmplitudeSliders[m].input.title=S+(g?" Volume":" Amplitude"),this._operatorDropdownGroups[m].style.display=this._openOperatorDropdowns[m]?"":"none",h.operators[m].waveform==3?(this._operatorWaveformPulsewidthSliders[m].container.style.display="",this._operatorWaveformHints[m].style.display="none"):(this._operatorWaveformPulsewidthSliders[m].container.style.display="none",this._operatorWaveformHints[m].style.display="")}}else this._algorithmSelectRow.style.display="none",this._phaseModGroup.style.display="none",this._feedbackRow1.style.display="none",this._feedbackRow2.style.display="none";if(this._pulseWidthSlider.input.title=Le(h.pulseWidth)+"%",nf(h.effects)?(this._transitionRow.style.display="",this._openTransitionDropdown&&(this._transitionDropdownGroup.style.display=""),Pn(this._transitionSelect,h.transition)):(this._transitionDropdownGroup.style.display="none",this._transitionRow.style.display="none"),Zh(h.effects)?(this._chordSelectRow.style.display="",this._chordDropdown.style.display=h.chord==w.chords.dictionary.arpeggio.index?"":"none",this._chordDropdownGroup.style.display=h.chord==w.chords.dictionary.arpeggio.index&&this._openChordDropdown?"":"none",Pn(this._chordSelect,h.chord)):(this._chordSelectRow.style.display="none",this._chordDropdown.style.display="none",this._chordDropdownGroup.style.display="none"),Qh(h.effects)){this._pitchShiftRow.style.display="",this._pitchShiftSlider.updateValue(h.pitchShift),this._pitchShiftSlider.input.title=h.pitchShift-w.pitchShiftCenter+" semitone(s)";for(const m of this._pitchShiftFifthMarkers)m.style.display=e.showFifth?"":"none"}else this._pitchShiftRow.style.display="none";Jh(h.effects)?(this._detuneSliderRow.style.display="",this._detuneSlider.updateValue(h.detune-w.detuneCenter),this._detuneSlider.input.title=ms.detuneToCents(h.detune)+" cent(s)"):this._detuneSliderRow.style.display="none",ec(h.effects)?(this._vibratoSelectRow.style.display="",this._openVibratoDropdown&&(this._vibratoDropdownGroup.style.display=""),Pn(this._vibratoSelect,h.vibrato)):(this._vibratoDropdownGroup.style.display="none",this._vibratoSelectRow.style.display="none"),ml(h.effects)?(this._noteFilterTypeRow.style.setProperty("--text-color-lit",_.primaryNote),this._noteFilterTypeRow.style.setProperty("--text-color-dim",_.secondaryNote),this._noteFilterTypeRow.style.setProperty("--background-color-lit",_.primaryChannel),this._noteFilterTypeRow.style.setProperty("--background-color-dim",_.secondaryChannel),this._noteFilterTypeRow.style.display="",this._noteFilterEditor.render(),h.noteFilterType?(this._noteFilterSimpleButton.classList.remove("deactivated"),this._noteFilterAdvancedButton.classList.add("deactivated"),this._noteFilterRow.style.display="none",this._noteFilterSimpleCutRow.style.display="",this._noteFilterSimplePeakRow.style.display=""):(this._noteFilterSimpleButton.classList.add("deactivated"),this._noteFilterAdvancedButton.classList.remove("deactivated"),this._noteFilterRow.style.display="",this._noteFilterSimpleCutRow.style.display="none",this._noteFilterSimplePeakRow.style.display="none")):(this._noteFilterRow.style.display="none",this._noteFilterSimpleCutRow.style.display="none",this._noteFilterSimplePeakRow.style.display="none",this._noteFilterTypeRow.style.display="none"),sh(h.effects)?(this._distortionRow.style.display="",h.type==je.chip||h.type==je.customChipWave||h.type==je.pwm?this._aliasingRow.style.display="":this._aliasingRow.style.display="none",this._distortionSlider.updateValue(h.distortion)):(this._distortionRow.style.display="none",this._aliasingRow.style.display="none"),tc(h.effects)?(this._bitcrusherQuantizationRow.style.display="",this._bitcrusherFreqRow.style.display="",this._bitcrusherQuantizationSlider.updateValue(h.bitcrusherQuantization),this._bitcrusherFreqSlider.updateValue(h.bitcrusherFreq)):(this._bitcrusherQuantizationRow.style.display="none",this._bitcrusherFreqRow.style.display="none"),nc(h.effects)?(this._panSliderRow.style.display="",this._openPanDropdown&&(this._panDropdownGroup.style.display=""),this._panSlider.updateValue(h.pan)):(this._panSliderRow.style.display="none",this._panDropdownGroup.style.display="none"),ic(h.effects)?(this._chorusRow.style.display="",this._chorusSlider.updateValue(h.chorus)):this._chorusRow.style.display="none",sc(h.effects)?(this._echoSustainRow.style.display="",this._echoSustainSlider.updateValue(h.echoSustain),this._echoDelayRow.style.display="",this._echoDelaySlider.updateValue(h.echoDelay),this._echoDelaySlider.input.title=Math.round((h.echoDelay+1)*w.echoDelayStepTicks/(w.ticksPerPart*w.partsPerBeat)*1e3)/1e3+" beat(s)"):(this._echoSustainRow.style.display="none",this._echoDelayRow.style.display="none"),rc(h.effects)?(this._reverbRow.style.display="",this._reverbSlider.updateValue(h.reverb)):this._reverbRow.style.display="none",h.type==je.chip||h.type==je.customChipWave||h.type==je.harmonics||h.type==je.pickedString?(this._unisonSelectRow.style.display="",Pn(this._unisonSelect,h.unison)):this._unisonSelectRow.style.display="none",this._envelopeEditor.render();for(let m=0;m<w.chords.length;m++){let g=!w.instrumentTypeHasSpecialInterval[h.type]&&w.chords[m].customInterval;const S=this._chordSelect.children[m];g?S.hasAttribute("hidden")||S.setAttribute("hidden",""):S.removeAttribute("hidden")}this._instrumentSettingsGroup.style.color=Q.getChannelColor(u.song,u.channel).primaryNote,Pn(this._transitionSelect,h.transition),Pn(this._vibratoSelect,h.vibrato),Pn(this._vibratoTypeSelect,h.vibratoType),Pn(this._chordSelect,h.chord),this._panSliderInputBox.value=h.pan+"",this._detuneSliderInputBox.value=h.detune-w.detuneCenter+"",this._instrumentVolumeSlider.updateValue(h.volume),this._instrumentVolumeSliderInputBox.value=""+h.volume,this._vibratoDepthSlider.updateValue(Math.round(h.vibratoDepth*25)),this._vibratoDelaySlider.updateValue(Math.round(h.vibratoDelay)),this._vibratoSpeedSlider.updateValue(h.vibratoSpeed),Pn(this._vibratoTypeSelect,h.vibratoType),this._arpeggioSpeedSlider.updateValue(h.arpeggioSpeed),this._panDelaySlider.updateValue(h.panDelay),this._vibratoDelaySlider.input.title=""+Math.round(h.vibratoDelay),this._vibratoDepthSlider.input.title=""+h.vibratoDepth,this._vibratoSpeedSlider.input.title=""+h.vibratoSpeed,this._panDelaySlider.input.title=""+h.panDelay,this._arpeggioSpeedSlider.input.title="x"+Le(w.arpSpeedScale[h.arpeggioSpeed]),this._eqFilterSimpleCutSlider.updateValue(h.eqFilterSimpleCut),this._eqFilterSimplePeakSlider.updateValue(h.eqFilterSimplePeak),this._noteFilterSimpleCutSlider.updateValue(h.noteFilterSimpleCut),this._noteFilterSimplePeakSlider.updateValue(h.noteFilterSimplePeak),h.type==je.customChipWave&&(this._customWaveDrawCanvas.redrawCanvas(),this.prompt instanceof bo&&this.prompt.customChipCanvas.render()),this._renderInstrumentBar(i,s,_)}if(this._instrumentSettingsGroup.style.color=_.primaryNote,this._eqFilterEditor.render(),this._instrumentVolumeSlider.updateValue(h.volume),this._detuneSlider.updateValue(h.detune-w.detuneCenter),this._twoNoteArpBox.checked=!!h.fastTwoNoteArp,this._clicklessTransitionBox.checked=!!h.clicklessTransition,this._aliasingBox.checked=!!h.aliases,this._addEnvelopeButton.disabled=h.envelopeCount>=w.maxEnvelopeCount,this._volumeSlider.updateValue(e.volume),d&&c!=null&&c.clientWidth==0&&this.refocusStage(),this._setPrompt(u.prompt),e.autoFollow&&!u.synth.playing&&u.synth.goToBar(u.bar),u.addedEffect){const m=this._addEnvelopeButton.getBoundingClientRect(),g=this._instrumentSettingsArea.getBoundingClientRect(),S=this._settingsArea.getBoundingClientRect();this._instrumentSettingsArea.scrollTop+=Math.max(0,m.top-(g.top+g.height)),this._settingsArea.scrollTop+=Math.max(0,m.top-(S.top+S.height)),u.addedEffect=!1}u.addedEnvelope&&(this._instrumentSettingsArea.scrollTop=this._instrumentSettingsArea.scrollHeight,this._settingsArea.scrollTop=this._settingsArea.scrollHeight,u.addedEnvelope=!1)});a(this,"updatePlayButton",()=>{(this._renderedIsPlaying!=u.synth.playing||this._renderedIsRecording!=u.synth.recording||this._renderedShowRecordButton!=u.prefs.showRecordButton||this._renderedCtrlHeld!=this._ctrlHeld)&&(this._renderedIsPlaying=u.synth.playing,this._renderedIsRecording=u.synth.recording,this._renderedShowRecordButton=u.prefs.showRecordButton,this._renderedCtrlHeld=this._ctrlHeld,(document.activeElement==this._playButton||document.activeElement==this._pauseButton||document.activeElement==this._recordButton||document.activeElement==this._stopButton)&&this.refocusStage(),this._playButton.style.display="none",this._pauseButton.style.display="none",this._recordButton.style.display="none",this._stopButton.style.display="none",this._prevBarButton.style.display="",this._nextBarButton.style.display="",this._playButton.classList.remove("shrunk"),this._recordButton.classList.remove("shrunk"),this._patternEditorRow.style.pointerEvents="",this._octaveScrollBar.container.style.pointerEvents="",this._octaveScrollBar.container.style.opacity="",this._trackContainer.style.pointerEvents="",this._loopEditor.container.style.opacity="",this._instrumentSettingsArea.style.pointerEvents="",this._instrumentSettingsArea.style.opacity="",this._menuArea.style.pointerEvents="",this._menuArea.style.opacity="",this._songSettingsArea.style.pointerEvents="",this._songSettingsArea.style.opacity="",u.synth.recording?(this._stopButton.style.display="",this._prevBarButton.style.display="none",this._nextBarButton.style.display="none",this._patternEditorRow.style.pointerEvents="none",this._octaveScrollBar.container.style.pointerEvents="none",this._octaveScrollBar.container.style.opacity="0.5",this._trackContainer.style.pointerEvents="none",this._loopEditor.container.style.opacity="0.5",this._instrumentSettingsArea.style.pointerEvents="none",this._instrumentSettingsArea.style.opacity="0.5",this._menuArea.style.pointerEvents="none",this._menuArea.style.opacity="0.5",this._songSettingsArea.style.pointerEvents="none",this._songSettingsArea.style.opacity="0.5"):u.synth.playing?this._pauseButton.style.display="":u.prefs.showRecordButton?(this._playButton.style.display="",this._recordButton.style.display="",this._playButton.classList.add("shrunk"),this._recordButton.classList.add("shrunk")):this._ctrlHeld?this._recordButton.style.display="":this._playButton.style.display=""),window.requestAnimationFrame(this.updatePlayButton)});a(this,"_disableCtrlContextMenu",e=>e.ctrlKey?(e.preventDefault(),!1):!0);a(this,"_tempoStepperCaptureNumberKeys",e=>{switch(e.keyCode){case 8:case 13:case 38:case 40:case 37:case 39:case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:e.stopPropagation();break}});a(this,"_whenKeyPressed",e=>{if(this._ctrlHeld=e.ctrlKey,this.prompt){(this.prompt instanceof bo||this.prompt instanceof ra||this.prompt instanceof yo)&&this.prompt.whenKeyPressed(e),e.keyCode==27&&u.undo();return}if(document.activeElement==this._songTitleInputBox.input||this._patternEditor.editingModLabel||document.activeElement==this._muteEditor._channelNameInput.input){(e.keyCode==13||e.keyCode==27)&&(this.mainLayer.focus(),this._patternEditor.stopEditingModLabel(e.keyCode==27));return}if(document.activeElement==this._panSliderInputBox||document.activeElement==this._detuneSliderInputBox||document.activeElement==this._instrumentVolumeSliderInputBox){(e.keyCode==13||e.keyCode==27)&&this.mainLayer.focus();return}if(u.synth.recording){!e.ctrlKey&&!e.metaKey&&this._keyboardLayout.handleKeyEvent(e,!0),e.keyCode==32?(this._toggleRecord(),e.preventDefault(),this.refocusStage()):e.keyCode==80&&(e.ctrlKey||e.metaKey)&&(this._toggleRecord(),e.preventDefault(),this.refocusStage());return}const t=u.prefs.pressControlForShortcuts!=e.getModifierState("CapsLock"),n=!e.ctrlKey&&!e.metaKey&&t;switch(n&&this._keyboardLayout.handleKeyEvent(e,!0),e.keyCode){case 27:!e.ctrlKey&&!e.metaKey&&(new Fn(u,0,0),u.selection.resetBoxSelection());break;case 16:this._patternEditor.shiftMode=!0;break;case 17:this._patternEditor.controlMode=!0;break;case 32:e.ctrlKey?this._toggleRecord():e.shiftKey?(this._trackEditor.movePlayheadToMouse()||this._patternEditor.movePlayheadToMouse())&&(u.synth.playing||u.performance.play()):this.togglePlay(),e.preventDefault(),this.refocusStage();break;case 80:if(n)break;(e.ctrlKey||e.metaKey)&&(this._toggleRecord(),e.preventDefault(),this.refocusStage());break;case 90:if(n)break;e.shiftKey?u.redo():u.undo(),e.preventDefault();break;case 89:if(n)break;u.redo(),e.preventDefault();break;case 67:if(n)break;e.shiftKey?this._copyInstrument():u.selection.copy(),u.selection.resetBoxSelection(),u.selection.selectionUpdated(),e.preventDefault();break;case 13:e.ctrlKey||e.metaKey?u.selection.insertChannel():u.selection.insertBars(),e.preventDefault();break;case 8:e.ctrlKey||e.metaKey?u.selection.deleteChannel():u.selection.deleteBars(),this._barScrollBar.animatePlayhead(),e.preventDefault();break;case 65:if(n)break;e.shiftKey?u.selection.selectChannel():u.selection.selectAll(),e.preventDefault();break;case 68:if(n)break;t==(e.ctrlKey||e.metaKey)&&(u.selection.duplicatePatterns(),e.preventDefault());break;case 69:e.shiftKey&&!u.song.channels[u.channel].instruments[u.getCurrentInstrument()].eqFilterType&&u.channel<u.song.pitchChannelCount+u.song.noiseChannelCount&&this._openPrompt("customEQFilterSettings");break;case 70:if(n)break;t==(e.ctrlKey||e.metaKey)&&(u.synth.snapToStart(),u.synth.computeLatestModValues(),u.prefs.autoFollow&&u.selection.setChannelBar(u.channel,Math.floor(u.synth.playhead)),e.preventDefault());break;case 72:if(n)break;t==(e.ctrlKey||e.metaKey)&&(u.synth.goToBar(u.bar),u.synth.snapToBar(),u.synth.computeLatestModValues(),u.prefs.autoFollow&&u.selection.setChannelBar(u.channel,Math.floor(u.synth.playhead)),e.preventDefault());break;case 74:if(n)break;e.shiftKey&&e.ctrlKey&&e.altKey&&(u.prefs.autoPlay=!1,u.prefs.autoFollow=!1,u.prefs.enableNotePreview=!0,u.prefs.showFifth=!0,u.prefs.notesOutsideScale=!1,u.prefs.defaultScale=0,u.prefs.showLetters=!0,u.prefs.showChannels=!0,u.prefs.showScrollBar=!0,u.prefs.alwaysFineNoteVol=!1,u.prefs.enableChannelMuting=!0,u.prefs.displayBrowserUrl=!0,u.prefs.displayVolumeBar=!0,u.prefs.layout="wide",u.prefs.visibleOctaves=5,u.prefs.save(),e.preventDefault(),location.reload());break;case 76:if(n)break;e.shiftKey?this._openPrompt("limiterSettings"):this._openPrompt("barCount");break;case 77:if(n)break;t==(e.ctrlKey||e.metaKey)&&u.prefs.enableChannelMuting&&(u.selection.muteChannels(e.shiftKey),e.preventDefault());break;case 78:if(n)break;const i=new Zt;if(e.shiftKey){const s=u.song.channels[u.channel].instruments[u.getCurrentInstrument()];ml(s.effects)&&!s.noteFilterType&&u.channel<u.song.pitchChannelCount+u.song.noiseChannelCount&&this._openPrompt("customNoteFilterSettings");break}else if(e.ctrlKey){let s=0;for(;s<u.song.patternsPerChannel&&u.song.channels[u.channel].patterns[s].notes.length>0;)s++;s++,s<=w.barCountMax&&(s>u.song.patternsPerChannel&&i.append(new Aa(u,s)),i.append(new Xi(u,s,u.bar,u.channel,1,1)))}else{let s=1;for(;u.song.channels[u.channel].bars.indexOf(s)!=-1&&s<=u.song.patternsPerChannel;)s++;s<=w.barCountMax&&(s>u.song.patternsPerChannel&&i.append(new Aa(u,s)),i.append(new Xi(u,s,u.bar,u.channel,1,1)))}u.record(i),e.preventDefault();break;case 81:if(n)break;t==(e.ctrlKey||e.metaKey)&&(this._openPrompt("channelSettings"),e.preventDefault());break;case 83:if(n)break;e.ctrlKey||e.metaKey?(this._openPrompt("export"),e.preventDefault()):u.prefs.enableChannelMuting&&(e.shiftKey?u.selection.muteChannels(!1):u.selection.soloChannels(!1),e.preventDefault());break;case 79:if(n)break;(e.ctrlKey||e.metaKey)&&(this._openPrompt("import"),e.preventDefault());break;case 86:if(n)break;(e.ctrlKey||e.metaKey)&&e.shiftKey&&!t?u.selection.pasteNumbers():e.shiftKey?this._pasteInstrument():u.selection.pasteNotes(),e.preventDefault();break;case 87:if(n)break;this._openPrompt("moveNotesSideways");break;case 73:if(n)break;if(t==(e.ctrlKey||e.metaKey)&&e.shiftKey){const h=u.song.channels[u.channel].instruments[u.getCurrentInstrument()].toJsonObject();delete h.preset,delete h.volume,delete h.pan;const d=h.effects.indexOf(w.effectNames[on.panning]);d!=-1&&h.effects.splice(d,1);for(let c=0;c<h.envelopes.length;c++){const _=h.envelopes[c];(_.target=="panning"||_.target=="none"||_.envelope=="none")&&(h.envelopes.splice(c,1),c--)}this._copyTextToClipboard(JSON.stringify(h)),e.preventDefault()}break;case 82:if(n)break;t==(e.ctrlKey||e.metaKey)&&(e.shiftKey?this._randomGenerated():this._randomPreset(),e.preventDefault());break;case 219:if(n)break;t==(e.ctrlKey||e.metaKey)&&(u.synth.goToPrevBar(),u.prefs.autoFollow&&u.selection.setChannelBar(u.channel,Math.floor(u.synth.playhead)),e.preventDefault());break;case 221:if(n)break;t==(e.ctrlKey||e.metaKey)&&(u.synth.goToNextBar(),u.prefs.autoFollow&&u.selection.setChannelBar(u.channel,Math.floor(u.synth.playhead)),e.preventDefault());break;case 189:case 173:if(n)break;t==(e.ctrlKey||e.metaKey)&&(u.selection.transpose(!1,e.shiftKey),e.preventDefault());break;case 187:case 61:case 171:if(n)break;t==(e.ctrlKey||e.metaKey)&&(u.selection.transpose(!0,e.shiftKey),e.preventDefault());break;case 38:e.ctrlKey||e.metaKey?u.selection.swapChannels(-1):e.shiftKey?(u.selection.boxSelectionY1=Math.max(0,u.selection.boxSelectionY1-1),u.selection.scrollToEndOfSelection(),u.selection.selectionUpdated()):(u.selection.setChannelBar((u.channel-1+u.song.getChannelCount())%u.song.getChannelCount(),u.bar),u.selection.resetBoxSelection()),e.preventDefault();break;case 40:e.ctrlKey||e.metaKey?u.selection.swapChannels(1):e.shiftKey?(u.selection.boxSelectionY1=Math.min(u.song.getChannelCount()-1,u.selection.boxSelectionY1+1),u.selection.scrollToEndOfSelection(),u.selection.selectionUpdated()):(u.selection.setChannelBar((u.channel+1)%u.song.getChannelCount(),u.bar),u.selection.resetBoxSelection()),e.preventDefault();break;case 37:e.shiftKey?(u.selection.boxSelectionX1=Math.max(0,u.selection.boxSelectionX1-1),u.selection.scrollToEndOfSelection(),u.selection.selectionUpdated()):(u.selection.setChannelBar(u.channel,(u.bar+u.song.barCount-1)%u.song.barCount),u.selection.resetBoxSelection()),e.preventDefault();break;case 39:e.shiftKey?(u.selection.boxSelectionX1=Math.min(u.song.barCount-1,u.selection.boxSelectionX1+1),u.selection.scrollToEndOfSelection(),u.selection.selectionUpdated()):(u.selection.setChannelBar(u.channel,(u.bar+1)%u.song.barCount),u.selection.resetBoxSelection()),e.preventDefault();break;case 46:u.selection.digits="",u.selection.nextDigit("0",!1,!1);break;case 48:if(n)break;u.selection.nextDigit("0",t!=(e.shiftKey||e.ctrlKey||e.metaKey),e.altKey),this._renderInstrumentBar(u.song.channels[u.channel],u.getCurrentInstrument(),Q.getChannelColor(u.song,u.channel)),e.preventDefault();break;case 49:if(n)break;u.selection.nextDigit("1",t!=(e.shiftKey||e.ctrlKey||e.metaKey),e.altKey),this._renderInstrumentBar(u.song.channels[u.channel],u.getCurrentInstrument(),Q.getChannelColor(u.song,u.channel)),e.preventDefault();break;case 50:if(n)break;u.selection.nextDigit("2",t!=(e.shiftKey||e.ctrlKey||e.metaKey),e.altKey),this._renderInstrumentBar(u.song.channels[u.channel],u.getCurrentInstrument(),Q.getChannelColor(u.song,u.channel)),e.preventDefault();break;case 51:if(n)break;u.selection.nextDigit("3",t!=(e.shiftKey||e.ctrlKey||e.metaKey),e.altKey),this._renderInstrumentBar(u.song.channels[u.channel],u.getCurrentInstrument(),Q.getChannelColor(u.song,u.channel)),e.preventDefault();break;case 52:if(n)break;u.selection.nextDigit("4",t!=(e.shiftKey||e.ctrlKey||e.metaKey),e.altKey),this._renderInstrumentBar(u.song.channels[u.channel],u.getCurrentInstrument(),Q.getChannelColor(u.song,u.channel)),e.preventDefault();break;case 53:if(n)break;u.selection.nextDigit("5",t!=(e.shiftKey||e.ctrlKey||e.metaKey),e.altKey),this._renderInstrumentBar(u.song.channels[u.channel],u.getCurrentInstrument(),Q.getChannelColor(u.song,u.channel)),e.preventDefault();break;case 54:if(n)break;u.selection.nextDigit("6",t!=(e.shiftKey||e.ctrlKey||e.metaKey),e.altKey),this._renderInstrumentBar(u.song.channels[u.channel],u.getCurrentInstrument(),Q.getChannelColor(u.song,u.channel)),e.preventDefault();break;case 55:if(n)break;u.selection.nextDigit("7",t!=(e.shiftKey||e.ctrlKey||e.metaKey),e.altKey),this._renderInstrumentBar(u.song.channels[u.channel],u.getCurrentInstrument(),Q.getChannelColor(u.song,u.channel)),e.preventDefault();break;case 56:if(n)break;u.selection.nextDigit("8",t!=(e.shiftKey||e.ctrlKey||e.metaKey),e.altKey),this._renderInstrumentBar(u.song.channels[u.channel],u.getCurrentInstrument(),Q.getChannelColor(u.song,u.channel)),e.preventDefault();break;case 57:if(n)break;u.selection.nextDigit("9",t!=(e.shiftKey||e.ctrlKey||e.metaKey),e.altKey),this._renderInstrumentBar(u.song.channels[u.channel],u.getCurrentInstrument(),Q.getChannelColor(u.song,u.channel)),e.preventDefault();break;default:u.selection.digits="",u.selection.instrumentDigits="";break}n&&(u.selection.digits="",u.selection.instrumentDigits="")});a(this,"_whenKeyReleased",e=>{this._muteEditor.onKeyUp(e),e.ctrlKey||(this._patternEditor.controlMode=!1),e.shiftKey||(this._patternEditor.shiftMode=!1),this._ctrlHeld=e.ctrlKey,this._keyboardLayout.handleKeyEvent(e,!1)});a(this,"_whenPrevBarPressed",()=>{u.synth.goToPrevBar(),this._barScrollBar.animatePlayhead()});a(this,"_whenNextBarPressed",()=>{u.synth.goToNextBar(),this._barScrollBar.animatePlayhead()});a(this,"togglePlay",()=>{u.synth.playing?(u.performance.pause(),this.outVolumeHistoricCap=0):(u.synth.snapToBar(),u.performance.play())});a(this,"_toggleRecord",()=>{u.synth.playing?u.performance.pause():u.performance.record()});a(this,"_animate",()=>{this._modSliderUpdate(),u.prefs.displayVolumeBar&&this._volumeUpdate(),this._barScrollBar.animatePlayhead(),u.synth.isFilterModActive(!1,u.channel,u.getCurrentInstrument())&&this._eqFilterEditor.render(!0),u.synth.isFilterModActive(!0,u.channel,u.getCurrentInstrument())&&this._noteFilterEditor.render(!0),window.requestAnimationFrame(this._animate)});a(this,"_volumeUpdate",()=>{this.outVolumeHistoricTimer--,this.outVolumeHistoricTimer<=0&&(this.outVolumeHistoricCap-=.03),u.song.outVolumeCap>this.outVolumeHistoricCap&&(this.outVolumeHistoricCap=u.song.outVolumeCap,this.outVolumeHistoricTimer=50),u.song.outVolumeCap!=this.lastOutVolumeCap&&(this.lastOutVolumeCap=u.song.outVolumeCap,this._animateVolume(u.song.outVolumeCap,this.outVolumeHistoricCap))});a(this,"_setVolumeSlider",()=>{u.setVolume(Number(this._volumeSlider.input.value))});a(this,"_copyInstrument",()=>{const n=u.song.channels[u.channel].instruments[u.getCurrentInstrument()].toJsonObject();n.isDrum=u.song.getChannelIsNoise(u.channel),window.localStorage.setItem("instrumentCopy",JSON.stringify(n)),this.refocusStage()});a(this,"_pasteInstrument",()=>{const t=u.song.channels[u.channel].instruments[u.getCurrentInstrument()],n=JSON.parse(String(window.localStorage.getItem("instrumentCopy")));n!=null&&n.isDrum==u.song.getChannelIsNoise(u.channel)&&u.record(new Zf(u,t,n)),this.refocusStage()});a(this,"_whenSetTempo",()=>{u.record(new ah(u,-1,parseInt(this._tempoStepper.value)|0))});a(this,"_whenSetScale",()=>{if(isNaN(this._scaleSelect.value)){switch(this._scaleSelect.value){case"forceScale":u.selection.forceScale();break}u.notifier.changed()}else u.record(new sp(u,this._scaleSelect.selectedIndex))});a(this,"_whenSetKey",()=>{if(isNaN(this._keySelect.value)){switch(this._keySelect.value){case"detectKey":u.record(new rp(u));break}u.notifier.changed()}else u.record(new Gf(u,w.keys.length-1-this._keySelect.selectedIndex))});a(this,"_whenSetRhythm",()=>{if(isNaN(this._rhythmSelect.value)){switch(this._rhythmSelect.value){case"forceRhythm":u.selection.forceRhythm();break}u.notifier.changed()}else u.record(new so(u,this._rhythmSelect.selectedIndex))});a(this,"_refocus",()=>{var e=this;setTimeout(function(){e.mainLayer.focus()},20)});a(this,"_whenSetPitchedPreset",()=>{this._setPreset(ut("#pitchPresetSelect").val()+"")});a(this,"_whenSetDrumPreset",()=>{this._setPreset(ut("#drumPresetSelect").val()+"")});a(this,"_whenSetFeedbackType",()=>{u.record(new Vf(u,this._feedbackTypeSelect.selectedIndex))});a(this,"_whenSetAlgorithm",()=>{u.record(new Hf(u,this._algorithmSelect.selectedIndex))});a(this,"_whenSelectInstrument",e=>{if(e.target==this._instrumentAddButton)u.record(new $f(u));else if(e.target==this._instrumentRemoveButton)u.record(new Yf(u));else{const t=this._instrumentButtons.indexOf(e.target);t!=-1&&u.selection.selectInstrument(t),u.channel>=u.song.pitchChannelCount+u.song.noiseChannelCount&&this._piano.forceRender(),this._renderInstrumentBar(u.song.channels[u.channel],t,Q.getChannelColor(u.song,u.channel))}this.refocusStage()});a(this,"_whenSetModChannel",e=>{let t=u.song.channels[u.channel].instruments[u.getCurrentInstrument()],n=t.modulators[e]==0||w.modulators[t.modulators[e]].forSong;u.selection.setModChannel(e,this._modChannelBoxes[e].selectedIndex);const i=Math.max(0,t.modChannels[e]);u.song.channels[i].instruments.length>1&&n&&this._modChannelBoxes[e].selectedIndex>=2&&u.song.channels[i].bars[u.bar]>0&&u.selection.setModInstrument(e,u.song.channels[i].patterns[u.song.channels[i].bars[u.bar]-1].instruments[0]),this._piano.forceRender()});a(this,"_whenSetModInstrument",e=>{u.selection.setModInstrument(e,this._modInstrumentBoxes[e].selectedIndex),this._piano.forceRender()});a(this,"_whenSetModSetting",(e,t=!1)=>{let n="none";this._modSetBoxes[e].selectedIndex!=-1&&(n=this._modSetBoxes[e].children[this._modSetBoxes[e].selectedIndex].textContent,t?(this._modSetBoxes[e].selectedOptions.item(0).style.setProperty("color","red"),this._modSetBoxes[e].classList.add("invalidSetting"),u.song.channels[u.channel].instruments[u.getCurrentInstrument()].invalidModulators[e]=!0):(this._modSetBoxes[e].classList.remove("invalidSetting"),u.song.channels[u.channel].instruments[u.getCurrentInstrument()].invalidModulators[e]=!1)),t||u.selection.setModSetting(e,n),this._piano.forceRender()});a(this,"_whenClickModTarget",e=>{this._modChannelBoxes[e].selectedIndex>=2&&u.selection.setChannelBar(this._modChannelBoxes[e].selectedIndex-2,u.bar)});a(this,"_whenClickJumpToModTarget",()=>{const e=u.channel,t=u.getCurrentInstrument();if(e<u.song.pitchChannelCount+u.song.noiseChannelCount)for(let n=u.song.pitchChannelCount+u.song.noiseChannelCount;n<u.song.channels.length;n++){const i=u.song.channels[n],s=i.bars[u.bar];if(s>0){const h=i.patterns[s-1].instruments[0],d=i.instruments[h];for(let c=0;c<w.modCount;c++)if(d.modChannels[c]==e&&(d.modInstruments[c]==t||d.modInstruments[c]>=u.song.channels[e].instruments.length)){u.selection.setChannelBar(n,u.bar);return}}}});a(this,"_whenSetModFilter",e=>{u.selection.setModFilter(e,this._modFilterBoxes[e].selectedIndex)});a(this,"_whenSetChipWave",()=>{u.record(new mp(u,this._chipWaveSelect.selectedIndex))});a(this,"_whenSetNoiseWave",()=>{u.record(new gp(u,this._chipNoiseSelect.selectedIndex))});a(this,"_whenSetTransition",()=>{u.record(new lf(u,this._transitionSelect.selectedIndex))});a(this,"_whenSetEffects",()=>{const e=u.song.channels[u.channel].instruments[u.getCurrentInstrument()],t=e.effects,n=w.effectOrder[this._effectsSelect.selectedIndex-1];u.record(new ru(u,n,null)),this._effectsSelect.selectedIndex=0,e.effects>t&&(u.addedEffect=!0),u.notifier.changed()});a(this,"_whenSetVibrato",()=>{u.record(new pf(u,this._vibratoSelect.selectedIndex))});a(this,"_whenSetVibratoType",()=>{u.record(new vf(u,this._vibratoTypeSelect.selectedIndex))});a(this,"_whenSetUnison",()=>{u.record(new uf(u,this._unisonSelect.selectedIndex))});a(this,"_whenSetChord",()=>{u.record(new ff(u,this._chordSelect.selectedIndex))});a(this,"_addNewEnvelope",()=>{u.record(new vp(u)),this.refocusStage(),u.addedEnvelope=!0});a(this,"_zoomIn",()=>{u.prefs.visibleOctaves=Math.max(1,u.prefs.visibleOctaves-1),u.prefs.save(),u.notifier.changed(),this.refocusStage()});a(this,"_zoomOut",()=>{u.prefs.visibleOctaves=Math.min(w.pitchOctaves,u.prefs.visibleOctaves+1),u.prefs.save(),u.notifier.changed(),this.refocusStage()});a(this,"_fileMenuHandler",e=>{switch(this._fileMenu.value){case"new":u.goBackToStart(),u.song.restoreLimiterDefaults();for(const t of u.song.channels)t.muted=!1,t.name="";u.record(new Ra(u,""),!1,!0);break;case"export":this._openPrompt("export");break;case"export_stems":this._openPrompt("exportStems");break;case"import":this._openPrompt("import");break;case"copyUrl":this._copyTextToClipboard(new URL("#"+u.song.toBase64String(),location.href).href);break;case"shareUrl":navigator.share({url:new URL("#"+u.song.toBase64String(),location.href).href});break;case"shortenUrl":window.open("https://tinyurl.com/api-create.php?url="+encodeURIComponent(new URL("#"+u.song.toBase64String(),location.href).href));break;case"viewPlayer":location.href="player/#song="+u.song.toBase64String();break;case"copyEmbed":this._copyTextToClipboard(`<iframe width="384" height="60" style="border: none;" src="${new URL("player/#song="+u.song.toBase64String(),location.href).href}"></iframe>`);break;case"songRecovery":this._openPrompt("songRecovery");break}this._fileMenu.selectedIndex=0});a(this,"_editMenuHandler",e=>{switch(this._editMenu.value){case"undo":u.undo();break;case"redo":u.redo();break;case"copy":u.selection.copy();break;case"insertBars":u.selection.insertBars();break;case"deleteBars":u.selection.deleteBars();break;case"insertChannel":u.selection.insertChannel();break;case"deleteChannel":u.selection.deleteChannel();break;case"pasteNotes":u.selection.pasteNotes();break;case"pasteNumbers":u.selection.pasteNumbers();break;case"transposeUp":u.selection.transpose(!0,!1);break;case"transposeDown":u.selection.transpose(!1,!1);break;case"selectAll":u.selection.selectAll();break;case"selectChannel":u.selection.selectChannel();break;case"duplicatePatterns":u.selection.duplicatePatterns();break;case"barCount":this._openPrompt("barCount");break;case"beatsPerBar":this._openPrompt("beatsPerBar");break;case"moveNotesSideways":this._openPrompt("moveNotesSideways");break;case"channelSettings":this._openPrompt("channelSettings");break;case"limiterSettings":this._openPrompt("limiterSettings");break}this._editMenu.selectedIndex=0});a(this,"_optionsMenuHandler",e=>{switch(this._optionsMenu.value){case"autoPlay":u.prefs.autoPlay=!u.prefs.autoPlay;break;case"autoFollow":u.prefs.autoFollow=!u.prefs.autoFollow;break;case"enableNotePreview":u.prefs.enableNotePreview=!u.prefs.enableNotePreview;break;case"showLetters":u.prefs.showLetters=!u.prefs.showLetters;break;case"showFifth":u.prefs.showFifth=!u.prefs.showFifth;break;case"notesOutsideScale":u.prefs.notesOutsideScale=!u.prefs.notesOutsideScale;break;case"setDefaultScale":u.prefs.defaultScale=u.song.scale;break;case"showChannels":u.prefs.showChannels=!u.prefs.showChannels;break;case"showScrollBar":u.prefs.showScrollBar=!u.prefs.showScrollBar;break;case"alwaysFineNoteVol":u.prefs.alwaysFineNoteVol=!u.prefs.alwaysFineNoteVol;break;case"enableChannelMuting":u.prefs.enableChannelMuting=!u.prefs.enableChannelMuting;for(const t of u.song.channels)t.muted=!1;break;case"displayBrowserUrl":u.toggleDisplayBrowserUrl();break;case"displayVolumeBar":u.prefs.displayVolumeBar=!u.prefs.displayVolumeBar;break;case"layout":this._openPrompt("layout");break;case"colorTheme":this._openPrompt("theme");break;case"recordingSetup":this._openPrompt("recordingSetup");break}this._optionsMenu.selectedIndex=0,u.notifier.changed(),u.prefs.save()});a(this,"_customWavePresetHandler",e=>{let t=new Float32Array(64),n=this._customWavePresetDrop.selectedIndex-1,i=Number.MIN_VALUE,s=Number.MAX_VALUE,h=0,d=(w.chipWaves[n].samples.length-1)/64;for(let c=0;c<64;c++)t[c]=(w.chipWaves[n].samples[Math.floor(h)]-w.chipWaves[n].samples[Math.floor(h)+1])/d,t[c]<s&&(s=t[c]),t[c]>i&&(i=t[c]),h+=d;for(let c=0;c<64;c++)t[c]-=s,t[c]/=i-s,t[c]*=48,t[c]-=24,t[c]=Math.ceil(t[c]),this._customWaveDrawCanvas.newArray[c]=t[c];u.record(new pr(u,t)),u.record(new wl(u,+this._instrumentVolumeSlider.input.value,-w.volumeRange/2+Math.round(Math.sqrt(w.chipWaves[n].expression)*w.volumeRange/2))),this._customWavePresetDrop.selectedIndex=0,u.notifier.changed(),u.prefs.save()});u.notifier.watch(this.whenUpdated),new o_(u),window.addEventListener("resize",this.whenUpdated),window.requestAnimationFrame(this.updatePlayButton),window.requestAnimationFrame(this._animate),"share"in navigator||this._fileMenu.removeChild(this._fileMenu.querySelector("[value='shareUrl']")),this._scaleSelect.appendChild(No({label:"Edit"},Qe({value:"forceScale"},"Snap Notes To Scale"))),this._keySelect.appendChild(No({label:"Edit"},Qe({value:"detectKey"},"Detect Key"))),this._rhythmSelect.appendChild(No({label:"Edit"},Qe({value:"forceRhythm"},"Snap Notes To Rhythm"))),this._vibratoSelect.appendChild(Qe({hidden:!0,value:5},"custom")),this._showModSliders=new Array(w.modulators.length),this._modSliderValues=new Array(w.modulators.length),this._phaseModGroup.appendChild(ye({class:"selectRow",style:`color: ${Q.secondaryText}; height: 1em; margin-top: 0.5em;`},ye({style:"margin-right: .1em; visibility: hidden;"},"1."),ye({style:"width: 3em; margin-right: .3em;",class:"tip",onclick:()=>this._openPrompt("operatorFrequency")},"Freq:"),ye({class:"tip",onclick:()=>this._openPrompt("operatorVolume")},"Volume:")));for(let t=0;t<w.operatorCount;t++){const n=t,i=ye({style:"margin-right: 0px; color: "+Q.secondaryText+";"},t+1+""),s=Mn(an({style:"width: 100%;",title:"Frequency"}),w.operatorFrequencies.map(A=>A.name)),h=new tn(Ft({type:"range",min:"0",max:w.operatorAmplitudeMax,value:"0",step:"1",title:"Volume"}),u,(A,C)=>new zf(u,n,A,C),!1),d=Mn(an({style:"width: 100%;",title:"Waveform"}),w.operatorWaves.map(A=>A.name)),c=rn({style:"margin-left:0em; margin-right: 2px; height:1.5em; width: 8px; max-width: 10px; padding: 0px; font-size: 8px;",onclick:()=>this._toggleDropdownMenu(Ps.FM,t)},""),_=st({class:"tip",style:"margin-left: 10px;",onclick:()=>this._openPrompt("operatorWaveform")},"Wave:"),m=new tn(Ft({style:"margin-left: 10px; width: 85%;",type:"range",min:"0",max:w.pwmOperatorWaves.length-1,value:"0",step:"1",title:"Pulse Width"}),u,(A,C)=>new qf(u,n,A,C),!0),g=ye({class:"selectRow"},_,m.container,ye({class:"selectContainer",style:"width: 6em; margin-left: .3em;"},d)),S=ye({class:"operatorRow"},g),E=ye({class:"selectRow"},i,c,ye({class:"selectContainer",style:"width: 3em; margin-right: .3em;"},s),h.container);this._phaseModGroup.appendChild(E),this._operatorRows[t]=E,this._operatorAmplitudeSliders[t]=h,this._operatorFrequencySelects[t]=s,this._operatorDropdowns[t]=c,this._operatorWaveformHints[t]=_,this._operatorWaveformSelects[t]=d,this._operatorWaveformPulsewidthSliders[t]=m,this._operatorDropdownRows[t]=g,this._phaseModGroup.appendChild(S),this._operatorDropdownGroups[t]=S,this._openOperatorDropdowns[t]=!1,d.addEventListener("change",()=>{u.record(new Wf(u,n,d.selectedIndex))}),s.addEventListener("change",()=>{u.record(new Uf(u,n,s.selectedIndex))})}this._drumsetGroup.appendChild(ye({class:"selectRow"},st({class:"tip",onclick:()=>this._openPrompt("drumsetEnvelope")},"Envelope:"),st({class:"tip",onclick:()=>this._openPrompt("drumsetSpectrum")},"Spectrum:")));for(let t=w.drumCount-1;t>=0;t--){const n=t,i=new Tc(u,n);i.container.addEventListener("mousedown",this.refocusStage),this._drumsetSpectrumEditors[t]=i;const s=Mn(an({style:"width: 100%;",title:"Filter Envelope"}),w.envelopes.map(d=>d.name));this._drumsetEnvelopeSelects[t]=s,s.addEventListener("change",()=>{u.record(new kf(u,n,s.selectedIndex))});const h=ye({class:"selectRow"},ye({class:"selectContainer",style:"width: 5em; margin-right: .3em;"},s),this._drumsetSpectrumEditors[t].container);this._drumsetGroup.appendChild(h)}this._modNameRows=[],this._modChannelBoxes=[],this._modInstrumentBoxes=[],this._modSetRows=[],this._modSetBoxes=[],this._modFilterRows=[],this._modFilterBoxes=[],this._modTargetIndicators=[];for(let t=0;t<w.modCount;t++){let n=an({style:"width: 100%; color: currentColor; text-overflow:ellipsis;"}),i=an({style:"width: 100%; color: currentColor;"}),s=ye({class:"operatorRow",style:"height: 1em; margin-bottom: 0.65em;"},ye({class:"tip",style:"width: 10%; max-width: 5.4em;",id:"modChannelText"+t,onclick:()=>this._openPrompt("modChannel")},"Ch:"),ye({class:"selectContainer",style:"width: 35%;"},n),ye({class:"tip",style:"width: 1.2em; margin-left: 0.8em;",id:"modInstrumentText"+t,onclick:()=>this._openPrompt("modInstrument")},"Ins:"),ye({class:"selectContainer",style:"width: 10%;"},i)),h=an(),d=an(),c=ye({class:"selectRow",id:"modSettingText"+t,style:"margin-bottom: 0.9em; color: currentColor;"},st({class:"tip",onclick:()=>this._openPrompt("modSet")},"Setting: "),st({class:"tip",style:"font-size:x-small;",onclick:()=>this._openPrompt("modSetInfo"+t)},"?"),ye({class:"selectContainer"},h)),_=ye({class:"selectRow",id:"modFilterText"+t,style:"margin-bottom: 0.9em; color: currentColor;"},st({class:"tip",onclick:()=>this._openPrompt("modFilter"+t)},"Target: "),ye({class:"selectContainer"},d)),m=me.svg({style:"transform: translate(0px, 1px);",width:"1.5em",height:"1em",viewBox:"0 0 200 200"},[me.path({d:"M90 155 l0 -45 -45 0 c-25 0 -45 -4 -45 -10 0 -5 20 -10 45 -10 l45 0 0 -45 c0 -25 5 -45 10 -45 6 0 10 20 10 45 l0 45 45 0 c25 0 45 5 45 10 0 6 -20 10 -45 10 l -45 0 0 45 c0 25 -4 45 -10 45 -5 0 -10 -20 -10 -45z"}),me.path({d:"M42 158 c-15 -15 -16 -38 -2 -38 6 0 10 7 10 15 0 8 7 15 15 15 8 0 15 5 15 10 0 14 -23 13 -38 -2z"}),me.path({d:"M120 160 c0 -5 7 -10 15 -10 8 0 15 -7 15 -15 0 -8 5 -15 10 -15 14 0 13 23 -2 38 -15 15 -38 16 -38 2z"}),me.path({d:"M32 58 c3 -23 48 -40 48 -19 0 6 -7 11 -15 11 -8 0 -15 7 -15 15 0 8 -5 15 -11 15 -6 0 -9 -10 -7 -22z"}),me.path({d:"M150 65 c0 -8 -7 -15 -15 -15 -8 0 -15 -4 -15 -10 0 -14 23 -13 38 2 15 15 16 38 2 38 -5 0 -10 -7 -10 -15z"})]);this._modNameRows.push(s),this._modChannelBoxes.push(n),this._modInstrumentBoxes.push(i),this._modSetRows.push(c),this._modSetBoxes.push(h),this._modFilterRows.push(_),this._modFilterBoxes.push(d),this._modTargetIndicators.push(m),this._modulatorGroup.appendChild(ye({style:"margin: 3px 0; font-weight: bold; margin-bottom: 0.7em; text-align: center; color: "+Q.secondaryText+"; background: "+Q.uiWidgetBackground+";"},["Modulator "+(t+1),m])),this._modulatorGroup.appendChild(s),this._modulatorGroup.appendChild(c),this._modulatorGroup.appendChild(_)}this._pitchShiftSlider.container.style.setProperty("transform","translate(0px, 3px)"),this._pitchShiftSlider.container.style.setProperty("width","100%"),this._fileMenu.addEventListener("change",this._fileMenuHandler),this._editMenu.addEventListener("change",this._editMenuHandler),this._optionsMenu.addEventListener("change",this._optionsMenuHandler),this._customWavePresetDrop.addEventListener("change",this._customWavePresetHandler),this._tempoStepper.addEventListener("change",this._whenSetTempo),this._scaleSelect.addEventListener("change",this._whenSetScale),this._keySelect.addEventListener("change",this._whenSetKey),this._rhythmSelect.addEventListener("change",this._whenSetRhythm),this._algorithmSelect.addEventListener("change",this._whenSetAlgorithm),this._instrumentsButtonBar.addEventListener("click",this._whenSelectInstrument),this._feedbackTypeSelect.addEventListener("change",this._whenSetFeedbackType),this._chipWaveSelect.addEventListener("change",this._whenSetChipWave),this._chipNoiseSelect.addEventListener("change",this._whenSetNoiseWave),this._transitionSelect.addEventListener("change",this._whenSetTransition),this._effectsSelect.addEventListener("change",this._whenSetEffects),this._unisonSelect.addEventListener("change",this._whenSetUnison),this._chordSelect.addEventListener("change",this._whenSetChord),this._vibratoSelect.addEventListener("change",this._whenSetVibrato),this._vibratoTypeSelect.addEventListener("change",this._whenSetVibratoType),this._playButton.addEventListener("click",this.togglePlay),this._pauseButton.addEventListener("click",this.togglePlay),this._recordButton.addEventListener("click",this._toggleRecord),this._stopButton.addEventListener("click",this._toggleRecord),this._recordButton.addEventListener("contextmenu",t=>{t.ctrlKey&&(t.preventDefault(),this._toggleRecord())}),this._stopButton.addEventListener("contextmenu",t=>{t.ctrlKey&&(t.preventDefault(),this._toggleRecord())}),this._prevBarButton.addEventListener("click",this._whenPrevBarPressed),this._nextBarButton.addEventListener("click",this._whenNextBarPressed),this._volumeSlider.input.addEventListener("input",this._setVolumeSlider),this._zoomInButton.addEventListener("click",this._zoomIn),this._zoomOutButton.addEventListener("click",this._zoomOut),this._patternArea.addEventListener("mousedown",this._refocusStageNotEditing),this._trackArea.addEventListener("mousedown",this.refocusStage),this._volumeSlider.container.style.setProperty("flex-grow","1"),this._volumeSlider.container.style.setProperty("display","flex"),this._volumeBarContainer.style.setProperty("flex-grow","1"),this._volumeBarContainer.style.setProperty("display","flex"),this._volumeSlider.container.style.setProperty("--mod-color",Q.multiplicativeModSlider),this._volumeSlider.container.style.setProperty("--mod-border-radius","50%"),this._instrumentVolumeSlider.container.style.setProperty("--mod-color",Q.multiplicativeModSlider),this._instrumentVolumeSlider.container.style.setProperty("--mod-border-radius","50%"),this._feedbackAmplitudeSlider.container.style.setProperty("--mod-color",Q.multiplicativeModSlider),this._feedbackAmplitudeSlider.container.style.setProperty("--mod-border-radius","50%");for(let t=0;t<w.operatorCount;t++)this._operatorAmplitudeSliders[t].container.style.setProperty("--mod-color",Q.multiplicativeModSlider),this._operatorAmplitudeSliders[t].container.style.setProperty("--mod-border-radius","50%");let e=this;for(let t=0;t<w.modCount;t++)this._modChannelBoxes[t].addEventListener("change",function(){e._whenSetModChannel(t)}),this._modInstrumentBoxes[t].addEventListener("change",function(){e._whenSetModInstrument(t)}),this._modSetBoxes[t].addEventListener("change",function(){e._whenSetModSetting(t)}),this._modFilterBoxes[t].addEventListener("change",function(){e._whenSetModFilter(t)}),this._modTargetIndicators[t].addEventListener("click",function(){e._whenClickModTarget(t)});if(this._jumpToModIndicator.addEventListener("click",function(){e._whenClickJumpToModTarget()}),this._patternArea.addEventListener("mousedown",this.refocusStage),this._fadeInOutEditor.container.addEventListener("mousedown",this.refocusStage),this._spectrumEditor.container.addEventListener("mousedown",this.refocusStage),this._eqFilterEditor.container.addEventListener("mousedown",this.refocusStage),this._noteFilterEditor.container.addEventListener("mousedown",this.refocusStage),this._harmonicsEditor.container.addEventListener("mousedown",this.refocusStage),this._tempoStepper.addEventListener("keydown",this._tempoStepperCaptureNumberKeys,!1),this._addEnvelopeButton.addEventListener("click",this._addNewEnvelope),this._patternArea.addEventListener("contextmenu",this._disableCtrlContextMenu),this._trackArea.addEventListener("contextmenu",this._disableCtrlContextMenu),this.mainLayer.addEventListener("keydown",this._whenKeyPressed),this.mainLayer.addEventListener("keyup",this._whenKeyReleased),this.mainLayer.addEventListener("focusin",this._onFocusIn),this._instrumentCopyButton.addEventListener("click",this._copyInstrument.bind(this)),this._instrumentPasteButton.addEventListener("click",this._pasteInstrument.bind(this)),this._instrumentVolumeSliderInputBox.addEventListener("input",()=>{u.record(new wl(u,u.song.channels[u.channel].instruments[u.getCurrentInstrument()].volume,Math.min(25,Math.max(-25,Math.round(+this._instrumentVolumeSliderInputBox.value)))))}),this._panSliderInputBox.addEventListener("input",()=>{u.record(new cc(u,u.song.channels[u.channel].instruments[u.getCurrentInstrument()].pan,Math.min(100,Math.max(0,Math.round(+this._panSliderInputBox.value)))))}),this._detuneSliderInputBox.addEventListener("input",()=>{u.record(new ac(u,u.song.channels[u.channel].instruments[u.getCurrentInstrument()].detune,Math.min(w.detuneMax-w.detuneCenter,Math.max(w.detuneMin-w.detuneCenter,Math.round(+this._detuneSliderInputBox.value)))))}),this._customWaveDraw.addEventListener("input",()=>{u.record(new pr(u,this._customWaveDrawCanvas.newArray))}),this._twoNoteArpBox.addEventListener("input",()=>{u.record(new yf(u,this._twoNoteArpBox.checked))}),this._clicklessTransitionBox.addEventListener("input",()=>{u.record(new wf(u,this._clicklessTransitionBox.checked))}),this._aliasingBox.addEventListener("input",()=>{u.record(new xf(u,this._aliasingBox.checked))}),this._promptContainer.addEventListener("click",t=>{t.target==this._promptContainer&&u.undo()}),za){const t=this._optionsMenu.querySelector("[value=autoPlay]");t.disabled=!0,t.setAttribute("hidden","")}if(window.screen.availWidth<710){const t=this._optionsMenu.querySelector("[value=layout]");t.disabled=!0,t.setAttribute("hidden","")}}_toggleDropdownMenu(e,t=0){let n=this._vibratoDropdown,i=this._vibratoDropdownGroup;switch(e){case Ps.Vibrato:n=this._vibratoDropdown,this._openVibratoDropdown=!this._openVibratoDropdown,i=this._vibratoDropdownGroup;break;case Ps.Pan:n=this._panDropdown,this._openPanDropdown=!this._openPanDropdown,i=this._panDropdownGroup;break;case Ps.Chord:n=this._chordDropdown,this._openChordDropdown=!this._openChordDropdown,i=this._chordDropdownGroup;break;case Ps.Transition:n=this._transitionDropdown,this._openTransitionDropdown=!this._openTransitionDropdown,i=this._transitionDropdownGroup;break;case Ps.FM:n=this._operatorDropdowns[t],this._openOperatorDropdowns[t]=!this._openOperatorDropdowns[t],i=this._operatorDropdownGroups[t];break}if(n.textContent==""){let s=u.song.channels[u.channel].instruments[u.getCurrentInstrument()];n.textContent="",(i!=this._chordDropdownGroup||s.chord==w.chords.dictionary.arpeggio.index)&&(i.style.display="")}else n.textContent="",i.style.display="none"}_modSliderUpdate(){if(u.synth.playing){let e=u.getCurrentInstrument();const t=u.synth.isAnyModActive(u.channel,e);if(t){let n=function(s,h,d,c,_){if(u.synth.isModActive(d,c,_)){let m=(u.synth.getModValue(d,c,_,!1)-w.modulators[d].convertRealFactor)/w.modulators[d].maxRawVol;return m!=s._modSliderValues[d]&&(s._modSliderValues[d]=m,h.container.style.setProperty("--mod-position",m*96+2+"%")),!0}return!1},i=u.getCurrentInstrument();for(let s=0;s<w.modulators.length;s++){this._newShowModSliders[s]=this._showModSliders[s];let h=this._getSliderForModSetting(s);h!=null&&(this._newShowModSliders[s]=n(this,h,s,u.channel,i))}}else if(this._hasActiveModSliders)for(let n=0;n<w.modulators.length;n++)this._newShowModSliders[n]=!1;if(t||this._hasActiveModSliders){let n=!1;for(let i=0;i<w.modulators.length;i++){if(this._newShowModSliders[i]!=this._showModSliders[i]){this._showModSliders[i]=this._newShowModSliders[i];let s=this._getSliderForModSetting(i);s!=null&&(this._showModSliders[i]==!0?s.container.classList.add("modSlider"):s.container.classList.remove("modSlider"))}this._newShowModSliders[i]==!0&&(n=!0)}this._hasActiveModSliders=n}}else{this._hasActiveModSliders=!1;for(let e=0;e<w.modulators.length;e++)if(this._showModSliders[e]==!0){this._showModSliders[e]=!1,this._newShowModSliders[e]=!1;let t=this._getSliderForModSetting(e);t!=null&&t.container.classList.remove("modSlider")}}}_getSliderForModSetting(e){switch(e){case w.modulators.dictionary.pan.index:return this._panSlider;case w.modulators.dictionary.detune.index:return this._detuneSlider;case w.modulators.dictionary["fm slider 1"].index:return this._operatorAmplitudeSliders[0];case w.modulators.dictionary["fm slider 2"].index:return this._operatorAmplitudeSliders[1];case w.modulators.dictionary["fm slider 3"].index:return this._operatorAmplitudeSliders[2];case w.modulators.dictionary["fm slider 4"].index:return this._operatorAmplitudeSliders[3];case w.modulators.dictionary["fm feedback"].index:return this._feedbackAmplitudeSlider;case w.modulators.dictionary["pulse width"].index:return this._pulseWidthSlider;case w.modulators.dictionary.reverb.index:return this._reverbSlider;case w.modulators.dictionary.distortion.index:return this._distortionSlider;case w.modulators.dictionary["note volume"].index:return this._showModSliders[w.modulators.dictionary["mix volume"].index]?null:this._instrumentVolumeSlider;case w.modulators.dictionary["mix volume"].index:return this._instrumentVolumeSlider;case w.modulators.dictionary["vibrato depth"].index:return this._vibratoDepthSlider;case w.modulators.dictionary["vibrato speed"].index:return this._vibratoSpeedSlider;case w.modulators.dictionary["vibrato delay"].index:return this._vibratoDelaySlider;case w.modulators.dictionary["arp speed"].index:return this._arpeggioSpeedSlider;case w.modulators.dictionary["pan delay"].index:return this._panDelaySlider;case w.modulators.dictionary.tempo.index:return this._tempoSlider;case w.modulators.dictionary["song volume"].index:return this._volumeSlider;case w.modulators.dictionary["eq filt cut"].index:return this._eqFilterSimpleCutSlider;case w.modulators.dictionary["eq filt peak"].index:return this._eqFilterSimplePeakSlider;case w.modulators.dictionary["note filt cut"].index:return this._noteFilterSimpleCutSlider;case w.modulators.dictionary["note filt peak"].index:return this._noteFilterSimplePeakSlider;case w.modulators.dictionary["bit crush"].index:return this._bitcrusherQuantizationSlider;case w.modulators.dictionary["freq crush"].index:return this._bitcrusherFreqSlider;case w.modulators.dictionary["pitch shift"].index:return this._pitchShiftSlider;case w.modulators.dictionary.chorus.index:return this._chorusSlider;case w.modulators.dictionary.echo.index:return this._echoSustainSlider;case w.modulators.dictionary["echo delay"].index:return this._echoDelaySlider;case w.modulators.dictionary.sustain.index:return this._stringSustainSlider;default:return null}}_openPrompt(e){u.openPrompt(e),this._setPrompt(e)}_setPrompt(e){if(this._currentPromptName!=e&&(this._currentPromptName=e,this.prompt&&(this._wasPlaying&&!(this.prompt instanceof Tl||this.prompt instanceof ra||this.prompt instanceof bo||this.prompt instanceof yo)&&u.performance.play(),this._wasPlaying=!1,this._promptContainer.style.display="none",this._promptContainer.removeChild(this.prompt.container),this.prompt.cleanUp(),this.prompt=null,this.refocusStage()),e)){switch(e){case"export":this.prompt=new hh(u);break;case"exportStems":this.prompt=new Hr(u);break;case"import":this.prompt=new zp(u);break;case"songRecovery":this.prompt=new E_(u);break;case"barCount":this.prompt=new hr(u);break;case"beatsPerBar":this.prompt=new lr(u);break;case"moveNotesSideways":this.prompt=new Na(u);break;case"channelSettings":this.prompt=new ii(u);break;case"limiterSettings":this.prompt=new ra(u,this);break;case"customChipSettings":this.prompt=new bo(u,this);break;case"customEQFilterSettings":this.prompt=new yo(u,this,!1);break;case"customNoteFilterSettings":this.prompt=new yo(u,this,!0);break;case"theme":this.prompt=new A_(u);break;case"layout":this.prompt=new Yp(u);break;case"recordingSetup":this.prompt=new M_(u);break;default:this.prompt=new Tl(u,e);break}this.prompt&&(this.prompt instanceof Tl||this.prompt instanceof ra||this.prompt instanceof bo||this.prompt instanceof yo||(this._wasPlaying=u.synth.playing,u.performance.pause()),this._promptContainer.style.display="",this._promptContainer.appendChild(this.prompt.container))}}changeBarScrollPos(e){this._barScrollBar.changePos(e)}_renderInstrumentBar(e,t,n){if(u.song.layeredInstruments||u.song.patternInstruments){this._instrumentsButtonRow.style.display="",this._instrumentsButtonBar.style.setProperty("--text-color-lit",n.primaryNote),this._instrumentsButtonBar.style.setProperty("--text-color-dim",n.secondaryNote),this._instrumentsButtonBar.style.setProperty("--background-color-lit",n.primaryChannel),this._instrumentsButtonBar.style.setProperty("--background-color-dim",n.secondaryChannel);const i=u.song.getMaxInstrumentsPerChannel();for(;this._instrumentButtons.length<e.instruments.length;){const s=rn(String(this._instrumentButtons.length+1));this._instrumentButtons.push(s),this._instrumentsButtonBar.insertBefore(s,this._instrumentRemoveButton)}for(let s=this._renderedInstrumentCount;s<e.instruments.length;s++)this._instrumentButtons[s].style.display="";for(let s=e.instruments.length;s<this._renderedInstrumentCount;s++)this._instrumentButtons[s].style.display="none";for(this._renderedInstrumentCount=e.instruments.length;this._instrumentButtons.length>i;)this._instrumentsButtonBar.removeChild(this._instrumentButtons.pop());if(this._instrumentRemoveButton.style.display=e.instruments.length>w.instrumentCountMin?"":"none",this._instrumentAddButton.style.display=e.instruments.length<i?"":"none",e.instruments.length<i?this._instrumentRemoveButton.classList.remove("last-button"):this._instrumentRemoveButton.classList.add("last-button"),e.instruments.length>1){if(this._highlightedInstrumentIndex!=t){const s=this._instrumentButtons[this._highlightedInstrumentIndex];s!=null&&s.classList.remove("selected-instrument"),this._instrumentButtons[t].classList.add("selected-instrument"),this._highlightedInstrumentIndex=t}}else{const s=this._instrumentButtons[this._highlightedInstrumentIndex];s!=null&&s.classList.remove("selected-instrument"),this._highlightedInstrumentIndex=-1}if(u.song.layeredInstruments&&u.song.patternInstruments&&u.channel<u.song.pitchChannelCount+u.song.noiseChannelCount){for(let s=0;s<e.instruments.length;s++)u.recentPatternInstruments[u.channel].indexOf(s)!=-1?this._instrumentButtons[s].classList.remove("deactivated"):this._instrumentButtons[s].classList.add("deactivated");this._deactivatedInstruments=!0}else if(this._deactivatedInstruments||u.channel>=u.song.pitchChannelCount+u.song.noiseChannelCount){for(let s=0;s<e.instruments.length;s++)this._instrumentButtons[s].classList.remove("deactivated");this._deactivatedInstruments=!1}if(u.song.layeredInstruments&&u.song.patternInstruments&&e.instruments.length>1&&u.channel<u.song.pitchChannelCount+u.song.noiseChannelCount)for(let s=0;s<e.instruments.length;s++)this._instrumentButtons[s].classList.remove("no-underline");else for(let s=0;s<e.instruments.length;s++)this._instrumentButtons[s].classList.add("no-underline")}else this._instrumentsButtonRow.style.display="none"}_usageCheck(e,t){var n=!1,i=!1,s=!1;const h=u.song.channels[e];if(e<u.song.pitchChannelCount+u.song.noiseChannelCount)for(let d=u.song.pitchChannelCount+u.song.noiseChannelCount;d<u.song.channels.length;d++){const c=u.song.channels[d],_=c.bars[u.bar];if(_>0){const m=c.patterns[_-1].instruments[0],g=c.instruments[m];for(let S=0;S<w.modCount;S++)g.modChannels[S]==e&&(g.modInstruments[S]==t||g.modInstruments[S]>=h.instruments.length)&&(s=!0)}}if(h.bars[u.bar]!=0){let d=Math.min(u.selection.boxSelectionX0,u.selection.boxSelectionX1),c=Math.max(u.selection.boxSelectionX0,u.selection.boxSelectionX1),_=Math.min(u.selection.boxSelectionY0,u.selection.boxSelectionY1),m=Math.max(u.selection.boxSelectionY0,u.selection.boxSelectionY1);for(let g=0;g<u.song.barCount;g++)h.bars[g]==h.bars[u.bar]&&g!=u.bar&&(g<d||g>c||u.channel<_||u.channel>m)&&(i=!0,g=u.song.barCount);for(let g=0;g<u.song.barCount;g++)h.bars[g]!=0&&h.bars[g]!=h.bars[u.bar]&&h.patterns[h.bars[g]-1].instruments.includes(t)&&g!=u.bar&&(g<d||g>c||u.channel<_||u.channel>m)&&(n=!0,g=u.song.barCount)}i?this._usedPatternIndicator.style.setProperty("fill",Q.indicatorPrimary):this._usedPatternIndicator.style.setProperty("fill",Q.indicatorSecondary),n?this._usedInstrumentIndicator.style.setProperty("fill",Q.indicatorPrimary):this._usedInstrumentIndicator.style.setProperty("fill",Q.indicatorSecondary),s?(this._jumpToModIndicator.style.setProperty("display",""),this._jumpToModIndicator.style.setProperty("fill",Q.indicatorPrimary),this._jumpToModIndicator.classList.add("modTarget")):e<u.song.pitchChannelCount+u.song.noiseChannelCount?(this._jumpToModIndicator.style.setProperty("display",""),this._jumpToModIndicator.style.setProperty("fill",Q.indicatorSecondary),this._jumpToModIndicator.classList.remove("modTarget")):this._jumpToModIndicator.style.setProperty("display","none")}_copyTextToClipboard(e){let t;if(t=navigator,t.clipboard&&t.clipboard.writeText){t.clipboard.writeText(e).catch(()=>{window.prompt("Copy to clipboard:",e)});return}const n=document.createElement("textarea");n.textContent=e,document.body.appendChild(n),n.select();const i=document.execCommand("copy");n.remove(),this.refocusStage(),i||window.prompt("Copy this:",e)}_animateVolume(e,t){this._outVolumeBar.setAttribute("width",""+Math.min(144,e*144)),this._outVolumeCap.setAttribute("x",""+(8+Math.min(144,t*144)))}_switchEQFilterType(e){const n=u.song.channels[u.channel].instruments[u.getCurrentInstrument()];n.eqFilterType!=e&&u.record(new Af(u,n,e))}_switchNoteFilterType(e){const n=u.song.channels[u.channel].instruments[u.getCurrentInstrument()];n.noteFilterType!=e&&u.record(new Rf(u,n,e))}_randomPreset(){const e=u.song.getChannelIsNoise(u.channel);u.record(new oc(u,$a(e)))}_randomGenerated(){u.record(new af(u))}_setPreset(e){if(isNaN(e)){switch(e){case"copyInstrument":this._copyInstrument();break;case"pasteInstrument":this._pasteInstrument();break;case"randomPreset":this._randomPreset();break;case"randomGenerated":this._randomGenerated();break}u.notifier.changed()}else u.record(new oc(u,parseInt(e)))}}const Jn=new dv,uv=document.getElementById("beepboxEditorContainer");uv.appendChild(Jn.mainLayer);Jn.whenUpdated();Jn.mainLayer.className+=" load";Jn.mainLayer.getElementsByClassName("pattern-area")[0].className+=" load";Jn.mainLayer.getElementsByClassName("settings-area")[0].className+=" load";Jn.mainLayer.getElementsByClassName("editor-song-settings")[0].className+=" load";Jn.mainLayer.getElementsByClassName("instrument-settings-area")[0].className+=" load";Jn.mainLayer.getElementsByClassName("trackAndMuteContainer")[0].className+=" load";Jn.mainLayer.getElementsByClassName("barScrollBar")[0].className+=" load";ut("#pitchPresetSelect").select2({dropdownAutoWidth:!0});ut("#drumPresetSelect").select2({dropdownAutoWidth:!0});ut("body").on("click",".select2-container--open .select2-results__group",function(){ut(this).siblings().toggle()});ut("#pitchPresetSelect").on("select2:open",function(){ut(".select2-dropdown--below").css("opacity",0),ut(".select2-dropdown").css("opacity",1),ut("#pitchPresetSelect"),setTimeout(()=>{let r=ut(".select2-container--open .select2-results__group"),e=ut(".select2-container--open .select2-results__option");ut.each(r,(t,n)=>{ut(n).siblings().hide(),ut(n)[0].setAttribute("style","color: "+Q.getChannelColor(u.song,u.channel).primaryNote+";")}),ut.each(e,(t,n)=>{ut(n)[0].setAttribute("style","color: "+Q.getChannelColor(u.song,u.channel).primaryNote+";")}),ut(".select2-dropdown--below").css("opacity",1)},0)});ut("#drumPresetSelect").on("select2:open",function(){ut(".select2-dropdown--below").css("opacity",0),ut(".select2-dropdown").css("opacity",1),ut("#drumPresetSelect"),setTimeout(()=>{let r=ut(".select2-container--open .select2-results__group"),e=ut(".select2-container--open .select2-results__option");ut.each(r,(t,n)=>{ut(n).siblings().hide(),ut(n)[0].setAttribute("style","color: "+Q.getChannelColor(u.song,u.channel).primaryNote+";")}),ut.each(e,(t,n)=>{ut(n)[0].setAttribute("style","color: "+Q.getChannelColor(u.song,u.channel).primaryNote+";")}),ut(".select2-dropdown--below").css("opacity",1)},0)});ut("#pitchPresetSelect").on("change",Jn._whenSetPitchedPreset);ut("#pitchPresetSelect").on("select2:close",Jn._refocus);ut("#drumPresetSelect").on("change",Jn._whenSetDrumPreset);ut("#drumPresetSelect").on("select2:close",Jn._refocus);Jn.mainLayer.focus();if(!za&&u.prefs.autoPlay){let r=function(){document.hidden||(u.synth.play(),Jn.updatePlayButton(),window.removeEventListener("visibilitychange",r))};document.hidden?window.addEventListener("visibilitychange",r):window.setTimeout(r)}"scrollRestoration"in history&&(history.scrollRestoration="manual");Jn.updatePlayButton();"serviceWorker"in navigator&&navigator.serviceWorker.register("/service_worker.js",{updateViaCache:"all",scope:"/"}).catch(()=>{});window.beepbox={Config:w,Synth:ms};
